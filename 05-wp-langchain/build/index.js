(()=>{var e,t={58:(e,t,r)=>{"use strict";r.d(t,{DS:()=>o,Tr:()=>s,bO:()=>n,gI:()=>a,xW:()=>i});class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new n({start:e=>function r(){return t.read().then(({done:t,value:n})=>{if(!t)return e.enqueue(n),r();e.close()})}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){const{value:r,done:n}=await e.next();n&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function a(e,t=2){const r=Array.from({length:t},()=>[]);return r.map(async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of r)e.push(t)}else{if(t[0].done)return;yield t.shift().value}})}function i(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const r={...e};for(const[e,n]of Object.entries(t))e in r&&!Array.isArray(r[e])?r[e]=i(r[e],n):r[e]=n;return r}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class s{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,n)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,n):this.firstResult.then(e=>r(void 0),n)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function o(e,t,r,...n){const a=new s(t,r),i=await a.setup;return{output:e(a,i,...n),setup:i}}},156:(e,t,r)=>{"use strict";var n={};r.r(n),r.d(n,{JsonPatchError:()=>Va,_areEquals:()=>ei,applyOperation:()=>Wa,applyPatch:()=>Ga,applyReducer:()=>Ya,deepClone:()=>qa,getValueByPointer:()=>Ja,validate:()=>Qa,validator:()=>Xa});const a="RFC3986",i={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},s=(Object.prototype.hasOwnProperty,Array.isArray),o=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),l=1024;function c(e,t){if(s(e)){const r=[];for(let n=0;n<e.length;n+=1)r.push(t(e[n]));return r}return t(e)}const u=Object.prototype.hasOwnProperty,h={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},d=Array.isArray,p=Array.prototype.push,m=function(e,t){p.apply(e,d(t)?t:[t])},f=Date.prototype.toISOString,g={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,r,n,a)=>{if(0===e.length)return e;let i=e;if("symbol"==typeof e?i=Symbol.prototype.toString.call(e):"string"!=typeof e&&(i=String(e)),"iso-8859-1"===r)return escape(i).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let s="";for(let e=0;e<i.length;e+=l){const t=i.length>=l?i.slice(e,e+l):i,r=[];for(let e=0;e<t.length;++e){let n=t.charCodeAt(e);45===n||46===n||95===n||126===n||n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||"RFC1738"===a&&(40===n||41===n)?r[r.length]=t.charAt(e):n<128?r[r.length]=o[n]:n<2048?r[r.length]=o[192|n>>6]+o[128|63&n]:n<55296||n>=57344?r[r.length]=o[224|n>>12]+o[128|n>>6&63]+o[128|63&n]:(e+=1,n=65536+((1023&n)<<10|1023&t.charCodeAt(e)),r[r.length]=o[240|n>>18]+o[128|n>>12&63]+o[128|n>>6&63]+o[128|63&n])}s+=r.join("")}return s},encodeValuesOnly:!1,format:a,formatter:i[a],indices:!1,serializeDate:e=>f.call(e),skipNulls:!1,strictNullHandling:!1},y={};function b(e,t,r,n,a,i,s,o,l,u,h,p,f,w,_,v,O,A){let E=e,x=A,I=0,P=!1;for(;void 0!==(x=x.get(y))&&!P;){const t=x.get(e);if(I+=1,void 0!==t){if(t===I)throw new RangeError("Cyclic object value");P=!0}void 0===x.get(y)&&(I=0)}if("function"==typeof u?E=u(t,E):E instanceof Date?E=f?.(E):"comma"===r&&d(E)&&(E=c(E,function(e){return e instanceof Date?f?.(e):e})),null===E){if(i)return l&&!v?l(t,g.encoder,O,"key",w):t;E=""}if("string"==typeof(S=E)||"number"==typeof S||"boolean"==typeof S||"symbol"==typeof S||"bigint"==typeof S||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(E)){if(l){const e=v?t:l(t,g.encoder,O,"key",w);return[_?.(e)+"="+_?.(l(E,g.encoder,O,"value",w))]}return[_?.(t)+"="+_?.(String(E))]}var S;const k=[];if(void 0===E)return k;let T;if("comma"===r&&d(E))v&&l&&(E=c(E,l)),T=[{value:E.length>0?E.join(",")||null:void 0}];else if(d(u))T=u;else{const e=Object.keys(E);T=h?e.sort(h):e}const C=o?String(t).replace(/\./g,"%2E"):String(t),j=n&&d(E)&&1===E.length?C+"[]":C;if(a&&d(E)&&0===E.length)return j+"[]";for(let t=0;t<T.length;++t){const c=T[t],g="object"==typeof c&&void 0!==c.value?c.value:E[c];if(s&&null===g)continue;const x=p&&o?c.replace(/\./g,"%2E"):c,P=d(E)?"function"==typeof r?r(j,x):j:j+(p?"."+x:"["+x+"]");A.set(e,I);const S=new WeakMap;S.set(y,A),m(k,b(g,P,r,n,a,i,s,o,"comma"===r&&v&&d(E)?null:l,u,h,p,f,w,_,v,O,S))}return k}const w="4.104.0";let _,v,O,A,E,x,I,P,S,k=!1,T=null,C=null,j=null,N=null;class R{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}const $=()=>{_||function(e,t={auto:!1}){if(k)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(_)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${_}'\``);k=t.auto,_=e.kind,v=e.fetch,T=e.Request,C=e.Response,j=e.Headers,O=e.FormData,N=e.Blob,A=e.File,E=e.ReadableStream,x=e.getMultipartRequestOptions,I=e.getDefaultAgent,P=e.fileFromPath,S=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let r,n,a,i;try{r=fetch,n=Request,a=Response,i=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:r,Request:n,Response:a,Headers:i,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new R(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0})};$();class L extends Error{}class M extends L{constructor(e,t,r,n){super(`${M.makeMessage(e,t,r)}`),this.status=e,this.headers=n,this.request_id=n?.["x-request-id"],this.error=t;const a=t;this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,r){const n=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,r,n){if(!e||!n)return new U({message:r,cause:$e(t)});const a=t?.error;return 400===e?new F(e,a,r,n):401===e?new B(e,a,r,n):403===e?new H(e,a,r,n):404===e?new V(e,a,r,n):409===e?new q(e,a,r,n):422===e?new Z(e,a,r,n):429===e?new K(e,a,r,n):e>=500?new J(e,a,r,n):new M(e,a,r,n)}}class D extends M{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class U extends M{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class z extends U{constructor({message:e}={}){super({message:e??"Request timed out."})}}class F extends M{}class B extends M{}class H extends M{}class V extends M{}class q extends M{}class Z extends M{}class K extends M{}class J extends M{}class W extends L{constructor(){super("Could not parse response content as the length limit was reached")}}class G extends L{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var Y,X=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r},Q=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class ee{constructor(){Y.set(this,void 0),this.buffer=new Uint8Array,X(this,Y,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?(new TextEncoder).encode(e):e;let r=new Uint8Array(this.buffer.length+t.length);r.set(this.buffer),r.set(t,this.buffer.length),this.buffer=r;const n=[];let a;for(;null!=(a=te(this.buffer,Q(this,Y,"f")));){if(a.carriage&&null==Q(this,Y,"f")){X(this,Y,a.index,"f");continue}if(null!=Q(this,Y,"f")&&(a.index!==Q(this,Y,"f")+1||a.carriage)){n.push(this.decodeText(this.buffer.slice(0,Q(this,Y,"f")-1))),this.buffer=this.buffer.slice(Q(this,Y,"f")),X(this,Y,null,"f");continue}const e=null!==Q(this,Y,"f")?a.preceding-1:a.preceding,t=this.decodeText(this.buffer.slice(0,e));n.push(t),this.buffer=this.buffer.slice(a.index),X(this,Y,null,"f")}return n}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new L(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new L(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new L("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode("\n"):[]}}function te(e,t){for(let r=t??0;r<e.length;r++){if(10===e[r])return{preceding:r,index:r+1,carriage:!1};if(13===e[r])return{preceding:r,index:r+1,carriage:!0}}return null}function re(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}function ne(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}Y=new WeakMap,ee.NEWLINE_CHARS=new Set(["\n","\r"]),ee.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class ae{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;return new ae(async function*(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const r of async function*(e,t){if(!e.body)throw t.abort(),new L("Attempted to iterate over a response with no body");const r=new ie,n=new ee,a=ne(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const r of e){if(null==r)continue;const e=r instanceof ArrayBuffer?new Uint8Array(r):"string"==typeof r?(new TextEncoder).encode(r):r;let n,a=new Uint8Array(t.length+e.length);for(a.set(t),a.set(e,t.length),t=a;-1!==(n=re(t));)yield t.slice(0,n),t=t.slice(n)}t.length>0&&(yield t)}(a))for(const t of n.decode(e)){const e=r.decode(t);e&&(yield e)}for(const e of n.flush()){const t=r.decode(e);t&&(yield t)}}(e,t))if(!n)if(r.data.startsWith("[DONE]"))n=!0;else if(null===r.event||r.event.startsWith("response.")||r.event.startsWith("transcript.")){let t;try{t=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if(t&&t.error)throw new M(void 0,t.error,void 0,Ae(e.headers));yield t}else{let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if("error"==r.event)throw new M(void 0,e.error,e.message,void 0);yield{event:r.event,data:e}}n=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{n||t.abort()}},t)}static fromReadableStream(e,t){let r=!1;return new ae(async function*(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const t of async function*(){const t=new ee,r=ne(e);for await(const e of r)for(const r of t.decode(e))yield r;for(const e of t.flush())yield e}())n||t&&(yield JSON.parse(t));n=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{n||t.abort()}},t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),n=n=>({next:()=>{if(0===n.length){const n=r.next();e.push(n),t.push(n)}return n.shift()}});return[new ae(()=>n(e),this.controller),new ae(()=>n(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new E({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:n,done:a}=await t.next();if(a)return e.close();const i=r.encode(JSON.stringify(n)+"\n");e.enqueue(i)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class ie{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,n]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return n.startsWith(" ")&&(n=n.substring(1)),"event"===t?this.event=n:"data"===t&&this.data.push(n),null}}const se=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,oe=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&le(e),le=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function ce(e,t,r){if(e=await e,oe(e))return e;if(se(e)){const n=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const a=le(n)?[await n.arrayBuffer()]:[n];return new A(a,t,r)}const n=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(le(e))t.push(await e.arrayBuffer());else{if(!he(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map(e=>`"${e}"`).join(", ")}]`}(e)}`);for await(const r of e)t.push(r)}return t}(e);if(t||(t=function(e){return ue(e.name)||ue(e.filename)||ue(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!r?.type){const e=n[0]?.type;"string"==typeof e&&(r={...r,type:e})}return new A(n,t,r)}const ue=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,he=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],de=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],pe=async e=>{const t=await me(e.body);return x(t,e)},me=async e=>{const t=new O;return await Promise.all(Object.entries(e||{}).map(([e,r])=>fe(t,e,r))),t},fe=async(e,t,r)=>{if(void 0!==r){if(null==r)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof r||"number"==typeof r||"boolean"==typeof r)e.append(t,String(r));else if((e=>oe(e)||se(e)||S(e))(r)){const n=await ce(r);e.append(t,n)}else if(Array.isArray(r))await Promise.all(r.map(r=>fe(e,t+"[]",r)));else{if("object"!=typeof r)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${r} instead`);await Promise.all(Object.entries(r).map(([r,n])=>fe(e,`${t}[${r}]`,n)))}}};var ge;async function ye(e){const{response:t}=e;if(e.options.stream)return Fe("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):ae.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const r=t.headers.get("content-type"),n=r?.split(";")[0]?.trim();if(n?.includes("application/json")||n?.endsWith("+json")){const e=await t.json();return Fe("response",t.status,t.url,t.headers,e),be(e,t)}const a=await t.text();return Fe("response",t.status,t.url,t.headers,a),a}function be(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}$();class we extends Promise{constructor(e,t=ye){super(e=>{e(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new we(this.responsePromise,async t=>be(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class _e{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:n,fetch:a}){this.baseURL=e,this.maxRetries=Re("maxRetries",t),this.timeout=Re("timeout",r),this.httpAgent=n,this.fetch=a??v}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...ke(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Be()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async r=>{const n=r&&le(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:n}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const r={...e},{method:n,path:a,query:i,headers:s={}}=r,o=ArrayBuffer.isView(r.body)||r.__binaryRequest&&"string"==typeof r.body?r.body:de(r.body)?r.body.body:r.body?JSON.stringify(r.body,null,2):null,l=this.calculateContentLength(o),c=this.buildURL(a,i);"timeout"in r&&Re("timeout",r.timeout),r.timeout=r.timeout??this.timeout;const u=r.httpAgent??this.httpAgent??I(c),h=r.timeout+1e3;return"number"==typeof u?.options?.timeout&&h>(u.options.timeout??0)&&(u.options.timeout=h),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey),{req:{method:n,...o&&{body:o},headers:this.buildHeaders({options:r,headers:s,contentLength:l,retryCount:t}),...u&&{agent:u},signal:r.signal??null},url:c,timeout:r.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:n}){const a={};r&&(a["content-length"]=r);const i=this.defaultHeaders(e);return Ue(a,i),Ue(a,t),de(e.body)&&"node"!==_&&delete a["content-type"],void 0===He(i,"x-stainless-retry-count")&&void 0===He(t,"x-stainless-retry-count")&&(a["x-stainless-retry-count"]=String(n)),void 0===He(i,"x-stainless-timeout")&&void 0===He(t,"x-stainless-timeout")&&e.timeout&&(a["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(e=>[...e])):{...e}:{}}makeStatusError(e,t,r,n){return M.generate(e,t,r,n)}request(e,t=null){return new we(this.makeRequest(e,t))}async makeRequest(e,t){const r=await e,n=r.maxRetries??this.maxRetries;null==t&&(t=n),await this.prepareOptions(r);const{req:a,url:i,timeout:s}=this.buildRequest(r,{retryCount:n-t});if(await this.prepareRequest(a,{url:i,options:r}),Fe("request",i,r,a.headers),r.signal?.aborted)throw new D;const o=new AbortController,l=await this.fetchWithTimeout(i,a,s,o).catch($e);if(l instanceof Error){if(r.signal?.aborted)throw new D;if(t)return this.retryRequest(r,t);if("AbortError"===l.name)throw new z;throw new U({cause:l})}const c=Ae(l.headers);if(!l.ok){if(t&&this.shouldRetry(l))return Fe(`response (error; retrying, ${t} attempts remaining)`,l.status,i,c),this.retryRequest(r,t,c);const e=await l.text().catch(e=>$e(e).message),n=Te(e),a=n?void 0:e;throw Fe(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,i,c,a),this.makeStatusError(l.status,n,a,c)}return{response:l,options:r,controller:o}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new Oe(this,r,e)}buildURL(e,t){const r=je(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),n=this.defaultQuery();return Me(n)||(t={...n,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([e,t])=>void 0!==t).map(([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new L(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,n){const{signal:a,...i}=t||{};a&&a.addEventListener("abort",()=>n.abort());const s=setTimeout(()=>n.abort(),r),o={signal:n.signal,...i};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally(()=>{clearTimeout(s)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,r){let n;const a=r?.["retry-after-ms"];if(a){const e=parseFloat(a);Number.isNaN(e)||(n=e)}const i=r?.["retry-after"];if(i&&!n){const e=parseFloat(i);n=Number.isNaN(e)?Date.parse(i)-Date.now():1e3*e}if(!(n&&0<=n&&n<6e4)){const r=e.maxRetries??this.maxRetries;n=this.calculateDefaultRetryTimeoutMillis(t,r)}return await Ne(n),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const r=t-e;return Math.min(.5*Math.pow(2,r),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${w}`}}class ve{constructor(e,t,r,n){ge.set(this,void 0),function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===n?a.call(e,r):a?a.value=r:t.set(e,r)}(this,ge,e,"f"),this.options=n,this.response=t,this.body=r}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new L("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,n]of r)e.url.searchParams.set(t,n);t.query=void 0,t.path=e.url.toString()}return await function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)}(this,ge,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(ge=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Oe extends we{constructor(e,t,r){super(t,async t=>new r(e,t.response,await ye(t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const Ae=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),Ee={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},xe=e=>"object"==typeof e&&null!==e&&!Me(e)&&Object.keys(e).every(e=>De(Ee,e)),Ie=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Pe=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let Se;const ke=()=>Se??(Se=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":w,"X-Stainless-OS":Pe(Deno.build.os),"X-Stainless-Arch":Ie(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":w,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":w,"X-Stainless-OS":Pe(process.platform),"X-Stainless-Arch":Ie(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:r}of e){const e=r.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":w,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":w,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),Te=e=>{try{return JSON.parse(e)}catch(e){return}},Ce=/^[a-z][a-z0-9+.-]*:/i,je=e=>Ce.test(e),Ne=e=>new Promise(t=>setTimeout(t,e)),Re=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new L(`${e} must be an integer`);if(t<0)throw new L(`${e} must be a positive integer`);return t},$e=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},Le=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function Me(e){if(!e)return!0;for(const t in e)return!1;return!0}function De(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Ue(e,t){for(const r in t){if(!De(t,r))continue;const n=r.toLowerCase();if(!n)continue;const a=t[r];null===a?delete e[n]:void 0!==a&&(e[n]=a)}}const ze=new Set(["authorization","api-key"]);function Fe(e,...t){if("undefined"!=typeof process&&"true"===process?.env?.DEBUG){const r=t.map(e=>{if(!e)return e;if(e.headers){const t={...e,headers:{...e.headers}};for(const r in e.headers)ze.has(r.toLowerCase())&&(t.headers[r]="REDACTED");return t}let t=null;for(const r in e)ze.has(r.toLowerCase())&&(t??(t={...e}),t[r]="REDACTED");return t??e});console.log(`OpenAI:DEBUG:${e}`,...r)}}const Be=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),He=(e,t)=>{const r=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const n=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,(e,t,r)=>t+r.toUpperCase());for(const a of[t,r,t.toUpperCase(),n]){const t=e.get(a);if(t)return t}}for(const[n,a]of Object.entries(e))if(n.toLowerCase()===r)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${t} header, using the first entry.`),a[0]):a};function Ve(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class qe{constructor(e){this._client=e}}class Ze extends qe{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Ke extends qe{list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,Xe,{query:t,...r})}}class Je extends ve{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class We extends ve{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class Ge extends qe{constructor(){super(...arguments),this.messages=new Ke(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/chat/completions",Ye,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}}class Ye extends We{}class Xe extends We{}Ge.ChatCompletionsPage=Ye,Ge.Messages=Ke;class Qe extends qe{constructor(){super(...arguments),this.completions=new Ge(this._client)}}Qe.Completions=Ge,Qe.ChatCompletionsPage=Ye;class et extends qe{create(e,t){const r=!!e.encoding_format;let n=r?e.encoding_format:"base64";r&&Fe("Request","User defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:n},...t});return r?a:(Fe("response","Decoding base64 embeddings to float32 array"),a._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),r=t.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=t.charCodeAt(e);return Array.from(new Float32Array(n.buffer))}})(t)}),e)))}}class tt extends qe{create(e,t){return this._client.post("/files",pe({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/files",rt,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=18e5}={}){const n=new Set(["processed","error","deleted"]),a=Date.now();let i=await this.retrieve(e);for(;!i.status||!n.has(i.status);)if(await Ne(t),i=await this.retrieve(e),Date.now()-a>r)throw new z({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}}class rt extends We{}tt.FileObjectsPage=rt;class nt extends qe{createVariation(e,t){return this._client.post("/images/variations",pe({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",pe({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class at extends qe{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class it extends qe{create(e,t){return this._client.post("/audio/transcriptions",pe({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class st extends qe{create(e,t){return this._client.post("/audio/translations",pe({body:e,...t,__metadata:{model:e.model}}))}}class ot extends qe{constructor(){super(...arguments),this.transcriptions=new it(this._client),this.translations=new st(this._client),this.speech=new at(this._client)}}ot.Transcriptions=it,ot.Translations=st,ot.Speech=at;class lt extends qe{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class ct extends qe{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",ut,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class ut extends Je{}ct.ModelsPage=ut;class ht extends qe{}class dt extends qe{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class pt extends qe{constructor(){super(...arguments),this.graders=new dt(this._client)}}pt.Graders=dt;class mt extends qe{create(e,t,r){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,ft,{body:t,method:"post",...r})}retrieve(e,t={},r){return xe(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}del(e,t,r){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,r)}}class ft extends Je{}mt.PermissionCreateResponsesPage=ft;class gt extends qe{constructor(){super(...arguments),this.permissions=new mt(this._client)}}gt.Permissions=mt,gt.PermissionCreateResponsesPage=ft;class yt extends qe{list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,bt,{query:t,...r})}}class bt extends We{}yt.FineTuningJobCheckpointsPage=bt;class wt extends qe{constructor(){super(...arguments),this.checkpoints=new yt(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",_t,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return xe(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,vt,{query:t,...r})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class _t extends We{}class vt extends We{}wt.FineTuningJobsPage=_t,wt.FineTuningJobEventsPage=vt,wt.Checkpoints=yt,wt.FineTuningJobCheckpointsPage=bt;class Ot extends qe{constructor(){super(...arguments),this.methods=new ht(this._client),this.jobs=new wt(this._client),this.checkpoints=new gt(this._client),this.alpha=new pt(this._client)}}Ot.Methods=ht,Ot.Jobs=wt,Ot.FineTuningJobsPage=_t,Ot.FineTuningJobEventsPage=vt,Ot.Checkpoints=gt,Ot.Alpha=pt;class At extends qe{}class Et extends qe{constructor(){super(...arguments),this.graderModels=new At(this._client)}}Et.GraderModels=At;class xt extends qe{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,It,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){const n=await this.create(e,t,r);return await this.poll(e,n.id,r)}async poll(e,t,r){const n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const a=await this.retrieve(e,t,{...r,headers:n}).withResponse(),i=a.data;switch(i.status){case"in_progress":let e=5e3;if(r?.pollIntervalMs)e=r.pollIntervalMs;else{const t=a.response.headers.get("openai-poll-after-ms");if(t){const r=parseInt(t);isNaN(r)||(e=r)}}await Ne(e);break;case"failed":case"completed":return i}}}async upload(e,t,r){const n=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:n.id},r)}async uploadAndPoll(e,t,r){const n=await this.upload(e,t,r);return await this.poll(e,n.id,r)}content(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Pt,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class It extends We{}class Pt extends Je{}xt.VectorStoreFilesPage=It,xt.FileContentResponsesPage=Pt;class St extends qe{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){const n=await this.create(e,t);return await this.poll(e,n.id,r)}listFiles(e,t,r={},n){return xe(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,It,{query:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async poll(e,t,r){const n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,t,{...r,headers:n}).withResponse();switch(a.status){case"in_progress":let e=5e3;if(r?.pollIntervalMs)e=r.pollIntervalMs;else{const t=i.headers.get("openai-poll-after-ms");if(t){const r=parseInt(t);isNaN(r)||(e=r)}}await Ne(e);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},n){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=n?.maxConcurrency??5,i=Math.min(a,t.length),s=this._client,o=t.values(),l=[...r],c=Array(i).fill(o).map(async function(e){for(let t of e){const e=await s.files.create({file:t,purpose:"assistants"},n);l.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),r=t.filter(e=>"rejected"===e.status);if(r.length){for(const e of r)console.error(e.reason);throw new Error(`${r.length} promise(s) failed - see the above errors`)}const n=[];for(const e of t)"fulfilled"===e.status&&n.push(e.value);return n})(c),await this.createAndPoll(e,{file_ids:l})}}class kt extends qe{constructor(){super(...arguments),this.files=new xt(this._client),this.fileBatches=new St(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/vector_stores",Tt,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/search`,Ct,{body:t,method:"post",...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class Tt extends We{}class Ct extends Je{}kt.VectorStoresPage=Tt,kt.VectorStoreSearchResponsesPage=Ct,kt.Files=xt,kt.VectorStoreFilesPage=It,kt.FileContentResponsesPage=Pt,kt.FileBatches=St;class jt extends qe{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/assistants",Nt,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Nt extends We{}function Rt(e){return"function"==typeof e.parse}jt.AssistantsPage=Nt;const $t=e=>"assistant"===e?.role,Lt=e=>"function"===e?.role,Mt=e=>"tool"===e?.role;var Dt,Ut,zt,Ft,Bt,Ht,Vt,qt,Zt,Kt,Jt,Wt,Gt,Yt=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r},Xt=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class Qt{constructor(){Dt.add(this),this.controller=new AbortController,Ut.set(this,void 0),zt.set(this,()=>{}),Ft.set(this,()=>{}),Bt.set(this,void 0),Ht.set(this,()=>{}),Vt.set(this,()=>{}),qt.set(this,{}),Zt.set(this,!1),Kt.set(this,!1),Jt.set(this,!1),Wt.set(this,!1),Yt(this,Ut,new Promise((e,t)=>{Yt(this,zt,e,"f"),Yt(this,Ft,t,"f")}),"f"),Yt(this,Bt,new Promise((e,t)=>{Yt(this,Ht,e,"f"),Yt(this,Vt,t,"f")}),"f"),Xt(this,Ut,"f").catch(()=>{}),Xt(this,Bt,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},Xt(this,Dt,"m",Gt).bind(this))},0)}_connected(){this.ended||(Xt(this,zt,"f").call(this),this._emit("connect"))}get ended(){return Xt(this,Zt,"f")}get errored(){return Xt(this,Kt,"f")}get aborted(){return Xt(this,Jt,"f")}abort(){this.controller.abort()}on(e,t){return(Xt(this,qt,"f")[e]||(Xt(this,qt,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=Xt(this,qt,"f")[e];if(!r)return this;const n=r.findIndex(e=>e.listener===t);return n>=0&&r.splice(n,1),this}once(e,t){return(Xt(this,qt,"f")[e]||(Xt(this,qt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{Yt(this,Wt,!0,"f"),"error"!==e&&this.once("error",r),this.once(e,t)})}async done(){Yt(this,Wt,!0,"f"),await Xt(this,Bt,"f")}_emit(e,...t){if(Xt(this,Zt,"f"))return;"end"===e&&(Yt(this,Zt,!0,"f"),Xt(this,Ht,"f").call(this));const r=Xt(this,qt,"f")[e];if(r&&(Xt(this,qt,"f")[e]=r.filter(e=>!e.once),r.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return Xt(this,Wt,"f")||r?.length||Promise.reject(e),Xt(this,Ft,"f").call(this,e),Xt(this,Vt,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Xt(this,Wt,"f")||r?.length||Promise.reject(e),Xt(this,Ft,"f").call(this,e),Xt(this,Vt,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function er(e){return"auto-parseable-response-format"===e?.$brand}function tr(e){return"auto-parseable-tool"===e?.$brand}function rr(e,t){const r=e.choices.map(e=>{if("length"===e.finish_reason)throw new W;if("content_filter"===e.finish_reason)throw new G;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>function(e,t){const r=e.tools?.find(e=>e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:tr(r)?r.$parseRaw(t.function.arguments):r?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?nr(t,e.message.content):null}}});return{...e,choices:r}}function nr(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function ar(e,t){if(!e)return!1;const r=e.tools?.find(e=>e.function?.name===t.function.name);return tr(r)||r?.function.strict||!1}function ir(e){return!!er(e.response_format)||(e.tools?.some(e=>tr(e)||"function"===e.type&&!0===e.function.strict)??!1)}Ut=new WeakMap,zt=new WeakMap,Ft=new WeakMap,Bt=new WeakMap,Ht=new WeakMap,Vt=new WeakMap,qt=new WeakMap,Zt=new WeakMap,Kt=new WeakMap,Jt=new WeakMap,Wt=new WeakMap,Dt=new WeakSet,Gt=function(e){if(Yt(this,Kt,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new D),e instanceof D)return Yt(this,Jt,!0,"f"),this._emit("abort",e);if(e instanceof L)return this._emit("error",e);if(e instanceof Error){const t=new L(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new L(String(e)))};var sr,or,lr,cr,ur,hr,dr,pr,mr=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};const fr=10;class gr extends Qt{constructor(){super(...arguments),sr.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(Lt(e)||Mt(e))&&e.content)this._emit("functionCallResult",e.content);else if($t(e)&&e.function_call)this._emit("functionCall",e.function_call);else if($t(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new L("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),mr(this,sr,"m",or).call(this)}async finalMessage(){return await this.done(),mr(this,sr,"m",lr).call(this)}async finalFunctionCall(){return await this.done(),mr(this,sr,"m",cr).call(this)}async finalFunctionCallResult(){return await this.done(),mr(this,sr,"m",ur).call(this)}async totalUsage(){return await this.done(),mr(this,sr,"m",hr).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=mr(this,sr,"m",lr).call(this);t&&this._emit("finalMessage",t);const r=mr(this,sr,"m",or).call(this);r&&this._emit("finalContent",r);const n=mr(this,sr,"m",cr).call(this);n&&this._emit("finalFunctionCall",n);const a=mr(this,sr,"m",ur).call(this);null!=a&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",mr(this,sr,"m",hr).call(this))}async _createChatCompletion(e,t,r){const n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),mr(this,sr,"m",dr).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(rr(a,t))}async _runChatCompletion(e,t,r){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){const n="function",{function_call:a="auto",stream:i,...s}=t,o="string"!=typeof a&&a?.name,{maxChatCompletions:l=fr}=r||{},c={};for(const e of t.functions)c[e.name||e.function.name]=e;const u=t.functions.map(e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description}));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...s,function_call:a,functions:u,messages:[...this.messages]},r),i=t.choices[0]?.message;if(!i)throw new L("missing message in ChatCompletion response");if(!i.function_call)return;const{name:l,arguments:h}=i.function_call,d=c[l];if(!d){const e=`Invalid function_call: ${JSON.stringify(l)}. Available options are: ${u.map(e=>JSON.stringify(e.name)).join(", ")}. Please try again`;this._addMessage({role:n,name:l,content:e});continue}if(o&&o!==l){const e=`Invalid function_call: ${JSON.stringify(l)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:n,name:l,content:e});continue}let p;try{p=Rt(d)?await d.parse(h):h}catch(e){this._addMessage({role:n,name:l,content:e instanceof Error?e.message:String(e)});continue}const m=await d.function(p,this),f=mr(this,sr,"m",pr).call(this,m);if(this._addMessage({role:n,name:l,content:f}),o)return}}async _runTools(e,t,r){const n="tool",{tool_choice:a="auto",stream:i,...s}=t,o="string"!=typeof a&&a?.function?.name,{maxChatCompletions:l=fr}=r||{},c=t.tools.map(e=>{if(tr(e)){if(!e.$callback)throw new L("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),u={};for(const e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const h="tools"in t?c.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...s,tool_choice:a,tools:h,messages:[...this.messages]},r),i=t.choices[0]?.message;if(!i)throw new L("missing message in ChatCompletion response");if(!i.tool_calls?.length)return;for(const e of i.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:r,arguments:a}=e.function,i=u[r];if(!i){const e=`Invalid tool_call: ${JSON.stringify(r)}. Available options are: ${Object.keys(u).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:n,tool_call_id:t,content:e});continue}if(o&&o!==r){const e=`Invalid tool_call: ${JSON.stringify(r)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:n,tool_call_id:t,content:e});continue}let s;try{s=Rt(i)?await i.parse(a):a}catch(e){const r=e instanceof Error?e.message:String(e);this._addMessage({role:n,tool_call_id:t,content:r});continue}const l=await i.function(s,this),c=mr(this,sr,"m",pr).call(this,l);if(this._addMessage({role:n,tool_call_id:t,content:c}),o)return}}}}sr=new WeakSet,or=function(){return mr(this,sr,"m",lr).call(this).content??null},lr=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if($t(t)){const{function_call:e,...r}=t,n={...r,content:t.content??null,refusal:t.refusal??null};return e&&(n.function_call=e),n}}throw new L("stream ended without producing a ChatCompletionMessage with role=assistant")},cr=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if($t(t)&&t?.function_call)return t.function_call;if($t(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},ur=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Lt(t)&&null!=t.content)return t.content;if(Mt(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},hr=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},dr=function(e){if(null!=e.n&&e.n>1)throw new L("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},pr=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class yr extends gr{static runFunctions(e,t,r){const n=new yr,a={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return n._run(()=>n._runFunctions(e,t,a)),n}static runTools(e,t,r){const n=new yr,a={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,a)),n}_addMessage(e,t=!0){super._addMessage(e,t),$t(e)&&e.content&&this._emit("content",e.content)}}class br extends Error{}class wr extends Error{}const _r=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const r=e.length;let n=0;const a=e=>{throw new br(`${e} at position ${n}`)},i=e=>{throw new wr(`${e} at position ${n}`)},s=()=>(h(),n>=r&&a("Unexpected end of input"),'"'===e[n]?o():"{"===e[n]?l():"["===e[n]?c():"null"===e.substring(n,n+4)||16&t&&r-n<4&&"null".startsWith(e.substring(n))?(n+=4,null):"true"===e.substring(n,n+4)||32&t&&r-n<4&&"true".startsWith(e.substring(n))?(n+=4,!0):"false"===e.substring(n,n+5)||32&t&&r-n<5&&"false".startsWith(e.substring(n))?(n+=5,!1):"Infinity"===e.substring(n,n+8)||128&t&&r-n<8&&"Infinity".startsWith(e.substring(n))?(n+=8,1/0):"-Infinity"===e.substring(n,n+9)||256&t&&1<r-n&&r-n<9&&"-Infinity".startsWith(e.substring(n))?(n+=9,-1/0):"NaN"===e.substring(n,n+3)||64&t&&r-n<3&&"NaN".startsWith(e.substring(n))?(n+=3,NaN):u()),o=()=>{const s=n;let o=!1;for(n++;n<r&&('"'!==e[n]||o&&"\\"===e[n-1]);)o="\\"===e[n]&&!o,n++;if('"'==e.charAt(n))try{return JSON.parse(e.substring(s,++n-Number(o)))}catch(e){i(String(e))}else if(1&t)try{return JSON.parse(e.substring(s,n-Number(o))+'"')}catch(t){return JSON.parse(e.substring(s,e.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},l=()=>{n++,h();const i={};try{for(;"}"!==e[n];){if(h(),n>=r&&8&t)return i;const a=o();h(),n++;try{const e=s();Object.defineProperty(i,a,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return i;throw e}h(),","===e[n]&&n++}}catch(e){if(8&t)return i;a("Expected '}' at end of object")}return n++,i},c=()=>{n++;const r=[];try{for(;"]"!==e[n];)r.push(s()),h(),","===e[n]&&n++}catch(e){if(4&t)return r;a("Expected ']' at end of array")}return n++,r},u=()=>{if(0===n){"-"===e&&2&t&&a("Not sure what '-' is");try{return JSON.parse(e)}catch(r){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}i(String(r))}}const s=n;for("-"===e[n]&&n++;e[n]&&!",]}".includes(e[n]);)n++;n!=r||2&t||a("Unterminated number literal");try{return JSON.parse(e.substring(s,n))}catch(r){"-"===e.substring(s,n)&&2&t&&a("Not sure what '-' is");try{return JSON.parse(e.substring(s,e.lastIndexOf("e")))}catch(e){i(String(e))}}},h=()=>{for(;n<r&&" \n\r\t".includes(e[n]);)n++};return s()})(e.trim(),t)}(e,509);var vr,Or,Ar,Er,xr,Ir,Pr,Sr,kr,Tr,Cr,jr,Nr=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r},Rr=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class $r extends gr{constructor(e){super(),vr.add(this),Or.set(this,void 0),Ar.set(this,void 0),Er.set(this,void 0),Nr(this,Or,e,"f"),Nr(this,Ar,[],"f")}get currentChatCompletionSnapshot(){return Rr(this,Er,"f")}static fromReadableStream(e){const t=new $r(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const n=new $r(t);return n._run(()=>n._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(e,t,r){super._createChatCompletion;const n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),Rr(this,vr,"m",xr).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const e of a)Rr(this,vr,"m",Pr).call(this,e);if(a.controller.signal?.aborted)throw new D;return this._addChatCompletion(Rr(this,vr,"m",Tr).call(this))}async _fromReadableStream(e,t){const r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Rr(this,vr,"m",xr).call(this),this._connected();const n=ae.fromReadableStream(e,this.controller);let a;for await(const e of n)a&&a!==e.id&&this._addChatCompletion(Rr(this,vr,"m",Tr).call(this)),Rr(this,vr,"m",Pr).call(this,e),a=e.id;if(n.controller.signal?.aborted)throw new D;return this._addChatCompletion(Rr(this,vr,"m",Tr).call(this))}[(Or=new WeakMap,Ar=new WeakMap,Er=new WeakMap,vr=new WeakSet,xr=function(){this.ended||Nr(this,Er,void 0,"f")},Ir=function(e){let t=Rr(this,Ar,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Rr(this,Ar,"f")[e.index]=t,t)},Pr=function(e){if(this.ended)return;const t=Rr(this,vr,"m",jr).call(this,e);this._emit("chunk",e,t);for(const r of e.choices){const e=t.choices[r.index];null!=r.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",r.delta.content,e.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=r.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:e.message.refusal}),null!=r.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=r.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const n=Rr(this,vr,"m",Ir).call(this,e);e.finish_reason&&(Rr(this,vr,"m",kr).call(this,e),null!=n.current_tool_call_index&&Rr(this,vr,"m",Sr).call(this,e,n.current_tool_call_index));for(const t of r.delta.tool_calls??[])n.current_tool_call_index!==t.index&&(Rr(this,vr,"m",kr).call(this,e),null!=n.current_tool_call_index&&Rr(this,vr,"m",Sr).call(this,e,n.current_tool_call_index)),n.current_tool_call_index=t.index;for(const t of r.delta.tool_calls??[]){const r=e.message.tool_calls?.[t.index];r?.type&&("function"===r?.type?this._emit("tool_calls.function.arguments.delta",{name:r.function?.name,index:t.index,arguments:r.function.arguments,parsed_arguments:r.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):Dr())}}},Sr=function(e,t){if(Rr(this,vr,"m",Ir).call(this,e).done_tool_calls.has(t))return;const r=e.message.tool_calls?.[t];if(!r)throw new Error("no tool call snapshot");if(!r.type)throw new Error("tool call snapshot missing `type`");if("function"===r.type){const e=Rr(this,Or,"f")?.tools?.find(e=>"function"===e.type&&e.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:t,arguments:r.function.arguments,parsed_arguments:tr(e)?e.$parseRaw(r.function.arguments):e?.function.strict?JSON.parse(r.function.arguments):null})}else r.type},kr=function(e){const t=Rr(this,vr,"m",Ir).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const r=Rr(this,vr,"m",Cr).call(this);this._emit("content.done",{content:e.message.content,parsed:r?r.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Tr=function(){if(this.ended)throw new L("stream has ended, this shouldn't happen");const e=Rr(this,Er,"f");if(!e)throw new L("request ended without sending any chunks");return Nr(this,Er,void 0,"f"),Nr(this,Ar,[],"f"),function(e,t){const{id:r,choices:n,created:a,model:i,system_fingerprint:s,...o}=e,l={...o,id:r,choices:n.map(({message:t,finish_reason:r,index:n,logprobs:a,...i})=>{if(!r)throw new L(`missing finish_reason for choice ${n}`);const{content:s=null,function_call:o,tool_calls:l,...c}=t,u=t.role;if(!u)throw new L(`missing role for choice ${n}`);if(o){const{arguments:e,name:l}=o;if(null==e)throw new L(`missing function_call.arguments for choice ${n}`);if(!l)throw new L(`missing function_call.name for choice ${n}`);return{...i,message:{content:s,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:r,index:n,logprobs:a}}return l?{...i,index:n,finish_reason:r,logprobs:a,message:{...c,role:u,content:s,refusal:t.refusal??null,tool_calls:l.map((t,r)=>{const{function:a,type:i,id:s,...o}=t,{arguments:l,name:c,...u}=a||{};if(null==s)throw new L(`missing choices[${n}].tool_calls[${r}].id\n${Lr(e)}`);if(null==i)throw new L(`missing choices[${n}].tool_calls[${r}].type\n${Lr(e)}`);if(null==c)throw new L(`missing choices[${n}].tool_calls[${r}].function.name\n${Lr(e)}`);if(null==l)throw new L(`missing choices[${n}].tool_calls[${r}].function.arguments\n${Lr(e)}`);return{...o,id:s,type:i,function:{...u,name:c,arguments:l}}})}}:{...i,message:{...c,content:s,role:u,refusal:t.refusal??null},finish_reason:r,index:n,logprobs:a}}),created:a,model:i,object:"chat.completion",...s?{system_fingerprint:s}:{}};return function(e,t){return t&&ir(t)?rr(e,t):{...e,choices:e.choices.map(e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(l,t)}(e,Rr(this,Or,"f"))},Cr=function(){const e=Rr(this,Or,"f")?.response_format;return er(e)?e:null},jr=function(e){var t,r,n,a;let i=Rr(this,Er,"f");const{choices:s,...o}=e;i?Object.assign(i,o):i=Nr(this,Er,{...o,choices:[]},"f");for(const{delta:s,finish_reason:o,index:l,logprobs:c=null,...u}of e.choices){let e=i.choices[l];if(e||(e=i.choices[l]={finish_reason:o,index:l,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:n,refusal:a,...i}=c;Mr(),Object.assign(e.logprobs,i),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n)),a&&((r=e.logprobs).refusal??(r.refusal=[]),e.logprobs.refusal.push(...a))}else e.logprobs=Object.assign({},c);if(o&&(e.finish_reason=o,Rr(this,Or,"f")&&ir(Rr(this,Or,"f")))){if("length"===o)throw new W;if("content_filter"===o)throw new G}if(Object.assign(e,u),!s)continue;const{content:h,refusal:d,function_call:p,role:m,tool_calls:f,...g}=s;if(Mr(),Object.assign(e.message,g),d&&(e.message.refusal=(e.message.refusal||"")+d),m&&(e.message.role=m),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),h&&(e.message.content=(e.message.content||"")+h,!e.message.refusal&&Rr(this,vr,"m",Cr).call(this)&&(e.message.parsed=_r(e.message.content))),f){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:r,type:n,function:i,...s}of f){const o=(a=e.message.tool_calls)[t]??(a[t]={});Object.assign(o,s),r&&(o.id=r),n&&(o.type=n),i&&(o.function??(o.function={name:i.name??"",arguments:""})),i?.name&&(o.function.name=i.name),i?.arguments&&(o.function.arguments+=i.arguments,ar(Rr(this,Or,"f"),o)&&(o.function.parsed_arguments=_r(o.function.arguments)))}}}return i},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",r=>{const n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{r=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),this.on("error",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ae(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Lr(e){return JSON.stringify(e)}function Mr(e){}function Dr(_x){}class Ur extends $r{static fromReadableStream(e){const t=new Ur(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){const n=new Ur(null),a={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return n._run(()=>n._runFunctions(e,t,a)),n}static runTools(e,t,r){const n=new Ur(t),a={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,a)),n}}class zr extends qe{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new L(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new L(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(t=>rr(t,e))}runFunctions(e,t){return e.stream?Ur.runFunctions(this._client,e,t):yr.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Ur.runTools(this._client,e,t):yr.runTools(this._client,e,t)}stream(e,t){return $r.createChatCompletion(this._client,e,t)}}class Fr extends qe{constructor(){super(...arguments),this.completions=new zr(this._client)}}!function(e){e.Completions=zr}(Fr||(Fr={}));class Br extends qe{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Hr extends qe{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Vr extends qe{constructor(){super(...arguments),this.sessions=new Br(this._client),this.transcriptionSessions=new Hr(this._client)}}Vr.Sessions=Br,Vr.TranscriptionSessions=Hr;var qr,Zr,Kr,Jr,Wr,Gr,Yr,Xr,Qr,en,tn,rn,nn,an,sn,on,ln,cn,un,hn,dn,pn,mn=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)},fn=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r};class gn extends Qt{constructor(){super(...arguments),qr.add(this),Zr.set(this,[]),Kr.set(this,{}),Jr.set(this,{}),Wr.set(this,void 0),Gr.set(this,void 0),Yr.set(this,void 0),Xr.set(this,void 0),Qr.set(this,void 0),en.set(this,void 0),tn.set(this,void 0),rn.set(this,void 0),nn.set(this,void 0)}[(Zr=new WeakMap,Kr=new WeakMap,Jr=new WeakMap,Wr=new WeakMap,Gr=new WeakMap,Yr=new WeakMap,Xr=new WeakMap,Qr=new WeakMap,en=new WeakMap,tn=new WeakMap,rn=new WeakMap,nn=new WeakMap,qr=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",r=>{const n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{r=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),this.on("error",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new gn;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const n=ae.fromReadableStream(e,this.controller);for await(const e of n)mn(this,qr,"m",an).call(this,e);if(n.controller.signal?.aborted)throw new D;return this._addRun(mn(this,qr,"m",sn).call(this))}toReadableStream(){return new ae(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,n,a){const i=new gn;return i._run(()=>i._runToolAssistantStream(e,t,r,n,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,n,a){const i=a?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const s={...n,stream:!0},o=await e.submitToolOutputs(t,r,s,{...a,signal:this.controller.signal});this._connected();for await(const e of o)mn(this,qr,"m",an).call(this,e);if(o.controller.signal?.aborted)throw new D;return this._addRun(mn(this,qr,"m",sn).call(this))}static createThreadAssistantStream(e,t,r){const n=new gn;return n._run(()=>n._threadAssistantStream(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(e,t,r,n){const a=new gn;return a._run(()=>a._runAssistantStream(e,t,r,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return mn(this,tn,"f")}currentRun(){return mn(this,rn,"f")}currentMessageSnapshot(){return mn(this,Wr,"f")}currentRunStepSnapshot(){return mn(this,nn,"f")}async finalRunSteps(){return await this.done(),Object.values(mn(this,Kr,"f"))}async finalMessages(){return await this.done(),Object.values(mn(this,Jr,"f"))}async finalRun(){if(await this.done(),!mn(this,Gr,"f"))throw Error("Final run was not received.");return mn(this,Gr,"f")}async _createThreadAssistantStream(e,t,r){const n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));const a={...t,stream:!0},i=await e.createAndRun(a,{...r,signal:this.controller.signal});this._connected();for await(const e of i)mn(this,qr,"m",an).call(this,e);if(i.controller.signal?.aborted)throw new D;return this._addRun(mn(this,qr,"m",sn).call(this))}async _createAssistantStream(e,t,r,n){const a=n?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const i={...r,stream:!0},s=await e.create(t,i,{...n,signal:this.controller.signal});this._connected();for await(const e of s)mn(this,qr,"m",an).call(this,e);if(s.controller.signal?.aborted)throw new D;return this._addRun(mn(this,qr,"m",sn).call(this))}static accumulateDelta(e,t){for(const[r,n]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=n;continue}let t=e[r];if(null!=t)if("index"!==r&&"type"!==r){if("string"==typeof t&&"string"==typeof n)t+=n;else if("number"==typeof t&&"number"==typeof n)t+=n;else{if(!Ve(t)||!Ve(n)){if(Array.isArray(t)&&Array.isArray(n)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...n);continue}for(const e of n){if(!Ve(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const r=e.index;if(null==r)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof r)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${r}`);const n=t[r];null==n?t.push(e):t[r]=this.accumulateDelta(n,e)}continue}throw Error(`Unhandled record type: ${r}, deltaValue: ${n}, accValue: ${t}`)}t=this.accumulateDelta(t,n)}e[r]=t}else e[r]=n;else e[r]=n}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,n){return await this._createAssistantStream(t,e,r,n)}async _runToolAssistantStream(e,t,r,n,a){return await this._createToolAssistantStream(r,e,t,n,a)}}an=function(e){if(!this.ended)switch(fn(this,tn,e,"f"),mn(this,qr,"m",cn).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":mn(this,qr,"m",pn).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":mn(this,qr,"m",ln).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":mn(this,qr,"m",on).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},sn=function(){if(this.ended)throw new L("stream has ended, this shouldn't happen");if(!mn(this,Gr,"f"))throw Error("Final run has not been received");return mn(this,Gr,"f")},on=function(e){const[t,r]=mn(this,qr,"m",hn).call(this,e,mn(this,Wr,"f"));fn(this,Wr,t,"f"),mn(this,Jr,"f")[t.id]=t;for(const e of r){const r=t.content[e.index];"text"==r?.type&&this._emit("textCreated",r.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const r of e.data.delta.content){if("text"==r.type&&r.text){let e=r.text,n=t.content[r.index];if(!n||"text"!=n.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,n.text)}if(r.index!=mn(this,Yr,"f")){if(mn(this,Xr,"f"))switch(mn(this,Xr,"f").type){case"text":this._emit("textDone",mn(this,Xr,"f").text,mn(this,Wr,"f"));break;case"image_file":this._emit("imageFileDone",mn(this,Xr,"f").image_file,mn(this,Wr,"f"))}fn(this,Yr,r.index,"f")}fn(this,Xr,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==mn(this,Yr,"f")){const t=e.data.content[mn(this,Yr,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,mn(this,Wr,"f"));break;case"text":this._emit("textDone",t.text,mn(this,Wr,"f"))}}mn(this,Wr,"f")&&this._emit("messageDone",e.data),fn(this,Wr,void 0,"f")}},ln=function(e){const t=mn(this,qr,"m",un).call(this,e);switch(fn(this,nn,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&"tool_calls"==r.step_details.type&&r.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of r.step_details.tool_calls)e.index==mn(this,Qr,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(mn(this,en,"f")&&this._emit("toolCallDone",mn(this,en,"f")),fn(this,Qr,e.index,"f"),fn(this,en,t.step_details.tool_calls[e.index],"f"),mn(this,en,"f")&&this._emit("toolCallCreated",mn(this,en,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":fn(this,nn,void 0,"f"),"tool_calls"==e.data.step_details.type&&mn(this,en,"f")&&(this._emit("toolCallDone",mn(this,en,"f")),fn(this,en,void 0,"f")),this._emit("runStepDone",e.data,t)}},cn=function(e){mn(this,Zr,"f").push(e),this._emit("event",e)},un=function(e){switch(e.event){case"thread.run.step.created":return mn(this,Kr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=mn(this,Kr,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const n=gn.accumulateDelta(t,r.delta);mn(this,Kr,"f")[e.data.id]=n}return mn(this,Kr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":mn(this,Kr,"f")[e.data.id]=e.data}if(mn(this,Kr,"f")[e.data.id])return mn(this,Kr,"f")[e.data.id];throw new Error("No snapshot available")},hn=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=e.data;if(n.delta.content)for(const e of n.delta.content)if(e.index in t.content){let r=t.content[e.index];t.content[e.index]=mn(this,qr,"m",dn).call(this,e,r)}else t.content[e.index]=e,r.push(e);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},dn=function(e,t){return gn.accumulateDelta(t,e)},pn=function(e){switch(fn(this,rn,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":fn(this,Gr,e.data,"f"),mn(this,en,"f")&&(this._emit("toolCallDone",mn(this,en,"f")),fn(this,en,void 0,"f"))}};class yn extends qe{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,bn,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class bn extends We{}yn.MessagesPage=bn;class wn extends qe{retrieve(e,t,r,n={},a){return xe(n)?this.retrieve(e,t,r,{},n):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:n,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t,r={},n){return xe(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,vn,{query:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class vn extends We{}wn.RunStepsPage=vn;class On extends qe{constructor(){super(...arguments),this.steps=new wn(this._client)}create(e,t,r){const{include:n,...a}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:n},body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,An,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){const n=await this.create(e,t,r);return await this.poll(e,n.id,r)}createAndStream(e,t,r){return gn.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){const n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:i}=await this.retrieve(e,t,{...r,headers:{...r?.headers,...n}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(r?.pollIntervalMs)e=r.pollIntervalMs;else{const t=i.headers.get("openai-poll-after-ms");if(t){const r=parseInt(t);isNaN(r)||(e=r)}}await Ne(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,t,r){return gn.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,n){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,n){const a=await this.submitToolOutputs(e,t,r,n);return await this.poll(e,a.id,n)}submitToolOutputsStream(e,t,r,n){return gn.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,n)}}class An extends We{}On.RunsPage=An,On.Steps=wn,On.RunStepsPage=vn;class En extends qe{constructor(){super(...arguments),this.runs=new On(this._client),this.messages=new yn(this._client)}create(e={},t){return xe(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return gn.createThreadAssistantStream(e,this._client.beta.threads,t)}}En.Runs=On,En.RunsPage=An,En.Messages=yn,En.MessagesPage=bn;class xn extends qe{constructor(){super(...arguments),this.realtime=new Vr(this._client),this.chat=new Fr(this._client),this.assistants=new jt(this._client),this.threads=new En(this._client)}}xn.Realtime=Vr,xn.Assistants=jt,xn.AssistantsPage=Nt,xn.Threads=En;class In extends qe{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/batches",Pn,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Pn extends We{}In.BatchesPage=Pn;class Sn extends qe{create(e,t,r){return this._client.post(`/uploads/${e}/parts`,pe({body:t,...r}))}}class kn extends qe{constructor(){super(...arguments),this.parts=new Sn(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}}function Tn(e,t){const r=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:jn(t,e)};if("message"===e.type){const r=e.content.map(e=>"output_text"===e.type?{...e,parsed:Cn(t,e.text)}:e);return{...e,content:r}}return e}),n=Object.assign({},e,{output:r});return Object.getOwnPropertyDescriptor(e,"output_text")||Nn(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const e of n.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),n}function Cn(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const r=e.text?.format;return r.$parseRaw(t)}return JSON.parse(t)}function jn(e,t){const r=(n=e.tools??[],a=t.name,n.find(e=>"function"===e.type&&e.name===a));var n,a,i;return{...t,...t,parsed_arguments:(i=r,"auto-parseable-tool"===i?.$brand?r.$parseRaw(t.arguments):r?.strict?JSON.parse(t.arguments):null)}}function Nn(e){const t=[];for(const r of e.output)if("message"===r.type)for(const e of r.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}kn.Parts=Sn;class Rn extends qe{list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Jn,{query:t,...r})}}var $n,Ln,Mn,Dn,Un,zn,Fn,Bn,Hn,Vn=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r},qn=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class Zn extends Qt{constructor(e){super(),$n.add(this),Ln.set(this,void 0),Mn.set(this,void 0),Dn.set(this,void 0),Vn(this,Ln,e,"f")}static createResponse(e,t,r){const n=new Zn(t);return n._run(()=>n._createOrRetrieveResponse(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(e,t,r){const n=r?.signal;let a;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),qn(this,$n,"m",Un).call(this);let i=null;"response_id"in t?(a=await e.responses.retrieve(t.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),i=t.starting_after??null):a=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(const e of a)qn(this,$n,"m",zn).call(this,e,i);if(a.controller.signal?.aborted)throw new D;return qn(this,$n,"m",Fn).call(this)}[(Ln=new WeakMap,Mn=new WeakMap,Dn=new WeakMap,$n=new WeakSet,Un=function(){this.ended||Vn(this,Mn,void 0,"f")},zn=function(e,t){if(this.ended)return;const r=(e,r)=>{(null==t||r.sequence_number>t)&&this._emit(e,r)},n=qn(this,$n,"m",Bn).call(this,e);switch(r("event",e),e.type){case"response.output_text.delta":{const t=n.output[e.output_index];if(!t)throw new L(`missing output at index ${e.output_index}`);if("message"===t.type){const n=t.content[e.content_index];if(!n)throw new L(`missing content at index ${e.content_index}`);if("output_text"!==n.type)throw new L(`expected content to be 'output_text', got ${n.type}`);r("response.output_text.delta",{...e,snapshot:n.text})}break}case"response.function_call_arguments.delta":{const t=n.output[e.output_index];if(!t)throw new L(`missing output at index ${e.output_index}`);"function_call"===t.type&&r("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:r(e.type,e)}},Fn=function(){if(this.ended)throw new L("stream has ended, this shouldn't happen");const e=qn(this,Mn,"f");if(!e)throw new L("request ended without sending any events");Vn(this,Mn,void 0,"f");const t=function(e,t){return function(e,t){return t&&function(e){return!!er(e.text?.format)}(t)?Tn(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,t)}(e,qn(this,Ln,"f"));return Vn(this,Dn,t,"f"),t},Bn=function(e){let t=qn(this,Mn,"f");if(!t){if("response.created"!==e.type)throw new L(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=Vn(this,Mn,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const r=t.output[e.output_index];if(!r)throw new L(`missing output at index ${e.output_index}`);"message"===r.type&&r.content.push(e.part);break}case"response.output_text.delta":{const r=t.output[e.output_index];if(!r)throw new L(`missing output at index ${e.output_index}`);if("message"===r.type){const t=r.content[e.content_index];if(!t)throw new L(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new L(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const r=t.output[e.output_index];if(!r)throw new L(`missing output at index ${e.output_index}`);"function_call"===r.type&&(r.arguments+=e.delta);break}case"response.completed":Vn(this,Mn,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",r=>{const n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{r=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),this.on("error",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=qn(this,Dn,"f");if(!e)throw new L("stream ended without producing a ChatCompletion");return e}}class Kn extends qe{constructor(){super(...arguments),this.inputItems=new Rn(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&Nn(e),e))}retrieve(e,t={},r){return this._client.get(`/responses/${e}`,{query:t,...r,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>Tn(t,e))}stream(e,t){return Zn.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class Jn extends We{}Kn.InputItems=Rn;class Wn extends qe{retrieve(e,t,r,n){return this._client.get(`/evals/${e}/runs/${t}/output_items/${r}`,n)}list(e,t,r={},n){return xe(r)?this.list(e,t,{},r):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Gn,{query:r,...n})}}class Gn extends We{}Wn.OutputItemListResponsesPage=Gn;class Yn extends qe{constructor(){super(...arguments),this.outputItems=new Wn(this._client)}create(e,t,r){return this._client.post(`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){return this._client.get(`/evals/${e}/runs/${t}`,r)}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,Xn,{query:t,...r})}del(e,t,r){return this._client.delete(`/evals/${e}/runs/${t}`,r)}cancel(e,t,r){return this._client.post(`/evals/${e}/runs/${t}`,r)}}class Xn extends We{}Yn.RunListResponsesPage=Xn,Yn.OutputItems=Wn,Yn.OutputItemListResponsesPage=Gn;class Qn extends qe{constructor(){super(...arguments),this.runs=new Yn(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,r){return this._client.post(`/evals/${e}`,{body:t,...r})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/evals",ea,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class ea extends We{}Qn.EvalListResponsesPage=ea,Qn.Runs=Yn,Qn.RunListResponsesPage=Xn;class ta extends qe{retrieve(e,t,r){return this._client.get(`/containers/${e}/files/${t}/content`,{...r,headers:{Accept:"application/binary",...r?.headers},__binaryResponse:!0})}}class ra extends qe{constructor(){super(...arguments),this.content=new ta(this._client)}create(e,t,r){return this._client.post(`/containers/${e}/files`,pe({body:t,...r}))}retrieve(e,t,r){return this._client.get(`/containers/${e}/files/${t}`,r)}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,na,{query:t,...r})}del(e,t,r){return this._client.delete(`/containers/${e}/files/${t}`,{...r,headers:{Accept:"*/*",...r?.headers}})}}class na extends We{}ra.FileListResponsesPage=na,ra.Content=ta;class aa extends qe{constructor(){super(...arguments),this.files=new ra(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/containers",ia,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class ia extends We{}aa.ContainerListResponsesPage=ia,aa.Files=ra,aa.FileListResponsesPage=na;class sa extends _e{constructor({baseURL:e=Le("OPENAI_BASE_URL"),apiKey:t=Le("OPENAI_API_KEY"),organization:r=Le("OPENAI_ORG_ID")??null,project:n=Le("OPENAI_PROJECT_ID")??null,...a}={}){if(void 0===t)throw new L("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:r,project:n,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new L("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Ze(this),this.chat=new Qe(this),this.embeddings=new et(this),this.files=new tt(this),this.images=new nt(this),this.audio=new ot(this),this.moderations=new lt(this),this.models=new ct(this),this.fineTuning=new Ot(this),this.graders=new Et(this),this.vectorStores=new kt(this),this.beta=new xn(this),this.batches=new In(this),this.uploads=new kn(this),this.responses=new Kn(this),this.evals=new Qn(this),this.containers=new aa(this),this._options=i,this.apiKey=t,this.organization=r,this.project=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return function(e,t={}){let r=e;const n=function(e=g){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||g.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let r=a;if(void 0!==e.format){if(!u.call(i,e.format))throw new TypeError("Unknown format option provided.");r=e.format}const n=i[r];let s,o=g.filter;if(("function"==typeof e.filter||d(e.filter))&&(o=e.filter),s=e.arrayFormat&&e.arrayFormat in h?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":g.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const l=void 0===e.allowDots?1==!!e.encodeDotInKeys||g.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:g.addQueryPrefix,allowDots:l,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:g.allowEmptyArrays,arrayFormat:s,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:g.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?g.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:g.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:g.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:g.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:g.encodeValuesOnly,filter:o,format:r,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:g.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:g.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:g.strictNullHandling}}(t);let s,o;"function"==typeof n.filter?(o=n.filter,r=o("",r)):d(n.filter)&&(o=n.filter,s=o);const l=[];if("object"!=typeof r||null===r)return"";const c=h[n.arrayFormat],p="comma"===c&&n.commaRoundTrip;s||(s=Object.keys(r)),n.sort&&s.sort(n.sort);const f=new WeakMap;for(let e=0;e<s.length;++e){const t=s[e];n.skipNulls&&null===r[t]||m(l,b(r[t],t,c,p,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,f))}const y=l.join(n.delimiter);let w=!0===n.addQueryPrefix?"?":"";return n.charsetSentinel&&("iso-8859-1"===n.charset?w+="utf8=%26%2310003%3B&":w+="utf8=%E2%9C%93&"),y.length>0?w+y:""}(e,{arrayFormat:"brackets"})}}Hn=sa,sa.OpenAI=Hn,sa.DEFAULT_TIMEOUT=6e5,sa.OpenAIError=L,sa.APIError=M,sa.APIConnectionError=U,sa.APIConnectionTimeoutError=z,sa.APIUserAbortError=D,sa.NotFoundError=V,sa.ConflictError=q,sa.RateLimitError=K,sa.BadRequestError=F,sa.AuthenticationError=B,sa.InternalServerError=J,sa.PermissionDeniedError=H,sa.UnprocessableEntityError=Z,sa.toFile=ce,sa.fileFromPath=P,sa.Completions=Ze,sa.Chat=Qe,sa.ChatCompletionsPage=Ye,sa.Embeddings=et,sa.Files=tt,sa.FileObjectsPage=rt,sa.Images=nt,sa.Audio=ot,sa.Moderations=lt,sa.Models=ct,sa.ModelsPage=ut,sa.FineTuning=Ot,sa.Graders=Et,sa.VectorStores=kt,sa.VectorStoresPage=Tt,sa.VectorStoreSearchResponsesPage=Ct,sa.Beta=xn,sa.Batches=In,sa.BatchesPage=Pn,sa.Uploads=kn,sa.Responses=Kn,sa.Evals=Qn,sa.EvalListResponsesPage=ea,sa.Containers=aa,sa.ContainerListResponsesPage=ia,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/images/edits"]);var oa=r(8575),la=r(3279),ca=r(9583),ua=r(8028),ha=r(4914),da=r(4691);function pa(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:r,azureOpenAIApiKey:n,azureOpenAIBasePath:a,baseURL:i}=e;if(n&&a&&t)return`${a}/${t}`;if(n){if(!r)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${r}.openai.azure.com/openai/deployments/${t}`}return i}function ma(e){let t;return e.constructor.name===z.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===D.name?(t=new Error(e.message),t.name="AbortError"):t=e,t}ha.j_,r(8201);var fa=r(2778);class ga extends ha.j_{constructor({concurrency:e,...t}){super(e?{maxConcurrency:e,...t}:t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","llms",this._llmType()]})}async invoke(e,t){const r=ga._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].text}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptions(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r?.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async*_streamIterator(e,t){if(this._streamResponseChunks===ga.prototype._streamResponseChunks)yield this.invoke(e,t);else{const r=ga._convertInputToPromptValue(e),[n,a]=this._separateRunnableConfigFromCallOptions(t),i=await da.Td.configure(n.callbacks,this.callbacks,n.tags,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),s={options:a,invocation_params:this?.invocationParams(a),batch_size:1},o=await(i?.handleLLMStart(this.toJSON(),[r.toString()],n.runId,void 0,s,void 0,void 0,n.runName));let l=new ua.mu({text:""});try{for await(const t of this._streamResponseChunks(e.toString(),a,o?.[0]))l=l?l.concat(t):t,"string"==typeof t.text&&(yield t.text)}catch(e){throw await Promise.all((o??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((o??[]).map(e=>e?.handleLLMEnd({generations:[[l]]})))}}async generatePrompt(e,t,r){const n=e.map(e=>e.toString());return this.generate(n,t,r)}invocationParams(e){return{}}_flattenLLMResult(e){const t=[];for(let r=0;r<e.generations.length;r+=1){const n=e.generations[r];if(0===r)t.push({generations:[n],llmOutput:e.llmOutput});else{const r=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[n],llmOutput:r})}}return t}async _generateUncached(e,t,r){const n=await da.Td.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a={options:t,invocation_params:this?.invocationParams(t),batch_size:e.length},i=await(n?.handleLLMStart(this.toJSON(),e,r.runId,void 0,a,void 0,void 0,r?.runName));let s;try{s=await this._generate(e,t,i?.[0])}catch(e){throw await Promise.all((i??[]).map(t=>t?.handleLLMError(e))),e}const o=this._flattenLLMResult(s);await Promise.all((i??[]).map((e,t)=>e?.handleLLMEnd(o[t])));const l=i?.map(e=>e.runId)||void 0;return Object.defineProperty(s,ua.SP,{value:l?{runIds:l}:void 0,configurable:!0}),s}async _generateCached({prompts:e,cache:t,llmStringKey:r,parsedOptions:n,handledOptions:a,runId:i}){const s=await da.Td.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o={options:n,invocation_params:this?.invocationParams(n),batch_size:e.length,cached:!0},l=await(s?.handleLLMStart(this.toJSON(),e,i,void 0,o,void 0,void 0,a?.runName)),c=[],u=(await Promise.allSettled(e.map(async(e,n)=>{const a=await t.lookup(e,r);return null==a&&c.push(n),a}))).map((e,t)=>({result:e,runManager:l?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),h=[];await Promise.all(u.map(async({result:e,runManager:t},r)=>{if("fulfilled"===e.status){const n=e.value;return h[r]=n,n.length&&await(t?.handleLLMNewToken(n[0].text)),t?.handleLLMEnd({generations:[n]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)}));const d={generations:h,missingPromptIndices:c};return Object.defineProperty(d,ua.SP,{value:l?{runIds:l?.map(e=>e.runId)}:void 0,configurable:!0}),d}async generate(e,t,r){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let n;n=Array.isArray(t)?{stop:t}:t;const[a,i]=this._separateRunnableConfigFromCallOptions(n);if(a.callbacks=a.callbacks??r,!this.cache)return this._generateUncached(e,i,a);const{cache:s}=this,o=this._getSerializedCacheKeyParametersForCall(i),{generations:l,missingPromptIndices:c}=await this._generateCached({prompts:e,cache:s,llmStringKey:o,parsedOptions:i,handledOptions:a,runId:a.runId});let u={};if(c.length>0){const t=await this._generateUncached(c.map(t=>e[t]),i,a);await Promise.all(t.generations.map(async(t,r)=>{const n=c[r];return l[n]=t,s.update(e[n],o,t)})),u=t.llmOutput??{}}return{generations:l,llmOutput:u}}async call(e,t,r){const{generations:n}=await this.generate([e],t,r);return n[0][0].text}async predict(e,t,r){return this.call(e,t,r)}async predictMessages(e,t,r){const n=(0,oa.Sw)(e),a=await this.call(n,t,r);return new oa.Od(a)}_identifyingParams(){return{}}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}_modelType(){return"base_llm"}}class ya extends ga{async _generate(e,t,r){return{generations:await Promise.all(e.map((e,n)=>this._call(e,{...t,promptIndex:n},r).then(e=>[{text:e}])))}}}const ba=(e,t)=>e.reduce((e,r,n)=>{const a=Math.floor(n/t),i=e[a]||[];return e[a]=i.concat([r]),e},[]);class wa extends ya{static lc_name(){return"OpenAIChat"}get callKeys(){return[...super.callKeys,"options","promptIndex"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"prefixMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.openAIApiKey??(0,ca.Az)("OPENAI_API_KEY"),this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,ca.Az)("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,ca.Az)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??((0,ca.Az)("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||(0,ca.Az)("AZURE_OPENAI_API_DEPLOYMENT_NAME")),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,ca.Az)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,ca.Az)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,ca.Az)("OPENAI_ORGANIZATION"),this.modelName=e?.modelName??this.modelName,this.prefixMessages=e?.prefixMessages??this.prefixMessages,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.maxTokens=e?.maxTokens,this.stop=e?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.n>1)throw new Error("Cannot use n > 1 in OpenAIChat LLM. Use ChatOpenAI Chat Model instead.");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}invocationParams(e){return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,logit_bias:this.logitBias,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,stop:e?.stop??this.stop,user:this.user,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}formatMessages(e){const t={role:"user",content:e};return this.prefixMessages?[...this.prefixMessages,t]:[t]}async*_streamResponseChunks(e,t,r){const n={...this.invocationParams(t),messages:this.formatMessages(e),stream:!0},a=await this.completionWithRetry(n,t);for await(const e of a){const n=e?.choices[0];if(!n)continue;const{delta:a}=n,i=new la.mu({text:a.content??""});yield i;const s={prompt:t.promptIndex??0,completion:n.index??0};r?.handleLLMNewToken(i.text??"",s)}if(t.signal?.aborted)throw new Error("AbortError")}async _call(e,t,r){const n=this.invocationParams(t);if(n.stream){const n=await this._streamResponseChunks(e,t,r);let a;for await(const e of n)a=void 0===a?e:a.concat(e);return a?.text??""}{const r=await this.completionWithRetry({...n,stream:!1,messages:this.formatMessages(e)},{signal:t.signal,...t.options});return r?.choices[0]?.message?.content??""}}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(e){throw ma(e)}})}_getClientOptions(e){if(!this.client){const e=pa({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new sa(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}}class _a extends ga{static lc_name(){return"OpenAI"}get callKeys(){return[...super.callKeys,"options"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if((e?.modelName?.startsWith("gpt-3.5-turbo")||e?.modelName?.startsWith("gpt-4"))&&!e?.modelName?.includes("-instruct"))return new wa(e,t);if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"bestOf",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo-instruct"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:20}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.openAIApiKey??(0,ca.Az)("OPENAI_API_KEY"),this.azureOpenAIApiKey=e?.azureOpenAIApiKey??(0,ca.Az)("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??(0,ca.Az)("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e?.azureOpenAIApiCompletionsDeploymentName||e?.azureOpenAIApiDeploymentName)??((0,ca.Az)("AZURE_OPENAI_API_COMPLETIONS_DEPLOYMENT_NAME")||(0,ca.Az)("AZURE_OPENAI_API_DEPLOYMENT_NAME")),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??(0,ca.Az)("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??(0,ca.Az)("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??(0,ca.Az)("OPENAI_ORGANIZATION"),this.modelName=e?.modelName??this.modelName,this.modelKwargs=e?.modelKwargs??{},this.batchSize=e?.batchSize??this.batchSize,this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.maxTokens=e?.maxTokens??this.maxTokens,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.n=e?.n??this.n,this.bestOf=e?.bestOf??this.bestOf,this.logitBias=e?.logitBias,this.stop=e?.stop,this.user=e?.user,this.streaming=e?.streaming??!1,this.streaming&&this.bestOf&&this.bestOf>1)throw new Error("Cannot stream results when bestOf > 1");if(this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}invocationParams(e){return{model:this.modelName,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,n:this.n,best_of:this.bestOf,logit_bias:this.logitBias,stop:e?.stop??this.stop,user:this.user,stream:this.streaming,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){const n=ba(e,this.batchSize),a=[],i={},s=this.invocationParams(t);if(-1===s.max_tokens){if(1!==e.length)throw new Error("max_tokens set to -1 not supported for multiple inputs");s.max_tokens=await(0,fa.Z2)({prompt:e[0],modelName:this.modelName})}for(let e=0;e<n.length;e+=1){const o=s.stream?await(async()=>{const a=[];let i;const o=await this.completionWithRetry({...s,stream:!0,prompt:n[e]},t);for await(const e of o){i||(i={id:e.id,object:e.object,created:e.created,model:e.model});for(const t of e.choices){if(a[t.index]){const e=a[t.index];e.text+=t.text,e.finish_reason=t.finish_reason,e.logprobs=t.logprobs}else a[t.index]=t;r?.handleLLMNewToken(t.text,{prompt:Math.floor(t.index/this.n),completion:t.index%this.n})}}if(t.signal?.aborted)throw new Error("AbortError");return{...i,choices:a}})():await this.completionWithRetry({...s,stream:!1,prompt:n[e]},{signal:t.signal,...t.options});a.push(...o.choices);const{completion_tokens:l,prompt_tokens:c,total_tokens:u}=o.usage?o.usage:{completion_tokens:void 0,prompt_tokens:void 0,total_tokens:void 0};l&&(i.completionTokens=(i.completionTokens??0)+l),c&&(i.promptTokens=(i.promptTokens??0)+c),u&&(i.totalTokens=(i.totalTokens??0)+u)}return{generations:ba(a,this.n).map(e=>e.map(e=>({text:e.text??"",generationInfo:{finishReason:e.finish_reason,logprobs:e.logprobs}}))),llmOutput:{tokenUsage:i}}}async*_streamResponseChunks(e,t,r){const n={...this.invocationParams(t),prompt:e,stream:!0},a=await this.completionWithRetry(n,t);for await(const e of a){const t=e?.choices[0];if(!t)continue;const n=new la.mu({text:t.text,generationInfo:{finishReason:t.finish_reason}});yield n,r?.handleLLMNewToken(n.text??"")}if(t.signal?.aborted)throw new Error("AbortError")}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.completions.create(e,r)}catch(e){throw ma(e)}})}_getClientOptions(e){if(!this.client){const e=pa({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new sa(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}}r(9624);var va=r(6446),Oa=(r(5311),r(9750),r(9834)),Aa=r(6768);r(9980),r(8999).y,Aa.LLMChain,r(3091),r(3382),r(6409),Oa.r;var Ea=r(8952);r(4116);const xa={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var Ia,Pa=new Uint8Array(16);function Sa(){if(!Ia&&!(Ia="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ia(Pa)}for(var ka=[],Ta=0;Ta<256;++Ta)ka.push((Ta+256).toString(16).slice(1));const Ca=function(e,t,r){if(xa.randomUUID&&!t&&!e)return xa.randomUUID();var n=(e=e||{}).random||(e.rng||Sa)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){r=r||0;for(var a=0;a<16;++a)t[r+a]=n[a];return t}return function(e,t=0){return(ka[e[t+0]]+ka[e[t+1]]+ka[e[t+2]]+ka[e[t+3]]+"-"+ka[e[t+4]]+ka[e[t+5]]+"-"+ka[e[t+6]]+ka[e[t+7]]+"-"+ka[e[t+8]]+ka[e[t+9]]+"-"+ka[e[t+10]]+ka[e[t+11]]+ka[e[t+12]]+ka[e[t+13]]+ka[e[t+14]]+ka[e[t+15]]).toLowerCase()}(n)};var ja=r(3246);const Na=Symbol.for("ls:tracing_async_local_storage"),Ra=new class{getStore(){}run(e,t){return t()}},$a=new class{getInstance(){return globalThis[Na]??Ra}initializeGlobalInstance(e){void 0===globalThis[Na]&&(globalThis[Na]=e)}};Symbol.for("langsmith:traceable:root");const La=Object.prototype.hasOwnProperty;function Ma(e,t){return La.call(e,t)}function Da(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Ua(e){let t=0;const r=e.length;let n;for(;t<r;){if(n=e.charCodeAt(t),!(n>=48&&n<=57))return!1;t++}return!0}function za(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Fa(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(Fa(e[t]))return!0}else if("object"==typeof e){const r=function(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)Ma(e,r)&&t.push(r);return t}(e),n=r.length;for(var t=0;t<n;t++)if(Fa(e[r[t]]))return!0}return!1}function Ba(e,t){const r=[e];for(const e in t){const n="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==n&&r.push(`${e}: ${n}`)}return r.join("\n")}class Ha extends Error{constructor(e,t,r,n,a){super(Ba(e,{name:t,index:r,operation:n,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=Ba(e,{name:t,index:r,operation:n,tree:a})}}const Va=Ha,qa=Da,Za={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var n=e[t];return delete e[t],{newDocument:r,removed:n}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:function(e,t,r){let n=Ja(r,this.path);n&&(n=Da(n));const a=Wa(r,{op:"remove",path:this.from}).removed;return Wa(r,{op:"add",path:this.path,value:a}),{newDocument:r,removed:n}},copy:function(e,t,r){const n=Ja(r,this.from);return Wa(r,{op:"add",path:this.path,value:Da(n)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:ei(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var Ka={add:function(e,t,r){return Ua(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:Za.move,copy:Za.copy,test:Za.test,_get:Za._get};function Ja(e,t){if(""==t)return e;var r={op:"_get",path:t};return Wa(e,r),r.value}function Wa(e,t,r=!1,n=!0,a=!0,i=0){if(r&&("function"==typeof r?r(t,0,e,t.path):Xa(t,0)),""===t.path){let n={newDocument:e};if("add"===t.op)return n.newDocument=t.value,n;if("replace"===t.op)return n.newDocument=t.value,n.removed=e,n;if("move"===t.op||"copy"===t.op)return n.newDocument=Ja(e,t.from),"move"===t.op&&(n.removed=e),n;if("test"===t.op){if(n.test=ei(e,t.value),!1===n.test)throw new Va("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return n.newDocument=e,n}if("remove"===t.op)return n.removed=e,n.newDocument=null,n;if("_get"===t.op)return t.value=e,n;if(r)throw new Va("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return n}{n||(e=Da(e));const s=(t.path||"").split("/");let o,l,c,u=e,h=1,d=s.length;for(c="function"==typeof r?r:Xa;;){if(l=s[h],l&&-1!=l.indexOf("~")&&(l=za(l)),a&&("__proto__"==l||"prototype"==l&&h>0&&"constructor"==s[h-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===o&&(void 0===u[l]?o=s.slice(0,h).join("/"):h==d-1&&(o=t.path),void 0!==o&&c(t,0,e,o)),h++,Array.isArray(u)){if("-"===l)l=u.length;else{if(r&&!Ua(l))throw new Va("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);Ua(l)&&(l=~~l)}if(h>=d){if(r&&"add"===t.op&&l>u.length)throw new Va("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const n=Ka[t.op].call(t,u,l,e);if(!1===n.test)throw new Va("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return n}}else if(h>=d){const r=Za[t.op].call(t,u,l,e);if(!1===r.test)throw new Va("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}if(u=u[l],r&&h<d&&(!u||"object"!=typeof u))throw new Va("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function Ga(e,t,r,n=!0,a=!0){if(r&&!Array.isArray(t))throw new Va("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(e=Da(e));const i=new Array(t.length);for(let n=0,s=t.length;n<s;n++)i[n]=Wa(e,t[n],r,!0,a,n),e=i[n].newDocument;return i.newDocument=e,i}function Ya(e,t,r){const n=Wa(e,t);if(!1===n.test)throw new Va("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return n.newDocument}function Xa(e,t,r,n){if("object"!=typeof e||null===e||Array.isArray(e))throw new Va("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(!Za[e.op])throw new Va("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r);if("string"!=typeof e.path)throw new Va("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new Va('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new Va("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new Va("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&Fa(e.value))throw new Va("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r)if("add"==e.op){var a=e.path.split("/").length,i=n.split("/").length;if(a!==i+1&&a!==i)throw new Va("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==n)throw new Va("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var s=Qa([{op:"_get",path:e.from,value:void 0}],r);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new Va("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}function Qa(e,t,r){try{if(!Array.isArray(e))throw new Va("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)Ga(Da(t),Da(e),r||!0);else{r=r||Xa;for(var n=0;n<e.length;n++)r(e[n],n,t,void 0)}}catch(e){if(e instanceof Va)return e;throw e}}function ei(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,n,a,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((n=e.length)!=t.length)return!1;for(r=n;0!==r--;)if(!ei(e[r],t[r]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((n=o.length)!==Object.keys(t).length)return!1;for(r=n;0!==r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=n;0!==r--;)if(!ei(e[a=o[r]],t[a]))return!1;return!0}return e!=e&&t!=t}new WeakMap;var ti=r(9478);function ri(e,t){return t?.[e]||ti(e)}function ni(e,t,r){const n={};for(const a in e)Object.hasOwn(e,a)&&(n[t(a,r)]=e[a]);return n}function ai(e){return Array.isArray(e)?[...e]:{...e}}function ii(e,t){const r=ai(e);for(const[e,n]of Object.entries(t)){const[t,...a]=e.split(".").reverse();let i=r;for(const e of a.reverse()){if(void 0===i[e])break;i[e]=ai(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[n]})}return r}function si(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}r(2729);class oi{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,si(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof oi||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e),{});for(let n=Object.getPrototypeOf(this);n;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n,"lc_aliases",this)),Object.assign(t,Reflect.get(n,"lc_secrets",this)),Object.assign(r,Reflect.get(n,"lc_attributes",this));return Object.keys(t).forEach(e=>{let t=this,n=r;const[a,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in n&&void 0!==n[e]||("object"==typeof t[e]&&null!=t[e]?n[e]={}:Array.isArray(t[e])&&(n[e]=[])),t=t[e],n=n[e]}a in t&&void 0!==t[a]&&(n[a]=n[a]||t[a])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:ni(Object.keys(t).length?ii(r,t):r,ri,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}const li=()=>"undefined"!=typeof Deno;let ci;async function ui(){if(void 0===ci){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||li()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":li()?"deno":"other":"node",e})();ci={library:"langchain-js",runtime:e}}return ci}function hi(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}class di{}class pi extends di{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,si(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==hi("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return oi.prototype.toJSON.call(this)}toJSONNotImplemented(){return oi.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends pi{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ca()}),Object.assign(this,e)}}}}function mi(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function fi(e){return"function"==typeof e._addRunToRunMap}class gi extends pi{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const t=function(e,t,r){const n=r.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${n}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),r={...e};if(void 0!==r.parent_run_id){const e=this.runMap.get(r.parent_run_id);e&&(this._addChildRun(e,r),e.child_execution_order=Math.max(e.child_execution_order,r.child_execution_order),r.trace_id=e.trace_id,void 0!==e.dotted_order&&(r.dotted_order=[e.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;return this.runMap.set(r.id,r),r}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,n,a,i,s,o){const l=this._getExecutionOrder(n),c=Date.now(),u=s?{...a,metadata:s}:a,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:i||[]};return this._addRunToRunMap(h)}async handleLLMStart(e,t,r,n,a,i,s,o){const l=this.runMap.get(r)??this._createRunForLLMStart(e,t,r,n,a,i,s,o);return await(this.onRunCreate?.(l)),await(this.onLLMStart?.(l)),l}_createRunForChatModelStart(e,t,r,n,a,i,s,o){const l=this._getExecutionOrder(n),c=Date.now(),u=s?{...a,metadata:s}:a,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:i||[]};return this._addRunToRunMap(h)}async handleChatModelStart(e,t,r,n,a,i,s,o){const l=this.runMap.get(r)??this._createRunForChatModelStart(e,t,r,n,a,i,s,o);return await(this.onRunCreate?.(l)),await(this.onLLMStart?.(l)),l}async handleLLMEnd(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onLLMEnd?.(r)),await this._endTrace(r),r}async handleLLMError(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onLLMError?.(r)),await this._endTrace(r),r}_createRunForChainStart(e,t,r,n,a,i,s,o){const l=this._getExecutionOrder(n),c=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleChainStart(e,t,r,n,a,i,s,o){const l=this.runMap.get(r)??this._createRunForChainStart(e,t,r,n,a,i,s,o);return await(this.onRunCreate?.(l)),await(this.onChainStart?.(l)),l}async handleChainEnd(e,t,r,n,a){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=mi(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),void 0!==a?.inputs&&(i.inputs=mi(a.inputs,"input")),await(this.onChainEnd?.(i)),await this._endTrace(i),i}async handleChainError(e,t,r,n,a){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),void 0!==a?.inputs&&(i.inputs=mi(a.inputs,"input")),await(this.onChainError?.(i)),await this._endTrace(i),i}_createRunForToolStart(e,t,r,n,a,i,s){const o=this._getExecutionOrder(n),l=Date.now(),c={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(c)}async handleToolStart(e,t,r,n,a,i,s){const o=this.runMap.get(r)??this._createRunForToolStart(e,t,r,n,a,i,s);return await(this.onRunCreate?.(o)),await(this.onToolStart?.(o)),o}async handleToolEnd(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onToolEnd?.(r)),await this._endTrace(r),r}async handleToolError(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onToolError?.(r)),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.runMap.get(t);if(!r||"chain"!==r?.run_type)return;const n=r;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(r))}async handleAgentEnd(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(r)))}_createRunForRetrieverStart(e,t,r,n,a,i,s){const o=this._getExecutionOrder(n),l=Date.now(),c={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return this._addRunToRunMap(c)}async handleRetrieverStart(e,t,r,n,a,i,s){const o=this.runMap.get(r)??this._createRunForRetrieverStart(e,t,r,n,a,i,s);return await(this.onRunCreate?.(o)),await(this.onRetrieverStart?.(o)),o}async handleRetrieverEnd(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverEnd?.(r)),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverError?.(r)),await this._endTrace(r),r}async handleText(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(r)))}async handleLLMNewToken(e,t,r,n,a,i){const s=this.runMap.get(r);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e,{chunk:i?.chunk})),s}}var yi=r(1259),bi=r(4083);function wi(e,t){return`${e.open}${t}${e.close}`}function _i(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function vi(e){return"string"==typeof e?e.trim():null==e?e:_i(e,e.toString())}function Oi(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:Ai}=bi;class Ei extends gi{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const e=this.runMap.get(r.parent_run_id);if(!e)break;t.push(e),r=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map((e,t,r)=>{const n=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?wi(bi.bold,n):n}).join(" > ");return wi(Ai.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.green,"[chain/start]")} [${t}] Entering Chain run with input: ${_i(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.cyan,"[chain/end]")} [${t}] [${Oi(e)}] Exiting Chain run with output: ${_i(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.red,"[chain/error]")} [${t}] [${Oi(e)}] Chain run errored with error: ${_i(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(e=>e.trim())}:e.inputs;console.log(`${wi(Ai.green,"[llm/start]")} [${t}] Entering LLM run with input: ${_i(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.cyan,"[llm/end]")} [${t}] [${Oi(e)}] Exiting LLM run with output: ${_i(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.red,"[llm/error]")} [${t}] [${Oi(e)}] LLM run errored with error: ${_i(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.green,"[tool/start]")} [${t}] Entering Tool run with input: "${vi(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.cyan,"[tool/end]")} [${t}] [${Oi(e)}] Exiting Tool run with output: "${vi(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.red,"[tool/error]")} [${t}] [${Oi(e)}] Tool run errored with error: ${_i(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${_i(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.cyan,"[retriever/end]")} [${t}] [${Oi(e)}] Exiting Retriever run with output: ${_i(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${wi(Ai.red,"[retriever/error]")} [${t}] [${Oi(e)}] Retriever run errored with error: ${_i(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${wi(Ai.blue,"[agent/action]")} [${r}] Agent selected action: ${_i(t.actions[t.actions.length-1],"[action]")}`)}}Error,Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom");class xi extends gi{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:n}=e;this.projectName=r??hi("LANGCHAIN_PROJECT")??hi("LANGCHAIN_SESSION"),this.exampleId=t,this.client=n??new yi.Kj({});const a=xi.getTraceableRunTree();a&&this.updateFromRunTree(a)}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await ui()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}updateFromRunTree(e){let t=e;const r=new Set;for(;t.parent_run&&!r.has(t.id)&&(r.add(t.id),t.parent_run);)t=t.parent_run;r.clear();const n=[t];for(;n.length>0;){const e=n.shift();e&&!r.has(e.id)&&(r.add(e.id),this.runMap.set(e.id,e),e.child_runs&&n.push(...e.child_runs))}this.client=e.client??this.client,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}convertToRunTree(e){const t={},r=[];for(const[e,n]of this.runMap){const a=new ja.gk({...n,child_runs:[],parent_run:void 0,client:this.client,project_name:this.projectName,reference_example_id:this.exampleId,tracingEnabled:!0});t[e]=a,r.push([e,n.dotted_order])}r.sort((e,t)=>e[1]&&t[1]?e[1].localeCompare(t[1]):0);for(const[e]of r){const r=this.runMap.get(e),n=t[e];if(r&&n&&r.parent_run_id){const e=t[r.parent_run_id];e&&(e.child_runs.push(n),n.parent_run=e)}}return t[e]}static getTraceableRunTree(){try{return(()=>{const e=$a.getInstance().getStore();if(!(0,ja.m5)(e))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join("\n"));return e})()}catch{return}}}var Ii=r(3290);let Pi;async function Si(e,t){!0===t?await e():(void 0===Pi&&(Pi=new(0,Ii.default)({autoStart:!0,concurrency:1})),Pi.add(e))}const ki=e=>void 0!==e?e:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(e=>"true"===hi(e));ki()&&"true"!==hi("LANGCHAIN_CALLBACKS_BACKGROUND")&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join("\n");class Ti{setHandler(e){return this.setHandlers([e])}}class Ci{constructor(e,t,r,n,a,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>Si(async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,n,a){await Promise.all(this.handlers.map(r=>Si(async()=>{try{await(r.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}}class ji extends Ci{getChild(e){const t=new Li(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}}class Ni extends Ci{async handleLLMNewToken(e,t,r,n,a,i){await Promise.all(this.handlers.map(r=>Si(async()=>{if(!r.ignoreLLM)try{await(r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class Ri extends Ci{getChild(e){const t=new Li(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,n,a){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleChainEnd(e,t,r,n,a){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class $i extends Ci{getChild(e){const t=new Li(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Si(async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class Li extends Ti{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,n=void 0,a=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map(async(t,n)=>{const i=0===n&&r?r:Ca();return await Promise.all(this.handlers.map(r=>{if(!r.ignoreLLM)return fi(r)&&r._createRunForLLMStart(e,[t],i,this._parentRunId,a,this.tags,this.metadata,o),Si(async()=>{try{await(r.handleLLMStart?.(e,[t],i,this._parentRunId,a,this.tags,this.metadata,o))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new Ni(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,n=void 0,a=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map(async(t,n)=>{const i=0===n&&r?r:Ca();return await Promise.all(this.handlers.map(r=>{if(!r.ignoreLLM)return fi(r)&&r._createRunForChatModelStart(e,[t],i,this._parentRunId,a,this.tags,this.metadata,o),Si(async()=>{try{if(r.handleChatModelStart)await(r.handleChatModelStart?.(e,[t],i,this._parentRunId,a,this.tags,this.metadata,o));else if(r.handleLLMStart){const n=function(e,t="Human",r="AI"){const n=[];for(const a of e){let e;if("human"===a._getType())e=t;else if("ai"===a._getType())e=r;else if("system"===a._getType())e="System";else if("function"===a._getType())e="Function";else if("tool"===a._getType())e="Tool";else{if("generic"!==a._getType())throw new Error(`Got unsupported message type: ${a._getType()}`);e=a.role}const i=a.name?`${a.name}, `:"",s="string"==typeof a.content?a.content:JSON.stringify(a.content,null,2);n.push(`${e}: ${i}${s}`)}return n.join("\n")}(t);await(r.handleLLMStart?.(e,[n],i,this._parentRunId,a,this.tags,this.metadata,o))}}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new Ni(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=Ca(),n=void 0,a=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map(a=>{if(!a.ignoreChain)return fi(a)&&a._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,n,s),Si(async()=>{try{await(a.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,n,s))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainStart: ${e}`),a.raiseError)throw e}},a.awaitHandlers)})),new Ri(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=Ca(),n=void 0,a=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map(n=>{if(!n.ignoreAgent)return fi(n)&&n._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,s),Si(async()=>{try{await(n.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,s))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleToolStart: ${e}`),n.raiseError)throw e}},n.awaitHandlers)})),new $i(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=Ca(),n=void 0,a=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map(n=>{if(!n.ignoreRetriever)return fi(n)&&n._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,s),Si(async()=>{try{await(n.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,s))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleRetrieverStart: ${e}`),n.raiseError)throw e}},n.awaitHandlers)})),new ji(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,n,a){await Promise.all(this.handlers.map(n=>Si(async()=>{if(!n.ignoreCustomEvent)try{await(n.handleCustomEvent?.(e,t,r,this.tags,this.metadata))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${e}`),n.raiseError)throw e}},n.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new Li(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const n of e)r.handlers.filter(e=>"console_callback_handler"===e.name).some(e=>e.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){const t=new this;return t.addHandler(new class extends pi{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ca()}),Object.assign(this,e)}}),t}static async configure(e,t,r,n,a,i,s){return this._configureSync(e,t,r,n,a,i,s)}static _configureSync(e,t,r,n,a,i,s){let o;(e||t)&&(Array.isArray(e)||!e?(o=new Li,o.setHandlers(e?.map(Mi)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(Mi):t?.handlers,!1));const l="true"===hi("LANGCHAIN_VERBOSE")||s?.verbose,c=xi.getTraceableRunTree()?.tracingEnabled||ki(),u=c||(hi("LANGCHAIN_TRACING")??!1);if(l||u){if(o||(o=new Li),l&&!o.handlers.some(e=>e.name===Ei.prototype.name)){const e=new Ei;o.addHandler(e,!0)}if(u&&!o.handlers.some(e=>"langchain_tracer"===e.name)&&c){const e=new xi;o.addHandler(e,!0),o._parentRunId=xi.getTraceableRunTree()?.id??o._parentRunId}}return(r||n)&&o&&(o.addTags(r??[]),o.addTags(n??[],!1)),(a||i)&&o&&(o.addMetadata(a??{}),o.addMetadata(i??{},!1)),o}}function Mi(e){return"name"in e?e:pi.fromMethods(e)}const Di=new class{getStore(){}run(e,t){return t()}},Ui=Symbol.for("ls:tracing_async_local_storage"),zi=Symbol.for("lc:child_config");new class{getInstance(){return globalThis[Ui]??Di}getRunnableConfig(){const e=this.getInstance();return e.getStore()?.extra?.[zi]}runWithConfig(e,t,r){const n=Li._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),a=this.getInstance(),i=n?.getParentRunId(),s=n?.handlers?.find(e=>"langchain_tracer"===e?.name);let o;return s&&i?o=s.convertToRunTree(i):r||(o=new yi.gk({name:"<runnable_lambda>",tracingEnabled:!1})),o&&(o.extra={...o.extra,[zi]:e}),a.run(o,t)}initializeGlobalInstance(e){void 0===globalThis[Ui]&&(globalThis[Ui]=e)}},ReadableStream,Symbol.asyncIterator,Symbol.asyncDispose,Symbol.asyncIterator,Symbol.asyncDispose,Symbol.asyncIterator,Symbol.asyncIterator,new Set(["string","number","boolean"]),r(8139),Oa.r,r(3296),Oa.r,Oa.r,Oa.r,r(8687);var Fi=r(8557),Bi=r(6792);r(3263),Bi.vd,Bi.vd;var Hi=r(765);class Vi extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}class qi extends ha.ZE{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1})}async invoke(e,t){return this.call(e,(0,Hi.ZI)(t))}async call(e,t,r){let n;try{n=await this.schema.parseAsync(e)}catch(t){throw new Vi("Received tool input did not match expected schema",JSON.stringify(e))}const a=(0,da.H_)(t),i=await da.Td.configure(a.callbacks,this.callbacks,a.tags||r,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),s=await(i?.handleToolStart(this.toJSON(),"string"==typeof n?n:JSON.stringify(n),a.runId,void 0,void 0,void 0,a.runName));let o;delete a.runId;try{o=await this._call(n,s,a)}catch(e){throw await(s?.handleToolError(e)),e}return await(s?.handleToolEnd(o)),o}}class Zi extends qi{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Ea.Ik({input:Ea.Yj().optional()}).transform(e=>e.input)})}call(e,t){return super.call("string"!=typeof e&&e?e:{input:e},t)}}Object.defineProperty(class extends Zi{static lc_name(){return"DallEAPIWrapper"}constructor(e){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??(0,ca.Az)("OPENAI_API_KEY"),organization:e?.organization??(0,ca.Az)("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0};this.client=new sa(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.responseFormat=e?.responseFormat??this.responseFormat,this.user=e?.user}async _call(e){const t=await this.client.images.generate({model:this.model,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user});let r="";return"url"===this.responseFormat?[r]=t.data.map(e=>e.url).filter(e=>"undefined"!==e):[r]=t.data.map(e=>e.b64_json).filter(e=>"undefined"!==e),r}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Oa.r,Oa.r,Oa.r,Fi.mJ,Fi.mJ,Oa.r,r(9641),Fi.vd,Fi.T2,Fi.vd;var Ki=function(e){return 0===e&&Number.NEGATIVE_INFINITY===1/e};function Ji(e,t){var r="",n=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(r+='in "'+e.mark.name+'" '),r+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(r+="\n\n"+e.mark.snippet),n+" "+r):n}function Wi(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=Ji(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack||""}Wi.prototype=Object.create(Error.prototype),Wi.prototype.constructor=Wi,Wi.prototype.toString=function(e){return this.name+": "+Ji(this,e)};var Gi=Wi,Yi=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],Xi=["scalar","sequence","mapping"],Qi=function(e,t){if(t=t||{},Object.keys(t).forEach(function(t){if(-1===Yi.indexOf(t))throw new Gi('Unknown option "'+t+'" is met in definition of "'+e+'" YAML type.')}),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(e){return e},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=function(e){var t={};return null!==e&&Object.keys(e).forEach(function(r){e[r].forEach(function(e){t[String(e)]=r})}),t}(t.styleAliases||null),-1===Xi.indexOf(this.kind))throw new Gi('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')};function es(e,t){var r=[];return e[t].forEach(function(e){var t=r.length;r.forEach(function(r,n){r.tag===e.tag&&r.kind===e.kind&&r.multi===e.multi&&(t=n)}),r[t]=e}),r}function ts(e){return this.extend(e)}ts.prototype.extend=function(e){var t=[],r=[];if(e instanceof Qi)r.push(e);else if(Array.isArray(e))r=r.concat(e);else{if(!e||!Array.isArray(e.implicit)&&!Array.isArray(e.explicit))throw new Gi("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(r=r.concat(e.explicit))}t.forEach(function(e){if(!(e instanceof Qi))throw new Gi("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(e.loadKind&&"scalar"!==e.loadKind)throw new Gi("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(e.multi)throw new Gi("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),r.forEach(function(e){if(!(e instanceof Qi))throw new Gi("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var n=Object.create(ts.prototype);return n.implicit=(this.implicit||[]).concat(t),n.explicit=(this.explicit||[]).concat(r),n.compiledImplicit=es(n,"implicit"),n.compiledExplicit=es(n,"explicit"),n.compiledTypeMap=function(){var e,t,r={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function n(e){e.multi?(r.multi[e.kind].push(e),r.multi.fallback.push(e)):r[e.kind][e.tag]=r.fallback[e.tag]=e}for(e=0,t=arguments.length;e<t;e+=1)arguments[e].forEach(n);return r}(n.compiledImplicit,n.compiledExplicit),n};var rs=new ts({explicit:[new Qi("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return null!==e?e:""}}),new Qi("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return null!==e?e:[]}}),new Qi("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return null!==e?e:{}}})]}),ns=new Qi("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(e){if(null===e)return!0;var t=e.length;return 1===t&&"~"===e||4===t&&("null"===e||"Null"===e||"NULL"===e)},construct:function(){return null},predicate:function(e){return null===e},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"}),as=new Qi("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t=e.length;return 4===t&&("true"===e||"True"===e||"TRUE"===e)||5===t&&("false"===e||"False"===e||"FALSE"===e)},construct:function(e){return"true"===e||"True"===e||"TRUE"===e},predicate:function(e){return"[object Boolean]"===Object.prototype.toString.call(e)},represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function is(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function ss(e){return 48<=e&&e<=55}function os(e){return 48<=e&&e<=57}var ls=new Qi("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,r=e.length,n=0,a=!1;if(!r)return!1;if("-"!==(t=e[n])&&"+"!==t||(t=e[++n]),"0"===t){if(n+1===r)return!0;if("b"===(t=e[++n])){for(n++;n<r;n++)if("_"!==(t=e[n])){if("0"!==t&&"1"!==t)return!1;a=!0}return a&&"_"!==t}if("x"===t){for(n++;n<r;n++)if("_"!==(t=e[n])){if(!is(e.charCodeAt(n)))return!1;a=!0}return a&&"_"!==t}if("o"===t){for(n++;n<r;n++)if("_"!==(t=e[n])){if(!ss(e.charCodeAt(n)))return!1;a=!0}return a&&"_"!==t}}if("_"===t)return!1;for(;n<r;n++)if("_"!==(t=e[n])){if(!os(e.charCodeAt(n)))return!1;a=!0}return!(!a||"_"===t)},construct:function(e){var t,r=e,n=1;if(-1!==r.indexOf("_")&&(r=r.replace(/_/g,"")),"-"!==(t=r[0])&&"+"!==t||("-"===t&&(n=-1),t=(r=r.slice(1))[0]),"0"===r)return 0;if("0"===t){if("b"===r[1])return n*parseInt(r.slice(2),2);if("x"===r[1])return n*parseInt(r.slice(2),16);if("o"===r[1])return n*parseInt(r.slice(2),8)}return n*parseInt(r,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&e%1==0&&!Ki(e)},represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),cs=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$"),us=/^[-+]?[0-9]+e/,hs=new Qi("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(e){return null!==e&&!(!cs.test(e)||"_"===e[e.length-1])},construct:function(e){var t,r;return r="-"===(t=e.replace(/_/g,"").toLowerCase())[0]?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),".inf"===t?1===r?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:".nan"===t?NaN:r*parseFloat(t,10)},predicate:function(e){return"[object Number]"===Object.prototype.toString.call(e)&&(e%1!=0||Ki(e))},represent:function(e,t){var r;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(Ki(e))return"-0.0";return r=e.toString(10),us.test(r)?r.replace("e",".e"):r},defaultStyle:"lowercase"}),ds=rs.extend({implicit:[ns,as,ls,hs]}),ps=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),ms=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$"),fs=new Qi("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(e){return null!==e&&(null!==ps.exec(e)||null!==ms.exec(e))},construct:function(e){var t,r,n,a,i,s,o,l,c=0,u=null;if(null===(t=ps.exec(e))&&(t=ms.exec(e)),null===t)throw new Error("Date resolve error");if(r=+t[1],n=+t[2]-1,a=+t[3],!t[4])return new Date(Date.UTC(r,n,a));if(i=+t[4],s=+t[5],o=+t[6],t[7]){for(c=t[7].slice(0,3);c.length<3;)c+="0";c=+c}return t[9]&&(u=6e4*(60*+t[10]+ +(t[11]||0)),"-"===t[9]&&(u=-u)),l=new Date(Date.UTC(r,n,a,i,s,o,c)),u&&l.setTime(l.getTime()-u),l},instanceOf:Date,represent:function(e){return e.toISOString()}}),gs=new Qi("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(e){return"<<"===e||null===e}}),ys="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\n\r",bs=new Qi("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(e){if(null===e)return!1;var t,r,n=0,a=e.length,i=ys;for(r=0;r<a;r++)if(!((t=i.indexOf(e.charAt(r)))>64)){if(t<0)return!1;n+=6}return n%8==0},construct:function(e){var t,r,n=e.replace(/[\r\n=]/g,""),a=n.length,i=ys,s=0,o=[];for(t=0;t<a;t++)t%4==0&&t&&(o.push(s>>16&255),o.push(s>>8&255),o.push(255&s)),s=s<<6|i.indexOf(n.charAt(t));return 0==(r=a%4*6)?(o.push(s>>16&255),o.push(s>>8&255),o.push(255&s)):18===r?(o.push(s>>10&255),o.push(s>>2&255)):12===r&&o.push(s>>4&255),new Uint8Array(o)},predicate:function(e){return"[object Uint8Array]"===Object.prototype.toString.call(e)},represent:function(e){var t,r,n="",a=0,i=e.length,s=ys;for(t=0;t<i;t++)t%3==0&&t&&(n+=s[a>>18&63],n+=s[a>>12&63],n+=s[a>>6&63],n+=s[63&a]),a=(a<<8)+e[t];return 0==(r=i%3)?(n+=s[a>>18&63],n+=s[a>>12&63],n+=s[a>>6&63],n+=s[63&a]):2===r?(n+=s[a>>10&63],n+=s[a>>4&63],n+=s[a<<2&63],n+=s[64]):1===r&&(n+=s[a>>2&63],n+=s[a<<4&63],n+=s[64],n+=s[64]),n}}),ws=Object.prototype.hasOwnProperty,_s=Object.prototype.toString,vs=new Qi("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,r,n,a,i,s=[],o=e;for(t=0,r=o.length;t<r;t+=1){if(n=o[t],i=!1,"[object Object]"!==_s.call(n))return!1;for(a in n)if(ws.call(n,a)){if(i)return!1;i=!0}if(!i)return!1;if(-1!==s.indexOf(a))return!1;s.push(a)}return!0},construct:function(e){return null!==e?e:[]}}),Os=Object.prototype.toString,As=new Qi("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(e){if(null===e)return!0;var t,r,n,a,i,s=e;for(i=new Array(s.length),t=0,r=s.length;t<r;t+=1){if(n=s[t],"[object Object]"!==Os.call(n))return!1;if(1!==(a=Object.keys(n)).length)return!1;i[t]=[a[0],n[a[0]]]}return!0},construct:function(e){if(null===e)return[];var t,r,n,a,i,s=e;for(i=new Array(s.length),t=0,r=s.length;t<r;t+=1)n=s[t],a=Object.keys(n),i[t]=[a[0],n[a[0]]];return i}}),Es=Object.prototype.hasOwnProperty,xs=new Qi("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(e){if(null===e)return!0;var t,r=e;for(t in r)if(Es.call(r,t)&&null!==r[t])return!1;return!0},construct:function(e){return null!==e?e:{}}});function Is(e){return 48===e?"\0":97===e?"":98===e?"\b":116===e||9===e?"\t":110===e?"\n":118===e?"\v":102===e?"\f":114===e?"\r":101===e?"":32===e?" ":34===e?'"':47===e?"/":92===e?"\\":78===e?"Â…":95===e?"Â ":76===e?"\u2028":80===e?"\u2029":""}ds.extend({implicit:[fs,gs],explicit:[bs,vs,As,xs]}),Object.prototype.hasOwnProperty;for(var Ps=new Array(256),Ss=new Array(256),ks=0;ks<256;ks++)Ps[ks]=Is(ks)?1:0,Ss[ks]=Is(ks);function Ts(e,t){return function(){throw new Error("Function yaml."+e+" is removed in js-yaml 4. Use yaml."+t+" instead, which is now safe by default.")}}Object.prototype.toString,Object.prototype.hasOwnProperty,Ts("safeLoad","load"),Ts("safeLoadAll","loadAll"),Ts("safeDump","dump"),Oa.r,document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("langchain-demo-app");if(!e)return;e.innerHTML='\n        <div id="demoAPP" >\n            <h2>LangChain.js Content Generator Demo</h2>\n\n            <div class="demo-form-group">\n                <label for="api-key">OpenAI API Key:</label>\n                <input type="password" id="api-key" class="demo-input" placeholder="sk-...">\n            </div>\n\n            <div class="demo-form-group">\n                <label for="topic">Topic:</label>\n                <input type="text" id="topic" class="demo-input" value="WordPress development">\n            </div>\n\n            <div class="demo-form-group">\n                <label for="length">Length:</label>\n                <br>\n                <select id="length" class="demo-select">\n                    <option value="short paragraph">Short paragraph</option>\n                    <option value="medium article">Medium article</option>\n                    <option value="detailed explanation">Detailed explanation</option>\n                </select>\n            </div>\n\n            <div class="demo-form-group">\n                <label for="style">Style:</label>\n                <br>\n                <select id="style" class="demo-select">\n                    <option value="professional">Professional</option>\n                    <option value="conversational">Conversational</option>\n                    <option value="technical">Technical</option>\n                </select>\n            </div>\n\n            <button id="generate-btn" class="demo-button">\n                Generate Content\n            </button>\n\n            <div id="result" class="demo-result"></div>\n        </div>\n    ';const t=document.getElementById("api-key"),r=document.getElementById("topic"),n=document.getElementById("length"),a=document.getElementById("style"),i=document.getElementById("generate-btn"),s=document.getElementById("result");let o,l,c;i.addEventListener("click",async()=>{const e=t.value.trim(),u=r.value.trim();if(e)if(u){i.disabled=!0,i.textContent="Generating...",s.textContent="Generating content...";try{s.textContent="Generating response...",o=function(e){return new _a({openAIApiKey:e,modelName:"gpt-3.5-turbo",temperature:.7})}(e),l=va.Hh.fromTemplate("\nGenerate a {length} response about {topic} in the style of {style}.\n\nTopic: {topic}\nLength: {length}\nStyle: {style}\n\nResponse:"),c=function(e,t){return new Aa.LLMChain({llm:e,prompt:t})}(o,l);const t={topic:u,length:n.value,style:a.value},r=await async function(e,t){try{return(await e.call(t)).text}catch(e){throw console.error("Error generating content:",e),e}}(c,t);s.textContent=r}catch(e){s.textContent=`Error: ${e.message}`}finally{i.disabled=!1,i.textContent="Generate Content"}}else s.textContent="Please provide a topic.";else s.textContent="Please provide an OpenAI API key."})})},204:e=>{"use strict";const t=/^[0-9]+$/,r=(e,r)=>{if("number"==typeof e&&"number"==typeof r)return e===r?0:e<r?-1:1;const n=t.test(e),a=t.test(r);return n&&a&&(e=+e,r=+r),e===r?0:n&&!a?-1:a&&!n?1:e<r?-1:1};e.exports={compareIdentifiers:r,rcompareIdentifiers:(e,t)=>r(t,e)}},228:e=>{"use strict";var t=Object.prototype.hasOwnProperty,r="~";function n(){}function a(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,n,i,s){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new a(n,i||e,s),l=r?r+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function s(e,t){0===--e._eventsCount?e._events=new n:delete e._events[t]}function o(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,n,a=[];if(0===this._eventsCount)return a;for(n in e=this._events)t.call(e,n)&&a.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},o.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var a=0,i=n.length,s=new Array(i);a<i;a++)s[a]=n[a].fn;return s},o.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},o.prototype.emit=function(e,t,n,a,i,s){var o=r?r+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,a),!0;case 5:return u.fn.call(u.context,t,n,a,i),!0;case 6:return u.fn.call(u.context,t,n,a,i,s),!0}for(c=1,l=new Array(h-1);c<h;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var d,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),h){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,n);break;case 4:u[c].fn.call(u[c].context,t,n,a);break;default:if(!l)for(d=1,l=new Array(h-1);d<h;d++)l[d-1]=arguments[d];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,n,a){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return s(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||a&&!o.once||n&&o.context!==n||s(this,i);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||a&&!o[l].once||n&&o[l].context!==n)&&c.push(o[l]);c.length?this._events[i]=1===c.length?c[0]:c:s(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&s(this,t)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o},305:(e,t,r)=>{"use strict";r.d(t,{T:()=>c,k:()=>l});var n=r(6792),a=r(3490),i=r(6362),s=r(8028);function o(e,t){const r=typeof e;if(r!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const r=e.length;if(r!==t.length)return!1;for(let n=0;n<r;n++)if(!o(e[n],t[n]))return!1;return!0}if("object"===r){if(!e||!t)return e===t;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const n of r)if(!o(e[n],t[n]))return!1;return!0}return e===t}"undefined"!=typeof self&&self.location&&"null"!==self.location.origin&&(self.location.origin,self.location.pathname,location.search);class l extends n.mJ{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class c extends l{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,r;for await(const n of e){if("string"!=typeof n&&"string"!=typeof n.content)throw new Error("Cannot handle non-string output.");let e;if((0,a.AJ)(n)){if("string"!=typeof n.content)throw new Error("Cannot handle non-string message output.");e=new s.Cf({message:n,text:n.content})}else if((0,a.ny)(n)){if("string"!=typeof n.content)throw new Error("Cannot handle non-string message output.");e=new s.Cf({message:(0,i.ih)(n),text:n.content})}else e=new s.mu({text:n});r=void 0===r?e:r.concat(e);const l=await this.parsePartialResult([r]);null==l||o(l,t)||(this.diff?yield this._diff(t,l):yield l,t=l)}}}},329:(e,t,r)=>{"use strict";r.d(t,{L:()=>i});var n=r(5311),a=r(6993);class i extends a.m{async formatPromptValue(e){const t=await this.format(e);return new n.HY(t)}}},487:(e,t,r)=>{"use strict";const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:a,MAX_LENGTH:i}=r(6261),s=r(6735),o=(t=e.exports={}).re=[],l=t.safeRe=[],c=t.src=[],u=t.safeSrc=[],h=t.t={};let d=0;const p="[a-zA-Z0-9-]",m=[["\\s",1],["\\d",i],[p,a]],f=(e,t,r)=>{const n=(e=>{for(const[t,r]of m)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),a=d++;s(e,a,t),h[e]=a,c[a]=t,u[a]=n,o[a]=new RegExp(t,r?"g":void 0),l[a]=new RegExp(n,r?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${p}*`),f("MAINVERSION",`(${c[h.NUMERICIDENTIFIER]})\\.(${c[h.NUMERICIDENTIFIER]})\\.(${c[h.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${c[h.NUMERICIDENTIFIERLOOSE]})\\.(${c[h.NUMERICIDENTIFIERLOOSE]})\\.(${c[h.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${c[h.NONNUMERICIDENTIFIER]}|${c[h.NUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${c[h.NONNUMERICIDENTIFIER]}|${c[h.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASE",`(?:-(${c[h.PRERELEASEIDENTIFIER]}(?:\\.${c[h.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${c[h.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[h.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER",`${p}+`),f("BUILD",`(?:\\+(${c[h.BUILDIDENTIFIER]}(?:\\.${c[h.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${c[h.MAINVERSION]}${c[h.PRERELEASE]}?${c[h.BUILD]}?`),f("FULL",`^${c[h.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${c[h.MAINVERSIONLOOSE]}${c[h.PRERELEASELOOSE]}?${c[h.BUILD]}?`),f("LOOSE",`^${c[h.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${c[h.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${c[h.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${c[h.XRANGEIDENTIFIER]})(?:\\.(${c[h.XRANGEIDENTIFIER]})(?:\\.(${c[h.XRANGEIDENTIFIER]})(?:${c[h.PRERELEASE]})?${c[h.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${c[h.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[h.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[h.XRANGEIDENTIFIERLOOSE]})(?:${c[h.PRERELEASELOOSE]})?${c[h.BUILD]}?)?)?`),f("XRANGE",`^${c[h.GTLT]}\\s*${c[h.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${c[h.GTLT]}\\s*${c[h.XRANGEPLAINLOOSE]}$`),f("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),f("COERCE",`${c[h.COERCEPLAIN]}(?:$|[^\\d])`),f("COERCEFULL",c[h.COERCEPLAIN]+`(?:${c[h.PRERELEASE]})?`+`(?:${c[h.BUILD]})?(?:$|[^\\d])`),f("COERCERTL",c[h.COERCE],!0),f("COERCERTLFULL",c[h.COERCEFULL],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${c[h.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",f("TILDE",`^${c[h.LONETILDE]}${c[h.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${c[h.LONETILDE]}${c[h.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${c[h.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",f("CARET",`^${c[h.LONECARET]}${c[h.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${c[h.LONECARET]}${c[h.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${c[h.GTLT]}\\s*(${c[h.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${c[h.GTLT]}\\s*(${c[h.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${c[h.GTLT]}\\s*(${c[h.LOOSEPLAIN]}|${c[h.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${c[h.XRANGEPLAIN]})\\s+-\\s+(${c[h.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${c[h.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[h.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},534:(e,t,r)=>{"use strict";const n=r(9558);e.exports=(e,t)=>new n(e,t).set.map(e=>e.map(e=>e.value).join(" ").trim().split(" "))},547:(e,t,r)=>{"use strict";const n=r(4899);e.exports=(e,t)=>new n(e,t).minor},639:e=>{"use strict";e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},747:(e,t,r)=>{"use strict";r.d(t,{Y:()=>i});const n=(...e)=>fetch(...e),a=Symbol.for("ls:fetch_implementation"),i=()=>globalThis[a]??n},753:(e,t,r)=>{"use strict";const n=r(9558);e.exports=(e,t,r)=>(e=new n(e,r),t=new n(t,r),e.intersects(t,r))},765:(e,t,r)=>{"use strict";r.d(t,{SV:()=>o,ZI:()=>c,kJ:()=>s,p_:()=>i,tn:()=>u});var n=r(4691),a=r(8521);const i=25;async function s(e){return n.Td.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function o(...e){const t={};for(const r of e.filter(e=>!!e))for(const e of Object.keys(r))if("metadata"===e)t[e]={...t[e],...r[e]};else if("tags"===e){const n=t[e]??[];t[e]=[...new Set(n.concat(r[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...r[e]};else if("callbacks"===e){const e=t.callbacks,a=r.callbacks;if(Array.isArray(a))if(e)if(Array.isArray(e))t.callbacks=e.concat(a);else{const r=e.copy();for(const e of a)r.addHandler((0,n.tW)(e),!0);t.callbacks=r}else t.callbacks=a;else if(a)if(e)if(Array.isArray(e)){const r=a.copy();for(const t of e)r.addHandler((0,n.tW)(t),!0);t.callbacks=r}else t.callbacks=new n.Td(a._parentRunId,{handlers:e.handlers.concat(a.handlers),inheritableHandlers:e.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(a.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(a.inheritableTags))),metadata:{...e.metadata,...a.metadata}});else t.callbacks=a}else{const n=e;t[n]=r[n]??t[n]}return t}const l=new Set(["string","number","boolean"]);function c(e){const t=e??a.N.getInstance().getStore();let r={tags:[],metadata:{},callbacks:void 0,recursionLimit:25,runId:void 0};if(t&&(r={...r,...t}),t?.configurable)for(const e of Object.keys(t.configurable))l.has(typeof t.configurable[e])&&!r.metadata?.[e]&&(r.metadata||(r.metadata={}),r.metadata[e]=t.configurable[e]);return r}function u(e={},{callbacks:t,maxConcurrency:r,recursionLimit:n,runName:a,configurable:i,runId:s}={}){const o=c(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==n&&(o.recursionLimit=n),void 0!==r&&(o.maxConcurrency=r),void 0!==a&&(o.runName=a),void 0!==i&&(o.configurable={...o.configurable,...i}),void 0!==s&&delete o.runId,o}},780:(e,t,r)=>{"use strict";function n(e,t=a){e=e.trim();const r=/```(json)?(.*)```/s.exec(e);return t(r?r[2]:e)}function a(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const r=[];let n=!1,a=!1;for(let i of e){if(n)'"'!==i||a?"\n"!==i||a?a="\\"===i&&!a:i="\\n":n=!1;else if('"'===i)n=!0,a=!1;else if("{"===i)r.push("}");else if("["===i)r.push("]");else if("}"===i||"]"===i){if(!r||r[r.length-1]!==i)return null;r.pop()}t+=i}n&&(t+='"');for(let e=r.length-1;e>=0;e-=1)t+=r[e];try{return JSON.parse(t)}catch(e){return null}}r.d(t,{D:()=>n,d:()=>a})},818:(e,t,r)=>{"use strict";const n=r(4621);e.exports=(e,t,r)=>0===n(e,t,r)},995:(e,t,r)=>{"use strict";const n=r(9558);e.exports=(e,t,r)=>{try{t=new n(t,r)}catch(e){return!1}return t.test(e)}},1259:(e,t,r)=>{"use strict";r.d(t,{Kj:()=>n.Kj,gk:()=>n.gk});var n=r(6928)},1534:(e,t,r)=>{"use strict";const n=r(818),a=r(9606),i=r(2559),s=r(7372),o=r(4056),l=r(6133);e.exports=(e,t,r,c)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return n(e,r,c);case"!=":return a(e,r,c);case">":return i(e,r,c);case">=":return s(e,r,c);case"<":return o(e,r,c);case"<=":return l(e,r,c);default:throw new TypeError(`Invalid operator: ${t}`)}}},1590:(e,t,r)=>{"use strict";r.d(t,{J:()=>i});var n=r(5960);function a(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class i extends n.N{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=function(e,t,r){const n=r.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${n}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),r={...e};if(void 0!==r.parent_run_id){const e=this.runMap.get(r.parent_run_id);e&&(this._addChildRun(e,r),e.child_execution_order=Math.max(e.child_execution_order,r.child_execution_order),r.trace_id=e.trace_id,void 0!==e.dotted_order&&(r.dotted_order=[e.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await(this.onRunCreate?.(r))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,n,a,i,s,o){const l=this._getExecutionOrder(n),c=Date.now(),u=s?{...a,metadata:s}:a,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:i||[]};return await this._startTrace(h),await(this.onLLMStart?.(h)),h}async handleChatModelStart(e,t,r,n,a,i,s,o){const l=this._getExecutionOrder(n),c=Date.now(),u=s?{...a,metadata:s}:a,h={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:i||[]};return await this._startTrace(h),await(this.onLLMStart?.(h)),h}async handleLLMEnd(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onLLMEnd?.(r)),await this._endTrace(r),r}async handleLLMError(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onLLMError?.(r)),await this._endTrace(r),r}async handleChainStart(e,t,r,n,a,i,s,o){const l=this._getExecutionOrder(n),c=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(u),await(this.onChainStart?.(u)),u}async handleChainEnd(e,t,r,n,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=a(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=a(i.inputs,"input")),await(this.onChainEnd?.(s)),await this._endTrace(s),s}async handleChainError(e,t,r,n,i){const s=this.runMap.get(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),void 0!==i?.inputs&&(s.inputs=a(i.inputs,"input")),await(this.onChainError?.(s)),await this._endTrace(s),s}async handleToolStart(e,t,r,n,a,i,s){const o=this._getExecutionOrder(n),l=Date.now(),c={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(c),await(this.onToolStart?.(c)),c}async handleToolEnd(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onToolEnd?.(r)),await this._endTrace(r),r}async handleToolError(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onToolError?.(r)),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.runMap.get(t);if(!r||"chain"!==r?.run_type)return;const n=r;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(r))}async handleAgentEnd(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(r)))}async handleRetrieverStart(e,t,r,n,a,i,s){const o=this._getExecutionOrder(n),l=Date.now(),c={id:r,name:s??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(c),await(this.onRetrieverStart?.(c)),c}async handleRetrieverEnd(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverEnd?.(r)),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverError?.(r)),await this._endTrace(r),r}async handleText(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(r)))}async handleLLMNewToken(e,t,r,n,a,i){const s=this.runMap.get(r);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e,{chunk:i?.chunk})),s}}},1620:(e,t,r)=>{"use strict";const n=r(995),a=r(4621);e.exports=(e,t,r)=>{const i=[];let s=null,o=null;const l=e.sort((e,t)=>a(e,t,r));for(const e of l)n(e,t,r)?(o=e,s||(s=e)):(o&&i.push([s,o]),o=null,s=null);s&&i.push([s,null]);const c=[];for(const[e,t]of i)e===t?c.push(e):t||e!==l[0]?t?e===l[0]?c.push(`<=${t}`):c.push(`${e} - ${t}`):c.push(`>=${e}`):c.push("*");const u=c.join(" || "),h="string"==typeof t.raw?t.raw:String(t);return u.length<h.length?u:t}},2153:(e,t,r)=>{"use strict";const n=r(9558);e.exports=(e,t)=>{try{return new n(e,t).range||"*"}catch(e){return null}}},2469:(e,t,r)=>{"use strict";const n=r(4621);e.exports=(e,t,r)=>n(t,e,r)},2559:(e,t,r)=>{"use strict";const n=r(4621);e.exports=(e,t,r)=>n(e,t,r)>0},2729:e=>{"use strict";const t=/[\p{Lu}]/u,r=/[\p{Ll}]/u,n=/^[\p{Lu}](?![\p{Lu}])/gu,a=/([\p{Alpha}\p{N}_]|$)/u,i=/[_.\- ]+/,s=new RegExp("^"+i.source),o=new RegExp(i.source+a.source,"gu"),l=new RegExp("\\d+"+a.source,"gu"),c=(e,a)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(a={pascalCase:!1,preserveConsecutiveUppercase:!1,...a},0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length)return"";const i=!1===a.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(a.locale),c=!1===a.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(a.locale);return 1===e.length?a.pascalCase?c(e):i(e):(e!==i(e)&&(e=((e,n,a)=>{let i=!1,s=!1,o=!1;for(let l=0;l<e.length;l++){const c=e[l];i&&t.test(c)?(e=e.slice(0,l)+"-"+e.slice(l),i=!1,o=s,s=!0,l++):s&&o&&r.test(c)?(e=e.slice(0,l-1)+"-"+e.slice(l-1),o=s,s=!1,i=!0):(i=n(c)===c&&a(c)!==c,o=s,s=a(c)===c&&n(c)!==c)}return e})(e,i,c)),e=e.replace(s,""),e=a.preserveConsecutiveUppercase?((e,t)=>(n.lastIndex=0,e.replace(n,e=>t(e))))(e,i):i(e),a.pascalCase&&(e=c(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,l.lastIndex=0,e.replace(o,(e,r)=>t(r)).replace(l,e=>t(e))))(e,c))};e.exports=c,e.exports.default=c},2771:(e,t,r)=>{"use strict";r.d(t,{FewShotPromptTemplate:()=>o});var n=r(329),a=r(9849),i=r(3650),s=r(3766);class o extends n.L{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:"\n\n"}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,a.Ns)(this.prefix+this.suffix,this.templateFormat,e)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){const t=this.inputVariables.filter(t=>!(t in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new o(n)}async format(e){const t=await this.mergePartialAndUserVariables(e),r=await this.getExamples(t),n=await Promise.all(r.map(e=>this.examplePrompt.format(e))),i=[this.prefix,...n,this.suffix].join(this.exampleSeparator);return(0,a.Xm)(i,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(void 0!==this.outputParser)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){const{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");const r=await i.PromptTemplate.deserialize(t);let n;if(!Array.isArray(e.examples))throw new Error("Invalid examples format. Only list or string are supported.");return n=e.examples,new o({inputVariables:e.input_variables,examplePrompt:r,examples:n,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}s.qF},2778:(e,t,r)=>{"use strict";r.d(t,{Z2:()=>n.Z2,ZE:()=>n.ZE,j_:()=>n.j_});var n=r(4914)},3042:(e,t,r)=>{"use strict";const n=r(4621);e.exports=(e,t)=>n(e,t,!0)},3091:(e,t,r)=>{"use strict";r.d(t,{SequentialChain:()=>o,SimpleSequentialChain:()=>l});var n=r(9834);function a(e,t){const r=new Set;for(const n of t)e.has(n)&&r.add(n);return r}function i(e,t){const r=new Set(e);for(const e of t)r.delete(e);return r}function s(e){return Array.from(e).map(e=>`"${e}"`).join(", ")}class o extends n.r{static lc_name(){return"SequentialChain"}get inputKeys(){return this.inputVariables}get outputKeys(){return this.outputVariables}constructor(e){if(super(e),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnAll",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.inputVariables=e.inputVariables,this.outputVariables=e.outputVariables??[],this.outputVariables.length>0&&e.returnAll)throw new Error("Either specify variables to return using `outputVariables` or use `returnAll` param. Cannot apply both conditions at the same time.");this.returnAll=e.returnAll??!1,this._validateChains()}_validateChains(){if(0===this.chains.length)throw new Error("Sequential chain must have at least one chain.");const e=this.memory?.memoryKeys??[],t=new Set(this.inputKeys),r=new Set(e),n=a(t,r);if(n.size>0)throw new Error(`The following keys: ${s(n)} are overlapping between memory and input keys of the chain variables. This can lead to unexpected behaviour. Please use input and memory keys that don't overlap.`);const o=function(e,t){const r=new Set(e);for(const e of t)r.add(e);return r}(t,r);for(const e of this.chains){let t=i(new Set(e.inputKeys),o);if(e.memory&&(t=i(t,new Set(e.memory.memoryKeys))),t.size>0)throw new Error(`Missing variables for chain "${e._chainType()}": ${s(t)}. Only got the following variables: ${s(o)}.`);const r=new Set(e.outputKeys),n=a(o,r);if(n.size>0)throw new Error(`The following output variables for chain "${e._chainType()}" are overlapping: ${s(n)}. This can lead to unexpected behaviour.`);for(const e of r)o.add(e)}if(0===this.outputVariables.length)if(this.returnAll){const e=i(o,t);this.outputVariables=Array.from(e)}else this.outputVariables=this.chains[this.chains.length-1].outputKeys;else{const e=i(new Set(this.outputVariables),new Set(o));if(e.size>0)throw new Error(`The following output variables were expected to be in the final chain output but were not found: ${s(e)}.`)}}async _call(e,t){let r={};const n=e;let a=0;for(const e of this.chains){a+=1,r=await e.call(n,t?.getChild(`step_${a}`));for(const e of Object.keys(r))n[e]=r[e]}const i={};for(const e of this.outputVariables)i[e]=n[e];return i}_chainType(){return"sequential_chain"}static async deserialize(e){const t=[],r=e.input_variables,a=e.output_variables,i=e.chains;for(const e of i){const r=await n.r.deserialize(e);t.push(r)}return new o({chains:t,inputVariables:r,outputVariables:a})}serialize(){const e=[];for(const t of this.chains)e.push(t.serialize());return{_type:this._chainType(),input_variables:this.inputVariables,output_variables:this.outputVariables,chains:e}}}class l extends n.r{static lc_name(){return"SimpleSequentialChain"}get inputKeys(){return[this.inputKey]}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"chains",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output"}),Object.defineProperty(this,"trimOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.chains=e.chains,this.trimOutputs=e.trimOutputs??!1,this._validateChains()}_validateChains(){for(const e of this.chains){if(1!==e.inputKeys.filter(t=>!e.memory?.memoryKeys.includes(t)??!0).length)throw new Error(`Chains used in SimpleSequentialChain should all have one input, got ${e.inputKeys.length} for ${e._chainType()}.`);if(1!==e.outputKeys.length)throw new Error(`Chains used in SimpleSequentialChain should all have one output, got ${e.outputKeys.length} for ${e._chainType()}.`)}}async _call(e,t){let r=e[this.inputKey],n=0;for(const a of this.chains)n+=1,r=(await a.call({[a.inputKeys[0]]:r,signal:e.signal},t?.getChild(`step_${n}`)))[a.outputKeys[0]],this.trimOutputs&&(r=r.trim()),await(t?.handleText(r));return{[this.outputKey]:r}}_chainType(){return"simple_sequential_chain"}static async deserialize(e){const t=[],r=e.chains;for(const e of r){const r=await n.r.deserialize(e);t.push(r)}return new l({chains:t})}serialize(){const e=[];for(const t of this.chains)e.push(t.serialize());return{_type:this._chainType(),chains:e}}}},3246:(e,t,r)=>{"use strict";r.d(t,{gk:()=>c,m5:()=>u});var n=r(5230),a=r(4785),i=r(9056),s=r(6232);const o=Symbol.for("lc:context_variables");class l{constructor(e,t){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t}static fromHeader(e){const t=e.split(",");let r={},n=[];for(const e of t){const[t,a]=e.split("="),i=decodeURIComponent(a);"langsmith-metadata"===t?r=JSON.parse(i):"langsmith-tags"===t&&(n=i.split(","))}return new l(r,n)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),e.join(",")}}class c{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),u(e))return void Object.assign(this,{...e});const t=c.getDefaultConfig(),{metadata:r,...n}=e,a=n.client??c.getSharedClient(),i={...r,...n?.extra?.metadata};if(n.extra={...n.extra,metadata:i},Object.assign(this,{...t,...n,client:a}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){const e=function(e,t,r=1){const n=r.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${n}Z`.replace(/[-:.]/g,"")+t}(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e}}static getDefaultConfig(){return{id:n.A(),run_type:"chain",project_name:(0,a.Az)("LANGCHAIN_PROJECT")??(0,a.Az)("LANGCHAIN_SESSION")??"default",child_runs:[],api_url:(0,a.Az)("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:(0,a.Az)("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return c.sharedClient||(c.sharedClient=new i.Kj),c.sharedClient}createChild(e){const t=this.child_execution_order+1,r=new c({...e,parent_run:this,project_name:this.project_name,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});o in this&&(r[o]=this[o]);const n=Symbol.for("lc:child_config"),a=e.extra?.[n]??this.extra[n];if(void 0!==(i=a)&&"object"==typeof i.callbacks&&(d(i.callbacks?.handlers)||d(i.callbacks))){const e={...a},t=function(e){return"object"==typeof e&&null!=e&&Array.isArray(e.handlers)}(e.callbacks)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:r.id}),t.handlers?.find(h)?.updateFromRunTree?.(r),e.callbacks=t),r.extra[n]=e}var i;const s=new Set;let l=this;for(;null!=l&&!s.has(l.id);)s.add(l.id),l.child_execution_order=Math.max(l.child_execution_order,t),l=l.parent_run;return this.child_runs.push(r),r}async end(e,t,r=Date.now(),n){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,n&&Object.keys(n).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...n}}:{metadata:n})}_convertToCreate(e,t,r=!0){const n=e.extra??{};if(n.runtime||(n.runtime={}),t)for(const[e,r]of Object.entries(t))n.runtime[e]||(n.runtime[e]=r);let a,i;return r?(i=e.parent_run?.id,a=[]):(a=e.child_runs.map(e=>this._convertToCreate(e,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:n,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags}}async postRun(e=!0){try{const t=(0,a.Ec)(),r=await this._convertToCreate(this,t,!0);if(await this.client.createRun(r),!e){(0,s.m)("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(){try{const e={end_time:this.end_time,error:this.error,inputs:this.inputs,outputs:this.outputs,parent_run_id:this.parent_run?.id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags};await this.client.updateRun(this.id,e)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}static fromRunnableConfig(e,t){const r=e?.callbacks;let n,i,s,o=!!["TRACING_V2","TRACING"].find(e=>"true"===(0,a.Jz)(e));if(r){const e=r?.getParentRunId?.()??"",t=r?.handlers?.find(e=>"langchain_tracer"==e?.name);n=t?.getRun?.(e),i=t?.projectName,s=t?.client,o=o||!!t}return n?new c({name:n.name,id:n.id,trace_id:n.trace_id,dotted_order:n.dotted_order,client:s,tracingEnabled:o,project_name:i,tags:[...new Set((n?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...n?.extra?.metadata,...e?.metadata}}}).createChild(t):new c({...t,client:s,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const r="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,n=r["langsmith-trace"];if(!n||"string"!=typeof n)return;const a=n.trim(),i=a.split(".").map(e=>{const[t,r]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:r}}),s=i[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:i.at(-1)?.uuid,trace_id:s,dotted_order:a};if(r.baggage&&"string"==typeof r.baggage){const e=l.fromHeader(r.baggage);o.metadata=e.metadata,o.tags=e.tags}return new c(o)}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new l(this.extra?.metadata,this.tags).toHeader()};if(e)for(const[r,n]of Object.entries(t))e.set(r,n);return t}}function u(e){return void 0!==e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}function h(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function d(e){return Array.isArray(e)&&e.some(e=>h(e))}Object.defineProperty(c,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null})},3263:(e,t,r)=>{"use strict";r.d(t,{d1:()=>i.d,hU:()=>s});var n=r(305),a=r(9641),i=r(780);class s extends n.T{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?(0,a.U)(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return(0,i.D)(e[0].text)}async parse(e){return(0,i.D)(e,JSON.parse)}getFormatInstructions(){return""}}},3279:(e,t,r)=>{"use strict";r.d(t,{Cf:()=>n.Cf,SP:()=>n.SP,mu:()=>n.mu});var n=r(8028)},3290:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(228),a=r(6641),i=r(4774),s=()=>{},o=new a.TimeoutError;t.default=class extends n{constructor(e){var t,r,n,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=s,this._resolveIdle=s,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:i.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(r=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==r?r:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(a=null===(n=e.interval)||void 0===n?void 0:n.toString())&&void 0!==a?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=s,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=s,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,n)=>{this._queue.enqueue(async()=>{this._pendingCount++,this._intervalCount++;try{const i=void 0===this._timeout&&void 0===t.timeout?e():a.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&n(o)});r(await i)}catch(e){n(e)}this._next()},t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},3296:(e,t,r)=>{"use strict";r.d(t,{VectorDBQAChain:()=>i});var n=r(9834),a=r(6409);class i extends n.r{static lc_name(){return"VectorDBQAChain"}get inputKeys(){return[this.inputKey]}get outputKeys(){return this.combineDocumentsChain.outputKeys.concat(this.returnSourceDocuments?["sourceDocuments"]:[])}constructor(e){super(e),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"query"}),Object.defineProperty(this,"vectorstore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"combineDocumentsChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSourceDocuments",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.vectorstore=e.vectorstore,this.combineDocumentsChain=e.combineDocumentsChain,this.inputKey=e.inputKey??this.inputKey,this.k=e.k??this.k,this.returnSourceDocuments=e.returnSourceDocuments??this.returnSourceDocuments}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Question key ${this.inputKey} not found.`);const r=e[this.inputKey],n=await this.vectorstore.similaritySearch(r,this.k,e.filter,t?.getChild("vectorstore")),a={question:r,input_documents:n},i=await this.combineDocumentsChain.call(a,t?.getChild("combine_documents"));return this.returnSourceDocuments?{...i,sourceDocuments:n}:i}_chainType(){return"vector_db_qa"}static async deserialize(e,t){if(!("vectorstore"in t))throw new Error("Need to pass in a vectorstore to deserialize VectorDBQAChain");const{vectorstore:r}=t;if(!e.combine_documents_chain)throw new Error("VectorDBQAChain must have combine_documents_chain in serialized data");return new i({combineDocumentsChain:await n.r.deserialize(e.combine_documents_chain),k:e.k,vectorstore:r})}serialize(){return{_type:this._chainType(),combine_documents_chain:this.combineDocumentsChain.serialize(),k:this.k}}static fromLLM(e,t,r){return new this({vectorstore:t,combineDocumentsChain:(0,a.q4)(e),...r})}}},3382:(e,t,r)=>{"use strict";r.d(t,{MapReduceDocumentsChain:()=>o,RefineDocumentsChain:()=>l,StuffDocumentsChain:()=>s});var n=r(6446),a=r(9834),i=r(6768);class s extends a.r{static lc_name(){return"StuffDocumentsChain"}get inputKeys(){return[this.inputKey,...this.llmChain.inputKeys].filter(e=>e!==this.documentVariableName)}get outputKeys(){return this.llmChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),this.llmChain=e.llmChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey}_prepInputs(e){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);const{[this.inputKey]:t,...r}=e,n=t.map(({pageContent:e})=>e).join("\n\n");return{...r,[this.documentVariableName]:n}}async _call(e,t){return await this.llmChain.call(this._prepInputs(e),t?.getChild("combine_documents"))}_chainType(){return"stuff_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");return new s({llmChain:await i.LLMChain.deserialize(e.llm_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize()}}}class o extends a.r{static lc_name(){return"MapReduceDocumentsChain"}get inputKeys(){return[this.inputKey,...this.combineDocumentChain.inputKeys]}get outputKeys(){return this.combineDocumentChain.outputKeys}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"returnIntermediateSteps",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:3e3}),Object.defineProperty(this,"maxIterations",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"ensureMapStep",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"combineDocumentChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmChain=e.llmChain,this.combineDocumentChain=e.combineDocumentChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.ensureMapStep=e.ensureMapStep??this.ensureMapStep,this.inputKey=e.inputKey??this.inputKey,this.maxTokens=e.maxTokens??this.maxTokens,this.maxIterations=e.maxIterations??this.maxIterations,this.returnIntermediateSteps=e.returnIntermediateSteps??!1}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);const{[this.inputKey]:r,...n}=e;let a=r,i=[];for(let e=0;e<this.maxIterations;e+=1){const r=a.map(e=>({[this.documentVariableName]:e.pageContent,...n}));if(0!==e||!this.ensureMapStep){const e=await this.combineDocumentChain.llmChain.prompt.format(this.combineDocumentChain._prepInputs({[this.combineDocumentChain.inputKey]:a,...n}));if(await this.combineDocumentChain.llmChain._getNumTokens(e)<this.maxTokens)break}const s=await this.llmChain.apply(r,t?Array.from({length:r.length},(e,r)=>t.getChild(`map_${r+1}`)):void 0),{outputKey:o}=this.llmChain;this.returnIntermediateSteps&&(i=i.concat(s.map(e=>e[o]))),a=s.map(e=>({pageContent:e[o],metadata:{}}))}const s={[this.combineDocumentChain.inputKey]:a,...n},o=await this.combineDocumentChain.call(s,t?.getChild("combine_documents"));return this.returnIntermediateSteps?{...o,intermediateSteps:i}:o}_chainType(){return"map_reduce_documents_chain"}static async deserialize(e){if(!e.llm_chain)throw new Error("Missing llm_chain");if(!e.combine_document_chain)throw new Error("Missing combine_document_chain");return new o({llmChain:await i.LLMChain.deserialize(e.llm_chain),combineDocumentChain:await s.deserialize(e.combine_document_chain)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),combine_document_chain:this.combineDocumentChain.serialize()}}}class l extends a.r{static lc_name(){return"RefineDocumentsChain"}get defaultDocumentPrompt(){return new n.Hh({inputVariables:["page_content"],template:"{page_content}"})}get inputKeys(){return[...new Set([this.inputKey,...this.llmChain.inputKeys,...this.refineLLMChain.inputKeys])].filter(e=>e!==this.documentVariableName&&e!==this.initialResponseName)}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"llmChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"input_documents"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output_text"}),Object.defineProperty(this,"documentVariableName",{enumerable:!0,configurable:!0,writable:!0,value:"context"}),Object.defineProperty(this,"initialResponseName",{enumerable:!0,configurable:!0,writable:!0,value:"existing_answer"}),Object.defineProperty(this,"refineLLMChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"documentPrompt",{enumerable:!0,configurable:!0,writable:!0,value:this.defaultDocumentPrompt}),this.llmChain=e.llmChain,this.refineLLMChain=e.refineLLMChain,this.documentVariableName=e.documentVariableName??this.documentVariableName,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.documentPrompt=e.documentPrompt??this.documentPrompt,this.initialResponseName=e.initialResponseName??this.initialResponseName}async _constructInitialInputs(e,t){const r={page_content:e.pageContent,...e.metadata},n={};return this.documentPrompt.inputVariables.forEach(e=>{n[e]=r[e]}),{[this.documentVariableName]:await this.documentPrompt.format({...n}),...t}}async _constructRefineInputs(e,t){const r={page_content:e.pageContent,...e.metadata},n={};this.documentPrompt.inputVariables.forEach(e=>{n[e]=r[e]});const a={[this.documentVariableName]:await this.documentPrompt.format({...n})};return{[this.initialResponseName]:t,...a}}async _call(e,t){if(!(this.inputKey in e))throw new Error(`Document key ${this.inputKey} not found.`);const{[this.inputKey]:r,...n}=e,a=r,i=await this._constructInitialInputs(a[0],n);let s=await this.llmChain.predict({...i},t?.getChild("answer"));const o=[s];for(let e=1;e<a.length;e+=1){const r={...await this._constructRefineInputs(a[e],s),...n};s=await this.refineLLMChain.predict({...r},t?.getChild("refine")),o.push(s)}return{[this.outputKey]:s}}_chainType(){return"refine_documents_chain"}static async deserialize(e){const t=e.llm_chain;if(!t)throw new Error("Missing llm_chain");const r=e.refine_llm_chain;if(!r)throw new Error("Missing refine_llm_chain");return new l({llmChain:await i.LLMChain.deserialize(t),refineLLMChain:await i.LLMChain.deserialize(r)})}serialize(){return{_type:this._chainType(),llm_chain:this.llmChain.serialize(),refine_llm_chain:this.refineLLMChain.serialize()}}}},3490:(e,t,r)=>{"use strict";r.d(t,{AJ:()=>u,Vt:()=>o,XQ:()=>i,_I:()=>a,gj:()=>l,ns:()=>s,ny:()=>c});var n=r(8999);function a(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?[...e,...t]:[...e,{type:"text",text:t}]}class i extends n.y{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function s(e,t){const r={...e};for(const[e,n]of Object.entries(t))if(null==r[e])r[e]=n;else{if(null==n)continue;if(typeof r[e]!=typeof n||Array.isArray(r[e])!==Array.isArray(n))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof r[e])r[e]=r[e]+n;else if(Array.isArray(r[e])||"object"!=typeof r[e])if(Array.isArray(r[e]))r[e]=o(r[e],n);else{if(r[e]===n)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else r[e]=s(r[e],n)}return r}function o(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const r=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=r.findIndex(t=>t.index===e.index);-1!==t?r[t]=s(r[t],e):r.push(e)}else r.push(e);return r}}}class l extends i{}function c(e){return"function"==typeof e?._getType}function u(e){return c(e)&&"function"==typeof e.concat}},3602:(e,t,r)=>{"use strict";const n=r(4899),a=r(9558),i=r(2559);e.exports=(e,t)=>{e=new a(e,t);let r=new n("0.0.0");if(e.test(r))return r;if(r=new n("0.0.0-0"),e.test(r))return r;r=null;for(let t=0;t<e.set.length;++t){const a=e.set[t];let s=null;a.forEach(e=>{const t=new n(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":s&&!i(t,s)||(s=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}}),!s||r&&!i(r,s)||(r=s)}return r&&e.test(r)?r:null}},3650:(e,t,r)=>{"use strict";r.d(t,{PromptTemplate:()=>i});var n=r(329),a=r(9849);class i extends n.L{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if("mustache"===this.templateFormat)throw new Error("Mustache templates cannot be validated.");let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,a.Ns)(this.template,this.templateFormat,e)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return(0,a.Xm)(this.template,this.templateFormat,t)}static fromExamples(e,t,r,n="\n\n",a=""){const s=[a,...e,t].join(n);return new i({inputVariables:r,template:s})}static fromTemplate(e,t){const{templateFormat:r="f-string",...n}=t??{},s=new Set;return(0,a.QC)(e,r).forEach(e=>{"variable"===e.type&&s.add(e.name)}),new i({inputVariables:[...s],templateFormat:r,template:e,...n})}async partial(e){const t=this.inputVariables.filter(t=>!(t in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new i(n)}serialize(){if(void 0!==this.outputParser)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new i({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}},3690:(e,t,r)=>{"use strict";const n=r(7737);e.exports=(e,t)=>{const r=n(e,t);return r&&r.prerelease.length?r.prerelease:null}},3766:(e,t,r)=>{"use strict";r.d(t,{BJ:()=>w,FS:()=>y,RZ:()=>v,qF:()=>m,sS:()=>b});var n=r(8575),a=r(5311),i=r(6093),s=r(329),o=r(6993),l=r(3650),c=r(6279),u=r(9849);class h extends i.YN{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig(e=>this.formatMessages(e),e,{...t,runType:"prompt"})}}class d extends h{static lc_name(){return"MessagesPlaceholder"}constructor(e){"string"==typeof e&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}validateInputOrThrow(e,t){if(this.optional&&!e)return!1;if(!e){const e=new Error(`Error: Field "${t}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw e.name="InputFormatError",e}let r=!1;if(r=Array.isArray(e)?e.every(e=>(0,n.ny)(e)):(0,n.ny)(e),!r){const r="string"==typeof e?e:JSON.stringify(e,null,2),n=new Error(`Error: Field "${t}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: ${r}`);throw n.name="InputFormatError",n}return!0}async formatMessages(e){return this.validateInputOrThrow(e[this.variableName],this.variableName),e[this.variableName]??[]}}class p extends h{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class m extends o.m{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new a.aB(t)}}class f extends p{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new n.cM(await this.prompt.format(e),this.role)}static fromTemplate(e,t,r){return new this(l.PromptTemplate.fromTemplate(e,{templateFormat:r?.templateFormat}),t)}}class g extends h{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let e=[];this.prompt.forEach(t=>{"inputVariables"in t&&(e=e.concat(t.inputVariables))}),this.inputVariables=e}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){const t=this.constructor;if(t._messageClass())return new(t._messageClass())({content:e});if(t.chatMessageClass){const r=t.chatMessageClass();return new r({content:e,role:this.getRoleFromMessageClass(r.lc_name())})}throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if("string"==typeof e)return new this(l.PromptTemplate.fromTemplate(e,t));const r=[];for(const t of e)if("string"==typeof t||"object"==typeof t&&"text"in t){let e="";"string"==typeof t?e=t:"string"==typeof t.text&&(e=t.text??""),r.push(l.PromptTemplate.fromTemplate(e))}else if("object"==typeof t&&"image_url"in t){let e,n=t.image_url??"",a=[];if("string"==typeof n){const t=(0,u.D4)(n).flatMap(e=>"variable"===e.type?[e.name]:[]);if((t?.length??0)>0){if(t.length>1)throw new Error(`Only one format variable allowed per image template.\nGot: ${t}\nFrom: ${n}`);a=[t[0]]}else a=[];n={url:n},e=new c.C({template:n,inputVariables:a})}else{if("object"!=typeof n)throw new Error("Invalid image template");a="url"in n?(0,u.D4)(n.url).flatMap(e=>"variable"===e.type?[e.name]:[]):[],e=new c.C({template:n,inputVariables:a})}r.push(e)}return new this({prompt:r,additionalOptions:t})}async format(e){if(this.prompt instanceof s.L){const t=await this.prompt.format(e);return this.createMessage(t)}{const t=[];for(const r of this.prompt){let n={};if(!("inputVariables"in r))throw new Error(`Prompt ${r} does not have inputVariables defined.`);for(const t of r.inputVariables)n||(n={[t]:e[t]}),n={...n,[t]:e[t]};if(r instanceof s.L){const e=await r.format(n);t.push({type:"text",text:e})}else if(r instanceof c.C){const e=await r.format(n);t.push({type:"image_url",image_url:e})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}}class y extends g{static _messageClass(){return n.xc}static lc_name(){return"HumanMessagePromptTemplate"}}class b extends g{static _messageClass(){return n.Od}static lc_name(){return"AIMessagePromptTemplate"}}class w extends g{static _messageClass(){return n.tn}static lc_name(){return"SystemMessagePromptTemplate"}}function _(e,t){if("function"==typeof e.formatMessages||(0,n.ny)(e))return e;if(Array.isArray(e)&&"placeholder"===e[0]){const t=e[1];if("string"!=typeof t||"{"!==t[0]||"}"!==t[t.length-1])throw new Error(`Invalid placeholder template: "${e[1]}". Expected a variable name surrounded by curly braces.`);const r=t.slice(1,-1);return new d({variableName:r,optional:!0})}const r=(0,n.K0)(e);let a;if(a="string"==typeof r.content?r.content:r.content.map(e=>"text"in e?{text:e.text}:"image_url"in e?{image_url:e.image_url}:e),"human"===r._getType())return y.fromTemplate(a,t);if("ai"===r._getType())return b.fromTemplate(a,t);if("system"===r._getType())return w.fromTemplate(a,t);if(n.cM.isInstance(r))return f.fromTemplate(r.content,r.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${r._getType()}".`)}class v extends m{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){const e=new Set;for(const t of this.promptMessages)if(!(t instanceof n.XQ))for(const r of t.inputVariables)e.add(r);const t=this.inputVariables,r=new Set(this.partialVariables?t.concat(Object.keys(this.partialVariables)):t),a=new Set([...r].filter(t=>!e.has(t)));if(a.size>0)throw new Error(`Input variables \`${[...a]}\` are not used in any of the prompt messages.`);const i=new Set([...e].filter(e=>!r.has(e)));if(i.size>0)throw new Error(`Input variables \`${[...i]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if("string"==typeof e.content)return e;const r=await Promise.all(e.content.map(async e=>{if("image_url"!==e.type)return e;let r="";r="string"==typeof e.image_url?e.image_url:e.image_url.url;const n=l.PromptTemplate.fromTemplate(r),a=await n.format(t);return"string"!=typeof e.image_url&&"url"in e.image_url?e.image_url.url=a:e.image_url=a,e}));return e.content=r,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let r=[];for(const e of this.promptMessages)if(e instanceof n.XQ)r.push(await this._parseImagePrompts(e,t));else{const n=e.inputVariables.reduce((r,n)=>{if(!(n in t||"MessagesPlaceholder"===e.constructor.lc_name()&&e.optional))throw new Error(`Missing value for input variable \`${n.toString()}\``);return r[n]=t[n],r},{}),a=await e.formatMessages(n);r=r.concat(a)}return r}async partial(e){const t=this.inputVariables.filter(t=>!(t in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new v(n)}static fromTemplate(e,t){const r=l.PromptTemplate.fromTemplate(e,t),n=new y({prompt:r});return this.fromMessages([n])}static fromMessages(e,t){const r=e.reduce((e,r)=>e.concat(r instanceof v?r.promptMessages:[_(r,t)]),[]),a=e.reduce((e,t)=>t instanceof v?Object.assign(e,t.partialVariables):e,Object.create(null)),i=new Set;for(const e of r)if(!(e instanceof n.XQ))for(const t of e.inputVariables)t in a||i.add(t);return new this({...t,inputVariables:[...i],promptMessages:r,partialVariables:a,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}},3767:(e,t,r)=>{"use strict";const n=r(4899);e.exports=(e,t)=>new n(e,t).major},3829:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});const n={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let a;const i=new Uint8Array(16);function s(){if(!a&&(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!a))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(i)}const o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).slice(1));const l=function(e,t,r){if(n.randomUUID&&!t&&!e)return n.randomUUID();const a=(e=e||{}).random||(e.rng||s)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=a[e];return t}return function(e,t=0){return o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]}(a)}},3961:e=>{function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var a=this._errors[n],i=a.message,s=(e[i]||0)+1;e[i]=s,s>=r&&(t=a,r=s)}return t}},4004:(e,t,r)=>{"use strict";const n=r(7737);e.exports=(e,t)=>{const r=n(e,t);return r?r.version:null}},4056:(e,t,r)=>{"use strict";const n=r(4621);e.exports=(e,t,r)=>n(e,t,r)<0},4076:(e,t,r)=>{"use strict";const n=r(6592);e.exports=(e,t,r)=>n(e,t,">",r)},4083:(e,t,r)=>{"use strict";e=r.nmd(e);const n=(e=0)=>t=>`[${38+e};5;${t}m`,a=(e=0)=>(t,r,n)=>`[${38+e};2;${t};${r};${n}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[r,n]of Object.entries(t)){for(const[r,a]of Object.entries(n))t[r]={open:`[${a[0]}m`,close:`[${a[1]}m`},n[r]=t[r],e.set(a[0],a[1]);Object.defineProperty(t,r,{value:n,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=n(),t.color.ansi16m=a(),t.bgColor.ansi256=n(10),t.bgColor.ansi16m=a(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:r}=t.groups;3===r.length&&(r=r.split("").map(e=>e+e).join(""));const n=Number.parseInt(r,16);return[n>>16&255,n>>8&255,255&n]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},4106:(e,t,r)=>{"use strict";const n=r(4899);e.exports=(e,t,r,a,i)=>{"string"==typeof r&&(i=a,a=r,r=void 0);try{return new n(e instanceof n?e.version:e,r).inc(t,a,i).version}catch(e){return null}}},4116:(e,t,r)=>{"use strict";const n=r(5617),a=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class i extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const s=(e,t)=>new Promise((r,s)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=n.operation(t);o.attempt(async n=>{try{r(await e(n))}catch(e){if(!(e instanceof Error))return void s(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof i)o.stop(),s(e.originalError);else if(e instanceof TypeError&&(l=e.message,!a.includes(l)))o.stop(),s(e);else{((e,t,r)=>{const n=r.retries-(t-1);e.attemptNumber=t,e.retriesLeft=n})(e,n,t);try{await t.onFailedAttempt(e)}catch(e){return void s(e)}o.retry(e)||s(o.mainError())}}var l})});e.exports=s,e.exports.default=s,e.exports.AbortError=i},4301:(e,t,r)=>{"use strict";r.d(t,{X:()=>i,c:()=>a});var n=r(3490);class a extends n.XQ{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return a}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}}class i extends n.gj{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new i({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata),role:this.role})}}},4453:(e,t,r)=>{"use strict";const n=r(6592);e.exports=(e,t,r)=>n(e,t,"<",r)},4617:e=>{"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then(e=>new Promise(e=>{e(t())}).then(()=>e),e=>new Promise(e=>{e(t())}).then(()=>{throw e})))},4621:(e,t,r)=>{"use strict";const n=r(4899);e.exports=(e,t,r)=>new n(e,r).compare(new n(t,r))},4691:(e,t,r)=>{"use strict";r.d(t,{Td:()=>I,tW:()=>P,H_:()=>w});var n=r(3829),a=r(5960),i=r(4083),s=r(1590);function o(e,t){return`${e.open}${t}${e.close}`}function l(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function c(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:u}=i;class h extends s.J{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const e=this.runMap.get(r.parent_run_id);if(!e)break;t.push(e),r=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map((e,t,r)=>{const n=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?o(i.bold,n):n}).join(" > ");return o(u.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.green,"[chain/start]")} [${t}] Entering Chain run with input: ${l(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.cyan,"[chain/end]")} [${t}] [${c(e)}] Exiting Chain run with output: ${l(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.red,"[chain/error]")} [${t}] [${c(e)}] Chain run errored with error: ${l(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(e=>e.trim())}:e.inputs;console.log(`${o(u.green,"[llm/start]")} [${t}] Entering LLM run with input: ${l(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.cyan,"[llm/end]")} [${t}] [${c(e)}] Exiting LLM run with output: ${l(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.red,"[llm/error]")} [${t}] [${c(e)}] LLM run errored with error: ${l(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.cyan,"[tool/end]")} [${t}] [${c(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.red,"[tool/error]")} [${t}] [${c(e)}] Tool run errored with error: ${l(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${l(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.cyan,"[retriever/end]")} [${t}] [${c(e)}] Exiting Retriever run with output: ${l(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${o(u.red,"[retriever/error]")} [${t}] [${c(e)}] Retriever run errored with error: ${l(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${o(u.blue,"[agent/action]")} [${r}] Agent selected action: ${l(t.actions[t.actions.length-1],"[action]")}`)}}var d=r(1259),p=r(9583);class m extends s.J{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:n}=e;this.projectName=r??(0,p.Az)("LANGCHAIN_PROJECT")??(0,p.Az)("LANGCHAIN_SESSION"),this.exampleId=t,this.client=n??new d.Kj({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await(0,p.Ec)()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}}var f=r(8575);s.J;var g=r(3290);let y;async function b(e,t){!0===t?await e():(void 0===y&&(y=new(0,g.default)({autoStart:!0,concurrency:1})),y.add(e))}function w(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}"true"===(0,p.Az)("LANGCHAIN_TRACING_V2")&&"true"!==(0,p.Az)("LANGCHAIN_CALLBACKS_BACKGROUND")&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join("\n");class _{setHandler(e){return this.setHandlers([e])}}class v{constructor(e,t,r,n,a,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}async handleText(e){await Promise.all(this.handlers.map(t=>b(async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`)}},t.awaitHandlers)))}}class O extends v{getChild(e){const t=new I(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${e}`)}},t.awaitHandlers)))}}class A extends v{async handleLLMNewToken(e,t,r,n,a,i){await Promise.all(this.handlers.map(r=>b(async()=>{if(!r.ignoreLLM)try{await(r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`)}},r.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`)}},t.awaitHandlers)))}}class E extends v{getChild(e){const t=new I(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,n,a){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`)}},t.awaitHandlers)))}async handleChainEnd(e,t,r,n,a){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`)}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`)}},t.awaitHandlers)))}}class x extends v{getChild(e){const t=new I(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>b(async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`)}},t.awaitHandlers)))}}class I extends _{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,i=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(t.map(async(t,a)=>{const s=0===a&&r?r:(0,n.A)();return await Promise.all(this.handlers.map(r=>b(async()=>{if(!r.ignoreLLM)try{await(r.handleLLMStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,l))}catch(e){console.error(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`)}},r.awaitHandlers))),new A(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,i=void 0,s=void 0,o=void 0,l=void 0){return Promise.all(t.map(async(t,a)=>{const s=0===a&&r?r:(0,n.A)();return await Promise.all(this.handlers.map(r=>b(async()=>{if(!r.ignoreLLM)try{if(r.handleChatModelStart)await(r.handleChatModelStart?.(e,[t],s,this._parentRunId,i,this.tags,this.metadata,l));else if(r.handleLLMStart){const n=(0,f.Sw)(t);await(r.handleLLMStart?.(e,[n],s,this._parentRunId,i,this.tags,this.metadata,l))}}catch(e){console.error(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`)}},r.awaitHandlers))),new A(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=(0,n.A)(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(n=>b(async()=>{if(!n.ignoreChain)try{await(n.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,o))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${e}`)}},n.awaitHandlers))),new E(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=(0,n.A)(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(n=>b(async()=>{if(!n.ignoreAgent)try{await(n.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleToolStart: ${e}`)}},n.awaitHandlers))),new x(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=(0,n.A)(),a=void 0,i=void 0,s=void 0,o=void 0){return await Promise.all(this.handlers.map(n=>b(async()=>{if(!n.ignoreRetriever)try{await(n.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){console.error(`Error in handler ${n.constructor.name}, handleRetrieverStart: ${e}`)}},n.awaitHandlers))),new O(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new I(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const n of e)r.handlers.filter(e=>"console_callback_handler"===e.name).some(e=>e.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){class t extends a.N{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:(0,n.A)()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,n,a,i,s){let o;(e||t)&&(Array.isArray(e)||!e?(o=new I,o.setHandlers(e?.map(P)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(P):t?.handlers,!1));const l="true"===(0,p.Az)("LANGCHAIN_VERBOSE")||s?.verbose,c="true"===(0,p.Az)("LANGCHAIN_TRACING_V2"),u=c||((0,p.Az)("LANGCHAIN_TRACING")??!1);if(l||u){if(o||(o=new I),l&&!o.handlers.some(e=>e.name===h.prototype.name)){const e=new h;o.addHandler(e,!0)}u&&!o.handlers.some(e=>"langchain_tracer"===e.name)&&c&&o.addHandler(await async function(){return new m}(),!0)}return(r||n)&&o&&(o.addTags(r??[]),o.addTags(n??[],!1)),(a||i)&&o&&(o.addMetadata(a??{}),o.addMetadata(i??{},!1)),o}}function P(e){return"name"in e?e:a.N.fromMethods(e)}},4774:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(9998);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const r={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(r);const a=n.default(this._queue,r,(e,t)=>t.priority-e.priority);this._queue.splice(a,0,r)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this._queue.length}}},4785:(e,t,r)=>{"use strict";r.d(t,{Az:()=>h,Ec:()=>c,Jz:()=>d,yk:()=>u});var n=r(6928);let a;const i=()=>"undefined"!=typeof Deno,s=()=>a||(a="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||i()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":i()?"deno":"other":"node",a);let o,l;function c(){if(void 0===o){const e=s(),t=function(){if(void 0!==l)return l;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const e=h(r);void 0!==e&&(t[r]=e)}return l=t,t}();o={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:n.Ls,...t}}return o}function u(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce((e,[t,r])=>(e[t]=String(r),e),{}):void 0}catch(e){return}}()||{},t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[n,a]of Object.entries(e))!n.startsWith("LANGCHAIN_")||"string"!=typeof a||r.includes(n)||n.toLowerCase().includes("key")||n.toLowerCase().includes("secret")||n.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===n?t.revision_id=a:t[n]=a);return t}function h(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function d(e){return h(`LANGSMITH_${e}`)||h(`LANGCHAIN_${e}`)}},4896:(e,t,r)=>{"use strict";r.d(t,{YN:()=>n.YN,kI:()=>s,zZ:()=>n.zZ,ZI:()=>a.ZI});var n=r(6093),a=r(765),i=r(58);class s extends n.YN{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const r=(0,a.ZI)(t);return this.func&&await this.func(e,r),this._callWithConfig(e=>Promise.resolve(e),e,r)}async*transform(e,t){const r=(0,a.ZI)(t);let n,s=!0;for await(const t of this._transformStreamWithConfig(e,e=>e,r))if(yield t,s)if(void 0===n)n=t;else try{n=(0,i.xW)(n,t)}catch{n=void 0,s=!1}this.func&&void 0!==n&&await this.func(n,r)}static assign(e){return new n.B2(new n.ck({steps:e}))}}n.YN,n.YN,r(8575),n.fJ},4899:(e,t,r)=>{"use strict";const n=r(6735),{MAX_LENGTH:a,MAX_SAFE_INTEGER:i}=r(6261),{safeRe:s,t:o}=r(487),l=r(6588),{compareIdentifiers:c}=r(204);class u{constructor(e,t){if(t=l(t),e instanceof u){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>a)throw new TypeError(`version is longer than ${a} characters`);n("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?s[o.LOOSE]:s[o.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>i||this.major<0)throw new TypeError("Invalid major version");if(this.minor>i||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>i||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<i)return t}return e}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(n("SemVer.compare",this.version,this.options,e),!(e instanceof u)){if("string"==typeof e&&e===this.version)return 0;e=new u(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof u||(e=new u(e,this.options)),this.major<e.major?-1:this.major>e.major?1:this.minor<e.minor?-1:this.minor>e.minor?1:this.patch<e.patch?-1:this.patch>e.patch?1:0}comparePre(e){if(e instanceof u||(e=new u(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],a=e.prerelease[t];if(n("prerelease compare",t,r,a),void 0===r&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===r)return-1;if(r!==a)return c(r,a)}while(++t)}compareBuild(e){e instanceof u||(e=new u(e,this.options));let t=0;do{const r=this.build[t],a=e.build[t];if(n("build compare",t,r,a),void 0===r&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===r)return-1;if(r!==a)return c(r,a)}while(++t)}inc(e,t,r){if(e.startsWith("pre")){if(!t&&!1===r)throw new Error("invalid increment argument: identifier is empty");if(t){const e=`-${t}`.match(this.options.loose?s[o.PRERELEASELOOSE]:s[o.PRERELEASE]);if(!e||e[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"release":if(0===this.prerelease.length)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(r)?1:0;if(0===this.prerelease.length)this.prerelease=[e];else{let n=this.prerelease.length;for(;--n>=0;)"number"==typeof this.prerelease[n]&&(this.prerelease[n]++,n=-2);if(-1===n){if(t===this.prerelease.join(".")&&!1===r)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let n=[t,e];!1===r&&(n=[t]),0===c(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=n):this.prerelease=n}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=u},4914:(e,t,r)=>{"use strict";r.d(t,{ZE:()=>A,j_:()=>E,Z2:()=>O});var n="object"==typeof window?window:{},a="0123456789abcdef".split(""),i=[-2147483648,8388608,32768,128],s=[24,16,8,0],o=[];function l(e){e?(o[0]=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0,this.blocks=o):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}l.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===n.ArrayBuffer&&(e=new Uint8Array(e));for(var r,a,i=0,o=e.length||0,l=this.blocks;i<o;){if(this.hashed&&(this.hashed=!1,l[0]=this.block,l[16]=l[1]=l[2]=l[3]=l[4]=l[5]=l[6]=l[7]=l[8]=l[9]=l[10]=l[11]=l[12]=l[13]=l[14]=l[15]=0),t)for(a=this.start;i<o&&a<64;++i)l[a>>2]|=e[i]<<s[3&a++];else for(a=this.start;i<o&&a<64;++i)(r=e.charCodeAt(i))<128?l[a>>2]|=r<<s[3&a++]:r<2048?(l[a>>2]|=(192|r>>6)<<s[3&a++],l[a>>2]|=(128|63&r)<<s[3&a++]):r<55296||r>=57344?(l[a>>2]|=(224|r>>12)<<s[3&a++],l[a>>2]|=(128|r>>6&63)<<s[3&a++],l[a>>2]|=(128|63&r)<<s[3&a++]):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++i)),l[a>>2]|=(240|r>>18)<<s[3&a++],l[a>>2]|=(128|r>>12&63)<<s[3&a++],l[a>>2]|=(128|r>>6&63)<<s[3&a++],l[a>>2]|=(128|63&r)<<s[3&a++]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=l[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},l.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=i[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},l.prototype.hash=function(){var e,t,r=this.h0,n=this.h1,a=this.h2,i=this.h3,s=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)r=(t=(n=(t=(a=(t=(i=(t=(s=(t=r<<5|r>>>27)+(n&a|~n&i)+s+1518500249+o[e]|0)<<5|s>>>27)+(r&(n=n<<30|n>>>2)|~r&a)+i+1518500249+o[e+1]|0)<<5|i>>>27)+(s&(r=r<<30|r>>>2)|~s&n)+a+1518500249+o[e+2]|0)<<5|a>>>27)+(i&(s=s<<30|s>>>2)|~i&r)+n+1518500249+o[e+3]|0)<<5|n>>>27)+(a&(i=i<<30|i>>>2)|~a&s)+r+1518500249+o[e+4]|0,a=a<<30|a>>>2;for(;e<40;e+=5)r=(t=(n=(t=(a=(t=(i=(t=(s=(t=r<<5|r>>>27)+(n^a^i)+s+1859775393+o[e]|0)<<5|s>>>27)+(r^(n=n<<30|n>>>2)^a)+i+1859775393+o[e+1]|0)<<5|i>>>27)+(s^(r=r<<30|r>>>2)^n)+a+1859775393+o[e+2]|0)<<5|a>>>27)+(i^(s=s<<30|s>>>2)^r)+n+1859775393+o[e+3]|0)<<5|n>>>27)+(a^(i=i<<30|i>>>2)^s)+r+1859775393+o[e+4]|0,a=a<<30|a>>>2;for(;e<60;e+=5)r=(t=(n=(t=(a=(t=(i=(t=(s=(t=r<<5|r>>>27)+(n&a|n&i|a&i)+s-1894007588+o[e]|0)<<5|s>>>27)+(r&(n=n<<30|n>>>2)|r&a|n&a)+i-1894007588+o[e+1]|0)<<5|i>>>27)+(s&(r=r<<30|r>>>2)|s&n|r&n)+a-1894007588+o[e+2]|0)<<5|a>>>27)+(i&(s=s<<30|s>>>2)|i&r|s&r)+n-1894007588+o[e+3]|0)<<5|n>>>27)+(a&(i=i<<30|i>>>2)|a&s|i&s)+r-1894007588+o[e+4]|0,a=a<<30|a>>>2;for(;e<80;e+=5)r=(t=(n=(t=(a=(t=(i=(t=(s=(t=r<<5|r>>>27)+(n^a^i)+s-899497514+o[e]|0)<<5|s>>>27)+(r^(n=n<<30|n>>>2)^a)+i-899497514+o[e+1]|0)<<5|i>>>27)+(s^(r=r<<30|r>>>2)^n)+a-899497514+o[e+2]|0)<<5|a>>>27)+(i^(s=s<<30|s>>>2)^r)+n-899497514+o[e+3]|0)<<5|n>>>27)+(a^(i=i<<30|i>>>2)^s)+r-899497514+o[e+4]|0,a=a<<30|a>>>2;this.h0=this.h0+r|0,this.h1=this.h1+n|0,this.h2=this.h2+a|0,this.h3=this.h3+i|0,this.h4=this.h4+s|0},l.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,i=this.h4;return a[e>>28&15]+a[e>>24&15]+a[e>>20&15]+a[e>>16&15]+a[e>>12&15]+a[e>>8&15]+a[e>>4&15]+a[15&e]+a[t>>28&15]+a[t>>24&15]+a[t>>20&15]+a[t>>16&15]+a[t>>12&15]+a[t>>8&15]+a[t>>4&15]+a[15&t]+a[r>>28&15]+a[r>>24&15]+a[r>>20&15]+a[r>>16&15]+a[r>>12&15]+a[r>>8&15]+a[r>>4&15]+a[15&r]+a[n>>28&15]+a[n>>24&15]+a[n>>20&15]+a[n>>16&15]+a[n>>12&15]+a[n>>8&15]+a[n>>4&15]+a[15&n]+a[i>>28&15]+a[i>>24&15]+a[i>>20&15]+a[i>>16&15]+a[i>>12&15]+a[i>>8&15]+a[i>>4&15]+a[15&i]},l.prototype.toString=l.prototype.hex,l.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,a=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,a>>24&255,a>>16&255,a>>8&255,255&a]},l.prototype.array=l.prototype.digest,l.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};var c=r(8575);const u=(...e)=>{return t=e.join("_"),new l(!0).update(t).hex();var t};class h{}const d=new Map;class p extends h{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(u(e,t))??null)}async update(e,t,r){this.cache.set(u(e,t),r)}static global(){return new p(d)}}var m=r(5311),f=r(9624),g=r(8139);const y={},b=new f.g({});async function w(e){return async function(e){return e in y||(y[e]=b.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(e=>e.json()).then(e=>new g.s(e)).catch(t=>{throw delete y[e],t})),await y[e]}((0,g.N)(e))}var _=r(6093);const v=e=>e.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":e.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":e.startsWith("gpt-4-32k")?"gpt-4-32k":e.startsWith("gpt-4-")?"gpt-4":e.startsWith("gpt-4o")?"gpt-4o":e,O=async({prompt:e,modelName:t})=>{let r;try{r=(await w(v(t))).encode(e).length}catch(t){console.warn("Failed to calculate number of tokens, falling back to approximate count"),r=Math.ceil(e.length/4)}const n=(e=>{switch(v(e)){case"gpt-3.5-turbo-16k":return 16384;case"gpt-3.5-turbo":return 4096;case"gpt-4-32k":return 32768;case"gpt-4":return 8192;case"text-davinci-003":default:return 4097;case"text-curie-001":case"text-babbage-001":case"text-ada-001":case"code-cushman-001":return 2048;case"code-davinci-002":return 8e3}})(t);return n-r};class A extends _.YN{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class E extends A{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof r.cache?this.cache=r.cache:r.cache?this.cache=p.global():this.cache=void 0,this.caller=new f.g(r??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await w("modelName"in this?v(this.modelName):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new m.HY(e):Array.isArray(e)?new m.aB(e.map(c.K0)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()};return Object.entries(r).filter(([e,t])=>void 0!==t).map(([e,t])=>`${e}:${JSON.stringify(t)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}},5230:(e,t,r)=>{"use strict";r.d(t,{A:()=>c});const n={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var a,i=new Uint8Array(16);function s(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(i)}for(var o=[],l=0;l<256;++l)o.push((l+256).toString(16).slice(1));const c=function(e,t,r){if(n.randomUUID&&!t&&!e)return n.randomUUID();var a=(e=e||{}).random||(e.rng||s)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(var i=0;i<16;++i)t[r+i]=a[i];return t}return function(e,t=0){return(o[e[t+0]]+o[e[t+1]]+o[e[t+2]]+o[e[t+3]]+"-"+o[e[t+4]]+o[e[t+5]]+"-"+o[e[t+6]]+o[e[t+7]]+"-"+o[e[t+8]]+o[e[t+9]]+"-"+o[e[t+10]]+o[e[t+11]]+o[e[t+12]]+o[e[t+13]]+o[e[t+14]]+o[e[t+15]]).toLowerCase()}(a)}},5311:(e,t,r)=>{"use strict";r.d(t,{HY:()=>s,aB:()=>o,vX:()=>l});var n=r(8999),a=r(8575);class i extends n.y{}class s extends i{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new a.xc(this.value)]}}class o extends i{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return(0,a.Sw)(this.messages)}toChatMessages(){return this.messages}}class l extends i{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new a.xc({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}},5454:(e,t,r)=>{"use strict";r.d(t,{a:()=>i,x:()=>a});var n=r(3490);class a extends n.XQ{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class i extends n.gj{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new i({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata)})}}},5617:(e,t,r)=>{e.exports=r(8303)},5960:(e,t,r)=>{"use strict";r.d(t,{N:()=>o});var n=r(3829),a=r(8999),i=r(9583);class s{}class o extends s{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,(0,a.Z)(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==(0,i.Az)("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.awaitHandlers=e._awaitHandler??this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return a.y.prototype.toJSON.call(this)}toJSONNotImplemented(){return a.y.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends o{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:n.A()}),Object.assign(this,e)}}}}},5985:(e,t,r)=>{"use strict";const n=r(4899),a=r(9558);e.exports=(e,t,r)=>{let i=null,s=null,o=null;try{o=new a(t,r)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(i&&-1!==s.compare(e)||(i=e,s=new n(i,r)))}),i}},6093:(e,t,r)=>{"use strict";r.d(t,{YN:()=>j,B2:()=>F,fJ:()=>N,jY:()=>D,ck:()=>M,zZ:()=>L,GH:()=>C,Bp:()=>z});var n=r(8952),a=r(4116),i=r(4691),s=r(6150),o=r(1590),l=r(58),c=r(8575);class u{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=(0,s.X6)({},t);return new h({ops:t,state:r[r.length-1].newDocument})}}class h extends u{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=(0,s.X6)(this.state,e.ops);return new h({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=(0,s.X6)({},e.ops);return new h({ops:e.ops,state:t[t.length-1].newDocument})}}async function d(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=e;return["retriever","llm","prompt"].includes(e.run_type)?r:1!==Object.keys(r).length||""!==r?.input?r.input:void 0}async function p(e,t){const{outputs:r}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?r:void 0!==r&&1===Object.keys(r).length&&void 0!==r?.output?r.output:r}class m extends o.J{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=l.bO.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every(e=>!this.excludeTags?.includes(e))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new u({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new u({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(r.inputs=await d(e,this._schemaFormat)),await this.writer.write(new u({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const r=[];"streaming_events"===this._schemaFormat&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await d(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await p(e,this._schemaFormat)}),void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const n=new u({ops:r});await this.writer.write(n)}finally{if(e.id===this.rootId){const t=new u({ops:[{op:"replace",path:"/final_output",value:await p(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const n=this.keyMapByRunId[e.id];if(void 0===n)return;let a;var i;void 0!==e.inputs.messages?(i=r?.chunk,a=void 0!==i&&void 0!==i.message?r?.chunk:new c.H(t)):a=t;const s=new u({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${n}/streamed_output/-`,value:a}]});await this.writer.write(s)}}var f=r(8999),g=r(765),y=r(9624);class b extends o.J{constructor({config:e,onStart:t,onEnd:r,onError:n}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=n}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function w(e){return!!e&&e.lc_runnable}class _{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const n=e.tags??[];return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(t)),void 0!==this.includeTags&&(r=r||n.some(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(r=r&&n.every(e=>!this.excludeTags?.includes(e))),r}}var v=r(8521),O=r(8201);const A=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;var E=r(3829);function x(e){return w(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...(0,O.Ik)(e.data.schema),title:e.data.name}}}class I{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{var n;e[t.id]="string"==typeof(n=t.id)&&A.test(n)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...x(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const r=t||(0,E.A)(),n={id:r,data:e};return this.nodes[r]=n,n}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const n={source:e.id,target:t.id,data:r};return this.edges.push(n),n}firstNode(){const e=new Set(this.edges.map(e=>e.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){const e=new Set(this.edges.map(e=>e.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e){Object.entries(e.nodes).forEach(([e,t])=>{this.nodes[e]=t}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter(t=>t.source===e.id);1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter(t=>t.target===e.id);1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}}function P(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function S(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*k(e,t){const r=v.N.getInstance();for(;;){const{value:n,done:a}=r.run(e,t.next.bind(t));if(a)break;yield n}}async function*T(e,t){const r=v.N.getInstance(),n=t[Symbol.asyncIterator]();for(;;){const{value:a,done:i}=await r.run(e,n.next.bind(t));if(i)break;yield a}}function C(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class j extends f.y{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new N({bound:this,kwargs:e,config:{}})}map(){return new R({bound:this})}withRetry(e){return new $({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new N({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new U({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(g.ZI);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([e])=>"runId"!==e));return Array.from({length:t},(t,n)=>(0,g.ZI)(0===n?e:r))}return Array.from({length:t},()=>(0,g.ZI)(e))}async batch(e,t,r){const n=this._getOptionsList(t??{},e.length),a=n[0]?.maxConcurrency??r?.maxConcurrency,i=new y.g({maxConcurrency:a,onFailedAttempt:e=>{throw e}}),s=e.map((e,t)=>i.call(async()=>{try{return await this.invoke(e,n[t])}catch(e){if(r?.returnExceptions)return e;throw e}}));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=new l.Tr(this._streamIterator(e,(0,g.ZI)(t)));return await r.setup,l.bO.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;t=void 0===e?(0,g.ZI)(e):(0,g.ZI)({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){const n=(0,g.ZI)(r),a=await(0,g.kJ)(n),i=await(a?.handleChainStart(this.toJSON(),C(t,"input"),n.runId,n?.runType,void 0,void 0,n?.runName??this.getName()));let s;delete n.runId;try{s=await e.call(this,t,n,i)}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(C(s,"output"))),s}async _batchWithConfig(e,t,r,n){const a=this._getOptionsList(r??{},t.length),i=await Promise.all(a.map(g.kJ)),s=await Promise.all(i.map(async(e,r)=>{const n=await(e?.handleChainStart(this.toJSON(),C(t[r],"input"),a[r].runId,a[r].runType,void 0,void 0,a[r].runName??this.getName()));return delete a[r].runId,n}));let o;try{o=await e.call(this,t,a,s,n)}catch(e){throw await Promise.all(s.map(t=>t?.handleChainError(e))),e}return await Promise.all(s.map(e=>e?.handleChainEnd(C(o,"output")))),o}async*_transformStreamWithConfig(e,t,r){let n,a,i=!0,s=!0;const o=(0,g.ZI)(r),c=await(0,g.kJ)(o);let u;try{const r=await(0,l.DS)(t.bind(this),async function*(){for await(const t of e){if(i)if(void 0===n)n=t;else try{n=(0,l.xW)(n,t)}catch{n=void 0,i=!1}yield t}}(),async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName()),o);delete o.runId,u=r.setup;const h=e=>"log_stream_tracer"===e.name,d=u?.handlers.find(h);let p=r.output;void 0!==d&&void 0!==u&&(p=await d.tapOutputIterable(u.runId,r.output));for await(const e of p)if(yield e,s)if(void 0===a)a=e;else try{a=(0,l.xW)(a,e)}catch{a=void 0,s=!1}}catch(e){throw await(u?.handleChainError(e,void 0,void 0,void 0,{inputs:C(n,"input")})),e}await(u?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:C(n,"input")}))}getGraph(e){const t=new I,r=t.addNode({name:`${this.getName()}Input`,schema:n.bz()}),a=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:n.bz()});return t.addEdge(r,a),t.addEdge(a,i),t}pipe(e){return new L({first:this,last:z(e)})}pick(e){return this.pipe(new B(e))}assign(e){return this.pipe(new F(new M({steps:e})))}async*transform(e,t){let r;for await(const t of e)r=void 0===r?t:(0,l.xW)(r,t);yield*this._streamIterator(r,(0,g.ZI)(t))}async*streamLog(e,t,r){const n=new m({...r,autoClose:!1,_schemaFormat:"original"}),a=(0,g.ZI)(t);yield*this._streamLog(e,n,a)}async*_streamLog(e,t,r){const{callbacks:n}=r;if(void 0===n)r.callbacks=[t];else if(Array.isArray(n))r.callbacks=n.concat([t]);else{const e=n.copy();e.inheritableHandlers.push(t),r.callbacks=e}const a=this.stream(e,r),i=async function(){try{const e=await a;for await(const r of e){const e=new u({ops:[{op:"add",path:"/streamed_output/-",value:r}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await i}}async*streamEvents(e,t,r){if("text/event-stream"===t.encoding){const n=await this._streamEvents(e,t,r);yield*function(e){const t=new TextEncoder,r=new ReadableStream({async start(r){for await(const n of e)r.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(n)}\n\n`));r.enqueue(t.encode("event: end\n\n")),r.close()}});return l.bO.fromReadableStream(r)}(n)}else yield*this._streamEvents(e,t,r)}async*_streamEvents(e,t,r){if("v1"!==t.version)throw new Error('Only version "v1" of the events schema is currently supported.');let n,a=!1;const i=(0,g.ZI)(t),s=i.tags??[],o=i.metadata??{},l=i.runName??this.getName(),c=new m({...r,autoClose:!1,_schemaFormat:"streaming_events"}),u=new _({...r}),d=this._streamLog(e,c,i);for await(const t of d){if(n=n?n.concat(t):h.fromRunLogPatch(t),void 0===n.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const t={...n.state},r={run_id:t.id,event:`on_${t.type}_start`,name:l,tags:s,metadata:o,data:{input:e}};u.includeEvent(r,t.type)&&(yield r)}const r=t.ops.filter(e=>e.path.startsWith("/logs/")).map(e=>e.path.split("/")[2]),i=[...new Set(r)];for(const e of i){let t,r={};const a=n.state.logs[e];if(t=void 0===a.end_time?a.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==a.inputs&&(r.input=a.inputs);else if("end"===t)void 0!==a.inputs&&(r.input=a.inputs),r.output=a.final_output;else if("stream"===t){const e=a.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${a.name}"`);r={chunk:a.streamed_output[0]},a.streamed_output=[]}yield{event:`on_${a.type}_${t}`,name:a.name,run_id:a.id,tags:a.tags,metadata:a.metadata,data:r}}const{state:c}=n;if(c.streamed_output.length>0){const e=c.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${c.name}"`);const t={chunk:c.streamed_output[0]};c.streamed_output=[];const r={event:`on_${c.type}_stream`,run_id:c.id,tags:s,metadata:o,name:l,data:t};u.includeEvent(r,c.type)&&(yield r)}}const p=n?.state;if(void 0!==p){const e={event:`on_${p.type}_end`,name:l,run_id:p.id,tags:s,metadata:o,data:{output:p.final_output}};u.includeEvent(e,p.type)&&(yield e)}}static isRunnable(e){return w(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new N({bound:this,config:{},configFactories:[n=>({callbacks:[new b({config:n,onStart:e,onEnd:t,onError:r})]})]})}}class N extends j{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=(0,g.SV)(this.config,...e);return(0,g.SV)(t,...this.configFactories?await Promise.all(this.configFactories.map(async e=>await e(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig((0,g.ZI)(t),this.kwargs))}async batch(e,t,r){const n=Array.isArray(t)?await Promise.all(t.map(async e=>this._mergeConfig((0,g.ZI)(e),this.kwargs))):await this._mergeConfig((0,g.ZI)(t),this.kwargs);return this.bound.batch(e,n,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig((0,g.ZI)(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig((0,g.ZI)(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig((0,g.ZI)(t),this.kwargs))}async*streamEvents(e,t,r){yield*this.bound.streamEvents(e,{...await this._mergeConfig((0,g.ZI)(t),this.kwargs),version:t.version},r)}static isRunnableBinding(e){return e.bound&&j.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new N({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[n=>({callbacks:[new b({config:n,onStart:e,onEnd:t,onError:r})]})]})}}class R extends j{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new R({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,(0,g.tn)(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new R({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class $ extends N{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const n=e>1?`retry:attempt:${e}`:void 0;return(0,g.tn)(t,{callbacks:r?.getChild(n)})}async _invoke(e,t,r){return a(n=>super.invoke(e,this._patchConfigForRetry(n,t,r)),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,n){const i={};try{await a(async a=>{const s=e.map((e,t)=>t).filter(e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error),o=s.map(t=>e[t]),l=s.map(e=>this._patchConfigForRetry(a,t?.[e],r?.[e])),c=await super.batch(o,l,{...n,returnExceptions:!0});let u;for(let e=0;e<c.length;e+=1){const t=c[e],r=s[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),i[r.toString()]=t}if(u)throw u;return c},{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==n?.returnExceptions)throw e}return Object.keys(i).sort((e,t)=>parseInt(e,10)-parseInt(t,10)).map(e=>i[parseInt(e,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class L extends j{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=(0,g.ZI)(t),n=await(0,g.kJ)(r),a=await(n?.handleChainStart(this.toJSON(),C(e,"input"),r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;let i,s=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const n=e[t];s=await n.invoke(s,(0,g.tn)(r,{callbacks:a?.getChild(`seq:step:${t+1}`)}))}i=await this.last.invoke(s,(0,g.tn)(r,{callbacks:a?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(C(i,"output"))),i}async batch(e,t,r){const n=this._getOptionsList(t??{},e.length),a=await Promise.all(n.map(g.kJ)),i=await Promise.all(a.map(async(t,r)=>{const a=await(t?.handleChainStart(this.toJSON(),C(e[r],"input"),n[r].runId,void 0,void 0,void 0,n[r].runName));return delete n[r].runId,a}));let s=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];s=await t.batch(s,i.map((t,r)=>{const a=t?.getChild(`seq:step:${e+1}`);return(0,g.tn)(n[r],{callbacks:a})}),r)}}catch(e){throw await Promise.all(i.map(t=>t?.handleChainError(e))),e}return await Promise.all(i.map(e=>e?.handleChainEnd(C(s,"output")))),s}async*_streamIterator(e,t){const r=await(0,g.kJ)(t),{runId:n,...a}=t??{},i=await(r?.handleChainStart(this.toJSON(),C(e,"input"),n,void 0,void 0,void 0,a?.runName)),s=[this.first,...this.middle,this.last];let o,c=!0;try{let t=s[0].transform(async function*(){yield e}(),(0,g.tn)(a,{callbacks:i?.getChild("seq:step:1")}));for(let e=1;e<s.length;e+=1){const r=s[e];t=await r.transform(t,(0,g.tn)(a,{callbacks:i?.getChild(`seq:step:${e+1}`)}))}for await(const e of t)if(yield e,c)if(void 0===o)o=e;else try{o=(0,l.xW)(o,e)}catch(e){o=void 0,c=!1}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(C(o,"output")))}getGraph(e){const t=new I;let r=null;return this.steps.forEach((n,a)=>{const i=n.getGraph(e);0!==a&&i.trimFirstNode(),a!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const s=i.firstNode();if(!s)throw new Error(`Runnable ${n} has no first node`);r&&t.addEdge(r,s),r=i.lastNode()}),t}pipe(e){return L.isRunnableSequence(e)?new L({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new L({first:this.first,middle:[...this.middle,this.last],last:z(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&j.isRunnable(e)}static from([e,...t],r){return new L({first:z(e),middle:t.slice(0,-1).map(z),last:z(t[t.length-1]),name:r})}}class M extends j{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=z(r)}static from(e){return new M({steps:e})}async invoke(e,t){const r=(0,g.ZI)(t),n=await(0,g.kJ)(r),a=await(n?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;const i={};try{await Promise.all(Object.entries(this.steps).map(async([t,n])=>{i[t]=await n.invoke(e,(0,g.tn)(r,{callbacks:a?.getChild(`map:key:${t}`)}))}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(i)),i}async*_transform(e,t,r){const n={...this.steps},a=(0,l.gI)(e,Object.keys(n).length),i=new Map(Object.entries(n).map(([e,n],i)=>{const s=n.transform(a[i],(0,g.tn)(r,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then(t=>({key:e,gen:s,result:t}))]}));for(;i.size;){const{key:e,result:t,gen:r}=await Promise.race(i.values());i.delete(e),t.done||(yield{[e]:t.value},i.set(e,r.next().then(t=>({key:e,gen:r,result:t}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=new l.Tr(this.transform(async function*(){yield e}(),t));return await r.setup,l.bO.fromAsyncGenerator(r)}}class D extends j{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new D({func:e})}async _invoke(e,t,r){return new Promise((n,a)=>{const i=(0,g.tn)(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??g.p_)-1});v.N.getInstance().run(i,async()=>{try{let r=await this.func(e,{...i,config:i});if(r&&j.isRunnable(r)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");r=await r.invoke(e,{...i,recursionLimit:(i.recursionLimit??g.p_)-1})}else if(S(r)){let e;for await(const t of T(i,r))if(void 0===e)e=t;else try{e=(0,l.xW)(e,t)}catch(r){e=t}r=e}else if(P(r)){let e;for(const t of k(i,r))if(void 0===e)e=t;else try{e=(0,l.xW)(e,t)}catch(r){e=t}r=e}n(r)}catch(e){a(e)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let n;for await(const t of e)if(void 0===n)n=t;else try{n=(0,l.xW)(n,t)}catch(e){n=t}const a=await new Promise((e,t)=>{v.N.getInstance().run(r,async()=>{try{const t=await this.func(n,{...r,config:r});e(t)}catch(e){t(e)}})});if(a&&j.isRunnable(a)){if(0===r?.recursionLimit)throw new Error("Recursion limit reached.");const e=await a.stream(n,(0,g.tn)(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??g.p_)-1}));for await(const t of e)yield t}else if(S(a))for await(const e of T(r,a))yield e;else if(P(a))for(const e of k(r,a))yield e;else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=new l.Tr(this.transform(async function*(){yield e}(),t));return await r.setup,l.bO.fromAsyncGenerator(r)}}class U extends j{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await i.Td.configure(t?.callbacks,void 0,t?.tags,void 0,t?.metadata),{runId:n,...a}=t??{},s=await(r?.handleChainStart(this.toJSON(),C(e,"input"),n,void 0,void 0,void 0,a?.runName));let o;for(const t of this.runnables())try{const r=await t.invoke(e,(0,g.tn)(a,{callbacks:s?.getChild()}));return await(s?.handleChainEnd(C(r,"output"))),r}catch(e){void 0===o&&(o=e)}if(void 0===o)throw new Error("No error stored at end of fallback.");throw await(s?.handleChainError(o)),o}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const n=this._getOptionsList(t??{},e.length),a=await Promise.all(n.map(e=>i.Td.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata))),s=await Promise.all(a.map(async(t,r)=>{const a=await(t?.handleChainStart(this.toJSON(),C(e[r],"input"),n[r].runId,void 0,void 0,void 0,n[r].runName));return delete n[r].runId,a}));let o;for(const t of this.runnables())try{const a=await t.batch(e,s.map((e,t)=>(0,g.tn)(n[t],{callbacks:e?.getChild()})),r);return await Promise.all(s.map((e,t)=>e?.handleChainEnd(C(a[t],"output")))),a}catch(e){void 0===o&&(o=e)}if(!o)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(s.map(e=>e?.handleChainError(o))),o}}function z(e){if("function"==typeof e)return new D({func:e});if(j.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[r,n]of Object.entries(e))t[r]=z(n);return new M({steps:t})}}class F extends j{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof M&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const n=this.mapper.getStepsKeys(),[a,i]=(0,l.gI)(e),s=this.mapper.transform(i,(0,g.tn)(r,{callbacks:t?.getChild()})),o=s.next();for await(const e of a){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter(([e])=>!n.includes(e)));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of s)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=new l.Tr(this.transform(async function*(){yield e}(),t));return await r.setup,l.bO.fromAsyncGenerator(r)}}class B extends j{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map(t=>[t,e[t]]).filter(e=>void 0!==e[1]);return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=new l.Tr(this.transform(async function*(){yield e}(),t));return await r.setup,l.bO.fromAsyncGenerator(r)}}},6133:(e,t,r)=>{"use strict";const n=r(4621);e.exports=(e,t,r)=>n(e,t,r)<=0},6150:(e,t,r)=>{"use strict";r.d(t,{X6:()=>_,UD:()=>I});var n={};r.r(n),r.d(n,{JsonPatchError:()=>m,_areEquals:()=>E,applyOperation:()=>w,applyPatch:()=>_,applyReducer:()=>v,deepClone:()=>f,getValueByPointer:()=>b,validate:()=>A,validator:()=>O});const a=Object.prototype.hasOwnProperty;function i(e,t){return a.call(e,t)}function s(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)i(e,r)&&t.push(r);return t}function o(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function l(e){let t=0;const r=e.length;let n;for(;t<r;){if(n=e.charCodeAt(t),!(n>=48&&n<=57))return!1;t++}return!0}function c(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function u(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function h(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(h(e[t]))return!0}else if("object"==typeof e){const r=s(e),n=r.length;for(var t=0;t<n;t++)if(h(e[r[t]]))return!0}return!1}function d(e,t){const r=[e];for(const e in t){const n="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==n&&r.push(`${e}: ${n}`)}return r.join("\n")}class p extends Error{constructor(e,t,r,n,a){super(d(e,{name:t,index:r,operation:n,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=d(e,{name:t,index:r,operation:n,tree:a})}}const m=p,f=o,g={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var n=e[t];return delete e[t],{newDocument:r,removed:n}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:function(e,t,r){let n=b(r,this.path);n&&(n=o(n));const a=w(r,{op:"remove",path:this.from}).removed;return w(r,{op:"add",path:this.path,value:a}),{newDocument:r,removed:n}},copy:function(e,t,r){const n=b(r,this.from);return w(r,{op:"add",path:this.path,value:o(n)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:E(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var y={add:function(e,t,r){return l(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:g.move,copy:g.copy,test:g.test,_get:g._get};function b(e,t){if(""==t)return e;var r={op:"_get",path:t};return w(e,r),r.value}function w(e,t,r=!1,n=!0,a=!0,i=0){if(r&&("function"==typeof r?r(t,0,e,t.path):O(t,0)),""===t.path){let n={newDocument:e};if("add"===t.op)return n.newDocument=t.value,n;if("replace"===t.op)return n.newDocument=t.value,n.removed=e,n;if("move"===t.op||"copy"===t.op)return n.newDocument=b(e,t.from),"move"===t.op&&(n.removed=e),n;if("test"===t.op){if(n.test=E(e,t.value),!1===n.test)throw new m("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return n.newDocument=e,n}if("remove"===t.op)return n.removed=e,n.newDocument=null,n;if("_get"===t.op)return t.value=e,n;if(r)throw new m("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return n}{n||(e=o(e));const s=(t.path||"").split("/");let c,h,d,p=e,f=1,b=s.length;for(d="function"==typeof r?r:O;;){if(h=s[f],h&&-1!=h.indexOf("~")&&(h=u(h)),a&&("__proto__"==h||"prototype"==h&&f>0&&"constructor"==s[f-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===c&&(void 0===p[h]?c=s.slice(0,f).join("/"):f==b-1&&(c=t.path),void 0!==c&&d(t,0,e,c)),f++,Array.isArray(p)){if("-"===h)h=p.length;else{if(r&&!l(h))throw new m("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);l(h)&&(h=~~h)}if(f>=b){if(r&&"add"===t.op&&h>p.length)throw new m("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const n=y[t.op].call(t,p,h,e);if(!1===n.test)throw new m("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return n}}else if(f>=b){const r=g[t.op].call(t,p,h,e);if(!1===r.test)throw new m("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}if(p=p[h],r&&f<b&&(!p||"object"!=typeof p))throw new m("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function _(e,t,r,n=!0,a=!0){if(r&&!Array.isArray(t))throw new m("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(e=o(e));const i=new Array(t.length);for(let n=0,s=t.length;n<s;n++)i[n]=w(e,t[n],r,!0,a,n),e=i[n].newDocument;return i.newDocument=e,i}function v(e,t,r){const n=w(e,t);if(!1===n.test)throw new m("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return n.newDocument}function O(e,t,r,n){if("object"!=typeof e||null===e||Array.isArray(e))throw new m("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(!g[e.op])throw new m("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r);if("string"!=typeof e.path)throw new m("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new m('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new m("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new m("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&h(e.value))throw new m("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r)if("add"==e.op){var a=e.path.split("/").length,i=n.split("/").length;if(a!==i+1&&a!==i)throw new m("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==n)throw new m("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var s=A([{op:"_get",path:e.from,value:void 0}],r);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new m("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}function A(e,t,r){try{if(!Array.isArray(e))throw new m("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)_(o(t),o(e),r||!0);else{r=r||O;for(var n=0;n<e.length;n++)r(e[n],n,t,void 0)}}catch(e){if(e instanceof m)return e;throw e}}function E(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,n,a,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((n=e.length)!=t.length)return!1;for(r=n;0!==r--;)if(!E(e[r],t[r]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((n=o.length)!==Object.keys(t).length)return!1;for(r=n;0!==r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=n;0!==r--;)if(!E(e[a=o[r]],t[a]))return!1;return!0}return e!=e&&t!=t}function x(e,t,r,n,a){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var l=s(t),u=s(e),h=!1,d=u.length-1;d>=0;d--){var p=e[f=u[d]];if(!i(t,f)||void 0===t[f]&&void 0!==p&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(a&&r.push({op:"test",path:n+"/"+c(f),value:o(p)}),r.push({op:"remove",path:n+"/"+c(f)}),h=!0):(a&&r.push({op:"test",path:n,value:e}),r.push({op:"replace",path:n,value:t}));else{var m=t[f];"object"==typeof p&&null!=p&&"object"==typeof m&&null!=m&&Array.isArray(p)===Array.isArray(m)?x(p,m,r,n+"/"+c(f),a):p!==m&&(a&&r.push({op:"test",path:n+"/"+c(f),value:o(p)}),r.push({op:"replace",path:n+"/"+c(f),value:o(m)}))}}if(h||l.length!=u.length)for(d=0;d<l.length;d++){var f;i(e,f=l[d])||void 0===t[f]||r.push({op:"add",path:n+"/"+c(f),value:o(t[f])})}}}function I(e,t,r=!1){var n=[];return x(e,t,n,"",r),n}new WeakMap},6232:(e,t,r)=>{"use strict";r.d(t,{m:()=>a});const n={};function a(e){n[e]||(console.warn(e),n[e]=!0)}},6261:e=>{"use strict";const t=Number.MAX_SAFE_INTEGER||9007199254740991;e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},6279:(e,t,r)=>{"use strict";r.d(t,{C:()=>s});var n=r(5311),a=r(6993),i=r(9849);class s extends a.m{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),(0,i.Ns)([{type:"image_url",image_url:this.template}],this.templateFormat,e)}}_getPromptType(){return"prompt"}async partial(e){const t=this.inputVariables.filter(t=>!(t in e)),r={...this.partialVariables??{},...e},n={...this,inputVariables:t,partialVariables:r};return new s(n)}async format(e){const t={};for(const[r,n]of Object.entries(this.template))t[r]="string"==typeof n?n.replace(/{([^{}]*)}/g,(t,r)=>{const n=e[r];return"string"==typeof n||"number"==typeof n?String(n):t}):n;const r=e.url||t.url,n=e.detail||t.detail;if(!r)throw new Error("Must provide either an image URL.");if("string"!=typeof r)throw new Error("url must be a string.");const a={url:r};return n&&(a.detail=n),a}async formatPromptValue(e){const t=await this.format(e);return new n.vX(t)}}},6362:(e,t,r)=>{"use strict";r.d(t,{K0:()=>c,Sw:()=>u,ih:()=>h});var n=r(3490),a=r(5454),i=r(7765),s=r(7974),o=r(4301),l=r(8675);function c(e){if("string"==typeof e)return new a.x(e);if((0,n.ny)(e))return e;const[t,r]=e;if("human"===t||"user"===t)return new a.x({content:r});if("ai"===t||"assistant"===t)return new i.Od({content:r});if("system"===t)return new s.t({content:r});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function u(e,t="Human",r="AI"){const n=[];for(const a of e){let e;if("human"===a._getType())e=t;else if("ai"===a._getType())e=r;else if("system"===a._getType())e="System";else if("function"===a._getType())e="Function";else if("tool"===a._getType())e="Tool";else{if("generic"!==a._getType())throw new Error(`Got unsupported message type: ${a._getType()}`);e=a.role}const i=a.name?`${a.name}, `:"";n.push(`${e}: ${i}${a.content}`)}return n.join("\n")}function h(e){const t=e._getType();if("human"===t)return new a.a({...e});if("ai"===t)return new i.H({...e});if("system"===t)return new s.u({...e});if("function"===t)return new l.F({...e});if(o.c.isInstance(e))return new o.X({...e});throw new Error("Unknown message type.")}r(8009)},6409:(e,t,r)=>{"use strict";r.d(t,{wV:()=>P,q4:()=>S});var n=r(6768),a=r(3382),i=r(6446),s=r(9750);const o=new i.Hh({template:"Use the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.\n\n{context}\n\nQuestion: {question}\nHelpful Answer:",inputVariables:["context","question"]}),l=[i.BJ.fromTemplate("Use the following pieces of context to answer the users question. \nIf you don't know the answer, just say that you don't know, don't try to make up an answer.\n----------------\n{context}"),i.FS.fromTemplate("{question}")],c=i.RZ.fromMessages(l),u=new s.C_(o,[[s.UV,c]]),h=i.Hh.fromTemplate("Use the following portion of a long document to see if any of the text is relevant to answer the question. \nReturn any relevant text verbatim.\n{context}\nQuestion: {question}\nRelevant text, if any:"),d=[i.BJ.fromTemplate("Use the following portion of a long document to see if any of the text is relevant to answer the question. \nReturn any relevant text verbatim.\n----------------\n{context}"),i.FS.fromTemplate("{question}")],p=i.RZ.fromMessages(d),m=new s.C_(h,[[s.UV,p]]),f=i.Hh.fromTemplate("Given the following extracted parts of a long document and a question, create a final answer. \nIf you don't know the answer, just say that you don't know. Don't try to make up an answer.\n\nQUESTION: Which state/country's law governs the interpretation of the contract?\n=========\nContent: This Agreement is governed by English law and the parties submit to the exclusive jurisdiction of the English courts in  relation to any dispute (contractual or non-contractual) concerning this Agreement save that either party may apply to any court for an  injunction or other relief to protect its Intellectual Property Rights.\n\nContent: No Waiver. Failure or delay in exercising any right or remedy under this Agreement shall not constitute a waiver of such (or any other)  right or remedy.\n\n11.7 Severability. The invalidity, illegality or unenforceability of any term (or part of a term) of this Agreement shall not affect the continuation  in force of the remainder of the term (if any) and this Agreement.\n\n11.8 No Agency. Except as expressly stated otherwise, nothing in this Agreement shall create an agency, partnership or joint venture of any  kind between the parties.\n\n11.9 No Third-Party Beneficiaries.\n\nContent: (b) if Google believes, in good faith, that the Distributor has violated or caused Google to violate any Anti-Bribery Laws (as  defined in Clause 8.5) or that such a violation is reasonably likely to occur,\n=========\nFINAL ANSWER: This Agreement is governed by English law.\n\nQUESTION: What did the president say about Michael Jackson?\n=========\nContent: Madam Speaker, Madam Vice President, our First Lady and Second Gentleman. Members of Congress and the Cabinet. Justices of the Supreme Court. My fellow Americans.  \n\nLast year COVID-19 kept us apart. This year we are finally together again. \n\nTonight, we meet as Democrats Republicans and Independents. But most importantly as Americans. \n\nWith a duty to one another to the American people to the Constitution. \n\nAnd with an unwavering resolve that freedom will always triumph over tyranny. \n\nSix days ago, Russiaâ€™s Vladimir Putin sought to shake the foundations of the free world thinking he could make it bend to his menacing ways. But he badly miscalculated. \n\nHe thought he could roll into Ukraine and the world would roll over. Instead he met a wall of strength he never imagined. \n\nHe met the Ukrainian people. \n\nFrom President Zelenskyy to every Ukrainian, their fearlessness, their courage, their determination, inspires the world. \n\nGroups of citizens blocking tanks with their bodies. Everyone from students to retirees teachers turned soldiers defending their homeland.\n\nContent: And we wonâ€™t stop. \n\nWe have lost so much to COVID-19. Time with one another. And worst of all, so much loss of life. \n\nLetâ€™s use this moment to reset. Letâ€™s stop looking at COVID-19 as a partisan dividing line and see it for what it is: A God-awful disease.  \n\nLetâ€™s stop seeing each other as enemies, and start seeing each other for who we really are: Fellow Americans.  \n\nWe canâ€™t change how divided weâ€™ve been. But we can change how we move forwardâ€”on COVID-19 and other issues we must face together. \n\nI recently visited the New York City Police Department days after the funerals of Officer Wilbert Mora and his partner, Officer Jason Rivera. \n\nThey were responding to a 9-1-1 call when a man shot and killed them with a stolen gun. \n\nOfficer Mora was 27 years old. \n\nOfficer Rivera was 22. \n\nBoth Dominican Americans whoâ€™d grown up on the same streets they later chose to patrol as police officers. \n\nI spoke with their families and told them that we are forever in debt for their sacrifice, and we will carry on their mission to restore the trust and safety every community deserves.\n\nContent: And a proud Ukrainian people, who have known 30 years  of independence, have repeatedly shown that they will not tolerate anyone who tries to take their country backwards.  \n\nTo all Americans, I will be honest with you, as Iâ€™ve always promised. A Russian dictator, invading a foreign country, has costs around the world. \n\nAnd Iâ€™m taking robust action to make sure the pain of our sanctions  is targeted at Russiaâ€™s economy. And I will use every tool at our disposal to protect American businesses and consumers. \n\nTonight, I can announce that the United States has worked with 30 other countries to release 60 Million barrels of oil from reserves around the world.  \n\nAmerica will lead that effort, releasing 30 Million barrels from our own Strategic Petroleum Reserve. And we stand ready to do more if necessary, unified with our allies.  \n\nThese steps will help blunt gas prices here at home. And I know the news about whatâ€™s happening can seem alarming. \n\nBut I want you to know that we are going to be okay.\n\nContent: More support for patients and families. \n\nTo get there, I call on Congress to fund ARPA-H, the Advanced Research Projects Agency for Health. \n\nItâ€™s based on DARPAâ€”the Defense Department project that led to the Internet, GPS, and so much more.  \n\nARPA-H will have a singular purposeâ€”to drive breakthroughs in cancer, Alzheimerâ€™s, diabetes, and more. \n\nA unity agenda for the nation. \n\nWe can do this. \n\nMy fellow Americansâ€”tonight , we have gathered in a sacred spaceâ€”the citadel of our democracy. \n\nIn this Capitol, generation after generation, Americans have debated great questions amid great strife, and have done great things. \n\nWe have fought for freedom, expanded liberty, defeated totalitarianism and terror. \n\nAnd built the strongest, freest, and most prosperous nation the world has ever known. \n\nNow is the hour. \n\nOur moment of responsibility. \n\nOur test of resolve and conscience, of history itself. \n\nIt is in this moment that our character is formed. Our purpose is found. Our future is forged. \n\nWell I know this nation.\n=========\nFINAL ANSWER: The president did not mention Michael Jackson.\n\nQUESTION: {question}\n=========\n{summaries}\n=========\nFINAL ANSWER:"),g=[i.BJ.fromTemplate("Given the following extracted parts of a long document and a question, create a final answer. \nIf you don't know the answer, just say that you don't know. Don't try to make up an answer.\n----------------\n{summaries}"),i.FS.fromTemplate("{question}")],y=i.RZ.fromMessages(g),b=new s.C_(f,[[s.UV,y]]),w=new i.Hh({inputVariables:["question","existing_answer","context"],template:"The original question is as follows: {question}\nWe have provided an existing answer: {existing_answer}\nWe have the opportunity to refine the existing answer\n(only if needed) with some more context below.\n------------\n{context}\n------------\nGiven the new context, refine the original answer to better answer the question. \nIf the context isn't useful, return the original answer."}),_=[i.FS.fromTemplate("{question}"),i.sS.fromTemplate("{existing_answer}"),i.FS.fromTemplate("The original question is as follows: {question}\nWe have provided an existing answer: {existing_answer}\nWe have the opportunity to refine the existing answer\n(only if needed) with some more context below.\n------------\n{context}\n------------\nGiven the new context, refine the original answer to better answer the question. \nIf the context isn't useful, return the original answer.")],v=i.RZ.fromMessages(_),O=new s.C_(w,[[s.UV,v]]),A=new i.Hh({inputVariables:["context","question"],template:"Context information is below. \n---------------------\n{context}\n---------------------\nGiven the context information and no prior knowledge, answer the question: {question}"}),E=[i.BJ.fromTemplate("Context information is below. \n---------------------\n{context}\n---------------------\nGiven the context information and no prior knowledge, answer any questions"),i.FS.fromTemplate("{question}")],x=i.RZ.fromMessages(E),I=new s.C_(A,[[s.UV,x]]),P=(e,t={type:"stuff"})=>{const{type:r}=t;if("stuff"===r)return S(e,t);if("map_reduce"===r)return function(e,t={}){const{combineMapPrompt:r=m.getPrompt(e),combinePrompt:i=b.getPrompt(e),verbose:s,combineLLM:o,returnIntermediateSteps:l}=t,c=new n.LLMChain({prompt:r,llm:e,verbose:s}),u=new n.LLMChain({prompt:i,llm:o??e,verbose:s}),h=new a.StuffDocumentsChain({llmChain:u,documentVariableName:"summaries",verbose:s});return new a.MapReduceDocumentsChain({llmChain:c,combineDocumentChain:h,returnIntermediateSteps:l,verbose:s})}(e,t);if("refine"===r)return function(e,t={}){const{questionPrompt:r=I.getPrompt(e),refinePrompt:i=O.getPrompt(e),refineLLM:s,verbose:o}=t,l=new n.LLMChain({prompt:r,llm:e,verbose:o}),c=new n.LLMChain({prompt:i,llm:s??e,verbose:o});return new a.RefineDocumentsChain({llmChain:l,refineLLMChain:c,verbose:o})}(e,t);throw new Error(`Invalid _type: ${r}`)};function S(e,t={}){const{prompt:r=u.getPrompt(e),verbose:i}=t,s=new n.LLMChain({prompt:r,llm:e,verbose:i});return new a.StuffDocumentsChain({llmChain:s,verbose:i})}},6446:(e,t,r)=>{"use strict";r.d(t,{sS:()=>a.sS,m2:()=>n.m,RZ:()=>a.RZ,Jc:()=>i.FewShotPromptTemplate,FS:()=>a.FS,Hh:()=>s.PromptTemplate,BJ:()=>a.BJ});var n=r(6993),a=r(3766),i=r(2771);n.m;var s=r(3650);r(329),r(9849),r(6279),a.RZ},6588:e=>{"use strict";const t=Object.freeze({loose:!0}),r=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:r},6592:(e,t,r)=>{"use strict";const n=r(4899),a=r(6635),{ANY:i}=a,s=r(9558),o=r(995),l=r(2559),c=r(4056),u=r(6133),h=r(7372);e.exports=(e,t,r,d)=>{let p,m,f,g,y;switch(e=new n(e,d),t=new s(t,d),r){case">":p=l,m=u,f=c,g=">",y=">=";break;case"<":p=c,m=h,f=l,g="<",y="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,d))return!1;for(let r=0;r<t.set.length;++r){const n=t.set[r];let s=null,o=null;if(n.forEach(e=>{e.semver===i&&(e=new a(">=0.0.0")),s=s||e,o=o||e,p(e.semver,s.semver,d)?s=e:f(e.semver,o.semver,d)&&(o=e)}),s.operator===g||s.operator===y)return!1;if((!o.operator||o.operator===g)&&m(e,o.semver))return!1;if(o.operator===y&&f(e,o.semver))return!1}return!0}},6635:(e,t,r)=>{"use strict";const n=Symbol("SemVer ANY");class a{static get ANY(){return n}constructor(e,t){if(t=i(t),e instanceof a){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),c("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===n?this.value="":this.value=this.operator+this.semver.version,c("comp",this)}parse(e){const t=this.options.loose?s[o.COMPARATORLOOSE]:s[o.COMPARATOR],r=e.match(t);if(!r)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==r[1]?r[1]:"","="===this.operator&&(this.operator=""),r[2]?this.semver=new u(r[2],this.options.loose):this.semver=n}toString(){return this.value}test(e){if(c("Comparator.test",e,this.options.loose),this.semver===n||e===n)return!0;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}return l(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new h(e.value,t).test(this.value):""===e.operator?""===e.value||new h(this.value,t).test(e.semver):!((t=i(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))||(!this.operator.startsWith(">")||!e.operator.startsWith(">"))&&(!this.operator.startsWith("<")||!e.operator.startsWith("<"))&&(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))&&!(l(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))&&!(l(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}}e.exports=a;const i=r(6588),{safeRe:s,t:o}=r(487),l=r(1534),c=r(6735),u=r(4899),h=r(9558)},6641:(e,t,r)=>{"use strict";const n=r(4617);class a extends Error{constructor(e){super(e),this.name="TimeoutError"}}const i=(e,t,r)=>new Promise((i,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void i(e);const o=setTimeout(()=>{if("function"==typeof r){try{i(r())}catch(e){s(e)}return}const n=r instanceof Error?r:new a("string"==typeof r?r:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(n)},t);n(e.then(i,s),()=>{clearTimeout(o)})});e.exports=i,e.exports.default=i,e.exports.TimeoutError=a},6675:(e,t,r)=>{"use strict";const n=r(8136);e.exports=(e,t)=>e.sort((e,r)=>n(r,e,t))},6735:e=>{"use strict";const t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};e.exports=t},6768:(e,t,r)=>{"use strict";r.d(t,{LLMChain:()=>u});var n=r(2778),a=r(6446),i=r(8687),s=r(9834),o=r(8557);class l extends o.mJ{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","default"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"NoOpOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}}function c(e){if(function(e){return"function"==typeof e._llmType}(e))return e;if("bound"in e&&i.YN.isRunnable(e.bound))return c(e.bound);if("runnable"in e&&"fallbacks"in e&&i.YN.isRunnable(e.runnable))return c(e.runnable);if("default"in e&&i.YN.isRunnable(e.default))return c(e.default);throw new Error("Unable to extract BaseLanguageModel from llmLike object.")}class u extends s.r{static lc_name(){return"LLMChain"}get inputKeys(){return this.prompt.inputVariables}get outputKeys(){return[this.outputKey]}constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llm",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"llmKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"text"}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,this.llm=e.llm,this.llmKwargs=e.llmKwargs,this.outputKey=e.outputKey??this.outputKey,this.outputParser=e.outputParser??new l,this.prompt.outputParser){if(e.outputParser)throw new Error("Cannot set both outputParser and prompt.outputParser");this.outputParser=this.prompt.outputParser}}getCallKeys(){return"callKeys"in this.llm?this.llm.callKeys:[]}_selectMemoryInputs(e){const t=super._selectMemoryInputs(e),r=this.getCallKeys();for(const n of r)n in e&&delete t[n];return t}async _getFinalOutput(e,t,r){let n;return n=this.outputParser?await this.outputParser.parseResultWithPrompt(e,t,r?.getChild()):e[0].text,n}call(e,t){return super.call(e,t)}async _call(e,t){const r={...e},n={...this.llmKwargs},a=this.getCallKeys();for(const t of a)t in e&&n&&(n[t]=e[t],delete r[t]);const i=await this.prompt.formatPromptValue(r);if("generatePrompt"in this.llm){const{generations:e}=await this.llm.generatePrompt([i],n,t?.getChild());return{[this.outputKey]:await this._getFinalOutput(e[0],i,t)}}const s=this.outputParser?this.llm.pipe(this.outputParser):this.llm,o=await s.invoke(i,t?.getChild());return{[this.outputKey]:o}}async predict(e,t){return(await this.call(e,t))[this.outputKey]}_chainType(){return"llm"}static async deserialize(e){const{llm:t,prompt:r}=e;if(!t)throw new Error("LLMChain must have llm");if(!r)throw new Error("LLMChain must have prompt");return new u({llm:await n.j_.deserialize(t),prompt:await a.m2.deserialize(r)})}serialize(){const e="serialize"in this.llm?this.llm.serialize():void 0;return{_type:`${this._chainType()}_chain`,llm:e,prompt:this.prompt.serialize()}}_getNumTokens(e){return c(this.llm).getNumTokens(e)}}},6792:(e,t,r)=>{"use strict";r.d(t,{CC:()=>s,mJ:()=>i,vd:()=>a});var n=r(4896);class a extends n.YN{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig(async(e,t)=>this.parseResult([{text:e}],t?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks),e,{...t,runType:"parser"})}}class i extends a{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class s extends Error{constructor(e,t,r,n=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=n,n&&(void 0===r||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}},6856:(e,t,r)=>{"use strict";const n=r(8136);e.exports=(e,t)=>e.sort((e,r)=>n(e,r,t))},6928:(e,t,r)=>{"use strict";r.d(t,{Kj:()=>n.Kj,Ls:()=>i,gk:()=>a.gk});var n=r(9056),a=r(3246);r(747);const i="0.1.68"},6945:(e,t,r)=>{"use strict";const n=r(4899),a=r(7737),{safeRe:i,t:s}=r(487);e.exports=(e,t)=>{if(e instanceof n)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let r=null;if((t=t||{}).rtl){const n=t.includePrerelease?i[s.COERCERTLFULL]:i[s.COERCERTL];let a;for(;(a=n.exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&a.index+a[0].length===r.index+r[0].length||(r=a),n.lastIndex=a.index+a[1].length+a[2].length;n.lastIndex=-1}else r=e.match(t.includePrerelease?i[s.COERCEFULL]:i[s.COERCE]);if(null===r)return null;const o=r[2],l=r[3]||"0",c=r[4]||"0",u=t.includePrerelease&&r[5]?`-${r[5]}`:"",h=t.includePrerelease&&r[6]?`+${r[6]}`:"";return a(`${o}.${l}.${c}${u}${h}`,t)}},6993:(e,t,r)=>{"use strict";r.d(t,{m:()=>a});var n=r(6093);class a extends n.YN{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[e,n]of Object.entries(t))r[e]="string"==typeof n?n:await n();return{...r,...e}}async invoke(e,t){return this._callWithConfig(e=>this.formatPromptValue(e),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await Promise.resolve().then(r.bind(r,3650));return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await Promise.resolve().then(r.bind(r,3650));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await Promise.resolve().then(r.bind(r,2771));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}},7119:(e,t,r)=>{"use strict";const n=r(7737);e.exports=(e,t)=>{const r=n(e,null,!0),a=n(t,null,!0),i=r.compare(a);if(0===i)return null;const s=i>0,o=s?r:a,l=s?a:r,c=!!o.prerelease.length;if(l.prerelease.length&&!c){if(!l.patch&&!l.minor)return"major";if(0===l.compareMain(o))return l.minor&&!l.patch?"minor":"patch"}const u=c?"pre":"";return r.major!==a.major?u+"major":r.minor!==a.minor?u+"minor":r.patch!==a.patch?u+"patch":"prerelease"}},7280:(e,t,r)=>{"use strict";const n=r(487),a=r(6261),i=r(4899),s=r(204),o=r(7737),l=r(4004),c=r(9855),u=r(4106),h=r(7119),d=r(3767),p=r(547),m=r(9196),f=r(3690),g=r(4621),y=r(2469),b=r(3042),w=r(8136),_=r(6856),v=r(6675),O=r(2559),A=r(4056),E=r(818),x=r(9606),I=r(7372),P=r(6133),S=r(1534),k=r(6945),T=r(6635),C=r(9558),j=r(995),N=r(534),R=r(5985),$=r(9499),L=r(3602),M=r(2153),D=r(6592),U=r(4076),z=r(4453),F=r(753),B=r(1620),H=r(9881);e.exports={parse:o,valid:l,clean:c,inc:u,diff:h,major:d,minor:p,patch:m,prerelease:f,compare:g,rcompare:y,compareLoose:b,compareBuild:w,sort:_,rsort:v,gt:O,lt:A,eq:E,neq:x,gte:I,lte:P,cmp:S,coerce:k,Comparator:T,Range:C,satisfies:j,toComparators:N,maxSatisfying:R,minSatisfying:$,minVersion:L,validRange:M,outside:D,gtr:U,ltr:z,intersects:F,simplifyRange:B,subset:H,SemVer:i,re:n.re,src:n.src,tokens:n.t,SEMVER_SPEC_VERSION:a.SEMVER_SPEC_VERSION,RELEASE_TYPES:a.RELEASE_TYPES,compareIdentifiers:s.compareIdentifiers,rcompareIdentifiers:s.rcompareIdentifiers}},7372:(e,t,r)=>{"use strict";const n=r(4621);e.exports=(e,t,r)=>n(e,t,r)>=0},7526:(e,t)=>{"use strict";t.byteLength=function(e){var t=o(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,i=o(e),s=i[0],l=i[1],c=new a(function(e,t,r){return 3*(t+r)/4-r}(0,s,l)),u=0,h=l>0?s-4:s;for(r=0;r<h;r+=4)t=n[e.charCodeAt(r)]<<18|n[e.charCodeAt(r+1)]<<12|n[e.charCodeAt(r+2)]<<6|n[e.charCodeAt(r+3)],c[u++]=t>>16&255,c[u++]=t>>8&255,c[u++]=255&t;return 2===l&&(t=n[e.charCodeAt(r)]<<2|n[e.charCodeAt(r+1)]>>4,c[u++]=255&t),1===l&&(t=n[e.charCodeAt(r)]<<10|n[e.charCodeAt(r+1)]<<4|n[e.charCodeAt(r+2)]>>2,c[u++]=t>>8&255,c[u++]=255&t),c},t.fromByteArray=function(e){for(var t,n=e.length,a=n%3,i=[],s=16383,o=0,l=n-a;o<l;o+=s)i.push(c(e,o,o+s>l?l:o+s));return 1===a?(t=e[n-1],i.push(r[t>>2]+r[t<<4&63]+"==")):2===a&&(t=(e[n-2]<<8)+e[n-1],i.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),i.join("")};for(var r=[],n=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0;s<64;++s)r[s]=i[s],n[i.charCodeAt(s)]=s;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function l(e){return r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[63&e]}function c(e,t,r){for(var n,a=[],i=t;i<r;i+=3)n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),a.push(l(n));return a.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},7737:(e,t,r)=>{"use strict";const n=r(4899);e.exports=(e,t,r=!1)=>{if(e instanceof n)return e;try{return new n(e,t)}catch(e){if(!r)return null;throw e}}},7765:(e,t,r)=>{"use strict";r.d(t,{H:()=>l,KX:()=>o,Od:()=>s});var n=r(780),a=r(3490),i=r(8009);class s extends a.XQ{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if("string"==typeof e)r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;const t=r.additional_kwargs?.tool_calls,n=r.tool_calls;null!=t&&t.length>0&&(void 0===n||0===n.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===n){const[e,n]=(0,i.p1)(t);r.tool_calls=e??[],r.invalid_tool_calls=n??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch(e){r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),"string"!=typeof r&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls)}static lc_name(){return"AIMessage"}_getType(){return"ai"}}function o(e){return"ai"===e._getType()}class l extends a.gj{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else{const r=[],a=[];for(const t of e.tool_call_chunks){let e={};try{if(e=(0,n.d)(t.args??"{}")??{},"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");r.push({name:t.name??"",args:e,id:t.id})}catch(e){a.push({name:t.name,args:t.args,id:t.id,error:"Malformed args."})}}t={...e,tool_calls:r,invalid_tool_calls:a}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.tool_call_chunks=t?.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t?.tool_calls??this.tool_calls,this.invalid_tool_calls=t?.invalid_tool_calls??this.invalid_tool_calls}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:(0,a._I)(this.content,e.content),additional_kwargs:(0,a.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,a.ns)(this.response_metadata,e.response_metadata),tool_call_chunks:[]};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const r=(0,a.Vt)(this.tool_call_chunks,e.tool_call_chunks);void 0!==r&&r.length>0&&(t.tool_call_chunks=r)}return new l(t)}}},7974:(e,t,r)=>{"use strict";r.d(t,{t:()=>a,u:()=>i});var n=r(3490);class a extends n.XQ{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class i extends n.gj{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new i({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata)})}}},8009:(e,t,r)=>{"use strict";r.d(t,{dr:()=>a,p1:()=>i});var n=r(3490);n.XQ;class a extends n.gj{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new a({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata),tool_call_id:this.tool_call_id})}}function i(e){const t=[],r=[];for(const n of e)if(n.function){const e=n.function.name;try{const r={name:e||"",args:JSON.parse(n.function.arguments)||{},id:n.id};t.push(r)}catch(t){r.push({name:e,args:n.function.arguments,id:n.id,error:"Malformed args."})}}return[t,r]}},8028:(e,t,r)=>{"use strict";r.d(t,{Cf:()=>i,SP:()=>n,mu:()=>a});const n="__run";class a{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new a({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class i extends a{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new i({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}},8136:(e,t,r)=>{"use strict";const n=r(4899);e.exports=(e,t,r)=>{const a=new n(e,r),i=new n(t,r);return a.compare(i)||a.compareBuild(i)}},8139:(e,t,r)=>{"use strict";r.d(t,{s:()=>l,N:()=>c});var n=r(7526),a=Object.defineProperty;function i(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let r=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;r.length>1;){let n=null;for(let a=0;a<r.length-1;a++){const i=e.slice(r[a].start,r[a+1].end),s=t.get(i.join(","));null!=s&&(null==n||s<n[0])&&(n=[s,a])}if(null==n)break;{const e=n[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}}return r}(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(e=>null!=e)}var s,o=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const r=e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{const[r,n,...a]=t.split(" "),i=Number.parseInt(n,10);return a.forEach((t,r)=>e[t]=i+r),e},{});for(const[e,t]of Object.entries(r)){const r=n.toByteArray(e);this.rankMap.set(r.join(","),t),this.textMap.set(t,r)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e),{})}encode(e,t=[],r="all"){const n=new RegExp(this.patStr,"ug"),a=o.specialTokenRegex(Object.keys(this.specialTokens)),s=[],l=new Set("all"===t?Object.keys(this.specialTokens):t),c=new Set("all"===r?Object.keys(this.specialTokens).filter(e=>!l.has(e)):r);if(c.size>0){const t=o.specialTokenRegex([...c]),r=e.match(t);if(null!=r)throw new Error(`The text contains a special token that is not allowed: ${r[0]}`)}let u=0;for(;;){let t=null,r=u;for(;a.lastIndex=r,t=a.exec(e),null!=t&&!l.has(t[0]);)r=t.index+1;const o=t?.index??e.length;for(const t of e.substring(u,o).matchAll(n)){const e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));null==r?s.push(...i(e,this.rankMap)):s.push(r)}if(null==t)break;let c=this.specialTokens[t[0]];s.push(c),u=t.index+t[0].length}return s}decode(e){const t=[];let r=0;for(let n=0;n<e.length;++n){const a=e[n],i=this.textMap.get(a)??this.inverseSpecialTokens[a];null!=i&&(t.push(i),r+=i.length)}const n=new Uint8Array(r);let a=0;for(const e of t)n.set(e,a),a+=e.length;return this.textDecoder.decode(n)}},l=o;function c(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}((e,t,r)=>{t in e?a(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r})(l,"symbol"!=typeof(s="specialTokenRegex")?s+"":s,e=>new RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"))},8201:(e,t,r)=>{"use strict";r.d(t,{Ik:()=>U});const n=Symbol("Let zodToJsonSchema decide on which parser to use"),a={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"};var i=r(8952);const s=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function o(e){if("openAi"!==e.target)return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?s(t,e.currentPath):t.join("/")}}function l(e,t,r,n){n?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function c(e,t,r,n,a){e[t]=r,l(e,t,n,a)}function u(e,t){return L(e.type._def,t)}function h(e,t,r){const n=r??t.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((r,n)=>h(e,t,r))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return d(e,t)}}const d=(e,t)=>{const r={type:"integer",format:"unix-time"};if("openApi3"===t.target)return r;for(const n of e.checks)switch(n.kind){case"min":c(r,"minimum",n.value,n.message,t);break;case"max":c(r,"maximum",n.value,n.message,t)}return r};let p;const m=/^[cC][^\s-]{8,}$/,f=/^[0-9a-z]+$/,g=/^[0-9A-HJKMNP-TV-Z]{26}$/,y=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,b=()=>(void 0===p&&(p=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),p),w=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,_=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,v=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,O=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,A=/^[a-zA-Z0-9_-]{21}$/,E=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function x(e,t){const r={type:"string"};if(e.checks)for(const n of e.checks)switch(n.kind){case"min":c(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,n.value):n.value,n.message,t);break;case"max":c(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":S(r,"email",n.message,t);break;case"format:idn-email":S(r,"idn-email",n.message,t);break;case"pattern:zod":k(r,y,n.message,t)}break;case"url":S(r,"uri",n.message,t);break;case"uuid":S(r,"uuid",n.message,t);break;case"regex":k(r,n.regex,n.message,t);break;case"cuid":k(r,m,n.message,t);break;case"cuid2":k(r,f,n.message,t);break;case"startsWith":k(r,RegExp(`^${I(n.value,t)}`),n.message,t);break;case"endsWith":k(r,RegExp(`${I(n.value,t)}$`),n.message,t);break;case"datetime":S(r,"date-time",n.message,t);break;case"date":S(r,"date",n.message,t);break;case"time":S(r,"time",n.message,t);break;case"duration":S(r,"duration",n.message,t);break;case"length":c(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,n.value):n.value,n.message,t),c(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"includes":k(r,RegExp(I(n.value,t)),n.message,t);break;case"ip":"v6"!==n.version&&S(r,"ipv4",n.message,t),"v4"!==n.version&&S(r,"ipv6",n.message,t);break;case"base64url":k(r,O,n.message,t);break;case"jwt":k(r,E,n.message,t);break;case"cidr":"v6"!==n.version&&k(r,w,n.message,t),"v4"!==n.version&&k(r,_,n.message,t);break;case"emoji":k(r,b(),n.message,t);break;case"ulid":k(r,g,n.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":S(r,"binary",n.message,t);break;case"contentEncoding:base64":c(r,"contentEncoding","base64",n.message,t);break;case"pattern:zod":k(r,v,n.message,t)}break;case"nanoid":k(r,A,n.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return r}function I(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)P.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}const P=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function S(e,t,r,n){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&n.errorMessages&&{errorMessage:{format:r}}})):c(e,"format",t,r,n)}function k(e,t,r,n){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:T(t,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):c(e,"pattern",T(t,n),r,n)}function T(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const r=e.flags.includes("i"),n=e.flags.includes("m"),a=e.flags.includes("s"),i=r?e.source.toLowerCase():e.source;let s="",o=!1,l=!1,c=!1;for(let e=0;e<i.length;e++)if(o)s+=i[e],o=!1;else{if(r)if(l){if(i[e].match(/[a-z]/)){c?(s+=i[e],s+=`${i[e-2]}-${i[e]}`.toUpperCase(),c=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(s+=i[e],c=!0):s+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){s+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(n){if("^"===i[e]){s+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){s+="($|(?=[\r\n]))";continue}}a&&"."===i[e]?s+=l?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(s+=i[e],"\\"===i[e]?o=!0:l&&"]"===i[e]?l=!1:l||"["!==i[e]||(l=!0))}try{new RegExp(s)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return s}function C(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===i.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,n)=>({...r,[n]:L(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",n]})??o(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};const r={type:"object",additionalProperties:L(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===i.kY.ZodString&&e.keyType._def.checks?.length){const{type:n,...a}=x(e.keyType._def,t);return{...r,propertyNames:a}}if(e.keyType?._def.typeName===i.kY.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===i.kY.ZodBranded&&e.keyType._def.type._def.typeName===i.kY.ZodString&&e.keyType._def.type._def.checks?.length){const{type:n,...a}=u(e.keyType._def,t);return{...r,propertyNames:a}}return r}const j={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},N=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>L(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function R(e){try{return e.isOptional()}catch{return!0}}const $=(e,t,r)=>{switch(t){case i.kY.ZodString:return x(e,r);case i.kY.ZodNumber:return function(e,t){const r={type:"number"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"int":r.type="integer",l(r,"type",n.message,t);break;case"min":"jsonSchema7"===t.target?n.inclusive?c(r,"minimum",n.value,n.message,t):c(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),c(r,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?c(r,"maximum",n.value,n.message,t):c(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),c(r,"maximum",n.value,n.message,t));break;case"multipleOf":c(r,"multipleOf",n.value,n.message,t)}return r}(e,r);case i.kY.ZodObject:return function(e,t){const r="openAi"===t.target,n={type:"object",properties:{}},a=[],i=e.shape();for(const e in i){let s=i[e];if(void 0===s||void 0===s._def)continue;let o=R(s);o&&r&&("ZodOptional"===s._def.typeName&&(s=s._def.innerType),s.isNullable()||(s=s.nullable()),o=!1);const l=L(s._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==l&&(n.properties[e]=l,o||a.push(e))}a.length&&(n.required=a);const s=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return L(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==s&&(n.additionalProperties=s),n}(e,r);case i.kY.ZodBigInt:return function(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"min":"jsonSchema7"===t.target?n.inclusive?c(r,"minimum",n.value,n.message,t):c(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),c(r,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?c(r,"maximum",n.value,n.message,t):c(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),c(r,"maximum",n.value,n.message,t));break;case"multipleOf":c(r,"multipleOf",n.value,n.message,t)}return r}(e,r);case i.kY.ZodBoolean:return{type:"boolean"};case i.kY.ZodDate:return h(e,r);case i.kY.ZodUndefined:return function(e){return{not:o(e)}}(r);case i.kY.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(r);case i.kY.ZodArray:return function(e,t){const r={type:"array"};return e.type?._def&&e.type?._def?.typeName!==i.kY.ZodAny&&(r.items=L(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&c(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&c(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(c(r,"minItems",e.exactLength.value,e.exactLength.message,t),c(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}(e,r);case i.kY.ZodUnion:case i.kY.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return N(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every(e=>e._def.typeName in j&&(!e._def.checks||!e._def.checks.length))){const e=r.reduce((e,t)=>{const r=j[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(r.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=r.reduce((e,t)=>{const r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===r.length){const t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:r.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(r.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:r.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return N(e,t)}(e,r);case i.kY.ZodIntersection:return function(e,t){const r=[L(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),L(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let n="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return r.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:r,...n}=e;t=n}else n=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(n=void 0);var t}),a.length?{allOf:a,...n}:void 0}(e,r);case i.kY.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,r)=>L(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:L(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,r)=>L(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,r);case i.kY.ZodRecord:return C(e,r);case i.kY.ZodLiteral:return function(e,t){const r=typeof e.value;return"bigint"!==r&&"number"!==r&&"boolean"!==r&&"string"!==r?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===r?"integer":r,enum:[e.value]}:{type:"bigint"===r?"integer":r,const:e.value}}(e,r);case i.kY.ZodEnum:return function(e){return{type:"string",enum:Array.from(e.values)}}(e);case i.kY.ZodNativeEnum:return function(e){const t=e.values,r=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),n=Array.from(new Set(r.map(e=>typeof e)));return{type:1===n.length?"string"===n[0]?"string":"number":["string","number"],enum:r}}(e);case i.kY.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:j[e.innerType._def.typeName],nullable:!0}:{type:[j[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const r=L(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const r=L(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}(e,r);case i.kY.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return L(e.innerType._def,t);const r=L(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:o(t)},r]}:o(t)})(e,r);case i.kY.ZodMap:return function(e,t){return"record"===t.mapStrategy?C(e,t):{type:"array",maxItems:125,items:{type:"array",items:[L(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||o(t),L(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||o(t)],minItems:2,maxItems:2}}}(e,r);case i.kY.ZodSet:return function(e,t){const r={type:"array",uniqueItems:!0,items:L(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&c(r,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&c(r,"maxItems",e.maxSize.value,e.maxSize.message,t),r}(e,r);case i.kY.ZodLazy:return()=>e.getter()._def;case i.kY.ZodPromise:return function(e,t){return L(e.type._def,t)}(e,r);case i.kY.ZodNaN:case i.kY.ZodNever:return function(e){return"openAi"===e.target?void 0:{not:o({...e,currentPath:[...e.currentPath,"not"]})}}(r);case i.kY.ZodEffects:return function(e,t){return"input"===t.effectStrategy?L(e.schema._def,t):o(t)}(e,r);case i.kY.ZodAny:return o(r);case i.kY.ZodUnknown:return function(e){return o(e)}(r);case i.kY.ZodDefault:return function(e,t){return{...L(e.innerType._def,t),default:e.defaultValue()}}(e,r);case i.kY.ZodBranded:return u(e,r);case i.kY.ZodReadonly:case i.kY.ZodCatch:return((e,t)=>L(e.innerType._def,t))(e,r);case i.kY.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return L(e.in._def,t);if("output"===t.pipeStrategy)return L(e.out._def,t);const r=L(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[r,L(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]})].filter(e=>void 0!==e)}})(e,r);case i.kY.ZodFunction:case i.kY.ZodVoid:case i.kY.ZodSymbol:default:return}};function L(e,t,r=!1){const a=t.seen.get(e);if(t.override){const i=t.override?.(e,t,a,r);if(i!==n)return i}if(a&&!r){const e=M(a,t);if(void 0!==e)return e}const i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);const s=$(e,e.typeName,t),o="function"==typeof s?L(s(),t):s;if(o&&D(e,t,o),t.postProcess){const r=t.postProcess(o,e,t);return i.jsonSchema=o,r}return i.jsonSchema=o,o}const M=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:s(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),o(t)):"seen"===t.$refStrategy?o(t):void 0}},D=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),U=(e,t)=>{const r=(e=>{const t=(e=>"string"==typeof e?{...a,name:e}:{...a,...e})(e),r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([e,r])=>[r._def,{def:r._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t);let n="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,n])=>({...e,[t]:L(n._def,{...r,currentPath:[...r.basePath,r.definitionPath,t]},!0)??o(r)}),{}):void 0;const i="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,s=L(e._def,void 0===i?r:{...r,currentPath:[...r.basePath,r.definitionPath,i]},!1)??o(r),l="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==l&&(s.title=l),r.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[r.openAiAnyTypeName]||(n[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===r.$refStrategy?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const c=void 0===i?n?{...s,[r.definitionPath]:n}:s:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,i].join("/"),[r.definitionPath]:{...n,[i]:s}};return"jsonSchema7"===r.target?c.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"!==r.target&&"openAi"!==r.target||(c.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===r.target&&("anyOf"in c||"oneOf"in c||"allOf"in c||"type"in c&&Array.isArray(c.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),c}},8303:(e,t,r)=>{var n=r(3961);t.operation=function(e){var r=t.timeouts(e);return new n(r,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],a=0;a<t.retries;a++)n.push(this.createTimeout(a,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(a,t)),n.sort(function(e,t){return e-t}),n},t.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,n=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(n,t.maxTimeout)},t.wrap=function(e,r,n){if(r instanceof Array&&(n=r,r=null),!n)for(var a in n=[],e)"function"==typeof e[a]&&n.push(a);for(var i=0;i<n.length;i++){var s=n[i],o=e[s];e[s]=function(n){var a=t.operation(r),i=Array.prototype.slice.call(arguments,1),s=i.pop();i.push(function(e){a.retry(e)||(e&&(arguments[0]=a.mainError()),s.apply(this,arguments))}),a.attempt(function(){n.apply(e,i)})}.bind(e,o),e[s].options=r}}},8521:(e,t,r)=>{"use strict";r.d(t,{N:()=>a});class n{getStore(){}run(e,t){return t()}}const a=new class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new n}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}}},8557:(e,t,r)=>{"use strict";r.d(t,{T2:()=>a.T,vd:()=>n.vd,mJ:()=>n.mJ,hU:()=>l.hU,CC:()=>n.CC,_6:()=>o,d1:()=>l.d1});var n=r(6792),a=r(305);a.k,a.k,a.k;var i=r(8952),s=r(8201);class o extends n.mJ{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(i.Ik(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,i.Yj().describe(t)]))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify((0,s.Ik)(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(e,t)=>`"${t.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new n.CC(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}n.mJ;var l=r(3263);r(9641),a.T},8575:(e,t,r)=>{"use strict";r.d(t,{FK:()=>s.F,H:()=>n.H,K0:()=>c.K0,KX:()=>n.KX,Od:()=>n.Od,Sw:()=>c.Sw,XQ:()=>a.XQ,XU:()=>i.X,a7:()=>o.a,cM:()=>i.c,dr:()=>u.dr,ny:()=>a.ny,tn:()=>l.t,uU:()=>l.u,xc:()=>o.x});var n=r(7765),a=r(3490),i=r(4301),s=r(8675),o=r(5454),l=r(7974),c=r(6362),u=r(8009)},8675:(e,t,r)=>{"use strict";r.d(t,{F:()=>a});var n=r(3490);n.XQ;class a extends n.gj{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new a({content:(0,n._I)(this.content,e.content),additional_kwargs:(0,n.ns)(this.additional_kwargs,e.additional_kwargs),response_metadata:(0,n.ns)(this.response_metadata,e.response_metadata),name:this.name??""})}}},8687:(e,t,r)=>{"use strict";r.d(t,{YN:()=>n.YN,ZI:()=>n.ZI,kI:()=>n.kI,zZ:()=>n.zZ});var n=r(4896)},8952:(e,t,r)=>{"use strict";var n,a;r.d(t,{kY:()=>Ce,ND:()=>J,bz:()=>Ne,Ik:()=>Re,Yj:()=>je}),function(e){e.assertEqual=e=>{},e.assertIs=function(e){},e.assertNever=function(_x){throw new Error},e.arrayToEnum=e=>{const t={};for(const r of e)t[r]=r;return t},e.getValidEnumValues=t=>{const r=e.objectKeys(t).filter(e=>"number"!=typeof t[t[e]]),n={};for(const e of r)n[e]=t[e];return e.objectValues(n)},e.objectValues=t=>e.objectKeys(t).map(function(e){return t[e]}),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},e.find=(e,t)=>{for(const r of e)if(t(r))return r},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(n||(n={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(a||(a={}));const i=n.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),s=e=>{switch(typeof e){case"undefined":return i.undefined;case"string":return i.string;case"number":return Number.isNaN(e)?i.nan:i.number;case"boolean":return i.boolean;case"function":return i.function;case"bigint":return i.bigint;case"symbol":return i.symbol;case"object":return Array.isArray(e)?i.array:null===e?i.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?i.promise:"undefined"!=typeof Map&&e instanceof Map?i.map:"undefined"!=typeof Set&&e instanceof Set?i.set:"undefined"!=typeof Date&&e instanceof Date?i.date:i.object;default:return i.unknown}},o=n.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class l extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},r={_errors:[]},n=e=>{for(const a of e.issues)if("invalid_union"===a.code)a.unionErrors.map(n);else if("invalid_return_type"===a.code)n(a.returnTypeError);else if("invalid_arguments"===a.code)n(a.argumentsError);else if(0===a.path.length)r._errors.push(t(a));else{let e=r,n=0;for(;n<a.path.length;){const r=a.path[n];n===a.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(a))):e[r]=e[r]||{_errors:[]},e=e[r],n++}}};return n(this),r}static assert(e){if(!(e instanceof l))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,n.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},r=[];for(const n of this.issues)if(n.path.length>0){const r=n.path[0];t[r]=t[r]||[],t[r].push(e(n))}else r.push(e(n));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}l.create=e=>new l(e);const c=(e,t)=>{let r;switch(e.code){case o.invalid_type:r=e.received===i.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case o.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,n.jsonStringifyReplacer)}`;break;case o.unrecognized_keys:r=`Unrecognized key(s) in object: ${n.joinValues(e.keys,", ")}`;break;case o.invalid_union:r="Invalid input";break;case o.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${n.joinValues(e.options)}`;break;case o.invalid_enum_value:r=`Invalid enum value. Expected ${n.joinValues(e.options)}, received '${e.received}'`;break;case o.invalid_arguments:r="Invalid function arguments";break;case o.invalid_return_type:r="Invalid function return type";break;case o.invalid_date:r="Invalid date";break;case o.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:n.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case o.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type||"bigint"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case o.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case o.custom:r="Invalid input";break;case o.invalid_intersection_types:r="Intersection results could not be merged";break;case o.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case o.not_finite:r="Number must be finite";break;default:r=t.defaultError,n.assertNever(e)}return{message:r}};let u=c;var h;!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(h||(h={}));function d(e,t){const r=u,n=(e=>{const{data:t,path:r,errorMaps:n,issueData:a}=e,i=[...r,...a.path||[]],s={...a,path:i};if(void 0!==a.message)return{...a,path:i,message:a.message};let o="";const l=n.filter(e=>!!e).slice().reverse();for(const e of l)o=e(s,{data:t,defaultError:o}).message;return{...a,path:i,message:o}})({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===c?void 0:c].filter(e=>!!e)});e.common.issues.push(n)}class p{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const n of t){if("aborted"===n.status)return m;"dirty"===n.status&&e.dirty(),r.push(n.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const e of t){const t=await e.key,n=await e.value;r.push({key:t,value:n})}return p.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const n of t){const{key:t,value:a}=n;if("aborted"===t.status)return m;if("aborted"===a.status)return m;"dirty"===t.status&&e.dirty(),"dirty"===a.status&&e.dirty(),"__proto__"===t.value||void 0===a.value&&!n.alwaysSet||(r[t.value]=a.value)}return{status:e.value,value:r}}}const m=Object.freeze({status:"aborted"}),f=e=>({status:"dirty",value:e}),g=e=>({status:"valid",value:e}),y=e=>"aborted"===e.status,b=e=>"dirty"===e.status,w=e=>"valid"===e.status,_=e=>"undefined"!=typeof Promise&&e instanceof Promise;class v{constructor(e,t,r,n){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=n}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const O=(e,t)=>{if(w(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new l(e.common.issues);return this._error=t,this._error}}};function A(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:n,description:a}=e;if(t&&(r||n))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:a}:{errorMap:(t,a)=>{const{message:i}=e;return"invalid_enum_value"===t.code?{message:i??a.defaultError}:void 0===a.data?{message:i??n??a.defaultError}:"invalid_type"!==t.code?{message:a.defaultError}:{message:i??r??a.defaultError}},description:a}}class E{get description(){return this._def.description}_getType(e){return s(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:s(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new p,ctx:{common:e.parent.common,data:e.data,parsedType:s(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(_(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){const r={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:s(e)},n=this._parseSync({data:e,path:r.path,parent:r});return O(r,n)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:s(e)};if(!this["~standard"].async)try{const r=this._parseSync({data:e,path:[],parent:t});return w(r)?{value:r.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>w(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:s(e)},n=this._parse({data:e,path:r.path,parent:r}),a=await(_(n)?n:Promise.resolve(n));return O(r,a)}refine(e,t){const r=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,n)=>{const a=e(t),i=()=>n.addIssue({code:o.custom,...r(t)});return"undefined"!=typeof Promise&&a instanceof Promise?a.then(e=>!!e||(i(),!1)):!!a||(i(),!1)})}refinement(e,t){return this._refinement((r,n)=>!!e(r)||(n.addIssue("function"==typeof t?t(r,n):t),!1))}_refinement(e){return new Oe({schema:this,typeName:Ce.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return Ae.create(this,this._def)}nullable(){return Ee.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return oe.create(this)}promise(){return ve.create(this,this._def)}or(e){return ue.create([this,e],this._def)}and(e){return de.create(this,e,this._def)}transform(e){return new Oe({...A(this._def),schema:this,typeName:Ce.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new xe({...A(this._def),innerType:this,defaultValue:t,typeName:Ce.ZodDefault})}brand(){return new Se({typeName:Ce.ZodBranded,type:this,...A(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new Ie({...A(this._def),innerType:this,catchValue:t,typeName:Ce.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return ke.create(this,e)}readonly(){return Te.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const x=/^c[^\s-]{8,}$/i,I=/^[0-9a-z]+$/,P=/^[0-9A-HJKMNP-TV-Z]{26}$/i,S=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,k=/^[a-z0-9_-]{21}$/i,T=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,C=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,j=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let N;const R=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,$=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,L=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,M=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,D=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,U=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,z="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",F=new RegExp(`^${z}$`);function B(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function H(e){return new RegExp(`^${B(e)}$`)}function V(e){let t=`${z}T${B(e)}`;const r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,new RegExp(`^${t}$`)}function q(e,t){return!("v4"!==t&&t||!R.test(e))||!("v6"!==t&&t||!L.test(e))}function Z(e,t){if(!T.test(e))return!1;try{const[r]=e.split(".");if(!r)return!1;const n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),a=JSON.parse(atob(n));return!("object"!=typeof a||null===a||"typ"in a&&"JWT"!==a?.typ||!a.alg||t&&a.alg!==t)}catch{return!1}}function K(e,t){return!("v4"!==t&&t||!$.test(e))||!("v6"!==t&&t||!M.test(e))}class J extends E{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==i.string){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.string,received:t.parsedType}),m}const t=new p;let r;for(const a of this._def.checks)if("min"===a.kind)e.data.length<a.value&&(r=this._getOrReturnCtx(e,r),d(r,{code:o.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),t.dirty());else if("max"===a.kind)e.data.length>a.value&&(r=this._getOrReturnCtx(e,r),d(r,{code:o.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),t.dirty());else if("length"===a.kind){const n=e.data.length>a.value,i=e.data.length<a.value;(n||i)&&(r=this._getOrReturnCtx(e,r),n?d(r,{code:o.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):i&&d(r,{code:o.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),t.dirty())}else if("email"===a.kind)j.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"email",code:o.invalid_string,message:a.message}),t.dirty());else if("emoji"===a.kind)N||(N=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),N.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"emoji",code:o.invalid_string,message:a.message}),t.dirty());else if("uuid"===a.kind)S.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"uuid",code:o.invalid_string,message:a.message}),t.dirty());else if("nanoid"===a.kind)k.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"nanoid",code:o.invalid_string,message:a.message}),t.dirty());else if("cuid"===a.kind)x.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"cuid",code:o.invalid_string,message:a.message}),t.dirty());else if("cuid2"===a.kind)I.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"cuid2",code:o.invalid_string,message:a.message}),t.dirty());else if("ulid"===a.kind)P.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"ulid",code:o.invalid_string,message:a.message}),t.dirty());else if("url"===a.kind)try{new URL(e.data)}catch{r=this._getOrReturnCtx(e,r),d(r,{validation:"url",code:o.invalid_string,message:a.message}),t.dirty()}else"regex"===a.kind?(a.regex.lastIndex=0,a.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"regex",code:o.invalid_string,message:a.message}),t.dirty())):"trim"===a.kind?e.data=e.data.trim():"includes"===a.kind?e.data.includes(a.value,a.position)||(r=this._getOrReturnCtx(e,r),d(r,{code:o.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),t.dirty()):"toLowerCase"===a.kind?e.data=e.data.toLowerCase():"toUpperCase"===a.kind?e.data=e.data.toUpperCase():"startsWith"===a.kind?e.data.startsWith(a.value)||(r=this._getOrReturnCtx(e,r),d(r,{code:o.invalid_string,validation:{startsWith:a.value},message:a.message}),t.dirty()):"endsWith"===a.kind?e.data.endsWith(a.value)||(r=this._getOrReturnCtx(e,r),d(r,{code:o.invalid_string,validation:{endsWith:a.value},message:a.message}),t.dirty()):"datetime"===a.kind?V(a).test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{code:o.invalid_string,validation:"datetime",message:a.message}),t.dirty()):"date"===a.kind?F.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{code:o.invalid_string,validation:"date",message:a.message}),t.dirty()):"time"===a.kind?H(a).test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{code:o.invalid_string,validation:"time",message:a.message}),t.dirty()):"duration"===a.kind?C.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"duration",code:o.invalid_string,message:a.message}),t.dirty()):"ip"===a.kind?q(e.data,a.version)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"ip",code:o.invalid_string,message:a.message}),t.dirty()):"jwt"===a.kind?Z(e.data,a.alg)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"jwt",code:o.invalid_string,message:a.message}),t.dirty()):"cidr"===a.kind?K(e.data,a.version)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"cidr",code:o.invalid_string,message:a.message}),t.dirty()):"base64"===a.kind?D.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"base64",code:o.invalid_string,message:a.message}),t.dirty()):"base64url"===a.kind?U.test(e.data)||(r=this._getOrReturnCtx(e,r),d(r,{validation:"base64url",code:o.invalid_string,message:a.message}),t.dirty()):n.assertNever(a);return{status:t.value,value:e.data}}_regex(e,t,r){return this.refinement(t=>e.test(t),{validation:t,code:o.invalid_string,...h.errToObj(r)})}_addCheck(e){return new J({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...h.errToObj(e)})}url(e){return this._addCheck({kind:"url",...h.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...h.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...h.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...h.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...h.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...h.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...h.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...h.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...h.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...h.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...h.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...h.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...h.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...h.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...h.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...h.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...h.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...h.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...h.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...h.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...h.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...h.errToObj(t)})}nonempty(e){return this.min(1,h.errToObj(e))}trim(){return new J({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new J({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new J({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function W(e,t){const r=(e.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,a=r>n?r:n;return Number.parseInt(e.toFixed(a).replace(".",""))%Number.parseInt(t.toFixed(a).replace(".",""))/10**a}J.create=e=>new J({checks:[],typeName:Ce.ZodString,coerce:e?.coerce??!1,...A(e)});class G extends E{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==i.number){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.number,received:t.parsedType}),m}let t;const r=new p;for(const a of this._def.checks)"int"===a.kind?n.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),d(t,{code:o.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(t=this._getOrReturnCtx(e,t),d(t,{code:o.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(t=this._getOrReturnCtx(e,t),d(t,{code:o.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"multipleOf"===a.kind?0!==W(e.data,a.value)&&(t=this._getOrReturnCtx(e,t),d(t,{code:o.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):"finite"===a.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),d(t,{code:o.not_finite,message:a.message}),r.dirty()):n.assertNever(a);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,h.toString(t))}gt(e,t){return this.setLimit("min",e,!1,h.toString(t))}lte(e,t){return this.setLimit("max",e,!0,h.toString(t))}lt(e,t){return this.setLimit("max",e,!1,h.toString(t))}setLimit(e,t,r,n){return new G({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:h.toString(n)}]})}_addCheck(e){return new G({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:h.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:h.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:h.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:h.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:h.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:h.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:h.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:h.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:h.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&n.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}G.create=e=>new G({checks:[],typeName:Ce.ZodNumber,coerce:e?.coerce||!1,...A(e)});class Y extends E{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==i.bigint)return this._getInvalidInput(e);let t;const r=new p;for(const a of this._def.checks)"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(t=this._getOrReturnCtx(e,t),d(t,{code:o.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(t=this._getOrReturnCtx(e,t),d(t,{code:o.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),r.dirty()):"multipleOf"===a.kind?e.data%a.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),d(t,{code:o.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):n.assertNever(a);return{status:r.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.bigint,received:t.parsedType}),m}gte(e,t){return this.setLimit("min",e,!0,h.toString(t))}gt(e,t){return this.setLimit("min",e,!1,h.toString(t))}lte(e,t){return this.setLimit("max",e,!0,h.toString(t))}lt(e,t){return this.setLimit("max",e,!1,h.toString(t))}setLimit(e,t,r,n){return new Y({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:h.toString(n)}]})}_addCheck(e){return new Y({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:h.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:h.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:h.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:h.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:h.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}Y.create=e=>new Y({checks:[],typeName:Ce.ZodBigInt,coerce:e?.coerce??!1,...A(e)});class X extends E{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==i.boolean){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.boolean,received:t.parsedType}),m}return g(e.data)}}X.create=e=>new X({typeName:Ce.ZodBoolean,coerce:e?.coerce||!1,...A(e)});class Q extends E{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==i.date){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.date,received:t.parsedType}),m}if(Number.isNaN(e.data.getTime()))return d(this._getOrReturnCtx(e),{code:o.invalid_date}),m;const t=new p;let r;for(const a of this._def.checks)"min"===a.kind?e.data.getTime()<a.value&&(r=this._getOrReturnCtx(e,r),d(r,{code:o.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),t.dirty()):"max"===a.kind?e.data.getTime()>a.value&&(r=this._getOrReturnCtx(e,r),d(r,{code:o.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),t.dirty()):n.assertNever(a);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Q({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:h.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:h.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Q.create=e=>new Q({checks:[],coerce:e?.coerce||!1,typeName:Ce.ZodDate,...A(e)});class ee extends E{_parse(e){if(this._getType(e)!==i.symbol){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.symbol,received:t.parsedType}),m}return g(e.data)}}ee.create=e=>new ee({typeName:Ce.ZodSymbol,...A(e)});class te extends E{_parse(e){if(this._getType(e)!==i.undefined){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.undefined,received:t.parsedType}),m}return g(e.data)}}te.create=e=>new te({typeName:Ce.ZodUndefined,...A(e)});class re extends E{_parse(e){if(this._getType(e)!==i.null){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.null,received:t.parsedType}),m}return g(e.data)}}re.create=e=>new re({typeName:Ce.ZodNull,...A(e)});class ne extends E{constructor(){super(...arguments),this._any=!0}_parse(e){return g(e.data)}}ne.create=e=>new ne({typeName:Ce.ZodAny,...A(e)});class ae extends E{constructor(){super(...arguments),this._unknown=!0}_parse(e){return g(e.data)}}ae.create=e=>new ae({typeName:Ce.ZodUnknown,...A(e)});class ie extends E{_parse(e){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.never,received:t.parsedType}),m}}ie.create=e=>new ie({typeName:Ce.ZodNever,...A(e)});class se extends E{_parse(e){if(this._getType(e)!==i.undefined){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.void,received:t.parsedType}),m}return g(e.data)}}se.create=e=>new se({typeName:Ce.ZodVoid,...A(e)});class oe extends E{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),n=this._def;if(t.parsedType!==i.array)return d(t,{code:o.invalid_type,expected:i.array,received:t.parsedType}),m;if(null!==n.exactLength){const e=t.data.length>n.exactLength.value,a=t.data.length<n.exactLength.value;(e||a)&&(d(t,{code:e?o.too_big:o.too_small,minimum:a?n.exactLength.value:void 0,maximum:e?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),r.dirty())}if(null!==n.minLength&&t.data.length<n.minLength.value&&(d(t,{code:o.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),r.dirty()),null!==n.maxLength&&t.data.length>n.maxLength.value&&(d(t,{code:o.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((e,r)=>n.type._parseAsync(new v(t,e,t.path,r)))).then(e=>p.mergeArray(r,e));const a=[...t.data].map((e,r)=>n.type._parseSync(new v(t,e,t.path,r)));return p.mergeArray(r,a)}get element(){return this._def.type}min(e,t){return new oe({...this._def,minLength:{value:e,message:h.toString(t)}})}max(e,t){return new oe({...this._def,maxLength:{value:e,message:h.toString(t)}})}length(e,t){return new oe({...this._def,exactLength:{value:e,message:h.toString(t)}})}nonempty(e){return this.min(1,e)}}function le(e){if(e instanceof ce){const t={};for(const r in e.shape){const n=e.shape[r];t[r]=Ae.create(le(n))}return new ce({...e._def,shape:()=>t})}return e instanceof oe?new oe({...e._def,type:le(e.element)}):e instanceof Ae?Ae.create(le(e.unwrap())):e instanceof Ee?Ee.create(le(e.unwrap())):e instanceof pe?pe.create(e.items.map(e=>le(e))):e}oe.create=(e,t)=>new oe({type:e,minLength:null,maxLength:null,exactLength:null,typeName:Ce.ZodArray,...A(t)});class ce extends E{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=n.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==i.object){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.object,received:t.parsedType}),m}const{status:t,ctx:r}=this._processInputParams(e),{shape:n,keys:a}=this._getCached(),s=[];if(!(this._def.catchall instanceof ie&&"strip"===this._def.unknownKeys))for(const e in r.data)a.includes(e)||s.push(e);const l=[];for(const e of a){const t=n[e],a=r.data[e];l.push({key:{status:"valid",value:e},value:t._parse(new v(r,a,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof ie){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of s)l.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)s.length>0&&(d(r,{code:o.unrecognized_keys,keys:s}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of s){const n=r.data[t];l.push({key:{status:"valid",value:t},value:e._parse(new v(r,n,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of l){const r=await t.key,n=await t.value;e.push({key:r,value:n,alwaysSet:t.alwaysSet})}return e}).then(e=>p.mergeObjectSync(t,e)):p.mergeObjectSync(t,l)}get shape(){return this._def.shape()}strict(e){return h.errToObj,new ce({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{const n=this._def.errorMap?.(t,r).message??r.defaultError;return"unrecognized_keys"===t.code?{message:h.errToObj(e).message??n}:{message:n}}}:{}})}strip(){return new ce({...this._def,unknownKeys:"strip"})}passthrough(){return new ce({...this._def,unknownKeys:"passthrough"})}extend(e){return new ce({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new ce({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:Ce.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new ce({...this._def,catchall:e})}pick(e){const t={};for(const r of n.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new ce({...this._def,shape:()=>t})}omit(e){const t={};for(const r of n.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new ce({...this._def,shape:()=>t})}deepPartial(){return le(this)}partial(e){const t={};for(const r of n.objectKeys(this.shape)){const n=this.shape[r];e&&!e[r]?t[r]=n:t[r]=n.optional()}return new ce({...this._def,shape:()=>t})}required(e){const t={};for(const r of n.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof Ae;)e=e._def.innerType;t[r]=e}return new ce({...this._def,shape:()=>t})}keyof(){return be(n.objectKeys(this.shape))}}ce.create=(e,t)=>new ce({shape:()=>e,unknownKeys:"strip",catchall:ie.create(),typeName:Ce.ZodObject,...A(t)}),ce.strictCreate=(e,t)=>new ce({shape:()=>e,unknownKeys:"strict",catchall:ie.create(),typeName:Ce.ZodObject,...A(t)}),ce.lazycreate=(e,t)=>new ce({shape:e,unknownKeys:"strip",catchall:ie.create(),typeName:Ce.ZodObject,...A(t)});class ue extends E{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map(async e=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;const r=e.map(e=>new l(e.ctx.common.issues));return d(t,{code:o.invalid_union,unionErrors:r}),m});{let e;const n=[];for(const a of r){const r={...t,common:{...t.common,issues:[]},parent:null},i=a._parseSync({data:t.data,path:t.path,parent:r});if("valid"===i.status)return i;"dirty"!==i.status||e||(e={result:i,ctx:r}),r.common.issues.length&&n.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const a=n.map(e=>new l(e));return d(t,{code:o.invalid_union,unionErrors:a}),m}}get options(){return this._def.options}}function he(e,t){const r=s(e),a=s(t);if(e===t)return{valid:!0,data:e};if(r===i.object&&a===i.object){const r=n.objectKeys(t),a=n.objectKeys(e).filter(e=>-1!==r.indexOf(e)),i={...e,...t};for(const r of a){const n=he(e[r],t[r]);if(!n.valid)return{valid:!1};i[r]=n.data}return{valid:!0,data:i}}if(r===i.array&&a===i.array){if(e.length!==t.length)return{valid:!1};const r=[];for(let n=0;n<e.length;n++){const a=he(e[n],t[n]);if(!a.valid)return{valid:!1};r.push(a.data)}return{valid:!0,data:r}}return r===i.date&&a===i.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}ue.create=(e,t)=>new ue({options:e,typeName:Ce.ZodUnion,...A(t)});class de extends E{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),n=(e,n)=>{if(y(e)||y(n))return m;const a=he(e.value,n.value);return a.valid?((b(e)||b(n))&&t.dirty(),{status:t.value,value:a.data}):(d(r,{code:o.invalid_intersection_types}),m)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([e,t])=>n(e,t)):n(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}de.create=(e,t,r)=>new de({left:e,right:t,typeName:Ce.ZodIntersection,...A(r)});class pe extends E{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==i.array)return d(r,{code:o.invalid_type,expected:i.array,received:r.parsedType}),m;if(r.data.length<this._def.items.length)return d(r,{code:o.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),m;!this._def.rest&&r.data.length>this._def.items.length&&(d(r,{code:o.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const n=[...r.data].map((e,t)=>{const n=this._def.items[t]||this._def.rest;return n?n._parse(new v(r,e,r.path,t)):null}).filter(e=>!!e);return r.common.async?Promise.all(n).then(e=>p.mergeArray(t,e)):p.mergeArray(t,n)}get items(){return this._def.items}rest(e){return new pe({...this._def,rest:e})}}pe.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new pe({items:e,typeName:Ce.ZodTuple,rest:null,...A(t)})};class me extends E{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==i.map)return d(r,{code:o.invalid_type,expected:i.map,received:r.parsedType}),m;const n=this._def.keyType,a=this._def.valueType,s=[...r.data.entries()].map(([e,t],i)=>({key:n._parse(new v(r,e,r.path,[i,"key"])),value:a._parse(new v(r,t,r.path,[i,"value"]))}));if(r.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const r of s){const n=await r.key,a=await r.value;if("aborted"===n.status||"aborted"===a.status)return m;"dirty"!==n.status&&"dirty"!==a.status||t.dirty(),e.set(n.value,a.value)}return{status:t.value,value:e}})}{const e=new Map;for(const r of s){const n=r.key,a=r.value;if("aborted"===n.status||"aborted"===a.status)return m;"dirty"!==n.status&&"dirty"!==a.status||t.dirty(),e.set(n.value,a.value)}return{status:t.value,value:e}}}}me.create=(e,t,r)=>new me({valueType:t,keyType:e,typeName:Ce.ZodMap,...A(r)});class fe extends E{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==i.set)return d(r,{code:o.invalid_type,expected:i.set,received:r.parsedType}),m;const n=this._def;null!==n.minSize&&r.data.size<n.minSize.value&&(d(r,{code:o.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),t.dirty()),null!==n.maxSize&&r.data.size>n.maxSize.value&&(d(r,{code:o.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),t.dirty());const a=this._def.valueType;function s(e){const r=new Set;for(const n of e){if("aborted"===n.status)return m;"dirty"===n.status&&t.dirty(),r.add(n.value)}return{status:t.value,value:r}}const l=[...r.data.values()].map((e,t)=>a._parse(new v(r,e,r.path,t)));return r.common.async?Promise.all(l).then(e=>s(e)):s(l)}min(e,t){return new fe({...this._def,minSize:{value:e,message:h.toString(t)}})}max(e,t){return new fe({...this._def,maxSize:{value:e,message:h.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}fe.create=(e,t)=>new fe({valueType:e,minSize:null,maxSize:null,typeName:Ce.ZodSet,...A(t)});class ge extends E{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}ge.create=(e,t)=>new ge({getter:e,typeName:Ce.ZodLazy,...A(t)});class ye extends E{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return d(t,{received:t.data,code:o.invalid_literal,expected:this._def.value}),m}return{status:"valid",value:e.data}}get value(){return this._def.value}}function be(e,t){return new we({values:e,typeName:Ce.ZodEnum,...A(t)})}ye.create=(e,t)=>new ye({value:e,typeName:Ce.ZodLiteral,...A(t)});class we extends E{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),r=this._def.values;return d(t,{expected:n.joinValues(r),received:t.parsedType,code:o.invalid_type}),m}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return d(t,{received:t.data,code:o.invalid_enum_value,options:r}),m}return g(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return we.create(e,{...this._def,...t})}exclude(e,t=this._def){return we.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}we.create=be;class _e extends E{_parse(e){const t=n.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==i.string&&r.parsedType!==i.number){const e=n.objectValues(t);return d(r,{expected:n.joinValues(e),received:r.parsedType,code:o.invalid_type}),m}if(this._cache||(this._cache=new Set(n.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=n.objectValues(t);return d(r,{received:r.data,code:o.invalid_enum_value,options:e}),m}return g(e.data)}get enum(){return this._def.values}}_e.create=(e,t)=>new _e({values:e,typeName:Ce.ZodNativeEnum,...A(t)});class ve extends E{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==i.promise&&!1===t.common.async)return d(t,{code:o.invalid_type,expected:i.promise,received:t.parsedType}),m;const r=t.parsedType===i.promise?t.data:Promise.resolve(t.data);return g(r.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}ve.create=(e,t)=>new ve({type:e,typeName:Ce.ZodPromise,...A(t)});class Oe extends E{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Ce.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,i={addIssue:e=>{d(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(i.addIssue=i.addIssue.bind(i),"preprocess"===a.type){const e=a.transform(r.data,i);if(r.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return m;const n=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===n.status?m:"dirty"===n.status||"dirty"===t.value?f(n.value):n});{if("aborted"===t.value)return m;const n=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===n.status?m:"dirty"===n.status||"dirty"===t.value?f(n.value):n}}if("refinement"===a.type){const e=e=>{const t=a.refinement(e,i);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===r.common.async){const n=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===n.status?m:("dirty"===n.status&&t.dirty(),e(n.value),{status:t.value,value:n.value})}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(r=>"aborted"===r.status?m:("dirty"===r.status&&t.dirty(),e(r.value).then(()=>({status:t.value,value:r.value}))))}if("transform"===a.type){if(!1===r.common.async){const e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!w(e))return m;const n=a.transform(e.value,i);if(n instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:n}}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(e=>w(e)?Promise.resolve(a.transform(e.value,i)).then(e=>({status:t.value,value:e})):m)}n.assertNever(a)}}Oe.create=(e,t,r)=>new Oe({schema:e,typeName:Ce.ZodEffects,effect:t,...A(r)}),Oe.createWithPreprocess=(e,t,r)=>new Oe({schema:t,effect:{type:"preprocess",transform:e},typeName:Ce.ZodEffects,...A(r)});class Ae extends E{_parse(e){return this._getType(e)===i.undefined?g(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ae.create=(e,t)=>new Ae({innerType:e,typeName:Ce.ZodOptional,...A(t)});class Ee extends E{_parse(e){return this._getType(e)===i.null?g(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ee.create=(e,t)=>new Ee({innerType:e,typeName:Ce.ZodNullable,...A(t)});class xe extends E{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===i.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}xe.create=(e,t)=>new xe({innerType:e,typeName:Ce.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...A(t)});class Ie extends E{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},n=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return _(n)?n.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new l(r.common.issues)},input:r.data})})):{status:"valid",value:"valid"===n.status?n.value:this._def.catchValue({get error(){return new l(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}Ie.create=(e,t)=>new Ie({innerType:e,typeName:Ce.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...A(t)});class Pe extends E{_parse(e){if(this._getType(e)!==i.nan){const t=this._getOrReturnCtx(e);return d(t,{code:o.invalid_type,expected:i.nan,received:t.parsedType}),m}return{status:"valid",value:e.data}}}Pe.create=e=>new Pe({typeName:Ce.ZodNaN,...A(e)}),Symbol("zod_brand");class Se extends E{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class ke extends E{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?m:"dirty"===e.status?(t.dirty(),f(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})();{const e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?m:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new ke({in:e,out:t,typeName:Ce.ZodPipeline})}}class Te extends E{_parse(e){const t=this._def.innerType._parse(e),r=e=>(w(e)&&(e.value=Object.freeze(e.value)),e);return _(t)?t.then(e=>r(e)):r(t)}unwrap(){return this._def.innerType}}var Ce;Te.create=(e,t)=>new Te({innerType:e,typeName:Ce.ZodReadonly,...A(t)}),ce.lazycreate,function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(Ce||(Ce={}));const je=J.create,Ne=(G.create,Pe.create,Y.create,X.create,Q.create,ee.create,te.create,re.create,ne.create),Re=(ae.create,ie.create,se.create,oe.create,ce.create);ce.strictCreate,ue.create,de.create,pe.create,me.create,fe.create,ge.create,ye.create,we.create,_e.create,ve.create,Oe.create,Ae.create,Ee.create,Oe.createWithPreprocess,ke.create},8999:(e,t,r)=>{"use strict";r.d(t,{y:()=>c,Z:()=>l});var n=r(9478);function a(e,t){return t?.[e]||n(e)}function i(e,t,r){const n={};for(const a in e)Object.hasOwn(e,a)&&(n[t(a,r)]=e[a]);return n}function s(e){return Array.isArray(e)?[...e]:{...e}}function o(e,t){const r=s(e);for(const[e,n]of Object.entries(t)){const[t,...a]=e.split(".").reverse();let i=r;for(const e of a.reverse()){if(void 0===i[e])break;i[e]=s(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[n]})}return r}function l(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}r(2729);class c{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,l(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof c||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e),{});for(let n=Object.getPrototypeOf(this);n;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n,"lc_aliases",this)),Object.assign(t,Reflect.get(n,"lc_secrets",this)),Object.assign(r,Reflect.get(n,"lc_attributes",this));return Object.keys(t).forEach(e=>{let t=this,n=r;const[a,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in n&&void 0!==n[e]||("object"==typeof t[e]&&null!=t[e]?n[e]={}:Array.isArray(t[e])&&(n[e]=[])),t=t[e],n=n[e]}a in t&&void 0!==t[a]&&(n[a]=n[a]||t[a])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:i(Object.keys(t).length?o(r,t):r,a,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}},9056:(e,t,r)=>{"use strict";r.d(t,{Kj:()=>j});var n=r(5230),a=r(4116),i=r(3290),s=r(747);const o=[400,401,403,404,405,406,407,408],l=[409];class c{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue=new i.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add(()=>a(()=>e(...t).catch(e=>{throw e instanceof Error?e:new Error(e)}),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,n=t?.status;if(n){if(o.includes(+n))throw e;if(l.includes(+n))return;r&&await r(t)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((t,r)=>{e.signal?.addEventListener("abort",()=>{r(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>(0,s.Y)()(...e).then(e=>e.ok?e:Promise.reject(e)))}}function u(e){return"function"==typeof e?._getType}function h(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}var d=r(4785),p=r(6928);const m=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function f(e,t){if("string"!=typeof(r=e)||!m.test(r))throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`);var r;return e}var g=r(6232),y=r(7280);function b(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,r]=e.split(":"),n=r||"latest";if(t.includes("/")){const[r,a]=t.split("/",2);if(!r||!a)throw new Error(`Invalid identifier format: ${e}`);return[r,a,n]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,n]}class w extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function _(e,t,r){let n;if(e.ok)return void(r&&(n=await e.text()));n=await e.text();const a=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${n}`;if(409===e.status)throw new w(a);throw new Error(a)}var v="[...]",O={result:"[Circular]"},A=[],E=[];function x(e,t,r,n){try{return JSON.stringify(e,t,r)}catch(s){if(!s.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";var a;console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),void 0===n&&(n={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),P(e,"",0,[],void 0,0,n);try{a=0===E.length?JSON.stringify(e,t,r):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,r){if(E.length>0)for(var n=0;n<E.length;n++){var a=E[n];if(a[1]===t&&a[0]===r){r=a[2],E.splice(n,1);break}}return e.call(this,t,r)}}(t),r)}catch(e){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==A.length;){var i=A.pop();4===i.length?Object.defineProperty(i[0],i[1],i[3]):i[0][i[1]]=i[2]}}return a}}function I(e,t,r,n){var a=Object.getOwnPropertyDescriptor(n,r);void 0!==a.get?a.configurable?(Object.defineProperty(n,r,{value:e}),A.push([n,r,t,a])):E.push([t,r,e]):(n[r]=e,A.push([n,r,t]))}function P(e,t,r,n,a,i,s){var o;if(i+=1,"object"==typeof e&&null!==e){for(o=0;o<n.length;o++)if(n[o]===e)return void I(O,e,t,a);if(void 0!==s.depthLimit&&i>s.depthLimit)return void I(v,e,t,a);if(void 0!==s.edgesLimit&&r+1>s.edgesLimit)return void I(v,e,t,a);if(n.push(e),Array.isArray(e))for(o=0;o<e.length;o++)P(e[o],o,o,n,e,i,s);else{var l=Object.keys(e);for(o=0;o<l.length;o++){var c=l[o];P(e[c],c,o,n,e,i,s)}}n.pop()}}function S(e){const t=(0,d.Ec)(),r=(0,d.yk)(),n=e.extra??{},a=n.metadata;return e.extra={...n,runtime:{...t,...n?.runtime},metadata:{...r,...r.revision_id||e.revision_id?{revision_id:e.revision_id??r.revision_id}:{},...a}},e}function k(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const T=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise(e=>setTimeout(e,t)),!0}return!1};class C{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const r=new Promise(e=>{t=e}),n=x(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:r,size:n}),this.sizeBytes+=n,r}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),r+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),r+=e.size,this.sizeBytes-=e.size}return[t.map(e=>({action:e.action,item:e.payload})),()=>t.forEach(e=>e.itemPromiseResolve())]}}class j{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new C}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=j.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=(0,d.Jz)("TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=k(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=k(e.apiKey??t.apiKey),this.webUrl=k(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??12e3,this.caller=new c(e.callerOptions??{}),this.batchIngestCaller=new c({...e.callerOptions??{},onFailedResponseHook:T}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=(0,d.Jz)("API_KEY");return{apiUrl:(0,d.Jz)("ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===(0,d.Jz)("HIDE_INPUTS"),hideOutputs:"true"===(0,d.Jz)("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(()=>{const e=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===e||"127.0.0.1"===e||"::1"===e})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${p.Ls}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=t?.toString()??"",n=`${this.apiUrl}${e}?${r}`,a=await this.caller.call((0,s.Y)(),n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(a,`Failed to fetch ${e}`),a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let n=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(n)),t.set("limit",String(a));const i=`${this.apiUrl}${e}?${t}`,o=await this.caller.call((0,s.Y)(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,`Failed to fetch ${e}`);const l=r?r(await o.json()):await o.json();if(0===l.length)break;if(yield l,l.length<a)break;n+=l.length}}async*_getCursorPaginatedList(e,t=null,r="POST",n="runs"){const a=t?{...t}:{};for(;;){const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)}),i=await t.json();if(!i)break;if(!i[n])break;yield i[n];const o=i.cursors;if(!o)break;if(!o.next)break;a.cursor=o.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const r of e)this.filteredPostUuids.has(r.id)?this.filteredPostUuids.delete(r.id):t.push(r);return t}{const t=[];for(const r of e)r.id!==r.trace_id&&!this.filteredPostUuids.has(r.trace_id)||Math.random()<this.tracingSampleRate?t.push(r):this.filteredPostUuids.add(r.id);return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??20971520}async drainAutoBatchQueue(){for(;this.autoBatchQueue.items.length>=0;){const[e,t]=this.autoBatchQueue.pop(await this._getBatchSizeLimitBytes());if(!e.length)return void t();try{const t={runCreates:e.filter(e=>"create"===e.action).map(e=>e.item),runUpdates:e.filter(e=>"update"===e.action).map(e=>e.item)},r=await this._ensureServerInfo();r?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(t):await this.batchIngestRuns(t)}finally{t()}}}async processRunOperation(e,t){const r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,"create"===e.action&&(e.item=S(e.item));const n=this.autoBatchQueue.push(e),a=await this._getBatchSizeLimitBytes();return(t||this.autoBatchQueue.sizeBytes>a)&&await this.drainAutoBatchQueue().catch(console.error),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),n}async _getServerInfo(){const e=await(0,s.Y)()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e3),...this.fetchOptions});return await _(e,"get server info"),e.json()}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to single calls and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const n=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void this.processRunOperation({action:"create",item:n}).catch(console.error);const a=S(n),i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:x(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let r=e?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[],n=t?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[];if(r.length>0&&n.length>0){const e=r.reduce((e,t)=>t.id?(e[t.id]=t,e):e,{}),t=[];for(const r of n)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);r=Object.values(e),n=t}const a={post:this._filterForSampling(r),patch:this._filterForSampling(n,!0)};if(!a.post.length&&!a.patch.length)return;if(void 0===(await this._ensureServerInfo()).version){this.autoBatchTracing=!1;for(const e of a.post)await this.createRun(e);for(const e of a.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const i={post:[],patch:[]};for(const e of["post","patch"]){const t=e,r=a[t].reverse();let n=r.pop();for(;void 0!==n;)i[t].push(n),n=r.pop()}(i.post.length>0||i.patch.length>0)&&await this._postBatchIngestRuns(x(i))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call((0,s.Y)(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;const r={};let n=[];for(const t of e??[]){const e=this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(r[e.id]=e.attachments),delete e.attachments,n.push(e)}let a=[];for(const e of t??[])a.push(this.prepareRunCreateOrUpdateInputs(e));if(void 0!==n.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==a.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(n.length>0&&a.length>0){const e=n.reduce((e,t)=>t.id?(e[t.id]=t,e):e,{}),t=[];for(const r of a)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);n=Object.values(e),a=t}if(0===n.length&&0===a.length)return;const i=[],s=[];for(const[e,t]of[["post",n],["patch",a]])for(const n of t){const{inputs:t,outputs:a,events:o,...l}=n,c={inputs:t,outputs:a,events:o},u=x(l);s.push({name:`${e}.${l.id}`,payload:new Blob([u],{type:`application/json; length=${u.length}`})});for(const[t,r]of Object.entries(c)){if(void 0===r)continue;const n=x(r);s.push({name:`${e}.${l.id}.${t}`,payload:new Blob([n],{type:`application/json; length=${n.length}`})})}if(void 0!==l.id){const e=r[l.id];if(e){delete r[l.id];for(const[t,[r,n]]of Object.entries(e))s.push({name:`attachment.${l.id}.${t}`,payload:new Blob([n],{type:`${r}; length=${n.length}`})})}}i.push(`trace=${l.trace_id},id=${l.id}`)}await this._sendMultipartRequest(s,i.join("; "))}async _sendMultipartRequest(e,t){try{const t=new FormData;for(const r of e)t.append(r.name,r.payload);await this.batchIngestCaller.call((0,s.Y)(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers},body:t,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})}catch(e){let r="Failed to multipart ingest runs";e instanceof Error?r+=`: ${e.stack||e.message}`:r+=`: ${String(e)}`,console.warn(`${r.trim()}\n\nContext: ${t}`)}}async updateRun(e,t){f(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void 0!==t.end_time&&void 0===r.parent_run_id&&this.blockOnRootRunFinalization?void await this.processRunOperation({action:"update",item:r},!0):void this.processRunOperation({action:"update",item:r}).catch(console.error);const n={...this.headers,"Content-Type":"application/json"},a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:n,body:x(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){f(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;e=t.session_id?t.session_id:r?.projectName?(await this.readProject({projectName:r?.projectName})).id:r?.projectId?r?.projectId:(await this.readProject({projectName:(0,d.Jz)("PROJECT")||"default"})).id;const n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const r of e)t.push(r);return t}(this.listRuns({id:e.child_run_ids})),r={},n={};t.sort((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??""));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in r||(r[e.parent_run_id]=[]),r[e.parent_run_id].push(e),n[e.id]=e}e.child_runs=r[e.id]||[];for(const t in r)t!==e.id&&(n[t].child_runs=r[t]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:n,traceId:a,referenceExampleId:i,startTime:s,executionOrder:o,isRoot:l,runType:c,error:u,id:h,query:d,filter:p,traceFilter:m,treeFilter:f,limit:g,select:y}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),r){const e=Array.isArray(r)?r:[r],t=await Promise.all(e.map(e=>this.readProject({projectName:e}).then(e=>e.id)));b.push(...t)}const w={session:b.length?b:null,run_type:c,reference_example:i,query:d,filter:p,trace_filter:m,tree_filter:f,execution_order:o,parent_run:n,start_time:s?s.toISOString():null,error:u,id:h,limit:g,trace:a,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:l};let _=0;for await(const e of this._getCursorPaginatedList("/runs/query",w))if(g){if(_>=g)break;if(e.length+_>g){const t=e.slice(0,g-_);yield*t;break}_+=e.length,yield*e}else yield*e}async getRunStats({id:e,trace:t,parentRun:r,runType:n,projectNames:a,projectIds:i,referenceExampleIds:o,startTime:l,endTime:c,error:u,query:h,filter:d,traceFilter:p,treeFilter:m,isRoot:f,dataSourceType:g}){let y=i||[];a&&(y=[...i||[],...await Promise.all(a.map(e=>this.readProject({projectName:e}).then(e=>e.id)))]);const b={id:e,trace:t,parent_run:r,run_type:n,session:y,reference_example:o,start_time:l,end_time:c,error:u,query:h,filter:d,trace_filter:p,tree_filter:m,is_root:f,data_source_type:g},w=Object.fromEntries(Object.entries(b).filter(([e,t])=>void 0!==t)),_=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(w),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _.json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||n.A()};f(e);const a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await a.json();if(null===i||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){f(e);const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"unshare run",!0)}async readRunSharedLink(e){f(e);const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(null!==r&&"share_token"in r)return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)r.append("id",e);f(e);const n=await this.caller.call((0,s.Y)(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await n.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),f(e);const r=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await r.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};f(e);const n=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await n.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){f(e);const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"unshare dataset",!0)}async readSharedDataset(e){f(e);const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){const r={};t?.exampleIds&&(r.id=t.exampleIds);const n=new URLSearchParams;Object.entries(r).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>n.append(e,t)):n.append(e,t)});const a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/public/${e}/examples?${n.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await a.json();if(!a.ok){if("detail"in i)throw new Error(`Failed to list shared examples.\nStatus: ${a.status}\nMessage: ${i.detail.join("\n")}`);throw new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`)}return i.map(e=>({...e,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:n=!1,projectExtra:a=null,referenceDatasetId:i=null}){const o=n?"?upsert=true":"",l=`${this.apiUrl}/sessions${o}`,c=a||{};r&&(c.metadata=r);const u={name:e,extra:c,description:t};null!==i&&(u.reference_dataset_id=i);const h=await this.caller.call((0,s.Y)(),l,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(h,"create project"),await h.json()}async updateProject(e,{name:t=null,description:r=null,metadata:n=null,projectExtra:a=null,endTime:i=null}){const o=`${this.apiUrl}/sessions/${e}`;let l=a;n&&(l={...l||{},metadata:n});const c={name:t,extra:l,description:r,end_time:i?new Date(i).toISOString():null},u=await this.caller.call((0,s.Y)(),o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(u,"update project"),await u.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)f(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");n.append("name",t)}const a=await this.caller.call((0,s.Y)(),`${this.apiUrl}${r}?${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await a.json();return!!a.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let n="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)f(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}void 0!==r&&a.append("include_stats",r.toString());const i=await this._get(n,a);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Project[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/datasets/${r.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:n,referenceDatasetName:a,referenceFree:i,metadata:s}={}){const o=new URLSearchParams;if(void 0!==e)for(const t of e)o.append("id",t);if(void 0!==t&&o.append("name",t),void 0!==r&&o.append("name_contains",r),void 0!==n)o.append("reference_dataset",n);else if(void 0!==a){const e=await this.readDataset({datasetName:a});o.append("reference_dataset",e.id)}void 0!==i&&o.append("reference_free",i.toString()),void 0!==s&&o.append("metadata",JSON.stringify(s));for await(const e of this._getPaginated("/sessions",o))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");r=void 0===e?(await this.readProject({projectName:t})).id:e,f(r);const n=await this.caller.call((0,s.Y)(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(n,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:n,description:a,dataType:i,name:o}){const l=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(e=>{c.append("input_keys",e)}),n.forEach(e=>{c.append("output_keys",e)}),a&&c.append("description",a),i&&c.append("data_type",i),o&&c.append("name",o);const u=await this.caller.call((0,s.Y)(),l,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(u,"upload CSV"),await u.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:n,outputsSchema:a,metadata:i}={}){const o={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(o.data_type=r),n&&(o.inputs_schema_definition=n),a&&(o.outputs_schema_definition=a);const l=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(l,"create dataset"),await l.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const n=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)f(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");n.append("name",t)}const a=await this._get(r,n);let i;if(Array.isArray(a)){if(0===a.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:n}){let a=e;if(void 0===a&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==a&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===a&&(a=(await this.readDataset({datasetName:t})).id);const i=new URLSearchParams({from_version:"string"==typeof r?r:r.toISOString(),to_version:"string"==typeof n?n:n.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const r=await this._getResponse(`/datasets/${e}/openai_ft`);return(await r.text()).trim().split("\n").map(e=>JSON.parse(e))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:n,datasetNameContains:a,metadata:i}={}){const s=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(const e of r)s.append("id",e);void 0!==n&&s.append("name",n),void 0!==a&&s.append("name_contains",a),void 0!==i&&s.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/datasets",s))yield*e}async updateDataset(e){const{datasetId:t,datasetName:r,...n}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:r})).id;f(a);const i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,"update dataset"),await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",n=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(n=(await this.readDataset({datasetName:t})).id),void 0===n)throw new Error("Must provide datasetName or datasetId");f(n),r+=`/${n}`;const a=await this.caller.call((0,s.Y)(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,`delete ${r}`),await a.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let n=e;if(!n&&!t)throw new Error("Must provide either datasetName or datasetId");if(n&&t)throw new Error("Must provide either datasetName or datasetId, not both");n||(n=(await this.readDataset({datasetName:t})).id),f(n);const a={tag:r},i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${n}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:n}={}){const a={limit:r,inputs:e};void 0!==n&&(a.filter=n),f(t);const i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,"fetch similar examples"),(await i.json()).examples}async createExample(e,t,{datasetId:r,datasetName:n,createdAt:a,exampleId:i,metadata:o,split:l,sourceRunId:c}){let u=r;if(void 0===u&&void 0===n)throw new Error("Must provide either datasetName or datasetId");if(void 0!==u&&void 0!==n)throw new Error("Must provide either datasetName or datasetId, not both");void 0===u&&(u=(await this.readDataset({datasetName:n})).id);const h=a||new Date,d={dataset_id:u,inputs:e,outputs:t,created_at:h?.toISOString(),id:i,metadata:o,split:l,source_run_id:c},p=await this.caller.call((0,s.Y)(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(d),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(p,"create example"),await p.json()}async createExamples(e){const{inputs:t,outputs:r,metadata:n,sourceRunIds:a,exampleIds:i,datasetId:o,datasetName:l}=e;let c=o;if(void 0===c&&void 0===l)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==l)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){const e=await this.readDataset({datasetName:l});c=e.id}const u=t.map((t,s)=>({dataset_id:c,inputs:t,outputs:r?r[s]:void 0,metadata:n?n[s]:void 0,split:e.splits?e.splits[s]:void 0,id:i?i[s]:void 0,source_run_id:a?a[s]:void 0})),h=await this.caller.call((0,s.Y)(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(u),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(h,"create examples"),await h.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const n=e.map(e=>u(e)?h(e):e),a=u(t)?h(t):t;return this.createExample({input:n},{output:a},r)}async readExample(e){f(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:n,splits:a,inlineS3Urls:i,metadata:s,limit:o,offset:l,filter:c}={}){let u;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)u=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");u=(await this.readDataset({datasetName:t})).id}const h=new URLSearchParams({dataset:u}),d=n?"string"==typeof n?n:n?.toISOString():void 0;d&&h.append("as_of",d);const p=i??!0;if(h.append("inline_s3_urls",p.toString()),void 0!==r)for(const e of r)h.append("id",e);if(void 0!==a)for(const e of a)h.append("splits",e);if(void 0!==s){const e=JSON.stringify(s);h.append("metadata",e)}void 0!==o&&h.append("limit",o.toString()),void 0!==l&&h.append("offset",l.toString()),void 0!==c&&h.append("filter",c);let m=0;for await(const e of this._getPaginated("/examples",h)){for(const t of e)yield t,m++;if(void 0!==o&&m>=o)break}}async deleteExample(e){f(e);const t=`/examples/${e}`,r=await this.caller.call((0,s.Y)(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,`delete ${t}`),await r.json()}async updateExample(e,t){f(e);const r=await this.caller.call((0,s.Y)(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(r,"update example"),await r.json()}async updateExamples(e){const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(t,"update examples"),await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");n=void 0===e?(await this.readDataset({datasetName:t})).id:e,f(n);const a=new URLSearchParams,i=r?"string"==typeof r?r:r?.toISOString():void 0;return i&&a.append("as_of",i),await this._get(`/datasets/${n}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:n,remove:a=!1}){let i;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");i=void 0===e?(await this.readDataset({datasetName:t})).id:e,f(i);const o={split_name:r,examples:n.map(e=>(f(e),e)),remove:a},l=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(l,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:n,referenceExample:a}={loadChildRuns:!1}){let i;if((0,g.m)("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)i=await this.readRun(e,{loadChildRuns:n});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);i=e}null!==i.reference_example_id&&void 0!==i.reference_example_id&&(a=await this.readExample(i.reference_example_id));const s=await t.evaluateRun(i,a),[o,l]=await this._logEvaluationFeedback(s,i,r);return l[0]}async createFeedback(e,t,{score:r,value:a,correction:i,comment:o,sourceInfo:l,feedbackSourceType:c="api",sourceRunId:u,feedbackId:h,feedbackConfig:d,projectId:p,comparativeExperimentId:m}){if(!e&&!p)throw new Error("One of runId or projectId must be provided");if(e&&p)throw new Error("Only one of runId or projectId can be provided");const g={type:c??"api",metadata:l??{}};void 0===u||void 0===g?.metadata||g.metadata.__run||(g.metadata.__run={run_id:u}),void 0!==g?.metadata&&void 0!==g.metadata.__run?.run_id&&f(g.metadata.__run.run_id);const y={id:h??n.A(),run_id:e,key:t,score:r,value:a,correction:i,comment:o,feedback_source:g,comparative_experiment_id:m,feedbackConfig:d,session_id:p},b=`${this.apiUrl}/feedback`,w=await this.caller.call((0,s.Y)(),b,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(y),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(w,"create feedback",!0),y}async updateFeedback(e,{score:t,value:r,correction:n,comment:a}){const i={};null!=t&&(i.score=t),null!=r&&(i.value=r),null!=n&&(i.correction=n),null!=a&&(i.comment=a),f(e);const o=await this.caller.call((0,s.Y)(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,"update feedback",!0)}async readFeedback(e){f(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){f(e);const t=`/feedback/${e}`,r=await this.caller.call((0,s.Y)(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const n=new URLSearchParams;if(e&&n.append("run",e.join(",")),t)for(const e of t)n.append("key",e);if(r)for(const e of r)n.append("source",e);for await(const e of this._getPaginated("/feedback",n))yield*e}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:n}={}){const a={run_id:e,feedback_key:t,feedback_config:n};r?"string"==typeof r?a.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(a.expires_in=r):a.expires_in={hours:3};const i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await i.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:n,description:a,metadata:i,id:o}){if(0===t.length)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!r)throw new Error("A reference dataset is required");const l={id:o,name:e,experiment_ids:t,reference_dataset_id:r,description:a,created_at:(n??new Date)?.toISOString(),extra:{}};i&&(l.extra.metadata=i);const c=await this.caller.call((0,s.Y)(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){f(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async _logEvaluationFeedback(e,t,r){const n=this._selectEvalResults(e),a=[];for(const e of n){let n=r||{};e.evaluatorInfo&&(n={...e.evaluatorInfo,...n});let i=null;e.targetRunId?i=e.targetRunId:t&&(i=t.id),a.push(await this.createFeedback(i,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:n,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[n,a]}async logEvaluationFeedback(e,t,r){const[n]=await this._logEvaluationFeedback(e,t,r);return n}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:n,limit:a}=e,i=new URLSearchParams;t&&t.forEach((e,t)=>{f(e,`queueIds[${t}]`),i.append("ids",e)}),r&&i.append("name",r),n&&i.append("name_contains",n),i.append("limit",(void 0!==a?Math.min(a,100):100).toString());let s=0;for await(const e of this._getPaginated("/annotation-queues",i))if(yield*e,s++,void 0!==a&&s>=a)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:a}=e,i={name:t,description:r,id:a||n.A()},o=await this.caller.call((0,s.Y)(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(i).filter(([e,t])=>void 0!==t))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(o,"create annotation queue"),await o.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:r,description:n}=t,a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/annotation-queues/${f(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:n}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(a,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/annotation-queues/${f(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const r=await this.caller.call((0,s.Y)(),`${this.apiUrl}/annotation-queues/${f(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map((e,t)=>f(e,`runIds[${t}]`).toString())),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${f(e,"queueId")}/run`,n=await this.caller.call((0,s.Y)(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(n,"get run from annotation queue"),await n.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${r.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call((0,s.Y)(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){const e="string"==typeof r.detail?r.detail:JSON.stringify(r.detail),n=new Error(`Error ${t.status}: ${t.statusText}\n${e}`);throw n.statusCode=t.status,n}if(0!==r.commits.length)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,n,a]=b(e),i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/likes/${r}/${n}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,(t?"like":"unlike")+" prompt"),await i.json()}async _getPromptUrl(e){const[t,r,n]=b(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==n?`${this.getHostUrl()}/prompts/${r}/${n.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${e.id}`}return"latest"!==n?`${this.getHostUrl()}/hub/${t}/${r}/${n.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,e=>e.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,e=>e.repos))yield*e}async getPrompt(e){const[t,r,n]=b(e),a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===a.status)return null;await _(a,"get prompt");const i=await a.json();return i.repo?i.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle. \n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[n,a,i]=b(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("create a prompt",n);const o={repo_handle:a,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},l=await this.caller.call((0,s.Y)(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(l,"create prompt");const{repo:c}=await l.json();return c}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,a,i]=b(e),o="latest"!==r?.parentCommitHash&&r?.parentCommitHash?r?.parentCommitHash:await this._getLatestCommitHash(`${n}/${a}`),l={manifest:JSON.parse(JSON.stringify(t)),parent_commit:o},c=await this.caller.call((0,s.Y)(),`${this.apiUrl}/commits/${n}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(c,"create commit");const u=await c.json();return this._getPromptUrl(`${n}/${a}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,n]=b(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const a={};if(void 0!==t?.description&&(a.description=t.description),void 0!==t?.readme&&(a.readme=t.readme),void 0!==t?.tags&&(a.tags=t.tags),void 0!==t?.isPublic&&(a.is_public=t.isPublic),void 0!==t?.isArchived&&(a.is_archived=t.isArchived),0===Object.keys(a).length)throw new Error("No valid update options provided");const i=await this.caller.call((0,s.Y)(),`${this.apiUrl}/repos/${r}/${n}`,{method:"PATCH",body:JSON.stringify(a),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,n]=b(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);const a=await this.caller.call((0,s.Y)(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await a.json()}async pullPromptCommit(e,t){const[r,n,a]=b(e);let i=a;if(!function(e){const t=(0,y.parse)(e),r=(0,y.parse)("0.5.23");if(!t||!r)throw new Error("Invalid version format.");return t.compare(r)>=0}((await this._getServerInfo()).version)&&"latest"===a){const e=await this._getLatestCommitHash(`${r}/${n}`);if(!e)throw new Error("No commits found");i=e}const o=await this.caller.call((0,s.Y)(),`${this.apiUrl}/commits/${r}/${n}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await _(o,"pull prompt commit");const l=await o.json();return{owner:r,repo:n,commit_hash:l.commit_hash,manifest:l.manifest,examples:l.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(e=>"object"!==e)&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:n}=t,[a,i]=this.parseTokenOrUrl(e,r),s=new j({apiUrl:a,apiKey:"placeholder"}),o=await s.readSharedDataset(i),l=n||o.name;try{if(await this.hasDataset({datasetId:l}))return void console.log(`Dataset ${l} already exists in your tenant. Skipping.`)}catch(e){}const c=await s.listSharedExamples(i),u=await this.createDataset(l,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:c.map(e=>e.inputs),outputs:c.flatMap(e=>e.outputs?[e.outputs]:[]),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,r=2,n="dataset"){try{return f(e),[t,e]}catch(e){}try{const a=new URL(e).pathname.split("/").filter(e=>""!==e);if(a.length>=r)return[t,a[a.length-r]];throw new Error(`Invalid public ${n} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${n} URL or token: ${e}`)}}awaitPendingTraceBatches(){return Promise.all(this.autoBatchQueue.items.map(({itemPromise:e})=>e))}}},9196:(e,t,r)=>{"use strict";const n=r(4899);e.exports=(e,t)=>new n(e,t).patch},9478:e=>{"use strict";e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},9499:(e,t,r)=>{"use strict";const n=r(4899),a=r(9558);e.exports=(e,t,r)=>{let i=null,s=null,o=null;try{o=new a(t,r)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(i&&1!==s.compare(e)||(i=e,s=new n(i,r)))}),i}},9558:(e,t,r)=>{"use strict";const n=/\s+/g;class a{constructor(e,t){if(t=s(t),e instanceof a)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new a(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(n," "),this.set=this.raw.split("||").map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter(e=>!y(e[0])),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&b(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&f)|(this.options.loose&&g))+":"+e,r=i.get(t);if(r)return r;const n=this.options.loose,a=n?u[h.HYPHENRANGELOOSE]:u[h.HYPHENRANGE];e=e.replace(a,T(this.options.includePrerelease)),l("hyphen replace",e),e=e.replace(u[h.COMPARATORTRIM],d),l("comparator trim",e),e=e.replace(u[h.TILDETRIM],p),l("tilde trim",e),e=e.replace(u[h.CARETTRIM],m),l("caret trim",e);let s=e.split(" ").map(e=>_(e,this.options)).join(" ").split(/\s+/).map(e=>k(e,this.options));n&&(s=s.filter(e=>(l("loose invalid filter",e,this.options),!!e.match(u[h.COMPARATORLOOSE])))),l("range list",s);const c=new Map,b=s.map(e=>new o(e,this.options));for(const e of b){if(y(e))return[e];c.set(e.value,e)}c.size>1&&c.has("")&&c.delete("");const w=[...c.values()];return i.set(t,w),w}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Range is required");return this.set.some(r=>w(r,t)&&e.set.some(e=>w(e,t)&&r.every(r=>e.every(e=>r.intersects(e,t)))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new c(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(C(this.set[t],e,this.options))return!0;return!1}}e.exports=a;const i=new(r(639)),s=r(6588),o=r(6635),l=r(6735),c=r(4899),{safeRe:u,t:h,comparatorTrimReplace:d,tildeTrimReplace:p,caretTrimReplace:m}=r(487),{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:g}=r(6261),y=e=>"<0.0.0-0"===e.value,b=e=>""===e.value,w=(e,t)=>{let r=!0;const n=e.slice();let a=n.pop();for(;r&&n.length;)r=n.every(e=>a.intersects(e,t)),a=n.pop();return r},_=(e,t)=>(e=e.replace(u[h.BUILD],""),l("comp",e,t),e=E(e,t),l("caret",e),e=O(e,t),l("tildes",e),e=I(e,t),l("xrange",e),e=S(e,t),l("stars",e),e),v=e=>!e||"x"===e.toLowerCase()||"*"===e,O=(e,t)=>e.trim().split(/\s+/).map(e=>A(e,t)).join(" "),A=(e,t)=>{const r=t.loose?u[h.TILDELOOSE]:u[h.TILDE];return e.replace(r,(t,r,n,a,i)=>{let s;return l("tilde",e,t,r,n,a,i),v(r)?s="":v(n)?s=`>=${r}.0.0 <${+r+1}.0.0-0`:v(a)?s=`>=${r}.${n}.0 <${r}.${+n+1}.0-0`:i?(l("replaceTilde pr",i),s=`>=${r}.${n}.${a}-${i} <${r}.${+n+1}.0-0`):s=`>=${r}.${n}.${a} <${r}.${+n+1}.0-0`,l("tilde return",s),s})},E=(e,t)=>e.trim().split(/\s+/).map(e=>x(e,t)).join(" "),x=(e,t)=>{l("caret",e,t);const r=t.loose?u[h.CARETLOOSE]:u[h.CARET],n=t.includePrerelease?"-0":"";return e.replace(r,(t,r,a,i,s)=>{let o;return l("caret",e,t,r,a,i,s),v(r)?o="":v(a)?o=`>=${r}.0.0${n} <${+r+1}.0.0-0`:v(i)?o="0"===r?`>=${r}.${a}.0${n} <${r}.${+a+1}.0-0`:`>=${r}.${a}.0${n} <${+r+1}.0.0-0`:s?(l("replaceCaret pr",s),o="0"===r?"0"===a?`>=${r}.${a}.${i}-${s} <${r}.${a}.${+i+1}-0`:`>=${r}.${a}.${i}-${s} <${r}.${+a+1}.0-0`:`>=${r}.${a}.${i}-${s} <${+r+1}.0.0-0`):(l("no pr"),o="0"===r?"0"===a?`>=${r}.${a}.${i}${n} <${r}.${a}.${+i+1}-0`:`>=${r}.${a}.${i}${n} <${r}.${+a+1}.0-0`:`>=${r}.${a}.${i} <${+r+1}.0.0-0`),l("caret return",o),o})},I=(e,t)=>(l("replaceXRanges",e,t),e.split(/\s+/).map(e=>P(e,t)).join(" ")),P=(e,t)=>{e=e.trim();const r=t.loose?u[h.XRANGELOOSE]:u[h.XRANGE];return e.replace(r,(r,n,a,i,s,o)=>{l("xRange",e,r,n,a,i,s,o);const c=v(a),u=c||v(i),h=u||v(s),d=h;return"="===n&&d&&(n=""),o=t.includePrerelease?"-0":"",c?r=">"===n||"<"===n?"<0.0.0-0":"*":n&&d?(u&&(i=0),s=0,">"===n?(n=">=",u?(a=+a+1,i=0,s=0):(i=+i+1,s=0)):"<="===n&&(n="<",u?a=+a+1:i=+i+1),"<"===n&&(o="-0"),r=`${n+a}.${i}.${s}${o}`):u?r=`>=${a}.0.0${o} <${+a+1}.0.0-0`:h&&(r=`>=${a}.${i}.0${o} <${a}.${+i+1}.0-0`),l("xRange return",r),r})},S=(e,t)=>(l("replaceStars",e,t),e.trim().replace(u[h.STAR],"")),k=(e,t)=>(l("replaceGTE0",e,t),e.trim().replace(u[t.includePrerelease?h.GTE0PRE:h.GTE0],"")),T=e=>(t,r,n,a,i,s,o,l,c,u,h,d)=>`${r=v(n)?"":v(a)?`>=${n}.0.0${e?"-0":""}`:v(i)?`>=${n}.${a}.0${e?"-0":""}`:s?`>=${r}`:`>=${r}${e?"-0":""}`} ${l=v(c)?"":v(u)?`<${+c+1}.0.0-0`:v(h)?`<${c}.${+u+1}.0-0`:d?`<=${c}.${u}.${h}-${d}`:e?`<${c}.${u}.${+h+1}-0`:`<=${l}`}`.trim(),C=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(l(e[r].semver),e[r].semver!==o.ANY&&e[r].semver.prerelease.length>0){const n=e[r].semver;if(n.major===t.major&&n.minor===t.minor&&n.patch===t.patch)return!0}return!1}return!0}},9583:(e,t,r)=>{"use strict";r.d(t,{Az:()=>o,Ec:()=>s});const n=()=>"undefined"!=typeof Deno,a=()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||n()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":n()?"deno":"other":"node",e};let i;async function s(){if(void 0===i){const e=a();i={library:"langchain-js",runtime:e}}return i}function o(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}},9606:(e,t,r)=>{"use strict";const n=r(4621);e.exports=(e,t,r)=>0!==n(e,t,r)},9624:(e,t,r)=>{"use strict";r.d(t,{g:()=>o});var n=r(4116),a=r(3290);const i=[400,401,402,403,404,405,406,407,409],s=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&i.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class o{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??s;const t=a.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>n(()=>e(...t).catch(e=>{throw e instanceof Error?e:new Error(e)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((t,r)=>{e.signal?.addEventListener("abort",()=>{r(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(e=>e.ok?e:Promise.reject(e)))}}},9641:(e,t,r)=>{"use strict";r.d(t,{U:()=>n.UD});var n=r(6150)},9750:(e,t,r)=>{"use strict";r.d(t,{C_:()=>a,UV:()=>i}),r(8999).y;class n{async getPromptAsync(e,t){return this.getPrompt(e).partial(t?.partialVariables??{})}}class a extends n{constructor(e,t=[]){super(),Object.defineProperty(this,"defaultPrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"conditionals",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.defaultPrompt=e,this.conditionals=t}getPrompt(e){for(const[t,r]of this.conditionals)if(t(e))return r;return this.defaultPrompt}}function i(e){return"base_chat_model"===e._modelType()}},9834:(e,t,r)=>{"use strict";r.d(t,{r:()=>o});var n=r(3279),a=r(4691),i=r(8687),s=r(2778);class o extends s.ZE{get lc_namespace(){return["langchain","chains",this._chainType()]}constructor(e,t,r){if(1!==arguments.length||"object"!=typeof e||"saveContext"in e)super({verbose:t,callbacks:r}),this.memory=e;else{const{memory:t,callbackManager:r,...n}=e;super({...n,callbacks:r??n.callbacks}),this.memory=t}}_selectMemoryInputs(e){const t={...e};return"signal"in t&&delete t.signal,"timeout"in t&&delete t.timeout,t}async invoke(e,t){const r=(0,i.ZI)(t),s=await this._formatValues(e),o=await a.Td.configure(r?.callbacks,this.callbacks,r?.tags,this.tags,r?.metadata,this.metadata,{verbose:this.verbose}),l=await(o?.handleChainStart(this.toJSON(),s,void 0,void 0,void 0,void 0,r?.runName));let c;try{c=await(s.signal?Promise.race([this._call(s,l,r),new Promise((e,t)=>{s.signal?.addEventListener("abort",()=>{t(new Error("AbortError"))})})]):this._call(s,l,r))}catch(e){throw await(l?.handleChainError(e)),e}return null!=this.memory&&await this.memory.saveContext(this._selectMemoryInputs(e),c),await(l?.handleChainEnd(c)),Object.defineProperty(c,n.SP,{value:l?{runId:l?.runId}:void 0,configurable:!0}),c}_validateOutputs(e){const t=this.outputKeys.filter(t=>!(t in e));if(t.length)throw new Error(`Missing output keys: ${t.join(", ")} from chain ${this._chainType()}`)}async prepOutputs(e,t,r=!1){return this._validateOutputs(t),this.memory&&await this.memory.saveContext(e,t),r?t:{...e,...t}}serialize(){throw new Error("Method not implemented.")}async run(e,t){const r=this.inputKeys.filter(e=>!this.memory?.memoryKeys.includes(e)??!0);if(!(r.length<=1))throw new Error(`Chain ${this._chainType()} expects multiple inputs, cannot use 'run' `);const n=r.length?{[r[0]]:e}:{},a=await this.call(n,t),i=Object.keys(a);if(1===i.length)return a[i[0]];throw new Error("return values have multiple keys, `run` only supported when one key currently")}async _formatValues(e){const t={...e};if(t.timeout&&!t.signal&&(t.signal=AbortSignal.timeout(t.timeout),delete t.timeout),null!=this.memory){const r=await this.memory.loadMemoryVariables(this._selectMemoryInputs(e));for(const[e,n]of Object.entries(r))t[e]=n}return t}async call(e,t,r){const n={tags:r,...(0,a.H_)(t)};return this.invoke(e,n)}async apply(e,t){return Promise.all(e.map(async(e,r)=>this.call(e,t?.[r])))}static async deserialize(e,t={}){switch(e._type){case"llm_chain":{const{LLMChain:t}=await Promise.resolve().then(r.bind(r,6768));return t.deserialize(e)}case"sequential_chain":{const{SequentialChain:t}=await Promise.resolve().then(r.bind(r,3091));return t.deserialize(e)}case"simple_sequential_chain":{const{SimpleSequentialChain:t}=await Promise.resolve().then(r.bind(r,3091));return t.deserialize(e)}case"stuff_documents_chain":{const{StuffDocumentsChain:t}=await Promise.resolve().then(r.bind(r,3382));return t.deserialize(e)}case"map_reduce_documents_chain":{const{MapReduceDocumentsChain:t}=await Promise.resolve().then(r.bind(r,3382));return t.deserialize(e)}case"refine_documents_chain":{const{RefineDocumentsChain:t}=await Promise.resolve().then(r.bind(r,3382));return t.deserialize(e)}case"vector_db_qa":{const{VectorDBQAChain:n}=await Promise.resolve().then(r.bind(r,3296));return n.deserialize(e,t)}case"api_chain":{const{APIChain:t}=await Promise.resolve().then(r.bind(r,9980));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}},9849:(e,t,r)=>{"use strict";r.d(t,{Ns:()=>k,D4:()=>E,QC:()=>S,Xm:()=>P});var n=Object.prototype.toString,a=Array.isArray||function(e){return"[object Array]"===n.call(e)};function i(e){return"function"==typeof e}function s(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function o(e,t){return null!=e&&"object"==typeof e&&t in e}function l(e,t){return null!=e&&"object"!=typeof e&&e.hasOwnProperty&&e.hasOwnProperty(t)}var c=RegExp.prototype.test,u=/\S/;function h(e){return!function(e,t){return c.call(e,t)}(u,e)}var d={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},p=/\s*/,m=/\s+/,f=/\s*=/,g=/\s*\}/,y=/#|\^|\/|>|\{|&|=|!/;function b(e){this.string=e,this.tail=e,this.pos=0}function w(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function _(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}b.prototype.eos=function(){return""===this.tail},b.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var r=t[0];return this.tail=this.tail.substring(r.length),this.pos+=r.length,r},b.prototype.scanUntil=function(e){var t,r=this.tail.search(e);switch(r){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,r),this.tail=this.tail.substring(r)}return this.pos+=t.length,t},w.prototype.push=function(e){return new w(e,this)},w.prototype.lookup=function(e){var t,r=this.cache;if(r.hasOwnProperty(e))t=r[e];else{for(var n,a,s,c=this,u=!1;c;){if(e.indexOf(".")>0)for(n=c.view,a=e.split("."),s=0;null!=n&&s<a.length;)s===a.length-1&&(u=o(n,a[s])||l(n,a[s])),n=n[a[s++]];else n=c.view[e],u=o(c.view,e);if(u){t=n;break}c=c.parent}r[e]=t}return i(t)&&(t=t.call(this.view)),t},_.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},_.prototype.parse=function(e,t){var r=this.templateCache,n=e+":"+(t||v.tags).join(":"),i=void 0!==r,o=i?r.get(n):void 0;return null==o&&(o=function(e,t){if(!e)return[];var r,n,i,o=!1,l=[],c=[],u=[],d=!1,w=!1,_="",O=0;function A(){if(d&&!w)for(;u.length;)delete c[u.pop()];else u=[];d=!1,w=!1}function E(e){if("string"==typeof e&&(e=e.split(m,2)),!a(e)||2!==e.length)throw new Error("Invalid tags: "+e);r=new RegExp(s(e[0])+"\\s*"),n=new RegExp("\\s*"+s(e[1])),i=new RegExp("\\s*"+s("}"+e[1]))}E(t||v.tags);for(var x,I,P,S,k,T,C=new b(e);!C.eos();){if(x=C.pos,P=C.scanUntil(r))for(var j=0,N=P.length;j<N;++j)h(S=P.charAt(j))?(u.push(c.length),_+=S):(w=!0,o=!0,_+=" "),c.push(["text",S,x,x+1]),x+=1,"\n"===S&&(A(),_="",O=0,o=!1);if(!C.scan(r))break;if(d=!0,I=C.scan(y)||"name",C.scan(p),"="===I?(P=C.scanUntil(f),C.scan(f),C.scanUntil(n)):"{"===I?(P=C.scanUntil(i),C.scan(g),C.scanUntil(n),I="&"):P=C.scanUntil(n),!C.scan(n))throw new Error("Unclosed tag at "+C.pos);if(k=">"==I?[I,P,x,C.pos,_,O,o]:[I,P,x,C.pos],O++,c.push(k),"#"===I||"^"===I)l.push(k);else if("/"===I){if(!(T=l.pop()))throw new Error('Unopened section "'+P+'" at '+x);if(T[1]!==P)throw new Error('Unclosed section "'+T[1]+'" at '+x)}else"name"===I||"{"===I||"&"===I?w=!0:"="===I&&E(P)}if(A(),T=l.pop())throw new Error('Unclosed section "'+T[1]+'" at '+C.pos);return function(e){for(var t,r=[],n=r,a=[],i=0,s=e.length;i<s;++i)switch((t=e[i])[0]){case"#":case"^":n.push(t),a.push(t),n=t[4]=[];break;case"/":a.pop()[5]=t[2],n=a.length>0?a[a.length-1][4]:r;break;default:n.push(t)}return r}(function(e){for(var t,r,n=[],a=0,i=e.length;a<i;++a)(t=e[a])&&("text"===t[0]&&r&&"text"===r[0]?(r[1]+=t[1],r[3]=t[3]):(n.push(t),r=t));return n}(c))}(e,t),i&&r.set(n,o)),o},_.prototype.render=function(e,t,r,n){var a=this.getConfigTags(n),i=this.parse(e,a),s=t instanceof w?t:new w(t,void 0);return this.renderTokens(i,s,r,e,n)},_.prototype.renderTokens=function(e,t,r,n,a){for(var i,s,o,l="",c=0,u=e.length;c<u;++c)o=void 0,"#"===(s=(i=e[c])[0])?o=this.renderSection(i,t,r,n,a):"^"===s?o=this.renderInverted(i,t,r,n,a):">"===s?o=this.renderPartial(i,t,r,a):"&"===s?o=this.unescapedValue(i,t):"name"===s?o=this.escapedValue(i,t,a):"text"===s&&(o=this.rawValue(i)),void 0!==o&&(l+=o);return l},_.prototype.renderSection=function(e,t,r,n,s){var o=this,l="",c=t.lookup(e[1]);if(c){if(a(c))for(var u=0,h=c.length;u<h;++u)l+=this.renderTokens(e[4],t.push(c[u]),r,n,s);else if("object"==typeof c||"string"==typeof c||"number"==typeof c)l+=this.renderTokens(e[4],t.push(c),r,n,s);else if(i(c)){if("string"!=typeof n)throw new Error("Cannot use higher-order sections without the original template");null!=(c=c.call(t.view,n.slice(e[3],e[5]),function(e){return o.render(e,t,r,s)}))&&(l+=c)}else l+=this.renderTokens(e[4],t,r,n,s);return l}},_.prototype.renderInverted=function(e,t,r,n,i){var s=t.lookup(e[1]);if(!s||a(s)&&0===s.length)return this.renderTokens(e[4],t,r,n,i)},_.prototype.indentPartial=function(e,t,r){for(var n=t.replace(/[^ \t]/g,""),a=e.split("\n"),i=0;i<a.length;i++)a[i].length&&(i>0||!r)&&(a[i]=n+a[i]);return a.join("\n")},_.prototype.renderPartial=function(e,t,r,n){if(r){var a=this.getConfigTags(n),s=i(r)?r(e[1]):r[e[1]];if(null!=s){var o=e[6],l=e[5],c=e[4],u=s;0==l&&c&&(u=this.indentPartial(s,c,o));var h=this.parse(u,a);return this.renderTokens(h,t,r,u,n)}}},_.prototype.unescapedValue=function(e,t){var r=t.lookup(e[1]);if(null!=r)return r},_.prototype.escapedValue=function(e,t,r){var n=this.getConfigEscape(r)||v.escape,a=t.lookup(e[1]);if(null!=a)return"number"==typeof a&&n===v.escape?String(a):n(a)},_.prototype.rawValue=function(e){return e[1]},_.prototype.getConfigTags=function(e){return a(e)?e:e&&"object"==typeof e?e.tags:void 0},_.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!a(e)?e.escape:void 0};var v={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){O.templateCache=e},get templateCache(){return O.templateCache}},O=new _;v.clearCache=function(){return O.clearCache()},v.parse=function(e,t){return O.parse(e,t)},v.render=function(e,t,r,n){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+(a(i=e)?"array":typeof i)+'" was given as the first argument for mustache#render(template, view, partials)');var i;return O.render(e,t,r,n)},v.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return d[e]})},v.Scanner=b,v.Context=w,v.Writer=_;const A=v,E=e=>{const t=e.split(""),r=[],n=(e,r)=>{for(let n=r;n<t.length;n+=1)if(e.includes(t[n]))return n;return-1};let a=0;for(;a<t.length;)if("{"===t[a]&&a+1<t.length&&"{"===t[a+1])r.push({type:"literal",text:"{"}),a+=2;else if("}"===t[a]&&a+1<t.length&&"}"===t[a+1])r.push({type:"literal",text:"}"}),a+=2;else if("{"===t[a]){const e=n("}",a);if(e<0)throw new Error("Unclosed '{' in template.");r.push({type:"variable",name:t.slice(a+1,e).join("")}),a=e+1}else{if("}"===t[a])throw new Error("Single '}' in template.");{const e=n("{}",a),i=(e<0?t.slice(a):t.slice(a,e)).join("");r.push({type:"literal",text:i}),a=e<0?t.length:e}}return r},x={"f-string":(e,t)=>E(e).reduce((e,r)=>{if("variable"===r.type){if(r.name in t)return e+t[r.name];throw new Error(`(f-string) Missing value for input ${r.name}`)}return e+r.text},""),mustache:(e,t)=>A.render(e,t)},I={"f-string":E,mustache:e=>(e=>e.map(e=>"name"===e[0]?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:"#"===e[0]?{type:"variable",name:e[1]}:{type:"literal",text:e[1]}))(A.parse(e))},P=(e,t,r)=>x[t](e,r),S=(e,t)=>I[t](e),k=(e,t,r)=>{if(!(t in x)){const e=Object.keys(x);throw new Error(`Invalid template format. Got \`${t}\`;\n                         should be one of ${e}`)}try{const n=r.reduce((e,t)=>(e[t]="foo",e),{});Array.isArray(e)?e.forEach(e=>{if("text"===e.type)P(e.text,t,n);else{if("image_url"!==e.type)throw new Error(`Invalid message template received. ${JSON.stringify(e,null,2)}`);if("string"==typeof e.image_url)P(e.image_url,t,n);else{const r=e.image_url.url;P(r,t,n)}}}):P(e,t,n)}catch(e){throw new Error(`Invalid prompt schema: ${e.message}`)}}},9855:(e,t,r)=>{"use strict";const n=r(7737);e.exports=(e,t)=>{const r=n(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null}},9881:(e,t,r)=>{"use strict";const n=r(9558),a=r(6635),{ANY:i}=a,s=r(995),o=r(4621),l=[new a(">=0.0.0-0")],c=[new a(">=0.0.0")],u=(e,t,r)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===i){if(1===t.length&&t[0].semver===i)return!0;e=r.includePrerelease?l:c}if(1===t.length&&t[0].semver===i){if(r.includePrerelease)return!0;t=c}const n=new Set;let a,u,p,m,f,g,y;for(const t of e)">"===t.operator||">="===t.operator?a=h(a,t,r):"<"===t.operator||"<="===t.operator?u=d(u,t,r):n.add(t.semver);if(n.size>1)return null;if(a&&u){if(p=o(a.semver,u.semver,r),p>0)return null;if(0===p&&(">="!==a.operator||"<="!==u.operator))return null}for(const e of n){if(a&&!s(e,String(a),r))return null;if(u&&!s(e,String(u),r))return null;for(const n of t)if(!s(e,String(n),r))return!1;return!0}let b=!(!u||r.includePrerelease||!u.semver.prerelease.length)&&u.semver,w=!(!a||r.includePrerelease||!a.semver.prerelease.length)&&a.semver;b&&1===b.prerelease.length&&"<"===u.operator&&0===b.prerelease[0]&&(b=!1);for(const e of t){if(y=y||">"===e.operator||">="===e.operator,g=g||"<"===e.operator||"<="===e.operator,a)if(w&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===w.major&&e.semver.minor===w.minor&&e.semver.patch===w.patch&&(w=!1),">"===e.operator||">="===e.operator){if(m=h(a,e,r),m===e&&m!==a)return!1}else if(">="===a.operator&&!s(a.semver,String(e),r))return!1;if(u)if(b&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===b.major&&e.semver.minor===b.minor&&e.semver.patch===b.patch&&(b=!1),"<"===e.operator||"<="===e.operator){if(f=d(u,e,r),f===e&&f!==u)return!1}else if("<="===u.operator&&!s(u.semver,String(e),r))return!1;if(!e.operator&&(u||a)&&0!==p)return!1}return!(a&&g&&!u&&0!==p||u&&y&&!a&&0!==p||w||b)},h=(e,t,r)=>{if(!e)return t;const n=o(e.semver,t.semver,r);return n>0?e:n<0||">"===t.operator&&">="===e.operator?t:e},d=(e,t,r)=>{if(!e)return t;const n=o(e.semver,t.semver,r);return n<0?e:n>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,r={})=>{if(e===t)return!0;e=new n(e,r),t=new n(t,r);let a=!1;e:for(const n of e.set){for(const e of t.set){const t=u(n,e,r);if(a=a||null!==t,t)continue e}if(a)return!1}return!0}},9980:(e,t,r)=>{"use strict";r.d(t,{APIChain:()=>u});var n=r(9834),a=r(6768),i=r(6446);const s="You are given the below API Documentation:\n{api_docs}\nUsing this documentation, generate the full API url to call for answering the user question.\nYou should build the API url in order to get a response that is as short as possible, while still getting the necessary information to answer the question. Pay attention to deliberately exclude any unnecessary pieces of data in the API call.\n\nQuestion:{question}\nAPI url:",o=new i.Hh({inputVariables:["api_docs","question"],template:s}),l=`${s} {api_url}\n\nHere is the response from the API:\n\n{api_response}\n\nSummarize this response to answer the original question.\n\nSummary:`,c=new i.Hh({inputVariables:["api_docs","question","api_url","api_response"],template:l});class u extends n.r{get inputKeys(){return[this.inputKey]}get outputKeys(){return[this.outputKey]}constructor(e){super(e),Object.defineProperty(this,"apiAnswerChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiRequestChain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiDocs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"headers",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inputKey",{enumerable:!0,configurable:!0,writable:!0,value:"question"}),Object.defineProperty(this,"outputKey",{enumerable:!0,configurable:!0,writable:!0,value:"output"}),this.apiRequestChain=e.apiRequestChain,this.apiAnswerChain=e.apiAnswerChain,this.apiDocs=e.apiDocs,this.inputKey=e.inputKey??this.inputKey,this.outputKey=e.outputKey??this.outputKey,this.headers=e.headers??this.headers}async _call(e,t){const r=e[this.inputKey],n=await this.apiRequestChain.predict({question:r,api_docs:this.apiDocs},t?.getChild("request")),a=await fetch(n,{headers:this.headers}),i=await a.text(),s=await this.apiAnswerChain.predict({question:r,api_docs:this.apiDocs,api_url:n,api_response:i},t?.getChild("response"));return{[this.outputKey]:s}}_chainType(){return"api_chain"}static async deserialize(e){const{api_request_chain:t,api_answer_chain:r,api_docs:n}=e;if(!t)throw new Error("LLMChain must have api_request_chain");if(!r)throw new Error("LLMChain must have api_answer_chain");if(!n)throw new Error("LLMChain must have api_docs");return new u({apiAnswerChain:await a.LLMChain.deserialize(r),apiRequestChain:await a.LLMChain.deserialize(t),apiDocs:n})}serialize(){return{_type:this._chainType(),api_answer_chain:this.apiAnswerChain.serialize(),api_request_chain:this.apiRequestChain.serialize(),api_docs:this.apiDocs}}static fromLLMAndAPIDocs(e,t,r={}){const{apiUrlPrompt:n=o,apiResponsePrompt:i=c}=r,s=new a.LLMChain({prompt:n,llm:e});return new this({apiAnswerChain:new a.LLMChain({prompt:i,llm:e}),apiRequestChain:s,apiDocs:t,...r})}}},9998:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){let n=0,a=e.length;for(;a>0;){const i=a/2|0;let s=n+i;r(e[s],t)<=0?(n=++s,a-=i+1):a=i}return n}}},r={};function n(e){var a=r[e];if(void 0!==a)return a.exports;var i=r[e]={id:e,loaded:!1,exports:{}};return t[e](i,i.exports,n),i.loaded=!0,i.exports}n.m=t,e=[],n.O=(t,r,a,i)=>{if(!r){var s=1/0;for(u=0;u<e.length;u++){for(var[r,a,i]=e[u],o=!0,l=0;l<r.length;l++)(!1&i||s>=i)&&Object.keys(n.O).every(e=>n.O[e](r[l]))?r.splice(l--,1):(o=!1,i<s&&(s=i));if(o){e.splice(u--,1);var c=a();void 0!==c&&(t=c)}}return t}i=i||0;for(var u=e.length;u>0&&e[u-1][2]>i;u--)e[u]=e[u-1];e[u]=[r,a,i]},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={57:0,350:0};n.O.j=t=>0===e[t];var t=(t,r)=>{var a,i,[s,o,l]=r,c=0;if(s.some(t=>0!==e[t])){for(a in o)n.o(o,a)&&(n.m[a]=o[a]);if(l)var u=l(n)}for(t&&t(r);c<s.length;c++)i=s[c],n.o(e,i)&&e[i]&&e[i][0](),e[i]=0;return n.O(u)},r=globalThis.webpackChunkwp_langchain_integration=globalThis.webpackChunkwp_langchain_integration||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var a=n.O(void 0,[350],()=>n(156));a=n.O(a)})();