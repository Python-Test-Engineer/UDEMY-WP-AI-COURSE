(()=>{"use strict";var e,t={204:e=>{const t=/^[0-9]+$/,n=(e,n)=>{if("number"==typeof e&&"number"==typeof n)return e===n?0:e<n?-1:1;const r=t.test(e),s=t.test(n);return r&&s&&(e=+e,n=+n),e===n?0:r&&!s?-1:s&&!r?1:e<n?-1:1};e.exports={compareIdentifiers:n,rcompareIdentifiers:(e,t)=>n(t,e)}},228:e=>{var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,i),c=n?n+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function i(e,t){0===--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,i=new Array(a);s<a;s++)i[s]=r[s].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,i){var o=n?n+e:e;if(!this._events[o])return!1;var c,l,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,i),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var p,h=u.length;for(l=0;l<h;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,r);break;case 4:u[l].fn.call(u[l].context,t,r,s);break;default:if(!c)for(p=1,c=new Array(d-1);p<d;p++)c[p-1]=arguments[p];u[l].fn.apply(u[l].context,c)}}return!0},o.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return i(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||i(this,a);else{for(var c=0,l=[],u=o.length;c<u;c++)(o[c].fn!==t||s&&!o[c].once||r&&o[c].context!==r)&&l.push(o[c]);l.length?this._events[a]=1===l.length?l[0]:l:i(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o},487:(e,t,n)=>{const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:s,MAX_LENGTH:a}=n(6261),i=n(6735),o=(t=e.exports={}).re=[],c=t.safeRe=[],l=t.src=[],u=t.safeSrc=[],d=t.t={};let p=0;const h="[a-zA-Z0-9-]",m=[["\\s",1],["\\d",a],[h,s]],f=(e,t,n)=>{const r=(e=>{for(const[t,n]of m)e=e.split(`${t}*`).join(`${t}{0,${n}}`).split(`${t}+`).join(`${t}{1,${n}}`);return e})(t),s=p++;i(e,s,t),d[e]=s,l[s]=t,u[s]=r,o[s]=new RegExp(t,n?"g":void 0),c[s]=new RegExp(r,n?"g":void 0)};f("NUMERICIDENTIFIER","0|[1-9]\\d*"),f("NUMERICIDENTIFIERLOOSE","\\d+"),f("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${h}*`),f("MAINVERSION",`(${l[d.NUMERICIDENTIFIER]})\\.(${l[d.NUMERICIDENTIFIER]})\\.(${l[d.NUMERICIDENTIFIER]})`),f("MAINVERSIONLOOSE",`(${l[d.NUMERICIDENTIFIERLOOSE]})\\.(${l[d.NUMERICIDENTIFIERLOOSE]})\\.(${l[d.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASEIDENTIFIER",`(?:${l[d.NONNUMERICIDENTIFIER]}|${l[d.NUMERICIDENTIFIER]})`),f("PRERELEASEIDENTIFIERLOOSE",`(?:${l[d.NONNUMERICIDENTIFIER]}|${l[d.NUMERICIDENTIFIERLOOSE]})`),f("PRERELEASE",`(?:-(${l[d.PRERELEASEIDENTIFIER]}(?:\\.${l[d.PRERELEASEIDENTIFIER]})*))`),f("PRERELEASELOOSE",`(?:-?(${l[d.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[d.PRERELEASEIDENTIFIERLOOSE]})*))`),f("BUILDIDENTIFIER",`${h}+`),f("BUILD",`(?:\\+(${l[d.BUILDIDENTIFIER]}(?:\\.${l[d.BUILDIDENTIFIER]})*))`),f("FULLPLAIN",`v?${l[d.MAINVERSION]}${l[d.PRERELEASE]}?${l[d.BUILD]}?`),f("FULL",`^${l[d.FULLPLAIN]}$`),f("LOOSEPLAIN",`[v=\\s]*${l[d.MAINVERSIONLOOSE]}${l[d.PRERELEASELOOSE]}?${l[d.BUILD]}?`),f("LOOSE",`^${l[d.LOOSEPLAIN]}$`),f("GTLT","((?:<|>)?=?)"),f("XRANGEIDENTIFIERLOOSE",`${l[d.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),f("XRANGEIDENTIFIER",`${l[d.NUMERICIDENTIFIER]}|x|X|\\*`),f("XRANGEPLAIN",`[v=\\s]*(${l[d.XRANGEIDENTIFIER]})(?:\\.(${l[d.XRANGEIDENTIFIER]})(?:\\.(${l[d.XRANGEIDENTIFIER]})(?:${l[d.PRERELEASE]})?${l[d.BUILD]}?)?)?`),f("XRANGEPLAINLOOSE",`[v=\\s]*(${l[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[d.XRANGEIDENTIFIERLOOSE]})(?:${l[d.PRERELEASELOOSE]})?${l[d.BUILD]}?)?)?`),f("XRANGE",`^${l[d.GTLT]}\\s*${l[d.XRANGEPLAIN]}$`),f("XRANGELOOSE",`^${l[d.GTLT]}\\s*${l[d.XRANGEPLAINLOOSE]}$`),f("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),f("COERCE",`${l[d.COERCEPLAIN]}(?:$|[^\\d])`),f("COERCEFULL",l[d.COERCEPLAIN]+`(?:${l[d.PRERELEASE]})?`+`(?:${l[d.BUILD]})?(?:$|[^\\d])`),f("COERCERTL",l[d.COERCE],!0),f("COERCERTLFULL",l[d.COERCEFULL],!0),f("LONETILDE","(?:~>?)"),f("TILDETRIM",`(\\s*)${l[d.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",f("TILDE",`^${l[d.LONETILDE]}${l[d.XRANGEPLAIN]}$`),f("TILDELOOSE",`^${l[d.LONETILDE]}${l[d.XRANGEPLAINLOOSE]}$`),f("LONECARET","(?:\\^)"),f("CARETTRIM",`(\\s*)${l[d.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",f("CARET",`^${l[d.LONECARET]}${l[d.XRANGEPLAIN]}$`),f("CARETLOOSE",`^${l[d.LONECARET]}${l[d.XRANGEPLAINLOOSE]}$`),f("COMPARATORLOOSE",`^${l[d.GTLT]}\\s*(${l[d.LOOSEPLAIN]})$|^$`),f("COMPARATOR",`^${l[d.GTLT]}\\s*(${l[d.FULLPLAIN]})$|^$`),f("COMPARATORTRIM",`(\\s*)${l[d.GTLT]}\\s*(${l[d.LOOSEPLAIN]}|${l[d.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",f("HYPHENRANGE",`^\\s*(${l[d.XRANGEPLAIN]})\\s+-\\s+(${l[d.XRANGEPLAIN]})\\s*$`),f("HYPHENRANGELOOSE",`^\\s*(${l[d.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[d.XRANGEPLAINLOOSE]})\\s*$`),f("STAR","(<|>)?=?\\s*\\*"),f("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),f("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},534:(e,t,n)=>{const r=n(9558);e.exports=(e,t)=>new r(e,t).set.map(e=>e.map(e=>e.value).join(" ").trim().split(" "))},547:(e,t,n)=>{const r=n(4899);e.exports=(e,t)=>new r(e,t).minor},639:e=>{e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},753:(e,t,n)=>{const r=n(9558);e.exports=(e,t,n)=>(e=new r(e,n),t=new r(t,n),e.intersects(t,n))},818:(e,t,n)=>{const r=n(4621);e.exports=(e,t,n)=>0===r(e,t,n)},995:(e,t,n)=>{const r=n(9558);e.exports=(e,t,n)=>{try{t=new r(t,n)}catch(e){return!1}return t.test(e)}},1534:(e,t,n)=>{const r=n(818),s=n(9606),a=n(2559),i=n(7372),o=n(4056),c=n(6133);e.exports=(e,t,n,l)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e===n;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e!==n;case"":case"=":case"==":return r(e,n,l);case"!=":return s(e,n,l);case">":return a(e,n,l);case">=":return i(e,n,l);case"<":return o(e,n,l);case"<=":return c(e,n,l);default:throw new TypeError(`Invalid operator: ${t}`)}}},1620:(e,t,n)=>{const r=n(995),s=n(4621);e.exports=(e,t,n)=>{const a=[];let i=null,o=null;const c=e.sort((e,t)=>s(e,t,n));for(const e of c)r(e,t,n)?(o=e,i||(i=e)):(o&&a.push([i,o]),o=null,i=null);i&&a.push([i,null]);const l=[];for(const[e,t]of a)e===t?l.push(e):t||e!==c[0]?t?e===c[0]?l.push(`<=${t}`):l.push(`${e} - ${t}`):l.push(`>=${e}`):l.push("*");const u=l.join(" || "),d="string"==typeof t.raw?t.raw:String(t);return u.length<d.length?u:t}},2153:(e,t,n)=>{const r=n(9558);e.exports=(e,t)=>{try{return new r(e,t).range||"*"}catch(e){return null}}},2469:(e,t,n)=>{const r=n(4621);e.exports=(e,t,n)=>r(t,e,n)},2559:(e,t,n)=>{const r=n(4621);e.exports=(e,t,n)=>r(e,t,n)>0},2729:e=>{const t=/[\p{Lu}]/u,n=/[\p{Ll}]/u,r=/^[\p{Lu}](?![\p{Lu}])/gu,s=/([\p{Alpha}\p{N}_]|$)/u,a=/[_.\- ]+/,i=new RegExp("^"+a.source),o=new RegExp(a.source+s.source,"gu"),c=new RegExp("\\d+"+s.source,"gu"),l=(e,s)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(s={pascalCase:!1,preserveConsecutiveUppercase:!1,...s},0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length)return"";const a=!1===s.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(s.locale),l=!1===s.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(s.locale);return 1===e.length?s.pascalCase?l(e):a(e):(e!==a(e)&&(e=((e,r,s)=>{let a=!1,i=!1,o=!1;for(let c=0;c<e.length;c++){const l=e[c];a&&t.test(l)?(e=e.slice(0,c)+"-"+e.slice(c),a=!1,o=i,i=!0,c++):i&&o&&n.test(l)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=i,i=!1,a=!0):(a=r(l)===l&&s(l)!==l,o=i,i=s(l)===l&&r(l)!==l)}return e})(e,a,l)),e=e.replace(i,""),e=s.preserveConsecutiveUppercase?((e,t)=>(r.lastIndex=0,e.replace(r,e=>t(e))))(e,a):a(e),s.pascalCase&&(e=l(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,(e,n)=>t(n)).replace(c,e=>t(e))))(e,l))};e.exports=l,e.exports.default=l},3042:(e,t,n)=>{const r=n(4621);e.exports=(e,t)=>r(e,t,!0)},3290:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(228),s=n(6641),a=n(4774),i=()=>{},o=new s.TimeoutError;t.default=class extends r{constructor(e){var t,n,r,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=i,this._resolveIdle=i,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:a.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(s=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==s?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=i,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=i,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((n,r)=>{this._queue.enqueue(async()=>{this._pendingCount++,this._intervalCount++;try{const a=void 0===this._timeout&&void 0===t.timeout?e():s.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(o)});n(await a)}catch(e){r(e)}this._next()},t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},3602:(e,t,n)=>{const r=n(4899),s=n(9558),a=n(2559);e.exports=(e,t)=>{e=new s(e,t);let n=new r("0.0.0");if(e.test(n))return n;if(n=new r("0.0.0-0"),e.test(n))return n;n=null;for(let t=0;t<e.set.length;++t){const s=e.set[t];let i=null;s.forEach(e=>{const t=new r(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":i&&!a(t,i)||(i=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}}),!i||n&&!a(n,i)||(n=i)}return n&&e.test(n)?n:null}},3690:(e,t,n)=>{const r=n(7737);e.exports=(e,t)=>{const n=r(e,t);return n&&n.prerelease.length?n.prerelease:null}},3767:(e,t,n)=>{const r=n(4899);e.exports=(e,t)=>new r(e,t).major},4004:(e,t,n)=>{const r=n(7737);e.exports=(e,t)=>{const n=r(e,t);return n?n.version:null}},4056:(e,t,n)=>{const r=n(4621);e.exports=(e,t,n)=>r(e,t,n)<0},4076:(e,t,n)=>{const r=n(6592);e.exports=(e,t,n)=>r(e,t,">",n)},4083:(e,t,n)=>{e=n.nmd(e);const r=(e=0)=>t=>`[${38+e};5;${t}m`,s=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[n,r]of Object.entries(t)){for(const[n,s]of Object.entries(r))t[n]={open:`[${s[0]}m`,close:`[${s[1]}m`},r[n]=t[n],e.set(s[0],s[1]);Object.defineProperty(t,n,{value:r,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=r(),t.color.ansi16m=s(),t.bgColor.ansi256=r(10),t.bgColor.ansi16m=s(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map(e=>e+e).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},4106:(e,t,n)=>{const r=n(4899);e.exports=(e,t,n,s,a)=>{"string"==typeof n&&(a=s,s=n,n=void 0);try{return new r(e instanceof r?e.version:e,n).inc(t,s,a).version}catch(e){return null}}},4453:(e,t,n)=>{const r=n(6592);e.exports=(e,t,n)=>r(e,t,"<",n)},4617:e=>{e.exports=(e,t)=>(t=t||(()=>{}),e.then(e=>new Promise(e=>{e(t())}).then(()=>e),e=>new Promise(e=>{e(t())}).then(()=>{throw e})))},4621:(e,t,n)=>{const r=n(4899);e.exports=(e,t,n)=>new r(e,n).compare(new r(t,n))},4774:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const r=n(9998);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const s=r.default(this._queue,n,(e,t)=>t.priority-e.priority);this._queue.splice(s,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this._queue.length}}},4899:(e,t,n)=>{const r=n(6735),{MAX_LENGTH:s,MAX_SAFE_INTEGER:a}=n(6261),{safeRe:i,t:o}=n(487),c=n(6588),{compareIdentifiers:l}=n(204);class u{constructor(e,t){if(t=c(t),e instanceof u){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>s)throw new TypeError(`version is longer than ${s} characters`);r("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const n=e.trim().match(t.loose?i[o.LOOSE]:i[o.FULL]);if(!n)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+n[1],this.minor=+n[2],this.patch=+n[3],this.major>a||this.major<0)throw new TypeError("Invalid major version");if(this.minor>a||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>a||this.patch<0)throw new TypeError("Invalid patch version");n[4]?this.prerelease=n[4].split(".").map(e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<a)return t}return e}):this.prerelease=[],this.build=n[5]?n[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(r("SemVer.compare",this.version,this.options,e),!(e instanceof u)){if("string"==typeof e&&e===this.version)return 0;e=new u(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof u||(e=new u(e,this.options)),this.major<e.major?-1:this.major>e.major?1:this.minor<e.minor?-1:this.minor>e.minor?1:this.patch<e.patch?-1:this.patch>e.patch?1:0}comparePre(e){if(e instanceof u||(e=new u(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const n=this.prerelease[t],s=e.prerelease[t];if(r("prerelease compare",t,n,s),void 0===n&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===n)return-1;if(n!==s)return l(n,s)}while(++t)}compareBuild(e){e instanceof u||(e=new u(e,this.options));let t=0;do{const n=this.build[t],s=e.build[t];if(r("build compare",t,n,s),void 0===n&&void 0===s)return 0;if(void 0===s)return 1;if(void 0===n)return-1;if(n!==s)return l(n,s)}while(++t)}inc(e,t,n){if(e.startsWith("pre")){if(!t&&!1===n)throw new Error("invalid increment argument: identifier is empty");if(t){const e=`-${t}`.match(this.options.loose?i[o.PRERELEASELOOSE]:i[o.PRERELEASE]);if(!e||e[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"release":if(0===this.prerelease.length)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(n)?1:0;if(0===this.prerelease.length)this.prerelease=[e];else{let r=this.prerelease.length;for(;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);if(-1===r){if(t===this.prerelease.join(".")&&!1===n)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let r=[t,e];!1===n&&(r=[t]),0===l(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=r):this.prerelease=r}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=u},5985:(e,t,n)=>{const r=n(4899),s=n(9558);e.exports=(e,t,n)=>{let a=null,i=null,o=null;try{o=new s(t,n)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(a&&-1!==i.compare(e)||(a=e,i=new r(a,n)))}),a}},6133:(e,t,n)=>{const r=n(4621);e.exports=(e,t,n)=>r(e,t,n)<=0},6261:e=>{const t=Number.MAX_SAFE_INTEGER||9007199254740991;e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},6588:e=>{const t=Object.freeze({loose:!0}),n=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:n},6592:(e,t,n)=>{const r=n(4899),s=n(6635),{ANY:a}=s,i=n(9558),o=n(995),c=n(2559),l=n(4056),u=n(6133),d=n(7372);e.exports=(e,t,n,p)=>{let h,m,f,g,y;switch(e=new r(e,p),t=new i(t,p),n){case">":h=c,m=u,f=l,g=">",y=">=";break;case"<":h=l,m=d,f=c,g="<",y="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,p))return!1;for(let n=0;n<t.set.length;++n){const r=t.set[n];let i=null,o=null;if(r.forEach(e=>{e.semver===a&&(e=new s(">=0.0.0")),i=i||e,o=o||e,h(e.semver,i.semver,p)?i=e:f(e.semver,o.semver,p)&&(o=e)}),i.operator===g||i.operator===y)return!1;if((!o.operator||o.operator===g)&&m(e,o.semver))return!1;if(o.operator===y&&f(e,o.semver))return!1}return!0}},6635:(e,t,n)=>{const r=Symbol("SemVer ANY");class s{static get ANY(){return r}constructor(e,t){if(t=a(t),e instanceof s){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),l("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===r?this.value="":this.value=this.operator+this.semver.version,l("comp",this)}parse(e){const t=this.options.loose?i[o.COMPARATORLOOSE]:i[o.COMPARATOR],n=e.match(t);if(!n)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==n[1]?n[1]:"","="===this.operator&&(this.operator=""),n[2]?this.semver=new u(n[2],this.options.loose):this.semver=r}toString(){return this.value}test(e){if(l("Comparator.test",e,this.options.loose),this.semver===r||e===r)return!0;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}return c(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof s))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new d(e.value,t).test(this.value):""===e.operator?""===e.value||new d(this.value,t).test(e.semver):!((t=a(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))||(!this.operator.startsWith(">")||!e.operator.startsWith(">"))&&(!this.operator.startsWith("<")||!e.operator.startsWith("<"))&&(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))&&!(c(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))&&!(c(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}}e.exports=s;const a=n(6588),{safeRe:i,t:o}=n(487),c=n(1534),l=n(6735),u=n(4899),d=n(9558)},6641:(e,t,n)=>{const r=n(4617);class s extends Error{constructor(e){super(e),this.name="TimeoutError"}}const a=(e,t,n)=>new Promise((a,i)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void a(e);const o=setTimeout(()=>{if("function"==typeof n){try{a(n())}catch(e){i(e)}return}const r=n instanceof Error?n:new s("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),i(r)},t);r(e.then(a,i),()=>{clearTimeout(o)})});e.exports=a,e.exports.default=a,e.exports.TimeoutError=s},6735:e=>{const t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};e.exports=t},6856:(e,t,n)=>{const r=n(8136);e.exports=(e,t)=>e.sort((e,n)=>r(e,n,t))},6945:(e,t,n)=>{const r=n(4899),s=n(7737),{safeRe:a,t:i}=n(487);e.exports=(e,t)=>{if(e instanceof r)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let n=null;if((t=t||{}).rtl){const r=t.includePrerelease?a[i.COERCERTLFULL]:a[i.COERCERTL];let s;for(;(s=r.exec(e))&&(!n||n.index+n[0].length!==e.length);)n&&s.index+s[0].length===n.index+n[0].length||(n=s),r.lastIndex=s.index+s[1].length+s[2].length;r.lastIndex=-1}else n=e.match(t.includePrerelease?a[i.COERCEFULL]:a[i.COERCE]);if(null===n)return null;const o=n[2],c=n[3]||"0",l=n[4]||"0",u=t.includePrerelease&&n[5]?`-${n[5]}`:"",d=t.includePrerelease&&n[6]?`+${n[6]}`:"";return s(`${o}.${c}.${l}${u}${d}`,t)}},7119:(e,t,n)=>{const r=n(7737);e.exports=(e,t)=>{const n=r(e,null,!0),s=r(t,null,!0),a=n.compare(s);if(0===a)return null;const i=a>0,o=i?n:s,c=i?s:n,l=!!o.prerelease.length;if(c.prerelease.length&&!l){if(!c.patch&&!c.minor)return"major";if(0===c.compareMain(o))return c.minor&&!c.patch?"minor":"patch"}const u=l?"pre":"";return n.major!==s.major?u+"major":n.minor!==s.minor?u+"minor":n.patch!==s.patch?u+"patch":"prerelease"}},7280:(e,t,n)=>{const r=n(487),s=n(6261),a=n(4899),i=n(204),o=n(7737),c=n(4004),l=n(9855),u=n(4106),d=n(7119),p=n(3767),h=n(547),m=n(9196),f=n(3690),g=n(4621),y=n(2469),_=n(3042),v=n(8136),w=n(6856),b=n(9056),x=n(2559),k=n(4056),T=n(818),I=n(9606),E=n(7372),O=n(6133),S=n(1534),A=n(6945),$=n(6635),C=n(9558),N=n(995),P=n(534),R=n(5985),j=n(9499),L=n(3602),M=n(2153),z=n(6592),U=n(4076),D=n(4453),F=n(753),B=n(1620),Z=n(9881);e.exports={parse:o,valid:c,clean:l,inc:u,diff:d,major:p,minor:h,patch:m,prerelease:f,compare:g,rcompare:y,compareLoose:_,compareBuild:v,sort:w,rsort:b,gt:x,lt:k,eq:T,neq:I,gte:E,lte:O,cmp:S,coerce:A,Comparator:$,Range:C,satisfies:N,toComparators:P,maxSatisfying:R,minSatisfying:j,minVersion:L,validRange:M,outside:z,gtr:U,ltr:D,intersects:F,simplifyRange:B,subset:Z,SemVer:a,re:r.re,src:r.src,tokens:r.t,SEMVER_SPEC_VERSION:s.SEMVER_SPEC_VERSION,RELEASE_TYPES:s.RELEASE_TYPES,compareIdentifiers:i.compareIdentifiers,rcompareIdentifiers:i.rcompareIdentifiers}},7372:(e,t,n)=>{const r=n(4621);e.exports=(e,t,n)=>r(e,t,n)>=0},7526:(e,t)=>{t.byteLength=function(e){var t=o(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,a=o(e),i=a[0],c=a[1],l=new s(function(e,t,n){return 3*(t+n)/4-n}(0,i,c)),u=0,d=c>0?i-4:i;for(n=0;n<d;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;return 2===c&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,l[u++]=255&t),1===c&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t),l},t.fromByteArray=function(e){for(var t,r=e.length,s=r%3,a=[],i=16383,o=0,c=r-s;o<c;o+=i)a.push(l(e,o,o+i>c?c:o+i));return 1===s?(t=e[r-1],a.push(n[t>>2]+n[t<<4&63]+"==")):2===s&&(t=(e[r-2]<<8)+e[r-1],a.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"=")),a.join("")};for(var n=[],r=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0;i<64;++i)n[i]=a[i],r[a.charCodeAt(i)]=i;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function c(e){return n[e>>18&63]+n[e>>12&63]+n[e>>6&63]+n[63&e]}function l(e,t,n){for(var r,s=[],a=t;a<n;a+=3)r=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(c(r));return s.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},7737:(e,t,n)=>{const r=n(4899);e.exports=(e,t,n=!1)=>{if(e instanceof r)return e;try{return new r(e,t)}catch(e){if(!n)return null;throw e}}},8136:(e,t,n)=>{const r=n(4899);e.exports=(e,t,n)=>{const s=new r(e,n),a=new r(t,n);return s.compare(a)||s.compareBuild(a)}},9056:(e,t,n)=>{const r=n(8136);e.exports=(e,t)=>e.sort((e,n)=>r(n,e,t))},9196:(e,t,n)=>{const r=n(4899);e.exports=(e,t)=>new r(e,t).patch},9478:e=>{e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},9499:(e,t,n)=>{const r=n(4899),s=n(9558);e.exports=(e,t,n)=>{let a=null,i=null,o=null;try{o=new s(t,n)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(a&&1!==i.compare(e)||(a=e,i=new r(a,n)))}),a}},9558:(e,t,n)=>{const r=/\s+/g;class s{constructor(e,t){if(t=i(t),e instanceof s)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new s(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(r," "),this.set=this.raw.split("||").map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter(e=>!y(e[0])),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&_(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&f)|(this.options.loose&&g))+":"+e,n=a.get(t);if(n)return n;const r=this.options.loose,s=r?u[d.HYPHENRANGELOOSE]:u[d.HYPHENRANGE];e=e.replace(s,$(this.options.includePrerelease)),c("hyphen replace",e),e=e.replace(u[d.COMPARATORTRIM],p),c("comparator trim",e),e=e.replace(u[d.TILDETRIM],h),c("tilde trim",e),e=e.replace(u[d.CARETTRIM],m),c("caret trim",e);let i=e.split(" ").map(e=>w(e,this.options)).join(" ").split(/\s+/).map(e=>A(e,this.options));r&&(i=i.filter(e=>(c("loose invalid filter",e,this.options),!!e.match(u[d.COMPARATORLOOSE])))),c("range list",i);const l=new Map,_=i.map(e=>new o(e,this.options));for(const e of _){if(y(e))return[e];l.set(e.value,e)}l.size>1&&l.has("")&&l.delete("");const v=[...l.values()];return a.set(t,v),v}intersects(e,t){if(!(e instanceof s))throw new TypeError("a Range is required");return this.set.some(n=>v(n,t)&&e.set.some(e=>v(e,t)&&n.every(n=>e.every(e=>n.intersects(e,t)))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new l(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(C(this.set[t],e,this.options))return!0;return!1}}e.exports=s;const a=new(n(639)),i=n(6588),o=n(6635),c=n(6735),l=n(4899),{safeRe:u,t:d,comparatorTrimReplace:p,tildeTrimReplace:h,caretTrimReplace:m}=n(487),{FLAG_INCLUDE_PRERELEASE:f,FLAG_LOOSE:g}=n(6261),y=e=>"<0.0.0-0"===e.value,_=e=>""===e.value,v=(e,t)=>{let n=!0;const r=e.slice();let s=r.pop();for(;n&&r.length;)n=r.every(e=>s.intersects(e,t)),s=r.pop();return n},w=(e,t)=>(e=e.replace(u[d.BUILD],""),c("comp",e,t),e=T(e,t),c("caret",e),e=x(e,t),c("tildes",e),e=E(e,t),c("xrange",e),e=S(e,t),c("stars",e),e),b=e=>!e||"x"===e.toLowerCase()||"*"===e,x=(e,t)=>e.trim().split(/\s+/).map(e=>k(e,t)).join(" "),k=(e,t)=>{const n=t.loose?u[d.TILDELOOSE]:u[d.TILDE];return e.replace(n,(t,n,r,s,a)=>{let i;return c("tilde",e,t,n,r,s,a),b(n)?i="":b(r)?i=`>=${n}.0.0 <${+n+1}.0.0-0`:b(s)?i=`>=${n}.${r}.0 <${n}.${+r+1}.0-0`:a?(c("replaceTilde pr",a),i=`>=${n}.${r}.${s}-${a} <${n}.${+r+1}.0-0`):i=`>=${n}.${r}.${s} <${n}.${+r+1}.0-0`,c("tilde return",i),i})},T=(e,t)=>e.trim().split(/\s+/).map(e=>I(e,t)).join(" "),I=(e,t)=>{c("caret",e,t);const n=t.loose?u[d.CARETLOOSE]:u[d.CARET],r=t.includePrerelease?"-0":"";return e.replace(n,(t,n,s,a,i)=>{let o;return c("caret",e,t,n,s,a,i),b(n)?o="":b(s)?o=`>=${n}.0.0${r} <${+n+1}.0.0-0`:b(a)?o="0"===n?`>=${n}.${s}.0${r} <${n}.${+s+1}.0-0`:`>=${n}.${s}.0${r} <${+n+1}.0.0-0`:i?(c("replaceCaret pr",i),o="0"===n?"0"===s?`>=${n}.${s}.${a}-${i} <${n}.${s}.${+a+1}-0`:`>=${n}.${s}.${a}-${i} <${n}.${+s+1}.0-0`:`>=${n}.${s}.${a}-${i} <${+n+1}.0.0-0`):(c("no pr"),o="0"===n?"0"===s?`>=${n}.${s}.${a}${r} <${n}.${s}.${+a+1}-0`:`>=${n}.${s}.${a}${r} <${n}.${+s+1}.0-0`:`>=${n}.${s}.${a} <${+n+1}.0.0-0`),c("caret return",o),o})},E=(e,t)=>(c("replaceXRanges",e,t),e.split(/\s+/).map(e=>O(e,t)).join(" ")),O=(e,t)=>{e=e.trim();const n=t.loose?u[d.XRANGELOOSE]:u[d.XRANGE];return e.replace(n,(n,r,s,a,i,o)=>{c("xRange",e,n,r,s,a,i,o);const l=b(s),u=l||b(a),d=u||b(i),p=d;return"="===r&&p&&(r=""),o=t.includePrerelease?"-0":"",l?n=">"===r||"<"===r?"<0.0.0-0":"*":r&&p?(u&&(a=0),i=0,">"===r?(r=">=",u?(s=+s+1,a=0,i=0):(a=+a+1,i=0)):"<="===r&&(r="<",u?s=+s+1:a=+a+1),"<"===r&&(o="-0"),n=`${r+s}.${a}.${i}${o}`):u?n=`>=${s}.0.0${o} <${+s+1}.0.0-0`:d&&(n=`>=${s}.${a}.0${o} <${s}.${+a+1}.0-0`),c("xRange return",n),n})},S=(e,t)=>(c("replaceStars",e,t),e.trim().replace(u[d.STAR],"")),A=(e,t)=>(c("replaceGTE0",e,t),e.trim().replace(u[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),$=e=>(t,n,r,s,a,i,o,c,l,u,d,p)=>`${n=b(r)?"":b(s)?`>=${r}.0.0${e?"-0":""}`:b(a)?`>=${r}.${s}.0${e?"-0":""}`:i?`>=${n}`:`>=${n}${e?"-0":""}`} ${c=b(l)?"":b(u)?`<${+l+1}.0.0-0`:b(d)?`<${l}.${+u+1}.0-0`:p?`<=${l}.${u}.${d}-${p}`:e?`<${l}.${u}.${+d+1}-0`:`<=${c}`}`.trim(),C=(e,t,n)=>{for(let n=0;n<e.length;n++)if(!e[n].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(let n=0;n<e.length;n++)if(c(e[n].semver),e[n].semver!==o.ANY&&e[n].semver.prerelease.length>0){const r=e[n].semver;if(r.major===t.major&&r.minor===t.minor&&r.patch===t.patch)return!0}return!1}return!0}},9606:(e,t,n)=>{const r=n(4621);e.exports=(e,t,n)=>0!==r(e,t,n)},9771:(e,t,n)=>{function r(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${t}/\n`,e}function s(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n}function a(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}let i=function(){const{crypto:e}=globalThis;if(e?.randomUUID)return i=e.randomUUID.bind(e),e.randomUUID();const t=new Uint8Array(1),n=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(+e^n()&15>>+e/4).toString(16))};function o(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}const c=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){const t=new Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return new Error(JSON.stringify(e))}catch{}}return new Error(e)};class l extends Error{}class u extends l{constructor(e,t,n,r){super(`${u.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.requestID=r?.get("x-request-id"),this.error=t;const s=t;this.code=s?.code,this.param=s?.param,this.type=s?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e||!r)return new p({message:n,cause:c(t)});const s=t?.error;return 400===e?new m(e,s,n,r):401===e?new f(e,s,n,r):403===e?new g(e,s,n,r):404===e?new y(e,s,n,r):409===e?new _(e,s,n,r):422===e?new v(e,s,n,r):429===e?new w(e,s,n,r):e>=500?new b(e,s,n,r):new u(e,s,n,r)}}class d extends u{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class p extends u{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class h extends p{constructor({message:e}={}){super({message:e??"Request timed out."})}}class m extends u{}class f extends u{}class g extends u{}class y extends u{}class _ extends u{}class v extends u{}class w extends u{}class b extends u{}class x extends l{constructor(){super("Could not parse response content as the length limit was reached")}}class k extends l{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class T extends Error{constructor(e){super(e)}}const I=/^[a-z][a-z0-9+.-]*:/i;let E=e=>(E=Array.isArray,E(e)),O=E;function S(e){return"object"!=typeof e?{}:e??{}}function A(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}const $=e=>new Promise(t=>setTimeout(t,e)),C="6.15.0",N=()=>{const e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":C,"X-Stainless-OS":R(Deno.build.os),"X-Stainless-Arch":P(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":C,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":C,"X-Stainless-OS":R(globalThis.process.platform??"unknown"),"X-Stainless-Arch":P(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};const t=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":C,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":C,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}},P=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",R=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let j;function L(...e){const t=globalThis.ReadableStream;if(void 0===t)throw new Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function M(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return L({start(){},async pull(e){const{done:n,value:r}=await t.next();n?e.close():e.enqueue(r)},async cancel(){await(t.return?.())}})}function z(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const U=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),D="RFC3986",F=e=>String(e),B={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:F};let Z=(e,t)=>(Z=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty),Z(e,t));const q=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),V=1024;function H(e,t){if(E(e)){const n=[];for(let r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)}const W={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},G=function(e,t){Array.prototype.push.apply(e,E(t)?t:[t])};let J;const K={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,r,s)=>{if(0===e.length)return e;let a=e;if("symbol"==typeof e?a=Symbol.prototype.toString.call(e):"string"!=typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let i="";for(let e=0;e<a.length;e+=V){const t=a.length>=V?a.slice(e,e+V):a,n=[];for(let e=0;e<t.length;++e){let r=t.charCodeAt(e);45===r||46===r||95===r||126===r||r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||"RFC1738"===s&&(40===r||41===r)?n[n.length]=t.charAt(e):r<128?n[n.length]=q[r]:r<2048?n[n.length]=q[192|r>>6]+q[128|63&r]:r<55296||r>=57344?n[n.length]=q[224|r>>12]+q[128|r>>6&63]+q[128|63&r]:(e+=1,r=65536+((1023&r)<<10|1023&t.charCodeAt(e)),n[n.length]=q[240|r>>18]+q[128|r>>12&63]+q[128|r>>6&63]+q[128|63&r])}i+=n.join("")}return i},encodeValuesOnly:!1,format:D,formatter:F,indices:!1,serializeDate:e=>(J??(J=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1},X={};function Y(e,t,n,r,s,a,i,o,c,l,u,d,p,h,m,f,g,y){let _=e,v=y,w=0,b=!1;for(;void 0!==(v=v.get(X))&&!b;){const t=v.get(e);if(w+=1,void 0!==t){if(t===w)throw new RangeError("Cyclic object value");b=!0}void 0===v.get(X)&&(w=0)}if("function"==typeof l?_=l(t,_):_ instanceof Date?_=p?.(_):"comma"===n&&E(_)&&(_=H(_,function(e){return e instanceof Date?p?.(e):e})),null===_){if(a)return c&&!f?c(t,K.encoder,g,"key",h):t;_=""}if("string"==typeof(x=_)||"number"==typeof x||"boolean"==typeof x||"symbol"==typeof x||"bigint"==typeof x||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(_)){if(c){const e=f?t:c(t,K.encoder,g,"key",h);return[m?.(e)+"="+m?.(c(_,K.encoder,g,"value",h))]}return[m?.(t)+"="+m?.(String(_))]}var x;const k=[];if(void 0===_)return k;let T;if("comma"===n&&E(_))f&&c&&(_=H(_,c)),T=[{value:_.length>0?_.join(",")||null:void 0}];else if(E(l))T=l;else{const e=Object.keys(_);T=u?e.sort(u):e}const I=o?String(t).replace(/\./g,"%2E"):String(t),O=r&&E(_)&&1===_.length?I+"[]":I;if(s&&E(_)&&0===_.length)return O+"[]";for(let t=0;t<T.length;++t){const v=T[t],b="object"==typeof v&&void 0!==v.value?v.value:_[v];if(i&&null===b)continue;const x=d&&o?v.replace(/\./g,"%2E"):v,I=E(_)?"function"==typeof n?n(O,x):O:O+(d?"."+x:"["+x+"]");y.set(e,w);const S=new WeakMap;S.set(X,y),G(k,Y(b,I,n,r,s,a,i,o,"comma"===n&&f&&E(_)?null:c,l,u,d,p,h,m,f,g,S))}return k}let Q,ee;function te(e){let t;return(Q??(t=new globalThis.TextEncoder,Q=t.encode.bind(t)))(e)}function ne(e){let t;return(ee??(t=new globalThis.TextDecoder,ee=t.decode.bind(t)))(e)}var re,se;class ae{constructor(){re.set(this,void 0),se.set(this,void 0),s(this,re,new Uint8Array,"f"),s(this,se,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?te(e):e;s(this,re,function(e){let t=0;for(const n of e)t+=n.length;const n=new Uint8Array(t);let r=0;for(const t of e)n.set(t,r),r+=t.length;return n}([a(this,re,"f"),t]),"f");const n=[];let r;for(;null!=(r=ie(a(this,re,"f"),a(this,se,"f")));){if(r.carriage&&null==a(this,se,"f")){s(this,se,r.index,"f");continue}if(null!=a(this,se,"f")&&(r.index!==a(this,se,"f")+1||r.carriage)){n.push(ne(a(this,re,"f").subarray(0,a(this,se,"f")-1))),s(this,re,a(this,re,"f").subarray(a(this,se,"f")),"f"),s(this,se,null,"f");continue}const e=null!==a(this,se,"f")?r.preceding-1:r.preceding,t=ne(a(this,re,"f").subarray(0,e));n.push(t),s(this,re,a(this,re,"f").subarray(r.index),"f"),s(this,se,null,"f")}return n}flush(){return a(this,re,"f").length?this.decode("\n"):[]}}function ie(e,t){for(let n=t??0;n<e.length;n++){if(10===e[n])return{preceding:n,index:n+1,carriage:!1};if(13===e[n])return{preceding:n,index:n+1,carriage:!0}}return null}function oe(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}re=new WeakMap,se=new WeakMap,ae.NEWLINE_CHARS=new Set(["\n","\r"]),ae.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const ce={off:0,error:200,warn:300,info:400,debug:500},le=(e,t,n)=>{var r,s;if(e)return r=ce,s=e,Object.prototype.hasOwnProperty.call(r,s)?e:void me(n).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(ce))}`)};function ue(){}function de(e,t,n){return!t||ce[e]>ce[n]?ue:t[e].bind(t)}const pe={error:ue,warn:ue,info:ue,debug:ue};let he=new WeakMap;function me(e){const t=e.logger,n=e.logLevel??"off";if(!t)return pe;const r=he.get(t);if(r&&r[0]===n)return r[1];const s={error:de("error",t,n),warn:de("warn",t,n),info:de("info",t,n),debug:de("debug",t,n)};return he.set(t,[n,s]),s}const fe=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);var ge,ye,_e;class ve{constructor(e,t,n){this.iterator=e,ge.set(this,void 0),this.controller=t,s(this,ge,n,"f")}static fromSSEResponse(e,t,n){let r=!1;const s=n?me(n):console;return new ve(async function*(){if(r)throw new l("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const r of async function*(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new l("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new l("Attempted to iterate over a response with no body")}const n=new we,r=new ae,s=z(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?te(n):n;let r,s=new Uint8Array(t.length+e.length);for(s.set(t),s.set(e,t.length),t=s;-1!==(r=oe(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(s))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t))if(!n)if(r.data.startsWith("[DONE]"))n=!0;else if(null!==r.event&&r.event.startsWith("thread.")){let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if("error"==r.event)throw new u(void 0,e.error,e.message,void 0);yield{event:r.event,data:e}}else{let t;try{t=JSON.parse(r.data)}catch(e){throw s.error("Could not parse message into JSON:",r.data),s.error("From chunk:",r.raw),e}if(t&&t.error)throw new u(void 0,t.error,void 0,e.headers);yield t}n=!0}catch(e){if(o(e))return;throw e}finally{n||t.abort()}},t,n)}static fromReadableStream(e,t,n){let r=!1;return new ve(async function*(){if(r)throw new l("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const t of async function*(){const t=new ae,n=z(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())n||t&&(yield JSON.parse(t));n=!0}catch(e){if(o(e))return;throw e}finally{n||t.abort()}},t,n)}[(ge=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new ve(()=>r(e),this.controller,a(this,ge,"f")),new ve(()=>r(t),this.controller,a(this,ge,"f"))]}toReadableStream(){const e=this;let t;return L({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:n,done:r}=await t.next();if(r)return e.close();const s=te(JSON.stringify(n)+"\n");e.enqueue(s)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class we{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}async function be(e,t){const{response:n,requestLogID:r,retryOfRequestLogID:s,startTime:a}=t,i=await(async()=>{if(t.options.stream)return me(e).debug("response",n.status,n.url,n.headers,n.body),t.options.__streamClass?t.options.__streamClass.fromSSEResponse(n,t.controller,e):ve.fromSSEResponse(n,t.controller,e);if(204===n.status)return null;if(t.options.__binaryResponse)return n;const r=n.headers.get("content-type"),s=r?.split(";")[0]?.trim();return s?.includes("application/json")||s?.endsWith("+json")?xe(await n.json(),n):await n.text()})();return me(e).debug(`[${r}] response parsed`,fe({retryOfRequestLogID:s,url:n.url,status:n.status,body:i,durationMs:Date.now()-a})),i}function xe(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class ke extends Promise{constructor(e,t,n=be){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=n,ye.set(this,void 0),s(this,ye,e,"f")}_thenUnwrap(e){return new ke(a(this,ye,"f"),this.responsePromise,async(t,n)=>xe(e(await this.parseResponse(t,n),n),n.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(a(this,ye,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}ye=new WeakMap;class Te{constructor(e,t,n,r){_e.set(this,void 0),s(this,_e,e,"f"),this.options=r,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){const e=this.nextPageRequestOptions();if(!e)throw new l("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await a(this,_e,"f").requestAPIList(this.constructor,e)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(_e=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Ie extends ke{constructor(e,t,n){super(e,t,async(e,t)=>new n(e,t.response,await be(e,t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}class Ee extends Te{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class Oe extends Te{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.has_more=n.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...S(this.options.query),after:t}}:null}}class Se extends Te{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.has_more=n.has_more||!1,this.last_id=n.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){const e=this.last_id;return e?{...this.options,query:{...S(this.options.query),after:e}}:null}}const Ae=()=>{if("undefined"==typeof File){const{process:e}=globalThis,t="string"==typeof e?.versions?.node&&parseInt(e.versions.node.split("."))<20;throw new Error("`File` is not defined as a global, which is required for file uploads."+(t?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function $e(e,t,n){return Ae(),new File(e,t??"unknown_file",n)}function Ce(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}const Ne=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],Pe=async(e,t)=>ze(e.body)?{...e,body:await Le(e.body,t)}:e,Re=async(e,t)=>({...e,body:await Le(e.body,t)}),je=new WeakMap,Le=async(e,t)=>{if(!await function(e){const t="function"==typeof e?e:e.fetch,n=je.get(t);if(n)return n;const r=(async()=>{try{const e="Response"in t?t.Response:(await t("data:,")).constructor,n=new FormData;return n.toString()!==await new e(n).text()}catch{return!0}})();return je.set(t,r),r}(t))throw new TypeError("The provided fetch function does not support file uploads with the current global FormData class.");const n=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>Ue(n,e,t))),n},Me=e=>e instanceof Blob&&"name"in e,ze=e=>{if((e=>"object"==typeof e&&null!==e&&(e instanceof Response||Ne(e)||Me(e)))(e))return!0;if(Array.isArray(e))return e.some(ze);if(e&&"object"==typeof e)for(const t in e)if(ze(e[t]))return!0;return!1},Ue=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if(n instanceof Response)e.append(t,$e([await n.blob()],Ce(n)));else if(Ne(n))e.append(t,$e([await new Response(M(n)).blob()],Ce(n)));else if(Me(n))e.append(t,n,Ce(n));else if(Array.isArray(n))await Promise.all(n.map(n=>Ue(e,t+"[]",n)));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map(([n,r])=>Ue(e,`${t}[${n}]`,r)))}}},De=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function Fe(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(De(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else{if(!Ne(e)){const t=e?.constructor?.name;throw new Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";return`; props: [${Object.getOwnPropertyNames(e).map(e=>`"${e}"`).join(", ")}]`}(e)}`)}for await(const n of e)t.push(...await Fe(n))}return t}class Be{constructor(e){this._client=e}}function Ze(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}const qe=Object.freeze(Object.create(null)),Ve=(e=Ze)=>function(t,...n){if(1===t.length)return t[0];let r=!1;const s=[],a=t.reduce((t,a,i)=>{/[?#]/.test(a)&&(r=!0);const o=n[i];let c=(r?encodeURIComponent:e)(""+o);return i!==n.length&&(null==o||"object"==typeof o&&o.toString===Object.getPrototypeOf(Object.getPrototypeOf(o.hasOwnProperty??qe)??qe)?.toString)&&(c=o+"",s.push({start:t.length+a.length,length:c.length,error:`Value of type ${Object.prototype.toString.call(o).slice(8,-1)} is not a valid path parameter`})),t+a+(i===n.length?"":c)},""),i=a.split(/[?#]/,1)[0],o=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;let c;for(;null!==(c=o.exec(i));)s.push({start:c.index,length:c[0].length,error:`Value "${c[0]}" can't be safely passed as a path parameter`});if(s.sort((e,t)=>e.start-t.start),s.length>0){let e=0;const t=s.reduce((t,n)=>{const r=" ".repeat(n.start-e),s="^".repeat(n.length);return e=n.start+n.length,t+r+s},"");throw new l(`Path parameters result in path with invalid segments:\n${s.map(e=>e.error).join("\n")}\n${a}\n${t}`)}return a},He=Ve(Ze);class We extends Be{list(e,t={},n){return this._client.getAPIList(He`/chat/completions/${e}/messages`,Oe,{query:t,...n})}}function Ge(e){return void 0!==e&&"function"in e&&void 0!==e.function}function Je(e){return"auto-parseable-response-format"===e?.$brand}function Ke(e){return"auto-parseable-tool"===e?.$brand}function Xe(e,t){const n=e.choices.map(e=>{if("length"===e.finish_reason)throw new x;if("content_filter"===e.finish_reason)throw new k;return tt(e.message.tool_calls),{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>function(e,t){const n=e.tools?.find(e=>Ge(e)&&e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:Ke(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?Ye(t,e.message.content):null}}});return{...e,choices:n}}function Ye(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function Qe(e,t){if(!e||!("tools"in e)||!e.tools)return!1;const n=e.tools?.find(e=>Ge(e)&&e.function?.name===t.function.name);return Ge(n)&&(Ke(n)||n?.function.strict||!1)}function et(e){return!!Je(e.response_format)||(e.tools?.some(e=>Ke(e)||"function"===e.type&&!0===e.function.strict)??!1)}function tt(e){for(const t of e||[])if("function"!==t.type)throw new l(`Currently only \`function\` tool calls are supported; Received \`${t.type}\``)}const nt=e=>"assistant"===e?.role,rt=e=>"tool"===e?.role;var st,at,it,ot,ct,lt,ut,dt,pt,ht,mt,ft,gt,yt,_t,vt,wt,bt,xt,kt,Tt;class It{constructor(){st.add(this),this.controller=new AbortController,at.set(this,void 0),it.set(this,()=>{}),ot.set(this,()=>{}),ct.set(this,void 0),lt.set(this,()=>{}),ut.set(this,()=>{}),dt.set(this,{}),pt.set(this,!1),ht.set(this,!1),mt.set(this,!1),ft.set(this,!1),s(this,at,new Promise((e,t)=>{s(this,it,e,"f"),s(this,ot,t,"f")}),"f"),s(this,ct,new Promise((e,t)=>{s(this,lt,e,"f"),s(this,ut,t,"f")}),"f"),a(this,at,"f").catch(()=>{}),a(this,ct,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},a(this,st,"m",gt).bind(this))},0)}_connected(){this.ended||(a(this,it,"f").call(this),this._emit("connect"))}get ended(){return a(this,pt,"f")}get errored(){return a(this,ht,"f")}get aborted(){return a(this,mt,"f")}abort(){this.controller.abort()}on(e,t){return(a(this,dt,"f")[e]||(a(this,dt,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=a(this,dt,"f")[e];if(!n)return this;const r=n.findIndex(e=>e.listener===t);return r>=0&&n.splice(r,1),this}once(e,t){return(a(this,dt,"f")[e]||(a(this,dt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,n)=>{s(this,ft,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)})}async done(){s(this,ft,!0,"f"),await a(this,ct,"f")}_emit(e,...t){if(a(this,pt,"f"))return;"end"===e&&(s(this,pt,!0,"f"),a(this,lt,"f").call(this));const n=a(this,dt,"f")[e];if(n&&(a(this,dt,"f")[e]=n.filter(e=>!e.once),n.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return a(this,ft,"f")||n?.length||Promise.reject(e),a(this,ot,"f").call(this,e),a(this,ut,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];a(this,ft,"f")||n?.length||Promise.reject(e),a(this,ot,"f").call(this,e),a(this,ut,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function Et(e){return"function"==typeof e.parse}at=new WeakMap,it=new WeakMap,ot=new WeakMap,ct=new WeakMap,lt=new WeakMap,ut=new WeakMap,dt=new WeakMap,pt=new WeakMap,ht=new WeakMap,mt=new WeakMap,ft=new WeakMap,st=new WeakSet,gt=function(e){if(s(this,ht,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new d),e instanceof d)return s(this,mt,!0,"f"),this._emit("abort",e);if(e instanceof l)return this._emit("error",e);if(e instanceof Error){const t=new l(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new l(String(e)))};const Ot=10;class St extends It{constructor(){super(...arguments),yt.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),rt(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(nt(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionToolCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new l("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),a(this,yt,"m",_t).call(this)}async finalMessage(){return await this.done(),a(this,yt,"m",vt).call(this)}async finalFunctionToolCall(){return await this.done(),a(this,yt,"m",wt).call(this)}async finalFunctionToolCallResult(){return await this.done(),a(this,yt,"m",bt).call(this)}async totalUsage(){return await this.done(),a(this,yt,"m",xt).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=a(this,yt,"m",vt).call(this);t&&this._emit("finalMessage",t);const n=a(this,yt,"m",_t).call(this);n&&this._emit("finalContent",n);const r=a(this,yt,"m",wt).call(this);r&&this._emit("finalFunctionToolCall",r);const s=a(this,yt,"m",bt).call(this);null!=s&&this._emit("finalFunctionToolCallResult",s),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",a(this,yt,"m",xt).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),a(this,yt,"m",kt).call(this,t);const s=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Xe(s,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runTools(e,t,n){const r="tool",{tool_choice:s="auto",stream:i,...o}=t,c="string"!=typeof s&&"function"===s.type&&s?.function?.name,{maxChatCompletions:u=Ot}=n||{},d=t.tools.map(e=>{if(Ke(e)){if(!e.$callback)throw new l("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),p={};for(const e of d)"function"===e.type&&(p[e.function.name||e.function.function.name]=e.function);const h="tools"in t?d.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<u;++t){const t=await this._createChatCompletion(e,{...o,tool_choice:s,tools:h,messages:[...this.messages]},n),i=t.choices[0]?.message;if(!i)throw new l("missing message in ChatCompletion response");if(!i.tool_calls?.length)return;for(const e of i.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:s}=e.function,i=p[n];if(!i){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(p).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}if(c&&c!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}let o;try{o=Et(i)?await i.parse(s):s}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:t,content:n});continue}const l=await i.function(o,this),u=a(this,yt,"m",Tt).call(this,l);if(this._addMessage({role:r,tool_call_id:t,content:u}),c)return}}}}yt=new WeakSet,_t=function(){return a(this,yt,"m",vt).call(this).content??null},vt=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(nt(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new l("stream ended without producing a ChatCompletionMessage with role=assistant")},wt=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(nt(t)&&t?.tool_calls?.length)return t.tool_calls.filter(e=>"function"===e.type).at(-1)?.function}},bt=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(rt(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},xt=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},kt=function(e){if(null!=e.n&&e.n>1)throw new l("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Tt=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class At extends St{static runTools(e,t,n){const r=new At,s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,s)),r}_addMessage(e,t=!0){super._addMessage(e,t),nt(e)&&e.content&&this._emit("content",e.content)}}class $t extends Error{}class Ct extends Error{}const Nt=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const n=e.length;let r=0;const s=e=>{throw new $t(`${e} at position ${r}`)},a=e=>{throw new Ct(`${e} at position ${r}`)},i=()=>(d(),r>=n&&s("Unexpected end of input"),'"'===e[r]?o():"{"===e[r]?c():"["===e[r]?l():"null"===e.substring(r,r+4)||16&t&&n-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):"true"===e.substring(r,r+4)||32&t&&n-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):"false"===e.substring(r,r+5)||32&t&&n-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):"Infinity"===e.substring(r,r+8)||128&t&&n-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):"-Infinity"===e.substring(r,r+9)||256&t&&1<n-r&&n-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):"NaN"===e.substring(r,r+3)||64&t&&n-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):u()),o=()=>{const i=r;let o=!1;for(r++;r<n&&('"'!==e[r]||o&&"\\"===e[r-1]);)o="\\"===e[r]&&!o,r++;if('"'==e.charAt(r))try{return JSON.parse(e.substring(i,++r-Number(o)))}catch(e){a(String(e))}else if(1&t)try{return JSON.parse(e.substring(i,r-Number(o))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},c=()=>{r++,d();const a={};try{for(;"}"!==e[r];){if(d(),r>=n&&8&t)return a;const s=o();d(),r++;try{const e=i();Object.defineProperty(a,s,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return a;throw e}d(),","===e[r]&&r++}}catch(e){if(8&t)return a;s("Expected '}' at end of object")}return r++,a},l=()=>{r++;const n=[];try{for(;"]"!==e[r];)n.push(i()),d(),","===e[r]&&r++}catch(e){if(4&t)return n;s("Expected ']' at end of array")}return r++,n},u=()=>{if(0===r){"-"===e&&2&t&&s("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}a(String(n))}}const i=r;for("-"===e[r]&&r++;e[r]&&!",]}".includes(e[r]);)r++;r!=n||2&t||s("Unterminated number literal");try{return JSON.parse(e.substring(i,r))}catch(n){"-"===e.substring(i,r)&&2&t&&s("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){a(String(e))}}},d=()=>{for(;r<n&&" \n\r\t".includes(e[r]);)r++};return i()})(e.trim(),t)}(e,509);var Pt,Rt,jt,Lt,Mt,zt,Ut,Dt,Ft,Bt,Zt,qt;class Vt extends St{constructor(e){super(),Pt.add(this),Rt.set(this,void 0),jt.set(this,void 0),Lt.set(this,void 0),s(this,Rt,e,"f"),s(this,jt,[],"f")}get currentChatCompletionSnapshot(){return a(this,Lt,"f")}static fromReadableStream(e){const t=new Vt(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,n){const r=new Vt(t);return r._run(()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,t,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),a(this,Pt,"m",Mt).call(this);const s=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of s)a(this,Pt,"m",Ut).call(this,e);if(s.controller.signal?.aborted)throw new d;return this._addChatCompletion(a(this,Pt,"m",Bt).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),a(this,Pt,"m",Mt).call(this),this._connected();const r=ve.fromReadableStream(e,this.controller);let s;for await(const e of r)s&&s!==e.id&&this._addChatCompletion(a(this,Pt,"m",Bt).call(this)),a(this,Pt,"m",Ut).call(this,e),s=e.id;if(r.controller.signal?.aborted)throw new d;return this._addChatCompletion(a(this,Pt,"m",Bt).call(this))}[(Rt=new WeakMap,jt=new WeakMap,Lt=new WeakMap,Pt=new WeakSet,Mt=function(){this.ended||s(this,Lt,void 0,"f")},zt=function(e){let t=a(this,jt,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},a(this,jt,"f")[e.index]=t,t)},Ut=function(e){if(this.ended)return;const t=a(this,Pt,"m",qt).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const r=a(this,Pt,"m",zt).call(this,e);e.finish_reason&&(a(this,Pt,"m",Ft).call(this,e),null!=r.current_tool_call_index&&a(this,Pt,"m",Dt).call(this,e,r.current_tool_call_index));for(const t of n.delta.tool_calls??[])r.current_tool_call_index!==t.index&&(a(this,Pt,"m",Ft).call(this,e),null!=r.current_tool_call_index&&a(this,Pt,"m",Dt).call(this,e,r.current_tool_call_index)),r.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&("function"===n?.type?this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):Gt())}}},Dt=function(e,t){if(a(this,Pt,"m",zt).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=a(this,Rt,"f")?.tools?.find(e=>Ge(e)&&e.function.name===n.function.name);this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:Ke(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},Ft=function(e){const t=a(this,Pt,"m",zt).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=a(this,Pt,"m",Zt).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},Bt=function(){if(this.ended)throw new l("stream has ended, this shouldn't happen");const e=a(this,Lt,"f");if(!e)throw new l("request ended without sending any chunks");return s(this,Lt,void 0,"f"),s(this,jt,[],"f"),function(e,t){const{id:n,choices:r,created:s,model:a,system_fingerprint:i,...o}=e,c={...o,id:n,choices:r.map(({message:t,finish_reason:n,index:r,logprobs:s,...a})=>{if(!n)throw new l(`missing finish_reason for choice ${r}`);const{content:i=null,function_call:o,tool_calls:c,...u}=t,d=t.role;if(!d)throw new l(`missing role for choice ${r}`);if(o){const{arguments:e,name:c}=o;if(null==e)throw new l(`missing function_call.arguments for choice ${r}`);if(!c)throw new l(`missing function_call.name for choice ${r}`);return{...a,message:{content:i,function_call:{arguments:e,name:c},role:d,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:s}}return c?{...a,index:r,finish_reason:n,logprobs:s,message:{...u,role:d,content:i,refusal:t.refusal??null,tool_calls:c.map((t,n)=>{const{function:s,type:a,id:i,...o}=t,{arguments:c,name:u,...d}=s||{};if(null==i)throw new l(`missing choices[${r}].tool_calls[${n}].id\n${Ht(e)}`);if(null==a)throw new l(`missing choices[${r}].tool_calls[${n}].type\n${Ht(e)}`);if(null==u)throw new l(`missing choices[${r}].tool_calls[${n}].function.name\n${Ht(e)}`);if(null==c)throw new l(`missing choices[${r}].tool_calls[${n}].function.arguments\n${Ht(e)}`);return{...o,id:i,type:a,function:{...d,name:u,arguments:c}}})}}:{...a,message:{...u,content:i,role:d,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:s}}),created:s,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&et(t)?Xe(e,t):{...e,choices:e.choices.map(e=>(tt(e.message.tool_calls),{...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(c,t)}(e,a(this,Rt,"f"))},Zt=function(){const e=a(this,Rt,"f")?.response_format;return Je(e)?e:null},qt=function(e){var t,n,r,i;let o=a(this,Lt,"f");const{choices:c,...l}=e;o?Object.assign(o,l):o=s(this,Lt,{...l,choices:[]},"f");for(const{delta:s,finish_reason:c,index:l,logprobs:u=null,...d}of e.choices){let e=o.choices[l];if(e||(e=o.choices[l]={finish_reason:c,index:l,message:{},logprobs:u,...d}),u)if(e.logprobs){const{content:r,refusal:s,...a}=u;Wt(),Object.assign(e.logprobs,a),r&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...r)),s&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...s))}else e.logprobs=Object.assign({},u);if(c&&(e.finish_reason=c,a(this,Rt,"f")&&et(a(this,Rt,"f")))){if("length"===c)throw new x;if("content_filter"===c)throw new k}if(Object.assign(e,d),!s)continue;const{content:p,refusal:h,function_call:m,role:f,tool_calls:g,...y}=s;if(Wt(),Object.assign(e.message,y),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),m&&(e.message.function_call?(m.name&&(e.message.function_call.name=m.name),m.arguments&&((r=e.message.function_call).arguments??(r.arguments=""),e.message.function_call.arguments+=m.arguments)):e.message.function_call=m),p&&(e.message.content=(e.message.content||"")+p,!e.message.refusal&&a(this,Pt,"m",Zt).call(this)&&(e.message.parsed=Nt(e.message.content))),g){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:r,function:s,...o}of g){const c=(i=e.message.tool_calls)[t]??(i[t]={});Object.assign(c,o),n&&(c.id=n),r&&(c.type=r),s&&(c.function??(c.function={name:s.name??"",arguments:""})),s?.name&&(c.function.name=s.name),s?.arguments&&(c.function.arguments+=s.arguments,Qe(a(this,Rt,"f"),c)&&(c.function.parsed_arguments=Nt(c.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",n=>{const r=t.shift();r?r.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ve(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Ht(e){return JSON.stringify(e)}function Wt(e){}function Gt(_x){}class Jt extends Vt{static fromReadableStream(e){const t=new Jt(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,n){const r=new Jt(t),s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,s)),r}}class Kt extends Be{constructor(){super(...arguments),this.messages=new We(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(He`/chat/completions/${e}`,t)}update(e,t,n){return this._client.post(He`/chat/completions/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/chat/completions",Oe,{query:e,...t})}delete(e,t){return this._client.delete(He`/chat/completions/${e}`,t)}parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new l(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new l(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>Xe(t,e))}runTools(e,t){return e.stream?Jt.runTools(this._client,e,t):At.runTools(this._client,e,t)}stream(e,t){return Vt.createChatCompletion(this._client,e,t)}}Kt.Messages=We;class Xt extends Be{constructor(){super(...arguments),this.completions=new Kt(this._client)}}Xt.Completions=Kt;const Yt=Symbol("brand.privateNullableHeaders");function*Qt(e){if(!e)return;if(Yt in e){const{values:t,nulls:n}=e;yield*t.entries();for(const e of n)yield[e,null];return}let t,n=!1;e instanceof Headers?t=e.entries():O(e)?t=e:(n=!0,t=Object.entries(e??{}));for(let e of t){const t=e[0];if("string"!=typeof t)throw new TypeError("expected header name to be a string");const r=O(e[1])?e[1]:[e[1]];let s=!1;for(const e of r)void 0!==e&&(n&&!s&&(s=!0,yield[t,null]),yield[t,e])}}const en=e=>{const t=new Headers,n=new Set;for(const r of e){const e=new Set;for(const[s,a]of Qt(r)){const r=s.toLowerCase();e.has(r)||(t.delete(s),e.add(r)),null===a?(t.delete(s),n.add(r)):(t.append(s,a),n.delete(r))}}return{[Yt]:!0,values:t,nulls:n}};class tn extends Be{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:en([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class nn extends Be{create(e,t){return this._client.post("/audio/transcriptions",Re({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class rn extends Be{create(e,t){return this._client.post("/audio/translations",Re({body:e,...t,__metadata:{model:e.model}},this._client))}}class sn extends Be{constructor(){super(...arguments),this.transcriptions=new nn(this._client),this.translations=new rn(this._client),this.speech=new tn(this._client)}}sn.Transcriptions=nn,sn.Translations=rn,sn.Speech=tn;class an extends Be{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(He`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",Oe,{query:e,...t})}cancel(e,t){return this._client.post(He`/batches/${e}/cancel`,t)}}class on extends Be{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(He`/assistants/${e}`,{...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(He`/assistants/${e}`,{body:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",Oe,{query:e,...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(He`/assistants/${e}`,{...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class cn extends Be{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class ln extends Be{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class un extends Be{constructor(){super(...arguments),this.sessions=new cn(this._client),this.transcriptionSessions=new ln(this._client)}}un.Sessions=cn,un.TranscriptionSessions=ln;class dn extends Be{create(e,t){return this._client.post("/chatkit/sessions",{body:e,...t,headers:en([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}cancel(e,t){return this._client.post(He`/chatkit/sessions/${e}/cancel`,{...t,headers:en([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}}class pn extends Be{retrieve(e,t){return this._client.get(He`/chatkit/threads/${e}`,{...t,headers:en([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}list(e={},t){return this._client.getAPIList("/chatkit/threads",Se,{query:e,...t,headers:en([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}delete(e,t){return this._client.delete(He`/chatkit/threads/${e}`,{...t,headers:en([{"OpenAI-Beta":"chatkit_beta=v1"},t?.headers])})}listItems(e,t={},n){return this._client.getAPIList(He`/chatkit/threads/${e}/items`,Se,{query:t,...n,headers:en([{"OpenAI-Beta":"chatkit_beta=v1"},n?.headers])})}}class hn extends Be{constructor(){super(...arguments),this.sessions=new dn(this._client),this.threads=new pn(this._client)}}hn.Sessions=dn,hn.Threads=pn;class mn extends Be{create(e,t,n){return this._client.post(He`/threads/${e}/messages`,{body:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{thread_id:r}=t;return this._client.get(He`/threads/${r}/messages/${e}`,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{thread_id:r,...s}=t;return this._client.post(He`/threads/${r}/messages/${e}`,{body:s,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(He`/threads/${e}/messages`,Oe,{query:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t,n){const{thread_id:r}=t;return this._client.delete(He`/threads/${r}/messages/${e}`,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}class fn extends Be{retrieve(e,t,n){const{thread_id:r,run_id:s,...a}=t;return this._client.get(He`/threads/${r}/runs/${s}/steps/${e}`,{query:a,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t,n){const{thread_id:r,...s}=t;return this._client.getAPIList(He`/threads/${r}/runs/${e}/steps`,Oe,{query:s,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}const gn=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;var yn,vn,wn,bn,xn,kn,Tn,In,En,On,Sn,An,$n,Cn,Nn,Pn,Rn,jn,Ln,Mn,zn,Un,Dn,Fn,Bn,Zn,qn,Vn,Hn,Wn,Gn,Jn,Kn,Xn,Yn,Qn,er,tr;class nr extends It{constructor(){super(...arguments),yn.add(this),wn.set(this,[]),bn.set(this,{}),xn.set(this,{}),kn.set(this,void 0),Tn.set(this,void 0),In.set(this,void 0),En.set(this,void 0),On.set(this,void 0),Sn.set(this,void 0),An.set(this,void 0),$n.set(this,void 0),Cn.set(this,void 0)}[(wn=new WeakMap,bn=new WeakMap,xn=new WeakMap,kn=new WeakMap,Tn=new WeakMap,In=new WeakMap,En=new WeakMap,On=new WeakMap,Sn=new WeakMap,An=new WeakMap,$n=new WeakMap,Cn=new WeakMap,yn=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const r=t.shift();r?r.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new vn;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=ve.fromReadableStream(e,this.controller);for await(const e of r)a(this,yn,"m",Nn).call(this,e);if(r.controller.signal?.aborted)throw new d;return this._addRun(a(this,yn,"m",Pn).call(this))}toReadableStream(){return new ve(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r){const s=new vn;return s._run(()=>s._runToolAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createToolAssistantStream(e,t,n,r){const s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...n,stream:!0},o=await e.submitToolOutputs(t,i,{...r,signal:this.controller.signal});this._connected();for await(const e of o)a(this,yn,"m",Nn).call(this,e);if(o.controller.signal?.aborted)throw new d;return this._addRun(a(this,yn,"m",Pn).call(this))}static createThreadAssistantStream(e,t,n){const r=new vn;return r._run(()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,t,n,r){const s=new vn;return s._run(()=>s._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return a(this,An,"f")}currentRun(){return a(this,$n,"f")}currentMessageSnapshot(){return a(this,kn,"f")}currentRunStepSnapshot(){return a(this,Cn,"f")}async finalRunSteps(){return await this.done(),Object.values(a(this,bn,"f"))}async finalMessages(){return await this.done(),Object.values(a(this,xn,"f"))}async finalRun(){if(await this.done(),!a(this,Tn,"f"))throw Error("Final run was not received.");return a(this,Tn,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const s={...t,stream:!0},i=await e.createAndRun(s,{...n,signal:this.controller.signal});this._connected();for await(const e of i)a(this,yn,"m",Nn).call(this,e);if(i.controller.signal?.aborted)throw new d;return this._addRun(a(this,yn,"m",Pn).call(this))}async _createAssistantStream(e,t,n,r){const s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...n,stream:!0},o=await e.create(t,i,{...r,signal:this.controller.signal});this._connected();for await(const e of o)a(this,yn,"m",Nn).call(this,e);if(o.controller.signal?.aborted)throw new d;return this._addRun(a(this,yn,"m",Pn).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else{if(!A(t)||!A(r)){if(Array.isArray(t)&&Array.isArray(r)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...r);continue}for(const e of r){if(!A(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const r=t[n];null==r?t.push(e):t[n]=this.accumulateDelta(r,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`)}t=this.accumulateDelta(t,r)}e[n]=t}else e[n]=r;else e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r){return await this._createToolAssistantStream(t,e,n,r)}}vn=nr,Nn=function(e){if(!this.ended)switch(s(this,An,e,"f"),a(this,yn,"m",Ln).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":a(this,yn,"m",Dn).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":a(this,yn,"m",jn).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":a(this,yn,"m",Rn).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Pn=function(){if(this.ended)throw new l("stream has ended, this shouldn't happen");if(!a(this,Tn,"f"))throw Error("Final run has not been received");return a(this,Tn,"f")},Rn=function(e){const[t,n]=a(this,yn,"m",zn).call(this,e,a(this,kn,"f"));s(this,kn,t,"f"),a(this,xn,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=a(this,In,"f")){if(a(this,En,"f"))switch(a(this,En,"f").type){case"text":this._emit("textDone",a(this,En,"f").text,a(this,kn,"f"));break;case"image_file":this._emit("imageFileDone",a(this,En,"f").image_file,a(this,kn,"f"))}s(this,In,n.index,"f")}s(this,En,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==a(this,In,"f")){const t=e.data.content[a(this,In,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,a(this,kn,"f"));break;case"text":this._emit("textDone",t.text,a(this,kn,"f"))}}a(this,kn,"f")&&this._emit("messageDone",e.data),s(this,kn,void 0,"f")}},jn=function(e){const t=a(this,yn,"m",Mn).call(this,e);switch(s(this,Cn,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==a(this,On,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(a(this,Sn,"f")&&this._emit("toolCallDone",a(this,Sn,"f")),s(this,On,e.index,"f"),s(this,Sn,t.step_details.tool_calls[e.index],"f"),a(this,Sn,"f")&&this._emit("toolCallCreated",a(this,Sn,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":s(this,Cn,void 0,"f"),"tool_calls"==e.data.step_details.type&&a(this,Sn,"f")&&(this._emit("toolCallDone",a(this,Sn,"f")),s(this,Sn,void 0,"f")),this._emit("runStepDone",e.data,t)}},Ln=function(e){a(this,wn,"f").push(e),this._emit("event",e)},Mn=function(e){switch(e.event){case"thread.run.step.created":return a(this,bn,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=a(this,bn,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=vn.accumulateDelta(t,n.delta);a(this,bn,"f")[e.data.id]=r}return a(this,bn,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":a(this,bn,"f")[e.data.id]=e.data}if(a(this,bn,"f")[e.data.id])return a(this,bn,"f")[e.data.id];throw new Error("No snapshot available")},zn=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=a(this,yn,"m",Un).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Un=function(e,t){return vn.accumulateDelta(t,e)},Dn=function(e){switch(s(this,$n,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":s(this,Tn,e.data,"f"),a(this,Sn,"f")&&(this._emit("toolCallDone",a(this,Sn,"f")),s(this,Sn,void 0,"f"))}};class rr extends Be{constructor(){super(...arguments),this.steps=new fn(this._client)}create(e,t,n){const{include:r,...s}=t;return this._client.post(He`/threads/${e}/runs`,{query:{include:r},body:s,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}retrieve(e,t,n){const{thread_id:r}=t;return this._client.get(He`/threads/${r}/runs/${e}`,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{thread_id:r,...s}=t;return this._client.post(He`/threads/${r}/runs/${e}`,{body:s,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(He`/threads/${e}/runs`,Oe,{query:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}cancel(e,t,n){const{thread_id:r}=t;return this._client.post(He`/threads/${r}/runs/${e}/cancel`,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(r.id,{thread_id:e},n)}createAndStream(e,t,n){return nr.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r=en([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:s,response:a}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await $(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,n){return nr.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n){const{thread_id:r,...s}=t;return this._client.post(He`/threads/${r}/runs/${e}/submit_tool_outputs`,{body:s,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,n){const r=await this.submitToolOutputs(e,t,n);return await this.poll(r.id,t,n)}submitToolOutputsStream(e,t,n){return nr.createToolAssistantStream(e,this._client.beta.threads.runs,t,n)}}rr.Steps=fn;class sr extends Be{constructor(){super(...arguments),this.runs=new rr(this._client),this.messages=new mn(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(He`/threads/${e}`,{...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(He`/threads/${e}`,{body:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t){return this._client.delete(He`/threads/${e}`,{...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.id,{thread_id:n.thread_id},t)}createAndRunStream(e,t){return nr.createThreadAssistantStream(e,this._client.beta.threads,t)}}sr.Runs=rr,sr.Messages=mn;class ar extends Be{constructor(){super(...arguments),this.realtime=new un(this._client),this.chatkit=new hn(this._client),this.assistants=new on(this._client),this.threads=new sr(this._client)}}ar.Realtime=un,ar.ChatKit=hn,ar.Assistants=on,ar.Threads=sr;class ir extends Be{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class or extends Be{retrieve(e,t,n){const{container_id:r}=t;return this._client.get(He`/containers/${r}/files/${e}/content`,{...n,headers:en([{Accept:"application/binary"},n?.headers]),__binaryResponse:!0})}}class cr extends Be{constructor(){super(...arguments),this.content=new or(this._client)}create(e,t,n){return this._client.post(He`/containers/${e}/files`,Re({body:t,...n},this._client))}retrieve(e,t,n){const{container_id:r}=t;return this._client.get(He`/containers/${r}/files/${e}`,n)}list(e,t={},n){return this._client.getAPIList(He`/containers/${e}/files`,Oe,{query:t,...n})}delete(e,t,n){const{container_id:r}=t;return this._client.delete(He`/containers/${r}/files/${e}`,{...n,headers:en([{Accept:"*/*"},n?.headers])})}}cr.Content=or;class lr extends Be{constructor(){super(...arguments),this.files=new cr(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(He`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",Oe,{query:e,...t})}delete(e,t){return this._client.delete(He`/containers/${e}`,{...t,headers:en([{Accept:"*/*"},t?.headers])})}}lr.Files=cr;class ur extends Be{create(e,t,n){const{include:r,...s}=t;return this._client.post(He`/conversations/${e}/items`,{query:{include:r},body:s,...n})}retrieve(e,t,n){const{conversation_id:r,...s}=t;return this._client.get(He`/conversations/${r}/items/${e}`,{query:s,...n})}list(e,t={},n){return this._client.getAPIList(He`/conversations/${e}/items`,Se,{query:t,...n})}delete(e,t,n){const{conversation_id:r}=t;return this._client.delete(He`/conversations/${r}/items/${e}`,n)}}class dr extends Be{constructor(){super(...arguments),this.items=new ur(this._client)}create(e={},t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(He`/conversations/${e}`,t)}update(e,t,n){return this._client.post(He`/conversations/${e}`,{body:t,...n})}delete(e,t){return this._client.delete(He`/conversations/${e}`,t)}}dr.Items=ur;class pr extends Be{create(e,t){const n=!!e.encoding_format;let r=n?e.encoding_format:"base64";n&&me(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);const s=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return n?s:(me(this._client).debug("embeddings/decoding base64 embeddings from base64"),s._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return Array.from(new Float32Array(r.buffer))}})(t)}),e)))}}class hr extends Be{retrieve(e,t,n){const{eval_id:r,run_id:s}=t;return this._client.get(He`/evals/${r}/runs/${s}/output_items/${e}`,n)}list(e,t,n){const{eval_id:r,...s}=t;return this._client.getAPIList(He`/evals/${r}/runs/${e}/output_items`,Oe,{query:s,...n})}}class mr extends Be{constructor(){super(...arguments),this.outputItems=new hr(this._client)}create(e,t,n){return this._client.post(He`/evals/${e}/runs`,{body:t,...n})}retrieve(e,t,n){const{eval_id:r}=t;return this._client.get(He`/evals/${r}/runs/${e}`,n)}list(e,t={},n){return this._client.getAPIList(He`/evals/${e}/runs`,Oe,{query:t,...n})}delete(e,t,n){const{eval_id:r}=t;return this._client.delete(He`/evals/${r}/runs/${e}`,n)}cancel(e,t,n){const{eval_id:r}=t;return this._client.post(He`/evals/${r}/runs/${e}`,n)}}mr.OutputItems=hr;class fr extends Be{constructor(){super(...arguments),this.runs=new mr(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(He`/evals/${e}`,t)}update(e,t,n){return this._client.post(He`/evals/${e}`,{body:t,...n})}list(e={},t){return this._client.getAPIList("/evals",Oe,{query:e,...t})}delete(e,t){return this._client.delete(He`/evals/${e}`,t)}}fr.Runs=mr;class gr extends Be{create(e,t){return this._client.post("/files",Re({body:e,...t},this._client))}retrieve(e,t){return this._client.get(He`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",Oe,{query:e,...t})}delete(e,t){return this._client.delete(He`/files/${e}`,t)}content(e,t){return this._client.get(He`/files/${e}/content`,{...t,headers:en([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),s=Date.now();let a=await this.retrieve(e);for(;!a.status||!r.has(a.status);)if(await $(t),a=await this.retrieve(e),Date.now()-s>n)throw new h({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}}class yr extends Be{}class _r extends Be{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class vr extends Be{constructor(){super(...arguments),this.graders=new _r(this._client)}}vr.Graders=_r;class wr extends Be{create(e,t,n){return this._client.getAPIList(He`/fine_tuning/checkpoints/${e}/permissions`,Ee,{body:t,method:"post",...n})}retrieve(e,t={},n){return this._client.get(He`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...n})}delete(e,t,n){const{fine_tuned_model_checkpoint:r}=t;return this._client.delete(He`/fine_tuning/checkpoints/${r}/permissions/${e}`,n)}}class br extends Be{constructor(){super(...arguments),this.permissions=new wr(this._client)}}br.Permissions=wr;class xr extends Be{list(e,t={},n){return this._client.getAPIList(He`/fine_tuning/jobs/${e}/checkpoints`,Oe,{query:t,...n})}}class kr extends Be{constructor(){super(...arguments),this.checkpoints=new xr(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(He`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",Oe,{query:e,...t})}cancel(e,t){return this._client.post(He`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return this._client.getAPIList(He`/fine_tuning/jobs/${e}/events`,Oe,{query:t,...n})}pause(e,t){return this._client.post(He`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(He`/fine_tuning/jobs/${e}/resume`,t)}}kr.Checkpoints=xr;class Tr extends Be{constructor(){super(...arguments),this.methods=new yr(this._client),this.jobs=new kr(this._client),this.checkpoints=new br(this._client),this.alpha=new vr(this._client)}}Tr.Methods=yr,Tr.Jobs=kr,Tr.Checkpoints=br,Tr.Alpha=vr;class Ir extends Be{}class Er extends Be{constructor(){super(...arguments),this.graderModels=new Ir(this._client)}}Er.GraderModels=Ir;class Or extends Be{createVariation(e,t){return this._client.post("/images/variations",Re({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",Re({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class Sr extends Be{retrieve(e,t){return this._client.get(He`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Ee,e)}delete(e,t){return this._client.delete(He`/models/${e}`,t)}}class Ar extends Be{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class $r extends Be{accept(e,t,n){return this._client.post(He`/realtime/calls/${e}/accept`,{body:t,...n,headers:en([{Accept:"*/*"},n?.headers])})}hangup(e,t){return this._client.post(He`/realtime/calls/${e}/hangup`,{...t,headers:en([{Accept:"*/*"},t?.headers])})}refer(e,t,n){return this._client.post(He`/realtime/calls/${e}/refer`,{body:t,...n,headers:en([{Accept:"*/*"},n?.headers])})}reject(e,t={},n){return this._client.post(He`/realtime/calls/${e}/reject`,{body:t,...n,headers:en([{Accept:"*/*"},n?.headers])})}}class Cr extends Be{create(e,t){return this._client.post("/realtime/client_secrets",{body:e,...t})}}class Nr extends Be{constructor(){super(...arguments),this.clientSecrets=new Cr(this._client),this.calls=new $r(this._client)}}function Pr(e,t){const n=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:Lr(t,e)};if("message"===e.type){const n=e.content.map(e=>"output_text"===e.type?{...e,parsed:Rr(t,e.text)}:e);return{...e,content:n}}return e}),r=Object.assign({},e,{output:n});return Object.getOwnPropertyDescriptor(e,"output_text")||Mr(r),Object.defineProperty(r,"output_parsed",{enumerable:!0,get(){for(const e of r.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),r}function Rr(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const n=e.text?.format;return n.$parseRaw(t)}return JSON.parse(t)}function jr(e){return"auto-parseable-tool"===e?.$brand}function Lr(e,t){const n=(r=e.tools??[],s=t.name,r.find(e=>"function"===e.type&&e.name===s));var r,s;return{...t,...t,parsed_arguments:jr(n)?n.$parseRaw(t.arguments):n?.strict?JSON.parse(t.arguments):null}}function Mr(e){const t=[];for(const n of e.output)if("message"===n.type)for(const e of n.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}Nr.ClientSecrets=Cr,Nr.Calls=$r;class zr extends It{constructor(e){super(),Fn.add(this),Bn.set(this,void 0),Zn.set(this,void 0),qn.set(this,void 0),s(this,Bn,e,"f")}static createResponse(e,t,n){const r=new zr(t);return r._run(()=>r._createOrRetrieveResponse(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(e,t,n){const r=n?.signal;let s;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),a(this,Fn,"m",Vn).call(this);let i=null;"response_id"in t?(s=await e.responses.retrieve(t.response_id,{stream:!0},{...n,signal:this.controller.signal,stream:!0}),i=t.starting_after??null):s=await e.responses.create({...t,stream:!0},{...n,signal:this.controller.signal}),this._connected();for await(const e of s)a(this,Fn,"m",Hn).call(this,e,i);if(s.controller.signal?.aborted)throw new d;return a(this,Fn,"m",Wn).call(this)}[(Bn=new WeakMap,Zn=new WeakMap,qn=new WeakMap,Fn=new WeakSet,Vn=function(){this.ended||s(this,Zn,void 0,"f")},Hn=function(e,t){if(this.ended)return;const n=(e,n)=>{(null==t||n.sequence_number>t)&&this._emit(e,n)},r=a(this,Fn,"m",Gn).call(this,e);switch(n("event",e),e.type){case"response.output_text.delta":{const t=r.output[e.output_index];if(!t)throw new l(`missing output at index ${e.output_index}`);if("message"===t.type){const r=t.content[e.content_index];if(!r)throw new l(`missing content at index ${e.content_index}`);if("output_text"!==r.type)throw new l(`expected content to be 'output_text', got ${r.type}`);n("response.output_text.delta",{...e,snapshot:r.text})}break}case"response.function_call_arguments.delta":{const t=r.output[e.output_index];if(!t)throw new l(`missing output at index ${e.output_index}`);"function_call"===t.type&&n("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:n(e.type,e)}},Wn=function(){if(this.ended)throw new l("stream has ended, this shouldn't happen");const e=a(this,Zn,"f");if(!e)throw new l("request ended without sending any events");s(this,Zn,void 0,"f");const t=function(e,t){return function(e,t){return t&&function(e){return!!Je(e.text?.format)}(t)?Pr(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,t)}(e,a(this,Bn,"f"));return s(this,qn,t,"f"),t},Gn=function(e){let t=a(this,Zn,"f");if(!t){if("response.created"!==e.type)throw new l(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=s(this,Zn,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const n=t.output[e.output_index];if(!n)throw new l(`missing output at index ${e.output_index}`);const r=n.type,s=e.part;"message"===r&&"reasoning_text"!==s.type?n.content.push(s):"reasoning"===r&&"reasoning_text"===s.type&&(n.content||(n.content=[]),n.content.push(s));break}case"response.output_text.delta":{const n=t.output[e.output_index];if(!n)throw new l(`missing output at index ${e.output_index}`);if("message"===n.type){const t=n.content[e.content_index];if(!t)throw new l(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new l(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const n=t.output[e.output_index];if(!n)throw new l(`missing output at index ${e.output_index}`);"function_call"===n.type&&(n.arguments+=e.delta);break}case"response.reasoning_text.delta":{const n=t.output[e.output_index];if(!n)throw new l(`missing output at index ${e.output_index}`);if("reasoning"===n.type){const t=n.content?.[e.content_index];if(!t)throw new l(`missing content at index ${e.content_index}`);if("reasoning_text"!==t.type)throw new l(`expected content to be 'reasoning_text', got ${t.type}`);t.text+=e.delta}break}case"response.completed":s(this,Zn,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",n=>{const r=t.shift();r?r.resolve(n):e.push(n)}),this.on("end",()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),this.on("error",e=>{n=!0;for(const n of t)n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:n?{value:void 0,done:!0}:new Promise((e,n)=>t.push({resolve:e,reject:n})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=a(this,qn,"f");if(!e)throw new l("stream ended without producing a ChatCompletion");return e}}class Ur extends Be{list(e,t={},n){return this._client.getAPIList(He`/responses/${e}/input_items`,Oe,{query:t,...n})}}class Dr extends Be{count(e={},t){return this._client.post("/responses/input_tokens",{body:e,...t})}}class Fr extends Be{constructor(){super(...arguments),this.inputItems=new Ur(this._client),this.inputTokens=new Dr(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&Mr(e),e))}retrieve(e,t={},n){return this._client.get(He`/responses/${e}`,{query:t,...n,stream:t?.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&Mr(e),e))}delete(e,t){return this._client.delete(He`/responses/${e}`,{...t,headers:en([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>Pr(t,e))}stream(e,t){return zr.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(He`/responses/${e}/cancel`,t)}compact(e,t){return this._client.post("/responses/compact",{body:e,...t})}}Fr.InputItems=Ur,Fr.InputTokens=Dr;class Br extends Be{create(e,t,n){return this._client.post(He`/uploads/${e}/parts`,Re({body:t,...n},this._client))}}class Zr extends Be{constructor(){super(...arguments),this.parts=new Br(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(He`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(He`/uploads/${e}/complete`,{body:t,...n})}}Zr.Parts=Br;class qr extends Be{create(e,t,n){return this._client.post(He`/vector_stores/${e}/file_batches`,{body:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{vector_store_id:r}=t;return this._client.get(He`/vector_stores/${r}/file_batches/${e}`,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}cancel(e,t,n){const{vector_store_id:r}=t;return this._client.post(He`/vector_stores/${r}/file_batches/${e}/cancel`,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n){const{vector_store_id:r,...s}=t;return this._client.getAPIList(He`/vector_stores/${r}/file_batches/${e}/files`,Oe,{query:s,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async poll(e,t,n){const r=en([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const{data:s,response:a}=await this.retrieve(t,{vector_store_id:e},{...n,headers:r}).withResponse();switch(s.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await $(e);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const s=r?.maxConcurrency??5,a=Math.min(s,t.length),i=this._client,o=t.values(),c=[...n],l=Array(a).fill(o).map(async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},r);c.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),n=t.filter(e=>"rejected"===e.status);if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(l),await this.createAndPoll(e,{file_ids:c})}}class Vr extends Be{create(e,t,n){return this._client.post(He`/vector_stores/${e}/files`,{body:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}retrieve(e,t,n){const{vector_store_id:r}=t;return this._client.get(He`/vector_stores/${r}/files/${e}`,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}update(e,t,n){const{vector_store_id:r,...s}=t;return this._client.post(He`/vector_stores/${r}/files/${e}`,{body:s,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e,t={},n){return this._client.getAPIList(He`/vector_stores/${e}/files`,Oe,{query:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}delete(e,t,n){const{vector_store_id:r}=t;return this._client.delete(He`/vector_stores/${r}/files/${e}`,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r=en([n?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":n?.pollIntervalMs?.toString()??void 0}]);for(;;){const s=await this.retrieve(t,{vector_store_id:e},{...n,headers:r}).withResponse(),a=s.data;switch(a.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await $(e);break;case"failed":case"completed":return a}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}content(e,t,n){const{vector_store_id:r}=t;return this._client.getAPIList(He`/vector_stores/${r}/files/${e}/content`,Ee,{...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}class Hr extends Be{constructor(){super(...arguments),this.files=new Vr(this._client),this.fileBatches=new qr(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(He`/vector_stores/${e}`,{...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,n){return this._client.post(He`/vector_stores/${e}`,{body:t,...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",Oe,{query:e,...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(He`/vector_stores/${e}`,{...t,headers:en([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,n){return this._client.getAPIList(He`/vector_stores/${e}/search`,Ee,{body:t,method:"post",...n,headers:en([{"OpenAI-Beta":"assistants=v2"},n?.headers])})}}Hr.Files=Vr,Hr.FileBatches=qr;class Wr extends Be{create(e,t){return this._client.post("/videos",Pe({body:e,...t},this._client))}retrieve(e,t){return this._client.get(He`/videos/${e}`,t)}list(e={},t){return this._client.getAPIList("/videos",Se,{query:e,...t})}delete(e,t){return this._client.delete(He`/videos/${e}`,t)}downloadContent(e,t={},n){return this._client.get(He`/videos/${e}/content`,{query:t,...n,headers:en([{Accept:"application/binary"},n?.headers]),__binaryResponse:!0})}remix(e,t,n){return this._client.post(He`/videos/${e}/remix`,Pe({body:t,...n},this._client))}}class Gr extends Be{constructor(){super(...arguments),Jn.add(this)}async unwrap(e,t,n=this._client.webhookSecret,r=300){return await this.verifySignature(e,t,n,r),JSON.parse(e)}async verifySignature(e,t,n=this._client.webhookSecret,r=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw new Error("Webhook signature verification is only supported when the `crypto` global is defined");a(this,Jn,"m",Kn).call(this,n);const s=en([t]).values,i=a(this,Jn,"m",Xn).call(this,s,"webhook-signature"),o=a(this,Jn,"m",Xn).call(this,s,"webhook-timestamp"),c=a(this,Jn,"m",Xn).call(this,s,"webhook-id"),l=parseInt(o,10);if(isNaN(l))throw new T("Invalid webhook timestamp format");const u=Math.floor(Date.now()/1e3);if(u-l>r)throw new T("Webhook timestamp is too old");if(l>u+r)throw new T("Webhook timestamp is too new");const d=i.split(" ").map(e=>e.startsWith("v1,")?e.substring(3):e),p=n.startsWith("whsec_")?Buffer.from(n.replace("whsec_",""),"base64"):Buffer.from(n,"utf-8"),h=c?`${c}.${o}.${e}`:`${o}.${e}`,m=await crypto.subtle.importKey("raw",p,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(const e of d)try{const t=Buffer.from(e,"base64");if(await crypto.subtle.verify("HMAC",m,t,(new TextEncoder).encode(h)))return}catch{continue}throw new T("The given webhook signature does not match the expected signature")}}Jn=new WeakSet,Kn=function(e){if("string"!=typeof e||0===e.length)throw new Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},Xn=function(e,t){if(!e)throw new Error("Headers are required");const n=e.get(t);if(null==n)throw new Error(`Missing required header: ${t}`);return n};class Jr{constructor({baseURL:e=gn("OPENAI_BASE_URL"),apiKey:t=gn("OPENAI_API_KEY"),organization:n=gn("OPENAI_ORG_ID")??null,project:r=gn("OPENAI_PROJECT_ID")??null,webhookSecret:a=gn("OPENAI_WEBHOOK_SECRET")??null,...i}={}){if(Yn.add(this),er.set(this,void 0),this.completions=new ir(this),this.chat=new Xt(this),this.embeddings=new pr(this),this.files=new gr(this),this.images=new Or(this),this.audio=new sn(this),this.moderations=new Ar(this),this.models=new Sr(this),this.fineTuning=new Tr(this),this.graders=new Er(this),this.vectorStores=new Hr(this),this.webhooks=new Gr(this),this.beta=new ar(this),this.batches=new an(this),this.uploads=new Zr(this),this.responses=new Fr(this),this.realtime=new Nr(this),this.conversations=new dr(this),this.evals=new fr(this),this.containers=new lr(this),this.videos=new Wr(this),void 0===t)throw new l("Missing credentials. Please pass an `apiKey`, or set the `OPENAI_API_KEY` environment variable.");const o={apiKey:t,organization:n,project:r,webhookSecret:a,...i,baseURL:e||"https://api.openai.com/v1"};if(!o.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new l("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=o.baseURL,this.timeout=o.timeout??Qn.DEFAULT_TIMEOUT,this.logger=o.logger??console;const c="warn";this.logLevel=c,this.logLevel=le(o.logLevel,"ClientOptions.logLevel",this)??le(gn("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??c,this.fetchOptions=o.fetchOptions,this.maxRetries=o.maxRetries??2,this.fetch=o.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw new Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),s(this,er,U,"f"),this._options=o,this.apiKey="string"==typeof t?t:"Missing Key",this.organization=n,this.project=r,this.webhookSecret=a}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return en([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return function(e,t={}){let n=e;const r=function(e=K){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||K.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=D;if(void 0!==e.format){if(!Z(B,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const r=B[n];let s,a=K.filter;if(("function"==typeof e.filter||E(e.filter))&&(a=e.filter),s=e.arrayFormat&&e.arrayFormat in W?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":K.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||K.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:K.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:K.allowEmptyArrays,arrayFormat:s,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:K.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?K.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:K.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:K.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:K.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:K.encodeValuesOnly,filter:a,format:n,formatter:r,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:K.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:K.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:K.strictNullHandling}}(t);let s,a;"function"==typeof r.filter?(a=r.filter,n=a("",n)):E(r.filter)&&(a=r.filter,s=a);const i=[];if("object"!=typeof n||null===n)return"";const o=W[r.arrayFormat],c="comma"===o&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const l=new WeakMap;for(let e=0;e<s.length;++e){const t=s[e];r.skipNulls&&null===n[t]||G(i,Y(n[t],t,o,c,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,l))}const u=i.join(r.delimiter);let d=!0===r.addQueryPrefix?"?":"";return r.charsetSentinel&&("iso-8859-1"===r.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${C}`}defaultIdempotencyKey(){return`stainless-node-retry-${i()}`}makeStatusError(e,t,n,r){return u.generate(e,t,n,r)}async _callApiKey(){const e=this._options.apiKey;if("function"!=typeof e)return!1;let t;try{t=await e()}catch(e){if(e instanceof l)throw e;throw new l(`Failed to get token from 'apiKey' function: ${e.message}`,{cause:e})}if("string"!=typeof t||!t)throw new l(`Expected 'apiKey' function argument to return a string but it returned ${t}`);return this.apiKey=t,!0}buildURL(e,t,n){const r=!a(this,Yn,"m",tr).call(this)&&n||this.baseURL,s=(e=>I.test(e))(e)?new URL(e):new URL(r+(r.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),i=this.defaultQuery();return function(e){if(!e)return!0;for(const t in e)return!1;return!0}(i)||(t={...i,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(s.search=this.stringifyQuery(t)),s.toString()}async prepareOptions(e){await this._callApiKey()}async prepareRequest(e,{url:t,options:n}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then(n=>({method:e,path:t,...n})))}request(e,t=null){return new ke(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,n){const r=await e,s=r.maxRetries??this.maxRetries;null==t&&(t=s),await this.prepareOptions(r);const{req:a,url:i,timeout:l}=await this.buildRequest(r,{retryCount:s-t});await this.prepareRequest(a,{url:i,options:r});const u="log_"+(Math.random()*(1<<24)|0).toString(16).padStart(6,"0"),m=void 0===n?"":`, retryOf: ${n}`,f=Date.now();if(me(this).debug(`[${u}] sending request`,fe({retryOfRequestLogID:n,method:r.method,url:i,options:r,headers:a.headers})),r.signal?.aborted)throw new d;const g=new AbortController,y=await this.fetchWithTimeout(i,a,l,g).catch(c),_=Date.now();if(y instanceof globalThis.Error){const e=`retrying, ${t} attempts remaining`;if(r.signal?.aborted)throw new d;const s=o(y)||/timed? ?out/i.test(String(y)+("cause"in y?String(y.cause):""));if(t)return me(this).info(`[${u}] connection ${s?"timed out":"failed"} - ${e}`),me(this).debug(`[${u}] connection ${s?"timed out":"failed"} (${e})`,fe({retryOfRequestLogID:n,url:i,durationMs:_-f,message:y.message})),this.retryRequest(r,t,n??u);if(me(this).info(`[${u}] connection ${s?"timed out":"failed"} - error; no more retries left`),me(this).debug(`[${u}] connection ${s?"timed out":"failed"} (error; no more retries left)`,fe({retryOfRequestLogID:n,url:i,durationMs:_-f,message:y.message})),s)throw new h;throw new p({cause:y})}const v=`[${u}${m}${[...y.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join("")}] ${a.method} ${i} ${y.ok?"succeeded":"failed"} with status ${y.status} in ${_-f}ms`;if(!y.ok){const e=await this.shouldRetry(y);if(t&&e){const e=`retrying, ${t} attempts remaining`;return await async function(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void await(e[Symbol.asyncIterator]().return?.());const t=e.getReader(),n=t.cancel();t.releaseLock(),await n}(y.body),me(this).info(`${v} - ${e}`),me(this).debug(`[${u}] response error (${e})`,fe({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,durationMs:_-f})),this.retryRequest(r,t,n??u,y.headers)}const s=e?"error; no more retries left":"error; not retryable";me(this).info(`${v} - ${s}`);const a=await y.text().catch(e=>c(e).message),i=(e=>{try{return JSON.parse(e)}catch(e){return}})(a),o=i?void 0:a;throw me(this).debug(`[${u}] response error (${s})`,fe({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,message:o,durationMs:Date.now()-f})),this.makeStatusError(y.status,i,o,y.headers)}return me(this).info(v),me(this).debug(`[${u}] response start`,fe({retryOfRequestLogID:n,url:y.url,status:y.status,headers:y.headers,durationMs:_-f})),{response:y,options:r,controller:g,requestLogID:u,retryOfRequestLogID:n,startTime:f}}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}requestAPIList(e,t){const n=this.makeRequest(t,null,void 0);return new Ie(this,n,e)}async fetchWithTimeout(e,t,n,r){const{signal:s,method:a,...i}=t||{};s&&s.addEventListener("abort",()=>r.abort());const o=setTimeout(()=>r.abort(),n),c=globalThis.ReadableStream&&i.body instanceof globalThis.ReadableStream||"object"==typeof i.body&&null!==i.body&&Symbol.asyncIterator in i.body,l={signal:r.signal,...c?{duplex:"half"}:{},method:"GET",...i};a&&(l.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,l)}finally{clearTimeout(o)}}async shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,n,r){let s;const a=r?.get("retry-after-ms");if(a){const e=parseFloat(a);Number.isNaN(e)||(s=e)}const i=r?.get("retry-after");if(i&&!s){const e=parseFloat(i);s=Number.isNaN(e)?Date.parse(i)-Date.now():1e3*e}if(!(s&&0<=s&&s<6e4)){const n=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,n)}return await $(s),this.makeRequest(e,t-1,n)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}async buildRequest(e,{retryCount:t=0}={}){const n={...e},{method:r,path:s,query:a,defaultBaseURL:i}=n,o=this.buildURL(s,a,i);"timeout"in n&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new l(`${e} must be an integer`);if(t<0)throw new l(`${e} must be a positive integer`)})("timeout",n.timeout),n.timeout=n.timeout??this.timeout;const{bodyHeaders:c,body:u}=this.buildBody({options:n});return{req:{method:r,headers:await this.buildHeaders({options:e,method:r,bodyHeaders:c,retryCount:t}),...n.signal&&{signal:n.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...n.fetchOptions??{}},url:o,timeout:n.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:n,retryCount:r}){let s={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);const a=en([s,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(r),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...j??(j=N()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,n,e.headers]);return this.validateHeaders(a),a.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};const n=en([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&n.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:M(e)}:a(this,er,"f").call(this,{body:e,headers:n})}}function Kr(e){if(!e||"object"!=typeof e)return e;let t;return e.constructor.name===h.name&&"message"in e&&"string"==typeof e.message?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===d.name&&"message"in e&&"string"==typeof e.message?(t=new Error(e.message),t.name="AbortError"):t="status"in e&&400===e.status&&"message"in e&&"string"==typeof e.message&&e.message.includes("tool_calls")?r(e,"INVALID_TOOL_RESULTS"):"status"in e&&401===e.status?r(e,"MODEL_AUTHENTICATION"):"status"in e&&429===e.status?r(e,"MODEL_RATE_LIMIT"):"status"in e&&404===e.status?r(e,"MODEL_NOT_FOUND"):e,t}Qn=Jr,er=new WeakMap,Yn=new WeakSet,tr=function(){return"https://api.openai.com/v1"!==this.baseURL},Jr.OpenAI=Qn,Jr.DEFAULT_TIMEOUT=6e5,Jr.OpenAIError=l,Jr.APIError=u,Jr.APIConnectionError=p,Jr.APIConnectionTimeoutError=h,Jr.APIUserAbortError=d,Jr.NotFoundError=y,Jr.ConflictError=_,Jr.RateLimitError=w,Jr.BadRequestError=m,Jr.AuthenticationError=f,Jr.InternalServerError=b,Jr.PermissionDeniedError=g,Jr.UnprocessableEntityError=v,Jr.InvalidWebhookSignatureError=T,Jr.toFile=async function(e,t,n){if(Ae(),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&De(e))(e=await e))return e instanceof File?e:$e([await e.arrayBuffer()],e.name);if((e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const r=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),$e(await Fe(r),t,n)}const r=await Fe(e);if(t||(t=Ce(e)),!n?.type){const e=r.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(n={...n,type:e})}return $e(r,t,n)},Jr.Completions=ir,Jr.Chat=Xt,Jr.Embeddings=pr,Jr.Files=gr,Jr.Images=Or,Jr.Audio=sn,Jr.Moderations=Ar,Jr.Models=Sr,Jr.FineTuning=Tr,Jr.Graders=Er,Jr.VectorStores=Hr,Jr.Webhooks=Gr,Jr.Beta=ar,Jr.Batches=an,Jr.Uploads=Zr,Jr.Responses=Fr,Jr.Realtime=Nr,Jr.Conversations=dr,Jr.Evals=fr,Jr.Containers=lr,Jr.Videos=Wr,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/batches","/images/edits"]);var Xr=Object.defineProperty,Yr=(e,t)=>{for(var n in t)Xr(e,n,{get:t[n],enumerable:!0})};function Qr(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"source_type"in e&&("url"===e.source_type||"base64"===e.source_type||"text"===e.source_type||"id"===e.source_type)}function es(e){return Qr(e)&&"url"===e.source_type&&"url"in e&&"string"==typeof e.url}function ts(e){return Qr(e)&&"base64"===e.source_type&&"data"in e&&"string"==typeof e.data}function ns(e){return Qr(e)&&"text"===e.source_type&&"text"in e&&"string"==typeof e.text}function rs(e){return Qr(e)&&"id"===e.source_type&&"id"in e&&"string"==typeof e.id}function ss(e){if(Qr(e)){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url}};if("base64"===e.source_type){if(!e.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${e.mime_type};base64,${e.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function as(e){const t=e.split(";")[0].split("/");if(2!==t.length)throw new Error(`Invalid mime type: "${e}" - does not match type/subtype format.`);const n=t[0].trim(),r=t[1].trim();if(""===n||""===r)throw new Error(`Invalid mime type: "${e}" - type or subtype is empty.`);const s={};for(const t of e.split(";").slice(1)){const n=t.split("=");if(2!==n.length)throw new Error(`Invalid parameter syntax in mime type: "${e}".`);const r=n[0].trim(),a=n[1].trim();if(""===r)throw new Error(`Invalid parameter syntax in mime type: "${e}".`);s[r]=a}return{type:n,subtype:r,parameters:s}}function is({dataUrl:e,asTypedArray:t=!1}){const n=e.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);let r;if(n)return r=n[1].toLowerCase(),{mime_type:r,data:t?Uint8Array.from(atob(n[2]),e=>e.charCodeAt(0)):n[2]}}function os(e,t){if("text"===e.type){if(!t.fromStandardTextBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardTextBlock\` method.`);return t.fromStandardTextBlock(e)}if("image"===e.type){if(!t.fromStandardImageBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardImageBlock\` method.`);return t.fromStandardImageBlock(e)}if("audio"===e.type){if(!t.fromStandardAudioBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardAudioBlock\` method.`);return t.fromStandardAudioBlock(e)}if("file"===e.type){if(!t.fromStandardFileBlock)throw new Error(`Converter for ${t.providerName} does not implement \`fromStandardFileBlock\` method.`);return t.fromStandardFileBlock(e)}throw new Error(`Unable to convert content block type '${e.type}' to provider-specific format: not recognized.`)}function cs(e){return"object"==typeof e&&null!==e&&"type"in e&&"content"in e&&("string"==typeof e.content||Array.isArray(e.content))}var ls=n(9478);function us(e,t){return t?.[e]||ls(e)}n(2729);const ds="__lc_escaped__";function ps(e){if(null!==e&&"object"==typeof e&&!Array.isArray(e)){if(null!==(t=e)&&"object"==typeof t&&"lc_serializable"in t&&"function"==typeof t.toJSON)return e;const n=e;if(function(e){return"lc"in e||1===Object.keys(e).length&&ds in e}(n))return function(e){return{[ds]:e}}(n);const r={};for(const[e,t]of Object.entries(n))r[e]=ps(t);return r}var t;return Array.isArray(e)?e.map(e=>ps(e)):e}function hs(e){return Array.isArray(e)?[...e]:{...e}}function ms(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}Yr({},{Serializable:()=>fs,get_lc_unique_name:()=>ms});var fs=class e{lc_serializable=!1;lc_kwargs;static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ms(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){void 0!==this.lc_serializable_keys?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([e])=>this.lc_serializable_keys?.includes(e))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof e||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const t={},n={},r=Object.keys(this.lc_kwargs).reduce((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e),{});for(let e=Object.getPrototypeOf(this);e;e=Object.getPrototypeOf(e))Object.assign(t,Reflect.get(e,"lc_aliases",this)),Object.assign(n,Reflect.get(e,"lc_secrets",this)),Object.assign(r,Reflect.get(e,"lc_attributes",this));Object.keys(n).forEach(e=>{let t=this,n=r;const[s,...a]=e.split(".").reverse();for(const e of a.reverse()){if(!(e in t)||void 0===t[e])return;e in n&&void 0!==n[e]||("object"==typeof t[e]&&null!=t[e]?n[e]={}:Array.isArray(t[e])&&(n[e]=[])),t=t[e],n=n[e]}s in t&&void 0!==t[s]&&(n[s]=n[s]||t[s])});const s={};for(const[e,t]of Object.entries(r))s[e]=ps(t);const a=Object.keys(n).length?function(e,t){const n=hs(e);for(const[e,r]of Object.entries(t)){const[t,...s]=e.split(".").reverse();let a=n;for(const e of s.reverse()){if(void 0===a[e])break;a[e]=hs(a[e]),a=a[e]}void 0!==a[t]&&(a[t]={lc:1,type:"secret",id:[r]})}return n}(s,n):s,i=function(e,t,n){const r={};for(const s in e)Object.hasOwn(e,s)&&(r[t(s,n)]=e[s]);return r}(a,us,t);return{lc:1,type:"constructor",id:this.lc_id,kwargs:i}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function gs(e,t){return ys(e)&&e.type===t}function ys(e){return"object"==typeof e&&null!==e}function _s(e){return Array.isArray(e)}function vs(e){return"string"==typeof e}function ws(e){return"number"==typeof e}function bs(e){return e instanceof Uint8Array}function xs(e){try{return JSON.parse(e)}catch{return}}const ks=e=>e();function Ts(e){if("char_location"===e.type&&vs(e.document_title)&&ws(e.start_char_index)&&ws(e.end_char_index)&&vs(e.cited_text)){const{document_title:t,start_char_index:n,end_char_index:r,cited_text:s,...a}=e;return{...a,type:"citation",source:"char",title:t??void 0,startIndex:n,endIndex:r,citedText:s}}if("page_location"===e.type&&vs(e.document_title)&&ws(e.start_page_number)&&ws(e.end_page_number)&&vs(e.cited_text)){const{document_title:t,start_page_number:n,end_page_number:r,cited_text:s,...a}=e;return{...a,type:"citation",source:"page",title:t??void 0,startIndex:n,endIndex:r,citedText:s}}if("content_block_location"===e.type&&vs(e.document_title)&&ws(e.start_block_index)&&ws(e.end_block_index)&&vs(e.cited_text)){const{document_title:t,start_block_index:n,end_block_index:r,cited_text:s,...a}=e;return{...a,type:"citation",source:"block",title:t??void 0,startIndex:n,endIndex:r,citedText:s}}if("web_search_result_location"===e.type&&vs(e.url)&&vs(e.title)&&vs(e.encrypted_index)&&vs(e.cited_text)){const{url:t,title:n,encrypted_index:r,cited_text:s,...a}=e;return{...a,type:"citation",source:"url",url:t,title:n,startIndex:Number(r),endIndex:Number(r),citedText:s}}if("search_result_location"===e.type&&vs(e.source)&&vs(e.title)&&ws(e.start_block_index)&&ws(e.end_block_index)&&vs(e.cited_text)){const{source:t,title:n,start_block_index:r,end_block_index:s,cited_text:a,...i}=e;return{...i,type:"citation",source:"search",url:t,title:n??void 0,startIndex:r,endIndex:s,citedText:a}}}function Is(e){if(gs(e,"document")&&ys(e.source)&&"type"in e.source){if("base64"===e.source.type&&vs(e.source.media_type)&&vs(e.source.data))return{type:"file",mimeType:e.source.media_type,data:e.source.data};if("url"===e.source.type&&vs(e.source.url))return{type:"file",url:e.source.url};if("file"===e.source.type&&vs(e.source.file_id))return{type:"file",fileId:e.source.file_id};if("text"===e.source.type&&vs(e.source.data))return{type:"file",mimeType:String(e.source.media_type??"text/plain"),data:e.source.data}}else if(gs(e,"image")&&ys(e.source)&&"type"in e.source){if("base64"===e.source.type&&vs(e.source.media_type)&&vs(e.source.data))return{type:"image",mimeType:e.source.media_type,data:e.source.data};if("url"===e.source.type&&vs(e.source.url))return{type:"image",url:e.source.url};if("file"===e.source.type&&vs(e.source.file_id))return{type:"image",fileId:e.source.file_id}}}function Es(e){return Array.from(function*(){for(const t of e){const e=Is(t);e?yield e:yield t}}())}function Os(e){return Array.from(function*(){const t="string"==typeof e.content?[{type:"text",text:e.content}]:e.content;for(const n of t){if(gs(n,"text")&&vs(n.text)){const{text:e,citations:t,...r}=n;if(_s(t)&&t.length){const n=t.reduce((e,t)=>{const n=Ts(t);return n?[...e,n]:e},[]);yield{...r,type:"text",text:e,annotations:n};continue}yield{...r,type:"text",text:e};continue}if(gs(n,"thinking")&&vs(n.thinking)){const{thinking:e,signature:t,...r}=n;yield{...r,type:"reasoning",reasoning:e,signature:t};continue}if(gs(n,"redacted_thinking"))yield{type:"non_standard",value:n};else if(gs(n,"tool_use")&&vs(n.name)&&vs(n.id))yield{type:"tool_call",id:n.id,name:n.name,args:n.input};else{if(gs(n,"input_json_delta")){if(As(e)&&e.tool_call_chunks?.length){const t=e.tool_call_chunks[0];yield{type:"tool_call_chunk",id:t.id,name:t.name,args:t.args,index:t.index};continue}}else if(gs(n,"server_tool_use")&&vs(n.name)&&vs(n.id)){const{name:e,id:t}=n;if("web_search"===e){const e=ks(()=>{if("string"==typeof n.input)return n.input;if(ys(n.input)&&vs(n.input.query))return n.input.query;if(vs(n.partial_json)){const e=xs(n.partial_json);if(e?.query)return e.query}return""});yield{id:t,type:"server_tool_call",name:"web_search",args:{query:e}};continue}if("code_execution"===n.name){const e=ks(()=>{if("string"==typeof n.input)return n.input;if(ys(n.input)&&vs(n.input.code))return n.input.code;if(vs(n.partial_json)){const e=xs(n.partial_json);if(e?.code)return e.code}return""});yield{id:t,type:"server_tool_call",name:"code_execution",args:{code:e}};continue}}else{if(gs(n,"web_search_tool_result")&&vs(n.tool_use_id)&&_s(n.content)){const{content:e,tool_use_id:t}=n,r=e.reduce((e,t)=>gs(t,"web_search_result")?[...e,t.url]:e,[]);yield{type:"server_tool_call_result",name:"web_search",toolCallId:t,status:"success",output:{urls:r}};continue}if(gs(n,"code_execution_tool_result")&&vs(n.tool_use_id)&&ys(n.content)){yield{type:"server_tool_call_result",name:"code_execution",toolCallId:n.tool_use_id,status:"success",output:n.content};continue}if(gs(n,"mcp_tool_use")){yield{id:n.id,type:"server_tool_call",name:"mcp_tool_use",args:n.input};continue}if(gs(n,"mcp_tool_result")&&vs(n.tool_use_id)&&ys(n.content)){yield{type:"server_tool_call_result",name:"mcp_tool_use",toolCallId:n.tool_use_id,status:"success",output:n.content};continue}if(gs(n,"container_upload")){yield{type:"server_tool_call",name:"container_upload",args:n.input};continue}if(gs(n,"search_result")){yield{id:n.id,type:"non_standard",value:n};continue}if(gs(n,"tool_result")){yield{id:n.id,type:"non_standard",value:n};continue}{const e=Is(n);if(e){yield e;continue}}}yield{type:"non_standard",value:n}}}}())}const Ss={translateContent:Os,translateContentChunk:Os};function As(e){return"function"==typeof e?._getType&&"function"==typeof e.concat&&"ai"===e._getType()}function $s(e){return es(e)?{type:e.type,mimeType:e.mime_type,url:e.url,metadata:e.metadata}:ts(e)?{type:e.type,mimeType:e.mime_type??"application/octet-stream",data:e.data,metadata:e.metadata}:rs(e)?{type:e.type,mimeType:e.mime_type,fileId:e.id,metadata:e.metadata}:e}function Cs(e){return e.map($s)}function Ns(e){return!(!gs(e,"image_url")||!ys(e.image_url))||!(!gs(e,"input_audio")||!ys(e.input_audio))||!(!gs(e,"file")||!ys(e.file))}function Ps(e){if(gs(e,"image_url")&&ys(e.image_url)&&vs(e.image_url.url)){const t=is({dataUrl:e.image_url.url});return t?{type:"image",mimeType:t.mime_type,data:t.data}:{type:"image",url:e.image_url.url}}if(gs(e,"input_audio")&&ys(e.input_audio)&&vs(e.input_audio.data)&&vs(e.input_audio.format))return{type:"audio",data:e.input_audio.data,mimeType:`audio/${e.input_audio.format}`};if(gs(e,"file")&&ys(e.file)&&vs(e.file.data)){const t=is({dataUrl:e.file.data});if(t)return{type:"file",data:t.data,mimeType:t.mime_type};if(vs(e.file.file_id))return{type:"file",fileId:e.file.file_id}}return e}function Rs(e){const t=[];for(const n of e)Ns(n)?t.push(Ps(n)):t.push(n);return t}function js(e){if("url_citation"===e.type){const{url:t,title:n,start_index:r,end_index:s}=e;return{type:"citation",url:t,title:n,startIndex:r,endIndex:s}}if("file_citation"===e.type){const{file_id:t,filename:n,index:r}=e;return{type:"citation",title:n,startIndex:r,endIndex:r,fileId:t}}return e}function Ls(e){return Array.from(function*(){if(ys(e.additional_kwargs?.reasoning)&&_s(e.additional_kwargs.reasoning.summary)){const t=e.additional_kwargs.reasoning.summary.reduce((e,t)=>ys(t)&&vs(t.text)?`${e}${t.text}`:e,"");yield{type:"reasoning",reasoning:t}}const t="string"==typeof e.content?[{type:"text",text:e.content}]:e.content;for(const e of t)if(gs(e,"text")){const{text:t,annotations:n,...r}=e;Array.isArray(n)?yield{...r,type:"text",text:String(t),annotations:n.map(js)}:yield{...r,type:"text",text:String(t)}}for(const t of e.tool_calls??[])yield{type:"tool_call",id:t.id,name:t.name,args:t.args};if(ys(e.additional_kwargs)&&_s(e.additional_kwargs.tool_outputs))for(const t of e.additional_kwargs.tool_outputs)if(gs(t,"web_search_call"))yield{id:t.id,type:"server_tool_call",name:"web_search",args:{query:t.query}};else if(gs(t,"file_search_call"))yield{id:t.id,type:"server_tool_call",name:"file_search",args:{query:t.query}};else if(gs(t,"computer_call"))yield{type:"non_standard",value:t};else if(gs(t,"code_interpreter_call")){if(vs(t.code)&&(yield{id:t.id,type:"server_tool_call",name:"code_interpreter",args:{code:t.code}}),_s(t.outputs)){const e=ks(()=>{if("in_progress"!==t.status){if("completed"===t.status)return 0;if("incomplete"===t.status)return 127;if("interpreting"!==t.status)return"failed"===t.status?1:void 0}});for(const n of t.outputs)if(gs(n,"logs")){yield{type:"server_tool_call_result",toolCallId:t.id??"",status:"success",output:{type:"code_interpreter_output",returnCode:e??0,stderr:[0,void 0].includes(e)?void 0:String(n.logs),stdout:[0,void 0].includes(e)?String(n.logs):void 0}};continue}}}else gs(t,"mcp_call")?yield{id:t.id,type:"server_tool_call",name:"mcp_call",args:t.input}:gs(t,"mcp_list_tools")?yield{id:t.id,type:"server_tool_call",name:"mcp_list_tools",args:t.input}:(gs(t,"mcp_approval_request")||gs(t,"image_generation_call")||ys(t))&&(yield{type:"non_standard",value:t})}())}const Ms={translateContent:e=>"string"==typeof e.content?function(e){const t=[];"string"==typeof e.content?t.push({type:"text",text:e.content}):t.push(...Rs(e.content));for(const n of e.tool_calls??[])t.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return t}(e):Ls(e),translateContentChunk:e=>"string"==typeof e.content?function(e){const t=[];"string"==typeof e.content?t.push({type:"text",text:e.content}):t.push(...Rs(e.content));for(const n of e.tool_calls??[])t.push({type:"tool_call",id:n.id,name:n.name,args:n.args});return t}(e):function(e){return Array.from(function*(){yield*Ls(e);for(const t of e.tool_call_chunks??[])yield{type:"tool_call_chunk",id:t.id,name:t.name,args:t.args}}())}(e)};const zs=Symbol.for("langchain.message");function Us(e,t){return"string"==typeof e?""===e?t:"string"==typeof t?e+t:Array.isArray(t)&&0===t.length?e:Array.isArray(t)&&t.some(e=>Qr(e))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?qs(e,t)??[...e,...t]:""===t?e:Array.isArray(e)&&e.some(e=>Qr(e))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}function Ds(e,t){return"error"===e||"error"===t?"error":"success"}var Fs=class extends fs{lc_namespace=["langchain_core","messages"];lc_serializable=!0;get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}[zs]=!0;id;name;content;additional_kwargs;response_metadata;_getType(){return this.type}getType(){return this._getType()}constructor(e){const t="string"==typeof e||Array.isArray(e)?{content:e}:e;t.additional_kwargs||(t.additional_kwargs={}),t.response_metadata||(t.response_metadata={}),super(t),this.name=t.name,void 0===t.content&&void 0!==t.contentBlocks?(this.content=t.contentBlocks,this.response_metadata={output_version:"v1",...t.response_metadata}):void 0!==t.content?(this.content=t.content??[],this.response_metadata=t.response_metadata):(this.content=[],this.response_metadata=t.response_metadata),this.additional_kwargs=t.additional_kwargs,this.id=t.id}get text(){return"string"==typeof this.content?this.content:Array.isArray(this.content)?this.content.map(e=>"string"==typeof e?e:"text"===e.type?e.text:"").join(""):""}get contentBlocks(){const e="string"==typeof this.content?[{type:"text",text:this.content}]:this.content;return[Cs,Rs,Es].reduce((e,t)=>t(e),e)}toDict(){return{type:this.getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}static isInstance(e){return"object"==typeof e&&null!==e&&zs in e&&!0===e[zs]&&cs(e)}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(null===e)return this;const t=(n=this._printableFields,r=Math.max(4,e),JSON.stringify(function e(t,n){if("object"!=typeof t||null==t)return t;if(n>=r)return Array.isArray(t)?"[Array]":"[Object]";if(Array.isArray(t))return t.map(t=>e(t,n+1));const s={};for(const r of Object.keys(t))s[r]=e(t[r],n+1);return s}(n,0),null,2));var n,r;return`${this.constructor.lc_name()} ${t}`}toFormattedString(e="pretty"){return function(e,t="pretty"){return"pretty"===t?function(e){const t=[],n=` ${e.type.charAt(0).toUpperCase()+e.type.slice(1)} Message `,r=Math.floor((80-n.length)/2),s="=".repeat(r),a=n.length%2==0?s:`${s}=`;if(t.push(`${s}${n}${a}`),"ai"===e.type){const n=e;if(n.tool_calls&&n.tool_calls.length>0){t.push("Tool Calls:");for(const e of n.tool_calls){t.push(`  ${e.name} (${e.id})`),t.push(` Call ID: ${e.id}`),t.push("  Args:");for(const[n,r]of Object.entries(e.args))t.push(`    ${n}: ${"object"==typeof r?JSON.stringify(r):r}`)}}}if("tool"===e.type){const n=e;n.name&&t.push(`Name: ${n.name}`)}return"string"==typeof e.content&&e.content.trim()&&(t.length>1&&t.push(""),t.push(e.content)),t.join("\n")}(e):JSON.stringify(e)}(this,e)}};function Bs(e){return Array.isArray(e)&&e.every(e=>"number"==typeof e.index)}function Zs(e={},t={}){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e]){if("type"===e)continue;["id","name","output_version","model_provider"].includes(e)?r&&(n[e]=r):n[e]+=r}else if("object"!=typeof n[e]||Array.isArray(n[e]))if(Array.isArray(n[e]))n[e]=qs(n[e],r);else{if(n[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else n[e]=Zs(n[e],r)}return n}function qs(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&null!==e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex(t=>{const n="object"==typeof t,r="index"in t&&t.index===e.index;return n&&r&&("id"in t&&"id"in e&&t?.id===e?.id||!("id"in t&&t?.id&&"id"in e&&e?.id))});-1!==t&&"object"==typeof n[t]&&null!==n[t]?n[t]=Zs(n[t],e):n.push(e)}else{if("object"==typeof e&&null!==e&&"text"in e&&""===e.text)continue;n.push(e)}return n}}}function Vs(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e??t;if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.\nLeft ${typeof e}\nRight ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return qs(e,t);if("object"==typeof e&&"object"==typeof t)return Zs(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.\nLeft ${e}\nRight ${t}`)}}var Hs=class e extends Fs{static isInstance(t){if(!super.isInstance(t))return!1;let n=Object.getPrototypeOf(t);for(;null!==n;){if(n===e.prototype)return!0;n=Object.getPrototypeOf(n)}return!1}};function Ws(e){return"string"==typeof e.role}function Gs(e){return"function"==typeof e?._getType}function Js(e){return Hs.isInstance(e)}function Ks(e,t){return Zs(e??{},t??{})}function Xs(e,t){const n={};return void 0===e?.audio&&void 0===t?.audio||(n.audio=(e?.audio??0)+(t?.audio??0)),void 0===e?.image&&void 0===t?.image||(n.image=(e?.image??0)+(t?.image??0)),void 0===e?.video&&void 0===t?.video||(n.video=(e?.video??0)+(t?.video??0)),void 0===e?.document&&void 0===t?.document||(n.document=(e?.document??0)+(t?.document??0)),void 0===e?.text&&void 0===t?.text||(n.text=(e?.text??0)+(t?.text??0)),n}function Ys(e,t){const n={...Xs(e,t)};return void 0===e?.cache_read&&void 0===t?.cache_read||(n.cache_read=(e?.cache_read??0)+(t?.cache_read??0)),void 0===e?.cache_creation&&void 0===t?.cache_creation||(n.cache_creation=(e?.cache_creation??0)+(t?.cache_creation??0)),n}function Qs(e,t){const n={...Xs(e,t)};return void 0===e?.reasoning&&void 0===t?.reasoning||(n.reasoning=(e?.reasoning??0)+(t?.reasoning??0)),n}function ea(e,t){return{input_tokens:(e?.input_tokens??0)+(t?.input_tokens??0),output_tokens:(e?.output_tokens??0)+(t?.output_tokens??0),total_tokens:(e?.total_tokens??0)+(t?.total_tokens??0),input_token_details:Ys(e?.input_token_details,t?.input_token_details),output_token_details:Qs(e?.output_token_details,t?.output_token_details)}}function ta(e){return null!=e&&"object"==typeof e&&"lc_direct_tool_output"in e&&!0===e.lc_direct_tool_output}Yr({},{ToolMessage:()=>na,ToolMessageChunk:()=>ra,defaultToolCallParser:()=>sa,isDirectToolOutput:()=>ta,isToolMessage:()=>aa,isToolMessageChunk:()=>ia});var na=class extends Fs{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}lc_direct_tool_output=!0;type="tool";status;tool_call_id;metadata;artifact;constructor(e,t,n){const r="string"==typeof e||Array.isArray(e)?{content:e,name:n,tool_call_id:t}:e;super(r),this.tool_call_id=r.tool_call_id,this.artifact=r.artifact,this.status=r.status,this.metadata=r.metadata}static isInstance(e){return super.isInstance(e)&&"tool"===e.type}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}},ra=class extends Hs{type="tool";tool_call_id;status;artifact;constructor(e){super(e),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}concat(e){return new(0,this.constructor)({content:Us(this.content,e.content),additional_kwargs:Zs(this.additional_kwargs,e.additional_kwargs),response_metadata:Zs(this.response_metadata,e.response_metadata),artifact:Vs(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:Ds(this.status,e.status)})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}};function sa(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n=JSON.parse(r.function.arguments);t.push({name:e||"",args:n||{},id:r.id})}catch{n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}function aa(e){return"object"==typeof e&&null!==e&&"getType"in e&&"function"==typeof e.getType&&"tool"===e.getType()}function ia(e){return"tool"===e._getType()}var oa=class e extends Fs{static lc_name(){return"ChatMessage"}type="generic";role;static _chatMessageClass(){return e}constructor(e,t){("string"==typeof e||Array.isArray(e))&&(e={content:e,role:t}),super(e),this.role=e.role}static isInstance(e){return super.isInstance(e)&&"generic"===e.type}get _printableFields(){return{...super._printableFields,role:this.role}}},ca=class extends Hs{static lc_name(){return"ChatMessageChunk"}type="generic";role;constructor(e,t){("string"==typeof e||Array.isArray(e))&&(e={content:e,role:t}),super(e),this.role=e.role}concat(e){return new(0,this.constructor)({content:Us(this.content,e.content),additional_kwargs:Zs(this.additional_kwargs,e.additional_kwargs),response_metadata:Zs(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&"generic"===e.type}get _printableFields(){return{...super._printableFields,role:this.role}}};function la(e){return"generic"===e._getType()}function ua(e){return"generic"===e._getType()}var da=class extends Fs{static lc_name(){return"FunctionMessage"}type="function";name;constructor(e){super(e),this.name=e.name}},pa=class extends Hs{static lc_name(){return"FunctionMessageChunk"}type="function";concat(e){return new(0,this.constructor)({content:Us(this.content,e.content),additional_kwargs:Zs(this.additional_kwargs,e.additional_kwargs),response_metadata:Zs(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}};function ha(e){return"function"===e._getType()}function ma(e){return"function"===e._getType()}var fa=class extends Fs{static lc_name(){return"HumanMessage"}type="human";constructor(e){super(e)}static isInstance(e){return super.isInstance(e)&&"human"===e.type}},ga=class extends Hs{static lc_name(){return"HumanMessageChunk"}type="human";constructor(e){super(e)}concat(e){return new(0,this.constructor)({content:Us(this.content,e.content),additional_kwargs:Zs(this.additional_kwargs,e.additional_kwargs),response_metadata:Zs(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&"human"===e.type}};function ya(e){return"human"===e.getType()}function _a(e){return"human"===e.getType()}var va=class extends Fs{type="remove";id;constructor(e){super({...e,content:[]}),this.id=e.id}get _printableFields(){return{...super._printableFields,id:this.id}}static isInstance(e){return super.isInstance(e)&&"remove"===e.type}},wa=class e extends Fs{static lc_name(){return"SystemMessage"}type="system";constructor(e){super(e)}concat(t){if("string"==typeof t)return new e({...this,content:Us(this.content,t)});if(e.isInstance(t))return new e({...this,additional_kwargs:{...this.additional_kwargs,...t.additional_kwargs},response_metadata:{...this.response_metadata,...t.response_metadata},content:Us(this.content,t.content)});throw new Error("Unexpected chunk type for system message")}static isInstance(e){return super.isInstance(e)&&"system"===e.type}},ba=class extends Hs{static lc_name(){return"SystemMessageChunk"}type="system";constructor(e){super(e)}concat(e){return new(0,this.constructor)({content:Us(this.content,e.content),additional_kwargs:Zs(this.additional_kwargs,e.additional_kwargs),response_metadata:Zs(this.response_metadata,e.response_metadata),id:this.id??e.id})}static isInstance(e){return super.isInstance(e)&&"system"===e.type}};function xa(e){return"system"===e._getType()}function ka(e){return"system"===e._getType()}function Ta(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://docs.langchain.com/oss/javascript/langchain/errors/${t}/\n`,e}function Ia(e){return!(!e||"object"!=typeof e||!("type"in e)||"tool_call"!==e.type)}var Ea=class extends Error{output;constructor(e,t){super(e),this.output=t}};function Oa(e,t=Sa){const n=(e=e.trim()).indexOf("```");if(-1===n)return t(e);let r=e.substring(n+3);r.startsWith("json\n")?r=r.substring(5):r.startsWith("json")?r=r.substring(4):r.startsWith("\n")&&(r=r.substring(1));const s=r.indexOf("```");let a=r;return-1!==s&&(a=r.substring(0,s)),t(a.trim())}function Sa(e){try{return void 0===e?null:function(e){try{return JSON.parse(e)}catch{}const t=e.trim();if(0===t.length)throw new Error("Unexpected end of JSON input");let n=0;function r(){for(;n<t.length&&/\s/.test(t[n]);)n+=1}function s(){if('"'!==t[n])throw new Error(`Expected '"' at position ${n}, got '${t[n]}'`);n+=1;let e="",r=!1;for(;n<t.length;){const s=t[n];if(r){if("n"===s)e+="\n";else if("t"===s)e+="\t";else if("r"===s)e+="\r";else if("\\"===s)e+="\\";else if('"'===s)e+='"';else if("b"===s)e+="\b";else if("f"===s)e+="\f";else if("/"===s)e+="/";else{if("u"!==s)throw new Error(`Invalid escape sequence '\\${s}' at position ${n}`);{const r=t.substring(n+1,n+5);if(!/^[0-9A-Fa-f]{0,4}$/.test(r))throw new Error(`Invalid unicode escape sequence '\\u${r}' at position ${n}`);4===r.length?e+=String.fromCharCode(Number.parseInt(r,16)):e+=`u${r}`,n+=r.length}}r=!1}else if("\\"===s)r=!0;else{if('"'===s)return n+=1,e;e+=s}n+=1}return r&&(e+="\\"),e}const a=function e(){if(r(),n>=t.length)throw new Error(`Unexpected end of input at position ${n}`);const a=t[n];if("{"===a)return function(){if("{"!==t[n])throw new Error(`Expected '{' at position ${n}, got '${t[n]}'`);const a={};if(n+=1,r(),n>=t.length)return a;if("}"===t[n])return n+=1,a;for(;n<t.length;){if(r(),n>=t.length)return a;const i=s();if(r(),n>=t.length)return a;if(":"!==t[n])throw new Error(`Expected ':' at position ${n}, got '${t[n]}'`);if(n+=1,r(),n>=t.length)return a;if(a[i]=e(),r(),n>=t.length)return a;if("}"===t[n])return n+=1,a;if(","!==t[n])throw new Error(`Expected ',' or '}' at position ${n}, got '${t[n]}'`);n+=1}return a}();if("["===a)return function(){if("["!==t[n])throw new Error(`Expected '[' at position ${n}, got '${t[n]}'`);const s=[];if(n+=1,r(),n>=t.length)return s;if("]"===t[n])return n+=1,s;for(;n<t.length;){if(r(),n>=t.length)return s;if(s.push(e()),r(),n>=t.length)return s;if("]"===t[n])return n+=1,s;if(","!==t[n])throw new Error(`Expected ',' or ']' at position ${n}, got '${t[n]}'`);n+=1}return s}();if('"'===a)return s();if("null".startsWith(t.substring(n,n+4)))return n+=Math.min(4,t.length-n),null;if("true".startsWith(t.substring(n,n+4)))return n+=Math.min(4,t.length-n),!0;if("false".startsWith(t.substring(n,n+5)))return n+=Math.min(5,t.length-n),!1;if("-"===a||a>="0"&&a<="9")return function(){const e=n;let r="";if("-"===t[n]&&(r+="-",n+=1),n<t.length&&"0"===t[n]&&(r+="0",n+=1,t[n]>="0"&&t[n]<="9"))throw new Error(`Invalid number at position ${e}`);if(n<t.length&&t[n]>="1"&&t[n]<="9")for(;n<t.length&&t[n]>="0"&&t[n]<="9";)r+=t[n],n+=1;if(n<t.length&&"."===t[n])for(r+=".",n+=1;n<t.length&&t[n]>="0"&&t[n]<="9";)r+=t[n],n+=1;if(n<t.length&&("e"===t[n]||"E"===t[n]))for(r+=t[n],n+=1,n<t.length&&("+"===t[n]||"-"===t[n])&&(r+=t[n],n+=1);n<t.length&&t[n]>="0"&&t[n]<="9";)r+=t[n],n+=1;if("-"===r)return-0;const s=Number.parseFloat(r);if(Number.isNaN(s))throw n=e,new Error(`Invalid number '${r}' at position ${e}`);return s}();throw new Error(`Unexpected character '${a}' at position ${n}`)}();if(r(),n<t.length)throw new Error(`Unexpected character '${t[n]}' at position ${n}`);return a}(e)}catch{return null}}function Aa(e){switch(e){case"csv":return"text/csv";case"doc":case"docx":return"application/vnd.openxmlformats-officedocument.wordprocessingml.document";case"html":return"text/html";case"md":return"text/markdown";case"pdf":return"application/pdf";case"txt":return"text/plain";case"xls":return"application/vnd.ms-excel";case"xlsx":return"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";case"gif":return"image/gif";case"jpeg":case"jpg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"flv":return"video/flv";case"mkv":return"video/mkv";case"mov":return"video/mov";case"mp4":return"video/mp4";case"mpeg":return"video/mpeg";case"mpg":return"video/mpg";case"three_gp":return"video/three_gp";case"webm":return"video/webm";case"wmv":return"video/wmv";default:return"application/octet-stream"}}function $a(e){if(ys(e.document)&&ys(e.document.source)){const t=Aa(ys(e.document)&&vs(e.document.format)?e.document.format:"");if(ys(e.document.source)){if(ys(e.document.source.s3Location)&&vs(e.document.source.s3Location.uri))return{type:"file",mimeType:t,fileId:e.document.source.s3Location.uri};if(bs(e.document.source.bytes))return{type:"file",mimeType:t,data:e.document.source.bytes};if(vs(e.document.source.text))return{type:"file",mimeType:t,data:Buffer.from(e.document.source.text).toString("base64")};if(_s(e.document.source.content))return{type:"file",mimeType:t,data:e.document.source.content.reduce((e,t)=>ys(t)&&vs(t.text)?e+t.text:e,"")}}}return{type:"non_standard",value:e}}function Ca(e){if(gs(e,"image")&&ys(e.image)){const t=Aa(ys(e.image)&&vs(e.image.format)?e.image.format:"");if(ys(e.image.source)){if(ys(e.image.source.s3Location)&&vs(e.image.source.s3Location.uri))return{type:"image",mimeType:t,fileId:e.image.source.s3Location.uri};if(bs(e.image.source.bytes))return{type:"image",mimeType:t,data:e.image.source.bytes}}}return{type:"non_standard",value:e}}function Na(e){if(gs(e,"video")&&ys(e.video)){const t=Aa(ys(e.video)&&vs(e.video.format)?e.video.format:"");if(ys(e.video.source)){if(ys(e.video.source.s3Location)&&vs(e.video.source.s3Location.uri))return{type:"video",mimeType:t,fileId:e.video.source.s3Location.uri};if(bs(e.video.source.bytes))return{type:"video",mimeType:t,data:e.video.source.bytes}}}return{type:"non_standard",value:e}}function Pa(e){return Array.from(function*(){const t="string"==typeof e.content?[{type:"text",text:e.content}]:e.content;for(const e of t)if(gs(e,"cache_point"))yield{type:"non_standard",value:e};else{if(gs(e,"citations_content")&&ys(e.citationsContent)){const t=_s(e.citationsContent.content)?e.citationsContent.content.reduce((e,t)=>ys(t)&&vs(t.text)?e+t.text:e,""):"",n=_s(e.citationsContent.citations)?e.citationsContent.citations.reduce((e,t)=>{if(ys(t)){const n=_s(t.sourceContent)?t.sourceContent.reduce((e,t)=>ys(t)&&vs(t.text)?e+t.text:e,""):"",r=ks(()=>{if(ys(t.location)){const e=t.location.documentChar||t.location.documentPage||t.location.documentChunk;if(ys(e))return{source:ws(e.documentIndex)?e.documentIndex.toString():void 0,startIndex:ws(e.start)?e.start:void 0,endIndex:ws(e.end)?e.end:void 0}}return{}});e.push({type:"citation",citedText:n,...r})}return e},[]):[];yield{type:"text",text:t,annotations:n};continue}gs(e,"document")&&ys(e.document)?yield $a(e):gs(e,"guard_content")?yield{type:"non_standard",value:e}:gs(e,"image")&&ys(e.image)?yield Ca(e):gs(e,"reasoning_content")&&vs(e.reasoningText)?yield{type:"reasoning",reasoning:e.reasoningText}:gs(e,"text")&&vs(e.text)?yield{type:"text",text:e.text}:gs(e,"tool_result")?yield{type:"non_standard",value:e}:gs(e,"tool_call")||(gs(e,"video")&&ys(e.video)?yield Na(e):yield{type:"non_standard",value:e})}}())}const Ra={translateContent:Pa,translateContentChunk:Pa};function ja(e){return Array.from(function*(){const t="string"==typeof e.content?[{type:"text",text:e.content}]:e.content;for(const n of t)gs(n,"text")&&vs(n.text)?yield{type:"text",text:n.text}:gs(n,"inlineData")&&ys(n.inlineData)&&vs(n.inlineData.mimeType)&&vs(n.inlineData.data)?yield{type:"file",mimeType:n.inlineData.mimeType,data:n.inlineData.data}:gs(n,"functionCall")&&ys(n.functionCall)&&vs(n.functionCall.name)&&ys(n.functionCall.args)?yield{type:"tool_call",id:e.id,name:n.functionCall.name,args:n.functionCall.args}:gs(n,"functionResponse")?yield{type:"non_standard",value:n}:gs(n,"fileData")&&ys(n.fileData)&&vs(n.fileData.mimeType)&&vs(n.fileData.fileUri)?yield{type:"file",mimeType:n.fileData.mimeType,fileId:n.fileData.fileUri}:(gs(n,"executableCode")||gs(n,"codeExecutionResult"),yield{type:"non_standard",value:n})}())}const La={translateContent:ja,translateContentChunk:ja};function Ma(e){return Array.from(function*(){const t="string"==typeof e.content?[{type:"text",text:e.content}]:e.content;for(const n of t){if(gs(n,"reasoning")&&vs(n.reasoning)){const r=ks(()=>{const r=t.indexOf(n);if(_s(e.additional_kwargs?.signatures)&&r>=0)return e.additional_kwargs.signatures.at(r)});vs(r)?yield{type:"reasoning",reasoning:n.reasoning,signature:r}:yield{type:"reasoning",reasoning:n.reasoning};continue}if(gs(n,"text")&&vs(n.text))yield{type:"text",text:n.text};else if(gs(n,"image_url")){if(vs(n.image_url))if(n.image_url.startsWith("data:")){const e=/^data:([^;]+);base64,(.+)$/,t=n.image_url.match(e);t?yield{type:"image",data:t[2],mimeType:t[1]}:yield{type:"image",url:n.image_url}}else yield{type:"image",url:n.image_url}}else gs(n,"media")&&vs(n.mimeType)&&vs(n.data)?yield{type:"file",mimeType:n.mimeType,data:n.data}:yield{type:"non_standard",value:n}}}())}const za={translateContent:Ma,translateContentChunk:Ma};function Ua(e){return globalThis.lc_block_translators_registry.get(e)}globalThis.lc_block_translators_registry??=new Map([["anthropic",Ss],["bedrock-converse",Ra],["google-genai",La],["google-vertexai",za],["openai",Ms]]);var Da=class extends Fs{type="ai";tool_calls=[];invalid_tool_calls=[];usage_metadata;get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e){let t;if("string"==typeof e||Array.isArray(e))t={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:{}};else{t=e;const n=t.additional_kwargs?.tool_calls,r=t.tool_calls;null!=n&&n.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `pnpm install @langchain/anthropic`,","pnpm install @langchain/openai`, etc."].join(" "));try{if(null!=n&&void 0===r){const[e,r]=sa(n);t.tool_calls=e??[],t.invalid_tool_calls=r??[]}else t.tool_calls=t.tool_calls??[],t.invalid_tool_calls=t.invalid_tool_calls??[]}catch{t.tool_calls=[],t.invalid_tool_calls=[]}if(void 0!==t.response_metadata&&"output_version"in t.response_metadata&&"v1"===t.response_metadata.output_version&&(t.contentBlocks=t.content,t.content=void 0),void 0!==t.contentBlocks){t.contentBlocks.push(...t.tool_calls.map(e=>({type:"tool_call",id:e.id,name:e.name,args:e.args})));const e=t.contentBlocks.filter(e=>"tool_call"===e.type).filter(e=>!t.tool_calls?.some(t=>t.id===e.id&&t.name===e.name));e.length>0&&(t.tool_calls=e.map(e=>({type:"tool_call",id:e.id,name:e.name,args:e.args})))}}super(t),"string"!=typeof t&&(this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=t.usage_metadata}static lc_name(){return"AIMessage"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&"v1"===this.response_metadata.output_version)return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&"string"==typeof this.response_metadata.model_provider){const e=Ua(this.response_metadata.model_provider);if(e)return e.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls){const t=this.tool_calls.filter(t=>!e.some(e=>e.id===t.id&&e.name===t.name));e.push(...t.map(e=>({...e,type:"tool_call",id:e.id,name:e.name,args:e.args})))}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}static isInstance(e){return super.isInstance(e)&&"ai"===e.type}};function Fa(e){return"ai"===e._getType()}function Ba(e){return"ai"===e._getType()}var Za=class extends Hs{type="ai";tool_calls=[];invalid_tool_calls=[];tool_call_chunks=[];usage_metadata;constructor(e){let t;t="string"==typeof e||Array.isArray(e)?{content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]}:void 0===e.tool_call_chunks||0===e.tool_call_chunks.length?{...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}:{...e,...Qa(e.tool_call_chunks??[]),usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0},super(t),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}get contentBlocks(){if(this.response_metadata&&"output_version"in this.response_metadata&&"v1"===this.response_metadata.output_version)return this.content;if(this.response_metadata&&"model_provider"in this.response_metadata&&"string"==typeof this.response_metadata.model_provider){const e=Ua(this.response_metadata.model_provider);if(e)return e.translateContent(this)}const e=super.contentBlocks;if(this.tool_calls&&"string"!=typeof this.content){const t=this.content.filter(e=>"tool_call"===e.type).map(e=>e.id);for(const n of this.tool_calls)n.id&&!t.includes(n.id)&&e.push({...n,type:"tool_call",id:n.id,name:n.name,args:n.args})}return e}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:Us(this.content,e.content),additional_kwargs:Zs(this.additional_kwargs,e.additional_kwargs),response_metadata:Ks(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=qs(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}return void 0===this.usage_metadata&&void 0===e.usage_metadata||(t.usage_metadata=ea(this.usage_metadata,e.usage_metadata)),new(0,this.constructor)(t)}static isInstance(e){return super.isInstance(e)&&"ai"===e.type}};const qa=e=>e();function Va(e){return Ia(e)?e:"string"==typeof e.id&&"function"===e.type&&"object"==typeof e.function&&null!==e.function&&"arguments"in e.function&&"string"==typeof e.function.arguments&&"name"in e.function&&"string"==typeof e.function.name?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function Ha(e){let t,n;if("object"==typeof(r=e)&&null!=r&&1===r.lc&&Array.isArray(r.id)&&null!=r.kwargs&&"object"==typeof r.kwargs){const r=e.id.at(-1);t="HumanMessage"===r||"HumanMessageChunk"===r?"user":"AIMessage"===r||"AIMessageChunk"===r?"assistant":"SystemMessage"===r||"SystemMessageChunk"===r?"system":"FunctionMessage"===r||"FunctionMessageChunk"===r?"function":"ToolMessage"===r||"ToolMessageChunk"===r?"tool":"unknown",n=e.kwargs}else{const{type:r,...s}=e;t=r,n=s}var r;if("human"===t||"user"===t)return new fa(n);if("ai"===t||"assistant"===t){const{tool_calls:e,...t}=n;if(!Array.isArray(e))return new Da(n);const r=e.map(Va);return new Da({...t,tool_calls:r})}if("system"===t)return new wa(n);if("developer"===t)return new wa({...n,additional_kwargs:{...n.additional_kwargs,__openai_role__:"developer"}});if("tool"===t&&"tool_call_id"in n)return new na({...n,content:n.content,tool_call_id:n.tool_call_id,name:n.name});if("remove"===t&&"id"in n&&"string"==typeof n.id)return new va({...n,id:n.id});throw Ta(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.\n\nReceived: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}function Wa(e){if("string"==typeof e)return new fa(e);if(Gs(e))return e;if(Array.isArray(e)){const[t,n]=e;return Ha({type:t,content:n})}if(Ws(e)){const{role:t,...n}=e;return Ha({...n,type:t})}return Ha(e)}function Ga(e,t="Human",n="AI"){const r=[];for(const s of e){let e;if("human"===s._getType())e=t;else if("ai"===s._getType())e=n;else if("system"===s._getType())e="System";else if("tool"===s._getType())e="Tool";else{if("generic"!==s._getType())throw new Error(`Got unsupported message type: ${s._getType()}`);e=s.role}const a=s.name?`${s.name}, `:"",i="string"==typeof s.content?s.content:JSON.stringify(s.content,null,2);r.push(`${e}: ${a}${i}`)}return r.join("\n")}function Ja(e){const t=function(e){if(void 0!==e.data)return e;{const t=e;return{type:t.type,data:{content:t.text,role:t.role,name:void 0,tool_call_id:void 0}}}}(e);switch(t.type){case"human":return new fa(t.data);case"ai":return new Da(t.data);case"system":return new wa(t.data);case"function":if(void 0===t.data.name)throw new Error("Name must be defined for function messages");return new da(t.data);case"tool":if(void 0===t.data.tool_call_id)throw new Error("Tool call ID must be defined for tool messages");return new na(t.data);case"generic":if(void 0===t.data.role)throw new Error("Role must be defined for chat messages");return new oa(t.data);default:throw new Error(`Got unexpected type: ${t.type}`)}}function Ka(e){return e.map(Ja)}function Xa(e){return e.map(e=>e.toDict())}function Ya(e){const t=e._getType();if("human"===t)return new ga({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)}))}),new Za({...t})}if("system"===t)return new ba({...e});if("function"===t)return new pa({...e});if(oa.isInstance(e))return new ca({...e});throw new Error("Unknown message type.")}function Qa(e){const t=e.reduce((e,t)=>{const n=e.findIndex(([e])=>"id"in t&&t.id&&"index"in t&&void 0!==t.index?t.id===e.id&&t.index===e.index:"id"in t&&t.id?t.id===e.id:"index"in t&&void 0!==t.index&&t.index===e.index);return-1!==n?e[n].push(t):e.push([t]),e},[]),n=[],r=[];for(const e of t){let t=null;const s=e[0]?.name??"",a=e.map(e=>e.args||"").join("").trim(),i=a.length?a:"{}",o=e[0]?.id;try{if(t=Sa(i),!o||null===t||"object"!=typeof t||Array.isArray(t))throw new Error("Malformed tool call chunk args.");n.push({name:s,args:t,id:o,type:"tool_call"})}catch{r.push({name:s,args:i,id:o,error:"Malformed args.",type:"invalid_tool_call"})}}return{tool_call_chunks:e,tool_calls:n,invalid_tool_calls:r}}const ei=Symbol.for("ls:tracing_async_local_storage"),ti=Symbol.for("lc:context_variables"),ni=()=>globalThis[ei];Yr({},{getEnv:()=>ci,getEnvironmentVariable:()=>di,getRuntimeEnvironment:()=>ui,isBrowser:()=>ri,isDeno:()=>ii,isJsDom:()=>ai,isNode:()=>oi,isWebWorker:()=>si});const ri=()=>"undefined"!=typeof window&&void 0!==window.document,si=()=>"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name,ai=()=>"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom"),ii=()=>"undefined"!=typeof Deno,oi=()=>"undefined"!=typeof process&&void 0!==process.versions&&void 0!==process.versions.node&&!ii(),ci=()=>{let e;return e=ri()?"browser":oi()?"node":si()?"webworker":ai()?"jsdom":ii()?"deno":"other",e};let li;function ui(){if(void 0===li){const e=ci();li={library:"langchain-js",runtime:e}}return li}function di(e){try{return"undefined"!=typeof process?process.env?.[e]:ii()?Deno?.env.get(e):void 0}catch{return}}var pi,hi=new Uint8Array(16);function mi(){if(!pi&&!(pi="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return pi(hi)}for(var fi=[],gi=0;gi<256;++gi)fi.push((gi+256).toString(16).slice(1));function yi(e,t=0){return(fi[e[t+0]]+fi[e[t+1]]+fi[e[t+2]]+fi[e[t+3]]+"-"+fi[e[t+4]]+fi[e[t+5]]+"-"+fi[e[t+6]]+fi[e[t+7]]+"-"+fi[e[t+8]]+fi[e[t+9]]+"-"+fi[e[t+10]]+fi[e[t+11]]+fi[e[t+12]]+fi[e[t+13]]+fi[e[t+14]]+fi[e[t+15]]).toLowerCase()}var _i=null,vi=null,wi=0;const bi=function(e,t,n){e=e||{};var r=t&&n||0,s=t||new Uint8Array(16),a=e.random||(e.rng||mi)(),i=void 0!==e.msecs?e.msecs:Date.now(),o=void 0!==e.seq?e.seq:null,c=vi,l=_i;return i>wi&&void 0===e.msecs&&(wi=i,null!==o&&(c=null,l=null)),null!==o&&(o>2147483647&&(o=2147483647),c=o>>>19&4095,l=524287&o),null!==c&&null!==l||(c=(c=127&a[6])<<8|a[7],l=(l=(l=63&a[8])<<8|a[9])<<5|a[10]>>>3),i+1e4>wi&&null===o?++l>524287&&(l=0,++c>4095&&(c=0,wi++)):wi=i,vi=c,_i=l,s[r++]=wi/1099511627776&255,s[r++]=wi/4294967296&255,s[r++]=wi/16777216&255,s[r++]=wi/65536&255,s[r++]=wi/256&255,s[r++]=255&wi,s[r++]=c>>>4&15|112,s[r++]=255&c,s[r++]=l>>>13&63|128,s[r++]=l>>>5&255,s[r++]=l<<3&255|7&a[10],s[r++]=a[11],s[r++]=a[12],s[r++]=a[13],s[r++]=a[14],s[r++]=a[15],t||yi(s)};Yr({},{BaseCallbackHandler:()=>Ti,callbackHandlerPrefersStreaming:()=>ki,isBaseCallbackHandler:()=>Ii});var xi=class{};function ki(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}var Ti=class extends xi{lc_serializable=!1;get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ms(this.constructor)]}lc_kwargs;ignoreLLM=!1;ignoreChain=!1;ignoreAgent=!1;ignoreRetriever=!1;ignoreCustomEvent=!1;raiseError=!1;awaitHandlers="false"===di("LANGCHAIN_CALLBACKS_BACKGROUND");constructor(e){super(),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return fs.prototype.toJSON.call(this)}toJSONNotImplemented(){return fs.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends Ti{name=bi();constructor(){super(),Object.assign(this,e)}}}};const Ii=e=>{const t=e;return void 0!==t&&"function"==typeof t.copy&&"string"==typeof t.name&&"boolean"==typeof t.awaitHandlers},Ei={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},Oi=function(e,t,n){if(Ei.randomUUID&&!t&&!e)return Ei.randomUUID();var r=(e=e||{}).random||(e.rng||mi)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(var s=0;s<16;++s)t[n+s]=r[s];return t}return yi(r)},Si="gen_ai.request.model",Ai="gen_ai.usage.input_tokens",$i="gen_ai.usage.output_tokens",Ci="gen_ai.usage.total_tokens",Ni="langsmith.span.tags",Pi=(...e)=>fetch(...e),Ri=Symbol.for("ls:fetch_implementation"),ji=e=>async(...t)=>{if(e||"true"===Ki("DEBUG")){const[e,n]=t;console.log(`→ ${n?.method||"GET"} ${e}`)}const n=await(globalThis[Ri]??Pi)(...t);return(e||"true"===Ki("DEBUG"))&&console.log(`← ${n.status} ${n.statusText} ${n.url}`),n},Li=()=>Ki("PROJECT")??Ji("LANGCHAIN_SESSION")??"default",Mi={};function zi(e){Mi[e]||(console.warn(e),Mi[e]=!0)}const Ui=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function Di(e,t){if(!Ui.test(e))throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`);return e}const Fi="0.4.4";let Bi;const Zi=()=>"undefined"!=typeof Deno,qi=()=>Bi||(Bi="undefined"!=typeof Bun?"bun":"undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Zi()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom")?"jsdom":Zi()?"deno":"other":"node",Bi);let Vi,Hi;function Wi(){if(void 0===Vi){const e=qi(),t=function(){if(void 0!==Hi)return Hi;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=Ji(n);void 0!==e&&(t[n]=e)}return Hi=t,t}();Vi={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:Fi,...t}}return Vi}function Gi(){const e=function(){const e={};try{if("undefined"!=typeof process&&process.env)for(const[t,n]of Object.entries(process.env))(t.startsWith("LANGCHAIN_")||t.startsWith("LANGSMITH_"))&&null!=n&&((t.toLowerCase().includes("key")||t.toLowerCase().includes("secret")||t.toLowerCase().includes("token"))&&"string"==typeof n?e[t]=n.slice(0,2)+"*".repeat(n.length-4)+n.slice(-2):e[t]=n)}catch(e){}return e}(),t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[r,s]of Object.entries(e))"string"!=typeof s||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=s:t[r]=s);return t}function Ji(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function Ki(e){return Ji(`LANGSMITH_${e}`)||Ji(`LANGCHAIN_${e}`)}function Xi(){return"true"===Ji("OTEL_ENABLED")||"true"===Ki("OTEL_ENABLED")}class Yi{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){let n;if(!this.hasWarned&&Xi()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0),1===t.length&&"function"==typeof t[0]?n=t[0]:2===t.length&&"function"==typeof t[1]?n=t[1]:3===t.length&&"function"==typeof t[2]&&(n=t[2]),"function"==typeof n)return n()}}const Qi=Symbol.for("ls:otel_trace"),eo=Symbol.for("ls:otel_context"),to=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),no=new class{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new Yi})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}},ro=new class{active(){return{}}with(e,t){return t()}},so=new class{getTraceInstance(){return globalThis[Qi]??no}getContextInstance(){return globalThis[eo]??ro}initializeGlobalInstances(e){void 0===globalThis[Qi]&&(globalThis[Qi]=e.trace),void 0===globalThis[eo]&&(globalThis[eo]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[to]=e}getDefaultOTLPTracerComponents(){return globalThis[to]??void 0}};function ao(){return so.getTraceInstance()}const io={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};class oo{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(const n of e)try{if(!n.run)continue;if("post"===n.operation){const e=this.createSpanForRun(n,n.run,t.get(n.id));e&&!n.run.end_time&&this.spans.set(n.id,e)}else this.updateSpanForRun(n,n.run)}catch(e){console.error(`Error processing operation ${n.id}:`,e)}}createSpanForRun(e,t,n){const r=n&&ao().getSpan(n);if(r)try{return this.finishSpanSetup(r,t,e)}catch(t){return void console.error(`Failed to create span for run ${e.id}:`,t)}}finishSpanSetup(e,t,n){return this.setSpanAttributes(e,t,n),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{const n=this.spans.get(e.id);if(!n)return void console.debug(`No span found for run ${e.id} during update`);this.setSpanAttributes(n,t,e),t.error?(n.setStatus({code:2}),n.recordException(new Error(t.error))):n.setStatus({code:1});const r=t.end_time;r&&(n.end(new Date(r)),this.spans.delete(e.id))}catch(t){console.error(`Failed to update span for run ${e.id}:`,t)}}extractModelName(e){if(e.extra?.metadata){const t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){const e=t.invocation_params;if(e.model)return e.model;if(e.model_name)return e.model_name}}}setSpanAttributes(e,t,n){if("run_type"in t&&t.run_type){e.setAttribute("langsmith.span.kind",t.run_type);const n=(r=t.run_type||"chain",io[r]||r);e.setAttribute("gen_ai.operation.name",n)}var r;"name"in t&&t.name&&e.setAttribute("langsmith.trace.name",t.name),"session_id"in t&&t.session_id&&e.setAttribute("langsmith.trace.session_id",t.session_id),"session_name"in t&&t.session_name&&e.setAttribute("langsmith.trace.session_name",t.session_name),this.setGenAiSystem(e,t);const s=this.extractModelName(t);s&&e.setAttribute(Si,s),"prompt_tokens"in t&&"number"==typeof t.prompt_tokens&&e.setAttribute(Ai,t.prompt_tokens),"completion_tokens"in t&&"number"==typeof t.completion_tokens&&e.setAttribute($i,t.completion_tokens),"total_tokens"in t&&"number"==typeof t.total_tokens&&e.setAttribute(Ci,t.total_tokens),this.setInvocationParameters(e,t);const a=t.extra?.metadata||{};for(const[t,n]of Object.entries(a))null!=n&&e.setAttribute(`langsmith.metadata.${t}`,String(n));const i=t.tags;if(i&&Array.isArray(i)?e.setAttribute(Ni,i.join(", ")):i&&e.setAttribute(Ni,String(i)),"serialized"in t&&"object"==typeof t.serialized){const n=t.serialized;n.name&&e.setAttribute("gen_ai.serialized.name",String(n.name)),n.signature&&e.setAttribute("gen_ai.serialized.signature",String(n.signature)),n.doc&&e.setAttribute("gen_ai.serialized.doc",String(n.doc))}this.setIOAttributes(e,n)}setGenAiSystem(e,t){let n="langchain";const r=this.extractModelName(t);if(r){const e=r.toLowerCase();e.includes("anthropic")||e.startsWith("claude")?n="anthropic":e.includes("bedrock")?n="aws.bedrock":e.includes("azure")&&e.includes("openai")?n="az.ai.openai":e.includes("azure")&&e.includes("inference")?n="az.ai.inference":e.includes("cohere")?n="cohere":e.includes("deepseek")?n="deepseek":e.includes("gemini")?n="gemini":e.includes("groq")?n="groq":e.includes("watson")||e.includes("ibm")?n="ibm.watsonx.ai":e.includes("mistral")?n="mistral_ai":e.includes("gpt")||e.includes("openai")?n="openai":e.includes("perplexity")||e.includes("sonar")?n="perplexity":e.includes("vertex")?n="vertex_ai":(e.includes("xai")||e.includes("grok"))&&(n="xai")}e.setAttribute("gen_ai.system",n)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;const n=t.extra.metadata.invocation_params;void 0!==n.max_tokens&&e.setAttribute("gen_ai.request.max_tokens",n.max_tokens),void 0!==n.temperature&&e.setAttribute("gen_ai.request.temperature",n.temperature),void 0!==n.top_p&&e.setAttribute("gen_ai.request.top_p",n.top_p),void 0!==n.frequency_penalty&&e.setAttribute("gen_ai.request.frequency_penalty",n.frequency_penalty),void 0!==n.presence_penalty&&e.setAttribute("gen_ai.request.presence_penalty",n.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{const n=t.run.inputs;"object"==typeof n&&null!==n&&(n.model&&Array.isArray(n.messages)&&e.setAttribute(Si,n.model),void 0!==n.stream&&e.setAttribute("langsmith.request.streaming",n.stream),n.extra_headers&&e.setAttribute("langsmith.request.headers",JSON.stringify(n.extra_headers)),n.extra_query&&e.setAttribute("gen_ai.request.extra_query",JSON.stringify(n.extra_query)),n.extra_body&&e.setAttribute("gen_ai.request.extra_body",JSON.stringify(n.extra_body))),e.setAttribute("gen_ai.prompt",JSON.stringify(n))}catch(e){console.debug(`Failed to process inputs for run ${t.id}`,e)}if(t.run.outputs)try{const n=t.run.outputs,r=this.getUnifiedRunTokens(n);if(r&&(e.setAttribute(Ai,r[0]),e.setAttribute($i,r[1]),e.setAttribute(Ci,r[0]+r[1])),n&&"object"==typeof n){if(n.model&&e.setAttribute("gen_ai.response.model",String(n.model)),n.id&&e.setAttribute("gen_ai.response.id",n.id),n.choices&&Array.isArray(n.choices)){const t=n.choices.map(e=>e.finish_reason).filter(e=>e).map(String);t.length>0&&e.setAttribute("gen_ai.response.finish_reasons",t.join(", "))}if(n.service_tier&&e.setAttribute("gen_ai.response.service_tier",n.service_tier),n.system_fingerprint&&e.setAttribute("gen_ai.response.system_fingerprint",n.system_fingerprint),n.usage_metadata&&"object"==typeof n.usage_metadata){const t=n.usage_metadata;t.input_token_details&&e.setAttribute("gen_ai.usage.input_token_details",JSON.stringify(t.input_token_details)),t.output_token_details&&e.setAttribute("gen_ai.usage.output_token_details",JSON.stringify(t.output_token_details))}}e.setAttribute("gen_ai.completion",JSON.stringify(n))}catch(e){console.debug(`Failed to process outputs for run ${t.id}`,e)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;const n=Object.keys(e);for(const r of n){const n=e[r];if(n&&"object"==typeof n){if(t=this.extractUnifiedRunTokens(n.usage_metadata),t)return t;if(1===n.lc&&n.kwargs&&"object"==typeof n.kwargs&&(t=this.extractUnifiedRunTokens(n.kwargs.usage_metadata),t))return t}}const r=e.generations||[];if(!Array.isArray(r))return null;const s=Array.isArray(r[0])?r.flat():r;for(const e of s)if("object"==typeof e&&e.message&&"object"==typeof e.message&&e.message.kwargs&&"object"==typeof e.message.kwargs&&(t=this.extractUnifiedRunTokens(e.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return e&&"object"==typeof e?"number"!=typeof e.input_tokens||"number"!=typeof e.output_tokens?null:[e.input_tokens,e.output_tokens]:null}}const co=Object.prototype.toString,lo=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function uo(e,t,{min:n=0,allowInfinity:r=!1}={}){if(void 0!==t){if("number"!=typeof t||Number.isNaN(t))throw new TypeError(`Expected \`${e}\` to be a number${r?" or Infinity":""}.`);if(!r&&!Number.isFinite(t))throw new TypeError(`Expected \`${e}\` to be a finite number.`);if(t<n)throw new TypeError(`Expected \`${e}\` to be ≥ ${n}.`)}}class po extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function ho(e,t){return Number.isFinite(t)?t-(performance.now()-e):t}async function mo({error:e,attemptNumber:t,retriesConsumed:n,startTime:r,options:s}){const a=e instanceof Error?e:new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(a instanceof po)throw a.originalError;const i=Number.isFinite(s.retries)?Math.max(0,s.retries-n):s.retries,o=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:a,attemptNumber:t,retriesLeft:i,retriesConsumed:n});if(await s.onFailedAttempt(c),ho(r,o)<=0)throw a;const l=await s.shouldConsumeRetry(c),u=ho(r,o);if(u<=0||i<=0)throw a;if(a instanceof TypeError&&!function(e){var t;if(!e||(t=e,"[object Error]"!==co.call(t))||"TypeError"!==e.name||"string"!=typeof e.message)return!1;const{message:n,stack:r}=e;return"Load failed"===n?void 0===r||"__sentry_captured__"in e:!!n.startsWith("error sending request for url")||lo.has(n)}(a)){if(l)throw a;return s.signal?.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw a;if(!l)return s.signal?.throwIfAborted(),!1;const d=function(e,t){const n=Math.max(1,e+1),r=t.randomize?Math.random()+1:1;let s=Math.round(r*t.minTimeout*t.factor**(n-1));return s=Math.min(s,t.maxTimeout),s}(n,s),p=Math.min(d,u);return p>0&&await new Promise((e,t)=>{const n=()=>{clearTimeout(r),s.signal?.removeEventListener("abort",n),t(s.signal.reason)},r=setTimeout(()=>{s.signal?.removeEventListener("abort",n),e()},p);s.unref&&r.unref?.(),s.signal?.addEventListener("abort",n,{once:!0})}),s.signal?.throwIfAborted(),!0}var fo=n(3290);const go=[408,425,429,500,502,503,504];class yo{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxQueueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.maxQueueSizeBytes=e.maxQueueSizeBytes,this.queue=new fo.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){return this.callWithOptions({},e,...t)}callWithOptions(e,t,...n){const r=e.sizeBytes??0;if(void 0!==this.maxQueueSizeBytes&&r>0&&this.queueSizeBytes+r>this.maxQueueSizeBytes)return Promise.reject(new Error(`Queue size limit (${this.maxQueueSizeBytes} bytes) exceeded. Current queue size: ${this.queueSizeBytes} bytes, attempted addition: ${r} bytes.`));r>0&&(this.queueSizeBytes+=r);const s=this.onFailedResponseHook;let a=this.queue.add(()=>async function(e,t={}){if(function(e){if("number"==typeof e){if(e<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(e))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(void 0!==e)throw new TypeError("Expected `retries` to be a number or Infinity.")}((t={...t}).retries),Object.hasOwn(t,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");t.retries??=10,t.factor??=2,t.minTimeout??=1e3,t.maxTimeout??=Number.POSITIVE_INFINITY,t.maxRetryTime??=Number.POSITIVE_INFINITY,t.randomize??=!1,t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.shouldConsumeRetry??=()=>!0,uo("factor",t.factor,{min:0,allowInfinity:!1}),uo("minTimeout",t.minTimeout,{min:0,allowInfinity:!1}),uo("maxTimeout",t.maxTimeout,{min:0,allowInfinity:!0}),uo("maxRetryTime",t.maxRetryTime,{min:0,allowInfinity:!0}),t.factor>0||(t.factor=1),t.signal?.throwIfAborted();let n=0,r=0;const s=performance.now();for(;!Number.isFinite(t.retries)||r<=t.retries;){n++;try{t.signal?.throwIfAborted();const r=await e(n);return t.signal?.throwIfAborted(),r}catch(e){await mo({error:e,attemptNumber:n,retriesConsumed:r,startTime:s,options:t})&&r++}}throw new Error("Retry attempts exhausted without throwing an error.")}(()=>t(...n).catch(e=>{throw e instanceof Error?e:new Error(e)}),{async onFailedAttempt({error:e}){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||"TimeoutError"===e.name||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response;if(s&&await s(t))return;const n=t?.status??e?.status;if(n&&!go.includes(+n))throw e},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0});return r>0&&(a=a.finally(()=>{this.queueSizeBytes-=r})),e.signal?Promise.race([a,new Promise((t,n)=>{e.signal?.addEventListener("abort",()=>{n(new Error("AbortError"))})})]):a}}function _o(e){return"function"==typeof e?._getType}function vo(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}function wo(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,n]=e.split(":"),r=n||"latest";if(t.includes("/")){const[n,s]=t.split("/",2);if(!n||!s)throw new Error(`Invalid identifier format: ${e}`);return[n,s,r]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,r]}n(7280);class bo extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}class xo extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithNotFoundError",this.status=404}}function ko(e){return null!=e&&"object"==typeof e&&"name"in e&&"LangSmithNotFoundError"===e?.name}async function To(e,t,n){let r;if(e.ok)return void(n&&(r=await e.text()));if(403===e.status)try{const t=await e.json(),n=t?.error;"org_scoped_key_requires_workspace"===n&&(r="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch(t){const n=new Error(`${e.status} ${e.statusText}`);throw n.status=e?.status,n}if(void 0===r)try{r=await e.text()}catch(e){r=""}const s=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Message: ${r}`;if(404===e.status)throw new xo(s);if(409===e.status)throw new bo(s);const a=new Error(s);throw a.status=e.status,a}const Io="ERR_CONFLICTING_ENDPOINTS";class Eo extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:Io}),this.name="ConflictingEndpointsError"}}var Oo="[...]",So={result:"[Circular]"},Ao=[],$o=[];const Co=new TextEncoder;function No(e){return Co.encode(e)}function Po(e){if(e&&"object"==typeof e&&null!==e){if(e instanceof Map)return Object.fromEntries(e);if(e instanceof Set)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof RegExp)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message}}else if("bigint"==typeof e)return e.toString();return e}function Ro(e,t,n,r,s){try{return No(JSON.stringify(e,(a=n,function(e,t){if(a){const n=a.call(this,e,t);if(void 0!==n)return n}return Po(t)}),r))}catch(a){if(!a.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."+(t?`\nContext: ${t}`:"")),No("[Unserializable]");let i;"true"!==Ki("SUPPRESS_CIRCULAR_JSON_WARNINGS")&&console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. "+(t?`\nContext: ${t}`:"")),void 0===s&&(s={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),Lo(e,"",0,[],void 0,0,s);try{i=0===$o.length?JSON.stringify(e,n,r):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,n){if($o.length>0)for(var r=0;r<$o.length;r++){var s=$o[r];if(s[1]===t&&s[0]===n){n=s[2],$o.splice(r,1);break}}return e.call(this,t,n)}}(n),r)}catch(e){return No("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==Ao.length;){const e=Ao.pop();4===e.length?Object.defineProperty(e[0],e[1],e[3]):e[0][e[1]]=e[2]}}return No(i)}var a}function jo(e,t,n,r){var s=Object.getOwnPropertyDescriptor(r,n);void 0!==s.get?s.configurable?(Object.defineProperty(r,n,{value:e}),Ao.push([r,n,t,s])):$o.push([t,n,e]):(r[n]=e,Ao.push([r,n,t]))}function Lo(e,t,n,r,s,a,i){var o;if(a+=1,"object"==typeof e&&null!==e){for(o=0;o<r.length;o++)if(r[o]===e)return void jo(So,e,t,s);if(void 0!==i.depthLimit&&a>i.depthLimit)return void jo(Oo,e,t,s);if(void 0!==i.edgesLimit&&n+1>i.edgesLimit)return void jo(Oo,e,t,s);if(r.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Lo(e[o],o,o,r,e,a,i);else{e=Po(e);var c=Object.keys(e);for(o=0;o<c.length;o++){var l=c[o];Lo(e[l],l,o,r,e,a,i)}}r.pop()}}function Mo(e,t,n){if(n)return e;const r=Wi(),s=t??Gi(),a=e.extra??{},i=a.metadata;return e.extra={...a,runtime:{...r,...a?.runtime},metadata:{...s,...s.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??s.revision_id}:{},...i}},e}function zo(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Uo=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"10",10);if(t>0)return await new Promise(e=>setTimeout(e,t)),!0}return!1};function Do(e){return"number"==typeof e?Number(e.toFixed(4)):e}const Fo=1073741824,Bo="https://api.smith.langchain.com";class Zo{constructor(e){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"maxSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSizeBytes=e??Fo}peek(){return this.items[0]}push(e){let t;const n=new Promise(e=>{t=e}),r=Ro(e.item,`Serializing run with id: ${e.item.id}`).length;return this.sizeBytes+r>this.maxSizeBytes&&this.items.length>0?(console.warn(`AutoBatchQueue size limit (${this.maxSizeBytes} bytes) exceeded. Dropping run with id: ${e.item.id}. Current queue size: ${this.sizeBytes} bytes, attempted addition: ${r} bytes.`),t(),n):(this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:n,size:r}),this.sizeBytes+=r,n)}pop({upToSizeBytes:e,upToSize:t}){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const n=[];let r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0&&n.length<t;){const e=this.items.shift();e&&(n.push(e),r+=e.size,this.sizeBytes-=e.size)}if(0===n.length&&this.items.length>0){const e=this.items.shift();n.push(e),r+=e.size,this.sizeBytes-=e.size}return[n.map(e=>({action:e.action,item:e.payload,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,size:e.size})),()=>n.forEach(e=>e.itemPromiseResolve())]}}class qo{get _fetch(){return this.fetchImplementation||ji(this.debug)}constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitTracedRuntimeInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===Ji("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_multipartDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:"true"===Ji("LANGSMITH_DEBUG")});const t=qo.getDefaultClientConfig();if(this.tracingSampleRate=(e=>{const t=e?.toString()??Ki("TRACING_SAMPLING_RATE");if(void 0===t)return;const n=parseFloat(t);if(n<0||n>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${n}`);return n})(e.tracingSamplingRate),this.apiUrl=zo(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=zo(e.apiKey??t.apiKey),this.webUrl=zo(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=zo(e.workspaceId??Ki("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new yo({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation;const n=e.maxIngestMemoryBytes??Fo;this.batchIngestCaller=new yo({maxRetries:4,maxConcurrency:this.traceBatchConcurrency,maxQueueSizeBytes:n,...e.callerOptions??{},onFailedResponseHook:Uo,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.omitTracedRuntimeInfo=e.omitTracedRuntimeInfo??!1,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.autoBatchQueue=new Zo(n),this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,Xi()&&(this.langSmithToOTELTranslator=new oo),this.cachedLSEnvVarsForMetadata=Gi()}static getDefaultClientConfig(){const e=Ki("API_KEY");return{apiUrl:Ki("ENDPOINT")??Bo,apiKey:e,webUrl:void 0,hideInputs:"true"===Ki("HIDE_INPUTS"),hideOutputs:"true"===Ki("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(()=>{const e=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===e||"127.0.0.1"===e||"::1"===e})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Fi}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return"/v1"!==this.apiUrl.slice(-3)&&"/v1/"!==this.apiUrl.slice(-4)?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}async processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=await this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`;return await this.caller.call(async()=>{const t=await this._fetch(r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,`fetch ${e}`),t})}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let r=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(s));const a=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(async()=>{const t=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,`fetch ${e}`),t}),o=n?n(await i.json()):await i.json();if(0===o.length)break;if(yield o,o.length<s)break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const s=t?{...t}:{};for(;;){const t=JSON.stringify(s),a=await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await To(r,`fetch ${e}`),r}),i=await a.json();if(!i)break;if(!i[r])break;yield i[r];const o=i.cursors;if(!o)break;if(!o.next)break;s.cursor=o.next}}_shouldSample(){return void 0===this.tracingSampleRate||Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.filteredPostUuids.has(n.trace_id)?n.id===n.trace_id&&this.filteredPostUuids.delete(n.trace_id):t.push(n);return t}{const t=[];for(const n of e){const e=n.trace_id??n.id;this.filteredPostUuids.has(e)||(n.id===e?this._shouldSample()?t.push(n):this.filteredPostUuids.add(e):t.push(n))}return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e?.batch_ingest_config?.size_limit_bytes??25165824}async _getBatchSizeLimit(){const e=await this._ensureServerInfo();return this.batchSizeLimit??e?.batch_ingest_config?.size_limit??100}async _getDatasetExamplesMultiPartSupport(){const e=await this._ensureServerInfo();return e.instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t}){const n=[];for(;this.autoBatchQueue.items.length>0;){const[r,s]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:t});if(!r.length){s();break}const a=r.reduce((e,t)=>{const n=t.apiUrl??this.apiUrl,r=t.apiKey??this.apiKey,s=t.apiKey===this.apiKey&&t.apiUrl===this.apiUrl?"default":`${n}|${r}`;return e[s]||(e[s]=[]),e[s].push(t),e},{}),i=[];for(const[e,t]of Object.entries(a)){const n=this._processBatch(t,{apiUrl:"default"===e?void 0:e.split("|")[0],apiKey:"default"===e?void 0:e.split("|")[1]});i.push(n)}const o=Promise.all(i).finally(s);n.push(o)}return Promise.all(n)}async _processBatch(e,t){if(!e.length)return;const n=e.reduce((e,t)=>e+(t.size??0),0);try{if(void 0!==this.langSmithToOTELTranslator)this._sendBatchToOTELTranslator(e);else{const r={runCreates:e.filter(e=>"create"===e.action).map(e=>e.item),runUpdates:e.filter(e=>"update"===e.action).map(e=>e.item)},s=await this._ensureServerInfo();if(!this._multipartDisabled&&(s?.batch_ingest_config?.use_multipart_endpoint??1)){const e=s?.instance_flags?.gzip_body_enabled;try{await this.multipartIngestRuns(r,{...t,useGzip:e,sizeBytes:n})}catch(e){if(!ko(e))throw e;this._multipartDisabled=!0,await this.batchIngestRuns(r,{...t,sizeBytes:n})}}else await this.batchIngestRuns(r,{...t,sizeBytes:n})}}catch(e){console.error("Error exporting batch:",e)}}_sendBatchToOTELTranslator(e){if(void 0!==this.langSmithToOTELTranslator){const t=new Map,n=[];for(const r of e)r.item.id&&r.otelContext&&(t.set(r.item.id,r.otelContext),"create"===r.action?n.push({operation:"post",id:r.item.id,trace_id:r.item.trace_id??r.item.id,run:r.item}):n.push({operation:"patch",id:r.item.id,trace_id:r.item.trace_id??r.item.id,run:r.item}));this.langSmithToOTELTranslator.exportBatch(n,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=Mo(e.item,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const n=await this._getBatchSizeLimitBytes(),r=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>n||this.autoBatchQueue.items.length>r)&&this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:r}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:n,batchSizeLimit:r})},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e4),...this.fetchOptions});return await To(e,"get server info"),e}),t=await e.json();return this.debug&&console.log("\n=== LangSmith Server Configuration ===\n"+JSON.stringify(t,null,2)+"\n"),t}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),t=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t})}_cloneCurrentOTELContext(){const e=ao(),t=so.getContextInstance();if(void 0!==this.langSmithToOTELTranslator){const n=e.getActiveSpan();if(n)return e.setSpan(t.active(),n)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;const n={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const s=await this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==s.trace_id&&void 0!==s.dotted_order){const e=this._cloneCurrentOTELContext();return void this.processRunOperation({action:"create",item:s,otelContext:e,apiKey:t?.apiKey,apiUrl:t?.apiUrl}).catch(console.error)}const a=Mo(s,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);void 0!==t?.apiKey&&(n["x-api-key"]=t.apiKey),void 0!==t?.workspaceId&&(n["x-tenant-id"]=t.workspaceId);const i=Ro(a,`Creating run with id: ${a.id}`);await this.caller.call(async()=>{const e=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await To(e,"create run",!0),e})}async batchIngestRuns({runCreates:e,runUpdates:t},n){if(void 0===e&&void 0===t)return;let r=await Promise.all(e?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]),s=await Promise.all(t?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]);if(r.length>0&&s.length>0){const e=r.reduce((e,t)=>t.id?(e[t.id]=t,e):e,{}),t=[];for(const n of s)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);r=Object.values(e),s=t}const a={post:r,patch:s};if(!a.post.length&&!a.patch.length)return;const i={post:[],patch:[]};for(const e of["post","patch"]){const t=e,n=a[t].reverse();let r=n.pop();for(;void 0!==r;)i[t].push(r),r=n.pop()}if(i.post.length>0||i.patch.length>0){const e=i.post.map(e=>e.id).concat(i.patch.map(e=>e.id)).join(",");await this._postBatchIngestRuns(Ro(i,`Ingesting runs with ids: ${e}`),n)}}async _postBatchIngestRuns(e,t){const n={...this.headers,"Content-Type":"application/json",Accept:"application/json"};void 0!==t?.apiKey&&(n["x-api-key"]=t.apiKey),await this.batchIngestCaller.callWithOptions({sizeBytes:t?.sizeBytes},async()=>{const r=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:n,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await To(r,"batch create run",!0),r})}async multipartIngestRuns({runCreates:e,runUpdates:t},n){if(void 0===e&&void 0===t)return;const r={};let s=[];for(const t of e??[]){const e=await this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(r[e.id]=e.attachments),delete e.attachments,s.push(e)}let a=[];for(const e of t??[])a.push(await this.prepareRunCreateOrUpdateInputs(e));if(void 0!==s.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==a.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(s.length>0&&a.length>0){const e=s.reduce((e,t)=>t.id?(e[t.id]=t,e):e,{}),t=[];for(const n of a)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);s=Object.values(e),a=t}if(0===s.length&&0===a.length)return;const i=[],o=[];for(const[e,t]of[["post",s],["patch",a]])for(const n of t){const{inputs:t,outputs:s,events:a,extra:c,error:l,serialized:u,attachments:d,...p}=n,h={inputs:t,outputs:s,events:a,extra:c,error:l,serialized:u},m=Ro(p,`Serializing for multipart ingestion of run with id: ${p.id}`);o.push({name:`${e}.${p.id}`,payload:new Blob([m],{type:`application/json; length=${m.length}`})});for(const[t,n]of Object.entries(h)){if(void 0===n)continue;const r=Ro(n,`Serializing ${t} for multipart ingestion of run with id: ${p.id}`);o.push({name:`${e}.${p.id}.${t}`,payload:new Blob([r],{type:`application/json; length=${r.length}`})})}if(void 0!==p.id){const e=r[p.id];if(e){delete r[p.id];for(const[t,n]of Object.entries(e)){let e,r;Array.isArray(n)?[e,r]=n:(e=n.mimeType,r=n.data),t.includes(".")?console.warn(`Skipping attachment '${t}' for run ${p.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`):o.push({name:`attachment.${p.id}.${t}`,payload:new Blob([r],{type:`${e}; length=${r.byteLength}`})})}}}i.push(`trace=${p.trace_id},id=${p.id}`)}await this._sendMultipartRequest(o,i.join("; "),n)}async _createNodeFetchBody(e,t){const n=[];for(const r of e)n.push(new Blob([`--${t}\r\n`])),n.push(new Blob([`Content-Disposition: form-data; name="${r.name}"\r\n`,`Content-Type: ${r.payload.type}\r\n\r\n`])),n.push(r.payload),n.push(new Blob(["\r\n"]));n.push(new Blob([`--${t}--\r\n`]));const r=new Blob(n);return await r.arrayBuffer()}async _createMultipartStream(e,t){const n=new TextEncoder;return new ReadableStream({async start(r){const s=async e=>{"string"==typeof e?r.enqueue(n.encode(e)):r.enqueue(e)};for(const n of e){await s(`--${t}\r\n`),await s(`Content-Disposition: form-data; name="${n.name}"\r\n`),await s(`Content-Type: ${n.payload.type}\r\n\r\n`);const e=n.payload.stream().getReader();try{let t;for(;!(t=await e.read()).done;)r.enqueue(t.value)}finally{e.releaseLock()}await s("\r\n")}await s(`--${t}--\r\n`),r.close()}})}async _sendMultipartRequest(e,t,n){const r="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),s=(()=>{const e=globalThis[Ri];return!!e&&"function"==typeof e&&"Headers"in e&&"Request"in e&&"Response"in e})(),a=()=>this._createNodeFetchBody(e,r),i=()=>this._createMultipartStream(e,r),o=async e=>this.batchIngestCaller.callWithOptions({sizeBytes:n?.sizeBytes},async()=>{const t=await e(),s={...this.headers,"Content-Type":`multipart/form-data; boundary=${r}`};void 0!==n?.apiKey&&(s["x-api-key"]=n.apiKey);let a=t;n?.useGzip&&"object"==typeof t&&"pipeThrough"in t&&(a=t.pipeThrough(new CompressionStream("gzip")),s["Content-Encoding"]="gzip");const i=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:s,body:a,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(i,"Failed to send multipart request",!0),i});try{let e,r=!1;s||this.multipartStreamingDisabled||"bun"===qi()?e=await o(a):(r=!0,e=await o(i)),this.multipartStreamingDisabled&&!r||422!==e.status||(n?.apiUrl??this.apiUrl)===Bo||(console.warn(`Streaming multipart upload to ${n?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${t}".`),this.multipartStreamingDisabled=!0,e=await o(a))}catch(e){if(ko(e))throw e;console.warn(`${e.message.trim()}\n\nContext: ${t}`)}}async updateRun(e,t,n){Di(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order){const e=this._cloneCurrentOTELContext();return void 0!==t.end_time&&void 0===r.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:r,otelContext:e,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error):void this.processRunOperation({action:"update",item:r,otelContext:e,apiKey:n?.apiKey,apiUrl:n?.apiUrl}).catch(console.error)}const s={...this.headers,"Content-Type":"application/json"};void 0!==n?.apiKey&&(s["x-api-key"]=n.apiKey),void 0!==n?.workspaceId&&(s["x-tenant-id"]=n.workspaceId);const a=Ro(t,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const t=await this._fetch(`${n?.apiUrl??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:s,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await To(t,"update run",!0),t})}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Di(e);let n=await this._get(`/runs/${e}`);return t&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;e=t.session_id?t.session_id:n?.projectName?(await this.readProject({projectName:n?.projectName})).id:n?.projectId?n?.projectId:(await this.readProject({projectName:Ki("PROJECT")||"default"})).id;const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),n={},r={};t.sort((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??""));for(const s of t){if(null===s.parent_run_id||void 0===s.parent_run_id)throw new Error(`Child run ${s.id} has no parent`);s.dotted_order?.startsWith(e.dotted_order??"")&&s.id!==e.id&&(s.parent_run_id in n||(n[s.parent_run_id]=[]),n[s.parent_run_id].push(s),r[s.id]=s)}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:s,referenceExampleId:a,startTime:i,executionOrder:o,isRoot:c,runType:l,error:u,id:d,query:p,filter:h,traceFilter:m,treeFilter:f,limit:g,select:y,order:_}=e;let v=[];if(t&&(v=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map(e=>this.readProject({projectName:e}).then(e=>e.id)));v.push(...t)}const w={session:v.length?v:null,run_type:l,reference_example:a,query:p,filter:h,trace_filter:m,tree_filter:f,execution_order:o,parent_run:r,start_time:i?i.toISOString():null,error:u,id:d,limit:g,trace:s,select:y||["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c,order:_};w.select.includes("child_run_ids")&&zi("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let b=0;for await(const e of this._getCursorPaginatedList("/runs/query",w))if(g){if(b>=g)break;if(e.length+b>g){const t=e.slice(0,g-b);yield*t;break}b+=e.length,yield*e}else yield*e}async*listGroupRuns(e){const{projectId:t,projectName:n,groupBy:r,filter:s,startTime:a,endTime:i,limit:o,offset:c}=e,l={session_id:t||(await this.readProject({projectName:n})).id,group_by:r,filter:s,start_time:a?a.toISOString():null,end_time:i?i.toISOString():null,limit:Number(o)||100};let u=Number(c)||0;const d="/runs/group",p=`${this.apiUrl}${d}`;for(;;){const e={...l,offset:u},t=Object.fromEntries(Object.entries(e).filter(([e,t])=>void 0!==t)),n=JSON.stringify(t),r=await this.caller.call(async()=>{const e=await this._fetch(p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await To(e,`Failed to fetch ${d}`),e}),s=await r.json(),{groups:a,total:i}=s;if(0===a.length)break;for(const e of a)yield e;if(u+=a.length,u>=i)break}}async getRunStats({id:e,trace:t,parentRun:n,runType:r,projectNames:s,projectIds:a,referenceExampleIds:i,startTime:o,endTime:c,error:l,query:u,filter:d,traceFilter:p,treeFilter:h,isRoot:m,dataSourceType:f}){let g=a||[];s&&(g=[...a||[],...await Promise.all(s.map(e=>this.readProject({projectName:e}).then(e=>e.id)))]);const y={id:e,trace:t,parent_run:n,run_type:r,session:g,reference_example:i,start_time:o,end_time:c,error:l,query:u,filter:d,trace_filter:p,tree_filter:h,is_root:m,data_source_type:f},_=Object.fromEntries(Object.entries(y).filter(([e,t])=>void 0!==t)),v=JSON.stringify(_),w=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:v});return await To(e,"get run stats"),e});return await w.json()}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||Oi()};Di(e);const r=JSON.stringify(n),s=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await To(t,"share run"),t}),a=await s.json();if(null===a||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){Di(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"unshare run",!0),t})}async readRunSharedLink(e){Di(e);const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"read run shared link"),t}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);Di(e);const r=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"list shared runs"),t});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){const n=await this.readDataset({datasetName:t});e=n.id}Di(e);const n=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"read dataset shared schema"),t}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){const n=await this.readDataset({datasetName:t});e=n.id}const n={dataset_id:e};Di(e);const r=JSON.stringify(n),s=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await To(t,"share dataset"),t}),a=await s.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){Di(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"unshare dataset",!0),t})}async readSharedDataset(e){Di(e);const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"read shared dataset"),t});return await t.json()}async listSharedExamples(e,t){const n={};t?.exampleIds&&(n.id=t.exampleIds);const r=new URLSearchParams;Object.entries(n).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>r.append(e,t)):r.append(e,t)});const s=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/examples?${r.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"list shared examples"),t}),a=await s.json();if(!s.ok){if("detail"in a)throw new Error(`Failed to list shared examples.\nStatus: ${s.status}\nMessage: ${Array.isArray(a.detail)?a.detail.join("\n"):"Unspecified error"}`);throw new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`)}return a.map(e=>({...e,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:s=null,referenceDatasetId:a=null}){const i=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${i}`,c=s||{};n&&(c.metadata=n);const l={name:e,extra:c,description:t};null!==a&&(l.reference_dataset_id=a);const u=JSON.stringify(l),d=await this.caller.call(async()=>{const e=await this._fetch(o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await To(e,"create project"),e});return await d.json()}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:s=null,endTime:a=null}){const i=`${this.apiUrl}/sessions/${e}`;let o=s;r&&(o={...o||{},metadata:r});const c=JSON.stringify({name:t,extra:o,description:n,end_time:a?new Date(a).toISOString():null}),l=await this.caller.call(async()=>{const e=await this._fetch(i,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await To(e,"update project"),e});return await l.json()}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Di(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const s=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,"has project"),e});try{const e=await s.json();return!!s.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const s=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Di(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");s.append("name",t)}void 0!==n&&s.append("include_stats",n.toString());const a=await this._get(r,s);let i;if(Array.isArray(a)){if(0===a.length)throw new Error(`Project[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:s,includeStats:a,datasetVersion:i,referenceFree:o,metadata:c}={}){const l=new URLSearchParams;if(void 0!==e)for(const t of e)l.append("id",t);if(void 0!==t&&l.append("name",t),void 0!==n&&l.append("name_contains",n),void 0!==r)l.append("reference_dataset",r);else if(void 0!==s){const e=await this.readDataset({datasetName:s});l.append("reference_dataset",e.id)}void 0!==a&&l.append("include_stats",a.toString()),void 0!==i&&l.append("dataset_version",i),void 0!==o&&l.append("reference_free",o.toString()),void 0!==c&&l.append("metadata",JSON.stringify(c));for await(const e of this._getPaginated("/sessions",l))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,Di(n),await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,`delete session ${n} (${t})`,!0),e})}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:s,dataType:a,name:i}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),n.forEach(e=>{c.append("input_keys",e)}),r.forEach(e=>{c.append("output_keys",e)}),s&&c.append("description",s),a&&c.append("data_type",a),i&&c.append("name",i);const l=await this.caller.call(async()=>{const e=await this._fetch(o,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await To(e,"upload CSV"),e});return await l.json()}async createDataset(e,{description:t,dataType:n,inputsSchema:r,outputsSchema:s,metadata:a}={}){const i={name:e,description:t,extra:a?{metadata:a}:void 0};n&&(i.data_type=n),r&&(i.inputs_schema_definition=r),s&&(i.outputs_schema_definition=s);const o=JSON.stringify(i),c=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await To(e,"create dataset"),e});return await c.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(e&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(e)Di(e),n+=`/${e}`;else{if(!t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const s=await this._get(n,r);let a;if(Array.isArray(s)){if(0===s.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);a=s[0]}else a=s;return a}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let s=e;if(void 0===s&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==s&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===s&&(s=(await this.readDataset({datasetName:t})).id);const a=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide either datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map(e=>JSON.parse(e))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:s,metadata:a}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)i.append("id",e);void 0!==r&&i.append("name",r),void 0!==s&&i.append("name_contains",s),void 0!==a&&i.append("metadata",JSON.stringify(a));for await(const e of this._getPaginated("/datasets",i))yield*e}async updateDataset(e){const{datasetId:t,datasetName:n,...r}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:n})).id;Di(s);const a=JSON.stringify(r),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await To(e,"update dataset"),e});return await i.json()}async updateDatasetTag(e){const{datasetId:t,datasetName:n,asOf:r,tag:s}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:n})).id;Di(a);const i=JSON.stringify({as_of:"string"==typeof r?r:r.toISOString(),tag:s});await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${a}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await To(e,"update dataset tags",!0),e})}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(r=(await this.readDataset({datasetName:t})).id),void 0===r)throw new Error("Must provide datasetName or datasetId");Di(r),n+=`/${r}`,await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,`delete ${n}`,!0),e})}async indexDataset({datasetId:e,datasetName:t,tag:n}){let r=e;if(!r&&!t)throw new Error("Must provide either datasetName or datasetId");if(r&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(!r){const e=await this.readDataset({datasetName:t});r=e.id}Di(r);const s={tag:n},a=JSON.stringify(s),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${r}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await To(e,"index dataset"),e});await i.json()}async similarExamples(e,t,n,{filter:r}={}){const s={limit:n,inputs:e};void 0!==r&&(s.filter=r),Di(t);const a=JSON.stringify(s),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:a});return await To(e,"fetch similar examples"),e});return(await i.json()).examples}async createExample(e,t,n){if(Vo(e)&&(void 0!==t||void 0!==n))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let r=t?n?.datasetId:e.dataset_id;const s=t?n?.datasetName:e.dataset_name;if(void 0===r&&void 0===s)throw new Error("Must provide either datasetName or datasetId");if(void 0!==r&&void 0!==s)throw new Error("Must provide either datasetName or datasetId, not both");void 0===r&&(r=(await this.readDataset({datasetName:s})).id);const a=(t?n?.createdAt:e.created_at)||new Date;let i;i=Vo(e)?e:{inputs:e,outputs:t,created_at:a?.toISOString(),id:n?.exampleId,metadata:n?.metadata,split:n?.split,source_run_id:n?.sourceRunId,use_source_run_io:n?.useSourceRunIO,use_source_run_attachments:n?.useSourceRunAttachments,attachments:n?.attachments};const o=await this._uploadExamplesMultipart(r,[i]);return await this.readExample(o.example_ids?.[0]??Oi())}async createExamples(e){if(Array.isArray(e)){if(0===e.length)return[];const t=e;let n=t[0].dataset_id;const r=t[0].dataset_name;if(void 0===n&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");void 0===n&&(n=(await this.readDataset({datasetName:r})).id);const s=await this._uploadExamplesMultipart(n,t);return await Promise.all(s.example_ids.map(e=>this.readExample(e)))}const{inputs:t,outputs:n,metadata:r,splits:s,sourceRunIds:a,useSourceRunIOs:i,useSourceRunAttachments:o,attachments:c,exampleIds:l,datasetId:u,datasetName:d}=e;if(void 0===t)throw new Error("Must provide inputs when using legacy parameters");let p=u;const h=d;if(void 0===p&&void 0===h)throw new Error("Must provide either datasetName or datasetId");if(void 0!==p&&void 0!==h)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===p){const e=await this.readDataset({datasetName:h});p=e.id}const m=t.map((e,t)=>({dataset_id:p,inputs:e,outputs:n?.[t],metadata:r?.[t],split:s?.[t],id:l?.[t],attachments:c?.[t],source_run_id:a?.[t],use_source_run_io:i?.[t],use_source_run_attachments:o?.[t]})),f=await this._uploadExamplesMultipart(p,m);return await Promise.all(f.example_ids.map(e=>this.readExample(e)))}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map(e=>_o(e)?vo(e):e),s=_o(t)?vo(t):t;return this.createExample({input:r},{output:s},n)}async readExample(e){Di(e);const t=`/examples/${e}`,n=await this._get(t),{attachment_urls:r,...s}=n,a=s;return r&&(a.attachments=Object.entries(r).reduce((e,[t,n])=>(e[t.slice(11)]={presigned_url:n.presigned_url,mime_type:n.mime_type},e),{})),a}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,splits:s,inlineS3Urls:a,metadata:i,limit:o,offset:c,filter:l,includeAttachments:u}={}){let d;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");d=(await this.readDataset({datasetName:t})).id}const p=new URLSearchParams({dataset:d}),h=r?"string"==typeof r?r:r?.toISOString():void 0;h&&p.append("as_of",h);const m=a??!0;if(p.append("inline_s3_urls",m.toString()),void 0!==n)for(const e of n)p.append("id",e);if(void 0!==s)for(const e of s)p.append("splits",e);if(void 0!==i){const e=JSON.stringify(i);p.append("metadata",e)}void 0!==o&&p.append("limit",o.toString()),void 0!==c&&p.append("offset",c.toString()),void 0!==l&&p.append("filter",l),!0===u&&["attachment_urls","outputs","metadata"].forEach(e=>p.append("select",e));let f=0;for await(const e of this._getPaginated("/examples",p)){for(const t of e){const{attachment_urls:e,...n}=t,r=n;e&&(r.attachments=Object.entries(e).reduce((e,[t,n])=>(e[t.slice(11)]={presigned_url:n.presigned_url,mime_type:n.mime_type||void 0},e),{})),yield r,f++}if(void 0!==o&&f>=o)break}}async deleteExample(e){Di(e);const t=`/examples/${e}`;await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,`delete ${t}`,!0),e})}async deleteExamples(e,t){if(e.forEach(e=>Di(e)),t?.hardDelete){const t=this._getPlatformEndpointPath("datasets/examples/delete");await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}${t}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({example_ids:e,hard_delete:!0}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(n,"hard delete examples",!0),n})}else{const t=new URLSearchParams;e.forEach(e=>t.append("example_ids",e)),await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/examples?${t.toString()}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,"delete examples",!0),e})}}async updateExample(e,t){let n,r,s;return n=t?e:e.id,Di(n),r=t?{id:n,...t}:e,s=void 0!==r.dataset_id?r.dataset_id:(await this.readExample(n)).dataset_id,this._updateExamplesMultipart(s,[r])}async updateExamples(e){let t;return t=void 0===e[0].dataset_id?(await this.readExample(e[0].id)).dataset_id:e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:n,tag:r}){let s;if(e)s=e;else{const e=await this.readDataset({datasetName:t});s=e.id}if(Di(s),n&&r||!n&&!r)throw new Error("Exactly one of asOf and tag must be specified.");const a=new URLSearchParams;void 0!==n&&a.append("as_of","string"==typeof n?n:n.toISOString()),void 0!==r&&a.append("tag",r);const i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${s}/version?${a.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,"read dataset version"),e});return await i.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");r=void 0===e?(await this.readDataset({datasetName:t})).id:e,Di(r);const s=new URLSearchParams,a=n?"string"==typeof n?n:n?.toISOString():void 0;return a&&s.append("as_of",a),await this._get(`/datasets/${r}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:r,remove:s=!1}){let a;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){const e=await this.readDataset({datasetName:t});a=e.id}else a=e;Di(a);const i={split_name:n,examples:r.map(e=>(Di(e),e)),remove:s},o=JSON.stringify(i);await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await To(e,"update dataset splits",!0),e})}async createFeedback(e,t,{score:n,value:r,correction:s,comment:a,sourceInfo:i,feedbackSourceType:o="api",sourceRunId:c,feedbackId:l,feedbackConfig:u,projectId:d,comparativeExperimentId:p}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const h={type:o??"api",metadata:i??{}};void 0===c||void 0===h?.metadata||h.metadata.__run||(h.metadata.__run={run_id:c}),void 0!==h?.metadata&&void 0!==h.metadata.__run?.run_id&&Di(h.metadata.__run.run_id);const m={id:l??Oi(),run_id:e,key:t,score:Do(n),value:r,correction:s,comment:a,feedback_source:h,comparative_experiment_id:p,feedbackConfig:u,session_id:d},f=JSON.stringify(m),g=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const e=await this._fetch(g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:f});return await To(e,"create feedback",!0),e}),m}async updateFeedback(e,{score:t,value:n,correction:r,comment:s}){const a={};null!=t&&(a.score=Do(t)),null!=n&&(a.value=n),null!=r&&(a.correction=r),null!=s&&(a.comment=s),Di(e);const i=JSON.stringify(a);await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await To(t,"update feedback",!0),t})}async readFeedback(e){Di(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Di(e);const t=`/feedback/${e}`;await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,`delete ${t}`,!0),e})}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e)for(const t of e)Di(t),r.append("run",t);if(t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const s={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?s.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(s.expires_in=n):s.expires_in={hours:3};const a=JSON.stringify(s),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await To(e,"create presigned feedback token"),e});return await i.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:s,metadata:a,id:i}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const o={id:i,name:e,experiment_ids:t,reference_dataset_id:n,description:s,created_at:(r??new Date)?.toISOString(),extra:{}};a&&(o.extra.metadata=a);const c=JSON.stringify(o);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await To(e,"create comparative experiment"),e})).json()}async*listPresignedFeedbackTokens(e){Di(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:Array.isArray(e)?e:[e],t}async _logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e),s=[];for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let a=null;e.targetRunId?a=e.targetRunId:t&&(a=t.id),s.push(await this.createFeedback(a,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[r,s]}async logEvaluationFeedback(e,t,n){const[r]=await this._logEvaluationFeedback(e,t,n);return r}async*listAnnotationQueues(e={}){const{queueIds:t,name:n,nameContains:r,limit:s}=e,a=new URLSearchParams;t&&t.forEach((e,t)=>{Di(e,`queueIds[${t}]`),a.append("ids",e)}),n&&a.append("name",n),r&&a.append("name_contains",r),a.append("limit",(void 0!==s?Math.min(s,100):100).toString());let i=0;for await(const e of this._getPaginated("/annotation-queues",a))if(yield*e,i++,void 0!==s&&i>=s)break}async createAnnotationQueue(e){const{name:t,description:n,queueId:r,rubricInstructions:s}=e,a={name:t,description:n,id:r||Oi(),rubric_instructions:s},i=JSON.stringify(Object.fromEntries(Object.entries(a).filter(([e,t])=>void 0!==t)));return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await To(e,"create annotation queue"),e})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Di(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"read annotation queue"),t})).json()}async updateAnnotationQueue(e,t){const{name:n,description:r,rubricInstructions:s}=t,a=JSON.stringify({name:n,description:r,rubric_instructions:s});await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Di(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await To(t,"update annotation queue",!0),t})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Di(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"delete annotation queue",!0),t})}async addRunsToAnnotationQueue(e,t){const n=JSON.stringify(t.map((e,t)=>Di(e,`runIds[${t}]`).toString()));await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Di(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await To(t,"add runs to annotation queue",!0),t})}async getRunFromAnnotationQueue(e,t){const n=`/annotation-queues/${Di(e,"queueId")}/run`;return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,"get run from annotation queue"),e})).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}/annotation-queues/${Di(e,"queueId")}/runs/${Di(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(n,"delete run from annotation queue",!0),n})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Di(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"get size from annotation queue"),t})).json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${n.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(t,"get latest commit hash"),t}),n=await t.json();if(0!==n.commits.length)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[n,r,s]=wo(e),a=JSON.stringify({like:t});return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/likes/${n}/${r}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await To(e,(t?"like":"unlike")+" prompt"),e})).json()}async _getPromptUrl(e){const[t,n,r]=wo(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==r?`${this.getHostUrl()}/prompts/${n}/${r.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${e.id}`}return"latest"!==r?`${this.getHostUrl()}/hub/${t}/${n}/${r.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,e=>e.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,e=>e.repos))yield*e}async getPrompt(e){const[t,n,r]=wo(e),s=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return 404===e?.status?null:(await To(e,"get prompt"),e)}),a=await(s?.json());return a?.repo?a.repo:null}async createPrompt(e,t){const n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle.\n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[r,s,a]=wo(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("create a prompt",r);const i={repo_handle:s,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},o=JSON.stringify(i),c=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await To(e,"create prompt"),e}),{repo:l}=await c.json();return l}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s,a]=wo(e),i="latest"!==n?.parentCommitHash&&n?.parentCommitHash?n?.parentCommitHash:await this._getLatestCommitHash(`${r}/${s}`),o={manifest:JSON.parse(JSON.stringify(t)),parent_commit:i},c=JSON.stringify(o),l=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/commits/${r}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await To(e,"create commit"),e}),u=await l.json();return this._getPromptUrl(`${r}/${s}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const e of t){const t=e.id,r=Ro({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}},`Serializing body for example with id: ${t}`),s=new Blob([r],{type:"application/json"});if(n.append(t,s),e.inputs){const r=Ro(e.inputs,`Serializing inputs for example with id: ${t}`),s=new Blob([r],{type:"application/json"});n.append(`${t}.inputs`,s)}if(e.outputs){const r=Ro(e.outputs,`Serializing outputs whle updating example with id: ${t}`),s=new Blob([r],{type:"application/json"});n.append(`${t}.outputs`,s)}if(e.attachments)for(const[r,s]of Object.entries(e.attachments)){let e,a;Array.isArray(s)?[e,a]=s:(e=s.mimeType,a=s.data);const i=new Blob([a],{type:`${e}; length=${a.byteLength}`});n.append(`${t}.attachment.${r}`,i)}if(e.attachments_operations){const r=Ro(e.attachments_operations,`Serializing attachments while updating example with id: ${t}`),s=new Blob([r],{type:"application/json"});n.append(`${t}.attachments_operations`,s)}}const r=e??t[0]?.dataset_id;return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${r}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await To(e,"update examples"),e})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const n=new FormData;for(const e of t){const t=(e.id??Oi()).toString(),r=Ro({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split},...e.source_run_id&&{source_run_id:e.source_run_id},...e.use_source_run_io&&{use_source_run_io:e.use_source_run_io},...e.use_source_run_attachments&&{use_source_run_attachments:e.use_source_run_attachments}},`Serializing body for uploaded example with id: ${t}`),s=new Blob([r],{type:"application/json"});if(n.append(t,s),e.inputs){const r=Ro(e.inputs,`Serializing inputs for uploaded example with id: ${t}`),s=new Blob([r],{type:"application/json"});n.append(`${t}.inputs`,s)}if(e.outputs){const r=Ro(e.outputs,`Serializing outputs for uploaded example with id: ${t}`),s=new Blob([r],{type:"application/json"});n.append(`${t}.outputs`,s)}if(e.attachments)for(const[r,s]of Object.entries(e.attachments)){let e,a;Array.isArray(s)?[e,a]=s:(e=s.mimeType,a=s.data);const i=new Blob([a],{type:`${e}; length=${a.byteLength}`});n.append(`${t}.attachment.${r}`,i)}}return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await To(t,"upload examples"),t})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r]=wo(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const s={};if(void 0!==t?.description&&(s.description=t.description),void 0!==t?.readme&&(s.readme=t.readme),void 0!==t?.tags&&(s.tags=t.tags),void 0!==t?.isPublic&&(s.is_public=t.isPublic),void 0!==t?.isArchived&&(s.is_archived=t.isArchived),0===Object.keys(s).length)throw new Error("No valid update options provided");const a=JSON.stringify(s);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${n}/${r}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await To(e,"update prompt"),e})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,n,r]=wo(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,"delete prompt"),e})).json()}async pullPromptCommit(e,t){const[n,r,s]=wo(e),a=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/commits/${n}/${r}/${s}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await To(e,"pull prompt commit"),e}),i=await a.json();return{owner:n,repo:r,commit_hash:i.commit_hash,manifest:i.manifest,examples:i.examples}}async _pullPrompt(e,t){const n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(e=>"object"!==e)&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:n=this.apiUrl,datasetName:r}=t,[s,a]=this.parseTokenOrUrl(e,n),i=new qo({apiUrl:s,apiKey:"placeholder"}),o=await i.readSharedDataset(a),c=r||o.name;try{if(await this.hasDataset({datasetId:c}))return void console.log(`Dataset ${c} already exists in your tenant. Skipping.`)}catch(e){}const l=await i.listSharedExamples(a),u=await this.createDataset(c,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(e=>e.inputs),outputs:l.flatMap(e=>e.outputs?[e.outputs]:[]),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,n=2,r="dataset"){try{return Di(e),[t,e]}catch(e){}try{const s=new URL(e).pathname.split("/").filter(e=>""!==e);if(s.length>=n)return[t,s[s.length-n]];throw new Error(`Invalid public ${r} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${r} URL or token: ${e}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await new Promise(e=>setTimeout(e,1)),await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()]),void 0!==this.langSmithToOTELTranslator&&await(so.getDefaultOTLPTracerComponents()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush())}}function Vo(e){return"dataset_id"in e||"dataset_name"in e}const Ho=Symbol.for("lc:context_variables"),Wo=(Symbol.for("lc:child_run_end_promises"),Symbol.for("langsmith:replica_trace_roots"));function Go(e,t){if(Ho in e)return e[Ho][t]}const Jo=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,Ko=function(e){return"string"==typeof e&&Jo.test(e)};function Xo(e,t,n,r){switch(e){case 0:return t&n^~t&r;case 1:case 3:return t^n^r;case 2:return t&n^t&r^n&r}}function Yo(e,t){return e<<t|e>>>32-t}var Qo=function(e,t,n){function r(e,t,r,s){var a;if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],n=0;n<e.length;++n)t.push(e.charCodeAt(n));return t}(e)),"string"==typeof t&&(t=function(e){if(!Ko(e))throw TypeError("Invalid UUID");var t,n=new Uint8Array(16);return n[0]=(t=parseInt(e.slice(0,8),16))>>>24,n[1]=t>>>16&255,n[2]=t>>>8&255,n[3]=255&t,n[4]=(t=parseInt(e.slice(9,13),16))>>>8,n[5]=255&t,n[6]=(t=parseInt(e.slice(14,18),16))>>>8,n[7]=255&t,n[8]=(t=parseInt(e.slice(19,23),16))>>>8,n[9]=255&t,n[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,n[11]=t/4294967296&255,n[12]=t>>>24&255,n[13]=t>>>16&255,n[14]=t>>>8&255,n[15]=255&t,n}(t)),16!==(null===(a=t)||void 0===a?void 0:a.length))throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var i=new Uint8Array(16+e.length);if(i.set(t),i.set(e,t.length),(i=n(i))[6]=15&i[6]|80,i[8]=63&i[8]|128,r){s=s||0;for(var o=0;o<16;++o)r[s+o]=i[o];return r}return yi(i)}try{r.name="v5"}catch(e){}return r.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",r.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",r}(0,0,function(e){var t=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var r=unescape(encodeURIComponent(e));e=[];for(var s=0;s<r.length;++s)e.push(r.charCodeAt(s))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var a=e.length/4+2,i=Math.ceil(a/16),o=new Array(i),c=0;c<i;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=e[64*c+4*u]<<24|e[64*c+4*u+1]<<16|e[64*c+4*u+2]<<8|e[64*c+4*u+3];o[c]=l}o[i-1][14]=8*(e.length-1)/Math.pow(2,32),o[i-1][14]=Math.floor(o[i-1][14]),o[i-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<i;++d){for(var p=new Uint32Array(80),h=0;h<16;++h)p[h]=o[d][h];for(var m=16;m<80;++m)p[m]=Yo(p[m-3]^p[m-8]^p[m-14]^p[m-16],1);for(var f=n[0],g=n[1],y=n[2],_=n[3],v=n[4],w=0;w<80;++w){var b=Math.floor(w/20),x=Yo(f,5)+Xo(b,g,y,_)+v+t[b]+p[w]>>>0;v=_,_=y,y=Yo(g,30)>>>0,g=f,f=x}n[0]=n[0]+f>>>0,n[1]=n[1]+g>>>0,n[2]=n[2]+y>>>0,n[3]=n[3]+_>>>0,n[4]=n[4]+v>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,255&n[0],n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,255&n[1],n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,255&n[2],n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,255&n[3],n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,255&n[4]]});const ec=Qo,tc="6ba7b810-9dad-11d1-80b4-00c04fd430c8";function nc(e){const t=Object.keys(e).sort().map(t=>`${t}:${e[t]??""}`).join("|");return ec(t,tc)}function rc(e,t=1){const n=t.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${n}Z`}function sc(e,t,n=1){const r=rc(e,n);return{dottedOrder:(s=r,s.replace(/[-:.]/g,"")+t),microsecondPrecisionDatestring:r};var s}class ac{constructor(e,t,n,r){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=n,this.replicas=r}static fromHeader(e){const t=e.split(",");let n,r,s={},a=[];for(const e of t){const[t,i]=e.split("="),o=decodeURIComponent(i);"langsmith-metadata"===t?s=JSON.parse(o):"langsmith-tags"===t?a=o.split(","):"langsmith-project"===t?n=o:"langsmith-replicas"===t&&(r=JSON.parse(o))}return new ac(s,a,n,r)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class ic{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"distributedParentId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_awaitInputsOnPost",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),null!=(t=e)&&"function"==typeof t.createChild&&"function"==typeof t.postRun)return void Object.assign(this,{...e});var t;const n=ic.getDefaultConfig(),{metadata:r,...s}=e,a=s.client??ic.getSharedClient(),i={...r,...s?.extra?.metadata};if(s.extra={...s.extra,metadata:i},"id"in s&&null==s.id&&delete s.id,Object.assign(this,{...n,...s,client:a}),this.execution_order??=1,this.child_execution_order??=1,this.dotted_order||(this._serialized_start_time=rc(this.start_time,this.execution_order)),this.id||(this.id=function(e){const t="string"==typeof e?Date.parse(e):e;return bi({msecs:t,seq:0})}(this._serialized_start_time??this.start_time)),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=(o=this.replicas)?o.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):function(){const e=Ji("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t)){const e=[];for(const n of t)"object"==typeof n&&null!==n?"string"==typeof n.api_url?"string"==typeof n.api_key?e.push({apiUrl:n.api_url.replace(/\/$/,""),apiKey:n.api_key}):console.warn("Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got "+typeof n.api_key):console.warn("Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got "+typeof n.api_url):console.warn("Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got "+typeof n);return e}if("object"==typeof t&&null!==t){!function(e){if(Object.keys(e).length>0&&Ki("ENDPOINT"))throw new Eo}(t);const e=[];for(const[n,r]of Object.entries(t)){const t=n.replace(/\/$/,"");"string"==typeof r?e.push({apiUrl:t,apiKey:r}):console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${n}: expected string, got `+typeof r)}return e}return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got "+typeof t),[]}catch(e){if("object"==typeof(t=e)&&null!==t&&t.code===Io)throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS – must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}var t}(),!this.dotted_order){const{dottedOrder:e}=sc(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e}var o}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){const e=Date.now();return{run_type:"chain",project_name:Li(),child_runs:[],api_url:Ji("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Ji("LANGCHAIN_API_KEY"),caller_options:{},start_time:e,serialized:{},inputs:{},extra:{}}}static getSharedClient(){return ic.sharedClient||(ic.sharedClient=new qo),ic.sharedClient}createChild(e){const t=this.child_execution_order+1,n=this.replicas?.map(e=>{const{reroot:t,...n}=e;return n}),r=e.replicas??n,s=new ic({...e,parent_run:this,project_name:this.project_name,replicas:r,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});Ho in this&&(s[Ho]=this[Ho]);const a=Symbol.for("lc:child_config"),i=e.extra?.[a]??this.extra[a];if(function(e){const t=e?.callbacks;return null!=e&&"object"==typeof t&&(cc(t?.handlers)||cc(t))}(i)){const e={...i},t="object"==typeof(o=e.callbacks)&&null!=o&&Array.isArray(o.handlers)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:s.id}),t.handlers?.find(oc)?.updateFromRunTree?.(s),e.callbacks=t),s.extra[a]=e}var o;const c=new Set;let l=this;for(;null!=l&&!c.has(l.id);)c.add(l.id),l.child_execution_order=Math.max(l.child_execution_order,t),l=l.parent_run;return this.child_runs.push(s),s}async end(e,t,n=Date.now(),r){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??n,r&&Object.keys(r).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...r}}:{metadata:r})}_convertToCreate(e,t,n=!0){const r=e.extra??{};if(void 0===r?.runtime?.library&&(r.runtime||(r.runtime={}),t))for(const[e,n]of Object.entries(t))r.runtime[e]||(r.runtime[e]=n);let s,a;return n?(a=e.parent_run?.id??e.parent_run_id,s=[]):(s=e.child_runs.map(e=>this._convertToCreate(e,t,n)),a=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:r,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:s,parent_run_id:a,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_sliceParentId(e,t){if(t.dotted_order){const n=t.dotted_order.split(".");let r=null;for(let t=0;t<n.length;t++)if(n[t].slice(-36)===e){r=t;break}if(null!==r){const e=n.slice(r+1);t.dotted_order=e.join("."),e.length>0?t.trace_id=e[0].slice(-36):t.trace_id=t.id}}t.parent_run_id===e&&(t.parent_run_id=void 0)}_setReplicaTraceRoot(e,t){const n=Go(this,Wo)??{};n[e]=t,function(e,t,n){const r=Ho in e?e[Ho]:{};r[t]=n,e[Ho]=r}(this,Wo,n);for(const n of this.child_runs)n._setReplicaTraceRoot(e,t)}_remapForProject(e){const{projectName:t,runtimeEnv:n,excludeChildRuns:r=!0,reroot:s=!1,distributedParentId:a,apiUrl:i,apiKey:o,workspaceId:c}=e,l=this._convertToCreate(this,n,r);if(t===this.project_name)return{...l,session_name:t};if(s){if(a)this._sliceParentId(a,l);else if(l.parent_run_id=void 0,l.dotted_order){const e=l.dotted_order.split(".");e.length>0&&(l.dotted_order=e[e.length-1],l.trace_id=l.id)}const e=nc({projectName:t,apiUrl:i,apiKey:o,workspaceId:c});this._setReplicaTraceRoot(e,l.id)}let u;if(!s&&(u=(Go(this,Wo)??{})[nc({projectName:t,apiUrl:i,apiKey:o,workspaceId:c})],u&&(l.trace_id=u,l.dotted_order))){const e=l.dotted_order.split(".");let t=null;for(let n=0;n<e.length;n++)if(e[n].slice(-36)===u){t=n;break}if(null!==t){const n=e.slice(t);l.dotted_order=n.join(".")}}const d=l.id,p=ec(`${d}:${t}`,tc);let h,m,f;return h=l.trace_id?ec(`${l.trace_id}:${t}`,tc):p,l.parent_run_id&&(m=ec(`${l.parent_run_id}:${t}`,tc)),l.dotted_order&&(f=l.dotted_order.split(".").map(e=>{const n=e.slice(-36),r=ec(`${n}:${t}`,tc);return e.slice(0,-36)+r}).join(".")),{...l,id:p,trace_id:h,parent_run_id:m,dotted_order:f,session_name:t}}async postRun(e=!0){this._awaitInputsOnPost&&(this.inputs=await this.inputs);try{const t=Wi();if(this.replicas&&this.replicas.length>0)for(const{projectName:e,apiKey:n,apiUrl:r,workspaceId:s,reroot:a}of this.replicas){const i=this._remapForProject({projectName:e??this.project_name,runtimeEnv:t,excludeChildRuns:!0,reroot:a,distributedParentId:this.distributedParentId,apiUrl:r,apiKey:n,workspaceId:s});await this.client.createRun(i,{apiKey:n,apiUrl:r,workspaceId:s})}else{const n=this._convertToCreate(this,t,e);await this.client.createRun(n)}if(!e){zi("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}this.child_runs=[]}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(e){if(this.replicas&&this.replicas.length>0)for(const{projectName:t,apiKey:n,apiUrl:r,workspaceId:s,updates:a,reroot:i}of this.replicas){const o=this._remapForProject({projectName:t??this.project_name,runtimeEnv:void 0,excludeChildRuns:!0,reroot:i,distributedParentId:this.distributedParentId,apiUrl:r,apiKey:n,workspaceId:s}),c={id:o.id,name:o.name,run_type:o.run_type,start_time:o.start_time,outputs:o.outputs,error:o.error,parent_run_id:o.parent_run_id,session_name:o.session_name,reference_example_id:o.reference_example_id,end_time:o.end_time,dotted_order:o.dotted_order,trace_id:o.trace_id,events:o.events,tags:o.tags,extra:o.extra,attachments:this.attachments,...a};e?.excludeInputs||(c.inputs=o.inputs),await this.client.updateRun(o.id,c,{apiKey:n,apiUrl:r,workspaceId:s})}else try{const t={name:this.name,run_type:this.run_type,start_time:this._serialized_start_time??this.start_time,end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e?.excludeInputs||(t.inputs=this.inputs),await this.client.updateRun(this.id,t)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}this.child_runs=[]}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),"string"==typeof e?this.events.push({name:"event",time:(new Date).toISOString(),message:e}):this.events.push({...e,time:e.time??(new Date).toISOString()})}static fromRunnableConfig(e,t){const n=e?.callbacks;let r,s,a,i=!!["TRACING_V2","TRACING"].find(e=>"true"===Ki(e));if(n){const e=n?.getParentRunId?.()??"",t=n?.handlers?.find(e=>"langchain_tracer"==e?.name);r=t?.getRun?.(e),s=t?.projectName,a=t?.client,i=i||!!t}return r?new ic({name:r.name,id:r.id,trace_id:r.trace_id,dotted_order:r.dotted_order,client:a,tracingEnabled:i,project_name:s,tags:[...new Set((r?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...r?.extra?.metadata,...e?.metadata}}}).createChild(t):new ic({...t,client:a,tracingEnabled:i,project_name:s})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const n="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,r=n["langsmith-trace"];if(!r||"string"!=typeof r)return;const s=r.trim(),a=s.split(".").map(e=>{const[t,n]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:n}}),i=a[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:a.at(-1)?.uuid,trace_id:i,dotted_order:s};if(n.baggage&&"string"==typeof n.baggage){const e=ac.fromHeader(n.baggage);o.metadata=e.metadata,o.tags=e.tags,o.project_name=e.project_name,o.replicas=e.replicas}const c=new ic(o);return c.distributedParentId=c.id,c}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new ac(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[n,r]of Object.entries(t))e.set(n,r);return t}}function oc(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function cc(e){return Array.isArray(e)&&e.some(e=>oc(e))}function lc(e,t){if(e)return new ic({...e,start_time:e._serialized_start_time??e.start_time,parent_run:lc(t),child_runs:e.child_runs.map(e=>lc(e)).filter(e=>void 0!==e),extra:{...e.extra,runtime:ui()},tracingEnabled:!1})}function uc(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function dc(e){return"function"==typeof e._addRunToRunMap}Object.defineProperty(ic,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null}),Yr({},{BaseTracer:()=>pc,isBaseTracer:()=>dc});var pc=class extends Ti{runMap=new Map;runTreeMap=new Map;usesRunTreeMap=!1;constructor(e){super(...arguments)}copy(){return this}getRunById(e){if(void 0!==e)return this.usesRunTreeMap?(e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e})(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:n}=sc(new Date(e.start_time).getTime(),e.id,e.execution_order),r={...e},s=this.getRunById(r.parent_run_id);if(void 0!==r.parent_run_id?s?(this._addChildRun(s,r),s.child_execution_order=Math.max(s.child_execution_order,r.child_execution_order),r.trace_id=s.trace_id,void 0!==s.dotted_order&&(r.dotted_order=[s.dotted_order,t].join("."),r._serialized_start_time=n)):r.parent_run_id=void 0:(r.trace_id=r.id,r.dotted_order=t,r._serialized_start_time=n),this.usesRunTreeMap){const e=lc(r,s);void 0!==e&&this.runTreeMap.set(r.id,e)}else this.runMap.set(r.id,r);return r}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await(this.onRunUpdate?.(e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=void 0!==e&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,n,r,s,a,i,o){const c=this._getExecutionOrder(r),l=Date.now(),u=i?{...s,metadata:i}:s,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:a||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,n,r,s,a,i,o){const c=this.getRunById(n)??this._createRunForLLMStart(e,t,n,r,s,a,i,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}_createRunForChatModelStart(e,t,n,r,s,a,i,o){const c=this._getExecutionOrder(r),l=Date.now(),u=i?{...s,metadata:i}:s,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:a||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,n,r,s,a,i,o){const c=this.getRunById(n)??this._createRunForChatModelStart(e,t,n,r,s,a,i,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}async handleLLMEnd(e,t,n,r,s){const a=this.getRunById(t);if(!a||"llm"!==a?.run_type)throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.outputs=e,a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...s},await(this.onLLMEnd?.(a)),await this._endTrace(a),a}async handleLLMError(e,t,n,r,s){const a=this.getRunById(t);if(!a||"llm"!==a?.run_type)throw new Error("No LLM run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),a.extra={...a.extra,...s},await(this.onLLMError?.(a)),await this._endTrace(a),a}_createRunForChainStart(e,t,n,r,s,a,i,o,c){const l=this._getExecutionOrder(r),u=Date.now(),d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:i??"chain",child_runs:[],extra:a?{...c,metadata:a}:{...c},tags:s||[]};return this._addRunToRunMap(d)}async handleChainStart(e,t,n,r,s,a,i,o){const c=this.getRunById(n)??this._createRunForChainStart(e,t,n,r,s,a,i,o);return await(this.onRunCreate?.(c)),await(this.onChainStart?.(c)),c}async handleChainEnd(e,t,n,r,s){const a=this.getRunById(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=uc(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),void 0!==s?.inputs&&(a.inputs=uc(s.inputs,"input")),await(this.onChainEnd?.(a)),await this._endTrace(a),a}async handleChainError(e,t,n,r,s){const a=this.getRunById(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),void 0!==s?.inputs&&(a.inputs=uc(s.inputs,"input")),await(this.onChainError?.(a)),await this._endTrace(a),a}_createRunForToolStart(e,t,n,r,s,a,i){const o=this._getExecutionOrder(r),c=Date.now(),l={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,n,r,s,a,i){const o=this.getRunById(n)??this._createRunForToolStart(e,t,n,r,s,a,i);return await(this.onRunCreate?.(o)),await(this.onToolStart?.(o)),o}async handleToolEnd(e,t){const n=this.getRunById(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.getRunById(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.getRunById(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.getRunById(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}_createRunForRetrieverStart(e,t,n,r,s,a,i){const o=this._getExecutionOrder(r),c=Date.now(),l={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:s||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,n,r,s,a,i){const o=this.getRunById(n)??this._createRunForRetrieverStart(e,t,n,r,s,a,i);return await(this.onRunCreate?.(o)),await(this.onRetrieverStart?.(o)),o}async handleRetrieverEnd(e,t){const n=this.getRunById(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.getRunById(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.getRunById(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,s,a){const i=this.getRunById(n);if(!i||"llm"!==i?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return i.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:a?.chunk}}),await(this.onLLMNewToken?.(i,e,{chunk:a?.chunk})),i}},hc=n(4083);function mc(e,t){return`${e.open}${t}${e.close}`}function fc(e,t){try{return JSON.stringify(e,null,2)}catch{return t}}function gc(e){return"string"==typeof e?e.trim():null==e?e:fc(e,e.toString())}function yc(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}Yr({},{ConsoleCallbackHandler:()=>vc});const{color:_c}=hc;var vc=class extends pc{name="console_callback_handler";persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?mc(hc.bold,r):r}).join(" > ");return mc(_c.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.green,"[chain/start]")} [${t}] Entering Chain run with input: ${fc(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.cyan,"[chain/end]")} [${t}] [${yc(e)}] Exiting Chain run with output: ${fc(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.red,"[chain/error]")} [${t}] [${yc(e)}] Chain run errored with error: ${fc(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map(e=>e.trim())}:e.inputs;console.log(`${mc(_c.green,"[llm/start]")} [${t}] Entering LLM run with input: ${fc(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.cyan,"[llm/end]")} [${t}] [${yc(e)}] Exiting LLM run with output: ${fc(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.red,"[llm/error]")} [${t}] [${yc(e)}] LLM run errored with error: ${fc(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.green,"[tool/start]")} [${t}] Entering Tool run with input: "${gc(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.cyan,"[tool/end]")} [${t}] [${yc(e)}] Exiting Tool run with output: "${gc(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.red,"[tool/error]")} [${t}] [${yc(e)}] Tool run errored with error: ${fc(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${fc(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.cyan,"[retriever/end]")} [${t}] [${yc(e)}] Exiting Retriever run with output: ${fc(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${mc(_c.red,"[retriever/error]")} [${t}] [${yc(e)}] Retriever run errored with error: ${fc(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${mc(_c.blue,"[agent/action]")} [${n}] Agent selected action: ${fc(t.actions[t.actions.length-1],"[action]")}`)}};let wc;const bc=()=>{if(void 0===wc){const e="false"===di("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};wc=new qo(e)}return wc},xc=Symbol.for("ls:tracing_async_local_storage"),kc=new class{getStore(){}run(e,t){return t()}},Tc=new class{getInstance(){return globalThis[xc]??kc}initializeGlobalInstance(e){void 0===globalThis[xc]&&(globalThis[xc]=e)}};function Ic(e){return"function"==typeof e&&"langsmith:traceable"in e}Symbol.for("langsmith:traceable:root"),Yr({},{LangChainTracer:()=>Ec});var Ec=class e extends pc{name="langchain_tracer";projectName;exampleId;client;replicas;usesRunTreeMap=!0;constructor(t={}){super(t);const{exampleId:n,projectName:r,client:s,replicas:a}=t;this.projectName=r??Li(),this.replicas=a,this.exampleId=n,this.client=s??bc();const i=e.getTraceableRunTree();i&&this.updateFromRunTree(i)}async persistRun(e){}async onRunCreate(e){if(!e.extra?.lc_defers_inputs){const t=this.getRunTreeWithTracingConfig(e.id);await(t?.postRun())}}async onRunUpdate(e){const t=this.getRunTreeWithTracingConfig(e.id);e.extra?.lc_defers_inputs?await(t?.postRun()):await(t?.patchRun())}onLLMEnd(e){const t=e.outputs;if(t?.generations){const n=function(e){let t;for(const n of e)for(const e of n)Da.isInstance(e.message)&&void 0!==e.message.usage_metadata&&(t=ea(t,e.message.usage_metadata));return t}(t.generations);if(void 0!==n){e.extra=e.extra??{};const t=e.extra.metadata??{};t.usage_metadata=n,e.extra.metadata=t}}}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){this.runTreeMap.set(e.id,e);let t=e;const n=new Set;for(;t.parent_run&&!n.has(t.id)&&(n.add(t.id),t.parent_run);)t=t.parent_run;n.clear();const r=[t];for(;r.length>0;){const e=r.shift();e&&!n.has(e.id)&&(n.add(e.id),this.runTreeMap.set(e.id,e),e.child_runs&&r.push(...e.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){const t=this.runTreeMap.get(e);if(t)return new ic({...t,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return function(e=!1){const t=Tc.getInstance().getStore();if(!e&&void 0===t)throw new Error("Could not get the current run tree.\n\nPlease make sure you are calling this method within a traceable function and that tracing is enabled.");return t}(!0)}catch{return}}};let Oc;async function Sc(e,t){if(!0===t){const t=ni();void 0!==t?await t.run(void 0,async()=>e()):await e()}else void 0===Oc&&(Oc=new(0,fo.default)({autoStart:!0,concurrency:1})),Oc.add(async()=>{const t=ni();void 0!==t?await t.run(void 0,async()=>e()):await e()})}async function Ac(){const e=bc();await Promise.allSettled([void 0!==Oc?Oc.onIdle():Promise.resolve(),e.awaitPendingTraceBatches()])}function $c(e){const t=ni();if(void 0===t)return;const n=t.getStore();return n?.[ti]?.[e]}Yr({},{awaitAllCallbacks:()=>Ac,consumeCallback:()=>Sc});const Cc=Symbol("lc:configure_hooks");function Nc(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}Yr({},{BaseCallbackManager:()=>Pc,BaseRunManager:()=>Rc,CallbackManager:()=>Uc,CallbackManagerForChainRun:()=>Mc,CallbackManagerForLLMRun:()=>Lc,CallbackManagerForRetrieverRun:()=>jc,CallbackManagerForToolRun:()=>zc,ensureHandler:()=>Dc,parseCallbackConfigArg:()=>Nc});var Pc=class{setHandler(e){return this.setHandlers([e])}},Rc=class{constructor(e,t,n,r,s,a,i,o){this.runId=e,this.handlers=t,this.inheritableHandlers=n,this.tags=r,this.inheritableTags=s,this.metadata=a,this.inheritableMetadata=i,this._parentRunId=o}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>Sc(async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleCustomEvent(e,t,n,r,s){await Promise.all(this.handlers.map(n=>Sc(async()=>{try{await(n.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${e}`),n.raiseError)throw e}},n.awaitHandlers)))}},jc=class extends Rc{getChild(e){const t=new Uc(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(n){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}},t.awaitHandlers)))}},Lc=class extends Rc{async handleLLMNewToken(e,t,n,r,s,a){await Promise.all(this.handlers.map(n=>Sc(async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`),n.raiseError)throw e}},n.awaitHandlers)))}async handleLLMError(e,t,n,r,s){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleLLMEnd(e,t,n,r,s){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}},Mc=class extends Rc{getChild(e){const t=new Uc(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,s){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleChainEnd(e,t,n,r,s){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}},zc=class extends Rc{getChild(e){const t=new Uc(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>Sc(async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}},Uc=class e extends Pc{handlers=[];inheritableHandlers=[];tags=[];inheritableTags=[];metadata={};inheritableMetadata={};name="callback_manager";_parentRunId;constructor(e,t){super(),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,n=void 0,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0){return Promise.all(t.map(async(t,r)=>{const a=0===r&&n?n:bi();return await Promise.all(this.handlers.map(n=>{if(!n.ignoreLLM)return dc(n)&&n._createRunForLLMStart(e,[t],a,this._parentRunId,s,this.tags,this.metadata,o),Sc(async()=>{try{await(n.handleLLMStart?.(e,[t],a,this._parentRunId,s,this.tags,this.metadata,o))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`),n.raiseError)throw e}},n.awaitHandlers)})),new Lc(a,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,n=void 0,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0){return Promise.all(t.map(async(t,r)=>{const a=0===r&&n?n:bi();return await Promise.all(this.handlers.map(n=>{if(!n.ignoreLLM)return dc(n)&&n._createRunForChatModelStart(e,[t],a,this._parentRunId,s,this.tags,this.metadata,o),Sc(async()=>{try{if(n.handleChatModelStart)await(n.handleChatModelStart?.(e,[t],a,this._parentRunId,s,this.tags,this.metadata,o));else if(n.handleLLMStart){const r=Ga(t);await(n.handleLLMStart?.(e,[r],a,this._parentRunId,s,this.tags,this.metadata,o))}}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleLLMStart: ${e}`),n.raiseError)throw e}},n.awaitHandlers)})),new Lc(a,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,n=bi(),r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,c=void 0){return await Promise.all(this.handlers.map(s=>{if(!s.ignoreChain)return dc(s)&&s._createRunForChainStart(e,t,n,this._parentRunId,this.tags,this.metadata,r,i,c),Sc(async()=>{try{await(s.handleChainStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,r,i,c))}catch(e){if((s.raiseError?console.error:console.warn)(`Error in handler ${s.constructor.name}, handleChainStart: ${e}`),s.raiseError)throw e}},s.awaitHandlers)})),new Mc(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,n=bi(),r=void 0,s=void 0,a=void 0,i=void 0){return await Promise.all(this.handlers.map(r=>{if(!r.ignoreAgent)return dc(r)&&r._createRunForToolStart(e,t,n,this._parentRunId,this.tags,this.metadata,i),Sc(async()=>{try{await(r.handleToolStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,i))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleToolStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new zc(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,n=bi(),r=void 0,s=void 0,a=void 0,i=void 0){return await Promise.all(this.handlers.map(r=>{if(!r.ignoreRetriever)return dc(r)&&r._createRunForRetrieverStart(e,t,n,this._parentRunId,this.tags,this.metadata,i),Sc(async()=>{try{await(r.handleRetrieverStart?.(e,t,n,this._parentRunId,this.tags,this.metadata,i))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleRetrieverStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new jc(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,r,s){await Promise.all(this.handlers.map(r=>Sc(async()=>{if(!r.ignoreCustomEvent)try{await(r.handleCustomEvent?.(e,t,n,this.tags,this.metadata))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(t=[],n=!0){const r=new e(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const e of t)r.handlers.filter(e=>"console_callback_handler"===e.name).some(t=>t.name===e.name)||r.addHandler(e,n);return r}static fromHandlers(e){const t=new this;return t.addHandler(new class extends Ti{name=bi();constructor(){super(),Object.assign(this,e)}}),t}static configure(e,t,n,r,s,a,i){return this._configureSync(e,t,n,r,s,a,i)}static _configureSync(t,n,r,s,a,i,o){let c;(t||n)&&(Array.isArray(t)||!t?(c=new e,c.setHandlers(t?.map(Dc)??[],!0)):c=t,c=c.copy(Array.isArray(n)?n.map(Dc):n?.handlers,!1));const l="true"===di("LANGCHAIN_VERBOSE")||o?.verbose,u=Ec.getTraceableRunTree()?.tracingEnabled||!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(e=>"true"===di(e)),d=u||(di("LANGCHAIN_TRACING")??!1);if(l||d){if(c||(c=new e),l&&!c.handlers.some(e=>e.name===vc.prototype.name)){const e=new vc;c.addHandler(e,!0)}if(d&&!c.handlers.some(e=>"langchain_tracer"===e.name)&&u){const e=new Ec;c.addHandler(e,!0)}if(u){const e=Ec.getTraceableRunTree();if(e&&void 0===c._parentRunId){c._parentRunId=e.id;const t=c.handlers.find(e=>"langchain_tracer"===e.name);t?.updateFromRunTree(e)}}}for(const{contextVar:t,inheritable:n=!0,handlerClass:r,envVar:s}of $c(Cc)||[]){const a=s&&"true"===di(s)&&r;let i;const o=void 0!==t?$c(t):void 0;o&&Ii(o)?i=o:a&&(i=new r({})),void 0!==i&&(c||(c=new e),c.handlers.some(e=>e.name===i.name)||c.addHandler(i,n))}return(r||s)&&c&&(c.addTags(r??[]),c.addTags(s??[],!1)),(a||i)&&c&&(c.addMetadata(a??{}),c.addMetadata(i??{},!1)),c}};function Dc(e){return"name"in e?e:Ti.fromMethods(e)}var Fc=class{getStore(){}run(e,t){return t()}enterWith(e){}};const Bc=new Fc,Zc=Symbol.for("lc:child_config"),qc=new class{getInstance(){return ni()??Bc}getRunnableConfig(){const e=this.getInstance();return e.getStore()?.extra?.[Zc]}runWithConfig(e,t,n){const r=Uc._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),s=this.getInstance(),a=s.getStore(),i=r?.getParentRunId(),o=r?.handlers?.find(e=>"langchain_tracer"===e?.name);let c;return o&&i?c=o.getRunTreeWithTracingConfig(i):n||(c=new ic({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[Zc]:e}),void 0!==a&&void 0!==a[ti]&&(void 0===c&&(c={}),c[ti]=a[ti]),s.run(c,t)}initializeGlobalInstance(e){void 0===ni()&&(e=>{globalThis[ei]=e})(e)}};async function Vc(e){return Uc._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function Hc(...e){const t={};for(const n of e.filter(e=>!!e))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=n.timeout:void 0!==n.timeout&&(t.timeout=Math.min(t.timeout,n.timeout));else if("signal"===e)void 0===t.signal?t.signal=n.signal:void 0!==n.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,n.signal]):t.signal=n.signal);else if("callbacks"===e){const e=t.callbacks,r=n.callbacks;if(Array.isArray(r))if(e)if(Array.isArray(e))t.callbacks=e.concat(r);else{const n=e.copy();for(const e of r)n.addHandler(Dc(e),!0);t.callbacks=n}else t.callbacks=r;else if(r)if(e)if(Array.isArray(e)){const n=r.copy();for(const t of e)n.addHandler(Dc(t),!0);t.callbacks=n}else t.callbacks=new Uc(r._parentRunId,{handlers:e.handlers.concat(r.handlers),inheritableHandlers:e.inheritableHandlers.concat(r.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(r.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(r.inheritableTags))),metadata:{...e.metadata,...r.metadata}});else t.callbacks=r}else{const r=e;t[r]=n[r]??t[r]}return t}Yr({},{AsyncLocalStorageProviderSingleton:()=>qc,MockAsyncLocalStorage:()=>Fc,_CONTEXT_VARIABLES_KEY:()=>ti});const Wc=new Set(["string","number","boolean"]);function Gc(e){const t=qc.getRunnableConfig();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,runName:r,...s}=t;n=Object.entries(s).reduce((e,[t,n])=>(void 0!==n&&(e[t]=n),e),n)}if(e&&(n=Object.entries(e).reduce((e,[t,n])=>(void 0!==n&&(e[t]=n),e),n)),n?.configurable)for(const e of Object.keys(n.configurable))Wc.has(typeof n.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=n.configurable[e]);if(void 0!==n.timeout){if(n.timeout<=0)throw new Error("Timeout must be a positive number");const e=n.timeout,t=AbortSignal.timeout(e);n.metadata||(n.metadata={}),void 0===n.metadata.timeoutMs&&(n.metadata.timeoutMs=e),void 0!==n.signal?"any"in AbortSignal&&(n.signal=AbortSignal.any([n.signal,t])):n.signal=t,delete n.timeout}return n}function Jc(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:s,configurable:a,runId:i}={}){const o=Gc(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==s&&(o.runName=s),void 0!==a&&(o.configurable={...o.configurable,...a}),void 0!==i&&delete o.runId,o}function Kc(e){if(e)return{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal,store:e.store}}async function Xc(e,t){if(void 0===t)return e;let n;return Promise.race([e.catch(e=>{if(!t?.aborted)throw e}),new Promise((e,r)=>{n=()=>{r(Yc(t))},t.addEventListener("abort",n),t.aborted&&r(Yc(t))})]).finally(()=>t.removeEventListener("abort",n))}function Yc(e){return e?.reason instanceof Error?e.reason:"string"==typeof e?.reason?new Error(e.reason):new Error("Aborted")}Yr({},{AsyncGeneratorWithSetup:()=>nl,IterableReadableStream:()=>Qc,atee:()=>el,concat:()=>tl,pipeGeneratorWithSetup:()=>rl});var Qc=class e extends ReadableStream{reader;ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(t){const n=t.getReader();return new e({start:e=>function t(){return n.read().then(({done:n,value:r})=>{if(!n)return e.enqueue(r),t();e.close()})}(),cancel(){n.releaseLock()}})}static fromAsyncGenerator(t){return new e({async pull(e){const{value:n,done:r}=await t.next();r&&e.close(),e.enqueue(n)},async cancel(e){await t.return(e)}})}};function el(e,t=2){const n=Array.from({length:t},()=>[]);return n.map(async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}})}function tl(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=tl(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}var nl=class{generator;setup;config;signal;firstResult;firstResultUsed=!1;constructor(e){this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,n)=>{qc.runWithConfig(Kc(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then(e=>t(void 0),n)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?qc.runWithConfig(Kc(this.config),this.signal?async()=>Xc(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}};async function rl(e,t,n,r,...s){const a=new nl({generator:t,startSetup:n,signal:r}),i=await a.setup;return{output:e(a,i,...s),setup:i}}const sl=Object.prototype.hasOwnProperty;function al(e,t){return sl.call(e,t)}function il(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)al(e,n)&&t.push(n);return t}function ol(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function cl(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function ll(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function ul(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function dl(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(dl(e[t]))return!0}else if("object"==typeof e){const n=il(e),r=n.length;for(var t=0;t<r;t++)if(dl(e[n[t]]))return!0}return!1}function pl(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}var hl=class extends Error{constructor(e,t,n,r,s){super(pl(e,{name:t,index:n,operation:r,tree:s})),this.name=t,this.index=n,this.operation=r,this.tree=s,Object.setPrototypeOf(this,new.target.prototype),this.message=pl(e,{name:t,index:n,operation:r,tree:s})}};Yr({},{JsonPatchError:()=>ml,_areEquals:()=>Il,applyOperation:()=>wl,applyPatch:()=>bl,applyReducer:()=>xl,deepClone:()=>fl,getValueByPointer:()=>vl,validate:()=>Tl,validator:()=>kl});const ml=hl,fl=ol;function gl(e){return Object.getOwnPropertyNames(Object.prototype).includes(e)}const yl={add:function(e,t,n){if(gl(t))throw new TypeError("JSON-Patch: modifying `__proto__`, `constructor`, or `prototype` prop is banned for security reasons");return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){if(gl(t))throw new TypeError("JSON-Patch: modifying `__proto__`, `constructor`, or `prototype` prop is banned for security reasons");var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){if(gl(t))throw new TypeError("JSON-Patch: modifying `__proto__`, `constructor`, or `prototype` prop is banned for security reasons");var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=vl(n,this.path);r&&(r=ol(r));const s=wl(n,{op:"remove",path:this.from}).removed;return wl(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=vl(n,this.from);return wl(n,{op:"add",path:this.path,value:ol(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:Il(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var _l={add:function(e,t,n){return cl(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:yl.move,copy:yl.copy,test:yl.test,_get:yl._get};function vl(e,t){if(""==t)return e;var n={op:"_get",path:t};return wl(e,n),n.value}function wl(e,t,n=!1,r=!0,s=!0,a=0){if(n&&("function"==typeof n?n(t,0,e,t.path):kl(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=vl(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=Il(e,t.value),!1===r.test)throw new ml("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new ml("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,t,e);return r}{r||(e=ol(e));const i=(t.path||"").split("/");let o,c,l,u=e,d=1,p=i.length;for(l="function"==typeof n?n:kl;;){if(c=i[d],c&&-1!=c.indexOf("~")&&(c=ul(c)),s&&("__proto__"==c||"prototype"==c&&d>0&&"constructor"==i[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===o&&(void 0===u[c]?o=i.slice(0,d).join("/"):d==p-1&&(o=t.path),void 0!==o&&l(t,0,e,o)),d++,Array.isArray(u)){if("-"===c)c=u.length;else{if(n&&!cl(c))throw new ml("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,t,e);cl(c)&&(c=~~c)}if(d>=p){if(n&&"add"===t.op&&c>u.length)throw new ml("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,t,e);const r=_l[t.op].call(t,u,c,e);if(!1===r.test)throw new ml("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r}}else if(d>=p){const n=yl[t.op].call(t,u,c,e);if(!1===n.test)throw new ml("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return n}if(u=u[c],n&&d<p&&(!u||"object"!=typeof u))throw new ml("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,t,e)}}}function bl(e,t,n,r=!0,s=!0){if(n&&!Array.isArray(t))throw new ml("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=ol(e));const a=new Array(t.length);for(let r=0,i=t.length;r<i;r++)a[r]=wl(e,t[r],n,!0,s,r),e=a[r].newDocument;return a.newDocument=e,a}function xl(e,t,n){const r=wl(e,t);if(!1===r.test)throw new ml("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r.newDocument}function kl(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new ml("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!yl[e.op])throw new ml("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new ml("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new ml('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new ml("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new ml("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&dl(e.value))throw new ml("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var s=e.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new ml("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new ml("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var i=Tl([{op:"_get",path:e.from,value:void 0}],n);if(i&&"OPERATION_PATH_UNRESOLVABLE"===i.name)throw new ml("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function Tl(e,t,n){try{if(!Array.isArray(e))throw new ml("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)bl(ol(t),ol(e),n||!0);else{n=n||kl;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof ml)return e;throw e}}function Il(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,s,a=Array.isArray(e),i=Array.isArray(t);if(a&&i){if((r=e.length)!=t.length)return!1;for(n=r;0!==n--;)if(!Il(e[n],t[n]))return!1;return!0}if(a!=i)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!==n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!==n--;)if(!Il(e[s=o[n]],t[s]))return!1;return!0}return e!=e&&t!=t}function El(e,t,n,r,s){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var a=il(t),i=il(e),o=!1,c=i.length-1;c>=0;c--){var l=e[d=i[c]];if(!al(t,d)||void 0===t[d]&&void 0!==l&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(s&&n.push({op:"test",path:r+"/"+ll(d),value:ol(l)}),n.push({op:"remove",path:r+"/"+ll(d)}),o=!0):(s&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}));else{var u=t[d];"object"==typeof l&&null!=l&&"object"==typeof u&&null!=u&&Array.isArray(l)===Array.isArray(u)?El(l,u,n,r+"/"+ll(d),s):l!==u&&(s&&n.push({op:"test",path:r+"/"+ll(d),value:ol(l)}),n.push({op:"replace",path:r+"/"+ll(d),value:ol(u)}))}}if(o||a.length!=i.length)for(c=0;c<a.length;c++){var d;al(e,d=a[c])||void 0===t[d]||n.push({op:"add",path:r+"/"+ll(d),value:ol(t[d])})}}}function Ol(e,t,n=!1){var r=[];return El(e,t,r,"",n),r}Yr({},{LogStreamCallbackHandler:()=>Pl,RunLog:()=>Al,RunLogPatch:()=>Sl,isLogStreamHandler:()=>$l});var Sl=class{ops;constructor(e){this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=bl({},t);return new Al({ops:t,state:n[n.length-1].newDocument})}},Al=class e extends Sl{state;constructor(e){super(e),this.state=e.state}concat(t){const n=this.ops.concat(t.ops),r=bl(this.state,t.ops);return new e({ops:n,state:r[r.length-1].newDocument})}static fromRunLogPatch(t){const n=bl({},t.ops);return new e({ops:t.ops,state:n[n.length-1].newDocument})}};const $l=e=>"log_stream_tracer"===e.name;async function Cl(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function Nl(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}var Pl=class extends pc{autoClose=!0;includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;_schemaFormat="original";rootId;keyMapByRunId={};counterMapByRunName={};transformStream;writer;receiveStream;name="log_stream_tracer";lc_prefer_streaming=!0;constructor(e){super({_awaitHandler:!0,...e}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Qc.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every(e=>!this.excludeTags?.includes(e))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new Sl({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new Sl({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await Cl(e,this._schemaFormat)),await this.writer.write(new Sl({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await Cl(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await Nl(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new Sl({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new Sl({ops:[{op:"replace",path:"/final_output",value:await Nl(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let s;var a;void 0!==e.inputs.messages?(a=n?.chunk,s=void 0!==a&&void 0!==a.message?n?.chunk:new Za({id:`run-${e.id}`,content:t})):s=t;const i=new Sl({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:s}]});await this.writer.write(i)}};Yr({},{ChatGenerationChunk:()=>Ll,GenerationChunk:()=>jl,RUN_KEY:()=>Rl});const Rl="__run";var jl=class e{text;generationInfo;constructor(e){this.text=e.text,this.generationInfo=e.generationInfo}concat(t){return new e({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo}})}},Ll=class e extends jl{message;constructor(e){super(e),this.message=e.message}concat(t){return new e({text:this.text+t.text,generationInfo:{...this.generationInfo,...t.generationInfo},message:this.message.concat(t.message)})}};function Ml({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const zl=e=>"event_stream_tracer"===e.name;var Ul=class extends pc{autoClose=!0;includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;runInfoMap=new Map;tappedPromises=new Map;transformStream;writer;receiveStream;readableStreamClosed=!1;name="event_stream_tracer";lc_prefer_streaming=!0;constructor(e){super({_awaitHandler:!0,...e}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream({flush:()=>{this.readableStreamClosed=!0}}),this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Qc.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(n=n||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(n=n&&t.every(e=>!this.excludeTags?.includes(e))),n}async*tapOutputIterable(e,t){const n=await t.next();if(n.done)return;const r=this.runInfoMap.get(e);if(void 0===r)return void(yield n.value);function s(e,t){return"llm"===e&&"string"==typeof t?new jl({text:t}):t}let a=this.tappedPromises.get(e);if(void 0===a){let i;a=new Promise(e=>{i=e}),this.tappedPromises.set(e,a);try{const a={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...a,data:{chunk:s(r.runType,n.value)}},r),yield n.value;for await(const e of t)"tool"!==r.runType&&"retriever"!==r.runType&&await this.send({...a,data:{chunk:s(r.runType,e)}},r),yield e}finally{i?.()}}else{yield n.value;for await(const e of t)yield e}}async send(e,t){this.readableStreamClosed||this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const n=this.tappedPromises.get(e.run_id);void 0!==n?n.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){const t=Ml(e),n=void 0!==e.inputs.messages?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,r);const s=`on_${n}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,n){const r=this.runInfoMap.get(e.id);let s,a;if(void 0===r)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===r.runType)a="on_chat_model_stream",s=void 0===n?.chunk?new Za({content:t,id:`run-${e.id}`}):n.chunk.message;else{if("llm"!==r.runType)throw new Error(`Unexpected run type ${r.runType}`);a="on_llm_stream",s=void 0===n?.chunk?new jl({text:t}):n.chunk}await this.send({event:a,data:{chunk:s},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let n;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const r=e.outputs?.generations;let s;if("chat_model"===t.runType){for(const e of r??[]){if(void 0!==s)break;s=e[0]?.message}n="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);s={generations:r?.map(e=>e.map(e=>({text:e.text,generationInfo:e.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end"}await this.sendEndEvent({event:n,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=Ml(e),n=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let s={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(s={},r.inputs={}):void 0!==e.inputs.input?(s.input=e.inputs.input,r.inputs=e.inputs.input):(s.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${n}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},s={output:e.outputs?.output??e.outputs,input:r};r.input&&1===Object.keys(r).length&&(s.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:n,data:s,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=Ml(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=Ml(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){const r=this.runInfoMap.get(n);if(void 0===r)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:r.tags,metadata:r.metadata,data:t},r)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}};const Dl=Object.prototype.toString,Fl=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function Bl(e,t,{min:n=0,allowInfinity:r=!1}={}){if(void 0!==t){if("number"!=typeof t||Number.isNaN(t))throw new TypeError(`Expected \`${e}\` to be a number${r?" or Infinity":""}.`);if(!r&&!Number.isFinite(t))throw new TypeError(`Expected \`${e}\` to be a finite number.`);if(t<n)throw new TypeError(`Expected \`${e}\` to be ≥ ${n}.`)}}var Zl=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};function ql(e,t){return Number.isFinite(t)?t-(performance.now()-e):t}async function Vl({error:e,attemptNumber:t,retriesConsumed:n,startTime:r,options:s}){const a=e instanceof Error?e:new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(a instanceof Zl)throw a.originalError;const i=Number.isFinite(s.retries)?Math.max(0,s.retries-n):s.retries,o=s.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:a,attemptNumber:t,retriesLeft:i,retriesConsumed:n});if(await s.onFailedAttempt(c),ql(r,o)<=0)throw a;const l=await s.shouldConsumeRetry(c),u=ql(r,o);if(u<=0||i<=0)throw a;if(a instanceof TypeError&&!function(e){var t;if(!e||(t=e,"[object Error]"!==Dl.call(t))||"TypeError"!==e.name||"string"!=typeof e.message)return!1;const{message:n,stack:r}=e;return"Load failed"===n?void 0===r||"__sentry_captured__"in e:!!n.startsWith("error sending request for url")||Fl.has(n)}(a)){if(l)throw a;return s.signal?.throwIfAborted(),!1}if(!await s.shouldRetry(c))throw a;if(!l)return s.signal?.throwIfAborted(),!1;const d=function(e,t){const n=Math.max(1,e+1),r=t.randomize?Math.random()+1:1;let s=Math.round(r*t.minTimeout*t.factor**(n-1));return s=Math.min(s,t.maxTimeout),s}(n,s),p=Math.min(d,u);return p>0&&await new Promise((e,t)=>{const n=()=>{clearTimeout(r),s.signal?.removeEventListener("abort",n),t(s.signal.reason)},r=setTimeout(()=>{s.signal?.removeEventListener("abort",n),e()},p);s.unref&&r.unref?.(),s.signal?.addEventListener("abort",n,{once:!0})}),s.signal?.throwIfAborted(),!0}async function Hl(e,t={}){if(function(e){if("number"==typeof e){if(e<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(e))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(void 0!==e)throw new TypeError("Expected `retries` to be a number or Infinity.")}((t={...t}).retries),Object.hasOwn(t,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");t.retries??=10,t.factor??=2,t.minTimeout??=1e3,t.maxTimeout??=Number.POSITIVE_INFINITY,t.maxRetryTime??=Number.POSITIVE_INFINITY,t.randomize??=!1,t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.shouldConsumeRetry??=()=>!0,Bl("factor",t.factor,{min:0,allowInfinity:!1}),Bl("minTimeout",t.minTimeout,{min:0,allowInfinity:!1}),Bl("maxTimeout",t.maxTimeout,{min:0,allowInfinity:!0}),Bl("maxRetryTime",t.maxRetryTime,{min:0,allowInfinity:!0}),t.factor>0||(t.factor=1),t.signal?.throwIfAborted();let n=0,r=0;const s=performance.now();for(;!Number.isFinite(t.retries)||r<=t.retries;){n++;try{t.signal?.throwIfAborted();const r=await e(n);return t.signal?.throwIfAborted(),r}catch(e){await Vl({error:e,attemptNumber:n,retriesConsumed:r,startTime:s,options:t})&&r++}}throw new Error("Retry attempts exhausted without throwing an error.")}Yr({},{AsyncCaller:()=>Jl});const Wl=[400,401,402,403,404,405,406,407,409],Gl=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&Wl.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};var Jl=class{maxConcurrency;maxRetries;onFailedAttempt;queue;constructor(e){this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Gl;const t=fo.default;this.queue=new t({concurrency:this.maxConcurrency})}async call(e,...t){return this.queue.add(()=>Hl(()=>e(...t).catch(e=>{throw e instanceof Error?e:new Error(e)}),{onFailedAttempt:({error:e})=>this.onFailedAttempt?.(e),retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...n){if(e.signal){let r;return Promise.race([this.call(t,...n),new Promise((t,n)=>{r=()=>{n(Yc(e.signal))},e.signal?.addEventListener("abort",r)})]).finally(()=>{e.signal&&r&&e.signal.removeEventListener("abort",r)})}return this.call(t,...n)}fetch(...e){return this.call(()=>fetch(...e).then(e=>e.ok?e:Promise.reject(e)))}},Kl=class extends pc{name="RootListenersTracer";rootId;config;argOnStart;argOnEnd;argOnError;constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}};function Xl(e){return!!e&&e.lc_runnable}var Yl=class{includeNames;includeTypes;includeTags;excludeNames;excludeTypes;excludeTags;constructor(e){this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every(e=>!this.excludeTags?.includes(e))),n}};function Ql(e,t,n){function r(n,r){var s;Object.defineProperty(n,"_zod",{value:n._zod??{},enumerable:!1}),(s=n._zod).traits??(s.traits=new Set),n._zod.traits.add(e),t(n,r);for(const e in i.prototype)e in n||Object.defineProperty(n,e,{value:i.prototype[e].bind(n)});n._zod.constr=i,n._zod.def=r}const s=n?.Parent??Object;class a extends s{}function i(e){var t;const s=n?.Parent?new a:this;r(s,e),(t=s._zod).deferred??(t.deferred=[]);for(const e of s._zod.deferred)e();return s}return Object.defineProperty(a,"name",{value:e}),Object.defineProperty(i,"init",{value:r}),Object.defineProperty(i,Symbol.hasInstance,{value:t=>!!(n?.Parent&&t instanceof n.Parent)||t?._zod?.traits?.has(e)}),Object.defineProperty(i,"name",{value:e}),i}Object.freeze({status:"aborted"}),Symbol("zod_brand");class eu extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const tu={};function nu(e){return e&&Object.assign(tu,e),tu}function ru(e){const t=Object.values(e).filter(e=>"number"==typeof e);return Object.entries(e).filter(([e,n])=>-1===t.indexOf(+e)).map(([e,t])=>t)}function su(e,t){return"bigint"==typeof t?t.toString():t}function au(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function iu(e){return null==e}function ou(e){const t=e.startsWith("^")?1:0,n=e.endsWith("$")?e.length-1:e.length;return e.slice(t,n)}function cu(e,t,n){Object.defineProperty(e,t,{get(){{const r=n();return e[t]=r,r}},set(n){Object.defineProperty(e,t,{value:n})},configurable:!0})}function lu(e,t,n){Object.defineProperty(e,t,{value:n,writable:!0,enumerable:!0,configurable:!0})}function uu(e){return JSON.stringify(e)}const du=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{};function pu(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}const hu=au(()=>{if("undefined"!=typeof navigator&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{return new Function(""),!0}catch(e){return!1}});function mu(e){if(!1===pu(e))return!1;const t=e.constructor;if(void 0===t)return!0;const n=t.prototype;return!1!==pu(n)&&!1!==Object.prototype.hasOwnProperty.call(n,"isPrototypeOf")}const fu=new Set(["string","number","symbol"]);function gu(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function yu(e,t,n){const r=new e._zod.constr(t??e._zod.def);return t&&!n?.parent||(r._zod.parent=e),r}function _u(e){const t=e;if(!t)return{};if("string"==typeof t)return{error:()=>t};if(void 0!==t?.message){if(void 0!==t?.error)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,"string"==typeof t.error?{...t,error:()=>t.error}:t}new Set(["string","number","bigint","boolean","symbol","undefined"]);const vu={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]};function wu(e,t){if(!mu(t))throw new Error("Invalid input to extend: expected a plain object");const n={...e._zod.def,get shape(){const n={...e._zod.def.shape,...t};return lu(this,"shape",n),n},checks:[]};return yu(e,n)}function bu(e,t,n){const r=t._zod.def.shape,s={...r};if(n)for(const t in n){if(!(t in r))throw new Error(`Unrecognized key: "${t}"`);n[t]&&(s[t]=e?new e({type:"optional",innerType:r[t]}):r[t])}else for(const t in r)s[t]=e?new e({type:"optional",innerType:r[t]}):r[t];return yu(t,{...t._zod.def,shape:s,checks:[]})}function xu(e,t=0){for(let n=t;n<e.issues.length;n++)if(!0!==e.issues[n]?.continue)return!0;return!1}function ku(e,t){return t.map(t=>{var n;return(n=t).path??(n.path=[]),t.path.unshift(e),t})}function Tu(e){return"string"==typeof e?e:e?.message}function Iu(e,t,n){const r={...e,path:e.path??[]};if(!e.message){const s=Tu(e.inst?._zod.def?.error?.(e))??Tu(t?.error?.(e))??Tu(n.customError?.(e))??Tu(n.localeError?.(e))??"Invalid input";r.message=s}return delete r.inst,delete r.continue,t?.reportInput||delete r.input,r}function Eu(e){return Array.isArray(e)?"array":"string"==typeof e?"string":"unknown"}function Ou(...e){const[t,n,r]=e;return"string"==typeof t?{message:t,code:"custom",input:n,inst:r}:{...t}}const Su=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get:()=>JSON.stringify(t,su,2),enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},Au=Ql("$ZodError",Su),$u=Ql("$ZodError",Su,{Parent:Error});function Cu(e){const t=[];for(const n of e)"number"==typeof n?t.push(`[${n}]`):"symbol"==typeof n?t.push(`[${JSON.stringify(String(n))}]`):/[^\w$]/.test(n)?t.push(`[${JSON.stringify(n)}]`):(t.length&&t.push("."),t.push(n));return t.join("")}const Nu=e=>(t,n,r,s)=>{const a=r?Object.assign(r,{async:!1}):{async:!1},i=t._zod.run({value:n,issues:[]},a);if(i instanceof Promise)throw new eu;if(i.issues.length){const t=new(s?.Err??e)(i.issues.map(e=>Iu(e,a,nu())));throw du(t,s?.callee),t}return i.value},Pu=Nu($u),Ru=e=>async(t,n,r,s)=>{const a=r?Object.assign(r,{async:!0}):{async:!0};let i=t._zod.run({value:n,issues:[]},a);if(i instanceof Promise&&(i=await i),i.issues.length){const t=new(s?.Err??e)(i.issues.map(e=>Iu(e,a,nu())));throw du(t,s?.callee),t}return i.value},ju=Ru($u),Lu=e=>(t,n,r)=>{const s=r?{...r,async:!1}:{async:!1},a=t._zod.run({value:n,issues:[]},s);if(a instanceof Promise)throw new eu;return a.issues.length?{success:!1,error:new(e??Au)(a.issues.map(e=>Iu(e,s,nu())))}:{success:!0,data:a.value}},Mu=Lu($u),zu=e=>async(t,n,r)=>{const s=r?Object.assign(r,{async:!0}):{async:!0};let a=t._zod.run({value:n,issues:[]},s);return a instanceof Promise&&(a=await a),a.issues.length?{success:!1,error:new e(a.issues.map(e=>Iu(e,s,nu())))}:{success:!0,data:a.value}},Uu=zu($u);Symbol("ZodOutput"),Symbol("ZodInput");class Du{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const n=t[0];if(this._map.set(e,n),n&&"object"==typeof n&&"id"in n){if(this._idmap.has(n.id))throw new Error(`ID ${n.id} already exists in the registry`);this._idmap.set(n.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const n={...this.get(t)??{}};return delete n.id,{...n,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function Fu(){return new Du}const Bu=Fu(),Zu=/^[cC][^\s-]{8,}$/,qu=/^[0-9a-z]+$/,Vu=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,Hu=/^[0-9a-vA-V]{20}$/,Wu=/^[A-Za-z0-9]{27}$/,Gu=/^[a-zA-Z0-9_-]{21}$/,Ju=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,Ku=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,Xu=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000)$/,Yu=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,Qu=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ed=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})$/,td=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,nd=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,rd=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,sd=/^[A-Za-z0-9_-]*$/,ad=/^([a-zA-Z0-9-]+\.)*[a-zA-Z0-9-]+$/,id=/^\+(?:[0-9]){6,14}[0-9]$/,od="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",cd=new RegExp(`^${od}$`);function ld(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return"number"==typeof e.precision?-1===e.precision?`${t}`:0===e.precision?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}const ud=/^\d+$/,dd=/^-?\d+(?:\.\d+)?/i,pd=/^[^A-Z]*$/,hd=/^[^a-z]*$/,md=Ql("$ZodCheck",(e,t)=>{var n;e._zod??(e._zod={}),e._zod.def=t,(n=e._zod).onattach??(n.onattach=[])}),fd={number:"number",bigint:"bigint",object:"date"},gd=Ql("$ZodCheckLessThan",(e,t)=>{md.init(e,t);const n=fd[typeof t.value];e._zod.onattach.push(e=>{const n=e._zod.bag,r=(t.inclusive?n.maximum:n.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<r&&(t.inclusive?n.maximum=t.value:n.exclusiveMaximum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value<=t.value:r.value<t.value)||r.issues.push({origin:n,code:"too_big",maximum:t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),yd=Ql("$ZodCheckGreaterThan",(e,t)=>{md.init(e,t);const n=fd[typeof t.value];e._zod.onattach.push(e=>{const n=e._zod.bag,r=(t.inclusive?n.minimum:n.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>r&&(t.inclusive?n.minimum=t.value:n.exclusiveMinimum=t.value)}),e._zod.check=r=>{(t.inclusive?r.value>=t.value:r.value>t.value)||r.issues.push({origin:n,code:"too_small",minimum:t.value,input:r.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),_d=Ql("$ZodCheckMultipleOf",(e,t)=>{md.init(e,t),e._zod.onattach.push(e=>{var n;(n=e._zod.bag).multipleOf??(n.multipleOf=t.value)}),e._zod.check=n=>{if(typeof n.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");("bigint"==typeof n.value?n.value%t.value===BigInt(0):0===function(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,s=n>r?n:r;return Number.parseInt(e.toFixed(s).replace(".",""))%Number.parseInt(t.toFixed(s).replace(".",""))/10**s}(n.value,t.value))||n.issues.push({origin:typeof n.value,code:"not_multiple_of",divisor:t.value,input:n.value,inst:e,continue:!t.abort})}}),vd=Ql("$ZodCheckNumberFormat",(e,t)=>{md.init(e,t),t.format=t.format||"float64";const n=t.format?.includes("int"),r=n?"int":"number",[s,a]=vu[t.format];e._zod.onattach.push(e=>{const r=e._zod.bag;r.format=t.format,r.minimum=s,r.maximum=a,n&&(r.pattern=ud)}),e._zod.check=i=>{const o=i.value;if(n){if(!Number.isInteger(o))return void i.issues.push({expected:r,format:t.format,code:"invalid_type",input:o,inst:e});if(!Number.isSafeInteger(o))return void(o>0?i.issues.push({input:o,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,continue:!t.abort}):i.issues.push({input:o,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:r,continue:!t.abort}))}o<s&&i.issues.push({origin:"number",input:o,code:"too_small",minimum:s,inclusive:!0,inst:e,continue:!t.abort}),o>a&&i.issues.push({origin:"number",input:o,code:"too_big",maximum:a,inst:e})}}),wd=Ql("$ZodCheckMaxLength",(e,t)=>{var n;md.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!iu(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const n=e._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<n&&(e._zod.bag.maximum=t.maximum)}),e._zod.check=n=>{const r=n.value;if(r.length<=t.maximum)return;const s=Eu(r);n.issues.push({origin:s,code:"too_big",maximum:t.maximum,inclusive:!0,input:r,inst:e,continue:!t.abort})}}),bd=Ql("$ZodCheckMinLength",(e,t)=>{var n;md.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!iu(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const n=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>n&&(e._zod.bag.minimum=t.minimum)}),e._zod.check=n=>{const r=n.value;if(r.length>=t.minimum)return;const s=Eu(r);n.issues.push({origin:s,code:"too_small",minimum:t.minimum,inclusive:!0,input:r,inst:e,continue:!t.abort})}}),xd=Ql("$ZodCheckLengthEquals",(e,t)=>{var n;md.init(e,t),(n=e._zod.def).when??(n.when=e=>{const t=e.value;return!iu(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const n=e._zod.bag;n.minimum=t.length,n.maximum=t.length,n.length=t.length}),e._zod.check=n=>{const r=n.value,s=r.length;if(s===t.length)return;const a=Eu(r),i=s>t.length;n.issues.push({origin:a,...i?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:n.value,inst:e,continue:!t.abort})}}),kd=Ql("$ZodCheckStringFormat",(e,t)=>{var n,r;md.init(e,t),e._zod.onattach.push(e=>{const n=e._zod.bag;n.format=t.format,t.pattern&&(n.patterns??(n.patterns=new Set),n.patterns.add(t.pattern))}),t.pattern?(n=e._zod).check??(n.check=n=>{t.pattern.lastIndex=0,t.pattern.test(n.value)||n.issues.push({origin:"string",code:"invalid_format",format:t.format,input:n.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(r=e._zod).check??(r.check=()=>{})}),Td=Ql("$ZodCheckRegex",(e,t)=>{kd.init(e,t),e._zod.check=n=>{t.pattern.lastIndex=0,t.pattern.test(n.value)||n.issues.push({origin:"string",code:"invalid_format",format:"regex",input:n.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),Id=Ql("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=pd),kd.init(e,t)}),Ed=Ql("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=hd),kd.init(e,t)}),Od=Ql("$ZodCheckIncludes",(e,t)=>{md.init(e,t);const n=gu(t.includes),r=new RegExp("number"==typeof t.position?`^.{${t.position}}${n}`:n);t.pattern=r,e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(r)}),e._zod.check=n=>{n.value.includes(t.includes,t.position)||n.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:n.value,inst:e,continue:!t.abort})}}),Sd=Ql("$ZodCheckStartsWith",(e,t)=>{md.init(e,t);const n=new RegExp(`^${gu(t.prefix)}.*`);t.pattern??(t.pattern=n),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(n)}),e._zod.check=n=>{n.value.startsWith(t.prefix)||n.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:n.value,inst:e,continue:!t.abort})}}),Ad=Ql("$ZodCheckEndsWith",(e,t)=>{md.init(e,t);const n=new RegExp(`.*${gu(t.suffix)}$`);t.pattern??(t.pattern=n),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(n)}),e._zod.check=n=>{n.value.endsWith(t.suffix)||n.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:n.value,inst:e,continue:!t.abort})}}),$d=Ql("$ZodCheckOverwrite",(e,t)=>{md.init(e,t),e._zod.check=e=>{e.value=t.tx(e.value)}});class Cd{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if("function"==typeof e)return e(this,{execution:"sync"}),void e(this,{execution:"async"});const t=e.split("\n").filter(e=>e),n=Math.min(...t.map(e=>e.length-e.trimStart().length)),r=t.map(e=>e.slice(n)).map(e=>" ".repeat(2*this.indent)+e);for(const e of r)this.content.push(e)}compile(){const e=Function,t=this?.args;return new e(...t,[...(this?.content??[""]).map(e=>`  ${e}`)].join("\n"))}}const Nd={major:4,minor:0,patch:0},Pd=Ql("$ZodType",(e,t)=>{var n;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Nd;const r=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&r.unshift(e);for(const t of r)for(const n of t._zod.onattach)n(e);if(0===r.length)(n=e._zod).deferred??(n.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const t=(e,t,n)=>{let r,s=xu(e);for(const a of t){if(a._zod.def.when){if(!a._zod.def.when(e))continue}else if(s)continue;const t=e.issues.length,i=a._zod.check(e);if(i instanceof Promise&&!1===n?.async)throw new eu;if(r||i instanceof Promise)r=(r??Promise.resolve()).then(async()=>{await i,e.issues.length!==t&&(s||(s=xu(e,t)))});else{if(e.issues.length===t)continue;s||(s=xu(e,t))}}return r?r.then(()=>e):e};e._zod.run=(n,s)=>{const a=e._zod.parse(n,s);if(a instanceof Promise){if(!1===s.async)throw new eu;return a.then(e=>t(e,r,s))}return t(a,r,s)}}e["~standard"]={validate:t=>{try{const n=Mu(e,t);return n.success?{value:n.data}:{issues:n.error?.issues}}catch(n){return Uu(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),Rd=Ql("$ZodString",(e,t)=>{var n;Pd.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??(n=e._zod.bag,new RegExp(`^${n?`[\\s\\S]{${n?.minimum??0},${n?.maximum??""}}`:"[\\s\\S]*"}$`)),e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=String(n.value)}catch(r){}return"string"==typeof n.value||n.issues.push({expected:"string",code:"invalid_type",input:n.value,inst:e}),n}}),jd=Ql("$ZodStringFormat",(e,t)=>{kd.init(e,t),Rd.init(e,t)}),Ld=Ql("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=Ku),jd.init(e,t)}),Md=Ql("$ZodUUID",(e,t)=>{if(t.version){const e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(void 0===e)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=Xu(e))}else t.pattern??(t.pattern=Xu());jd.init(e,t)}),zd=Ql("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=Yu),jd.init(e,t)}),Ud=Ql("$ZodURL",(e,t)=>{jd.init(e,t),e._zod.check=n=>{try{const r=n.value,s=new URL(r),a=s.href;return t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(s.hostname)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:ad.source,input:n.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(s.protocol.endsWith(":")?s.protocol.slice(0,-1):s.protocol)||n.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:n.value,inst:e,continue:!t.abort})),void(!r.endsWith("/")&&a.endsWith("/")?n.value=a.slice(0,-1):n.value=a)}catch(r){n.issues.push({code:"invalid_format",format:"url",input:n.value,inst:e,continue:!t.abort})}}}),Dd=Ql("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),jd.init(e,t)}),Fd=Ql("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=Gu),jd.init(e,t)}),Bd=Ql("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=Zu),jd.init(e,t)}),Zd=Ql("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=qu),jd.init(e,t)}),qd=Ql("$ZodULID",(e,t)=>{t.pattern??(t.pattern=Vu),jd.init(e,t)}),Vd=Ql("$ZodXID",(e,t)=>{t.pattern??(t.pattern=Hu),jd.init(e,t)}),Hd=Ql("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=Wu),jd.init(e,t)}),Wd=Ql("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=function(e){const t=ld({precision:e.precision}),n=["Z"];e.local&&n.push(""),e.offset&&n.push("([+-]\\d{2}:\\d{2})");const r=`${t}(?:${n.join("|")})`;return new RegExp(`^${od}T(?:${r})$`)}(t)),jd.init(e,t)}),Gd=Ql("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=cd),jd.init(e,t)}),Jd=Ql("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=new RegExp(`^${ld(t)}$`)),jd.init(e,t)}),Kd=Ql("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=Ju),jd.init(e,t)}),Xd=Ql("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=Qu),jd.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv4"})}),Yd=Ql("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=ed),jd.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv6"}),e._zod.check=n=>{try{new URL(`http://[${n.value}]`)}catch{n.issues.push({code:"invalid_format",format:"ipv6",input:n.value,inst:e,continue:!t.abort})}}}),Qd=Ql("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=td),jd.init(e,t)}),ep=Ql("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=nd),jd.init(e,t),e._zod.check=n=>{const[r,s]=n.value.split("/");try{if(!s)throw new Error;const e=Number(s);if(`${e}`!==s)throw new Error;if(e<0||e>128)throw new Error;new URL(`http://[${r}]`)}catch{n.issues.push({code:"invalid_format",format:"cidrv6",input:n.value,inst:e,continue:!t.abort})}}});function tp(e){if(""===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}const np=Ql("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=rd),jd.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64"}),e._zod.check=n=>{tp(n.value)||n.issues.push({code:"invalid_format",format:"base64",input:n.value,inst:e,continue:!t.abort})}}),rp=Ql("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=sd),jd.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64url"}),e._zod.check=n=>{(function(e){if(!sd.test(e))return!1;const t=e.replace(/[-_]/g,e=>"-"===e?"+":"/");return tp(t.padEnd(4*Math.ceil(t.length/4),"="))})(n.value)||n.issues.push({code:"invalid_format",format:"base64url",input:n.value,inst:e,continue:!t.abort})}}),sp=Ql("$ZodE164",(e,t)=>{t.pattern??(t.pattern=id),jd.init(e,t)}),ap=Ql("$ZodJWT",(e,t)=>{jd.init(e,t),e._zod.check=n=>{(function(e,t=null){try{const n=e.split(".");if(3!==n.length)return!1;const[r]=n;if(!r)return!1;const s=JSON.parse(atob(r));return!("typ"in s&&"JWT"!==s?.typ||!s.alg||t&&(!("alg"in s)||s.alg!==t))}catch{return!1}})(n.value,t.alg)||n.issues.push({code:"invalid_format",format:"jwt",input:n.value,inst:e,continue:!t.abort})}}),ip=Ql("$ZodNumber",(e,t)=>{Pd.init(e,t),e._zod.pattern=e._zod.bag.pattern??dd,e._zod.parse=(n,r)=>{if(t.coerce)try{n.value=Number(n.value)}catch(e){}const s=n.value;if("number"==typeof s&&!Number.isNaN(s)&&Number.isFinite(s))return n;const a="number"==typeof s?Number.isNaN(s)?"NaN":Number.isFinite(s)?void 0:"Infinity":void 0;return n.issues.push({expected:"number",code:"invalid_type",input:s,inst:e,...a?{received:a}:{}}),n}}),op=Ql("$ZodNumber",(e,t)=>{vd.init(e,t),ip.init(e,t)}),cp=Ql("$ZodUnknown",(e,t)=>{Pd.init(e,t),e._zod.parse=e=>e}),lp=Ql("$ZodNever",(e,t)=>{Pd.init(e,t),e._zod.parse=(t,n)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)});function up(e,t,n){e.issues.length&&t.issues.push(...ku(n,e.issues)),t.value[n]=e.value}const dp=Ql("$ZodArray",(e,t)=>{Pd.init(e,t),e._zod.parse=(n,r)=>{const s=n.value;if(!Array.isArray(s))return n.issues.push({expected:"array",code:"invalid_type",input:s,inst:e}),n;n.value=Array(s.length);const a=[];for(let e=0;e<s.length;e++){const i=s[e],o=t.element._zod.run({value:i,issues:[]},r);o instanceof Promise?a.push(o.then(t=>up(t,n,e))):up(o,n,e)}return a.length?Promise.all(a).then(()=>n):n}});function pp(e,t,n){e.issues.length&&t.issues.push(...ku(n,e.issues)),t.value[n]=e.value}function hp(e,t,n,r){e.issues.length?void 0===r[n]?t.value[n]=n in r?void 0:e.value:t.issues.push(...ku(n,e.issues)):void 0===e.value?n in r&&(t.value[n]=void 0):t.value[n]=e.value}const mp=Ql("$ZodObject",(e,t)=>{Pd.init(e,t);const n=au(()=>{const e=Object.keys(t.shape);for(const n of e)if(!(t.shape[n]instanceof Pd))throw new Error(`Invalid element at key "${n}": expected a Zod schema`);const n=(r=t.shape,Object.keys(r).filter(e=>"optional"===r[e]._zod.optin&&"optional"===r[e]._zod.optout));var r;return{shape:t.shape,keys:e,keySet:new Set(e),numKeys:e.length,optionalKeys:new Set(n)}});let r;cu(e._zod,"propValues",()=>{const e=t.shape,n={};for(const t in e){const r=e[t]._zod;if(r.values){n[t]??(n[t]=new Set);for(const e of r.values)n[t].add(e)}}return n});const s=pu,a=!tu.jitless,i=a&&hu.value,o=t.catchall;let c;e._zod.parse=(l,u)=>{c??(c=n.value);const d=l.value;if(!s(d))return l.issues.push({expected:"object",code:"invalid_type",input:d,inst:e}),l;const p=[];if(a&&i&&!1===u?.async&&!0!==u.jitless)r||(r=(e=>{const t=new Cd(["shape","payload","ctx"]),r=n.value,s=e=>{const t=uu(e);return`shape[${t}]._zod.run({ value: input[${t}], issues: [] }, ctx)`};t.write("const input = payload.value;");const a=Object.create(null);let i=0;for(const e of r.keys)a[e]="key_"+i++;t.write("const newResult = {}");for(const e of r.keys)if(r.optionalKeys.has(e)){const n=a[e];t.write(`const ${n} = ${s(e)};`);const r=uu(e);t.write(`\n        if (${n}.issues.length) {\n          if (input[${r}] === undefined) {\n            if (${r} in input) {\n              newResult[${r}] = undefined;\n            }\n          } else {\n            payload.issues = payload.issues.concat(\n              ${n}.issues.map((iss) => ({\n                ...iss,\n                path: iss.path ? [${r}, ...iss.path] : [${r}],\n              }))\n            );\n          }\n        } else if (${n}.value === undefined) {\n          if (${r} in input) newResult[${r}] = undefined;\n        } else {\n          newResult[${r}] = ${n}.value;\n        }\n        `)}else{const n=a[e];t.write(`const ${n} = ${s(e)};`),t.write(`\n          if (${n}.issues.length) payload.issues = payload.issues.concat(${n}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${uu(e)}, ...iss.path] : [${uu(e)}]\n          })));`),t.write(`newResult[${uu(e)}] = ${n}.value`)}t.write("payload.value = newResult;"),t.write("return payload;");const o=t.compile();return(t,n)=>o(e,t,n)})(t.shape)),l=r(l,u);else{l.value={};const e=c.shape;for(const t of c.keys){const n=e[t],r=n._zod.run({value:d[t],issues:[]},u),s="optional"===n._zod.optin&&"optional"===n._zod.optout;r instanceof Promise?p.push(r.then(e=>s?hp(e,l,t,d):pp(e,l,t))):s?hp(r,l,t,d):pp(r,l,t)}}if(!o)return p.length?Promise.all(p).then(()=>l):l;const h=[],m=c.keySet,f=o._zod,g=f.def.type;for(const e of Object.keys(d)){if(m.has(e))continue;if("never"===g){h.push(e);continue}const t=f.run({value:d[e],issues:[]},u);t instanceof Promise?p.push(t.then(t=>pp(t,l,e))):pp(t,l,e)}return h.length&&l.issues.push({code:"unrecognized_keys",keys:h,input:d,inst:e}),p.length?Promise.all(p).then(()=>l):l}});function fp(e,t,n,r){for(const n of e)if(0===n.issues.length)return t.value=n.value,t;return t.issues.push({code:"invalid_union",input:t.value,inst:n,errors:e.map(e=>e.issues.map(e=>Iu(e,r,nu())))}),t}const gp=Ql("$ZodUnion",(e,t)=>{Pd.init(e,t),cu(e._zod,"optin",()=>t.options.some(e=>"optional"===e._zod.optin)?"optional":void 0),cu(e._zod,"optout",()=>t.options.some(e=>"optional"===e._zod.optout)?"optional":void 0),cu(e._zod,"values",()=>{if(t.options.every(e=>e._zod.values))return new Set(t.options.flatMap(e=>Array.from(e._zod.values)))}),cu(e._zod,"pattern",()=>{if(t.options.every(e=>e._zod.pattern)){const e=t.options.map(e=>e._zod.pattern);return new RegExp(`^(${e.map(e=>ou(e.source)).join("|")})$`)}}),e._zod.parse=(n,r)=>{let s=!1;const a=[];for(const e of t.options){const t=e._zod.run({value:n.value,issues:[]},r);if(t instanceof Promise)a.push(t),s=!0;else{if(0===t.issues.length)return t;a.push(t)}}return s?Promise.all(a).then(t=>fp(t,n,e,r)):fp(a,n,e,r)}}),yp=Ql("$ZodDiscriminatedUnion",(e,t)=>{gp.init(e,t);const n=e._zod.parse;cu(e._zod,"propValues",()=>{const e={};for(const n of t.options){const r=n._zod.propValues;if(!r||0===Object.keys(r).length)throw new Error(`Invalid discriminated union option at index "${t.options.indexOf(n)}"`);for(const[t,n]of Object.entries(r)){e[t]||(e[t]=new Set);for(const r of n)e[t].add(r)}}return e});const r=au(()=>{const e=t.options,n=new Map;for(const r of e){const e=r._zod.propValues[t.discriminator];if(!e||0===e.size)throw new Error(`Invalid discriminated union option at index "${t.options.indexOf(r)}"`);for(const t of e){if(n.has(t))throw new Error(`Duplicate discriminator value "${String(t)}"`);n.set(t,r)}}return n});e._zod.parse=(s,a)=>{const i=s.value;if(!pu(i))return s.issues.push({code:"invalid_type",expected:"object",input:i,inst:e}),s;const o=r.value.get(i?.[t.discriminator]);return o?o._zod.run(s,a):t.unionFallback?n(s,a):(s.issues.push({code:"invalid_union",errors:[],note:"No matching discriminator",input:i,path:[t.discriminator],inst:e}),s)}}),_p=Ql("$ZodIntersection",(e,t)=>{Pd.init(e,t),e._zod.parse=(e,n)=>{const r=e.value,s=t.left._zod.run({value:r,issues:[]},n),a=t.right._zod.run({value:r,issues:[]},n);return s instanceof Promise||a instanceof Promise?Promise.all([s,a]).then(([t,n])=>wp(e,t,n)):wp(e,s,a)}});function vp(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e===+t)return{valid:!0,data:e};if(mu(e)&&mu(t)){const n=Object.keys(t),r=Object.keys(e).filter(e=>-1!==n.indexOf(e)),s={...e,...t};for(const n of r){const r=vp(e[n],t[n]);if(!r.valid)return{valid:!1,mergeErrorPath:[n,...r.mergeErrorPath]};s[n]=r.data}return{valid:!0,data:s}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const n=[];for(let r=0;r<e.length;r++){const s=vp(e[r],t[r]);if(!s.valid)return{valid:!1,mergeErrorPath:[r,...s.mergeErrorPath]};n.push(s.data)}return{valid:!0,data:n}}return{valid:!1,mergeErrorPath:[]}}function wp(e,t,n){if(t.issues.length&&e.issues.push(...t.issues),n.issues.length&&e.issues.push(...n.issues),xu(e))return e;const r=vp(t.value,n.value);if(!r.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(r.mergeErrorPath)}`);return e.value=r.data,e}const bp=Ql("$ZodRecord",(e,t)=>{Pd.init(e,t),e._zod.parse=(n,r)=>{const s=n.value;if(!mu(s))return n.issues.push({expected:"record",code:"invalid_type",input:s,inst:e}),n;const a=[];if(t.keyType._zod.values){const i=t.keyType._zod.values;n.value={};for(const e of i)if("string"==typeof e||"number"==typeof e||"symbol"==typeof e){const i=t.valueType._zod.run({value:s[e],issues:[]},r);i instanceof Promise?a.push(i.then(t=>{t.issues.length&&n.issues.push(...ku(e,t.issues)),n.value[e]=t.value})):(i.issues.length&&n.issues.push(...ku(e,i.issues)),n.value[e]=i.value)}let o;for(const e in s)i.has(e)||(o=o??[],o.push(e));o&&o.length>0&&n.issues.push({code:"unrecognized_keys",input:s,inst:e,keys:o})}else{n.value={};for(const i of Reflect.ownKeys(s)){if("__proto__"===i)continue;const o=t.keyType._zod.run({value:i,issues:[]},r);if(o instanceof Promise)throw new Error("Async schemas not supported in object keys currently");if(o.issues.length){n.issues.push({origin:"record",code:"invalid_key",issues:o.issues.map(e=>Iu(e,r,nu())),input:i,path:[i],inst:e}),n.value[o.value]=o.value;continue}const c=t.valueType._zod.run({value:s[i],issues:[]},r);c instanceof Promise?a.push(c.then(e=>{e.issues.length&&n.issues.push(...ku(i,e.issues)),n.value[o.value]=e.value})):(c.issues.length&&n.issues.push(...ku(i,c.issues)),n.value[o.value]=c.value)}}return a.length?Promise.all(a).then(()=>n):n}}),xp=Ql("$ZodEnum",(e,t)=>{Pd.init(e,t);const n=ru(t.entries);e._zod.values=new Set(n),e._zod.pattern=new RegExp(`^(${n.filter(e=>fu.has(typeof e)).map(e=>"string"==typeof e?gu(e):e.toString()).join("|")})$`),e._zod.parse=(t,r)=>{const s=t.value;return e._zod.values.has(s)||t.issues.push({code:"invalid_value",values:n,input:s,inst:e}),t}}),kp=Ql("$ZodLiteral",(e,t)=>{Pd.init(e,t),e._zod.values=new Set(t.values),e._zod.pattern=new RegExp(`^(${t.values.map(e=>"string"==typeof e?gu(e):e?e.toString():String(e)).join("|")})$`),e._zod.parse=(n,r)=>{const s=n.value;return e._zod.values.has(s)||n.issues.push({code:"invalid_value",values:t.values,input:s,inst:e}),n}}),Tp=Ql("$ZodTransform",(e,t)=>{Pd.init(e,t),e._zod.parse=(e,n)=>{const r=t.transform(e.value,e);if(n.async)return(r instanceof Promise?r:Promise.resolve(r)).then(t=>(e.value=t,e));if(r instanceof Promise)throw new eu;return e.value=r,e}}),Ip=Ql("$ZodOptional",(e,t)=>{Pd.init(e,t),e._zod.optin="optional",e._zod.optout="optional",cu(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),cu(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${ou(e.source)})?$`):void 0}),e._zod.parse=(e,n)=>"optional"===t.innerType._zod.optin?t.innerType._zod.run(e,n):void 0===e.value?e:t.innerType._zod.run(e,n)}),Ep=Ql("$ZodNullable",(e,t)=>{Pd.init(e,t),cu(e._zod,"optin",()=>t.innerType._zod.optin),cu(e._zod,"optout",()=>t.innerType._zod.optout),cu(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${ou(e.source)}|null)$`):void 0}),cu(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(e,n)=>null===e.value?e:t.innerType._zod.run(e,n)}),Op=Ql("$ZodDefault",(e,t)=>{Pd.init(e,t),e._zod.optin="optional",cu(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,n)=>{if(void 0===e.value)return e.value=t.defaultValue,e;const r=t.innerType._zod.run(e,n);return r instanceof Promise?r.then(e=>Sp(e,t)):Sp(r,t)}});function Sp(e,t){return void 0===e.value&&(e.value=t.defaultValue),e}const Ap=Ql("$ZodPrefault",(e,t)=>{Pd.init(e,t),e._zod.optin="optional",cu(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,n)=>(void 0===e.value&&(e.value=t.defaultValue),t.innerType._zod.run(e,n))}),$p=Ql("$ZodNonOptional",(e,t)=>{Pd.init(e,t),cu(e._zod,"values",()=>{const e=t.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(n,r)=>{const s=t.innerType._zod.run(n,r);return s instanceof Promise?s.then(t=>Cp(t,e)):Cp(s,e)}});function Cp(e,t){return e.issues.length||void 0!==e.value||e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const Np=Ql("$ZodCatch",(e,t)=>{Pd.init(e,t),e._zod.optin="optional",cu(e._zod,"optout",()=>t.innerType._zod.optout),cu(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,n)=>{const r=t.innerType._zod.run(e,n);return r instanceof Promise?r.then(r=>(e.value=r.value,r.issues.length&&(e.value=t.catchValue({...e,error:{issues:r.issues.map(e=>Iu(e,n,nu()))},input:e.value}),e.issues=[]),e)):(e.value=r.value,r.issues.length&&(e.value=t.catchValue({...e,error:{issues:r.issues.map(e=>Iu(e,n,nu()))},input:e.value}),e.issues=[]),e)}}),Pp=Ql("$ZodPipe",(e,t)=>{Pd.init(e,t),cu(e._zod,"values",()=>t.in._zod.values),cu(e._zod,"optin",()=>t.in._zod.optin),cu(e._zod,"optout",()=>t.out._zod.optout),e._zod.parse=(e,n)=>{const r=t.in._zod.run(e,n);return r instanceof Promise?r.then(e=>Rp(e,t,n)):Rp(r,t,n)}});function Rp(e,t,n){return xu(e)?e:t.out._zod.run({value:e.value,issues:e.issues},n)}const jp=Ql("$ZodReadonly",(e,t)=>{Pd.init(e,t),cu(e._zod,"propValues",()=>t.innerType._zod.propValues),cu(e._zod,"values",()=>t.innerType._zod.values),cu(e._zod,"optin",()=>t.innerType._zod.optin),cu(e._zod,"optout",()=>t.innerType._zod.optout),e._zod.parse=(e,n)=>{const r=t.innerType._zod.run(e,n);return r instanceof Promise?r.then(Lp):Lp(r)}});function Lp(e){return e.value=Object.freeze(e.value),e}const Mp=Ql("$ZodCustom",(e,t)=>{md.init(e,t),Pd.init(e,t),e._zod.parse=(e,t)=>e,e._zod.check=n=>{const r=n.value,s=t.fn(r);if(s instanceof Promise)return s.then(t=>zp(t,n,r,e));zp(s,n,r,e)}});function zp(e,t,n,r){if(!e){const e={code:"custom",input:n,inst:r,path:[...r._zod.def.path??[]],continue:!r._zod.def.abort};r._zod.def.params&&(e.params=r._zod.def.params),t.issues.push(Ou(e))}}function Up(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,..._u(t)})}function Dp(e){return new e({type:"unknown"})}function Fp(e,t){return new e({type:"never",..._u(t)})}function Bp(e,t){return new gd({check:"less_than",..._u(t),value:e,inclusive:!1})}function Zp(e,t){return new gd({check:"less_than",..._u(t),value:e,inclusive:!0})}function qp(e,t){return new yd({check:"greater_than",..._u(t),value:e,inclusive:!1})}function Vp(e,t){return new yd({check:"greater_than",..._u(t),value:e,inclusive:!0})}function Hp(e,t){return new _d({check:"multiple_of",..._u(t),value:e})}function Wp(e,t){return new wd({check:"max_length",..._u(t),maximum:e})}function Gp(e,t){return new bd({check:"min_length",..._u(t),minimum:e})}function Jp(e,t){return new xd({check:"length_equals",..._u(t),length:e})}function Kp(e){return new $d({check:"overwrite",tx:e})}function Xp(e){if("object"!=typeof e||null===e)return!1;if(!("_zod"in e))return!1;const t=e._zod;return"object"==typeof t&&null!==t&&"def"in t}function Yp(e){if("object"!=typeof e||null===e)return!1;if(!("_def"in e)||"_zod"in e)return!1;const t=e._def;return"object"==typeof t&&null!=t&&"typeName"in t}function Qp(e){return Xp(e)&&console.warn("[WARNING] Attempting to use Zod 4 schema in a context where Zod 3 schema is expected. This may cause unexpected behavior."),Yp(e)}function eh(e){return!(!e||"object"!=typeof e||Array.isArray(e)||!Xp(e)&&!Yp(e))}function th(e){return"object"==typeof e&&null!==e&&"_def"in e&&"object"==typeof e._def&&null!==e._def&&"typeName"in e._def&&"ZodLiteral"===e._def.typeName}function nh(e){return!!Xp(e)&&"object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"literal"===e._zod.def.type}function rh(e){return!!th(e)||!!nh(e)}async function sh(e,t){if(Xp(e))try{return{success:!0,data:await ju(e,t)}}catch(e){return{success:!1,error:e}}if(Yp(e))return await e.safeParseAsync(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function ah(e,t){if(Xp(e))return await ju(e,t);if(Yp(e))return await e.parseAsync(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function ih(e,t){if(Xp(e))try{return{success:!0,data:Pu(e,t)}}catch(e){return{success:!1,error:e}}if(Yp(e))return e.safeParse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function oh(e,t){if(Xp(e))return Pu(e,t);if(Yp(e))return e.parse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function ch(e){return Xp(e)?Bu.get(e)?.description:Yp(e)||"description"in e&&"string"==typeof e.description?e.description:void 0}function lh(e){if(!eh(e))return!1;if(Yp(e)){const t=e._def;if("ZodObject"===t.typeName){const t=e;return!t.shape||0===Object.keys(t.shape).length}if("ZodRecord"===t.typeName)return!0}if(Xp(e)){const t=e._zod.def;if("object"===t.type){const t=e;return!t.shape||0===Object.keys(t.shape).length}if("record"===t.type)return!0}return"object"==typeof e&&null!==e&&!("shape"in e)}function uh(e){return!!eh(e)&&(Yp(e)?"ZodString"===e._def.typeName:!!Xp(e)&&"string"===e._zod.def.type)}function dh(e){return"object"==typeof e&&null!==e&&"_def"in e&&"object"==typeof e._def&&null!==e._def&&"typeName"in e._def&&"ZodObject"===e._def.typeName}function ph(e){return!!Xp(e)&&"object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"object"===e._zod.def.type}function hh(e){return!!Xp(e)&&"object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"array"===e._zod.def.type}function mh(e){return!!Xp(e)&&"object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"optional"===e._zod.def.type}function fh(e){return!!Xp(e)&&"object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"nullable"===e._zod.def.type}function gh(e){return!!dh(e)||!!ph(e)}function yh(e){if(Yp(e))return e.shape;if(Xp(e))return e._zod.def.shape;throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function _h(e,t){if(Yp(e))return e.extend(t);if(Xp(e))return wu(e,t);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function vh(e){if(Yp(e))return e.partial();if(Xp(e))return bu(Ip,e,void 0);throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function wh(e,t=!1){if(Yp(e))return e.strict();if(ph(e)){const n=e._zod.def.shape;if(t)for(const[r,s]of Object.entries(e._zod.def.shape)){if(ph(s)){const e=wh(s,t);n[r]=e}else if(hh(s)){let e=s._zod.def.element;ph(e)&&(e=wh(e,t)),n[r]=yu(s,{...s._zod.def,element:e})}else n[r]=s;const e=Bu.get(s);e&&Bu.add(n[r],e)}const r=yu(e,{...e._zod.def,shape:n,catchall:Fp(lp)}),s=Bu.get(e);return s&&Bu.add(r,s),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function bh(e,t=!1){if(dh(e))return e.passthrough();if(ph(e)){const n=e._zod.def.shape;if(t)for(const[r,s]of Object.entries(e._zod.def.shape)){if(ph(s)){const e=bh(s,t);n[r]=e}else if(hh(s)){let e=s._zod.def.element;ph(e)&&(e=bh(e,t)),n[r]=yu(s,{...s._zod.def,element:e})}else n[r]=s;const e=Bu.get(s);e&&Bu.add(n[r],e)}const r=yu(e,{...e._zod.def,shape:n,catchall:Dp(cp)}),s=Bu.get(e);return s&&Bu.add(r,s),r}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function xh(e){if(Yp(e))try{const t=e.parse(void 0);return()=>t}catch{return}if(Xp(e))try{const t=Pu(e,void 0);return()=>t}catch{return}}function kh(e,t,n){const r=n.get(e);if(void 0!==r)return r;if(Yp(e))return function(e){return Yp(e)&&"typeName"in e._def&&"ZodEffects"===e._def.typeName}(e)?kh(e._def.schema,t,n):e;if(Xp(e)){let r=e;if(function(e){return Xp(e)&&"pipe"===e._zod.def.type}(e)&&(r=kh(e._zod.def.in,t,n)),t)if(ph(r)){const e={};for(const[s,a]of Object.entries(r._zod.def.shape))e[s]=kh(a,t,n);r=yu(r,{...r._zod.def,shape:e})}else if(hh(r)){const e=kh(r._zod.def.element,t,n);r=yu(r,{...r._zod.def,element:e})}else if(mh(r)){const e=kh(r._zod.def.innerType,t,n);r=yu(r,{...r._zod.def,innerType:e})}else if(fh(r)){const e=kh(r._zod.def.innerType,t,n);r=yu(r,{...r._zod.def,innerType:e})}const s=Bu.get(e);return s&&Bu.add(r,s),n.set(e,r),r}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Th(e,t=!1){return kh(e,t,new WeakMap)}function Ih(e,t){if(Yp(e)){const n=yh(e),r={};for(const[e,s]of Object.entries(n))t(e,s)?r[e]=s.optional():r[e]=s;return e.extend(r)}if(Xp(e)){const n=yh(e),r={...e._zod.def.shape};for(const[e,s]of Object.entries(n))t(e,s)&&(r[e]=new Ip({type:"optional",innerType:s}));const s=yu(e,{...e._zod.def,shape:r}),a=Bu.get(e);return a&&Bu.add(s,a),s}throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Eh(e){return e instanceof Error&&("ZodError"===e.constructor.name||"$ZodError"===e.constructor.name)}function Oh(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const Sh=["*","_","`"];const Ah=Symbol("Let zodToJsonSchema decide on which parser to use"),$h={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},Ch=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")};function Nh(e){if("openAi"!==e.target)return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?Ch(t,e.currentPath):t.join("/")}}function Ph(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function Rh(e,t,n,r,s){e[t]=n,Ph(e,t,r,s)}var jh,Lh,Mh;(Mh=jh||(jh={})).assertEqual=e=>{},Mh.assertIs=function(e){},Mh.assertNever=function(_x){throw new Error},Mh.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},Mh.getValidEnumValues=e=>{const t=Mh.objectKeys(e).filter(t=>"number"!=typeof e[e[t]]),n={};for(const r of t)n[r]=e[r];return Mh.objectValues(n)},Mh.objectValues=e=>Mh.objectKeys(e).map(function(t){return e[t]}),Mh.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},Mh.find=(e,t)=>{for(const n of e)if(t(n))return n},Mh.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,Mh.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},Mh.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t,function(e){e.mergeShapes=(e,t)=>({...e,...t})}(Lh||(Lh={}));const zh=jh.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Uh=e=>{switch(typeof e){case"undefined":return zh.undefined;case"string":return zh.string;case"number":return Number.isNaN(e)?zh.nan:zh.number;case"boolean":return zh.boolean;case"function":return zh.function;case"bigint":return zh.bigint;case"symbol":return zh.symbol;case"object":return Array.isArray(e)?zh.array:null===e?zh.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?zh.promise:"undefined"!=typeof Map&&e instanceof Map?zh.map:"undefined"!=typeof Set&&e instanceof Set?zh.set:"undefined"!=typeof Date&&e instanceof Date?zh.date:zh.object;default:return zh.unknown}},Dh=jh.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Fh extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const s of e.issues)if("invalid_union"===s.code)s.unionErrors.map(r);else if("invalid_return_type"===s.code)r(s.returnTypeError);else if("invalid_arguments"===s.code)r(s.argumentsError);else if(0===s.path.length)n._errors.push(t(s));else{let e=n,r=0;for(;r<s.path.length;){const n=s.path[r];r===s.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(s))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof Fh))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,jh.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const r of this.issues)if(r.path.length>0){const n=r.path[0];t[n]=t[n]||[],t[n].push(e(r))}else n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}Fh.create=e=>new Fh(e);const Bh=(e,t)=>{let n;switch(e.code){case Dh.invalid_type:n=e.received===zh.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case Dh.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,jh.jsonStringifyReplacer)}`;break;case Dh.unrecognized_keys:n=`Unrecognized key(s) in object: ${jh.joinValues(e.keys,", ")}`;break;case Dh.invalid_union:n="Invalid input";break;case Dh.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${jh.joinValues(e.options)}`;break;case Dh.invalid_enum_value:n=`Invalid enum value. Expected ${jh.joinValues(e.options)}, received '${e.received}'`;break;case Dh.invalid_arguments:n="Invalid function arguments";break;case Dh.invalid_return_type:n="Invalid function return type";break;case Dh.invalid_date:n="Invalid date";break;case Dh.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:jh.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case Dh.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type||"bigint"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case Dh.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case Dh.custom:n="Invalid input";break;case Dh.invalid_intersection_types:n="Intersection results could not be merged";break;case Dh.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case Dh.not_finite:n="Number must be finite";break;default:n=t.defaultError,jh.assertNever(e)}return{message:n}};let Zh=Bh;var qh;!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(qh||(qh={}));function Vh(e,t){const n=Zh,r=(e=>{const{data:t,path:n,errorMaps:r,issueData:s}=e,a=[...n,...s.path||[]],i={...s,path:a};if(void 0!==s.message)return{...s,path:a,message:s.message};let o="";const c=r.filter(e=>!!e).slice().reverse();for(const e of c)o=e(i,{data:t,defaultError:o}).message;return{...s,path:a,message:o}})({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===Bh?void 0:Bh].filter(e=>!!e)});e.common.issues.push(r)}class Hh{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return Wh;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return Hh.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:s}=r;if("aborted"===t.status)return Wh;if("aborted"===s.status)return Wh;"dirty"===t.status&&e.dirty(),"dirty"===s.status&&e.dirty(),"__proto__"===t.value||void 0===s.value&&!r.alwaysSet||(n[t.value]=s.value)}return{status:e.value,value:n}}}const Wh=Object.freeze({status:"aborted"}),Gh=e=>({status:"dirty",value:e}),Jh=e=>({status:"valid",value:e}),Kh=e=>"aborted"===e.status,Xh=e=>"dirty"===e.status,Yh=e=>"valid"===e.status,Qh=e=>"undefined"!=typeof Promise&&e instanceof Promise;class em{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const tm=(e,t)=>{if(Yh(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Fh(e.common.issues);return this._error=t,this._error}}};function nm(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:s}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:s}:{errorMap:(t,s)=>{const{message:a}=e;return"invalid_enum_value"===t.code?{message:a??s.defaultError}:void 0===s.data?{message:a??r??s.defaultError}:"invalid_type"!==t.code?{message:s.defaultError}:{message:a??n??s.defaultError}},description:s}}class rm{get description(){return this._def.description}_getType(e){return Uh(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Uh(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Hh,ctx:{common:e.parent.common,data:e.data,parsedType:Uh(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Qh(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){const n={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Uh(e)},r=this._parseSync({data:e,path:n.path,parent:n});return tm(n,r)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Uh(e)};if(!this["~standard"].async)try{const n=this._parseSync({data:e,path:[],parent:t});return Yh(n)?{value:n.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>Yh(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Uh(e)},r=this._parse({data:e,path:n.path,parent:n}),s=await(Qh(r)?r:Promise.resolve(r));return tm(n,s)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,r)=>{const s=e(t),a=()=>r.addIssue({code:Dh.custom,...n(t)});return"undefined"!=typeof Promise&&s instanceof Promise?s.then(e=>!!e||(a(),!1)):!!s||(a(),!1)})}refinement(e,t){return this._refinement((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1))}_refinement(e){return new tf({schema:this,typeName:df.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return nf.create(this,this._def)}nullable(){return rf.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Dm.create(this)}promise(){return ef.create(this,this._def)}or(e){return Zm.create([this,e],this._def)}and(e){return Vm.create(this,e,this._def)}transform(e){return new tf({...nm(this._def),schema:this,typeName:df.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new sf({...nm(this._def),innerType:this,defaultValue:t,typeName:df.ZodDefault})}brand(){return new cf({typeName:df.ZodBranded,type:this,...nm(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new af({...nm(this._def),innerType:this,catchValue:t,typeName:df.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return lf.create(this,e)}readonly(){return uf.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const sm=/^c[^\s-]{8,}$/i,am=/^[0-9a-z]+$/,im=/^[0-9A-HJKMNP-TV-Z]{26}$/i,om=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,cm=/^[a-z0-9_-]{21}$/i,lm=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,um=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,dm=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let pm;const hm=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,mm=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,fm=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,gm=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,ym=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,_m=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,vm="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",wm=new RegExp(`^${vm}$`);function bm(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function xm(e){return new RegExp(`^${bm(e)}$`)}function km(e){let t=`${vm}T${bm(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function Tm(e,t){return!("v4"!==t&&t||!hm.test(e))||!("v6"!==t&&t||!fm.test(e))}function Im(e,t){if(!lm.test(e))return!1;try{const[n]=e.split(".");if(!n)return!1;const r=n.replace(/-/g,"+").replace(/_/g,"/").padEnd(n.length+(4-n.length%4)%4,"="),s=JSON.parse(atob(r));return!("object"!=typeof s||null===s||"typ"in s&&"JWT"!==s?.typ||!s.alg||t&&s.alg!==t)}catch{return!1}}function Em(e,t){return!("v4"!==t&&t||!mm.test(e))||!("v6"!==t&&t||!gm.test(e))}class Om extends rm{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==zh.string){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.string,received:t.parsedType}),Wh}const t=new Hh;let n;for(const r of this._def.checks)if("min"===r.kind)e.data.length<r.value&&(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),t.dirty());else if("max"===r.kind)e.data.length>r.value&&(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),t.dirty());else if("length"===r.kind){const s=e.data.length>r.value,a=e.data.length<r.value;(s||a)&&(n=this._getOrReturnCtx(e,n),s?Vh(n,{code:Dh.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}):a&&Vh(n,{code:Dh.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}),t.dirty())}else if("email"===r.kind)dm.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"email",code:Dh.invalid_string,message:r.message}),t.dirty());else if("emoji"===r.kind)pm||(pm=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),pm.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"emoji",code:Dh.invalid_string,message:r.message}),t.dirty());else if("uuid"===r.kind)om.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"uuid",code:Dh.invalid_string,message:r.message}),t.dirty());else if("nanoid"===r.kind)cm.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"nanoid",code:Dh.invalid_string,message:r.message}),t.dirty());else if("cuid"===r.kind)sm.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"cuid",code:Dh.invalid_string,message:r.message}),t.dirty());else if("cuid2"===r.kind)am.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"cuid2",code:Dh.invalid_string,message:r.message}),t.dirty());else if("ulid"===r.kind)im.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"ulid",code:Dh.invalid_string,message:r.message}),t.dirty());else if("url"===r.kind)try{new URL(e.data)}catch{n=this._getOrReturnCtx(e,n),Vh(n,{validation:"url",code:Dh.invalid_string,message:r.message}),t.dirty()}else"regex"===r.kind?(r.regex.lastIndex=0,r.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"regex",code:Dh.invalid_string,message:r.message}),t.dirty())):"trim"===r.kind?e.data=e.data.trim():"includes"===r.kind?e.data.includes(r.value,r.position)||(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.invalid_string,validation:{includes:r.value,position:r.position},message:r.message}),t.dirty()):"toLowerCase"===r.kind?e.data=e.data.toLowerCase():"toUpperCase"===r.kind?e.data=e.data.toUpperCase():"startsWith"===r.kind?e.data.startsWith(r.value)||(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.invalid_string,validation:{startsWith:r.value},message:r.message}),t.dirty()):"endsWith"===r.kind?e.data.endsWith(r.value)||(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.invalid_string,validation:{endsWith:r.value},message:r.message}),t.dirty()):"datetime"===r.kind?km(r).test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.invalid_string,validation:"datetime",message:r.message}),t.dirty()):"date"===r.kind?wm.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.invalid_string,validation:"date",message:r.message}),t.dirty()):"time"===r.kind?xm(r).test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.invalid_string,validation:"time",message:r.message}),t.dirty()):"duration"===r.kind?um.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"duration",code:Dh.invalid_string,message:r.message}),t.dirty()):"ip"===r.kind?Tm(e.data,r.version)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"ip",code:Dh.invalid_string,message:r.message}),t.dirty()):"jwt"===r.kind?Im(e.data,r.alg)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"jwt",code:Dh.invalid_string,message:r.message}),t.dirty()):"cidr"===r.kind?Em(e.data,r.version)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"cidr",code:Dh.invalid_string,message:r.message}),t.dirty()):"base64"===r.kind?ym.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"base64",code:Dh.invalid_string,message:r.message}),t.dirty()):"base64url"===r.kind?_m.test(e.data)||(n=this._getOrReturnCtx(e,n),Vh(n,{validation:"base64url",code:Dh.invalid_string,message:r.message}),t.dirty()):jh.assertNever(r);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement(t=>e.test(t),{validation:t,code:Dh.invalid_string,...qh.errToObj(n)})}_addCheck(e){return new Om({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...qh.errToObj(e)})}url(e){return this._addCheck({kind:"url",...qh.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...qh.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...qh.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...qh.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...qh.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...qh.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...qh.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...qh.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...qh.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...qh.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...qh.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...qh.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...qh.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...qh.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...qh.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...qh.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...qh.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...qh.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...qh.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...qh.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...qh.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...qh.errToObj(t)})}nonempty(e){return this.min(1,qh.errToObj(e))}trim(){return new Om({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Om({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Om({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Sm(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,s=n>r?n:r;return Number.parseInt(e.toFixed(s).replace(".",""))%Number.parseInt(t.toFixed(s).replace(".",""))/10**s}Om.create=e=>new Om({checks:[],typeName:df.ZodString,coerce:e?.coerce??!1,...nm(e)});class Am extends rm{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==zh.number){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.number,received:t.parsedType}),Wh}let t;const n=new Hh;for(const r of this._def.checks)"int"===r.kind?jh.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),Vh(t,{code:Dh.invalid_type,expected:"integer",received:"float",message:r.message}),n.dirty()):"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),Vh(t,{code:Dh.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),Vh(t,{code:Dh.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty()):"multipleOf"===r.kind?0!==Sm(e.data,r.value)&&(t=this._getOrReturnCtx(e,t),Vh(t,{code:Dh.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):"finite"===r.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),Vh(t,{code:Dh.not_finite,message:r.message}),n.dirty()):jh.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,qh.toString(t))}gt(e,t){return this.setLimit("min",e,!1,qh.toString(t))}lte(e,t){return this.setLimit("max",e,!0,qh.toString(t))}lt(e,t){return this.setLimit("max",e,!1,qh.toString(t))}setLimit(e,t,n,r){return new Am({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:qh.toString(r)}]})}_addCheck(e){return new Am({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:qh.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:qh.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:qh.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:qh.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:qh.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:qh.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:qh.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:qh.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:qh.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&jh.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Am.create=e=>new Am({checks:[],typeName:df.ZodNumber,coerce:e?.coerce||!1,...nm(e)});class $m extends rm{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==zh.bigint)return this._getInvalidInput(e);let t;const n=new Hh;for(const r of this._def.checks)"min"===r.kind?(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),Vh(t,{code:Dh.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"max"===r.kind?(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),Vh(t,{code:Dh.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty()):"multipleOf"===r.kind?e.data%r.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),Vh(t,{code:Dh.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):jh.assertNever(r);return{status:n.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.bigint,received:t.parsedType}),Wh}gte(e,t){return this.setLimit("min",e,!0,qh.toString(t))}gt(e,t){return this.setLimit("min",e,!1,qh.toString(t))}lte(e,t){return this.setLimit("max",e,!0,qh.toString(t))}lt(e,t){return this.setLimit("max",e,!1,qh.toString(t))}setLimit(e,t,n,r){return new $m({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:qh.toString(r)}]})}_addCheck(e){return new $m({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:qh.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:qh.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:qh.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:qh.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:qh.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}$m.create=e=>new $m({checks:[],typeName:df.ZodBigInt,coerce:e?.coerce??!1,...nm(e)});class Cm extends rm{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==zh.boolean){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.boolean,received:t.parsedType}),Wh}return Jh(e.data)}}Cm.create=e=>new Cm({typeName:df.ZodBoolean,coerce:e?.coerce||!1,...nm(e)});class Nm extends rm{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==zh.date){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.date,received:t.parsedType}),Wh}if(Number.isNaN(e.data.getTime()))return Vh(this._getOrReturnCtx(e),{code:Dh.invalid_date}),Wh;const t=new Hh;let n;for(const r of this._def.checks)"min"===r.kind?e.data.getTime()<r.value&&(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),t.dirty()):"max"===r.kind?e.data.getTime()>r.value&&(n=this._getOrReturnCtx(e,n),Vh(n,{code:Dh.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),t.dirty()):jh.assertNever(r);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Nm({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:qh.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:qh.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Nm.create=e=>new Nm({checks:[],coerce:e?.coerce||!1,typeName:df.ZodDate,...nm(e)});class Pm extends rm{_parse(e){if(this._getType(e)!==zh.symbol){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.symbol,received:t.parsedType}),Wh}return Jh(e.data)}}Pm.create=e=>new Pm({typeName:df.ZodSymbol,...nm(e)});class Rm extends rm{_parse(e){if(this._getType(e)!==zh.undefined){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.undefined,received:t.parsedType}),Wh}return Jh(e.data)}}Rm.create=e=>new Rm({typeName:df.ZodUndefined,...nm(e)});class jm extends rm{_parse(e){if(this._getType(e)!==zh.null){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.null,received:t.parsedType}),Wh}return Jh(e.data)}}jm.create=e=>new jm({typeName:df.ZodNull,...nm(e)});class Lm extends rm{constructor(){super(...arguments),this._any=!0}_parse(e){return Jh(e.data)}}Lm.create=e=>new Lm({typeName:df.ZodAny,...nm(e)});class Mm extends rm{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Jh(e.data)}}Mm.create=e=>new Mm({typeName:df.ZodUnknown,...nm(e)});class zm extends rm{_parse(e){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.never,received:t.parsedType}),Wh}}zm.create=e=>new zm({typeName:df.ZodNever,...nm(e)});class Um extends rm{_parse(e){if(this._getType(e)!==zh.undefined){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.void,received:t.parsedType}),Wh}return Jh(e.data)}}Um.create=e=>new Um({typeName:df.ZodVoid,...nm(e)});class Dm extends rm{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==zh.array)return Vh(t,{code:Dh.invalid_type,expected:zh.array,received:t.parsedType}),Wh;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,s=t.data.length<r.exactLength.value;(e||s)&&(Vh(t,{code:e?Dh.too_big:Dh.too_small,minimum:s?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(Vh(t,{code:Dh.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(Vh(t,{code:Dh.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map((e,n)=>r.type._parseAsync(new em(t,e,t.path,n)))).then(e=>Hh.mergeArray(n,e));const s=[...t.data].map((e,n)=>r.type._parseSync(new em(t,e,t.path,n)));return Hh.mergeArray(n,s)}get element(){return this._def.type}min(e,t){return new Dm({...this._def,minLength:{value:e,message:qh.toString(t)}})}max(e,t){return new Dm({...this._def,maxLength:{value:e,message:qh.toString(t)}})}length(e,t){return new Dm({...this._def,exactLength:{value:e,message:qh.toString(t)}})}nonempty(e){return this.min(1,e)}}function Fm(e){if(e instanceof Bm){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=nf.create(Fm(r))}return new Bm({...e._def,shape:()=>t})}return e instanceof Dm?new Dm({...e._def,type:Fm(e.element)}):e instanceof nf?nf.create(Fm(e.unwrap())):e instanceof rf?rf.create(Fm(e.unwrap())):e instanceof Hm?Hm.create(e.items.map(e=>Fm(e))):e}Dm.create=(e,t)=>new Dm({type:e,minLength:null,maxLength:null,exactLength:null,typeName:df.ZodArray,...nm(t)});class Bm extends rm{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=jh.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==zh.object){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.object,received:t.parsedType}),Wh}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:s}=this._getCached(),a=[];if(!(this._def.catchall instanceof zm&&"strip"===this._def.unknownKeys))for(const e in n.data)s.includes(e)||a.push(e);const i=[];for(const e of s){const t=r[e],s=n.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new em(n,s,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof zm){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of a)i.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)a.length>0&&(Vh(n,{code:Dh.unrecognized_keys,keys:a}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of a){const r=n.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new em(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of i){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e}).then(e=>Hh.mergeObjectSync(t,e)):Hh.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return qh.errToObj,new Bm({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{const r=this._def.errorMap?.(t,n).message??n.defaultError;return"unrecognized_keys"===t.code?{message:qh.errToObj(e).message??r}:{message:r}}}:{}})}strip(){return new Bm({...this._def,unknownKeys:"strip"})}passthrough(){return new Bm({...this._def,unknownKeys:"passthrough"})}extend(e){return new Bm({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Bm({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:df.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Bm({...this._def,catchall:e})}pick(e){const t={};for(const n of jh.objectKeys(e))e[n]&&this.shape[n]&&(t[n]=this.shape[n]);return new Bm({...this._def,shape:()=>t})}omit(e){const t={};for(const n of jh.objectKeys(this.shape))e[n]||(t[n]=this.shape[n]);return new Bm({...this._def,shape:()=>t})}deepPartial(){return Fm(this)}partial(e){const t={};for(const n of jh.objectKeys(this.shape)){const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()}return new Bm({...this._def,shape:()=>t})}required(e){const t={};for(const n of jh.objectKeys(this.shape))if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof nf;)e=e._def.innerType;t[n]=e}return new Bm({...this._def,shape:()=>t})}keyof(){return Xm(jh.objectKeys(this.shape))}}Bm.create=(e,t)=>new Bm({shape:()=>e,unknownKeys:"strip",catchall:zm.create(),typeName:df.ZodObject,...nm(t)}),Bm.strictCreate=(e,t)=>new Bm({shape:()=>e,unknownKeys:"strict",catchall:zm.create(),typeName:df.ZodObject,...nm(t)}),Bm.lazycreate=(e,t)=>new Bm({shape:e,unknownKeys:"strip",catchall:zm.create(),typeName:df.ZodObject,...nm(t)});class Zm extends rm{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map(async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map(e=>new Fh(e.ctx.common.issues));return Vh(t,{code:Dh.invalid_union,unionErrors:n}),Wh});{let e;const r=[];for(const s of n){const n={...t,common:{...t.common,issues:[]},parent:null},a=s._parseSync({data:t.data,path:t.path,parent:n});if("valid"===a.status)return a;"dirty"!==a.status||e||(e={result:a,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const s=r.map(e=>new Fh(e));return Vh(t,{code:Dh.invalid_union,unionErrors:s}),Wh}}get options(){return this._def.options}}function qm(e,t){const n=Uh(e),r=Uh(t);if(e===t)return{valid:!0,data:e};if(n===zh.object&&r===zh.object){const n=jh.objectKeys(t),r=jh.objectKeys(e).filter(e=>-1!==n.indexOf(e)),s={...e,...t};for(const n of r){const r=qm(e[n],t[n]);if(!r.valid)return{valid:!1};s[n]=r.data}return{valid:!0,data:s}}if(n===zh.array&&r===zh.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const s=qm(e[r],t[r]);if(!s.valid)return{valid:!1};n.push(s.data)}return{valid:!0,data:n}}return n===zh.date&&r===zh.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}Zm.create=(e,t)=>new Zm({options:e,typeName:df.ZodUnion,...nm(t)});class Vm extends rm{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(Kh(e)||Kh(r))return Wh;const s=qm(e.value,r.value);return s.valid?((Xh(e)||Xh(r))&&t.dirty(),{status:t.value,value:s.data}):(Vh(n,{code:Dh.invalid_intersection_types}),Wh)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([e,t])=>r(e,t)):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Vm.create=(e,t,n)=>new Vm({left:e,right:t,typeName:df.ZodIntersection,...nm(n)});class Hm extends rm{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==zh.array)return Vh(n,{code:Dh.invalid_type,expected:zh.array,received:n.parsedType}),Wh;if(n.data.length<this._def.items.length)return Vh(n,{code:Dh.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Wh;!this._def.rest&&n.data.length>this._def.items.length&&(Vh(n,{code:Dh.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new em(n,e,n.path,t)):null}).filter(e=>!!e);return n.common.async?Promise.all(r).then(e=>Hh.mergeArray(t,e)):Hh.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new Hm({...this._def,rest:e})}}Hm.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Hm({items:e,typeName:df.ZodTuple,rest:null,...nm(t)})};class Wm extends rm{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==zh.map)return Vh(n,{code:Dh.invalid_type,expected:zh.map,received:n.parsedType}),Wh;const r=this._def.keyType,s=this._def.valueType,a=[...n.data.entries()].map(([e,t],a)=>({key:r._parse(new em(n,e,n.path,[a,"key"])),value:s._parse(new em(n,t,n.path,[a,"value"]))}));if(n.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const n of a){const r=await n.key,s=await n.value;if("aborted"===r.status||"aborted"===s.status)return Wh;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}})}{const e=new Map;for(const n of a){const r=n.key,s=n.value;if("aborted"===r.status||"aborted"===s.status)return Wh;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}}}}Wm.create=(e,t,n)=>new Wm({valueType:t,keyType:e,typeName:df.ZodMap,...nm(n)});class Gm extends rm{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==zh.set)return Vh(n,{code:Dh.invalid_type,expected:zh.set,received:n.parsedType}),Wh;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(Vh(n,{code:Dh.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(Vh(n,{code:Dh.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const s=this._def.valueType;function a(e){const n=new Set;for(const r of e){if("aborted"===r.status)return Wh;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const i=[...n.data.values()].map((e,t)=>s._parse(new em(n,e,n.path,t)));return n.common.async?Promise.all(i).then(e=>a(e)):a(i)}min(e,t){return new Gm({...this._def,minSize:{value:e,message:qh.toString(t)}})}max(e,t){return new Gm({...this._def,maxSize:{value:e,message:qh.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Gm.create=(e,t)=>new Gm({valueType:e,minSize:null,maxSize:null,typeName:df.ZodSet,...nm(t)});class Jm extends rm{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Jm.create=(e,t)=>new Jm({getter:e,typeName:df.ZodLazy,...nm(t)});class Km extends rm{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return Vh(t,{received:t.data,code:Dh.invalid_literal,expected:this._def.value}),Wh}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Xm(e,t){return new Ym({values:e,typeName:df.ZodEnum,...nm(t)})}Km.create=(e,t)=>new Km({value:e,typeName:df.ZodLiteral,...nm(t)});class Ym extends rm{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return Vh(t,{expected:jh.joinValues(n),received:t.parsedType,code:Dh.invalid_type}),Wh}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return Vh(t,{received:t.data,code:Dh.invalid_enum_value,options:n}),Wh}return Jh(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return Ym.create(e,{...this._def,...t})}exclude(e,t=this._def){return Ym.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}Ym.create=Xm;class Qm extends rm{_parse(e){const t=jh.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==zh.string&&n.parsedType!==zh.number){const e=jh.objectValues(t);return Vh(n,{expected:jh.joinValues(e),received:n.parsedType,code:Dh.invalid_type}),Wh}if(this._cache||(this._cache=new Set(jh.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=jh.objectValues(t);return Vh(n,{received:n.data,code:Dh.invalid_enum_value,options:e}),Wh}return Jh(e.data)}get enum(){return this._def.values}}Qm.create=(e,t)=>new Qm({values:e,typeName:df.ZodNativeEnum,...nm(t)});class ef extends rm{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==zh.promise&&!1===t.common.async)return Vh(t,{code:Dh.invalid_type,expected:zh.promise,received:t.parsedType}),Wh;const n=t.parsedType===zh.promise?t.data:Promise.resolve(t.data);return Jh(n.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}ef.create=(e,t)=>new ef({type:e,typeName:df.ZodPromise,...nm(t)});class tf extends rm{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===df.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,s={addIssue:e=>{Vh(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===r.type){const e=r.transform(n.data,s);if(n.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return Wh;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?Wh:"dirty"===r.status||"dirty"===t.value?Gh(r.value):r});{if("aborted"===t.value)return Wh;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?Wh:"dirty"===r.status||"dirty"===t.value?Gh(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,s);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?Wh:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(n=>"aborted"===n.status?Wh:("dirty"===n.status&&t.dirty(),e(n.value).then(()=>({status:t.value,value:n.value}))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Yh(e))return Wh;const a=r.transform(e.value,s);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(e=>Yh(e)?Promise.resolve(r.transform(e.value,s)).then(e=>({status:t.value,value:e})):Wh)}jh.assertNever(r)}}tf.create=(e,t,n)=>new tf({schema:e,typeName:df.ZodEffects,effect:t,...nm(n)}),tf.createWithPreprocess=(e,t,n)=>new tf({schema:t,effect:{type:"preprocess",transform:e},typeName:df.ZodEffects,...nm(n)});class nf extends rm{_parse(e){return this._getType(e)===zh.undefined?Jh(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}nf.create=(e,t)=>new nf({innerType:e,typeName:df.ZodOptional,...nm(t)});class rf extends rm{_parse(e){return this._getType(e)===zh.null?Jh(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}rf.create=(e,t)=>new rf({innerType:e,typeName:df.ZodNullable,...nm(t)});class sf extends rm{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===zh.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}sf.create=(e,t)=>new sf({innerType:e,typeName:df.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...nm(t)});class af extends rm{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Qh(r)?r.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new Fh(n.common.issues)},input:n.data})})):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new Fh(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}af.create=(e,t)=>new af({innerType:e,typeName:df.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...nm(t)});class of extends rm{_parse(e){if(this._getType(e)!==zh.nan){const t=this._getOrReturnCtx(e);return Vh(t,{code:Dh.invalid_type,expected:zh.nan,received:t.parsedType}),Wh}return{status:"valid",value:e.data}}}of.create=e=>new of({typeName:df.ZodNaN,...nm(e)}),Symbol("zod_brand");class cf extends rm{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class lf extends rm{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Wh:"dirty"===e.status?(t.dirty(),Gh(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})();{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Wh:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new lf({in:e,out:t,typeName:df.ZodPipeline})}}class uf extends rm{_parse(e){const t=this._def.innerType._parse(e),n=e=>(Yh(e)&&(e.value=Object.freeze(e.value)),e);return Qh(t)?t.then(e=>n(e)):n(t)}unwrap(){return this._def.innerType}}var df;uf.create=(e,t)=>new uf({innerType:e,typeName:df.ZodReadonly,...nm(t)}),Bm.lazycreate,function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(df||(df={}));const pf=Om.create,hf=(Am.create,of.create,$m.create,Cm.create,Nm.create,Pm.create,Rm.create,jm.create,Lm.create),mf=(Mm.create,zm.create,Um.create,Dm.create,Bm.create);function ff(e,t){return Ff(e.type._def,t)}function gf(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(n=>gf(e,t,n))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return yf(e,t)}}Bm.strictCreate,Zm.create,Vm.create,Hm.create,Wm.create,Gm.create,Jm.create,Km.create,Ym.create,Qm.create,ef.create,tf.create,nf.create,rf.create,tf.createWithPreprocess,lf.create;const yf=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":Rh(n,"minimum",r.value,r.message,t);break;case"max":Rh(n,"maximum",r.value,r.message,t)}return n};let _f;const vf=/^[cC][^\s-]{8,}$/,wf=/^[0-9a-z]+$/,bf=/^[0-9A-HJKMNP-TV-Z]{26}$/,xf=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,kf=()=>(void 0===_f&&(_f=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),_f),Tf=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,If=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Ef=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Of=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Sf=/^[a-zA-Z0-9_-]{21}$/,Af=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function $f(e,t){const n={type:"string"};if(e.checks)for(const r of e.checks)switch(r.kind){case"min":Rh(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t);break;case"max":Rh(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Pf(n,"email",r.message,t);break;case"format:idn-email":Pf(n,"idn-email",r.message,t);break;case"pattern:zod":Rf(n,xf,r.message,t)}break;case"url":Pf(n,"uri",r.message,t);break;case"uuid":Pf(n,"uuid",r.message,t);break;case"regex":Rf(n,r.regex,r.message,t);break;case"cuid":Rf(n,vf,r.message,t);break;case"cuid2":Rf(n,wf,r.message,t);break;case"startsWith":Rf(n,RegExp(`^${Cf(r.value,t)}`),r.message,t);break;case"endsWith":Rf(n,RegExp(`${Cf(r.value,t)}$`),r.message,t);break;case"datetime":Pf(n,"date-time",r.message,t);break;case"date":Pf(n,"date",r.message,t);break;case"time":Pf(n,"time",r.message,t);break;case"duration":Pf(n,"duration",r.message,t);break;case"length":Rh(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,r.value):r.value,r.message,t),Rh(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,r.value):r.value,r.message,t);break;case"includes":Rf(n,RegExp(Cf(r.value,t)),r.message,t);break;case"ip":"v6"!==r.version&&Pf(n,"ipv4",r.message,t),"v4"!==r.version&&Pf(n,"ipv6",r.message,t);break;case"base64url":Rf(n,Of,r.message,t);break;case"jwt":Rf(n,Af,r.message,t);break;case"cidr":"v6"!==r.version&&Rf(n,Tf,r.message,t),"v4"!==r.version&&Rf(n,If,r.message,t);break;case"emoji":Rf(n,kf(),r.message,t);break;case"ulid":Rf(n,bf,r.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Pf(n,"binary",r.message,t);break;case"contentEncoding:base64":Rh(n,"contentEncoding","base64",r.message,t);break;case"pattern:zod":Rf(n,Ef,r.message,t)}break;case"nanoid":Rf(n,Sf,r.message,t);break;case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return n}function Cf(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let n=0;n<e.length;n++)Nf.has(e[n])||(t+="\\"),t+=e[n];return t}(e):e}const Nf=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function Pf(e,t,n,r){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Rh(e,"format",t,n,r)}function Rf(e,t,n,r){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:jf(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Rh(e,"pattern",jf(t,r),n,r)}function jf(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const n=e.flags.includes("i"),r=e.flags.includes("m"),s=e.flags.includes("s"),a=n?e.source.toLowerCase():e.source;let i="",o=!1,c=!1,l=!1;for(let e=0;e<a.length;e++)if(o)i+=a[e],o=!1;else{if(n)if(c){if(a[e].match(/[a-z]/)){l?(i+=a[e],i+=`${a[e-2]}-${a[e]}`.toUpperCase(),l=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(i+=a[e],l=!0):i+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){i+=`[${a[e]}${a[e].toUpperCase()}]`;continue}if(r){if("^"===a[e]){i+="(^|(?<=[\r\n]))";continue}if("$"===a[e]){i+="($|(?=[\r\n]))";continue}}s&&"."===a[e]?i+=c?`${a[e]}\r\n`:`[${a[e]}\r\n]`:(i+=a[e],"\\"===a[e]?o=!0:c&&"]"===a[e]?c=!1:c||"["!==a[e]||(c=!0))}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return i}function Lf(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===df.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,r)=>({...n,[r]:Ff(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??Nh(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};const n={type:"object",additionalProperties:Ff(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===df.ZodString&&e.keyType._def.checks?.length){const{type:r,...s}=$f(e.keyType._def,t);return{...n,propertyNames:s}}if(e.keyType?._def.typeName===df.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===df.ZodBranded&&e.keyType._def.type._def.typeName===df.ZodString&&e.keyType._def.type._def.checks?.length){const{type:r,...s}=ff(e.keyType._def,t);return{...n,propertyNames:s}}return n}const Mf={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},zf=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,n)=>Ff(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return n.length?{anyOf:n}:void 0};function Uf(e){try{return e.isOptional()}catch{return!0}}const Df=(e,t,n)=>{switch(t){case df.ZodString:return $f(e,n);case df.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",Ph(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?Rh(n,"minimum",r.value,r.message,t):Rh(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Rh(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Rh(n,"maximum",r.value,r.message,t):Rh(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Rh(n,"maximum",r.value,r.message,t));break;case"multipleOf":Rh(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case df.ZodObject:return function(e,t){const n="openAi"===t.target,r={type:"object",properties:{}},s=[],a=e.shape();for(const e in a){let i=a[e];if(void 0===i||void 0===i._def)continue;let o=Uf(i);o&&n&&("ZodOptional"===i._def.typeName&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);const c=Ff(i._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==c&&(r.properties[e]=c,o||s.push(e))}s.length&&(r.required=s);const i=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return Ff(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==i&&(r.additionalProperties=i),r}(e,n);case df.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?Rh(n,"minimum",r.value,r.message,t):Rh(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Rh(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Rh(n,"maximum",r.value,r.message,t):Rh(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Rh(n,"maximum",r.value,r.message,t));break;case"multipleOf":Rh(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case df.ZodBoolean:return{type:"boolean"};case df.ZodDate:return gf(e,n);case df.ZodUndefined:return function(e){return{not:Nh(e)}}(n);case df.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case df.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==df.ZodAny&&(n.items=Ff(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Rh(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Rh(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Rh(n,"minItems",e.exactLength.value,e.exactLength.message,t),Rh(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case df.ZodUnion:case df.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return zf(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(e=>e._def.typeName in Mf&&(!e._def.checks||!e._def.checks.length))){const e=n.reduce((e,t)=>{const n=Mf[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e},[]);return{type:e.length>1?e:e[0]}}if(n.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=n.reduce((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":return null===t._def.value?[...e,"null"]:e;default:return e}},[]);if(e.length===n.length){const t=e.filter((e,t,n)=>n.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:n.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(n.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:n.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return zf(e,t)}(e,n);case df.ZodIntersection:return function(e,t){const n=[Ff(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Ff(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;s.push(t)}else s.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t}),s.length?{allOf:s,...r}:void 0}(e,n);case df.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,n)=>Ff(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:Ff(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,n)=>Ff(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,n);case df.ZodRecord:return Lf(e,n);case df.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case df.ZodEnum:return function(e){return{type:"string",enum:Array.from(e.values)}}(e);case df.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),r=Array.from(new Set(n.map(e=>typeof e)));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case df.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:Mf[e.innerType._def.typeName],nullable:!0}:{type:[Mf[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=Ff(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=Ff(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case df.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Ff(e.innerType._def,t);const n=Ff(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:Nh(t)},n]}:Nh(t)})(e,n);case df.ZodMap:return function(e,t){return"record"===t.mapStrategy?Lf(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Ff(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||Nh(t),Ff(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||Nh(t)],minItems:2,maxItems:2}}}(e,n);case df.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:Ff(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Rh(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Rh(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case df.ZodLazy:return()=>e.getter()._def;case df.ZodPromise:return function(e,t){return Ff(e.type._def,t)}(e,n);case df.ZodNaN:case df.ZodNever:return function(e){return"openAi"===e.target?void 0:{not:Nh({...e,currentPath:[...e.currentPath,"not"]})}}(n);case df.ZodEffects:return function(e,t){return"input"===t.effectStrategy?Ff(e.schema._def,t):Nh(t)}(e,n);case df.ZodAny:return Nh(n);case df.ZodUnknown:return function(e){return Nh(e)}(n);case df.ZodDefault:return function(e,t){return{...Ff(e.innerType._def,t),default:e.defaultValue()}}(e,n);case df.ZodBranded:return ff(e,n);case df.ZodReadonly:case df.ZodCatch:return((e,t)=>Ff(e.innerType._def,t))(e,n);case df.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Ff(e.in._def,t);if("output"===t.pipeStrategy)return Ff(e.out._def,t);const n=Ff(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,Ff(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter(e=>void 0!==e)}})(e,n);case df.ZodFunction:case df.ZodVoid:case df.ZodSymbol:default:return}};function Ff(e,t,n=!1){const r=t.seen.get(e);if(t.override){const s=t.override?.(e,t,r,n);if(s!==Ah)return s}if(r&&!n){const e=Bf(r,t);if(void 0!==e)return e}const s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);const a=Df(e,e.typeName,t),i="function"==typeof a?Ff(a(),t):a;if(i&&Zf(e,t,i),t.postProcess){const n=t.postProcess(i,e,t);return s.jsonSchema=i,n}return s.jsonSchema=i,i}const Bf=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:Ch(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,n)=>t.currentPath[n]===e)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),Nh(t)):"seen"===t.$refStrategy?Nh(t):void 0}},Zf=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n);class qf{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??Bu,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var n;const r=e._zod.def,s={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},a=this.seen.get(e);if(a)return a.count++,t.schemaPath.includes(e)&&(a.cycle=t.path),a.schema;const i={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,i);const o=e._zod.toJSONSchema?.();if(o)i.schema=o;else{const n={...t,schemaPath:[...t.schemaPath,e],path:t.path},a=e._zod.parent;if(a)i.ref=a,this.process(a,n),this.seen.get(a).isParent=!0;else{const t=i.schema;switch(r.type){case"string":{const n=t;n.type="string";const{minimum:r,maximum:a,format:o,patterns:c,contentEncoding:l}=e._zod.bag;if("number"==typeof r&&(n.minLength=r),"number"==typeof a&&(n.maxLength=a),o&&(n.format=s[o]??o,""===n.format&&delete n.format),l&&(n.contentEncoding=l),c&&c.size>0){const e=[...c];1===e.length?n.pattern=e[0].source:e.length>1&&(i.schema.allOf=[...e.map(e=>({..."draft-7"===this.target?{type:"string"}:{},pattern:e.source}))])}break}case"number":{const n=t,{minimum:r,maximum:s,format:a,multipleOf:i,exclusiveMaximum:o,exclusiveMinimum:c}=e._zod.bag;"string"==typeof a&&a.includes("int")?n.type="integer":n.type="number","number"==typeof c&&(n.exclusiveMinimum=c),"number"==typeof r&&(n.minimum=r,"number"==typeof c&&(c>=r?delete n.minimum:delete n.exclusiveMinimum)),"number"==typeof o&&(n.exclusiveMaximum=o),"number"==typeof s&&(n.maximum=s,"number"==typeof o&&(o<=s?delete n.maximum:delete n.exclusiveMaximum)),"number"==typeof i&&(n.multipleOf=i);break}case"boolean":case"success":t.type="boolean";break;case"bigint":if("throw"===this.unrepresentable)throw new Error("BigInt cannot be represented in JSON Schema");break;case"symbol":if("throw"===this.unrepresentable)throw new Error("Symbols cannot be represented in JSON Schema");break;case"null":t.type="null";break;case"any":case"unknown":break;case"undefined":if("throw"===this.unrepresentable)throw new Error("Undefined cannot be represented in JSON Schema");break;case"void":if("throw"===this.unrepresentable)throw new Error("Void cannot be represented in JSON Schema");break;case"never":t.not={};break;case"date":if("throw"===this.unrepresentable)throw new Error("Date cannot be represented in JSON Schema");break;case"array":{const s=t,{minimum:a,maximum:i}=e._zod.bag;"number"==typeof a&&(s.minItems=a),"number"==typeof i&&(s.maxItems=i),s.type="array",s.items=this.process(r.element,{...n,path:[...n.path,"items"]});break}case"object":{const e=t;e.type="object",e.properties={};const s=r.shape;for(const t in s)e.properties[t]=this.process(s[t],{...n,path:[...n.path,"properties",t]});const a=new Set(Object.keys(s)),i=new Set([...a].filter(e=>{const t=r.shape[e]._zod;return"input"===this.io?void 0===t.optin:void 0===t.optout}));i.size>0&&(e.required=Array.from(i)),"never"===r.catchall?._zod.def.type?e.additionalProperties=!1:r.catchall?r.catchall&&(e.additionalProperties=this.process(r.catchall,{...n,path:[...n.path,"additionalProperties"]})):"output"===this.io&&(e.additionalProperties=!1);break}case"union":t.anyOf=r.options.map((e,t)=>this.process(e,{...n,path:[...n.path,"anyOf",t]}));break;case"intersection":{const e=t,s=this.process(r.left,{...n,path:[...n.path,"allOf",0]}),a=this.process(r.right,{...n,path:[...n.path,"allOf",1]}),i=e=>"allOf"in e&&1===Object.keys(e).length,o=[...i(s)?s.allOf:[s],...i(a)?a.allOf:[a]];e.allOf=o;break}case"tuple":{const s=t;s.type="array";const a=r.items.map((e,t)=>this.process(e,{...n,path:[...n.path,"prefixItems",t]}));if("draft-2020-12"===this.target?s.prefixItems=a:s.items=a,r.rest){const e=this.process(r.rest,{...n,path:[...n.path,"items"]});"draft-2020-12"===this.target?s.items=e:s.additionalItems=e}r.rest&&(s.items=this.process(r.rest,{...n,path:[...n.path,"items"]}));const{minimum:i,maximum:o}=e._zod.bag;"number"==typeof i&&(s.minItems=i),"number"==typeof o&&(s.maxItems=o);break}case"record":{const e=t;e.type="object",e.propertyNames=this.process(r.keyType,{...n,path:[...n.path,"propertyNames"]}),e.additionalProperties=this.process(r.valueType,{...n,path:[...n.path,"additionalProperties"]});break}case"map":if("throw"===this.unrepresentable)throw new Error("Map cannot be represented in JSON Schema");break;case"set":if("throw"===this.unrepresentable)throw new Error("Set cannot be represented in JSON Schema");break;case"enum":{const e=t,n=ru(r.entries);n.every(e=>"number"==typeof e)&&(e.type="number"),n.every(e=>"string"==typeof e)&&(e.type="string"),e.enum=n;break}case"literal":{const e=t,n=[];for(const e of r.values)if(void 0===e){if("throw"===this.unrepresentable)throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if("bigint"==typeof e){if("throw"===this.unrepresentable)throw new Error("BigInt literals cannot be represented in JSON Schema");n.push(Number(e))}else n.push(e);if(0===n.length);else if(1===n.length){const t=n[0];e.type=null===t?"null":typeof t,e.const=t}else n.every(e=>"number"==typeof e)&&(e.type="number"),n.every(e=>"string"==typeof e)&&(e.type="string"),n.every(e=>"boolean"==typeof e)&&(e.type="string"),n.every(e=>null===e)&&(e.type="null"),e.enum=n;break}case"file":{const n=t,r={type:"string",format:"binary",contentEncoding:"binary"},{minimum:s,maximum:a,mime:i}=e._zod.bag;void 0!==s&&(r.minLength=s),void 0!==a&&(r.maxLength=a),i?1===i.length?(r.contentMediaType=i[0],Object.assign(n,r)):n.anyOf=i.map(e=>({...r,contentMediaType:e})):Object.assign(n,r);break}case"transform":if("throw"===this.unrepresentable)throw new Error("Transforms cannot be represented in JSON Schema");break;case"nullable":{const e=this.process(r.innerType,n);t.anyOf=[e,{type:"null"}];break}case"nonoptional":case"promise":case"optional":this.process(r.innerType,n),i.ref=r.innerType;break;case"default":this.process(r.innerType,n),i.ref=r.innerType,t.default=JSON.parse(JSON.stringify(r.defaultValue));break;case"prefault":this.process(r.innerType,n),i.ref=r.innerType,"input"===this.io&&(t._prefault=JSON.parse(JSON.stringify(r.defaultValue)));break;case"catch":{let e;this.process(r.innerType,n),i.ref=r.innerType;try{e=r.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}t.default=e;break}case"nan":if("throw"===this.unrepresentable)throw new Error("NaN cannot be represented in JSON Schema");break;case"template_literal":{const n=t,r=e._zod.pattern;if(!r)throw new Error("Pattern not found in template literal");n.type="string",n.pattern=r.source;break}case"pipe":{const e="input"===this.io?"transform"===r.in._zod.def.type?r.out:r.in:r.out;this.process(e,n),i.ref=e;break}case"readonly":this.process(r.innerType,n),i.ref=r.innerType,t.readOnly=!0;break;case"lazy":{const t=e._zod.innerType;this.process(t,n),i.ref=t;break}case"custom":if("throw"===this.unrepresentable)throw new Error("Custom types cannot be represented in JSON Schema")}}}const c=this.metadataRegistry.get(e);return c&&Object.assign(i.schema,c),"input"===this.io&&Hf(e)&&(delete i.schema.examples,delete i.schema.default),"input"===this.io&&i.schema._prefault&&((n=i.schema).default??(n.default=i.schema._prefault)),delete i.schema._prefault,this.seen.get(e).schema}emit(e,t){const n={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},r=this.seen.get(e);if(!r)throw new Error("Unprocessed schema. This is a bug in Zod.");const s=e=>{const t="draft-2020-12"===this.target?"$defs":"definitions";if(n.external){const r=n.external.registry.get(e[0])?.id,s=n.external.uri??(e=>e);if(r)return{ref:s(r)};const a=e[1].defId??e[1].schema.id??"schema"+this.counter++;return e[1].defId=a,{defId:a,ref:`${s("__shared")}#/${t}/${a}`}}if(e[1]===r)return{ref:"#"};const s=`#/${t}/`,a=e[1].schema.id??"__schema"+this.counter++;return{defId:a,ref:s+a}},a=e=>{if(e[1].schema.$ref)return;const t=e[1],{ref:n,defId:r}=s(e);t.def={...t.schema},r&&(t.defId=r);const a=t.schema;for(const e in a)delete a[e];a.$ref=n};if("throw"===n.cycles)for(const e of this.seen.entries()){const t=e[1];if(t.cycle)throw new Error(`Cycle detected: #/${t.cycle?.join("/")}/<root>\n\nSet the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const t of this.seen.entries()){const r=t[1];if(e===t[0]){a(t);continue}if(n.external){const r=n.external.registry.get(t[0])?.id;if(e!==t[0]&&r){a(t);continue}}const s=this.metadataRegistry.get(t[0])?.id;(s||r.cycle||r.count>1&&"ref"===n.reused)&&a(t)}const i=(e,t)=>{const n=this.seen.get(e),r=n.def??n.schema,s={...r};if(null===n.ref)return;const a=n.ref;if(n.ref=null,a){i(a,t);const e=this.seen.get(a).schema;e.$ref&&"draft-7"===t.target?(r.allOf=r.allOf??[],r.allOf.push(e)):(Object.assign(r,e),Object.assign(r,s))}n.isParent||this.override({zodSchema:e,jsonSchema:r,path:n.path??[]})};for(const e of[...this.seen.entries()].reverse())i(e[0],{target:this.target});const o={};if("draft-2020-12"===this.target?o.$schema="https://json-schema.org/draft/2020-12/schema":"draft-7"===this.target?o.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),n.external?.uri){const t=n.external.registry.get(e)?.id;if(!t)throw new Error("Schema is missing an `id` property");o.$id=n.external.uri(t)}Object.assign(o,r.def);const c=n.external?.defs??{};for(const e of this.seen.entries()){const t=e[1];t.def&&t.defId&&(c[t.defId]=t.def)}n.external||Object.keys(c).length>0&&("draft-2020-12"===this.target?o.$defs=c:o.definitions=c);try{return JSON.parse(JSON.stringify(o))}catch(e){throw new Error("Error converting schema to JSON.")}}}function Vf(e,t){if(e instanceof Du){const n=new qf(t),r={};for(const t of e._idmap.entries()){const[e,r]=t;n.process(r)}const s={},a={registry:e,uri:t?.uri,defs:r};for(const r of e._idmap.entries()){const[e,i]=r;s[e]=n.emit(i,{...t,external:a})}if(Object.keys(r).length>0){const e="draft-2020-12"===n.target?"$defs":"definitions";s.__shared={[e]:r}}return{schemas:s}}const n=new qf(t);return n.process(e),n.emit(e,t)}function Hf(e,t){const n=t??{seen:new Set};if(n.seen.has(e))return!1;n.seen.add(e);const r=e._zod.def;switch(r.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":case"custom":case"success":case"catch":return!1;case"array":return Hf(r.element,n);case"object":for(const e in r.shape)if(Hf(r.shape[e],n))return!0;return!1;case"union":for(const e of r.options)if(Hf(e,n))return!0;return!1;case"intersection":return Hf(r.left,n)||Hf(r.right,n);case"tuple":for(const e of r.items)if(Hf(e,n))return!0;return!(!r.rest||!Hf(r.rest,n));case"record":case"map":return Hf(r.keyType,n)||Hf(r.valueType,n);case"set":return Hf(r.valueType,n);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":case"default":case"prefault":return Hf(r.innerType,n);case"lazy":return Hf(r.getter(),n);case"transform":return!0;case"pipe":return Hf(r.in,n)||Hf(r.out,n)}throw new Error(`Unknown schema type: ${r.type}`)}function Wf(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(!Wf(e[r],t[r]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n)if(!Wf(e[r],t[r]))return!1;return!0}return e===t}function Gf(e){return encodeURI(function(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}(e))}const Jf={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},Kf={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},Xf={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let Yf="undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function Qf(e,t=Object.create(null),n=Yf,r=""){if(e&&"object"==typeof e&&!Array.isArray(e)){const s=e.$id||e.id;if(s){const a=new URL(s,n.href);a.hash.length>1?t[a.href]=e:(a.hash="",""===r?n=a:Qf(e,t,n))}}else if(!0!==e&&!1!==e)return t;const s=n.href+(r?"#"+r:"");if(void 0!==t[s])throw new Error(`Duplicate schema URI "${s}".`);if(t[s]=e,!0===e||!1===e)return t;if(void 0===e.__absolute_uri__&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:s}),e.$ref&&void 0===e.__absolute_ref__){const t=new URL(e.$ref,n.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:t.href})}if(e.$recursiveRef&&void 0===e.__absolute_recursive_ref__){const t=new URL(e.$recursiveRef,n.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:t.href})}e.$anchor&&(t[new URL("#"+e.$anchor,n.href).href]=e);for(let s in e){if(Xf[s])continue;const a=`${r}/${Gf(s)}`,i=e[s];if(Array.isArray(i)){if(Jf[s]){const e=i.length;for(let r=0;r<e;r++)Qf(i[r],t,n,`${a}/${r}`)}}else if(Kf[s])for(let e in i)Qf(i[e],t,n,`${a}/${Gf(e)}`);else Qf(i,t,n,a)}return t}const eg=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,tg=[0,31,28,31,30,31,30,31,31,30,31,30,31],ng=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i;function rg(e){return e.test.bind(e)}const sg={date:ag,time:ig.bind(void 0,!1),"date-time":function(e){const t=e.split(og);return 2==t.length&&ag(t[0])&&ig(!0,t[1])},duration:e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),uri:function(e){return cg.test(e)&&lg.test(e)},"uri-reference":rg(/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i),"uri-template":rg(/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i),url:rg(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu),email:e=>{if('"'===e[0])return!1;const[t,n,...r]=e.split("@");return!(!t||!n||0!==r.length||t.length>64||n.length>253)&&"."!==t[0]&&!t.endsWith(".")&&!t.includes("..")&&!(!/^[a-z0-9.-]+$/i.test(n)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t))&&n.split(".").every(e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e))},hostname:rg(/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i),ipv4:rg(/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/),ipv6:rg(/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i),regex:function(e){if(ug.test(e))return!1;try{return new RegExp(e,"u"),!0}catch(e){return!1}},uuid:rg(/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i),"json-pointer":rg(/^(?:\/(?:[^~/]|~0|~1)*)*$/),"json-pointer-uri-fragment":rg(/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i),"relative-json-pointer":rg(/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/)};function ag(e){const t=e.match(eg);if(!t)return!1;const n=+t[1],r=+t[2],s=+t[3];return r>=1&&r<=12&&s>=1&&s<=(2==r&&function(e){return e%4==0&&(e%100!=0||e%400==0)}(n)?29:tg[r])}function ig(e,t){const n=t.match(ng);if(!n)return!1;const r=+n[1],s=+n[2],a=+n[3],i=!!n[5];return(r<=23&&s<=59&&a<=59||23==r&&59==s&&60==a)&&(!e||i)}const og=/t|\s/i,cg=/\/|:/,lg=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,ug=/[^\\]\\Z/;var dg;function pg(e,t,n="2019-09",r=Qf(t),s=!0,a=null,i="#",o="#",c=Object.create(null)){if(!0===t)return{valid:!0,errors:[]};if(!1===t)return{valid:!1,errors:[{instanceLocation:i,keyword:"false",keywordLocation:i,error:"False boolean schema."}]};const l=typeof e;let u;switch(l){case"boolean":case"number":case"string":u=l;break;case"object":u=null===e?"null":Array.isArray(e)?"array":"object";break;default:throw new Error(`Instances of "${l}" type are not supported.`)}const{$ref:d,$recursiveRef:p,$recursiveAnchor:h,type:m,const:f,enum:g,required:y,not:_,anyOf:v,allOf:w,oneOf:b,if:x,then:k,else:T,format:I,properties:E,patternProperties:O,additionalProperties:S,unevaluatedProperties:A,minProperties:$,maxProperties:C,propertyNames:N,dependentRequired:P,dependentSchemas:R,dependencies:j,prefixItems:L,items:M,additionalItems:z,unevaluatedItems:U,contains:D,minContains:F,maxContains:B,minItems:Z,maxItems:q,uniqueItems:V,minimum:H,maximum:W,exclusiveMinimum:G,exclusiveMaximum:J,multipleOf:K,minLength:X,maxLength:Y,pattern:Q,__absolute_ref__:ee,__absolute_recursive_ref__:te}=t,ne=[];if(!0===h&&null===a&&(a=t),"#"===p){const l=null===a?r[te]:a,u=`${o}/$recursiveRef`,d=pg(e,null===a?t:a,n,r,s,l,i,u,c);d.valid||ne.push({instanceLocation:i,keyword:"$recursiveRef",keywordLocation:u,error:"A subschema had errors."},...d.errors)}if(void 0!==d){const t=r[ee||d];if(void 0===t){let e=`Unresolved $ref "${d}".`;throw ee&&ee!==d&&(e+=`  Absolute URI "${ee}".`),e+=`\nKnown schemas:\n- ${Object.keys(r).join("\n- ")}`,new Error(e)}const l=`${o}/$ref`,u=pg(e,t,n,r,s,a,i,l,c);if(u.valid||ne.push({instanceLocation:i,keyword:"$ref",keywordLocation:l,error:"A subschema had errors."},...u.errors),"4"===n||"7"===n)return{valid:0===ne.length,errors:ne}}if(Array.isArray(m)){let t=m.length,n=!1;for(let r=0;r<t;r++)if(u===m[r]||"integer"===m[r]&&"number"===u&&e%1==0&&e==e){n=!0;break}n||ne.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m.join('", "')}".`})}else"integer"===m?("number"!==u||e%1||e!=e)&&ne.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m}".`}):void 0!==m&&u!==m&&ne.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${m}".`});if(void 0!==f&&("object"===u||"array"===u?Wf(e,f)||ne.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(f)}.`}):e!==f&&ne.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(f)}.`})),void 0!==g&&("object"===u||"array"===u?g.some(t=>Wf(e,t))||ne.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some(t=>e===t)||ne.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),void 0!==_){const t=`${o}/not`;pg(e,_,n,r,s,a,i,t).valid&&ne.push({instanceLocation:i,keyword:"not",keywordLocation:t,error:'Instance matched "not" schema.'})}let re=[];if(void 0!==v){const t=`${o}/anyOf`,l=ne.length;let u=!1;for(let o=0;o<v.length;o++){const l=v[o],d=Object.create(c),p=pg(e,l,n,r,s,!0===h?a:null,i,`${t}/${o}`,d);ne.push(...p.errors),u=u||p.valid,p.valid&&re.push(d)}u?ne.length=l:ne.splice(l,0,{instanceLocation:i,keyword:"anyOf",keywordLocation:t,error:"Instance does not match any subschemas."})}if(void 0!==w){const t=`${o}/allOf`,l=ne.length;let u=!0;for(let o=0;o<w.length;o++){const l=w[o],d=Object.create(c),p=pg(e,l,n,r,s,!0===h?a:null,i,`${t}/${o}`,d);ne.push(...p.errors),u=u&&p.valid,p.valid&&re.push(d)}u?ne.length=l:ne.splice(l,0,{instanceLocation:i,keyword:"allOf",keywordLocation:t,error:"Instance does not match every subschema."})}if(void 0!==b){const t=`${o}/oneOf`,l=ne.length,u=b.filter((o,l)=>{const u=Object.create(c),d=pg(e,o,n,r,s,!0===h?a:null,i,`${t}/${l}`,u);return ne.push(...d.errors),d.valid&&re.push(u),d.valid}).length;1===u?ne.length=l:ne.splice(l,0,{instanceLocation:i,keyword:"oneOf",keywordLocation:t,error:`Instance does not match exactly one subschema (${u} matches).`})}if("object"!==u&&"array"!==u||Object.assign(c,...re),void 0!==x){const t=`${o}/if`;if(pg(e,x,n,r,s,a,i,t,c).valid){if(void 0!==k){const l=pg(e,k,n,r,s,a,i,`${o}/then`,c);l.valid||ne.push({instanceLocation:i,keyword:"if",keywordLocation:t,error:'Instance does not match "then" schema.'},...l.errors)}}else if(void 0!==T){const l=pg(e,T,n,r,s,a,i,`${o}/else`,c);l.valid||ne.push({instanceLocation:i,keyword:"if",keywordLocation:t,error:'Instance does not match "else" schema.'},...l.errors)}}if("object"===u){if(void 0!==y)for(const t of y)t in e||ne.push({instanceLocation:i,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${t}".`});const t=Object.keys(e);if(void 0!==$&&t.length<$&&ne.push({instanceLocation:i,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${$} properties.`}),void 0!==C&&t.length>C&&ne.push({instanceLocation:i,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${C} properties.`}),void 0!==N){const t=`${o}/propertyNames`;for(const o in e){const e=`${i}/${Gf(o)}`,c=pg(o,N,n,r,s,a,e,t);c.valid||ne.push({instanceLocation:i,keyword:"propertyNames",keywordLocation:t,error:`Property name "${o}" does not match schema.`},...c.errors)}}if(void 0!==P){const t=`${o}/dependantRequired`;for(const n in P)if(n in e){const r=P[n];for(const s of r)s in e||ne.push({instanceLocation:i,keyword:"dependentRequired",keywordLocation:t,error:`Instance has "${n}" but does not have "${s}".`})}}if(void 0!==R)for(const t in R){const l=`${o}/dependentSchemas`;if(t in e){const o=pg(e,R[t],n,r,s,a,i,`${l}/${Gf(t)}`,c);o.valid||ne.push({instanceLocation:i,keyword:"dependentSchemas",keywordLocation:l,error:`Instance has "${t}" but does not match dependant schema.`},...o.errors)}}if(void 0!==j){const t=`${o}/dependencies`;for(const o in j)if(o in e){const c=j[o];if(Array.isArray(c))for(const n of c)n in e||ne.push({instanceLocation:i,keyword:"dependencies",keywordLocation:t,error:`Instance has "${o}" but does not have "${n}".`});else{const l=pg(e,c,n,r,s,a,i,`${t}/${Gf(o)}`);l.valid||ne.push({instanceLocation:i,keyword:"dependencies",keywordLocation:t,error:`Instance has "${o}" but does not match dependant schema.`},...l.errors)}}}const l=Object.create(null);let u=!1;if(void 0!==E){const t=`${o}/properties`;for(const o in E){if(!(o in e))continue;const d=`${i}/${Gf(o)}`,p=pg(e[o],E[o],n,r,s,a,d,`${t}/${Gf(o)}`);if(p.valid)c[o]=l[o]=!0;else if(u=s,ne.push({instanceLocation:i,keyword:"properties",keywordLocation:t,error:`Property "${o}" does not match schema.`},...p.errors),u)break}}if(!u&&void 0!==O){const t=`${o}/patternProperties`;for(const o in O){const d=new RegExp(o,"u"),p=O[o];for(const h in e){if(!d.test(h))continue;const m=`${i}/${Gf(h)}`,f=pg(e[h],p,n,r,s,a,m,`${t}/${Gf(o)}`);f.valid?c[h]=l[h]=!0:(u=s,ne.push({instanceLocation:i,keyword:"patternProperties",keywordLocation:t,error:`Property "${h}" matches pattern "${o}" but does not match associated schema.`},...f.errors))}}}if(u||void 0===S){if(!u&&void 0!==A){const t=`${o}/unevaluatedProperties`;for(const o in e)if(!c[o]){const l=`${i}/${Gf(o)}`,u=pg(e[o],A,n,r,s,a,l,t);u.valid?c[o]=!0:ne.push({instanceLocation:i,keyword:"unevaluatedProperties",keywordLocation:t,error:`Property "${o}" does not match unevaluated properties schema.`},...u.errors)}}}else{const t=`${o}/additionalProperties`;for(const o in e){if(l[o])continue;const d=`${i}/${Gf(o)}`,p=pg(e[o],S,n,r,s,a,d,t);p.valid?c[o]=!0:(u=s,ne.push({instanceLocation:i,keyword:"additionalProperties",keywordLocation:t,error:`Property "${o}" does not match additional properties schema.`},...p.errors))}}}else if("array"===u){void 0!==q&&e.length>q&&ne.push({instanceLocation:i,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${e.length} > ${q}).`}),void 0!==Z&&e.length<Z&&ne.push({instanceLocation:i,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${e.length} < ${Z}).`});const t=e.length;let l=0,u=!1;if(void 0!==L){const d=`${o}/prefixItems`,p=Math.min(L.length,t);for(;l<p;l++){const t=pg(e[l],L[l],n,r,s,a,`${i}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(u=s,ne.push({instanceLocation:i,keyword:"prefixItems",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}}if(void 0!==M){const d=`${o}/items`;if(Array.isArray(M)){const o=Math.min(M.length,t);for(;l<o;l++){const t=pg(e[l],M[l],n,r,s,a,`${i}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(u=s,ne.push({instanceLocation:i,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}}else for(;l<t;l++){const t=pg(e[l],M,n,r,s,a,`${i}/${l}`,d);if(c[l]=!0,!t.valid&&(u=s,ne.push({instanceLocation:i,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}if(!u&&void 0!==z){const d=`${o}/additionalItems`;for(;l<t;l++){const t=pg(e[l],z,n,r,s,a,`${i}/${l}`,d);c[l]=!0,t.valid||(u=s,ne.push({instanceLocation:i,keyword:"additionalItems",keywordLocation:d,error:"Items did not match additional items schema."},...t.errors))}}}if(void 0!==D)if(0===t&&void 0===F)ne.push({instanceLocation:i,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(void 0!==F&&t<F)ne.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${t}) than minContains (${F}).`});else{const l=`${o}/contains`,u=ne.length;let d=0;for(let o=0;o<t;o++){const t=pg(e[o],D,n,r,s,a,`${i}/${o}`,l);t.valid?(c[o]=!0,d++):ne.push(...t.errors)}d>=(F||0)&&(ne.length=u),void 0===F&&void 0===B&&0===d?ne.splice(u,0,{instanceLocation:i,keyword:"contains",keywordLocation:l,error:"Array does not contain item matching schema."}):void 0!==F&&d<F?ne.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${F} items matching schema. Only ${d} items were found.`}):void 0!==B&&d>B&&ne.push({instanceLocation:i,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${B} items matching schema. ${d} items were found.`})}if(!u&&void 0!==U){const u=`${o}/unevaluatedItems`;for(;l<t;l++){if(c[l])continue;const t=pg(e[l],U,n,r,s,a,`${i}/${l}`,u);c[l]=!0,t.valid||ne.push({instanceLocation:i,keyword:"unevaluatedItems",keywordLocation:u,error:"Items did not match unevaluated items schema."},...t.errors)}}if(V)for(let n=0;n<t;n++){const r=e[n],s="object"==typeof r&&null!==r;for(let a=0;a<t;a++){if(n===a)continue;const t=e[a];(r===t||s&&"object"==typeof t&&null!==t&&Wf(r,t))&&(ne.push({instanceLocation:i,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${n} and ${a}.`}),n=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER)}}}else if("number"===u){if("4"===n?(void 0!==H&&(!0===G&&e<=H||e<H)&&ne.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${G?"or equal to ":""} ${H}.`}),void 0!==W&&(!0===J&&e>=W||e>W)&&ne.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${J?"or equal to ":""} ${W}.`})):(void 0!==H&&e<H&&ne.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${H}.`}),void 0!==W&&e>W&&ne.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${W}.`}),void 0!==G&&e<=G&&ne.push({instanceLocation:i,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${e} is less than ${G}.`}),void 0!==J&&e>=J&&ne.push({instanceLocation:i,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${e} is greater than or equal to ${J}.`})),void 0!==K){const t=e%K;Math.abs(0-t)>=1.1920929e-7&&Math.abs(K-t)>=1.1920929e-7&&ne.push({instanceLocation:i,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${e} is not a multiple of ${K}.`})}}else if("string"===u){const t=void 0===X&&void 0===Y?0:function(e){let t,n=0,r=e.length,s=0;for(;s<r;)n++,t=e.charCodeAt(s++),t>=55296&&t<=56319&&s<r&&(t=e.charCodeAt(s),56320==(64512&t)&&s++);return n}(e);void 0!==X&&t<X&&ne.push({instanceLocation:i,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${t} < ${X}).`}),void 0!==Y&&t>Y&&ne.push({instanceLocation:i,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${t} > ${Y}).`}),void 0===Q||new RegExp(Q,"u").test(e)||ne.push({instanceLocation:i,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),void 0!==I&&sg[I]&&!sg[I](e)&&ne.push({instanceLocation:i,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${I}".`})}return{valid:0===ne.length,errors:ne}}!function(e){e[e.Flag=1]="Flag",e[e.Basic=2]="Basic",e[e.Detailed=4]="Detailed"}(dg||(dg={}));class hg{schema;draft;shortCircuit;lookup;constructor(e,t="2019-09",n=!0){this.schema=e,this.draft=t,this.shortCircuit=n,this.lookup=Qf(e)}validate(e){return pg(e,this.schema,this.draft,this.lookup,this.shortCircuit)}addSchema(e,t){t&&(e={...e,$id:t}),Qf(e,this.lookup)}}function mg(e,t){if(Xp(e)){const n=Th(e,!0);return ph(n)?Vf(wh(n,!0),t):Vf(e,t)}return Yp(e)?((e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...$h,name:e}:{...$h,...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t);let r;const s=t?.name,a=Ff(e._def,void 0===s?n:{...n,currentPath:[...n.basePath,n.definitionPath,s]},!1)??Nh(n);n.flags.hasReferencedOpenAiAnyType&&(r||(r={}),r[n.openAiAnyTypeName]||(r[n.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===n.$refStrategy?"1":[...n.basePath,n.definitionPath,n.openAiAnyTypeName].join("/")}}));const i=void 0===s?r?{...a,[n.definitionPath]:r}:a:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...r,[s]:a}};return"jsonSchema7"===n.target?i.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"!==n.target&&"openAi"!==n.target||(i.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===n.target&&("anyOf"in i||"oneOf"in i||"allOf"in i||"type"in i&&Array.isArray(i.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),i})(e):e}function fg(e){if(!e||"object"!=typeof e||0===Object.keys(e).length||Array.isArray(e))return!1;if("type"in e)return"string"==typeof e.type?"string"===e.type:!!Array.isArray(e.type)&&e.type.every(e=>"string"===e);if("enum"in e)return Array.isArray(e.enum)&&e.enum.length>0&&e.enum.every(e=>"string"==typeof e);if("const"in e)return"string"==typeof e.const;if("allOf"in e&&Array.isArray(e.allOf))return e.allOf.some(e=>fg(e));if("anyOf"in e&&Array.isArray(e.anyOf)||"oneOf"in e&&Array.isArray(e.oneOf)){const t="anyOf"in e?e.anyOf:e.oneOf;return t.length>0&&t.every(e=>fg(e))}if("not"in e)return!1;if("$ref"in e&&"string"==typeof e.$ref){const t=e.$ref,n=Qf(e);return!!n[t]&&fg(n[t])}return!1}function gg(e,t){if(void 0!==e&&!Ko(e))return e;if(!Xl(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch{return t.getName()}}function yg(e){return Xl(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...mg(e.data.schema),title:e.data.name}}}Yr({},{Validator:()=>hg,deepCompareStrict:()=>Wf,toJsonSchema:()=>mg,validatesOnlyStrings:()=>fg}),Yr({},{Graph:()=>_g});var _g=class e{nodes={};edges=[];constructor(e){this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,n)=>{e[t.id]=Ko(t.id)?n:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...yg(t)})),edges:this.edges.map(t=>{const n={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(n.data=t.data),void 0!==t.conditional&&(n.conditional=t.conditional),n})}}addNode(e,t,n){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const r=t??Oi(),s={id:r,data:e,name:gg(t,e),metadata:n};return this.nodes[r]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,n,r){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const s={source:e.id,target:t.id,data:n,conditional:r};return this.edges.push(s),s}firstNode(){return vg(this)}lastNode(){return wg(this)}extend(e,t=""){let n=t;Object.values(e.nodes).map(e=>e.id).every(Ko)&&(n="");const r=e=>n?`${n}:${e}`:e;Object.entries(e.nodes).forEach(([e,t])=>{this.nodes[r(e)]={...t,id:r(e)}});const s=e.edges.map(e=>({...e,source:r(e.source),target:r(e.target)}));this.edges=[...this.edges,...s];const a=e.firstNode(),i=e.lastNode();return[a?{id:r(a.id),data:a.data}:void 0,i?{id:r(i.id),data:i.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&vg(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&wg(this,[e.id])&&this.removeNode(e)}reid(){const t=Object.fromEntries(Object.values(this.nodes).map(e=>[e.id,e.name])),n=new Map;Object.values(t).forEach(e=>{n.set(e,(n.get(e)||0)+1)});const r=e=>{const r=t[e];return Ko(e)&&1===n.get(r)?r:e};return new e({nodes:Object.fromEntries(Object.entries(this.nodes).map(([e,t])=>[r(e),{...t,id:r(e)}])),edges:this.edges.map(e=>({...e,source:r(e.source),target:r(e.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:n,nodeColors:r={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:s}=e??{},a=this.reid(),i=a.firstNode(),o=a.lastNode();return function(e,t,n){const{firstNode:r,lastNode:s,nodeColors:a,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=n??{};let l=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(i){const t="default",n={[t]:"{0}({1})"};void 0!==r&&(n[r]="{0}([{1}]):::first"),void 0!==s&&(n[s]="{0}([{1}]):::last");for(const[r,s]of Object.entries(e)){const e=s.name.split(":").pop()??"";let a=Sh.some(t=>e.startsWith(t)&&e.endsWith(t))?`<p>${e}</p>`:e;Object.keys(s.metadata??{}).length&&(a+=`<hr/><small><em>${Object.entries(s.metadata??{}).map(([e,t])=>`${e} = ${t}`).join("\n")}</em></small>`);const i=(n[r]??n[t]).replace("{0}",Oh(r)).replace("{1}",a);l+=`\t${i}\n`}}const u={};for(const e of t){const t=e.source.split(":"),n=e.target.split(":"),r=t.filter((e,t)=>e===n[t]).join(":");u[r]||(u[r]=[]),u[r].push(e)}const d=new Set;function p(e,t){const n=1===e.length&&e[0].source===e[0].target;if(t&&!n){const e=t.split(":").pop();if(d.has(t))throw new Error(`Found duplicate subgraph '${e}' at '${t} -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(t),l+=`\tsubgraph ${e}\n`}const r=(s=Object.keys(u).filter(e=>e.startsWith(`${t}:`)&&e!==t&&e.split(":").length===t.split(":").length+1),[...s].sort((e,t)=>e.split(":").length-t.split(":").length));var s;for(const e of r)p(u[e],e);for(const t of e){const{source:e,target:n,data:r,conditional:s}=t;let a="";if(void 0!==r){let e=r;const t=e.split(" ");t.length>c&&(e=Array.from({length:Math.ceil(t.length/c)},(e,n)=>t.slice(n*c,(n+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),a=s?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --\x3e `}else a=s?" -.-> ":" --\x3e ";l+=`\t${Oh(e)}${a}${Oh(n)};\n`}t&&!n&&(l+="\tend\n")}p(u[""]??[],"");for(const e in u)e.includes(":")||""===e||p(u[e],e);return i&&(l+=function(e){let t="";for(const[n,r]of Object.entries(e))t+=`\tclassDef ${n} ${r};\n`;return t}(a??{})),l}(a.nodes,a.edges,{firstNode:i?.id,lastNode:o?.id,withStyles:t,curveStyle:n,nodeColors:r,wrapLabelNWords:s})}async drawMermaidPng(e){return async function(e,t){let n=t?.backgroundColor??"white";const r=t?.imageType??"png",s=(e=>btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""))(e);void 0!==n&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const a=`https://mermaid.ink/img/${s}?bgColor=${n}&type=${r}`,i=await fetch(a);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join("\n"));return await i.blob()}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}};function vg(e,t=[]){const n=new Set(e.edges.filter(e=>!t.includes(e.source)).map(e=>e.target)),r=[];for(const s of Object.values(e.nodes))t.includes(s.id)||n.has(s.id)||r.push(s);return 1===r.length?r[0]:void 0}function wg(e,t=[]){const n=new Set(e.edges.filter(e=>!t.includes(e.target)).map(e=>e.source)),r=[];for(const s of Object.values(e.nodes))t.includes(s.id)||n.has(s.id)||r.push(s);return 1===r.length?r[0]:void 0}function bg(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function xg(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*kg(e,t){for(;;){const{value:n,done:r}=qc.runWithConfig(Kc(e),t.next.bind(t),!0);if(r)break;yield n}}async function*Tg(e,t){const n=t[Symbol.asyncIterator]();for(;;){const{value:r,done:s}=await qc.runWithConfig(Kc(e),n.next.bind(t),!0);if(s)break;yield r}}function Ig(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}var Eg=class extends fs{lc_runnable=!0;name;getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}withRetry(e){return new Ag({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new Og({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new jg({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Gc);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter(([e])=>"runId"!==e));return Array.from({length:t},(t,r)=>Gc(0===r?e:n))}return Array.from({length:t},()=>Gc(e))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),s=r[0]?.maxConcurrency??n?.maxConcurrency,a=new Jl({maxConcurrency:s,onFailedAttempt:e=>{throw e}}),i=e.map((e,t)=>a.call(async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}));return Promise.all(i)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=Gc(t),r=new nl({generator:this._streamIterator(e,n),config:n});return await r.setup,Qc.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;t=Gc(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,delete n.timeout,delete n.signal,[t,n]}async _callWithConfig(e,t,n){const r=Gc(n),s=await Vc(r),a=await(s?.handleChainStart(this.toJSON(),Ig(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let i;delete r.runId;try{const s=e.call(this,t,r,a);i=await Xc(s,n?.signal)}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(Ig(i,"output"))),i}async _batchWithConfig(e,t,n,r){const s=this._getOptionsList(n??{},t.length),a=await Promise.all(s.map(Vc)),i=await Promise.all(a.map(async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),Ig(t[n],"input"),s[n].runId,s[n].runType,void 0,void 0,s[n].runName??this.getName()));return delete s[n].runId,r}));let o;try{const n=e.call(this,t,s,i,r);o=await Xc(n,s?.[0]?.signal)}catch(e){throw await Promise.all(i.map(t=>t?.handleChainError(e))),e}return await Promise.all(i.map(e=>e?.handleChainEnd(Ig(o,"output")))),o}_concatOutputChunks(e,t){return tl(e,t)}async*_transformStreamWithConfig(e,t,n){let r,s,a=!0,i=!0;const o=Gc(n),c=await Vc(o),l=this;let u;try{const d=await rl(t.bind(this),async function*(){for await(const t of e){if(a)if(void 0===r)r=t;else try{r=l._concatOutputChunks(r,t)}catch{r=void 0,a=!1}yield t}}(),async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName(),void 0,{lc_defers_inputs:!0}),n?.signal,o);delete o.runId,u=d.setup;const p=u?.handlers.find(zl);let h=d.output;void 0!==p&&void 0!==u&&(h=p.tapOutputIterable(u.runId,h));const m=u?.handlers.find($l);void 0!==m&&void 0!==u&&(h=m.tapOutputIterable(u.runId,h));for await(const e of h)if(yield e,i)if(void 0===s)s=e;else try{s=this._concatOutputChunks(s,e)}catch{s=void 0,i=!1}}catch(e){throw await(u?.handleChainError(e,void 0,void 0,void 0,{inputs:Ig(r,"input")})),e}await(u?.handleChainEnd(s??{},void 0,void 0,void 0,{inputs:Ig(r,"input")}))}getGraph(e){const t=new _g,n=t.addNode({name:`${this.getName()}Input`,schema:hf()}),r=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:hf()});return t.addEdge(n,r),t.addEdge(r,s),t}pipe(e){return new $g({first:this,last:Lg(e)})}pick(e){return this.pipe(new zg(e))}assign(e){return this.pipe(new Mg(new Cg({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:this._concatOutputChunks(n,t);yield*this._streamIterator(n,Gc(t))}async*streamLog(e,t,n){const r=new Pl({...n,autoClose:!1,_schemaFormat:"original"}),s=Gc(t);yield*this._streamLog(e,r,s)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.addHandler(t,!0),n.callbacks=e}const s=this.stream(e,n),a=async function(){try{const e=await s;for await(const n of e){const e=new Sl({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await a}}streamEvents(e,t,n){let r;if("v1"===t.version)r=this._streamEventsV1(e,t,n);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');r=this._streamEventsV2(e,t,n)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return Qc.fromReadableStream(n)}(r):Qc.fromAsyncGenerator(r)}async*_streamEventsV2(e,t,n){const r=new Ul({...n,autoClose:!1}),s=Gc(t),a=s.runId??Oi();s.runId=a;const i=s.callbacks;if(void 0===i)s.callbacks=[r];else if(Array.isArray(i))s.callbacks=i.concat(r);else{const e=i.copy();e.addHandler(r,!0),s.callbacks=e}const o=new AbortController,c=this,l=async function(){let n,i=null;try{t?.signal?"any"in AbortSignal?n=AbortSignal.any([o.signal,t.signal]):(n=t.signal,i=()=>{o.abort()},t.signal.addEventListener("abort",i,{once:!0})):n=o.signal;const l=await c.stream(e,{...s,signal:n}),u=r.tapOutputIterable(a,l);for await(const e of u)if(o.signal.aborted)break}finally{await r.finish(),n&&i&&n.removeEventListener("abort",i)}}();let u,d=!1;try{for await(const t of r)d?(t.run_id===u&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,d=!0,u=t.run_id,yield t)}finally{o.abort(),await l}}async*_streamEventsV1(e,t,n){let r,s=!1;const a=Gc(t),i=a.tags??[],o=a.metadata??{},c=a.runName??this.getName(),l=new Pl({...n,autoClose:!1,_schemaFormat:"streaming_events"}),u=new Yl({...n}),d=this._streamLog(e,l,a);for await(const t of d){if(r=r?r.concat(t):Al.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:i,metadata:o,data:{input:e}};u.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter(e=>e.path.startsWith("/logs/")).map(e=>e.path.split("/")[2]),a=[...new Set(n)];for(const e of a){let t,n={};const s=r.state.logs[e];if(t=void 0===s.end_time?s.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==s.inputs&&(n.input=s.inputs);else if("end"===t)void 0!==s.inputs&&(n.input=s.inputs),n.output=s.final_output;else if("stream"===t){const e=s.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${s.name}"`);n={chunk:s.streamed_output[0]},s.streamed_output=[]}yield{event:`on_${s.type}_${t}`,name:s.name,run_id:s.id,tags:s.tags,metadata:s.metadata,data:n}}const{state:l}=r;if(l.streamed_output.length>0){const e=l.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${l.name}"`);const t={chunk:l.streamed_output[0]};l.streamed_output=[];const n={event:`on_${l.type}_stream`,run_id:l.id,tags:i,metadata:o,name:c,data:t};u.includeEvent(n,l.type)&&(yield n)}}const p=r?.state;if(void 0!==p){const e={event:`on_${p.type}_end`,name:c,run_id:p.id,tags:i,metadata:o,data:{output:p.final_output}};u.includeEvent(e,p.type)&&(yield e)}}static isRunnable(e){return Xl(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new Og({bound:this,config:{},configFactories:[r=>({callbacks:[new Kl({config:r,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return function(e,t){const n=t.name??e.getName(),r=t.description??ch(t.schema);return uh(t.schema)?new Ug({name:n,description:r,schema:mf({input:pf()}).transform(e=>e.input),bound:e}):new Ug({name:n,description:r,schema:t.schema,bound:e})}(this,e)}},Og=class e extends Eg{static lc_name(){return"RunnableBinding"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;bound;config;kwargs;configFactories;constructor(e){super(e),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=Hc(this.config,...e);return Hc(t,...this.configFactories?await Promise.all(this.configFactories.map(async e=>await e(t))):[])}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new Ag({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(t,this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map(async e=>this._mergeConfig(Gc(e),this.kwargs))):await this._mergeConfig(Gc(t),this.kwargs);return this.bound.batch(e,r,n)}_concatOutputChunks(e,t){return this.bound._concatOutputChunks(e,t)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(Gc(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(Gc(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(Gc(t),this.kwargs))}streamEvents(e,t,n){const r=this;return Qc.fromAsyncGenerator(async function*(){yield*r.bound.streamEvents(e,{...await r._mergeConfig(Gc(t),r.kwargs),version:t.version},n)}())}static isRunnableBinding(e){return e.bound&&Eg.isRunnable(e.bound)}withListeners({onStart:t,onEnd:n,onError:r}){return new e({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[e=>({callbacks:[new Kl({config:e,onStart:t,onEnd:n,onError:r})]})]})}},Sg=class e extends Eg{static lc_name(){return"RunnableEach"}lc_serializable=!0;lc_namespace=["langchain_core","runnables"];bound;constructor(e){super(e),this.bound=e.bound}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,n){return this.bound.batch(e,Jc(t,{callbacks:n?.getChild()}))}withListeners({onStart:t,onEnd:n,onError:r}){return new e({bound:this.bound.withListeners({onStart:t,onEnd:n,onError:r})})}},Ag=class extends Og{static lc_name(){return"RunnableRetry"}lc_namespace=["langchain_core","runnables"];maxAttemptNumber=3;onFailedAttempt=()=>{};constructor(e){super(e),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return Jc(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return Hl(r=>super.invoke(e,this._patchConfigForRetry(r,t,n)),{onFailedAttempt:({error:t})=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,n,r){const s={};try{await Hl(async a=>{const i=e.map((e,t)=>t).filter(e=>void 0===s[e.toString()]||s[e.toString()]instanceof Error),o=i.map(t=>e[t]),c=i.map(e=>this._patchConfigForRetry(a,t?.[e],n?.[e])),l=await super.batch(o,c,{...r,returnExceptions:!0});let u;for(let e=0;e<l.length;e+=1){const t=l[e],n=i[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),s[n.toString()]=t}if(u)throw u;return l},{onFailedAttempt:({error:e})=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(s).sort((e,t)=>parseInt(e,10)-parseInt(t,10)).map(e=>s[parseInt(e,10)])}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}},$g=class e extends Eg{static lc_name(){return"RunnableSequence"}first;middle=[];last;omitSequenceTags=!1;lc_serializable=!0;lc_namespace=["langchain_core","runnables"];constructor(e){super(e),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=Gc(t),r=await Vc(n),s=await(r?.handleChainStart(this.toJSON(),Ig(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let a,i=e;try{const e=[this.first,...this.middle];for(let r=0;r<e.length;r+=1){const a=e[r].invoke(i,Jc(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${r+1}`)}));i=await Xc(a,t?.signal)}if(t?.signal?.aborted)throw Yc(t.signal);a=await this.last.invoke(i,Jc(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(Ig(a,"output"))),a}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),s=await Promise.all(r.map(Vc)),a=await Promise.all(s.map(async(t,n)=>{const s=await(t?.handleChainStart(this.toJSON(),Ig(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,s}));let i=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e].batch(i,a.map((t,n)=>{const s=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return Jc(r[n],{callbacks:s})}),n);i=await Xc(t,r[0]?.signal)}}catch(e){throw await Promise.all(a.map(t=>t?.handleChainError(e))),e}return await Promise.all(a.map(e=>e?.handleChainEnd(Ig(i,"output")))),i}_concatOutputChunks(e,t){return this.last._concatOutputChunks(e,t)}async*_streamIterator(e,t){const n=await Vc(t),{runId:r,...s}=t??{},a=await(n?.handleChainStart(this.toJSON(),Ig(e,"input"),r,void 0,void 0,void 0,s?.runName)),i=[this.first,...this.middle,this.last];let o,c=!0;try{let n=i[0].transform(async function*(){yield e}(),Jc(s,{callbacks:a?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let e=1;e<i.length;e+=1){const t=i[e];n=await t.transform(n,Jc(s,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`)}))}for await(const e of n)if(t?.signal?.throwIfAborted(),yield e,c)if(void 0===o)o=e;else try{o=this._concatOutputChunks(o,e)}catch{o=void 0,c=!1}}catch(e){throw await(a?.handleChainError(e)),e}await(a?.handleChainEnd(Ig(o,"output")))}getGraph(e){const t=new _g;let n=null;return this.steps.forEach((r,s)=>{const a=r.getGraph(e);0!==s&&a.trimFirstNode(),s!==this.steps.length-1&&a.trimLastNode(),t.extend(a);const i=a.firstNode();if(!i)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,i),n=a.lastNode()}),t}pipe(t){return e.isRunnableSequence(t)?new e({first:this.first,middle:this.middle.concat([this.last,t.first,...t.middle]),last:t.last,name:this.name??t.name}):new e({first:this.first,middle:[...this.middle,this.last],last:Lg(t),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Eg.isRunnable(e)}static from([t,...n],r){let s={};return"string"==typeof r?s.name=r:void 0!==r&&(s=r),new e({...s,first:Lg(t),middle:n.slice(0,-1).map(Lg),last:Lg(n[n.length-1])})}},Cg=class e extends Eg{static lc_name(){return"RunnableMap"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;steps;getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=Lg(n)}static from(t){return new e({steps:t})}async invoke(e,t){const n=Gc(t),r=await Vc(n),s=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const a={};try{const r=Object.entries(this.steps).map(async([t,r])=>{a[t]=await r.invoke(e,Jc(n,{callbacks:s?.getChild(`map:key:${t}`)}))});await Xc(Promise.all(r),t?.signal)}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(a)),a}async*_transform(e,t,n){const r={...this.steps},s=el(e,Object.keys(r).length),a=new Map(Object.entries(r).map(([e,r],a)=>{const i=r.transform(s[a],Jc(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,i.next().then(t=>({key:e,gen:i,result:t}))]}));for(;a.size;){const e=Promise.race(a.values()),{key:t,result:r,gen:s}=await Xc(e,n?.signal);a.delete(t),r.done||(yield{[t]:r.value},a.set(t,s.next().then(e=>({key:t,gen:s,result:e}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Gc(t),r=new nl({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Qc.fromAsyncGenerator(r)}},Ng=class e extends Eg{lc_serializable=!1;lc_namespace=["langchain_core","runnables"];func;constructor(e){if(super(e),!Ic(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[n]=this._getOptionsList(t??{},1),r=await Vc(n);return Xc(this.func(Jc(n,{callbacks:r}),e),n?.signal)}async*_streamIterator(e,t){const[n]=this._getOptionsList(t??{},1),r=await this.invoke(e,t);var s;if(xg(r))for await(const e of r)n?.signal?.throwIfAborted(),yield e;else if(null!=(s=r)&&"object"==typeof s&&"next"in s&&"function"==typeof s.next)for(;;){n?.signal?.throwIfAborted();const e=r.next();if(e.done)break;yield e.value}else yield r}static from(t){return new e({func:t})}},Pg=class e extends Eg{static lc_name(){return"RunnableLambda"}lc_namespace=["langchain_core","runnables"];func;constructor(e){if(Ic(e.func))return Ng.from(e.func);super(e),function(e){if(Ic(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(t){return new e({func:t})}async _invoke(e,t,n){return new Promise((r,s)=>{const a=Jc(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});qc.runWithConfig(Kc(a),async()=>{try{let n=await this.func(e,{...a});if(n&&Eg.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...a,recursionLimit:(a.recursionLimit??25)-1})}else if(xg(n)){let e;for await(const r of Tg(a,n))if(t?.signal?.throwIfAborted(),void 0===e)e=r;else try{e=this._concatOutputChunks(e,r)}catch{e=r}n=e}else if(bg(n)){let e;for(const r of kg(a,n))if(t?.signal?.throwIfAborted(),void 0===e)e=r;else try{e=this._concatOutputChunks(e,r)}catch{e=r}n=e}r(n)}catch(e){s(e)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=this._concatOutputChunks(r,t)}catch{r=t}const s=Jc(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??25)-1}),a=await new Promise((e,t)=>{qc.runWithConfig(Kc(s),async()=>{try{const t=await this.func(r,{...s,config:s});e(t)}catch(e){t(e)}})});if(a&&Eg.isRunnable(a)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await a.stream(r,s);for await(const t of e)yield t}else if(xg(a))for await(const e of Tg(s,a))n?.signal?.throwIfAborted(),yield e;else if(bg(a))for(const e of kg(s,a))n?.signal?.throwIfAborted(),yield e;else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Gc(t),r=new nl({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Qc.fromAsyncGenerator(r)}},Rg=class extends Cg{},jg=class extends Eg{static lc_name(){return"RunnableWithFallbacks"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;runnable;fallbacks;constructor(e){super(e),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=Gc(t),r=await Vc(n),{runId:s,...a}=n,i=await(r?.handleChainStart(this.toJSON(),Ig(e,"input"),s,void 0,void 0,void 0,a?.runName)),o=Jc(a,{callbacks:i?.getChild()});return await qc.runWithConfig(o,async()=>{let t;for(const r of this.runnables()){n?.signal?.throwIfAborted();try{const t=await r.invoke(e,o);return await(i?.handleChainEnd(Ig(t,"output"))),t}catch(e){void 0===t&&(t=e)}}if(void 0===t)throw new Error("No error stored at end of fallback.");throw await(i?.handleChainError(t)),t})}async*_streamIterator(e,t){const n=Gc(t),r=await Vc(n),{runId:s,...a}=n,i=await(r?.handleChainStart(this.toJSON(),Ig(e,"input"),s,void 0,void 0,void 0,a?.runName));let o,c,l;for(const t of this.runnables()){n?.signal?.throwIfAborted();const r=Jc(a,{callbacks:i?.getChild()});try{c=Tg(r,await t.stream(e,r));break}catch(e){void 0===o&&(o=e)}}if(void 0===c){const e=o??new Error("No error stored at end of fallback.");throw await(i?.handleChainError(e)),e}try{for await(const e of c){yield e;try{l=void 0===l?l:this._concatOutputChunks(l,e)}catch{l=void 0}}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(Ig(l,"output")))}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),s=await Promise.all(r.map(e=>Vc(e))),a=await Promise.all(s.map(async(t,n)=>{const s=await(t?.handleChainStart(this.toJSON(),Ig(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,s}));let i;for(const t of this.runnables()){r[0].signal?.throwIfAborted();try{const s=await t.batch(e,a.map((e,t)=>Jc(r[t],{callbacks:e?.getChild()})),n);return await Promise.all(a.map((e,t)=>e?.handleChainEnd(Ig(s[t],"output")))),s}catch(e){void 0===i&&(i=e)}}if(!i)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(a.map(e=>e?.handleChainError(i))),i}};function Lg(e){if("function"==typeof e)return new Pg({func:e});if(Eg.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=Lg(r);return new Cg({steps:t})}}var Mg=class extends Eg{static lc_name(){return"RunnableAssign"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;mapper;constructor(e){e instanceof Cg&&(e={mapper:e}),super(e),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[s,a]=el(e),i=this.mapper.transform(a,Jc(n,{callbacks:t?.getChild()})),o=i.next();for await(const e of s){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter(([e])=>!r.includes(e)));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of i)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Gc(t),r=new nl({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Qc.fromAsyncGenerator(r)}},zg=class extends Eg{static lc_name(){return"RunnablePick"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;keys;constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map(t=>[t,e[t]]).filter(e=>void 0!==e[1]);return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Gc(t),r=new nl({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Qc.fromAsyncGenerator(r)}},Ug=class extends Og{name;description;schema;constructor(e){super({bound:$g.from([Pg.from(async e=>{let t;if(Ia(e))try{t=await ah(this.schema,e.args)}catch{throw new Ea("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}};const Dg=(e,t)=>{const n=[...new Set(t?.map(e=>{if("string"==typeof e)return e;const t=new e({});if(!("getType"in t)||"function"!=typeof t.getType)throw new Error("Invalid type provided.");return t.getType()}))],r=e.getType();return n.some(e=>e===r)};function Fg(e,t){return Array.isArray(e)?Bg(e,t):Pg.from(t=>Bg(t,e))}function Bg(e,t={}){const{includeNames:n,excludeNames:r,includeTypes:s,excludeTypes:a,includeIds:i,excludeIds:o}=t,c=[];for(const t of e)r&&t.name&&r.includes(t.name)||a&&Dg(t,a)||o&&t.id&&o.includes(t.id)||(s||i||n?(n&&t.name&&n.some(e=>e===t.name)||s&&Dg(t,s)||i&&t.id&&i.some(e=>e===t.id))&&c.push(t):c.push(t));return c}function Zg(e){return Array.isArray(e)?qg(e):Pg.from(qg)}function qg(e){if(!e.length)return[];const t=[];for(const n of e){const e=n,r=t.pop();if(r)if("tool"===e.getType()||e.getType()!==r.getType())t.push(r,e);else{const n=Ya(r),s=Ya(e),a=n.concat(s);"string"==typeof n.content&&"string"==typeof s.content&&(a.content=`${n.content}\n${s.content}`),t.push(Kg(a))}else t.push(e)}return t}function Vg(e,t){if(Array.isArray(e)){const n=e;if(!t)throw new Error("Options parameter is required when providing messages.");return Hg(n,t)}{const t=e;return Pg.from(e=>Hg(e,t)).withConfig({runName:"trim_messages"})}}async function Hg(e,t){const{maxTokens:n,tokenCounter:r,strategy:s="last",allowPartial:a=!1,endOn:i,startOn:o,includeSystem:c=!1,textSplitter:l}=t;if(o&&"first"===s)throw new Error("`startOn` should only be specified if `strategy` is 'last'.");if(c&&"first"===s)throw new Error("`includeSystem` should only be specified if `strategy` is 'last'.");let u;u="getNumTokens"in r?async e=>(await Promise.all(e.map(e=>r.getNumTokens(e.content)))).reduce((e,t)=>e+t,0):async e=>r(e);let d=Xg;if(l&&(d="splitText"in l?l.splitText:async e=>l(e)),"first"===s)return Wg(e,{maxTokens:n,tokenCounter:u,textSplitter:d,partialStrategy:a?"first":void 0,endOn:i});if("last"===s)return async function(e,t){const{allowPartial:n=!1,includeSystem:r=!1,endOn:s,startOn:a,...i}=t;let o=e.map(e=>{const t=Object.fromEntries(Object.entries(e).filter(([e])=>"type"!==e&&!e.startsWith("lc_")));return Jg(e.getType(),t,Js(e))});if(s){const e=Array.isArray(s)?s:[s];for(;o.length>0&&!Dg(o[o.length-1],e);)o=o.slice(0,-1)}const c=r&&"system"===o[0]?.getType();let l=c?o.slice(0,1).concat(o.slice(1).reverse()):o.reverse();return l=await Wg(l,{...i,partialStrategy:n?"last":void 0,endOn:a}),c?[l[0],...l.slice(1).reverse()]:l.reverse()}(e,{maxTokens:n,tokenCounter:u,textSplitter:d,allowPartial:a,includeSystem:c,startOn:o,endOn:i});throw new Error(`Unrecognized strategy: '${s}'. Must be one of 'first' or 'last'.`)}async function Wg(e,t){const{maxTokens:n,tokenCounter:r,textSplitter:s,partialStrategy:a,endOn:i}=t;let o=[...e],c=0;for(let e=0;e<o.length;e+=1){const t=e>0?o.slice(0,-e):o;if(await r(t)<=n){c=o.length-e;break}}if(c<o.length&&a){let e=!1;if(Array.isArray(o[c].content)){const t=o[c];if("string"==typeof t.content)throw new Error("Expected content to be an array.");const s=t.content.length,i="last"===a?[...t.content].reverse():t.content;for(let l=1;l<=s;l+=1){const s="first"===a?i.slice(0,l):i.slice(-l),u=Object.fromEntries(Object.entries(t).filter(([e])=>"type"!==e&&!e.startsWith("lc_"))),d=Jg(t.getType(),{...u,content:s}),p=[...o.slice(0,c),d];if(!(await r(p)<=n))break;o=p,c+=1,e=!0}e&&"last"===a&&(t.content=[...i].reverse())}if(!e){const e=o[c];let t;if(Array.isArray(e.content)&&e.content.some(e=>"string"==typeof e||"text"===e.type)){const n=e.content.find(e=>"text"===e.type&&e.text);t=n?.text}else"string"==typeof e.content&&(t=e.content);if(t){const i=await s(t),l=i.length;"last"===a&&i.reverse();for(let t=0;t<l-1;t+=1)if(i.pop(),e.content=i.join(""),await r([...o.slice(0,c),e])<=n){"last"===a&&(e.content=[...i].reverse().join("")),o=[...o.slice(0,c),e],c+=1;break}}}}if(i){const e=Array.isArray(i)?i:[i];for(;c>0&&!Dg(o[c-1],e);)c-=1}return o.slice(0,c)}const Gg={human:{message:fa,messageChunk:ga},ai:{message:Da,messageChunk:Za},system:{message:wa,messageChunk:ba},developer:{message:wa,messageChunk:ba},tool:{message:na,messageChunk:ra},function:{message:da,messageChunk:pa},generic:{message:oa,messageChunk:ca},remove:{message:va,messageChunk:va}};function Jg(e,t,n){let r,s;switch(e){case"human":n?r=new ga(t):s=new fa(t);break;case"ai":if(n){let e={...t};"tool_calls"in e&&(e={...e,tool_call_chunks:e.tool_calls?.map(e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)}))}),r=new Za(e)}else s=new Da(t);break;case"system":n?r=new ba(t):s=new wa(t);break;case"developer":n?r=new ba({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}}):s=new wa({...t,additional_kwargs:{...t.additional_kwargs,__openai_role__:"developer"}});break;case"tool":if(!("tool_call_id"in t))throw new Error("Can not convert ToolMessage to ToolMessageChunk if 'tool_call_id' field is not defined.");n?r=new ra(t):s=new na(t);break;case"function":if(n)r=new pa(t);else{if(!t.name)throw new Error("FunctionMessage must have a 'name' field");s=new da(t)}break;case"generic":if(!("role"in t))throw new Error("Can not convert ChatMessage to ChatMessageChunk if 'role' field is not defined.");n?r=new ca(t):s=new oa(t);break;default:throw new Error(`Unrecognized message type ${e}`)}if(n&&r)return r;if(s)return s;throw new Error(`Unrecognized message type ${e}`)}function Kg(e){const t=e.getType();let n;const r=Object.fromEntries(Object.entries(e).filter(([e])=>!["type","tool_call_chunks"].includes(e)&&!e.startsWith("lc_")));if(t in Gg&&(n=Jg(t,r)),!n)throw new Error(`Unrecognized message chunk class ${t}. Supported classes are ${Object.keys(Gg)}`);return n}function Xg(e){const t=e.split("\n");return Promise.resolve([...t.slice(0,-1).map(e=>`${e}\n`),t[t.length-1]])}const Yg=["text","reasoning","tool_call","tool_call_chunk","invalid_tool_call","server_tool_call","server_tool_call_chunk","server_tool_call_result","image","video","audio","text-plain","file"];Yr({},{AIMessage:()=>Da,AIMessageChunk:()=>Za,BaseMessage:()=>Fs,BaseMessageChunk:()=>Hs,ChatMessage:()=>oa,ChatMessageChunk:()=>ca,FunctionMessage:()=>da,FunctionMessageChunk:()=>pa,HumanMessage:()=>fa,HumanMessageChunk:()=>ga,KNOWN_BLOCK_TYPES:()=>Yg,RemoveMessage:()=>va,SystemMessage:()=>wa,SystemMessageChunk:()=>ba,ToolMessage:()=>na,ToolMessageChunk:()=>ra,_isMessageFieldWithRole:()=>Ws,_mergeDicts:()=>Zs,_mergeLists:()=>qs,_mergeObj:()=>Vs,_mergeStatus:()=>Ds,coerceMessageLikeToMessage:()=>Wa,collapseToolCallChunks:()=>Qa,convertToChunk:()=>Ya,convertToOpenAIImageBlock:()=>ss,convertToProviderContentBlock:()=>os,defaultTextSplitter:()=>Xg,defaultToolCallParser:()=>sa,filterMessages:()=>Fg,getBufferString:()=>Ga,iife:()=>qa,isAIMessage:()=>Fa,isAIMessageChunk:()=>Ba,isBase64ContentBlock:()=>ts,isBaseMessage:()=>Gs,isBaseMessageChunk:()=>Js,isChatMessage:()=>la,isChatMessageChunk:()=>ua,isDataContentBlock:()=>Qr,isDirectToolOutput:()=>ta,isFunctionMessage:()=>ha,isFunctionMessageChunk:()=>ma,isHumanMessage:()=>ya,isHumanMessageChunk:()=>_a,isIDContentBlock:()=>rs,isMessage:()=>cs,isOpenAIToolCallArray:()=>Bs,isPlainTextContentBlock:()=>ns,isSystemMessage:()=>xa,isSystemMessageChunk:()=>ka,isToolMessage:()=>aa,isToolMessageChunk:()=>ia,isURLContentBlock:()=>es,mapChatMessagesToStoredMessages:()=>Xa,mapStoredMessageToChatMessage:()=>Ja,mapStoredMessagesToChatMessages:()=>Ka,mergeContent:()=>Us,mergeMessageRuns:()=>Zg,mergeResponseMetadata:()=>Ks,mergeUsageMetadata:()=>ea,parseBase64DataUrl:()=>is,parseMimeType:()=>as,trimMessages:()=>Vg});const Qg=e=>e();function ey(e){return!(!e||!/^o\d/.test(e??"")&&(!e.startsWith("gpt-5")||e.startsWith("gpt-5-chat")))}function ty(e){const t=e.metadata?.filename??e.metadata?.name??e.metadata?.title;if(!t)throw new Error("a filename or name or title is needed via meta-data for OpenAI when working with multimodal blocks");return t}function ny(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!oa.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}function ry(e){return"undefined"!=typeof Headers&&null!==e&&"object"==typeof e&&"[object Headers]"===Object.prototype.toString.call(e)}function sy(e){return void 0!==e&&Array.isArray(e.lc_namespace)}function ay(e){return void 0!==e&&Eg.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}function iy(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&(eh(e.schema)||null!=e.schema&&"object"==typeof e.schema&&"type"in e.schema&&"string"==typeof e.schema.type&&["null","boolean","object","array","number","string"].includes(e.schema.type))}function oy(e){return iy(e)||ay(e)||sy(e)}function cy(e,t){const n="number"==typeof t?void 0:t;return{name:e.name,description:e.description,parameters:mg(e.schema),...void 0!==n?.strict?{strict:n.strict}:{}}}function ly(e,t){const n="number"==typeof t?void 0:t;let r;return r=oy(e)?{type:"function",function:cy(e)}:e,void 0!==n?.strict&&(r.function.strict=n.strict),r}function uy(e,t){const n=[];for(const[r,s]of Object.entries(e.properties??{}))s.description&&t<2&&n.push(`// ${s.description}`),e.required?.includes(r)?n.push(`${r}: ${dy(s,t)},`):n.push(`${r}?: ${dy(s,t)},`);return n.map(e=>" ".repeat(t)+e).join("\n")}function dy(e,t){if(void 0!==(n=e).anyOf&&Array.isArray(n.anyOf))return e.anyOf.map(e=>dy(e,t)).join(" | ");var n;switch(e.type){case"string":return e.enum?e.enum.map(e=>`"${e}"`).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map(e=>`${e}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",uy(e,t+2),"}"].join("\n");case"array":return e.items?`${dy(e.items,t)}[]`:"any[]";default:return""}}function py(e){return e?"any"===e||"required"===e?"required":"auto"===e?"auto":"none"===e?"none":"string"==typeof e?{type:"function",function:{name:e}}:e:void 0}function hy(e){return"type"in e&&"function"!==e.type}function my(e){return"object"==typeof e&&null!==e&&"metadata"in e&&"object"==typeof e.metadata&&null!==e.metadata&&"customTool"in e.metadata&&"object"==typeof e.metadata.customTool&&null!==e.metadata.customTool}function fy(e){return"type"in e&&"custom"===e.type&&"custom"in e&&"object"==typeof e.custom&&null!==e.custom}function gy(e){if("custom_tool_call"===e.type)return{...e,type:"tool_call",call_id:e.id,id:e.call_id,name:e.name,isCustomTool:!0,args:{input:e.input}}}function yy(e){if("computer_call"===e.type)return{...e,type:"tool_call",call_id:e.id,id:e.call_id,name:"computer_use",isComputerTool:!0,args:{action:e.action}}}function _y(e){return{type:"custom",name:e.custom.name,description:e.custom.description,format:(()=>{if(e.custom.format)return"grammar"===e.custom.format.type?{type:"grammar",definition:e.custom.format.grammar.definition,syntax:e.custom.format.grammar.syntax}:"text"===e.custom.format.type?{type:"text"}:void 0})()}}Yr({},{convertToOpenAIFunction:()=>cy,convertToOpenAITool:()=>ly,isLangChainTool:()=>oy,isRunnableToolLike:()=>ay,isStructuredTool:()=>sy,isStructuredToolParams:()=>iy}),Yr({},{extendInteropZodObject:()=>_h,getInteropZodDefaultGetter:()=>xh,getInteropZodObjectShape:()=>yh,getSchemaDescription:()=>ch,interopParse:()=>oh,interopParseAsync:()=>ah,interopSafeParse:()=>ih,interopSafeParseAsync:()=>sh,interopZodObjectMakeFieldsOptional:()=>Ih,interopZodObjectPartial:()=>vh,interopZodObjectPassthrough:()=>bh,interopZodObjectStrict:()=>wh,interopZodTransformInputSchema:()=>Th,isInteropZodError:()=>Eh,isInteropZodLiteral:()=>rh,isInteropZodObject:()=>gh,isInteropZodSchema:()=>eh,isShapelessZodSchema:()=>lh,isSimpleStringZodSchema:()=>uh,isZodArrayV4:()=>hh,isZodLiteralV3:()=>th,isZodLiteralV4:()=>nh,isZodNullableV4:()=>fh,isZodObjectV3:()=>dh,isZodObjectV4:()=>ph,isZodOptionalV4:()=>mh,isZodSchema:()=>Qp,isZodSchemaV3:()=>Yp,isZodSchemaV4:()=>Xp});const vy=Symbol("Let zodToJsonSchema decide on which parser to use"),wy={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},by=e=>"_def"in e?e._def:e;function xy(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function ky(e,t,n,r,s){e[t]=n,xy(e,t,r,s)}function Ty(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map((n,r)=>Ty(e,t,n))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Iy(e,t)}}const Iy=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":ky(n,"minimum",r.value,r.message,t);break;case"max":ky(n,"maximum",r.value,r.message,t)}return n};let Ey;const Oy=/^[cC][^\s-]{8,}$/,Sy=/^[0-9a-z]+$/,Ay=/^[0-9A-HJKMNP-TV-Z]{26}$/,$y=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,Cy=()=>(void 0===Ey&&(Ey=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Ey),Ny=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Py=/^[a-zA-Z0-9_-]{21}$/;function Ry(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?jy(e):e}if(e.checks)for(const s of e.checks)switch(s.kind){case"min":ky(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,s.value):s.value,s.message,t);break;case"max":ky(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,s.value):s.value,s.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Ly(n,"email",s.message,t);break;case"format:idn-email":Ly(n,"idn-email",s.message,t);break;case"pattern:zod":My(n,$y,s.message,t)}break;case"url":Ly(n,"uri",s.message,t);break;case"uuid":Ly(n,"uuid",s.message,t);break;case"regex":My(n,s.regex,s.message,t);break;case"cuid":My(n,Oy,s.message,t);break;case"cuid2":My(n,Sy,s.message,t);break;case"startsWith":My(n,RegExp(`^${r(s.value)}`),s.message,t);break;case"endsWith":My(n,RegExp(`${r(s.value)}$`),s.message,t);break;case"datetime":Ly(n,"date-time",s.message,t);break;case"date":Ly(n,"date",s.message,t);break;case"time":Ly(n,"time",s.message,t);break;case"duration":Ly(n,"duration",s.message,t);break;case"length":ky(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,s.value):s.value,s.message,t),ky(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,s.value):s.value,s.message,t);break;case"includes":My(n,RegExp(r(s.value)),s.message,t);break;case"ip":"v6"!==s.version&&Ly(n,"ipv4",s.message,t),"v4"!==s.version&&Ly(n,"ipv6",s.message,t);break;case"emoji":My(n,Cy,s.message,t);break;case"ulid":My(n,Ay,s.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Ly(n,"binary",s.message,t);break;case"contentEncoding:base64":ky(n,"contentEncoding","base64",s.message,t);break;case"pattern:zod":My(n,Ny,s.message,t)}break;case"nanoid":My(n,Py,s.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return n}const jy=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Ly=(e,t,n,r)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):ky(e,"format",t,n,r)},My=(e,t,n,r)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:zy(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):ky(e,"pattern",zy(t,r),n,r)},zy=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const r=n.flags.includes("i"),s=n.flags.includes("m"),a=n.flags.includes("s"),i=r?n.source.toLowerCase():n.source;let o="",c=!1,l=!1,u=!1;for(let e=0;e<i.length;e++)if(c)o+=i[e],c=!1;else{if(r)if(l){if(i[e].match(/[a-z]/)){u?(o+=i[e],o+=`${i[e-2]}-${i[e]}`.toUpperCase(),u=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(o+=i[e],u=!0):o+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){o+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(s){if("^"===i[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){o+="($|(?=[\r\n]))";continue}}a&&"."===i[e]?o+=l?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(o+=i[e],"\\"===i[e]?c=!0:l&&"]"===i[e]?l=!1:l||"["!==i[e]||(l=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return o};function Uy(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===df.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((n,r)=>({...n,[r]:Zy(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}}),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Zy(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===df.ZodString&&e.keyType._def.checks?.length){const r=Object.entries(Ry(e.keyType._def,t)).reduce((e,[t,n])=>"type"===t?e:{...e,[t]:n},{});return{...n,propertyNames:r}}return e.keyType?._def.typeName===df.ZodEnum?{...n,propertyNames:{enum:e.keyType._def.values}}:n}const Dy={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Fy=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,n)=>Zy(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return n.length?{anyOf:n}:void 0};function By(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:Zy(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:Zy(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function Zy(e,t,n=!1){const r=t.seen.get(e);if(t.override){const s=t.override?.(e,t,r,n);if(s!==vy)return s}if(r&&!n){const e=qy(r,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}const s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);const a=Hy(e,e.typeName,t,n);return a&&Wy(e,t,a),s.jsonSchema=a,a}const qy=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const n=e.path.slice(t.basePath.length+1).join("_");return n!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[n]=e.def),{$ref:[...t.basePath,t.definitionPath,n].join("/")};case"relative":return{$ref:Vy(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,n)=>t.currentPath[n]===e)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},Vy=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},Hy=(e,t,n,r)=>{switch(t){case df.ZodString:return Ry(e,n);case df.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",xy(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?ky(n,"minimum",r.value,r.message,t):ky(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),ky(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?ky(n,"maximum",r.value,r.message,t):ky(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),ky(n,"maximum",r.value,r.message,t));break;case"multipleOf":ky(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case df.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const s=[...t.currentPath,"properties",n],a=Zy(r._def,{...t,currentPath:s,propertyPath:s});if(void 0===a)return e;if(t.openaiStrictMode&&r.isOptional()&&!r.isNullable()&&void 0===r._def?.defaultValue)throw new Error(`Zod field at \`${s.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...e.properties,[n]:a},required:r.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,n]}},{properties:{},required:[]}),additionalProperties:By(e,t)};return n.required.length||delete n.required,n}(e,n);case df.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?ky(n,"minimum",r.value,r.message,t):ky(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),ky(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?ky(n,"maximum",r.value,r.message,t):ky(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),ky(n,"maximum",r.value,r.message,t));break;case"multipleOf":ky(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case df.ZodBoolean:return{type:"boolean"};case df.ZodDate:return Ty(e,n);case df.ZodUndefined:return{not:{}};case df.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case df.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def?.typeName!==df.ZodAny&&(n.items=Zy(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&ky(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&ky(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(ky(n,"minItems",e.exactLength.value,e.exactLength.message,t),ky(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case df.ZodUnion:case df.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Fy(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every(e=>e._def.typeName in Dy&&(!e._def.checks||!e._def.checks.length))){const e=n.reduce((e,t)=>{const n=Dy[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e},[]);return{type:e.length>1?e:e[0]}}if(n.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=n.reduce((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===n.length){const t=e.filter((e,t,n)=>n.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:n.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(n.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:n.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return Fy(e,t)}(e,n);case df.ZodIntersection:return function(e,t){const n=[Zy(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Zy(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;s.push(t)}else s.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t}),s.length?{allOf:s,...r}:void 0}(e,n);case df.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,n)=>Zy(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:Zy(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,n)=>Zy(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,n);case df.ZodRecord:return Uy(e,n);case df.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case df.ZodEnum:return function(e){return{type:"string",enum:[...e.values]}}(e);case df.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),r=Array.from(new Set(n.map(e=>typeof e)));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case df.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:Dy[e.innerType._def.typeName],nullable:!0}:{type:[Dy[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=Zy(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=Zy(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case df.ZodOptional:return((e,t)=>{if(t.propertyPath&&t.currentPath.slice(0,t.propertyPath.length).toString()===t.propertyPath.toString())return Zy(e.innerType._def,{...t,currentPath:t.currentPath});const n=Zy(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case df.ZodMap:return function(e,t){return"record"===t.mapStrategy?Uy(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Zy(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},Zy(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case df.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:Zy(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&ky(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&ky(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case df.ZodLazy:return Zy(e.getter()._def,n);case df.ZodPromise:return function(e,t){return Zy(e.type._def,t)}(e,n);case df.ZodNaN:case df.ZodNever:return{not:{}};case df.ZodEffects:return function(e,t,n){return"input"===t.effectStrategy?Zy(e.schema._def,t,n):{}}(e,n,r);case df.ZodAny:case df.ZodUnknown:return{};case df.ZodDefault:return function(e,t){return{...Zy(e.innerType._def,t),default:e.defaultValue()}}(e,n);case df.ZodBranded:return function(e,t){return Zy(e.type._def,t)}(e,n);case df.ZodReadonly:case df.ZodCatch:return((e,t)=>Zy(e.innerType._def,t))(e,n);case df.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Zy(e.in._def,t);if("output"===t.pipeStrategy)return Zy(e.out._def,t);const n=Zy(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,Zy(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter(e=>void 0!==e)}})(e,n);case df.ZodFunction:case df.ZodVoid:case df.ZodSymbol:default:return}},Wy=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n);function Gy(e){if("object"!==e.type)throw new Error("Root schema must have type: 'object' but got type: "+(e.type?`'${e.type}'`:"undefined"));const t=structuredClone(e);return Ky(t,[],t)}function Jy(e){if("boolean"==typeof e)return!1;if("null"===e.type)return!0;for(const t of e.oneOf??[])if(Jy(t))return!0;for(const t of e.anyOf??[])if(Jy(t))return!0;return!1}function Ky(e,t,n){if("boolean"==typeof e)throw new TypeError(`Expected object schema but got boolean; path=${t.join("/")}`);if(!Xy(e))throw new TypeError(`Expected ${JSON.stringify(e)} to be an object; path=${t.join("/")}`);const r=e.$defs;if(Xy(r))for(const[e,s]of Object.entries(r))Ky(s,[...t,"$defs",e],n);const s=e.definitions;if(Xy(s))for(const[e,r]of Object.entries(s))Ky(r,[...t,"definitions",e],n);"object"!==e.type||"additionalProperties"in e||(e.additionalProperties=!1);const a=e.required??[],i=e.properties;if(Xy(i)){for(const[e,n]of Object.entries(i))if(!Jy(n)&&!a.includes(e))throw new Error(`Zod field at \`${[...t,"properties",e].join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);e.required=Object.keys(i),e.properties=Object.fromEntries(Object.entries(i).map(([e,r])=>[e,Ky(r,[...t,"properties",e],n)]))}const o=e.items;Xy(o)&&(e.items=Ky(o,[...t,"items"],n));const c=e.anyOf;Array.isArray(c)&&(e.anyOf=c.map((e,r)=>Ky(e,[...t,"anyOf",String(r)],n)));const l=e.allOf;if(Array.isArray(l))if(1===l.length){const r=Ky(l[0],[...t,"allOf","0"],n);Object.assign(e,r),delete e.allOf}else e.allOf=l.map((e,r)=>Ky(e,[...t,"allOf",String(r)],n));null===e.default&&delete e.default;const u=e.$ref;if(u&&function(e){let t=0;for(const n in e)if(t++,t>1)return!0;return!1}(e)){if("string"!=typeof u)throw new TypeError(`Received non-string $ref - ${u}; path=${t.join("/")}`);const r=function(e,t){if(!t.startsWith("#/"))throw new Error(`Unexpected $ref format ${JSON.stringify(t)}; Does not start with #/`);const n=t.slice(2).split("/");let r=e;for(const e of n){if(!Xy(r))throw new Error(`encountered non-object entry while resolving ${t} - ${JSON.stringify(r)}`);const n=r[e];if(void 0===n)throw new Error(`Key ${e} not found while resolving ${t}`);r=n}return r}(n,u);if("boolean"==typeof r)throw new Error(`Expected \`$ref: ${u}\` to resolve to an object schema but got boolean`);if(!Xy(r))throw new Error(`Expected \`$ref: ${u}\` to resolve to an object but got ${JSON.stringify(r)}`);return Object.assign(e,{...r,...e}),delete e.$ref,Ky(e,t,n)}return e}function Xy(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}function Yy(e,t){return((e,t)=>{const n=(e=>{const t=(e=>"string"==typeof e?{...wy,basePath:["#"],definitions:{},name:e}:{...wy,basePath:["#"],definitions:{},...e})(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([e,n])=>[by(n),{def:by(n),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t),r="title"===t?.nameStrategy?void 0:t?.name,s=Zy(e._def,void 0===r?n:{...n,currentPath:[...n.basePath,n.definitionPath,r]},!1)??{},a=void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==a&&(s.title=a);const i=(()=>{if(function(e){if(!e)return!0;for(const t in e)return!1;return!0}(n.definitions))return;const e={},t=new Set;for(let r=0;r<500;r++){const r=Object.entries(n.definitions).filter(([e])=>!t.has(e));if(0===r.length)break;for(const[s,a]of r)e[s]=Zy(by(a),{...n,currentPath:[...n.basePath,n.definitionPath,s]},!0)??{},t.add(s)}return e})(),o=void 0===r?i?{...s,[n.definitionPath]:i}:s:"duplicate-ref"===n.nameStrategy?{...s,...i||n.seenRefs.size?{[n.definitionPath]:{...i,...n.seenRefs.size?{[r]:s}:void 0}}:void 0}:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,r].join("/"),[n.definitionPath]:{...i,[r]:s}};return"jsonSchema7"===n.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o})(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function Qy(e){return"_zod"in e}function e_(e,t,n){return function(t){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t=>e.parse(JSON.parse(t)),enumerable:!1}}),n}({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:Qy(e)?(r=e,Gy(Vf(r,{target:"draft-7"}))):Yy(e,{name:t})}});var r}const t_=["jsonSchema","functionCalling","jsonMode"];function n_(e,t,n){if(Yp(e))return e_(e,t,n);if(Xp(e))return function(t){const n={...t};return Object.defineProperties(n,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t=>Pu(e,JSON.parse(t)),enumerable:!1}}),n}({type:"json_schema",json_schema:{...n,name:t,strict:!0,schema:mg(e,{cycles:"ref",reused:"ref",override(e){e.jsonSchema.title=t}})}});throw new Error("Unsupported schema response format")}var r_={"gpt-4.1-nano":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"text-embedding-3-small":{maxInputTokens:8191,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1536,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:8192,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-pro":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-05-13":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-08-06":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4.1-mini":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-deep-research":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-3.5-turbo":{maxInputTokens:16385,imageInputs:!1,audioInputs:!1,pdfInputs:!1,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!1,imageUrlInputs:!1,pdfToolMessage:!1,imageToolMessage:!1,toolChoice:!0},"text-embedding-3-large":{maxInputTokens:8191,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:3072,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4-turbo":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:4096,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-preview":{maxInputTokens:128e3,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-mini":{maxInputTokens:2e5,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"codex-mini-latest":{maxInputTokens:2e5,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-nano":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-codex":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4.1":{maxInputTokens:1047576,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:32768,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o4-mini":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},o1:{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-mini":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o1-mini":{maxInputTokens:128e3,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:65536,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"text-embedding-ada-002":{maxInputTokens:8192,imageInputs:!1,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1536,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o3-pro":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-2024-11-20":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},o3:{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"o4-mini-deep-research":{maxInputTokens:2e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:1e5,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-chat-latest":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!1,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-4o-mini":{maxInputTokens:128e3,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:16384,reasoningOutput:!1,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:128e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0},"gpt-5-pro":{maxInputTokens:4e5,imageInputs:!0,audioInputs:!1,pdfInputs:!0,videoInputs:!1,maxOutputTokens:272e3,reasoningOutput:!0,imageOutputs:!1,audioOutputs:!1,videoOutputs:!1,toolCalling:!0,structuredOutput:!0,imageUrlInputs:!0,pdfToolMessage:!0,imageToolMessage:!0,toolChoice:!0}};Yr({},{BasePromptValue:()=>s_,ChatPromptValue:()=>i_,ImagePromptValue:()=>o_,StringPromptValue:()=>a_});var s_=class extends fs{},a_=class extends s_{static lc_name(){return"StringPromptValue"}lc_namespace=["langchain_core","prompt_values"];lc_serializable=!0;value;constructor(e){super({value:e}),this.value=e}toString(){return this.value}toChatMessages(){return[new fa(this.value)]}},i_=class extends s_{lc_namespace=["langchain_core","prompt_values"];lc_serializable=!0;static lc_name(){return"ChatPromptValue"}messages;constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),this.messages=e.messages}toString(){return Ga(this.messages)}toChatMessages(){return this.messages}},o_=class extends s_{lc_namespace=["langchain_core","prompt_values"];lc_serializable=!0;static lc_name(){return"ImagePromptValue"}imageUrl;value;constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new fa({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}},c_="0123456789abcdef".split(""),l_=[-2147483648,8388608,32768,128],u_=[24,16,8,0],d_=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],p_=[];function h_(e,t){t?(p_[0]=p_[16]=p_[1]=p_[2]=p_[3]=p_[4]=p_[5]=p_[6]=p_[7]=p_[8]=p_[9]=p_[10]=p_[11]=p_[12]=p_[13]=p_[14]=p_[15]=0,this.blocks=p_):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}h_.prototype.update=function(e){if(!this.finalized){var t,n=typeof e;if("string"!==n){if("object"!==n)throw new Error(ERROR);if(null===e)throw new Error(ERROR);if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||ARRAY_BUFFER&&ArrayBuffer.isView(e)))throw new Error(ERROR);t=!0}for(var r,s,a=0,i=e.length,o=this.blocks;a<i;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(s=this.start;a<i&&s<64;++a)o[s>>>2]|=e[a]<<u_[3&s++];else for(s=this.start;a<i&&s<64;++a)(r=e.charCodeAt(a))<128?o[s>>>2]|=r<<u_[3&s++]:r<2048?(o[s>>>2]|=(192|r>>>6)<<u_[3&s++],o[s>>>2]|=(128|63&r)<<u_[3&s++]):r<55296||r>=57344?(o[s>>>2]|=(224|r>>>12)<<u_[3&s++],o[s>>>2]|=(128|r>>>6&63)<<u_[3&s++],o[s>>>2]|=(128|63&r)<<u_[3&s++]):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++a)),o[s>>>2]|=(240|r>>>18)<<u_[3&s++],o[s>>>2]|=(128|r>>>12&63)<<u_[3&s++],o[s>>>2]|=(128|r>>>6&63)<<u_[3&s++],o[s>>>2]|=(128|63&r)<<u_[3&s++]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=o[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},h_.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=l_[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},h_.prototype.hash=function(){var e,t,n,r,s,a,i,o,c,l=this.h0,u=this.h1,d=this.h2,p=this.h3,h=this.h4,m=this.h5,f=this.h6,g=this.h7,y=this.blocks;for(e=16;e<64;++e)t=((s=y[e-15])>>>7|s<<25)^(s>>>18|s<<14)^s>>>3,n=((s=y[e-2])>>>17|s<<15)^(s>>>19|s<<13)^s>>>10,y[e]=y[e-16]+t+y[e-7]+n|0;for(c=u&d,e=0;e<64;e+=4)this.first?(this.is224?(a=300032,g=(s=y[0]-1413257819)-150054599|0,p=s+24177077|0):(a=704751109,g=(s=y[0]-210244248)-1521486534|0,p=s+143694565|0),this.first=!1):(t=(l>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10),r=(a=l&u)^l&d^c,g=p+(s=g+(n=(h>>>6|h<<26)^(h>>>11|h<<21)^(h>>>25|h<<7))+(h&m^~h&f)+d_[e]+y[e])|0,p=s+(t+r)|0),t=(p>>>2|p<<30)^(p>>>13|p<<19)^(p>>>22|p<<10),r=(i=p&l)^p&u^a,f=d+(s=m+(n=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(f&g^~f&h)+d_[e+1]+y[e+1])|0,t=((d=s+(t+r)|0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),r=(o=d&p)^d&l^i,m=u+(s=h+(n=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(m&f^~m&g)+d_[e+2]+y[e+2])|0,t=((u=s+(t+r)|0)>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),r=(c=u&d)^u&p^o,h=l+(s=h+(n=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(m&f^~m&g)+d_[e+3]+y[e+3])|0,l=s+(t+r)|0,this.chromeBugWorkAround=!0;this.h0=this.h0+l|0,this.h1=this.h1+u|0,this.h2=this.h2+d|0,this.h3=this.h3+p|0,this.h4=this.h4+h|0,this.h5=this.h5+m|0,this.h6=this.h6+f|0,this.h7=this.h7+g|0},h_.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4,a=this.h5,i=this.h6,o=this.h7,c=c_[e>>>28&15]+c_[e>>>24&15]+c_[e>>>20&15]+c_[e>>>16&15]+c_[e>>>12&15]+c_[e>>>8&15]+c_[e>>>4&15]+c_[15&e]+c_[t>>>28&15]+c_[t>>>24&15]+c_[t>>>20&15]+c_[t>>>16&15]+c_[t>>>12&15]+c_[t>>>8&15]+c_[t>>>4&15]+c_[15&t]+c_[n>>>28&15]+c_[n>>>24&15]+c_[n>>>20&15]+c_[n>>>16&15]+c_[n>>>12&15]+c_[n>>>8&15]+c_[n>>>4&15]+c_[15&n]+c_[r>>>28&15]+c_[r>>>24&15]+c_[r>>>20&15]+c_[r>>>16&15]+c_[r>>>12&15]+c_[r>>>8&15]+c_[r>>>4&15]+c_[15&r]+c_[s>>>28&15]+c_[s>>>24&15]+c_[s>>>20&15]+c_[s>>>16&15]+c_[s>>>12&15]+c_[s>>>8&15]+c_[s>>>4&15]+c_[15&s]+c_[a>>>28&15]+c_[a>>>24&15]+c_[a>>>20&15]+c_[a>>>16&15]+c_[a>>>12&15]+c_[a>>>8&15]+c_[a>>>4&15]+c_[15&a]+c_[i>>>28&15]+c_[i>>>24&15]+c_[i>>>20&15]+c_[i>>>16&15]+c_[i>>>12&15]+c_[i>>>8&15]+c_[i>>>4&15]+c_[15&i];return this.is224||(c+=c_[o>>>28&15]+c_[o>>>24&15]+c_[o>>>20&15]+c_[o>>>16&15]+c_[o>>>12&15]+c_[o>>>8&15]+c_[o>>>4&15]+c_[15&o]),c},h_.prototype.toString=h_.prototype.hex,h_.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4,a=this.h5,i=this.h6,o=this.h7,c=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,n>>>24&255,n>>>16&255,n>>>8&255,255&n,r>>>24&255,r>>>16&255,r>>>8&255,255&r,s>>>24&255,s>>>16&255,s>>>8&255,255&s,a>>>24&255,a>>>16&255,a>>>8&255,255&a,i>>>24&255,i>>>16&255,i>>>8&255,255&i];return this.is224||c.push(o>>>24&255,o>>>16&255,o>>>8&255,255&o),c},h_.prototype.array=h_.prototype.digest,h_.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e};const m_=(...e)=>new h_(!1,!0).update(e.join("")).hex();Yr({},{sha256:()=>m_}),Yr({},{BaseCache:()=>v_,InMemoryCache:()=>b_,defaultHashKeyEncoder:()=>f_,deserializeStoredGeneration:()=>g_,serializeGeneration:()=>y_});const f_=(...e)=>m_(e.join("_"));function g_(e){return void 0!==e.message?{text:e.text,message:Ja(e.message)}:{text:e.text}}function y_(e){const t={text:e.text};return void 0!==e.message&&(t.message=e.message.toDict()),t}var v_=class{keyEncoder=f_;makeDefaultKeyEncoder(e){this.keyEncoder=e}};const w_=new Map;var b_=class e extends v_{cache;constructor(e){super(),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,n){this.cache.set(this.keyEncoder(e,t),n)}static global(){return new e(w_)}},x_=n(7526),k_=Object.defineProperty;function T_(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const a=e.slice(n[s].start,n[s+1].end),i=t.get(a.join(","));null!=i&&(null==r||i<r[0])&&(r=[i,s])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map(n=>t.get(e.slice(n.start,n.end).join(","))).filter(e=>null!=e)}var I_,E_,O_=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{const[n,r,...s]=t.split(" "),a=Number.parseInt(r,10);return s.forEach((t,n)=>e[t]=a+n),e},{});for(const[e,t]of Object.entries(n)){const n=x_.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=O_.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter(e=>!i.has(e)):n);if(o.size>0){const t=O_.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let c=0;for(;;){let t=null,n=c;for(;s.lastIndex=n,t=s.exec(e),null!=t&&!i.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?a.push(...T_(e,this.rankMap)):a.push(n)}if(null==t)break;let l=this.specialTokens[t[0]];a.push(l),c=t.index+t[0].length}return a}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const s=e[r],a=this.textMap.get(s)??this.inverseSpecialTokens[s];null!=a&&(t.push(a),n+=a.length)}const r=new Uint8Array(n);let s=0;for(const e of t)r.set(e,s),s+=e.length;return this.textDecoder.decode(r)}},S_=O_;E_=e=>new RegExp(e.map(e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e)).join("|"),"g"),((e,t,n)=>{t in e?k_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(S_,"symbol"!=typeof(I_="specialTokenRegex")?I_+"":I_,E_),Yr({},{encodingForModel:()=>N_,getEncoding:()=>C_});const A_={},$_=new Jl({});async function C_(e){return e in A_||(A_[e]=$_.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(e=>e.json()).then(e=>new S_(e)).catch(t=>{throw delete A_[e],t})),await A_[e]}async function N_(e){return C_(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}(e))}Yr({},{BaseLangChain:()=>z_,BaseLanguageModel:()=>U_,calculateMaxTokens:()=>M_,getEmbeddingContextSize:()=>R_,getModelContextSize:()=>j_,getModelNameForTiktoken:()=>P_,isOpenAITool:()=>L_});const P_=e=>e.startsWith("gpt-5")?"gpt-5":e.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":e.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":e.startsWith("gpt-4-32k")?"gpt-4-32k":e.startsWith("gpt-4-")?"gpt-4":e.startsWith("gpt-4o")?"gpt-4o":e,R_=e=>"text-embedding-ada-002"===e?8191:2046,j_=e=>{switch(P_(e)){case"gpt-5":case"gpt-5-turbo":case"gpt-5-turbo-preview":return 4e5;case"gpt-4o":case"gpt-4o-mini":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4-turbo":case"gpt-4-turbo-preview":case"gpt-4-turbo-2024-04-09":case"gpt-4-0125-preview":case"gpt-4-1106-preview":return 128e3;case"gpt-4-32k":case"gpt-4-32k-0314":case"gpt-4-32k-0613":case"gemini-pro":case"gemini-pro-vision":return 32768;case"gpt-4":case"gpt-4-0314":case"gpt-4-0613":return 8192;case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-16k-0613":return 16384;case"gpt-3.5-turbo":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-1106":case"gpt-3.5-turbo-0125":return 4096;case"text-davinci-003":case"text-davinci-002":default:return 4097;case"text-davinci-001":return 2049;case"text-curie-001":case"text-babbage-001":case"text-ada-001":case"code-cushman-001":return 2048;case"code-davinci-002":case"code-davinci-001":return 8e3;case"claude-3-5-sonnet-20241022":case"claude-3-5-sonnet-20240620":case"claude-3-opus-20240229":case"claude-3-sonnet-20240229":case"claude-3-haiku-20240307":case"claude-2.1":return 2e5;case"claude-2.0":case"claude-instant-1.2":return 1e5;case"gemini-1.5-pro":case"gemini-1.5-pro-latest":case"gemini-1.5-flash":case"gemini-1.5-flash-latest":return 1e6}};function L_(e){return!("object"!=typeof e||!e||!("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&e.function&&"name"in e.function&&"parameters"in e.function))}const M_=async({prompt:e,modelName:t})=>{let n;try{n=(await N_(P_(t))).encode(e).length}catch{console.warn("Failed to calculate number of tokens, falling back to approximate count"),n=Math.ceil(e.length/4)}return j_(t)-n};var z_=class extends Eg{verbose;callbacks;tags;metadata;get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}},U_=class extends z_{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}caller;cache;constructor({callbacks:e,callbackManager:t,...n}){const{cache:r,...s}=n;super({callbacks:e??t,...s}),this.cache="object"==typeof r?r:r?b_.global():void 0,this.caller=new Jl(n??{})}_encoding;async getNumTokens(e){let t;t="string"==typeof e?e:e.map(e=>"string"==typeof e?e:"text"===e.type&&"text"in e?e.text:"").join("");let n=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await N_("modelName"in this?P_(this.modelName):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}if(this._encoding)try{n=this._encoding.encode(t).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return n}static _convertInputToPromptValue(e){return"string"==typeof e?new a_(e):Array.isArray(e)?new i_(e.map(Wa)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter(([e,t])=>void 0!==t),s=r.map(([e,t])=>`${e}:${JSON.stringify(t)}`).sort().join(",");return s}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}get profile(){return{}}},D_=class extends Eg{static lc_name(){return"RunnablePassthrough"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;func;constructor(e){super(e),e&&(this.func=e.func)}async invoke(e,t){const n=Gc(t);return this.func&&await this.func(e,n),this._callWithConfig(e=>Promise.resolve(e),e,n)}async*transform(e,t){const n=Gc(t);let r,s=!0;for await(const t of this._transformStreamWithConfig(e,e=>e,n))if(yield t,s)if(void 0===r)r=t;else try{r=tl(r,t)}catch{r=void 0,s=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new Mg(new Cg({steps:e}))}};function F_(e){return new(0,e.constructor)({...e,content:e.contentBlocks,response_metadata:{...e.response_metadata,output_version:"v1"}})}function B_(e){const t=[];for(const n of e){let e=n;if(Array.isArray(n.content))for(let t=0;t<n.content.length;t++){const r=n.content[t];(es(r)||ts(r))&&e===n&&(e=new n.constructor({...e,content:[...n.content.slice(0,t),ss(r),...n.content.slice(t+1)]}))}t.push(e)}return t}Yr({},{BaseChatModel:()=>Z_,SimpleChatModel:()=>q_});var Z_=class e extends U_{lc_namespace=["langchain","chat_models",this._llmType()];disableStreaming=!1;outputVersion;get callKeys(){return[...super.callKeys,"outputVersion"]}constructor(e){super(e),this.outputVersion=(()=>{const t=e.outputVersion??di("LC_OUTPUT_VERSION");return t&&["v0","v1"].includes(t)?t:"v0"})()}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async invoke(t,n){const r=e._convertInputToPromptValue(t);return(await this.generatePrompt([r],n,n?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(t,n){if(this._streamResponseChunks===e.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(t,n);else{const r=e._convertInputToPromptValue(t).toChatMessages(),[s,a]=this._separateRunnableConfigFromCallOptionsCompat(n),i={...s.metadata,...this.getLsParams(a)},o=await Uc.configure(s.callbacks,this.callbacks,s.tags,this.tags,i,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this?.invocationParams(a),batch_size:1},l=a.outputVersion??this.outputVersion,u=await(o?.handleChatModelStart(this.toJSON(),[B_(r)],s.runId,void 0,c,void 0,void 0,s.runName));let d,p;try{for await(const e of this._streamResponseChunks(r,a,u?.[0])){if(null==e.message.id){const t=u?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},"v1"===l?yield F_(e.message):yield e.message,d=d?d.concat(e):e,Ba(e.message)&&void 0!==e.message.usage_metadata&&(p={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((u??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((u??[]).map(e=>e?.handleLLMEnd({generations:[[d]],llmOutput:p})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(t,n,r,s){const a=t.map(e=>e.map(Wa));let i;if(void 0!==s&&s.length===a.length)i=s;else{const e={...r.metadata,...this.getLsParams(n)},t=await Uc.configure(r.callbacks,this.callbacks,r.tags,this.tags,e,this.metadata,{verbose:this.verbose}),s={options:n,invocation_params:this?.invocationParams(n),batch_size:1};i=await(t?.handleChatModelStart(this.toJSON(),a.map(B_),r.runId,void 0,s,void 0,void 0,r.runName))}const o=n.outputVersion??this.outputVersion,c=[],l=[];if(i?.[0].handlers.find(ki)&&!this.disableStreaming&&1===a.length&&this._streamResponseChunks!==e.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(a[0],n,i?.[0]);let t,r;for await(const n of e){if(null==n.message.id){const e=i?.at(0)?.runId;null!=e&&n.message._updateId(`run-${e}`)}t=void 0===t?n:tl(t,n),Ba(n.message)&&void 0!==n.message.usage_metadata&&(r={tokenUsage:{promptTokens:n.message.usage_metadata.input_tokens,completionTokens:n.message.usage_metadata.output_tokens,totalTokens:n.message.usage_metadata.total_tokens}})}if(void 0===t)throw new Error("Received empty response from chat model call.");c.push([t]),await(i?.[0].handleLLMEnd({generations:c,llmOutput:r}))}catch(e){throw await(i?.[0].handleLLMError(e)),e}else{const e=await Promise.allSettled(a.map(async(e,t)=>{const r=await this._generate(e,{...n,promptIndex:t},i?.[t]);if("v1"===o)for(const e of r.generations)e.message=F_(e.message);return r}));await Promise.all(e.map(async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations){if(null==e.message.id){const t=i?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),c[t]=n.generations,l[t]=n.llmOutput,i?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(i?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)}))}const u={generations:c,llmOutput:l.length?this._combineLLMOutput?.(...l):void 0};return Object.defineProperty(u,Rl,{value:i?{runIds:i?.map(e=>e.runId)}:void 0,configurable:!0}),u}async _generateCached({messages:t,cache:n,llmStringKey:r,parsedOptions:s,handledOptions:a}){const i=t.map(e=>e.map(Wa)),o={...a.metadata,...this.getLsParams(s)},c=await Uc.configure(a.callbacks,this.callbacks,a.tags,this.tags,o,this.metadata,{verbose:this.verbose}),l={options:s,invocation_params:this?.invocationParams(s),batch_size:1},u=await(c?.handleChatModelStart(this.toJSON(),i.map(B_),a.runId,void 0,l,void 0,void 0,a.runName)),d=[],p=(await Promise.allSettled(i.map(async(t,s)=>{const a=e._convertInputToPromptValue(t).toString(),i=await n.lookup(a,r);return null==i&&d.push(s),i}))).map((e,t)=>({result:e,runManager:u?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),h=s.outputVersion??this.outputVersion,m=[];await Promise.all(p.map(async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return m[n]=r.map(e=>("message"in e&&Gs(e.message)&&Fa(e.message)&&(e.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0},"v1"===h&&(e.message=F_(e.message))),e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]},void 0,void 0,void 0,{cached:!0})}return await(t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(e.reason)}));const f={generations:m,missingPromptIndices:d,startedRunManagers:u};return Object.defineProperty(f,Rl,{value:u?{runIds:u?.map(e=>e.runId)}:void 0,configurable:!0}),f}async generate(t,n,r){let s;s=Array.isArray(n)?{stop:n}:n;const a=t.map(e=>e.map(Wa)),[i,o]=this._separateRunnableConfigFromCallOptionsCompat(s);if(i.callbacks=i.callbacks??r,!this.cache)return this._generateUncached(a,o,i);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:u,missingPromptIndices:d,startedRunManagers:p}=await this._generateCached({messages:a,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:i});let h={};if(d.length>0){const t=await this._generateUncached(d.map(e=>a[e]),o,i,void 0!==p?d.map(e=>p?.[e]):void 0);await Promise.all(t.generations.map(async(t,n)=>{const r=d[n];u[r]=t;const s=e._convertInputToPromptValue(a[r]).toString();return c.update(s,l,t)})),h=t.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}async generatePrompt(e,t,n){const r=e.map(e=>e.toChatMessages());return this.generate(r,t,n)}withStructuredOutput(e,t){if("function"!=typeof this.bindTools)throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw new Error('"strict" mode is not supported for this model by default.');const n=e,r=t?.name,s=ch(n)??"A function available to call.",a=t?.method,i=t?.includeRaw;if("jsonMode"===a)throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o,c=r??"extract";eh(n)?o=[{type:"function",function:{name:c,description:s,parameters:mg(n)}}]:("name"in n&&(c=n.name),o=[{type:"function",function:{name:c,description:s,parameters:n}}]);const l=this.bindTools(o),u=Pg.from(e=>{if(!Za.isInstance(e))throw new Error("Input is not an AIMessageChunk.");if(!e.tool_calls||0===e.tool_calls.length)throw new Error("No tool calls found in the response.");const t=e.tool_calls.find(e=>e.name===c);if(!t)throw new Error(`No tool call found with name ${c}.`);return t.args});if(!i)return l.pipe(u).withConfig({runName:"StructuredOutput"});const d=D_.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),p=D_.assign({parsed:()=>null}),h=d.withFallbacks({fallbacks:[p]});return $g.from([{raw:l},h]).withConfig({runName:"StructuredOutputRunnable"})}},q_=class extends Z_{async _generate(e,t,n){const r=await this._call(e,t,n),s=new Da(r);if("string"!=typeof s.content)throw new Error("Cannot generate with a simple chat model when output is not a string.");return{generations:[{text:s.content,message:s}]}}},V_=class extends Eg{static lc_name(){return"RouterRunnable"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;runnables;constructor(e){super(e),this.runnables=e.runnables}async invoke(e,t){const{key:n,input:r}=e,s=this.runnables[n];if(void 0===s)throw new Error(`No runnable associated with key "${n}".`);return s.invoke(r,Gc(t))}async batch(e,t,n){const r=e.map(e=>e.key),s=e.map(e=>e.input),a=r.find(e=>void 0===this.runnables[e]);if(void 0!==a)throw new Error("One or more keys do not have a corresponding runnable.");const i=r.map(e=>this.runnables[e]),o=this._getOptionsList(t??{},e.length),c=o[0]?.maxConcurrency??n?.maxConcurrency,l=c&&c>0?c:e.length,u=[];for(let e=0;e<s.length;e+=l){const t=s.slice(e,e+l).map((e,t)=>i[t].invoke(e,o[t])),n=await Promise.all(t);u.push(n)}return u.flat()}async stream(e,t){const{key:n,input:r}=e,s=this.runnables[n];if(void 0===s)throw new Error(`No runnable associated with key "${n}".`);return s.stream(r,t)}},H_=class extends Eg{static lc_name(){return"RunnableBranch"}lc_namespace=["langchain_core","runnables"];lc_serializable=!0;default;branches;constructor(e){super(e),this.branches=e.branches,this.default=e.default}static from(e){if(e.length<1)throw new Error("RunnableBranch requires at least one branch");return new this({branches:e.slice(0,-1).map(([e,t])=>[Lg(e),Lg(t)]),default:Lg(e[e.length-1])})}async _invoke(e,t,n){let r;for(let s=0;s<this.branches.length;s+=1){const[a,i]=this.branches[s];if(await a.invoke(e,Jc(t,{callbacks:n?.getChild(`condition:${s+1}`)}))){r=await i.invoke(e,Jc(t,{callbacks:n?.getChild(`branch:${s+1}`)}));break}}return r||(r=await this.default.invoke(e,Jc(t,{callbacks:n?.getChild("branch:default")}))),r}async invoke(e,t={}){return this._callWithConfig(this._invoke,e,t)}async*_streamIterator(e,t){const n=await Vc(t),r=await(n?.handleChainStart(this.toJSON(),Ig(e,"input"),t?.runId,void 0,void 0,void 0,t?.runName));let s,a,i=!0;try{for(let n=0;n<this.branches.length;n+=1){const[o,c]=this.branches[n];if(await o.invoke(e,Jc(t,{callbacks:r?.getChild(`condition:${n+1}`)}))){a=await c.stream(e,Jc(t,{callbacks:r?.getChild(`branch:${n+1}`)}));for await(const e of a)if(yield e,i)if(void 0===s)s=e;else try{s=tl(s,e)}catch{s=void 0,i=!1}break}}if(void 0===a){a=await this.default.stream(e,Jc(t,{callbacks:r?.getChild("branch:default")}));for await(const e of a)if(yield e,i)if(void 0===s)s=e;else try{s=tl(s,e)}catch{s=void 0,i=!1}}}catch(e){throw await(r?.handleChainError(e)),e}await(r?.handleChainEnd(s??{}))}},W_=class extends Og{runnable;inputMessagesKey;outputMessagesKey;historyMessagesKey;getMessageHistory;constructor(e){let t=Pg.from((e,t)=>this._enterHistory(e,t??{})).withConfig({runName:"loadHistory"});const n=e.historyMessagesKey??e.inputMessagesKey;n&&(t=D_.assign({[n]:t}).withConfig({runName:"insertHistory"}));const r=t.pipe(e.runnable.withListeners({onEnd:(e,t)=>this._exitHistory(e,t??{})})).withConfig({runName:"RunnableWithMessageHistory"}),s=e.config??{};super({...e,config:s,bound:r}),this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if("object"!=typeof e||Array.isArray(e)||Gs(e))t=e;else{let n;n=this.inputMessagesKey?this.inputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"input",t=Array.isArray(e[n])&&Array.isArray(e[n][0])?e[n][0]:e[n]}if("string"==typeof t)return[new fa(t)];if(Array.isArray(t))return t;if(Gs(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.\nGot ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(Array.isArray(e)||Gs(e)||"string"==typeof e)t=e;else{let n;n=void 0!==this.outputMessagesKey?this.outputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"output",t=void 0!==e.generations?e.generations[0][0].message:e[n]}if("string"==typeof t)return[new Da(t)];if(Array.isArray(t))return t;if(Gs(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){const n=t?.configurable?.messageHistory,r=await n.getMessages();return void 0===this.historyMessagesKey?r.concat(this._getInputMessages(e)):r}async _exitHistory(e,t){const n=t.configurable?.messageHistory;let r;r=Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?e.inputs[0]:e.inputs;let s=this._getInputMessages(r);if(void 0===this.historyMessagesKey){const e=await n.getMessages();s=s.slice(e.length)}const a=e.outputs;if(!a)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const i=this._getOutputMessages(a);await n.addMessages([...s,...i])}async _mergeConfig(...e){const t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){const e={[this.inputMessagesKey??"input"]:"foo"},t={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()\neg. chain.invoke(${JSON.stringify(e)}, ${JSON.stringify(t)})`)}const{sessionId:n}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(n),t}};Yr({},{RouterRunnable:()=>V_,Runnable:()=>Eg,RunnableAssign:()=>Mg,RunnableBinding:()=>Og,RunnableBranch:()=>H_,RunnableEach:()=>Sg,RunnableLambda:()=>Pg,RunnableMap:()=>Cg,RunnableParallel:()=>Rg,RunnablePassthrough:()=>D_,RunnablePick:()=>zg,RunnableRetry:()=>Ag,RunnableSequence:()=>$g,RunnableToolLike:()=>Ug,RunnableWithFallbacks:()=>jg,RunnableWithMessageHistory:()=>W_,_coerceToRunnable:()=>Lg,ensureConfig:()=>Gc,getCallbackManagerForConfig:()=>Vc,mergeConfigs:()=>Hc,patchConfig:()=>Jc,pickRunnableConfigKeys:()=>Kc,raceWithSignal:()=>Xc});var G_=class extends Eg{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig(async(e,t)=>this.parseResult([{text:e}],t?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks),e,{...t,runType:"parser"})}},J_=class extends G_{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}},K_=class extends Error{llmOutput;observation;sendToLLM;constructor(e,t,n,r=!1){if(super(e),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Ta(this,"OUTPUT_PARSING_FAILURE")}},X_=class extends J_{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},Y_=class extends X_{diff=!1;constructor(e){super(e),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const r of e){if("string"!=typeof r&&"string"!=typeof r.content)throw new Error("Cannot handle non-string output.");let e;if(Js(r)){if("string"!=typeof r.content)throw new Error("Cannot handle non-string message output.");e=new Ll({message:r,text:r.content})}else if(Gs(r)){if("string"!=typeof r.content)throw new Error("Cannot handle non-string message output.");e=new Ll({message:Ya(r),text:r.content})}else e=new jl({text:r});n=void 0===n?e:n.concat(e);const s=await this.parsePartialResult([n]);null==s||Wf(s,t)||(this.diff?yield this._diff(t,s):yield s,t=s)}}getFormatInstructions(){return""}};Yr({},{applyPatch:()=>bl,compare:()=>Ol});var Q_=class extends Y_{static lc_name(){return"JsonOutputParser"}lc_namespace=["langchain_core","output_parsers"];lc_serializable=!0;_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?Ol(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Oa(e[0].text)}async parse(e){return Oa(e,JSON.parse)}getFormatInstructions(){return""}},ev=class extends X_{static lc_name(){return"BytesOutputParser"}lc_namespace=["langchain_core","output_parsers","bytes"];lc_serializable=!0;textEncoder=new TextEncoder;parse(e){return Promise.resolve(this.textEncoder.encode(e))}getFormatInstructions(){return""}},tv=class extends X_{re;async*_transform(e){let t="";for await(const n of e)if(t+="string"==typeof n?n:n.content,this.re){const e=[...t.matchAll(this.re)];if(e.length>1){let n=0;for(const t of e.slice(0,-1))yield[t[1]],n+=(t.index??0)+t[0].length;t=t.slice(n)}}else{const e=await this.parse(t);if(e.length>1){for(const t of e.slice(0,-1))yield[t];t=e[e.length-1]}}for(const e of await this.parse(t))yield[e]}},nv=class extends tv{static lc_name(){return"CommaSeparatedListOutputParser"}lc_namespace=["langchain_core","output_parsers","list"];lc_serializable=!0;async parse(e){try{return e.trim().split(",").map(e=>e.trim())}catch{throw new K_(`Could not parse output: ${e}`,e)}}getFormatInstructions(){return"Your response should be a list of comma separated values, eg: `foo, bar, baz`"}},rv=class extends tv{lc_namespace=["langchain_core","output_parsers","list"];length;separator;constructor({length:e,separator:t}){super(...arguments),this.length=e,this.separator=t||","}async parse(e){try{const t=e.trim().split(this.separator).map(e=>e.trim());if(void 0!==this.length&&t.length!==this.length)throw new K_(`Incorrect number of items. Expected ${this.length}, got ${t.length}.`);return t}catch(t){if(Object.getPrototypeOf(t)===K_.prototype)throw t;throw new K_(`Could not parse output: ${e}`)}}getFormatInstructions(){return`Your response should be a list of ${void 0===this.length?"":`${this.length} `}items separated by "${this.separator}" (eg: \`foo${this.separator} bar${this.separator} baz\`)`}},sv=class extends tv{static lc_name(){return"NumberedListOutputParser"}lc_namespace=["langchain_core","output_parsers","list"];lc_serializable=!0;getFormatInstructions(){return"Your response should be a numbered list with each item on a new line. For example: \n\n1. foo\n\n2. bar\n\n3. baz"}re=/\d+\.\s([^\n]+)/g;async parse(e){return[...e.matchAll(this.re)??[]].map(e=>e[1])}},av=class extends tv{static lc_name(){return"NumberedListOutputParser"}lc_namespace=["langchain_core","output_parsers","list"];lc_serializable=!0;getFormatInstructions(){return"Your response should be a numbered list with each item on a new line. For example: \n\n1. foo\n\n2. bar\n\n3. baz"}re=/^\s*[-*]\s([^\n]+)$/gm;async parse(e){return[...e.matchAll(this.re)??[]].map(e=>e[1])}},iv=class extends X_{static lc_name(){return"StrOutputParser"}lc_namespace=["langchain_core","output_parsers","string"];lc_serializable=!0;parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentToString(e){switch(e.type){case"text":case"text_delta":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce((e,t)=>e+this._messageContentToString(t),"")}},ov=class extends J_{static lc_name(){return"StructuredOutputParser"}lc_namespace=["langchain","output_parsers","structured"];toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),this.schema=e}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(mf(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,pf().describe(t)]))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify(mg(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=e.trim(),n=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(e,t)=>`"${t.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await ah(this.schema,JSON.parse(n))}catch(t){throw new K_(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}},cv=class extends ov{static lc_name(){return"JsonMarkdownStructuredOutputParser"}getFormatInstructions(e){const t=e?.interpolationDepth??1;if(t<1)throw new Error("f string interpolation depth must be at least 1");return`Return a markdown code snippet with a JSON object formatted to look like:\n\`\`\`json\n${this._schemaToInstruction(mg(this.schema)).replaceAll("{","{".repeat(t)).replaceAll("}","}".repeat(t))}\n\`\`\``}_schemaToInstruction(e,t=2){const n=e;if("type"in n){let e,r=!1;if(Array.isArray(n.type)){const t=n.type.findIndex(e=>"null"===e);-1!==t&&(r=!0,n.type.splice(t,1)),e=n.type.join(" | ")}else e=n.type;if("object"===n.type&&n.properties){const e=n.description?` // ${n.description}`:"",r=Object.entries(n.properties).map(([e,r])=>{const s=n.required?.includes(e)?"":" (optional)";return`${" ".repeat(t)}"${e}": ${this._schemaToInstruction(r,t+2)}${s}`}).join("\n");return`{\n${r}\n${" ".repeat(t-2)}}${e}`}if("array"===n.type&&n.items){const e=n.description?` // ${n.description}`:"";return`array[\n${" ".repeat(t)}${this._schemaToInstruction(n.items,t+2)}\n${" ".repeat(t-2)}] ${e}`}const s=r?" (nullable)":"";return`${e}${n.description?` // ${n.description}`:""}${s}`}if("anyOf"in n)return n.anyOf.map(e=>this._schemaToInstruction(e,t)).join(`\n${" ".repeat(t-2)}`);throw new Error("unsupported schema type")}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(mf(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,pf().describe(t)]))))}},lv=class extends J_{structuredInputParser;constructor({inputSchema:e}){super(...arguments),this.structuredInputParser=new cv(e)}async parse(e){let t;try{t=await this.structuredInputParser.parse(e)}catch(t){throw new K_(`Failed to parse. Text: "${e}". Error: ${t}`,e)}return this.outputProcessor(t)}getFormatInstructions(){return this.structuredInputParser.getFormatInstructions()}};const uv=function(){const e={parser:function(e,t){return new n(e,t)}};e.SAXParser=n,e.SAXStream=a,e.createStream=function(e,t){return new a(e,t)},e.MAX_BUFFER_LENGTH=65536;const t=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];function n(r,s){if(!(this instanceof n))return new n(r,s);var a=this;!function(e){for(var n=0,r=t.length;n<r;n++)e[t[n]]=""}(a),a.q=a.c="",a.bufferCheckPosition=e.MAX_BUFFER_LENGTH,a.opt=s||{},a.opt.lowercase=a.opt.lowercase||a.opt.lowercasetags,a.looseCase=a.opt.lowercase?"toLowerCase":"toUpperCase",a.tags=[],a.closed=a.closedRoot=a.sawRoot=!1,a.tag=a.error=null,a.strict=!!r,a.noscript=!(!r&&!a.opt.noscript),a.state=k.BEGIN,a.strictEntities=a.opt.strictEntities,a.ENTITIES=a.strictEntities?Object.create(e.XML_ENTITIES):Object.create(e.ENTITIES),a.attribList=[],a.opt.xmlns&&(a.ns=Object.create(u)),a.trackPosition=!1!==a.opt.position,a.trackPosition&&(a.position=a.line=a.column=0),I(a,"onready")}e.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"],Object.create||(Object.create=function(e){function t(){}return t.prototype=e,new t}),Object.keys||(Object.keys=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t}),n.prototype={end:function(){$(this)},write:function(n){var r=this;if(this.error)throw this.error;if(r.closed)return A(r,"Cannot write after close. Assign an onready handler.");if(null===n)return $(r);"object"==typeof n&&(n=n.toString());for(var s=0,a="";a=U(n,s++),r.c=a,a;)switch(r.trackPosition&&(r.position++,"\n"===a?(r.line++,r.column=0):r.column++),r.state){case k.BEGIN:if(r.state=k.BEGIN_WHITESPACE,"\ufeff"===a)continue;z(r,a);continue;case k.BEGIN_WHITESPACE:z(r,a);continue;case k.TEXT:if(r.sawRoot&&!r.closedRoot){for(var c=s-1;a&&"<"!==a&&"&"!==a;)(a=U(n,s++))&&r.trackPosition&&(r.position++,"\n"===a?(r.line++,r.column=0):r.column++);r.textNode+=n.substring(c,s-1)}"<"!==a||r.sawRoot&&r.closedRoot&&!r.strict?(f(a)||r.sawRoot&&!r.closedRoot||C(r,"Text data outside of root node."),"&"===a?r.state=k.TEXT_ENTITY:r.textNode+=a):(r.state=k.OPEN_WAKA,r.startTagPosition=r.position);continue;case k.SCRIPT:"<"===a?r.state=k.SCRIPT_ENDING:r.script+=a;continue;case k.SCRIPT_ENDING:"/"===a?r.state=k.CLOSE_TAG:(r.script+="<"+a,r.state=k.SCRIPT);continue;case k.OPEN_WAKA:if("!"===a)r.state=k.SGML_DECL,r.sgmlDecl="";else if(f(a));else if(_(d,a))r.state=k.OPEN_TAG,r.tagName=a;else if("/"===a)r.state=k.CLOSE_TAG,r.tagName="";else if("?"===a)r.state=k.PROC_INST,r.procInstName=r.procInstBody="";else{if(C(r,"Unencoded <"),r.startTagPosition+1<r.position){var l=r.position-r.startTagPosition;a=new Array(l).join(" ")+a}r.textNode+="<"+a,r.state=k.TEXT}continue;case k.SGML_DECL:(r.sgmlDecl+a).toUpperCase()===i?(E(r,"onopencdata"),r.state=k.CDATA,r.sgmlDecl="",r.cdata=""):r.sgmlDecl+a==="--"?(r.state=k.COMMENT,r.comment="",r.sgmlDecl=""):(r.sgmlDecl+a).toUpperCase()===o?(r.state=k.DOCTYPE,(r.doctype||r.sawRoot)&&C(r,"Inappropriately located doctype declaration"),r.doctype="",r.sgmlDecl=""):">"===a?(E(r,"onsgmldeclaration",r.sgmlDecl),r.sgmlDecl="",r.state=k.TEXT):g(a)?(r.state=k.SGML_DECL_QUOTED,r.sgmlDecl+=a):r.sgmlDecl+=a;continue;case k.SGML_DECL_QUOTED:a===r.q&&(r.state=k.SGML_DECL,r.q=""),r.sgmlDecl+=a;continue;case k.DOCTYPE:">"===a?(r.state=k.TEXT,E(r,"ondoctype",r.doctype),r.doctype=!0):(r.doctype+=a,"["===a?r.state=k.DOCTYPE_DTD:g(a)&&(r.state=k.DOCTYPE_QUOTED,r.q=a));continue;case k.DOCTYPE_QUOTED:r.doctype+=a,a===r.q&&(r.q="",r.state=k.DOCTYPE);continue;case k.DOCTYPE_DTD:r.doctype+=a,"]"===a?r.state=k.DOCTYPE:g(a)&&(r.state=k.DOCTYPE_DTD_QUOTED,r.q=a);continue;case k.DOCTYPE_DTD_QUOTED:r.doctype+=a,a===r.q&&(r.state=k.DOCTYPE_DTD,r.q="");continue;case k.COMMENT:"-"===a?r.state=k.COMMENT_ENDING:r.comment+=a;continue;case k.COMMENT_ENDING:"-"===a?(r.state=k.COMMENT_ENDED,r.comment=S(r.opt,r.comment),r.comment&&E(r,"oncomment",r.comment),r.comment=""):(r.comment+="-"+a,r.state=k.COMMENT);continue;case k.COMMENT_ENDED:">"!==a?(C(r,"Malformed comment"),r.comment+="--"+a,r.state=k.COMMENT):r.state=k.TEXT;continue;case k.CDATA:"]"===a?r.state=k.CDATA_ENDING:r.cdata+=a;continue;case k.CDATA_ENDING:"]"===a?r.state=k.CDATA_ENDING_2:(r.cdata+="]"+a,r.state=k.CDATA);continue;case k.CDATA_ENDING_2:">"===a?(r.cdata&&E(r,"oncdata",r.cdata),E(r,"onclosecdata"),r.cdata="",r.state=k.TEXT):"]"===a?r.cdata+="]":(r.cdata+="]]"+a,r.state=k.CDATA);continue;case k.PROC_INST:"?"===a?r.state=k.PROC_INST_ENDING:f(a)?r.state=k.PROC_INST_BODY:r.procInstName+=a;continue;case k.PROC_INST_BODY:if(!r.procInstBody&&f(a))continue;"?"===a?r.state=k.PROC_INST_ENDING:r.procInstBody+=a;continue;case k.PROC_INST_ENDING:">"===a?(E(r,"onprocessinginstruction",{name:r.procInstName,body:r.procInstBody}),r.procInstName=r.procInstBody="",r.state=k.TEXT):(r.procInstBody+="?"+a,r.state=k.PROC_INST_BODY);continue;case k.OPEN_TAG:_(p,a)?r.tagName+=a:(N(r),">"===a?j(r):"/"===a?r.state=k.OPEN_TAG_SLASH:(f(a)||C(r,"Invalid character in tag name"),r.state=k.ATTRIB));continue;case k.OPEN_TAG_SLASH:">"===a?(j(r,!0),L(r)):(C(r,"Forward-slash in opening tag not followed by >"),r.state=k.ATTRIB);continue;case k.ATTRIB:if(f(a))continue;">"===a?j(r):"/"===a?r.state=k.OPEN_TAG_SLASH:_(d,a)?(r.attribName=a,r.attribValue="",r.state=k.ATTRIB_NAME):C(r,"Invalid attribute name");continue;case k.ATTRIB_NAME:"="===a?r.state=k.ATTRIB_VALUE:">"===a?(C(r,"Attribute without value"),r.attribValue=r.attribName,R(r),j(r)):f(a)?r.state=k.ATTRIB_NAME_SAW_WHITE:_(p,a)?r.attribName+=a:C(r,"Invalid attribute name");continue;case k.ATTRIB_NAME_SAW_WHITE:if("="===a)r.state=k.ATTRIB_VALUE;else{if(f(a))continue;C(r,"Attribute without value"),r.tag.attributes[r.attribName]="",r.attribValue="",E(r,"onattribute",{name:r.attribName,value:""}),r.attribName="",">"===a?j(r):_(d,a)?(r.attribName=a,r.state=k.ATTRIB_NAME):(C(r,"Invalid attribute name"),r.state=k.ATTRIB)}continue;case k.ATTRIB_VALUE:if(f(a))continue;g(a)?(r.q=a,r.state=k.ATTRIB_VALUE_QUOTED):(C(r,"Unquoted attribute value"),r.state=k.ATTRIB_VALUE_UNQUOTED,r.attribValue=a);continue;case k.ATTRIB_VALUE_QUOTED:if(a!==r.q){"&"===a?r.state=k.ATTRIB_VALUE_ENTITY_Q:r.attribValue+=a;continue}R(r),r.q="",r.state=k.ATTRIB_VALUE_CLOSED;continue;case k.ATTRIB_VALUE_CLOSED:f(a)?r.state=k.ATTRIB:">"===a?j(r):"/"===a?r.state=k.OPEN_TAG_SLASH:_(d,a)?(C(r,"No whitespace between attributes"),r.attribName=a,r.attribValue="",r.state=k.ATTRIB_NAME):C(r,"Invalid attribute name");continue;case k.ATTRIB_VALUE_UNQUOTED:if(!y(a)){"&"===a?r.state=k.ATTRIB_VALUE_ENTITY_U:r.attribValue+=a;continue}R(r),">"===a?j(r):r.state=k.ATTRIB;continue;case k.CLOSE_TAG:if(r.tagName)">"===a?L(r):_(p,a)?r.tagName+=a:r.script?(r.script+="</"+r.tagName,r.tagName="",r.state=k.SCRIPT):(f(a)||C(r,"Invalid tagname in closing tag"),r.state=k.CLOSE_TAG_SAW_WHITE);else{if(f(a))continue;v(d,a)?r.script?(r.script+="</"+a,r.state=k.SCRIPT):C(r,"Invalid tagname in closing tag."):r.tagName=a}continue;case k.CLOSE_TAG_SAW_WHITE:if(f(a))continue;">"===a?L(r):C(r,"Invalid characters in closing tag");continue;case k.TEXT_ENTITY:case k.ATTRIB_VALUE_ENTITY_Q:case k.ATTRIB_VALUE_ENTITY_U:var u,w;switch(r.state){case k.TEXT_ENTITY:u=k.TEXT,w="textNode";break;case k.ATTRIB_VALUE_ENTITY_Q:u=k.ATTRIB_VALUE_QUOTED,w="attribValue";break;case k.ATTRIB_VALUE_ENTITY_U:u=k.ATTRIB_VALUE_UNQUOTED,w="attribValue"}if(";"===a)if(r.opt.unparsedEntities){var b=M(r);r.entity="",r.state=u,r.write(b)}else r[w]+=M(r),r.entity="",r.state=u;else _(r.entity.length?m:h,a)?r.entity+=a:(C(r,"Invalid character in entity name"),r[w]+="&"+r.entity+a,r.entity="",r.state=u);continue;default:throw new Error(r,"Unknown state: "+r.state)}return r.position>=r.bufferCheckPosition&&function(n){for(var r=Math.max(e.MAX_BUFFER_LENGTH,10),s=0,a=0,i=t.length;a<i;a++){var o=n[t[a]].length;if(o>r)switch(t[a]){case"textNode":O(n);break;case"cdata":E(n,"oncdata",n.cdata),n.cdata="";break;case"script":E(n,"onscript",n.script),n.script="";break;default:A(n,"Max buffer length exceeded: "+t[a])}s=Math.max(s,o)}var c=e.MAX_BUFFER_LENGTH-s;n.bufferCheckPosition=c+n.position}(r),r},resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){var e;O(e=this),""!==e.cdata&&(E(e,"oncdata",e.cdata),e.cdata=""),""!==e.script&&(E(e,"onscript",e.script),e.script="")}};var r=ReadableStream;r||(r=function(){});var s=e.EVENTS.filter(function(e){return"error"!==e&&"end"!==e});function a(e,t){if(!(this instanceof a))return new a(e,t);r.apply(this),this._parser=new n(e,t),this.writable=!0,this.readable=!0;var i=this;this._parser.onend=function(){i.emit("end")},this._parser.onerror=function(e){i.emit("error",e),i._parser.error=null},this._decoder=null,s.forEach(function(e){Object.defineProperty(i,"on"+e,{get:function(){return i._parser["on"+e]},set:function(t){if(!t)return i.removeAllListeners(e),i._parser["on"+e]=t,t;i.on(e,t)},enumerable:!0,configurable:!1})})}a.prototype=Object.create(r.prototype,{constructor:{value:a}}),a.prototype.write=function(e){return this._parser.write(e.toString()),this.emit("data",e),!0},a.prototype.end=function(e){return e&&e.length&&this.write(e),this._parser.end(),!0},a.prototype.on=function(e,t){var n=this;return n._parser["on"+e]||-1===s.indexOf(e)||(n._parser["on"+e]=function(){var t=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);t.splice(0,0,e),n.emit.apply(n,t)}),r.prototype.on.call(n,e,t)};var i="[CDATA[",o="DOCTYPE",c="http://www.w3.org/XML/1998/namespace",l="http://www.w3.org/2000/xmlns/",u={xml:c,xmlns:l},d=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,p=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,h=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,m=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function f(e){return" "===e||"\n"===e||"\r"===e||"\t"===e}function g(e){return'"'===e||"'"===e}function y(e){return">"===e||f(e)}function _(e,t){return e.test(t)}function v(e,t){return!_(e,t)}var w,b,x,k=0;for(var T in e.STATE={BEGIN:k++,BEGIN_WHITESPACE:k++,TEXT:k++,TEXT_ENTITY:k++,OPEN_WAKA:k++,SGML_DECL:k++,SGML_DECL_QUOTED:k++,DOCTYPE:k++,DOCTYPE_QUOTED:k++,DOCTYPE_DTD:k++,DOCTYPE_DTD_QUOTED:k++,COMMENT_STARTING:k++,COMMENT:k++,COMMENT_ENDING:k++,COMMENT_ENDED:k++,CDATA:k++,CDATA_ENDING:k++,CDATA_ENDING_2:k++,PROC_INST:k++,PROC_INST_BODY:k++,PROC_INST_ENDING:k++,OPEN_TAG:k++,OPEN_TAG_SLASH:k++,ATTRIB:k++,ATTRIB_NAME:k++,ATTRIB_NAME_SAW_WHITE:k++,ATTRIB_VALUE:k++,ATTRIB_VALUE_QUOTED:k++,ATTRIB_VALUE_CLOSED:k++,ATTRIB_VALUE_UNQUOTED:k++,ATTRIB_VALUE_ENTITY_Q:k++,ATTRIB_VALUE_ENTITY_U:k++,CLOSE_TAG:k++,CLOSE_TAG_SAW_WHITE:k++,SCRIPT:k++,SCRIPT_ENDING:k++},e.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},e.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(e.ENTITIES).forEach(function(t){var n=e.ENTITIES[t],r="number"==typeof n?String.fromCharCode(n):n;e.ENTITIES[t]=r}),e.STATE)e.STATE[e.STATE[T]]=T;function I(e,t,n){e[t]&&e[t](n)}function E(e,t,n){e.textNode&&O(e),I(e,t,n)}function O(e){e.textNode=S(e.opt,e.textNode),e.textNode&&I(e,"ontext",e.textNode),e.textNode=""}function S(e,t){return e.trim&&(t=t.trim()),e.normalize&&(t=t.replace(/\s+/g," ")),t}function A(e,t){return O(e),e.trackPosition&&(t+="\nLine: "+e.line+"\nColumn: "+e.column+"\nChar: "+e.c),t=new Error(t),e.error=t,I(e,"onerror",t),e}function $(e){return e.sawRoot&&!e.closedRoot&&C(e,"Unclosed root tag"),e.state!==k.BEGIN&&e.state!==k.BEGIN_WHITESPACE&&e.state!==k.TEXT&&A(e,"Unexpected end"),O(e),e.c="",e.closed=!0,I(e,"onend"),n.call(e,e.strict,e.opt),e}function C(e,t){if("object"!=typeof e||!(e instanceof n))throw new Error("bad call to strictFail");e.strict&&A(e,t)}function N(e){e.strict||(e.tagName=e.tagName[e.looseCase]());var t=e.tags[e.tags.length-1]||e,n=e.tag={name:e.tagName,attributes:{}};e.opt.xmlns&&(n.ns=t.ns),e.attribList.length=0,E(e,"onopentagstart",n)}function P(e,t){var n=e.indexOf(":")<0?["",e]:e.split(":"),r=n[0],s=n[1];return t&&"xmlns"===e&&(r="xmlns",s=""),{prefix:r,local:s}}function R(e){if(e.strict||(e.attribName=e.attribName[e.looseCase]()),-1!==e.attribList.indexOf(e.attribName)||e.tag.attributes.hasOwnProperty(e.attribName))e.attribName=e.attribValue="";else{if(e.opt.xmlns){var t=P(e.attribName,!0),n=t.prefix,r=t.local;if("xmlns"===n)if("xml"===r&&e.attribValue!==c)C(e,"xml: prefix must be bound to "+c+"\nActual: "+e.attribValue);else if("xmlns"===r&&e.attribValue!==l)C(e,"xmlns: prefix must be bound to "+l+"\nActual: "+e.attribValue);else{var s=e.tag,a=e.tags[e.tags.length-1]||e;s.ns===a.ns&&(s.ns=Object.create(a.ns)),s.ns[r]=e.attribValue}e.attribList.push([e.attribName,e.attribValue])}else e.tag.attributes[e.attribName]=e.attribValue,E(e,"onattribute",{name:e.attribName,value:e.attribValue});e.attribName=e.attribValue=""}}function j(e,t){if(e.opt.xmlns){var n=e.tag,r=P(e.tagName);n.prefix=r.prefix,n.local=r.local,n.uri=n.ns[r.prefix]||"",n.prefix&&!n.uri&&(C(e,"Unbound namespace prefix: "+JSON.stringify(e.tagName)),n.uri=r.prefix);var s=e.tags[e.tags.length-1]||e;n.ns&&s.ns!==n.ns&&Object.keys(n.ns).forEach(function(t){E(e,"onopennamespace",{prefix:t,uri:n.ns[t]})});for(var a=0,i=e.attribList.length;a<i;a++){var o=e.attribList[a],c=o[0],l=o[1],u=P(c,!0),d=u.prefix,p=u.local,h=""===d?"":n.ns[d]||"",m={name:c,value:l,prefix:d,local:p,uri:h};d&&"xmlns"!==d&&!h&&(C(e,"Unbound namespace prefix: "+JSON.stringify(d)),m.uri=d),e.tag.attributes[c]=m,E(e,"onattribute",m)}e.attribList.length=0}e.tag.isSelfClosing=!!t,e.sawRoot=!0,e.tags.push(e.tag),E(e,"onopentag",e.tag),t||(e.noscript||"script"!==e.tagName.toLowerCase()?e.state=k.TEXT:e.state=k.SCRIPT,e.tag=null,e.tagName=""),e.attribName=e.attribValue="",e.attribList.length=0}function L(e){if(!e.tagName)return C(e,"Weird empty close tag."),e.textNode+="</>",void(e.state=k.TEXT);if(e.script){if("script"!==e.tagName)return e.script+="</"+e.tagName+">",e.tagName="",void(e.state=k.SCRIPT);E(e,"onscript",e.script),e.script=""}var t=e.tags.length,n=e.tagName;e.strict||(n=n[e.looseCase]());for(var r=n;t--&&e.tags[t].name!==r;)C(e,"Unexpected close tag");if(t<0)return C(e,"Unmatched closing tag: "+e.tagName),e.textNode+="</"+e.tagName+">",void(e.state=k.TEXT);e.tagName=n;for(var s=e.tags.length;s-- >t;){var a=e.tag=e.tags.pop();e.tagName=e.tag.name,E(e,"onclosetag",e.tagName);var i={};for(var o in a.ns)i[o]=a.ns[o];var c=e.tags[e.tags.length-1]||e;e.opt.xmlns&&a.ns!==c.ns&&Object.keys(a.ns).forEach(function(t){var n=a.ns[t];E(e,"onclosenamespace",{prefix:t,uri:n})})}0===t&&(e.closedRoot=!0),e.tagName=e.attribValue=e.attribName="",e.attribList.length=0,e.state=k.TEXT}function M(e){var t,n=e.entity,r=n.toLowerCase(),s="";return e.ENTITIES[n]?e.ENTITIES[n]:e.ENTITIES[r]?e.ENTITIES[r]:("#"===(n=r).charAt(0)&&("x"===n.charAt(1)?(n=n.slice(2),s=(t=parseInt(n,16)).toString(16)):(n=n.slice(1),s=(t=parseInt(n,10)).toString(10))),n=n.replace(/^0+/,""),isNaN(t)||s.toLowerCase()!==n?(C(e,"Invalid character entity"),"&"+e.entity+";"):String.fromCodePoint(t))}function z(e,t){"<"===t?(e.state=k.OPEN_WAKA,e.startTagPosition=e.position):f(t)||(C(e,"Non-whitespace before first tag."),e.textNode=t,e.state=k.TEXT)}function U(e,t){var n="";return t<e.length&&(n=e.charAt(t)),n}return k=e.STATE,String.fromCodePoint||(w=String.fromCharCode,b=Math.floor,x=function(){var e,t,n=[],r=-1,s=arguments.length;if(!s)return"";for(var a="";++r<s;){var i=Number(arguments[r]);if(!isFinite(i)||i<0||i>1114111||b(i)!==i)throw RangeError("Invalid code point: "+i);i<=65535?n.push(i):(e=55296+((i-=65536)>>10),t=i%1024+56320,n.push(e,t)),(r+1===s||n.length>16384)&&(a+=w.apply(null,n),n.length=0)}return a},Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:x,configurable:!0,writable:!0}):String.fromCodePoint=x),e}(),dv='The output should be formatted as a XML file.\n1. Output should conform to the tags below. \n2. If tags are not given, make them on your own.\n3. Remember to always open and close all the tags.\n\nAs an example, for the tags ["foo", "bar", "baz"]:\n1. String "<foo>\n   <bar>\n      <baz></baz>\n   </bar>\n</foo>" is a well-formatted instance of the schema. \n2. String "<foo>\n   <bar>\n   </foo>" is a badly-formatted instance.\n3. String "<foo>\n   <tag>\n   </tag>\n</foo>" is a badly-formatted instance.\n\nHere are the output tags:\n```\n{tags}\n```';var pv=class extends Y_{tags;constructor(e){super(e),this.tags=e?.tags}static lc_name(){return"XMLOutputParser"}lc_namespace=["langchain_core","output_parsers"];lc_serializable=!0;_diff(e,t){if(t)return e?Ol(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return fv(e[0].text)}async parse(e){return fv(e)}getFormatInstructions(){return this.tags&&this.tags.length>0?dv.replace("{tags}",this.tags?.join(", ")??""):dv}};const hv=e=>e.split("\n").map(e=>e.replace(/^\s+/,"")).join("\n").trim(),mv=e=>{if(0===Object.keys(e).length)return{};const t={};return e.children.length>0?(t[e.name]=e.children.map(mv),t):(t[e.name]=e.text??void 0,t)};function fv(e){const t=hv(e),n=uv.parser(!0);let r={};const s=[];n.onopentag=e=>{const t={name:e.name,attributes:e.attributes,children:[],text:"",isSelfClosing:e.isSelfClosing};s.length>0?s[s.length-1].children.push(t):r=t,e.isSelfClosing||s.push(t)},n.onclosetag=()=>{if(s.length>0){const e=s.pop();0===s.length&&e&&(r=e)}},n.ontext=e=>{s.length>0&&(s[s.length-1].text+=e)},n.onattribute=e=>{s.length>0&&(s[s.length-1].attributes[e.name]=e.value)};const a=/```(xml)?(.*)```/s.exec(t),i=a?a[2]:t;return n.write(i).close(),r&&"?xml"===r.name&&(r=r.children[0]),mv(r)}function gv(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=Sa(e.function.arguments??"{}")}catch{return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new K_([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n,type:"tool_call"};return t?.returnId&&(r.id=e.id),r}function yv(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function _v(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}Yr({},{AsymmetricStructuredOutputParser:()=>lv,BaseCumulativeTransformOutputParser:()=>Y_,BaseLLMOutputParser:()=>G_,BaseOutputParser:()=>J_,BaseTransformOutputParser:()=>X_,BytesOutputParser:()=>ev,CommaSeparatedListOutputParser:()=>nv,CustomListOutputParser:()=>rv,JsonMarkdownStructuredOutputParser:()=>cv,JsonOutputParser:()=>Q_,ListOutputParser:()=>tv,MarkdownListOutputParser:()=>av,NumberedListOutputParser:()=>sv,OutputParserException:()=>K_,StringOutputParser:()=>iv,StructuredOutputParser:()=>ov,XMLOutputParser:()=>pv,XML_FORMAT_INSTRUCTIONS:()=>dv,parseJsonMarkdown:()=>Oa,parsePartialJson:()=>Sa,parseXMLMarkdown:()=>fv});var vv=class extends Y_{static lc_name(){return"JsonOutputToolsParser"}returnId=!1;lc_namespace=["langchain","output_parsers","openai_tools"];lc_serializable=!0;constructor(e){super(e),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){const n=e[0].message;let r;if(Fa(n)&&n.tool_calls?.length?r=n.tool_calls.map(e=>{const{id:t,...n}=e;return this.returnId?{id:t,...n}:n}):void 0!==n.additional_kwargs.tool_calls&&(r=JSON.parse(JSON.stringify(n.additional_kwargs.tool_calls)).map(e=>gv(e,{returnId:this.returnId,partial:t}))),!r)return[];const s=[];for(const e of r)if(void 0!==e){const t={type:e.name,args:e.args,id:e.id};s.push(t)}return s}},wv=class extends vv{static lc_name(){return"JsonOutputKeyToolsParser"}lc_namespace=["langchain","output_parsers","openai_tools"];lc_serializable=!0;returnId=!1;keyName;returnSingle=!1;zodSchema;constructor(e){super(e),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await sh(this.zodSchema,e);if(t.success)return t.data;throw new K_(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter(e=>e.type===this.keyName);let n=t;if(t.length)return this.returnId||(n=t.map(e=>e.args)),this.returnSingle?n[0]:n}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter(e=>e.type===this.keyName);let n=t;if(!t.length)return;if(this.returnId||(n=t.map(e=>e.args)),this.returnSingle)return this._validateResult(n[0]);const r=await Promise.all(n.map(e=>this._validateResult(e)));return r}};Yr({},{JsonOutputKeyToolsParser:()=>wv,JsonOutputToolsParser:()=>vv,convertLangChainToolCallToOpenAI:()=>yv,makeInvalidToolCall:()=>_v,parseToolCall:()=>gv});var bv=class extends Z_{temperature;topP;frequencyPenalty;presencePenalty;n;logitBias;model="gpt-3.5-turbo";modelKwargs;stop;stopSequences;user;timeout;streaming=!1;streamUsage=!0;maxTokens;logprobs;topLogprobs;apiKey;organization;__includeRawResponse;client;clientConfig;supportsStrictToolCalling;audio;modalities;reasoning;zdrEnabled;service_tier;promptCacheKey;promptCacheRetention;verbosity;defaultOptions;_llmType(){return"openai"}static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning","service_tier"]}lc_serializable=!0;get lc_secrets(){return{apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{apiKey:"openai_api_key",modelName:"model"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","model","modelName","modelKwargs","stop","stopSequences","timeout","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","zdrEnabled","reasoning","promptCacheKey","promptCacheRetention","verbosity"]}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}identifyingParams(){return this._identifyingParams()}constructor(e){super(e??{});const t="string"==typeof e?.configuration?.apiKey||"function"==typeof e?.configuration?.apiKey?e?.configuration?.apiKey:void 0;this.apiKey=e?.apiKey??t??di("OPENAI_API_KEY"),this.organization=e?.configuration?.organization??di("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoning=e?.reasoning,this.maxTokens=e?.maxCompletionTokens??e?.maxTokens,this.promptCacheKey=e?.promptCacheKey??this.promptCacheKey,this.promptCacheRetention=e?.promptCacheRetention??this.promptCacheRetention,this.verbosity=e?.verbosity??this.verbosity,this.disableStreaming=!0===e?.disableStreaming,this.streaming=!0===e?.streaming,this.disableStreaming&&(this.streaming=!1),!1===e?.streaming&&(this.disableStreaming=!0),this.streamUsage=e?.streamUsage??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration},void 0!==e?.supportsStrictToolCalling&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),void 0!==e?.service_tier&&(this.service_tier=e.service_tier),this.zdrEnabled=e?.zdrEnabled??!1}_getReasoningParams(e){if(!ey(this.model))return;let t;return void 0!==this.reasoning&&(t={...t,...this.reasoning}),void 0!==e?.reasoning&&(t={...t,...e.reasoning}),t}_getResponseFormat(e){return e&&"json_schema"===e.type&&e.json_schema.schema&&eh(e.json_schema.schema)?n_(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}_combineCallOptions(e){return{...this.defaultOptions,...e??{}}}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:a,azureADTokenProvider:i,azureOpenAIEndpoint:o}=e;if((r||i)&&s&&t)return`${s}/${t}`;if((r||i)&&o&&t)return`${o}/openai/deployments/${t}`;if(r||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return a}({baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,t.defaultHeaders=function(e,t=!1,n="1.0.0"){const r=function(e){const t=Qg(()=>{if(ry(e))return e;if(Array.isArray(e))return new Headers(e);if("object"==typeof e&&null!==e&&"values"in e&&ry(e.values))return e.values;if("object"==typeof e&&null!==e){const t=Object.entries(e).filter(([,e])=>"string"==typeof e).map(([e,t])=>[e,t]);return new Headers(t)}return new Headers});return Object.fromEntries(t.entries())}(e),s=function(){let e=ci();return"node"!==e&&"deno"!==e||(e=`(${e}/${process.version}; ${process.platform}; ${process.arch})`),e}(),a=`langchainjs${t?"-azure":""}-openai`;return{...r,"User-Agent":r["User-Agent"]?`${a}/${n} (${s})${r["User-Agent"]}`:`${a}/${n} (${s})`}}(t.defaultHeaders),this.client=new Jr(t)}return{...this.clientConfig,...e}}_convertChatOpenAIToolToCompletionsTool(e,t){return my(e)?function(e){return{type:"custom",custom:{name:e.name,description:e.description,format:(()=>{if(e.format)return"grammar"===e.format.type?{type:"grammar",grammar:{definition:e.format.definition,syntax:e.format.syntax}}:"text"===e.format.type?{type:"text"}:void 0})()}}}(e.metadata.customTool):L_(e)?void 0!==t?.strict?{...e,function:{...e.function,strict:t.strict}}:e:function(e,t){let n;return n=oy(e)?ly(e):e,void 0!==t?.strict&&(n.function.strict=t.strict),n}(e,t)}bindTools(e,t){let n;return void 0!==t?.strict?n=t.strict:void 0!==this.supportsStrictToolCalling&&(n=this.supportsStrictToolCalling),this.withConfig({tools:e.map(e=>hy(e)||my(e)?e:function(e){return"object"==typeof e&&null!==e&&"extras"in e&&"object"==typeof e.extras&&null!==e.extras&&"providerToolDefinition"in e.extras&&"object"==typeof e.extras.providerToolDefinition&&null!==e.extras.providerToolDefinition}(e)?e.extras.providerToolDefinition:this._convertChatOpenAIToolToCompletionsTool(e,{strict:n})),...t})}async stream(e,t){return super.stream(e,this._combineCallOptions(t))}async invoke(e,t){return super.invoke(e,this._combineCallOptions(t))}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const s=await Promise.all(e.map(async e=>{const s=await this.getNumTokens(e.content),a=await this.getNumTokens(ny(e)),i=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=s+n+a+i;const c=e;if("function"===c._getType()&&(o-=2),c.additional_kwargs?.function_call&&(o+=3),c?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(c.additional_kwargs.function_call)),o+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=o,o}));return t+=3,{totalCount:t,countPerMessage:s}}async _getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async _getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(uy(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find(e=>"system"===e._getType())&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async moderateContent(e,t){const n=this._getClientOptions(t?.options),r={input:e,model:t?.model??"omni-moderation-latest"};return this.caller.call(async()=>{try{return await this.client.moderations.create(r,n)}catch(e){throw Kr(e)}})}get profile(){return r_[this.model]??{}}_getStructuredOutputMethod(e){const t={...e};if(this.model.startsWith("gpt-3")||this.model.startsWith("gpt-4-")||"gpt-4"===this.model)"jsonSchema"===t.method&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`);else if(void 0===t?.method)return"jsonSchema";return t.method}withStructuredOutput(e,t){let n,r;const{schema:s,name:a,includeRaw:i}={...t,schema:e};if(void 0!==t?.strict&&"jsonMode"===t.method)throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");const o=function(e,t){if(void 0!==t&&!t_.includes(t))throw new Error(`Invalid method: ${t}. Supported methods are: ${t_.join(", ")}`);const n=!e.startsWith("gpt-3")&&!e.startsWith("gpt-4-")&&"gpt-4"!==e;if(n&&!t)return"jsonSchema";if(!n&&"jsonSchema"===t)throw new Error(`JSON Schema is not supported for model "${e}". Please use a different method, e.g. "functionCalling" or "jsonMode".`);return t??"functionCalling"}(this.model,t?.method);if("jsonMode"===o){r=eh(s)?ov.fromZodSchema(s):new Q_;const e=mg(s);n=this.withConfig({outputVersion:"v0",response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"json_mode"},schema:{title:a??"extract",...e}}})}else if("jsonSchema"===o){const e={name:a??"extract",description:ch(s),schema:s,strict:t?.strict},i=mg(e.schema);if(n=this.withConfig({outputVersion:"v0",response_format:{type:"json_schema",json_schema:e},ls_structured_output_format:{kwargs:{method:"json_schema"},schema:{title:e.name,description:e.description,...i}}}),eh(s)){const e=ov.fromZodSchema(s);r=Pg.from(t=>"parsed"in t.additional_kwargs?t.additional_kwargs.parsed:e)}else r=new Q_}else{let e=a??"extract";if(eh(s)){const a=mg(s);n=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:{name:e,description:a.description,parameters:a}}],tool_choice:{type:"function",function:{name:e}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:e,...a}},...void 0!==t?.strict?{strict:t.strict}:{}}),r=new wv({returnSingle:!0,keyName:e,zodSchema:s})}else{let a;"string"==typeof s.name&&"object"==typeof s.parameters&&null!=s.parameters?(a=s,e=s.name):(e=s.title??e,a={name:e,description:s.description??"",parameters:s});const i=mg(s);n=this.withConfig({outputVersion:"v0",tools:[{type:"function",function:a}],tool_choice:{type:"function",function:{name:e}},ls_structured_output_format:{kwargs:{method:"function_calling"},schema:{title:e,...i}},...void 0!==t?.strict?{strict:t.strict}:{}}),r=new wv({returnSingle:!0,keyName:e})}}if(!i)return n.pipe(r);const c=D_.assign({parsed:(e,t)=>r.invoke(e.raw,t)}),l=D_.assign({parsed:()=>null}),u=c.withFallbacks({fallbacks:[l]});return $g.from([{raw:n},u])}};const xv={providerName:"ChatOpenAI",fromStandardTextBlock:e=>({type:"text",text:e.text}),fromStandardImageBlock(e){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};if("base64"===e.source_type)return{type:"image_url",image_url:{url:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};throw new Error(`Image content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(e){if("url"===e.source_type){const t=is({dataUrl:e.url});if(!t)throw new Error(`URL audio blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);const n=t.mime_type||e.mime_type||"";let r;try{r=as(n)}catch{throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==r.type||"wav"!==r.subtype&&"mp3"!==r.subtype)throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:r.subtype,data:t.data}}}if("base64"===e.source_type){let t;try{t=as(e.mime_type??"")}catch{throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==t.type||"wav"!==t.subtype&&"mp3"!==t.subtype)throw new Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:t.subtype,data:e.data}}}throw new Error(`Audio content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(e){if("url"===e.source_type){const t=is({dataUrl:e.url}),n=ty(e);if(!t)throw new Error(`URL file blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:e.url,...e.metadata?.filename||e.metadata?.name?{filename:n}:{}}}}if("base64"===e.source_type){const t=ty(e);return{type:"file",file:{file_data:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.filename||e.metadata?.name||e.metadata?.title?{filename:t}:{}}}}if("id"===e.source_type)return{type:"file",file:{file_id:e.id}};throw new Error(`File content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)}},kv=e=>{if("image"===e.type){if(e.url)return{type:"image_url",image_url:{url:e.url}};if(e.data)return{type:"image_url",image_url:{url:`data:${e.mimeType};base64,${e.data}`}}}if("audio"===e.type&&e.data){const t=qa(()=>{const[,t]=e.mimeType.split("/");return"wav"===t||"mp3"===t?t:"wav"});return{type:"input_audio",input_audio:{data:e.data.toString(),format:t}}}if("file"===e.type){if(e.data){const t=ty(e);return{type:"file",file:{file_data:`data:${e.mimeType};base64,${e.data}`,filename:t}}}if(e.fileId)return{type:"file",file:{file_id:e.fileId}}}},Tv=({messages:e,model:t})=>e.flatMap(e=>{if("output_version"in e.response_metadata&&"v1"===e.response_metadata?.output_version)return(({message:e,model:t})=>{let n=ny(e);return"system"===n&&ey(t)&&(n="developer"),"developer"===n?{role:"developer",content:e.contentBlocks.filter(e=>"text"===e.type)}:"system"===n?{role:"system",content:e.contentBlocks.filter(e=>"text"===e.type)}:"assistant"===n?{role:"assistant",content:e.contentBlocks.filter(e=>"text"===e.type)}:"tool"===n&&na.isInstance(e)?{role:"tool",tool_call_id:e.tool_call_id,content:e.contentBlocks.filter(e=>"text"===e.type)}:"function"===n?{role:"function",name:e.name??"",content:e.contentBlocks.filter(e=>"text"===e.type).join("")}:{role:"user",content:Array.from(function*(e){for(const t of e){"text"===t.type&&(yield{type:"text",text:t.text});const e=kv(t);e&&(yield e)}}(e.contentBlocks))}})({message:e});let n=ny(e);"system"===n&&ey(t)&&(n="developer");const r={role:n,content:"string"==typeof e.content?e.content:e.content.map(e=>Qr(e)?os(e,xv):e)};return null!=e.name&&(r.name=e.name),null!=e.additional_kwargs.function_call&&(r.function_call=e.additional_kwargs.function_call),Da.isInstance(e)&&e.tool_calls?.length?r.tool_calls=e.tool_calls.map(yv):(null!=e.additional_kwargs.tool_calls&&(r.tool_calls=e.additional_kwargs.tool_calls),na.isInstance(e)&&null!=e.tool_call_id&&(r.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio?[r,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:r});var Iv=class extends bv{invocationParams(e,t){let n;void 0!==e?.strict?n=e.strict:void 0!==this.supportsStrictToolCalling&&(n=this.supportsStrictToolCalling);let r={};void 0!==e?.stream_options?r={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(r={stream_options:{include_usage:!0}});const s={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(e=>this._convertChatOpenAIToolToCompletionsTool(e,{strict:n})):void 0,tool_choice:py(e?.tool_choice),response_format:this._getResponseFormat(e?.response_format),seed:e?.seed,...r,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs,prompt_cache_key:e?.promptCacheKey??this.promptCacheKey,prompt_cache_retention:e?.promptCacheRetention??this.promptCacheRetention,verbosity:e?.verbosity??this.verbosity};void 0!==e?.prediction&&(s.prediction=e.prediction),void 0!==this.service_tier&&(s.service_tier=this.service_tier),void 0!==e?.service_tier&&(s.service_tier=e.service_tier);const a=this._getReasoningParams(e);return void 0!==a&&void 0!==a.effort&&(s.reasoning_effort=a.effort),ey(s.model)?s.max_completion_tokens=-1===this.maxTokens?void 0:this.maxTokens:s.max_tokens=-1===this.maxTokens?void 0:this.maxTokens,s}async _generate(e,t,n){const r={},s=this.invocationParams(t),a=Tv({messages:e,model:this.model});if(s.stream){const s=this._streamResponseChunks(e,t,n),a={};for await(const e of s){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===a[t]?a[t]=e:a[t]=a[t].concat(e)}const i=Object.entries(a).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:o,function_call:c}=this.invocationParams(t),l=await this._getEstimatedTokenCountFromPrompt(e,o,c),u=await this._getNumTokensFromGenerations(i);return r.input_tokens=l,r.output_tokens=u,r.total_tokens=l+u,{generations:i,llmOutput:{estimatedTokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}{const e=await this.completionWithRetry({...s,stream:!1,messages:a},{signal:t?.signal,...t?.options}),{completion_tokens:n,prompt_tokens:i,total_tokens:o,prompt_tokens_details:c,completion_tokens_details:l}=e?.usage??{};n&&(r.output_tokens=(r.output_tokens??0)+n),i&&(r.input_tokens=(r.input_tokens??0)+i),o&&(r.total_tokens=(r.total_tokens??0)+o),null===c?.audio_tokens&&null===c?.cached_tokens||(r.input_token_details={...null!==c?.audio_tokens&&{audio:c?.audio_tokens},...null!==c?.cached_tokens&&{cache_read:c?.cached_tokens}}),null===l?.audio_tokens&&null===l?.reasoning_tokens||(r.output_token_details={...null!==l?.audio_tokens&&{audio:l?.audio_tokens},...null!==l?.reasoning_tokens&&{reasoning:l?.reasoning_tokens}});const u=[];for(const t of e?.choices??[]){const n={text:t.message?.content??"",message:this._convertCompletionsMessageToBaseMessage(t.message??{role:"assistant"},e)};n.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},Fa(n.message)&&(n.message.usage_metadata=r),n.message=new Da(Object.fromEntries(Object.entries(n.message).filter(([e])=>!e.startsWith("lc_")))),u.push(n)}return{generations:u,llmOutput:{tokenUsage:{promptTokens:r.input_tokens,completionTokens:r.output_tokens,totalTokens:r.total_tokens}}}}}async*_streamResponseChunks(e,t,n){const r=Tv({messages:e,model:this.model}),s={...this.invocationParams(t,{streaming:!0}),messages:r,stream:!0};let a;const i=await this.completionWithRetry(s,t);let o;for await(const e of i){const r=e?.choices?.[0];if(e.usage&&(o=e.usage),!r)continue;const{delta:s}=r;if(!s)continue;const i=this._convertCompletionsDeltaToBaseMessageChunk(s,e,a);a=s.role??a;const c={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof i.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const l={...c};null!=r.finish_reason&&(l.finish_reason=r.finish_reason,l.system_fingerprint=e.system_fingerprint,l.model_name=e.model,l.service_tier=e.service_tier),this.logprobs&&(l.logprobs=r.logprobs);const u=new Ll({message:i,text:i.content,generationInfo:l});yield u,await(n?.handleLLMNewToken(u.text??"",c,void 0,void 0,void 0,{chunk:u}))}if(o){const e={...null!==o.prompt_tokens_details?.audio_tokens&&{audio:o.prompt_tokens_details?.audio_tokens},...null!==o.prompt_tokens_details?.cached_tokens&&{cache_read:o.prompt_tokens_details?.cached_tokens}},t={...null!==o.completion_tokens_details?.audio_tokens&&{audio:o.completion_tokens_details?.audio_tokens},...null!==o.completion_tokens_details?.reasoning_tokens&&{reasoning:o.completion_tokens_details?.reasoning_tokens}},n=new Ll({message:new Za({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield n}if(t.signal?.aborted)throw new Error("AbortError")}async completionWithRetry(e,t){const n=this._getClientOptions(t),r=e.response_format&&"json_schema"===e.response_format.type;return this.caller.call(async()=>{try{return r&&!e.stream?await this.client.chat.completions.parse(e,n):await this.client.chat.completions.create(e,n)}catch(e){throw Kr(e)}})}_convertCompletionsDeltaToBaseMessageChunk(e,t,n){return(({delta:e,rawResponse:t,includeRawResponse:n,defaultRole:r})=>{const s=e.role??r,a=e.content??"";let i;i=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},n&&(i.__raw_response=t),e.audio&&(i.audio={...e.audio,index:t.choices[0].index});const o={model_provider:"openai",usage:{...t.usage}};if("user"===s)return new ga({content:a,response_metadata:o});if("assistant"===s){const n=[];if(Array.isArray(e.tool_calls))for(const t of e.tool_calls)n.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new Za({content:a,tool_call_chunks:n,additional_kwargs:i,id:t.id,response_metadata:o})}return"system"===s?new ba({content:a,response_metadata:o}):"developer"===s?new ba({content:a,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):"function"===s?new pa({content:a,additional_kwargs:i,name:e.name,response_metadata:o}):"tool"===s?new ra({content:a,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:o}):new ca({content:a,role:s,response_metadata:o})})({delta:e,rawResponse:t,includeRawResponse:this.__includeRawResponse,defaultRole:n})}_convertCompletionsMessageToBaseMessage(e,t){return(({message:e,rawResponse:t,includeRawResponse:n})=>{const r=e.tool_calls;if("assistant"===e.role){const s=[],a=[];for(const e of r??[])try{s.push(gv(e,{returnId:!0}))}catch(t){a.push(_v(e,t.message))}const i={function_call:e.function_call,tool_calls:r};void 0!==n&&(i.__raw_response=t);const o={model_provider:"openai",model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};e.audio&&(i.audio=e.audio);const c=function(e,t){return t&&"object"==typeof t&&"images"in t&&Array.isArray(t.images)?[{type:"text",text:e},...t.images.filter(e=>"string"==typeof e?.image_url?.url).map(e=>({type:"image",url:e.image_url.url}))]:e}(e.content||"",t.choices?.[0]?.message);return new Da({content:c,tool_calls:s,invalid_tool_calls:a,additional_kwargs:i,response_metadata:o,id:t.id})}return new oa(e.content||"",e.role??"unknown")})({message:e,rawResponse:t,includeRawResponse:this.__includeRawResponse})}};const Ev="__openai_function_call_ids__",Ov=e=>{const t={...null!=e?.input_tokens_details?.cached_tokens&&{cache_read:e?.input_tokens_details?.cached_tokens}},n={...null!=e?.output_tokens_details?.reasoning_tokens&&{reasoning:e?.output_tokens_details?.reasoning_tokens}};return{input_tokens:e?.input_tokens??0,output_tokens:e?.output_tokens??0,total_tokens:e?.total_tokens??0,input_token_details:t,output_token_details:n}},Sv=e=>{if(e.error){const t=new Error(e.error.message);throw t.name=e.error.code,t}let t;const n=[],r=[],s=[],a={model_provider:"openai",model:e.model,created_at:e.created_at,id:e.id,incomplete_details:e.incomplete_details,metadata:e.metadata,object:e.object,status:e.status,user:e.user,service_tier:e.service_tier,model_name:e.model},i={};for(const a of e.output)if("message"===a.type)t=a.id,n.push(...a.content.flatMap(e=>"output_text"===e.type?("parsed"in e&&null!=e.parsed&&(i.parsed=e.parsed),{type:"text",text:e.text,annotations:e.annotations}):"refusal"===e.type?(i.refusal=e.refusal,[]):e));else if("function_call"===a.type){const e={function:{name:a.name,arguments:a.arguments},id:a.call_id};try{r.push(gv(e,{returnId:!0}))}catch(t){let n;"object"==typeof t&&null!=t&&"message"in t&&"string"==typeof t.message&&(n=t.message),s.push(_v(e,n))}i[Ev]??={},a.id&&(i[Ev][a.call_id]=a.id)}else if("reasoning"===a.type)i.reasoning=a;else if("custom_tool_call"===a.type){const e=gy(a);e?r.push(e):s.push(_v(a,"Malformed custom tool call"))}else if("computer_call"===a.type){const e=yy(a);e?r.push(e):s.push(_v(a,"Malformed computer call"))}else i.tool_outputs??=[],i.tool_outputs.push(a);return new Da({id:t,content:n,tool_calls:r,invalid_tool_calls:s,usage_metadata:Ov(e.usage),additional_kwargs:i,response_metadata:a})},Av=e=>{const t=[];let n,r={};const s=[],a={model_provider:"openai"},i={};let o;if("response.output_text.delta"===e.type)t.push({type:"text",text:e.delta,index:e.content_index});else if("response.output_text.annotation.added"===e.type)t.push({type:"text",text:"",annotations:[e.annotation],index:e.content_index});else if("response.output_item.added"===e.type&&"message"===e.item.type)o=e.item.id;else if("response.output_item.added"===e.type&&"function_call"===e.item.type)s.push({type:"tool_call_chunk",name:e.item.name,args:e.item.arguments,id:e.item.call_id,index:e.output_index}),i[Ev]={[e.item.call_id]:e.item.id};else if("response.output_item.done"===e.type&&"computer_call"===e.item.type)s.push({type:"tool_call_chunk",name:"computer_use",args:JSON.stringify({action:e.item.action}),id:e.item.call_id,index:e.output_index}),i.tool_outputs=[e.item];else if("response.output_item.done"===e.type&&["web_search_call","file_search_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call","custom_tool_call"].includes(e.item.type))i.tool_outputs=[e.item];else if("response.created"===e.type)a.id=e.response.id,a.model_name=e.response.model,a.model=e.response.model;else if("response.completed"===e.type){const t=Sv(e.response);n=Ov(e.response.usage),"json_schema"===e.response.text?.format?.type&&(i.parsed??=JSON.parse(t.text));for(const[t,n]of Object.entries(e.response))"id"!==t&&(a[t]=n)}else if("response.function_call_arguments.delta"===e.type||"response.custom_tool_call_input.delta"===e.type)s.push({type:"tool_call_chunk",args:e.delta,index:e.output_index});else if("response.web_search_call.completed"===e.type||"response.file_search_call.completed"===e.type)r={tool_outputs:{id:e.item_id,type:e.type.replace("response.","").replace(".completed",""),status:"completed"}};else if("response.refusal.done"===e.type)i.refusal=e.refusal;else if("response.output_item.added"===e.type&&"item"in e&&"reasoning"===e.item.type){const t=e.item.summary?e.item.summary.map((e,t)=>({...e,index:t})):void 0;i.reasoning={id:e.item.id,type:e.item.type,...t?{summary:t}:{}}}else if("response.reasoning_summary_part.added"===e.type)i.reasoning={type:"reasoning",summary:[{...e.part,index:e.summary_index}]};else{if("response.reasoning_summary_text.delta"!==e.type)return e.type,null;i.reasoning={type:"reasoning",summary:[{text:e.delta,type:"summary_text",index:e.summary_index}]}}return new Ll({text:t.map(e=>e.text).join(""),message:new Za({id:o,content:t,tool_call_chunks:s,usage_metadata:n,additional_kwargs:i,response_metadata:a}),generationInfo:r})},$v=({messages:e,zdrEnabled:t,model:n})=>e.flatMap(e=>{const r=e.response_metadata;if("v1"===r?.output_version)return(e=>{const t=Da.isInstance(e)&&"openai"===e.response_metadata?.model_provider;return Array.from(function*(){const n=Qg(()=>{try{const t=ny(e);return"system"===t||"developer"===t||"assistant"===t||"user"===t?t:"assistant"}catch{return"assistant"}});let r;const s=new Set,a=new Set,i=new Map,o=new Map;function*c(){if(!r)return;const e=r.content;("string"==typeof e&&e.length>0||Array.isArray(e)&&e.length>0)&&(yield r),r=void 0}const l=e=>{r||(r={type:"message",role:n,content:[]}),"string"==typeof r.content?r.content=r.content.length>0?[{type:"input_text",text:r.content},...e]:[...e]:r.content.push(...e)},u=e=>{if("string"==typeof e)return e;try{return JSON.stringify(e??{})}catch{return"{}"}},d=e=>{const t=Qg(()=>{const t=e.metadata?.detail;return"low"===t||"high"===t||"auto"===t?t:"auto"});if(e.fileId)return{type:"input_image",detail:t,file_id:e.fileId};if(e.url)return{type:"input_image",detail:t,image_url:e.url};if(e.data){const n="string"==typeof e.data?e.data:Buffer.from(e.data).toString("base64");return{type:"input_image",detail:t,image_url:`data:${e.mimeType??"image/png"};base64,${n}`}}},p=e=>{const t=ty(e);if(e.fileId&&"string"==typeof t)return{type:"input_file",file_id:e.fileId,...t?{filename:t}:{}};if(e.url&&"string"==typeof t)return{type:"input_file",file_url:e.url,...t?{filename:t}:{}};if(e.data&&"string"==typeof t){const n="string"==typeof e.data?e.data:Buffer.from(e.data).toString("base64");return{type:"input_file",file_data:`data:${e.mimeType??"application/octet-stream"};base64,${n}`,...t?{filename:t}:{}}}},h=e=>{const t=Qg(()=>{if(Array.isArray(e.summary)){const t=e.summary,n=t?.map(e=>e?.text).filter(e=>"string"==typeof e)??[];if(n.length>0)return n}return e.reasoning?[e.reasoning]:[]}),n=t.length>0?t.map(e=>({type:"summary_text",text:e})):[{type:"summary_text",text:""}],r={type:"reasoning",id:e.id??"",summary:n};return e.reasoning&&(r.content=[{type:"reasoning_text",text:e.reasoning}]),r},m=e=>({type:"function_call",name:e.name??"",call_id:e.id??"",arguments:u(e.args)}),f=e=>{const t=u(e.output),n="success"===e.status?"completed":"error"===e.status?"incomplete":void 0;return{type:"function_call_output",call_id:e.toolCallId??"",output:t,...n?{status:n}:{}}};for(const n of e.contentBlocks)if("text"===n.type)l([{type:"input_text",text:n.text}]);else if("invalid_tool_call"===n.type);else if("reasoning"===n.type)yield*c(),yield h(n);else if("tool_call"===n.type){yield*c();const e=n.id??"";e&&(s.add(e),i.delete(e)),yield m(n)}else if("tool_call_chunk"===n.type){if(n.id){const e=i.get(n.id)??{name:n.name,args:[]};n.name&&(e.name=n.name),n.args&&e.args.push(n.args),i.set(n.id,e)}}else if("server_tool_call"===n.type){yield*c();const e=n.id??"";e&&(a.add(e),o.delete(e)),yield m(n)}else if("server_tool_call_chunk"===n.type){if(n.id){const e=o.get(n.id)??{name:n.name,args:[]};n.name&&(e.name=n.name),n.args&&e.args.push(n.args),o.set(n.id,e)}}else if("server_tool_call_result"===n.type)yield*c(),yield f(n);else if("audio"===n.type);else if("file"===n.type){const e=p(n);e&&l([e])}else if("image"===n.type){const e=d(n);e&&l([e])}else if("video"===n.type){const e=p(n);e&&l([e])}else"text-plain"===n.type?n.text&&l([{type:"input_text",text:n.text}]):"non_standard"===n.type&&t&&(yield*c(),yield n.value);yield*c();for(const[e,t]of i){if(!e||s.has(e))continue;const n=t.args.join("");(t.name||n)&&(yield{type:"function_call",call_id:e,name:t.name??"",arguments:n})}for(const[e,t]of o){if(!e||a.has(e))continue;const n=t.args.join("");(t.name||n)&&(yield{type:"function_call",call_id:e,name:t.name??"",arguments:n})}}())})(e);const s=e.additional_kwargs;let a=ny(e);if("system"===a&&ey(n)&&(a="developer"),"function"===a)throw new Error("Function messages are not supported in Responses API");if("tool"===a){const t=e;if("computer_call_output"===s?.type){const e=(()=>{if("string"==typeof t.content)return{type:"input_image",image_url:t.content};if(Array.isArray(t.content)){const e=t.content.find(e=>"input_image"===e.type);if(e)return e;const n=t.content.find(e=>"computer_screenshot"===e.type);if(n)return n;const r=t.content.find(e=>"image_url"===e.type);if(r)return{type:"input_image",image_url:"string"==typeof r.image_url?r.image_url:r.image_url.url}}throw new Error("Invalid computer call output")})();return{type:"computer_call_output",output:e,call_id:t.tool_call_id}}return t.additional_kwargs?.customTool?{type:"custom_tool_call_output",call_id:t.tool_call_id,output:t.content}:{type:"function_call_output",call_id:t.tool_call_id,id:t.id?.startsWith("fc_")?t.id:void 0,output:"string"!=typeof t.content?JSON.stringify(t.content):t.content}}if("assistant"===a){if(!t&&null!=r?.output&&Array.isArray(r?.output)&&r?.output.length>0&&r?.output.every(e=>"type"in e))return r?.output;const n=[];if(s?.reasoning&&!t){const e=(e=>{const t=(e.summary.length>1?e.summary.reduce((e,t)=>{const n=e[e.length-1];return n.index===t.index?n.text+=t.text:e.push(t),e},[{...e.summary[0]}]):e.summary).map(e=>Object.fromEntries(Object.entries(e).filter(([e])=>"index"!==e)));return{...e,summary:t}})(s.reasoning);n.push(e)}let{content:a}=e;s?.refusal&&("string"==typeof a&&(a=[{type:"output_text",text:a,annotations:[]}]),a=[...a,{type:"refusal",refusal:s.refusal}]),("string"==typeof a||a.length>0)&&n.push({type:"message",role:"assistant",...e.id&&!t&&e.id.startsWith("msg_")?{id:e.id}:{},content:Qg(()=>"string"==typeof a?a:a.flatMap(e=>"text"===e.type?{type:"output_text",text:e.text,annotations:e.annotations??[]}:"output_text"===e.type||"refusal"===e.type?e:[]))});const i=s?.[Ev];Da.isInstance(e)&&e.tool_calls?.length?n.push(...e.tool_calls.map(e=>function(e){return"object"==typeof e&&null!==e&&"type"in e&&"tool_call"===e.type&&"isCustomTool"in e&&!0===e.isCustomTool}(e)?{type:"custom_tool_call",id:e.call_id,call_id:e.id??"",input:e.args.input,name:e.name}:function(e){return"object"==typeof e&&null!==e&&"type"in e&&"tool_call"===e.type&&"isComputerTool"in e&&!0===e.isComputerTool}(e)?{type:"computer_call",id:e.call_id,call_id:e.id??"",action:e.args.action}:{type:"function_call",name:e.name,arguments:JSON.stringify(e.args),call_id:e.id,...t?{}:{id:i?.[e.id]}})):s?.tool_calls&&n.push(...s.tool_calls.map(e=>({type:"function_call",name:e.function.name,call_id:e.id,arguments:e.function.arguments,...t?{}:{id:i?.[e.id]}})));const o=(r?.output)?.length?r?.output:s.tool_outputs,c=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(null!=o){const e=o,t=e?.filter(e=>c.includes(e.type));t.length>0&&n.push(...t)}return n}if("user"===a||"system"===a||"developer"===a){if("string"==typeof e.content)return{type:"message",role:a,content:e.content};const t=[],n=e.content.flatMap(e=>("mcp_approval_response"===e.type&&t.push({type:"mcp_approval_response",approval_request_id:e.approval_request_id,approve:e.approve}),Qr(e)?os(e,xv):"text"===e.type?{type:"input_text",text:e.text}:"image_url"===e.type?{type:"input_image",image_url:Qg(()=>"string"==typeof e.image_url?e.image_url:"object"==typeof e.image_url&&null!==e.image_url&&"url"in e.image_url?e.image_url.url:void 0),detail:Qg(()=>"string"==typeof e.image_url?"auto":"object"==typeof e.image_url&&null!==e.image_url&&"detail"in e.image_url?e.image_url.detail:void 0)}:"input_text"===e.type||"input_image"===e.type||"input_file"===e.type?e:[]));return n.length>0&&t.push({type:"message",role:a,content:n}),t}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${a}`),[]});var Cv=class extends bv{invocationParams(e){let t;void 0!==e?.strict&&(t=e.strict),void 0===t&&void 0!==this.supportsStrictToolCalling&&(t=this.supportsStrictToolCalling);const n={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e?.previous_response_id,truncation:e?.truncation,include:e?.include,tools:e?.tools?.length?this._reduceChatOpenAITools(e.tools,{stream:this.streaming,strict:t}):void 0,tool_choice:(r=e?.tool_choice,null!=r&&"object"==typeof r&&"type"in r&&"function"!==r.type?e?.tool_choice:(()=>{const t=py(e?.tool_choice);if("object"==typeof t&&"type"in t){if("function"===t.type)return{type:"function",name:t.function.name};if("allowed_tools"===t.type)return{type:"allowed_tools",mode:t.allowed_tools.mode,tools:t.allowed_tools.tools};if("custom"===t.type)return{type:"custom",name:t.custom.name}}})()),text:(()=>{if(e?.text)return e.text;const t=this._getResponseFormat(e?.response_format);return"json_schema"===t?.type?null!=t.json_schema.schema?{format:{type:"json_schema",schema:t.json_schema.schema,description:t.json_schema.description,name:t.json_schema.name,strict:t.json_schema.strict},verbosity:e?.verbosity}:void 0:{format:t,verbosity:e?.verbosity}})(),parallel_tool_calls:e?.parallel_tool_calls,max_output_tokens:-1===this.maxTokens?void 0:this.maxTokens,prompt_cache_key:e?.promptCacheKey??this.promptCacheKey,prompt_cache_retention:e?.promptCacheRetention??this.promptCacheRetention,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs};var r;const s=this._getReasoningParams(e);return void 0!==s&&(n.reasoning=s),n}async _generate(e,t){const n=this.invocationParams(t);if(n.stream){const n=this._streamResponseChunks(e,t);let r;for await(const e of n)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},r=r?.concat(e)??e;return{generations:r?[r]:[],llmOutput:{estimatedTokenUsage:(r?.message)?.usage_metadata}}}{const r=await this.completionWithRetry({input:$v({messages:e,zdrEnabled:this.zdrEnabled??!1,model:this.model}),...n,stream:!1},{signal:t?.signal,...t?.options});return{generations:[{text:r.output_text,message:Sv(r)}],llmOutput:{id:r.id,estimatedTokenUsage:r.usage?{promptTokens:r.usage.input_tokens,completionTokens:r.usage.output_tokens,totalTokens:r.usage.total_tokens}:void 0}}}}async*_streamResponseChunks(e,t,n){const r=await this.completionWithRetry({...this.invocationParams(t),input:$v({messages:e,zdrEnabled:this.zdrEnabled??!1,model:this.model}),stream:!0},t);for await(const e of r){const r=Av(e);null!=r&&(yield r,await(n?.handleLLMNewToken(r.text||"",{prompt:t.promptIndex??0,completion:0},void 0,void 0,void 0,{chunk:r})))}}async completionWithRetry(e,t){return this.caller.call(async()=>{const n=this._getClientOptions(t);try{return"json_schema"!==e.text?.format?.type||e.stream?await this.client.responses.create(e,n):await this.client.responses.parse(e,n)}catch(e){throw Kr(e)}})}_reduceChatOpenAITools(e,t){const n=[];for(const r of e)if(hy(r))"image_generation"===r.type&&t?.stream&&(r.partial_images=1),n.push(r);else if(my(r)){const e=r.metadata.customTool;n.push({type:"custom",name:e.name,description:e.description,format:e.format})}else L_(r)?n.push({type:"function",name:r.function.name,parameters:r.function.parameters,description:r.function.description,strict:t?.strict??null}):fy(r)&&n.push(_y(r));return n}},Nv=class e extends bv{useResponsesApi=!1;responses;completions;get lc_serializable_keys(){return[...super.lc_serializable_keys,"useResponsesApi"]}get callKeys(){return[...super.callKeys,"useResponsesApi"]}constructor(e){super(e),this.fields=e,this.useResponsesApi=e?.useResponsesApi??!1,this.responses=e?.responses??new Cv(e),this.completions=e?.completions??new Iv(e)}_useResponsesApi(e){const t=e?.tools?.some(hy),n=null!=e?.previous_response_id||null!=e?.text||null!=e?.truncation||null!=e?.include||null!=e?.reasoning?.summary||null!=this.reasoning?.summary,r=e?.tools?.some(fy)||e?.tools?.some(my);return this.useResponsesApi||t||n||r||this.model.includes("gpt-5.2-pro")}getLsParams(e){const t=this._combineCallOptions(e);return this._useResponsesApi(e)?this.responses.getLsParams(t):this.completions.getLsParams(t)}invocationParams(e){const t=this._combineCallOptions(e);return this._useResponsesApi(e)?this.responses.invocationParams(t):this.completions.invocationParams(t)}async _generate(e,t,n){return this._useResponsesApi(t)?this.responses._generate(e,t):this.completions._generate(e,t,n)}async*_streamResponseChunks(e,t,n){this._useResponsesApi(t)?yield*this.responses._streamResponseChunks(e,this._combineCallOptions(t),n):yield*this.completions._streamResponseChunks(e,this._combineCallOptions(t),n)}withConfig(t){const n=new e(this.fields);return n.defaultOptions={...this.defaultOptions,...t},n}};Yr({},{BaseLLM:()=>Pv,LLM:()=>Rv});var Pv=class e extends U_{lc_namespace=["langchain","llms",this._llmType()];async invoke(t,n){const r=e._convertInputToPromptValue(t);return(await this.generatePrompt([r],n,n?.callbacks)).generations[0][0].text}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}_separateRunnableConfigFromCallOptionsCompat(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n.signal=t.signal,[t,n]}async*_streamIterator(t,n){if(this._streamResponseChunks===e.prototype._streamResponseChunks)yield this.invoke(t,n);else{const r=e._convertInputToPromptValue(t),[s,a]=this._separateRunnableConfigFromCallOptionsCompat(n),i=await Uc.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),o={options:a,invocation_params:this?.invocationParams(a),batch_size:1},c=await(i?.handleLLMStart(this.toJSON(),[r.toString()],s.runId,void 0,o,void 0,void 0,s.runName));let l=new jl({text:""});try{for await(const e of this._streamResponseChunks(r.toString(),a,c?.[0]))l=l?l.concat(e):e,"string"==typeof e.text&&(yield e.text)}catch(e){throw await Promise.all((c??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((c??[]).map(e=>e?.handleLLMEnd({generations:[[l]]})))}}async generatePrompt(e,t,n){const r=e.map(e=>e.toString());return this.generate(r,t,n)}invocationParams(e){return{}}_flattenLLMResult(e){const t=[];for(let n=0;n<e.generations.length;n+=1){const r=e.generations[n];if(0===n)t.push({generations:[r],llmOutput:e.llmOutput});else{const n=e.llmOutput?{...e.llmOutput,tokenUsage:{}}:void 0;t.push({generations:[r],llmOutput:n})}}return t}async _generateUncached(t,n,r,s){let a,i;if(void 0!==s&&s.length===t.length)a=s;else{const e=await Uc.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),s={options:n,invocation_params:this?.invocationParams(n),batch_size:t.length};a=await(e?.handleLLMStart(this.toJSON(),t,r.runId,void 0,s,void 0,void 0,r?.runName))}if(a?.[0].handlers.find(ki)&&1===t.length&&this._streamResponseChunks!==e.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(t[0],n,a?.[0]);let r;for await(const t of e)r=void 0===r?t:tl(r,t);if(void 0===r)throw new Error("Received empty response from chat model call.");i={generations:[[r]],llmOutput:{}},await(a?.[0].handleLLMEnd(i))}catch(e){throw await(a?.[0].handleLLMError(e)),e}else{try{i=await this._generate(t,n,a?.[0])}catch(e){throw await Promise.all((a??[]).map(t=>t?.handleLLMError(e))),e}const e=this._flattenLLMResult(i);await Promise.all((a??[]).map((t,n)=>t?.handleLLMEnd(e[n])))}const o=a?.map(e=>e.runId)||void 0;return Object.defineProperty(i,Rl,{value:o?{runIds:o}:void 0,configurable:!0}),i}async _generateCached({prompts:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:s,runId:a}){const i=await Uc.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),o={options:r,invocation_params:this?.invocationParams(r),batch_size:e.length},c=await(i?.handleLLMStart(this.toJSON(),e,a,void 0,o,void 0,void 0,s?.runName)),l=[],u=(await Promise.allSettled(e.map(async(e,r)=>{const s=await t.lookup(e,n);return null==s&&l.push(r),s}))).map((e,t)=>({result:e,runManager:c?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),d=[];await Promise.all(u.map(async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return d[n]=r.map(e=>(e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]},void 0,void 0,void 0,{cached:!0})}return await(t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(e.reason)}));const p={generations:d,missingPromptIndices:l,startedRunManagers:c};return Object.defineProperty(p,Rl,{value:c?{runIds:c?.map(e=>e.runId)}:void 0,configurable:!0}),p}async generate(e,t,n){if(!Array.isArray(e))throw new Error("Argument 'prompts' is expected to be a string[]");let r;r=Array.isArray(t)?{stop:t}:t;const[s,a]=this._separateRunnableConfigFromCallOptionsCompat(r);if(s.callbacks=s.callbacks??n,!this.cache)return this._generateUncached(e,a,s);const{cache:i}=this,o=this._getSerializedCacheKeyParametersForCall(a),{generations:c,missingPromptIndices:l,startedRunManagers:u}=await this._generateCached({prompts:e,cache:i,llmStringKey:o,parsedOptions:a,handledOptions:s,runId:s.runId});let d={};if(l.length>0){const t=await this._generateUncached(l.map(t=>e[t]),a,s,void 0!==u?l.map(e=>u?.[e]):void 0);await Promise.all(t.generations.map(async(t,n)=>{const r=l[n];return c[r]=t,i.update(e[r],o,t)})),d=t.llmOutput??{}}return{generations:c,llmOutput:d}}_identifyingParams(){return{}}_modelType(){return"base_llm"}},Rv=class extends Pv{async _generate(e,t,n){return{generations:await Promise.all(e.map((e,r)=>this._call(e,{...t,promptIndex:r},n).then(e=>[{text:e}])))}}};Yr({},{chunkArray:()=>jv});const jv=(e,t)=>e.reduce((e,n,r)=>{const s=Math.floor(r/t),a=e[s]||[];return e[s]=a.concat([n]),e},[]);Yr({},{Embeddings:()=>Lv});var Lv=class{caller;constructor(e){this.caller=new Jl(e??{})}};Yr({},{BaseToolkit:()=>Fv,DynamicStructuredTool:()=>Dv,DynamicTool:()=>Uv,StructuredTool:()=>Mv,Tool:()=>zv,ToolInputParsingException:()=>Ea,isLangChainTool:()=>oy,isRunnableToolLike:()=>ay,isStructuredTool:()=>sy,isStructuredToolParams:()=>iy,tool:()=>Bv});var Mv=class extends z_{extras;returnDirect=!1;verboseParsingErrors=!1;get lc_namespace(){return["langchain","tools"]}responseFormat="content";defaultConfig;constructor(e){super(e??{}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata,this.extras=e?.extras??this.extras}async invoke(e,t){let n,r=Gc(Hc(this.defaultConfig,t));return Ia(e)?(n=e.args,r={...r,toolCall:e}):n=e,this.call(n,r)}async call(e,t,n){const r=Ia(e)?e.args:e;let s;if(eh(this.schema))try{s=await ah(this.schema,r)}catch(t){let n="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(n=`${n}\nDetails: ${t.message}`),Eh(t)&&(n=`${n}\n\n${function(e){const t=[],n=[...e.issues].sort((e,t)=>e.path.length-t.path.length);for(const e of n)t.push(`✖ ${e.message}`),e.path?.length&&t.push(`  → at ${Cu(e.path)}`);return t.join("\n")}(t)}`),new Ea(n,JSON.stringify(e))}else{const t=pg(r,this.schema);if(!t.valid){let n="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(n=`${n}\nDetails: ${t.errors.map(e=>`${e.keywordLocation}: ${e.error}`).join("\n")}`),new Ea(n,JSON.stringify(e))}s=r}const a=Nc(t),i=Uc.configure(a.callbacks,this.callbacks,a.tags||n,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o=await(i?.handleToolStart(this.toJSON(),"string"==typeof e?e:JSON.stringify(e),a.runId,void 0,void 0,void 0,a.runName));let c,l,u,d;delete a.runId;try{c=await this._call(s,o,a)}catch(e){throw await(o?.handleToolError(e)),e}if("content_and_artifact"===this.responseFormat){if(!Array.isArray(c)||2!==c.length)throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.\nResult: ${JSON.stringify(c)}`);[l,u]=c}else l=c;Ia(e)&&(d=e.id),!d&&function(e){return!!(e&&"object"==typeof e&&"toolCall"in e&&null!=e.toolCall&&"object"==typeof e.toolCall&&"id"in e.toolCall&&"string"==typeof e.toolCall.id)}(a)&&(d=a.toolCall.id);const p=function(e){const{content:t,artifact:n,toolCallId:r,metadata:s}=e;return r&&!ta(t)?"string"==typeof t||Array.isArray(t)&&t.every(e=>"object"==typeof e)?new na({status:"success",content:t,artifact:n,tool_call_id:r,name:e.name,metadata:s}):new na({status:"success",content:Zv(t),artifact:n,tool_call_id:r,name:e.name,metadata:s}):t}({content:l,artifact:u,toolCallId:d,name:this.name,metadata:this.metadata});return await(o?.handleToolEnd(p)),p}},zv=class extends Mv{schema=mf({input:pf().optional()}).transform(e=>e.input);constructor(e){super(e)}call(e,t){const n="string"==typeof e||null==e?{input:e}:e;return super.call(n,t)}},Uv=class extends zv{static lc_name(){return"DynamicTool"}name;description;func;constructor(e){super(e),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect}async call(e,t){const n=Nc(t);return void 0===n.runName&&(n.runName=this.name),super.call(e,n)}async _call(e,t,n){return this.func(e,t,n)}},Dv=class extends Mv{static lc_name(){return"DynamicStructuredTool"}name;description;func;schema;constructor(e){super(e),this.name=e.name,this.description=e.description,this.func=e.func,this.returnDirect=e.returnDirect??this.returnDirect,this.schema=e.schema}async call(e,t,n){const r=Nc(t);return void 0===r.runName&&(r.runName=this.name),super.call(e,r,n)}_call(e,t,n){return this.func(e,t,n)}},Fv=class{getTools(){return this.tools}};function Bv(e,t){const n=uh(t.schema),r=fg(t.schema);if(!t.schema||n||r)return new Uv({...t,description:t.description??t.schema?.description??`${t.name} tool`,func:async(t,n,r)=>new Promise((s,a)=>{const i=Jc(r,{callbacks:n?.getChild()});qc.runWithConfig(Kc(i),async()=>{try{s(e(t,i))}catch(e){a(e)}})})});const s=t.schema,a=t.description??t.schema.description??`${t.name} tool`;return new Dv({...t,description:a,schema:s,func:async(t,n,r)=>new Promise((s,a)=>{let i;const o=()=>{r?.signal&&i&&r.signal.removeEventListener("abort",i)};r?.signal&&(i=()=>{o(),a(Yc(r.signal))},r.signal.addEventListener("abort",i));const c=Jc(r,{callbacks:n?.getChild()});qc.runWithConfig(Kc(c),async()=>{try{const n=await e(t,c);if(r?.signal?.aborted)return void o();o(),s(n)}catch(e){o(),a(e)}})})})}function Zv(e){try{return JSON.stringify(e,null,2)??""}catch(t){return`${e}`}}const qv=Ql("ZodISODateTime",(e,t)=>{Wd.init(e,t),sw.init(e,t)});const Vv=Ql("ZodISODate",(e,t)=>{Gd.init(e,t),sw.init(e,t)});const Hv=Ql("ZodISOTime",(e,t)=>{Jd.init(e,t),sw.init(e,t)});const Wv=Ql("ZodISODuration",(e,t)=>{Kd.init(e,t),sw.init(e,t)});const Gv=(e,t)=>{Au.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:t=>function(e,t){const n=t||function(e){return e.message},r={_errors:[]},s=e=>{for(const t of e.issues)if("invalid_union"===t.code&&t.errors.length)t.errors.map(e=>s({issues:e}));else if("invalid_key"===t.code)s({issues:t.issues});else if("invalid_element"===t.code)s({issues:t.issues});else if(0===t.path.length)r._errors.push(n(t));else{let e=r,s=0;for(;s<t.path.length;){const r=t.path[s];s===t.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(n(t))):e[r]=e[r]||{_errors:[]},e=e[r],s++}}};return s(e),r}(e,t)},flatten:{value:t=>function(e,t=e=>e.message){const n={},r=[];for(const s of e.issues)s.path.length>0?(n[s.path[0]]=n[s.path[0]]||[],n[s.path[0]].push(t(s))):r.push(t(s));return{formErrors:r,fieldErrors:n}}(e,t)},addIssue:{value:t=>e.issues.push(t)},addIssues:{value:t=>e.issues.push(...t)},isEmpty:{get:()=>0===e.issues.length}})},Jv=(Ql("ZodError",Gv),Ql("ZodError",Gv,{Parent:Error})),Kv=Nu(Jv),Xv=Ru(Jv),Yv=Lu(Jv),Qv=zu(Jv),ew=Ql("ZodType",(e,t)=>(Pd.init(e,t),e.def=t,Object.defineProperty(e,"_def",{value:t}),e.check=(...n)=>e.clone({...t,checks:[...t.checks??[],...n.map(e=>"function"==typeof e?{_zod:{check:e,def:{check:"custom"},onattach:[]}}:e)]}),e.clone=(t,n)=>yu(e,t,n),e.brand=()=>e,e.register=(t,n)=>(t.add(e,n),e),e.parse=(t,n)=>Kv(e,t,n,{callee:e.parse}),e.safeParse=(t,n)=>Yv(e,t,n),e.parseAsync=async(t,n)=>Xv(e,t,n,{callee:e.parseAsync}),e.safeParseAsync=async(t,n)=>Qv(e,t,n),e.spa=e.safeParseAsync,e.refine=(t,n)=>e.check(function(e,t={}){return function(e,t,n){return new e({type:"custom",check:"custom",fn:t,..._u(n)})}(nb,e,t)}(t,n)),e.superRefine=t=>e.check(function(e){const t=function(e){const t=new md({check:"custom"});return t._zod.check=e,t}(n=>(n.addIssue=e=>{if("string"==typeof e)n.issues.push(Ou(e,n.value,t._zod.def));else{const r=e;r.fatal&&(r.continue=!1),r.code??(r.code="custom"),r.input??(r.input=n.value),r.inst??(r.inst=t),r.continue??(r.continue=!t._zod.def.abort),n.issues.push(Ou(r))}},e(n.value,n)));return t}(t)),e.overwrite=t=>e.check(Kp(t)),e.optional=()=>Hw(e),e.nullable=()=>Gw(e),e.nullish=()=>Hw(Gw(e)),e.nonoptional=t=>function(e,t){return new Xw({type:"nonoptional",innerType:e,..._u(t)})}(e,t),e.array=()=>Nw(e),e.or=t=>{return new jw({type:"union",options:[e,t],..._u(n)});var n},e.and=t=>new zw({type:"intersection",left:e,right:t}),e.transform=t=>eb(e,new qw({type:"transform",transform:t})),e.default=t=>{return n=t,new Jw({type:"default",innerType:e,get defaultValue(){return"function"==typeof n?n():n}});var n},e.prefault=t=>{return n=t,new Kw({type:"prefault",innerType:e,get defaultValue(){return"function"==typeof n?n():n}});var n},e.catch=t=>{return new Yw({type:"catch",innerType:e,catchValue:"function"==typeof(n=t)?n:()=>n});var n},e.pipe=t=>eb(e,t),e.readonly=()=>new tb({type:"readonly",innerType:e}),e.describe=t=>{const n=e.clone();return Bu.add(n,{description:t}),n},Object.defineProperty(e,"description",{get:()=>Bu.get(e)?.description,configurable:!0}),e.meta=(...t)=>{if(0===t.length)return Bu.get(e);const n=e.clone();return Bu.add(n,t[0]),n},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),tw=Ql("_ZodString",(e,t)=>{Rd.init(e,t),ew.init(e,t);const n=e._zod.bag;e.format=n.format??null,e.minLength=n.minimum??null,e.maxLength=n.maximum??null,e.regex=(...t)=>e.check(function(e,t){return new Td({check:"string_format",format:"regex",..._u(t),pattern:e})}(...t)),e.includes=(...t)=>e.check(function(e,t){return new Od({check:"string_format",format:"includes",..._u(t),includes:e})}(...t)),e.startsWith=(...t)=>e.check(function(e,t){return new Sd({check:"string_format",format:"starts_with",..._u(t),prefix:e})}(...t)),e.endsWith=(...t)=>e.check(function(e,t){return new Ad({check:"string_format",format:"ends_with",..._u(t),suffix:e})}(...t)),e.min=(...t)=>e.check(Gp(...t)),e.max=(...t)=>e.check(Wp(...t)),e.length=(...t)=>e.check(Jp(...t)),e.nonempty=(...t)=>e.check(Gp(1,...t)),e.lowercase=t=>e.check(function(e){return new Id({check:"string_format",format:"lowercase",..._u(e)})}(t)),e.uppercase=t=>e.check(function(e){return new Ed({check:"string_format",format:"uppercase",..._u(e)})}(t)),e.trim=()=>e.check(Kp(e=>e.trim())),e.normalize=(...t)=>e.check(function(e){return Kp(t=>t.normalize(e))}(...t)),e.toLowerCase=()=>e.check(Kp(e=>e.toLowerCase())),e.toUpperCase=()=>e.check(Kp(e=>e.toUpperCase()))}),nw=Ql("ZodString",(e,t)=>{Rd.init(e,t),tw.init(e,t),e.email=t=>e.check(function(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,..._u(t)})}(aw,t)),e.url=t=>e.check(function(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,..._u(t)})}(cw,t)),e.jwt=t=>e.check(function(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,..._u(t)})}(kw,t)),e.emoji=t=>e.check(function(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,..._u(t)})}(lw,t)),e.guid=t=>e.check(Up(iw,t)),e.uuid=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,..._u(t)})}(ow,t)),e.uuidv4=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",..._u(t)})}(ow,t)),e.uuidv6=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",..._u(t)})}(ow,t)),e.uuidv7=t=>e.check(function(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",..._u(t)})}(ow,t)),e.nanoid=t=>e.check(function(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,..._u(t)})}(uw,t)),e.guid=t=>e.check(Up(iw,t)),e.cuid=t=>e.check(function(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,..._u(t)})}(dw,t)),e.cuid2=t=>e.check(function(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,..._u(t)})}(pw,t)),e.ulid=t=>e.check(function(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,..._u(t)})}(hw,t)),e.base64=t=>e.check(function(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,..._u(t)})}(ww,t)),e.base64url=t=>e.check(function(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,..._u(t)})}(bw,t)),e.xid=t=>e.check(function(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,..._u(t)})}(mw,t)),e.ksuid=t=>e.check(function(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,..._u(t)})}(fw,t)),e.ipv4=t=>e.check(function(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,..._u(t)})}(gw,t)),e.ipv6=t=>e.check(function(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,..._u(t)})}(yw,t)),e.cidrv4=t=>e.check(function(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,..._u(t)})}(_w,t)),e.cidrv6=t=>e.check(function(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,..._u(t)})}(vw,t)),e.e164=t=>e.check(function(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,..._u(t)})}(xw,t)),e.datetime=t=>e.check(function(e){return function(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,..._u(t)})}(qv,e)}(t)),e.date=t=>e.check(function(e){return function(e,t){return new e({type:"string",format:"date",check:"string_format",..._u(t)})}(Vv,e)}(t)),e.time=t=>e.check(function(e){return function(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,..._u(t)})}(Hv,e)}(t)),e.duration=t=>e.check(function(e){return function(e,t){return new e({type:"string",format:"duration",check:"string_format",..._u(t)})}(Wv,e)}(t))});function rw(e){return function(e,t){return new e({type:"string",..._u(t)})}(nw,e)}const sw=Ql("ZodStringFormat",(e,t)=>{jd.init(e,t),tw.init(e,t)}),aw=Ql("ZodEmail",(e,t)=>{zd.init(e,t),sw.init(e,t)}),iw=Ql("ZodGUID",(e,t)=>{Ld.init(e,t),sw.init(e,t)}),ow=Ql("ZodUUID",(e,t)=>{Md.init(e,t),sw.init(e,t)}),cw=Ql("ZodURL",(e,t)=>{Ud.init(e,t),sw.init(e,t)}),lw=Ql("ZodEmoji",(e,t)=>{Dd.init(e,t),sw.init(e,t)}),uw=Ql("ZodNanoID",(e,t)=>{Fd.init(e,t),sw.init(e,t)}),dw=Ql("ZodCUID",(e,t)=>{Bd.init(e,t),sw.init(e,t)}),pw=Ql("ZodCUID2",(e,t)=>{Zd.init(e,t),sw.init(e,t)}),hw=Ql("ZodULID",(e,t)=>{qd.init(e,t),sw.init(e,t)}),mw=Ql("ZodXID",(e,t)=>{Vd.init(e,t),sw.init(e,t)}),fw=Ql("ZodKSUID",(e,t)=>{Hd.init(e,t),sw.init(e,t)}),gw=Ql("ZodIPv4",(e,t)=>{Xd.init(e,t),sw.init(e,t)}),yw=Ql("ZodIPv6",(e,t)=>{Yd.init(e,t),sw.init(e,t)}),_w=Ql("ZodCIDRv4",(e,t)=>{Qd.init(e,t),sw.init(e,t)}),vw=Ql("ZodCIDRv6",(e,t)=>{ep.init(e,t),sw.init(e,t)}),ww=Ql("ZodBase64",(e,t)=>{np.init(e,t),sw.init(e,t)}),bw=Ql("ZodBase64URL",(e,t)=>{rp.init(e,t),sw.init(e,t)}),xw=Ql("ZodE164",(e,t)=>{sp.init(e,t),sw.init(e,t)}),kw=Ql("ZodJWT",(e,t)=>{ap.init(e,t),sw.init(e,t)}),Tw=Ql("ZodNumber",(e,t)=>{ip.init(e,t),ew.init(e,t),e.gt=(t,n)=>e.check(qp(t,n)),e.gte=(t,n)=>e.check(Vp(t,n)),e.min=(t,n)=>e.check(Vp(t,n)),e.lt=(t,n)=>e.check(Bp(t,n)),e.lte=(t,n)=>e.check(Zp(t,n)),e.max=(t,n)=>e.check(Zp(t,n)),e.int=t=>e.check(Ow(t)),e.safe=t=>e.check(Ow(t)),e.positive=t=>e.check(qp(0,t)),e.nonnegative=t=>e.check(Vp(0,t)),e.negative=t=>e.check(Bp(0,t)),e.nonpositive=t=>e.check(Zp(0,t)),e.multipleOf=(t,n)=>e.check(Hp(t,n)),e.step=(t,n)=>e.check(Hp(t,n)),e.finite=()=>e;const n=e._zod.bag;e.minValue=Math.max(n.minimum??Number.NEGATIVE_INFINITY,n.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(n.maximum??Number.POSITIVE_INFINITY,n.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(n.format??"").includes("int")||Number.isSafeInteger(n.multipleOf??.5),e.isFinite=!0,e.format=n.format??null});function Iw(e){return function(e,t){return new e({type:"number",checks:[],..._u(t)})}(Tw,e)}const Ew=Ql("ZodNumberFormat",(e,t)=>{op.init(e,t),Tw.init(e,t)});function Ow(e){return function(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",..._u(t)})}(Ew,e)}const Sw=Ql("ZodUnknown",(e,t)=>{cp.init(e,t),ew.init(e,t)});function Aw(){return Dp(Sw)}const $w=Ql("ZodNever",(e,t)=>{lp.init(e,t),ew.init(e,t)});const Cw=Ql("ZodArray",(e,t)=>{dp.init(e,t),ew.init(e,t),e.element=t.element,e.min=(t,n)=>e.check(Gp(t,n)),e.nonempty=t=>e.check(Gp(1,t)),e.max=(t,n)=>e.check(Wp(t,n)),e.length=(t,n)=>e.check(Jp(t,n)),e.unwrap=()=>e.element});function Nw(e,t){return function(e,t,n){return new e({type:"array",element:t,..._u(n)})}(Cw,e,t)}const Pw=Ql("ZodObject",(e,t)=>{mp.init(e,t),ew.init(e,t),cu(e,"shape",()=>t.shape),e.keyof=()=>Fw(Object.keys(e._zod.def.shape)),e.catchall=t=>e.clone({...e._zod.def,catchall:t}),e.passthrough=()=>e.clone({...e._zod.def,catchall:Aw()}),e.loose=()=>e.clone({...e._zod.def,catchall:Aw()}),e.strict=()=>{return e.clone({...e._zod.def,catchall:Fp($w,t)});var t},e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=t=>wu(e,t),e.merge=t=>{return r=t,yu(n=e,{...n._zod.def,get shape(){const e={...n._zod.def.shape,...r._zod.def.shape};return lu(this,"shape",e),e},catchall:r._zod.def.catchall,checks:[]});var n,r},e.pick=t=>function(e,t){const n={},r=e._zod.def;for(const e in t){if(!(e in r.shape))throw new Error(`Unrecognized key: "${e}"`);t[e]&&(n[e]=r.shape[e])}return yu(e,{...e._zod.def,shape:n,checks:[]})}(e,t),e.omit=t=>function(e,t){const n={...e._zod.def.shape},r=e._zod.def;for(const e in t){if(!(e in r.shape))throw new Error(`Unrecognized key: "${e}"`);t[e]&&delete n[e]}return yu(e,{...e._zod.def,shape:n,checks:[]})}(e,t),e.partial=(...t)=>bu(Vw,e,t[0]),e.required=(...t)=>function(e,t,n){const r=t._zod.def.shape,s={...r};if(n)for(const t in n){if(!(t in s))throw new Error(`Unrecognized key: "${t}"`);n[t]&&(s[t]=new e({type:"nonoptional",innerType:r[t]}))}else for(const t in r)s[t]=new e({type:"nonoptional",innerType:r[t]});return yu(t,{...t._zod.def,shape:s,checks:[]})}(Xw,e,t[0])});function Rw(e,t){const n={type:"object",get shape(){return lu(this,"shape",{...e}),this.shape},..._u(t)};return new Pw(n)}const jw=Ql("ZodUnion",(e,t)=>{gp.init(e,t),ew.init(e,t),e.options=t.options});const Lw=Ql("ZodDiscriminatedUnion",(e,t)=>{jw.init(e,t),yp.init(e,t)});function Mw(e,t,n){return new Lw({type:"union",options:t,discriminator:e,..._u(n)})}const zw=Ql("ZodIntersection",(e,t)=>{_p.init(e,t),ew.init(e,t)}),Uw=Ql("ZodRecord",(e,t)=>{bp.init(e,t),ew.init(e,t),e.keyType=t.keyType,e.valueType=t.valueType});const Dw=Ql("ZodEnum",(e,t)=>{xp.init(e,t),ew.init(e,t),e.enum=t.entries,e.options=Object.values(t.entries);const n=new Set(Object.keys(t.entries));e.extract=(e,r)=>{const s={};for(const r of e){if(!n.has(r))throw new Error(`Key ${r} not found in enum`);s[r]=t.entries[r]}return new Dw({...t,checks:[],..._u(r),entries:s})},e.exclude=(e,r)=>{const s={...t.entries};for(const t of e){if(!n.has(t))throw new Error(`Key ${t} not found in enum`);delete s[t]}return new Dw({...t,checks:[],..._u(r),entries:s})}});function Fw(e,t){const n=Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e;return new Dw({type:"enum",entries:n,..._u(t)})}const Bw=Ql("ZodLiteral",(e,t)=>{kp.init(e,t),ew.init(e,t),e.values=new Set(t.values),Object.defineProperty(e,"value",{get(){if(t.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return t.values[0]}})});function Zw(e,t){return new Bw({type:"literal",values:Array.isArray(e)?e:[e],..._u(t)})}const qw=Ql("ZodTransform",(e,t)=>{Tp.init(e,t),ew.init(e,t),e._zod.parse=(n,r)=>{n.addIssue=r=>{if("string"==typeof r)n.issues.push(Ou(r,n.value,t));else{const t=r;t.fatal&&(t.continue=!1),t.code??(t.code="custom"),t.input??(t.input=n.value),t.inst??(t.inst=e),t.continue??(t.continue=!0),n.issues.push(Ou(t))}};const s=t.transform(n.value,n);return s instanceof Promise?s.then(e=>(n.value=e,n)):(n.value=s,n)}});const Vw=Ql("ZodOptional",(e,t)=>{Ip.init(e,t),ew.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Hw(e){return new Vw({type:"optional",innerType:e})}const Ww=Ql("ZodNullable",(e,t)=>{Ep.init(e,t),ew.init(e,t),e.unwrap=()=>e._zod.def.innerType});function Gw(e){return new Ww({type:"nullable",innerType:e})}const Jw=Ql("ZodDefault",(e,t)=>{Op.init(e,t),ew.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap}),Kw=Ql("ZodPrefault",(e,t)=>{Ap.init(e,t),ew.init(e,t),e.unwrap=()=>e._zod.def.innerType}),Xw=Ql("ZodNonOptional",(e,t)=>{$p.init(e,t),ew.init(e,t),e.unwrap=()=>e._zod.def.innerType}),Yw=Ql("ZodCatch",(e,t)=>{Np.init(e,t),ew.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap}),Qw=Ql("ZodPipe",(e,t)=>{Pp.init(e,t),ew.init(e,t),e.in=t.in,e.out=t.out});function eb(e,t){return new Qw({type:"pipe",in:e,out:t})}const tb=Ql("ZodReadonly",(e,t)=>{jp.init(e,t),ew.init(e,t)}),nb=Ql("ZodCustom",(e,t)=>{Mp.init(e,t),ew.init(e,t)}),rb=Rw({type:Zw("screenshot")}),sb=Rw({type:Zw("click"),x:Iw(),y:Iw(),button:Fw(["left","right","wheel","back","forward"]).default("left")}),ab=Rw({type:Zw("double_click"),x:Iw(),y:Iw(),button:Fw(["left","right","wheel","back","forward"]).default("left")}),ib=Rw({type:Zw("drag"),path:Nw(Rw({x:Iw(),y:Iw()}))}),ob=Rw({type:Zw("keypress"),keys:Nw(rw())}),cb=Rw({type:Zw("move"),x:Iw(),y:Iw()}),lb=Rw({type:Zw("scroll"),x:Iw(),y:Iw(),scroll_x:Iw(),scroll_y:Iw()}),ub=Rw({type:Zw("type"),text:rw()}),db=Rw({type:Zw("wait"),duration:Iw().optional()});var pb,hb,mb;Rw({action:Mw("type",[rb,sb,ab,ib,ob,cb,lb,ub,db])}),Mw("type",[Rw({type:Zw("exec"),command:Nw(rw()),env:(pb=rw(),hb=rw(),new Uw({type:"record",keyType:pb,valueType:hb,..._u(mb)})).optional(),working_directory:rw().optional(),timeout_ms:Iw().optional(),user:rw().optional()})]),Rw({commands:Nw(rw()).describe("Array of shell commands to execute"),timeout_ms:Iw().optional().describe("Optional timeout in milliseconds for the commands"),max_output_length:Iw().optional().describe("Optional maximum number of characters to return from each command")}),Mw("type",[Rw({type:Zw("create_file"),path:rw(),diff:rw()}),Rw({type:Zw("update_file"),path:rw(),diff:rw()}),Rw({type:Zw("delete_file"),path:rw()})]);var fb=class extends Eg{lc_serializable=!0;lc_namespace=["langchain_core","prompts",this._getPromptType()];get lc_attributes(){return{partialVariables:void 0}}inputVariables;outputParser;partialVariables;metadata;tags;constructor(e){super(e);const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},n={};for(const[e,r]of Object.entries(t))n[e]="string"==typeof r?r:await r();return{...n,...e}}async invoke(e,t){const n={...this.metadata,...t?.metadata},r=[...this.tags??[],...t?.tags??[]];return this._callWithConfig(e=>this.formatPromptValue(e),e,{...t,tags:r,metadata:n,runType:"prompt"})}},gb=class extends fb{async formatPromptValue(e){const t=await this.format(e);return new a_(t)}},yb=Object.prototype.toString,_b=Array.isArray||function(e){return"[object Array]"===yb.call(e)};function vb(e){return"function"==typeof e}function wb(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function bb(e,t){return null!=e&&"object"==typeof e&&t in e}function xb(e,t){return null!=e&&"object"!=typeof e&&e.hasOwnProperty&&e.hasOwnProperty(t)}var kb=RegExp.prototype.test,Tb=/\S/;function Ib(e){return!function(e,t){return kb.call(e,t)}(Tb,e)}var Eb={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},Ob=/\s*/,Sb=/\s+/,Ab=/\s*=/,$b=/\s*\}/,Cb=/#|\^|\/|>|\{|&|=|!/;function Nb(e){this.string=e,this.tail=e,this.pos=0}function Pb(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function Rb(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}Nb.prototype.eos=function(){return""===this.tail},Nb.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n},Nb.prototype.scanUntil=function(e){var t,n=this.tail.search(e);switch(n){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=t.length,t},Pb.prototype.push=function(e){return new Pb(e,this)},Pb.prototype.lookup=function(e){var t,n=this.cache;if(n.hasOwnProperty(e))t=n[e];else{for(var r,s,a,i=this,o=!1;i;){if(e.indexOf(".")>0)for(r=i.view,s=e.split("."),a=0;null!=r&&a<s.length;)a===s.length-1&&(o=bb(r,s[a])||xb(r,s[a])),r=r[s[a++]];else r=i.view[e],o=bb(i.view,e);if(o){t=r;break}i=i.parent}n[e]=t}return vb(t)&&(t=t.call(this.view)),t},Rb.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},Rb.prototype.parse=function(e,t){var n=this.templateCache,r=e+":"+(t||jb.tags).join(":"),s=void 0!==n,a=s?n.get(r):void 0;return null==a&&(a=function(e,t){if(!e)return[];var n,r,s,a=!1,i=[],o=[],c=[],l=!1,u=!1,d="",p=0;function h(){if(l&&!u)for(;c.length;)delete o[c.pop()];else c=[];l=!1,u=!1}function m(e){if("string"==typeof e&&(e=e.split(Sb,2)),!_b(e)||2!==e.length)throw new Error("Invalid tags: "+e);n=new RegExp(wb(e[0])+"\\s*"),r=new RegExp("\\s*"+wb(e[1])),s=new RegExp("\\s*"+wb("}"+e[1]))}m(t||jb.tags);for(var f,g,y,_,v,w,b=new Nb(e);!b.eos();){if(f=b.pos,y=b.scanUntil(n))for(var x=0,k=y.length;x<k;++x)Ib(_=y.charAt(x))?(c.push(o.length),d+=_):(u=!0,a=!0,d+=" "),o.push(["text",_,f,f+1]),f+=1,"\n"===_&&(h(),d="",p=0,a=!1);if(!b.scan(n))break;if(l=!0,g=b.scan(Cb)||"name",b.scan(Ob),"="===g?(y=b.scanUntil(Ab),b.scan(Ab),b.scanUntil(r)):"{"===g?(y=b.scanUntil(s),b.scan($b),b.scanUntil(r),g="&"):y=b.scanUntil(r),!b.scan(r))throw new Error("Unclosed tag at "+b.pos);if(v=">"==g?[g,y,f,b.pos,d,p,a]:[g,y,f,b.pos],p++,o.push(v),"#"===g||"^"===g)i.push(v);else if("/"===g){if(!(w=i.pop()))throw new Error('Unopened section "'+y+'" at '+f);if(w[1]!==y)throw new Error('Unclosed section "'+w[1]+'" at '+f)}else"name"===g||"{"===g||"&"===g?u=!0:"="===g&&m(y)}if(h(),w=i.pop())throw new Error('Unclosed section "'+w[1]+'" at '+b.pos);return function(e){for(var t,n=[],r=n,s=[],a=0,i=e.length;a<i;++a)switch((t=e[a])[0]){case"#":case"^":r.push(t),s.push(t),r=t[4]=[];break;case"/":s.pop()[5]=t[2],r=s.length>0?s[s.length-1][4]:n;break;default:r.push(t)}return n}(function(e){for(var t,n,r=[],s=0,a=e.length;s<a;++s)(t=e[s])&&("text"===t[0]&&n&&"text"===n[0]?(n[1]+=t[1],n[3]=t[3]):(r.push(t),n=t));return r}(o))}(e,t),s&&n.set(r,a)),a},Rb.prototype.render=function(e,t,n,r){var s=this.getConfigTags(r),a=this.parse(e,s),i=t instanceof Pb?t:new Pb(t,void 0);return this.renderTokens(a,i,n,e,r)},Rb.prototype.renderTokens=function(e,t,n,r,s){for(var a,i,o,c="",l=0,u=e.length;l<u;++l)o=void 0,"#"===(i=(a=e[l])[0])?o=this.renderSection(a,t,n,r,s):"^"===i?o=this.renderInverted(a,t,n,r,s):">"===i?o=this.renderPartial(a,t,n,s):"&"===i?o=this.unescapedValue(a,t):"name"===i?o=this.escapedValue(a,t,s):"text"===i&&(o=this.rawValue(a)),void 0!==o&&(c+=o);return c},Rb.prototype.renderSection=function(e,t,n,r,s){var a=this,i="",o=t.lookup(e[1]);if(o){if(_b(o))for(var c=0,l=o.length;c<l;++c)i+=this.renderTokens(e[4],t.push(o[c]),n,r,s);else if("object"==typeof o||"string"==typeof o||"number"==typeof o)i+=this.renderTokens(e[4],t.push(o),n,r,s);else if(vb(o)){if("string"!=typeof r)throw new Error("Cannot use higher-order sections without the original template");null!=(o=o.call(t.view,r.slice(e[3],e[5]),function(e){return a.render(e,t,n,s)}))&&(i+=o)}else i+=this.renderTokens(e[4],t,n,r,s);return i}},Rb.prototype.renderInverted=function(e,t,n,r,s){var a=t.lookup(e[1]);if(!a||_b(a)&&0===a.length)return this.renderTokens(e[4],t,n,r,s)},Rb.prototype.indentPartial=function(e,t,n){for(var r=t.replace(/[^ \t]/g,""),s=e.split("\n"),a=0;a<s.length;a++)s[a].length&&(a>0||!n)&&(s[a]=r+s[a]);return s.join("\n")},Rb.prototype.renderPartial=function(e,t,n,r){if(n){var s=this.getConfigTags(r),a=vb(n)?n(e[1]):n[e[1]];if(null!=a){var i=e[6],o=e[5],c=e[4],l=a;0==o&&c&&(l=this.indentPartial(a,c,i));var u=this.parse(l,s);return this.renderTokens(u,t,n,l,r)}}},Rb.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(null!=n)return n},Rb.prototype.escapedValue=function(e,t,n){var r=this.getConfigEscape(n)||jb.escape,s=t.lookup(e[1]);if(null!=s)return"number"==typeof s&&r===jb.escape?String(s):r(s)},Rb.prototype.rawValue=function(e){return e[1]},Rb.prototype.getConfigTags=function(e){return _b(e)?e:e&&"object"==typeof e?e.tags:void 0},Rb.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!_b(e)?e.escape:void 0};var jb={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){Lb.templateCache=e},get templateCache(){return Lb.templateCache}},Lb=new Rb;jb.clearCache=function(){return Lb.clearCache()},jb.parse=function(e,t){return Lb.parse(e,t)},jb.render=function(e,t,n,r){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+((_b(s=e)?"array":typeof s)+'" was given as the first argument for mustache#render(template, view, partials)'));var s;return Lb.render(e,t,n,r)},jb.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return Eb[e]})},jb.Scanner=Nb,jb.Context=Pb,jb.Writer=Rb;const Mb=jb;function zb(){Mb.escape=e=>e}const Ub=e=>{const t=e.split(""),n=[],r=(e,n)=>{for(let r=n;r<t.length;r+=1)if(e.includes(t[r]))return r;return-1};let s=0;for(;s<t.length;)if("{"===t[s]&&s+1<t.length&&"{"===t[s+1])n.push({type:"literal",text:"{"}),s+=2;else if("}"===t[s]&&s+1<t.length&&"}"===t[s+1])n.push({type:"literal",text:"}"}),s+=2;else if("{"===t[s]){const e=r("}",s);if(e<0)throw new Error("Unclosed '{' in template.");n.push({type:"variable",name:t.slice(s+1,e).join("")}),s=e+1}else{if("}"===t[s])throw new Error("Single '}' in template.");{const e=r("{}",s),a=(e<0?t.slice(s):t.slice(s,e)).join("");n.push({type:"literal",text:a}),s=e<0?t.length:e}}return n},Db=(e,t=[])=>{const n=[];for(const r of e)if("name"===r[0]){const e=r[1].includes(".")?r[1].split(".")[0]:r[1];n.push({type:"variable",name:e})}else if(["#","&","^",">"].includes(r[0])){if(n.push({type:"variable",name:r[1]}),"#"===r[0]&&r.length>4&&Array.isArray(r[4])){const e=[...t,r[1]],s=Db(r[4],e);n.push(...s)}}else n.push({type:"literal",text:r[1]});return n},Fb=e=>{zb();const t=Mb.parse(e);return Db(t)},Bb=(e,t)=>Ub(e).reduce((e,n)=>{if("variable"===n.type){if(n.name in t)return e+("string"==typeof t[n.name]?t[n.name]:JSON.stringify(t[n.name]));throw new Error(`(f-string) Missing value for input ${n.name}`)}return e+n.text},""),Zb=(e,t)=>(zb(),Mb.render(e,t)),qb={"f-string":Bb,mustache:Zb},Vb={"f-string":Ub,mustache:Fb},Hb=(e,t,n)=>{try{return qb[t](e,n)}catch(e){throw Ta(e,"INVALID_PROMPT_INPUT")}},Wb=(e,t)=>Vb[t](e),Gb=(e,t,n)=>{if(!(t in qb)){const e=Object.keys(qb);throw new Error(`Invalid template format. Got \`${t}\`;\n                         should be one of ${e}`)}try{const r=n.reduce((e,t)=>(e[t]="foo",e),{});Array.isArray(e)?e.forEach(e=>{if("text"===e.type&&"text"in e&&"string"==typeof e.text)Hb(e.text,t,r);else{if("image_url"!==e.type)throw new Error(`Invalid message template received. ${JSON.stringify(e,null,2)}`);if("string"==typeof e.image_url)Hb(e.image_url,t,r);else if("object"==typeof e.image_url&&null!==e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url){const n=e.image_url.url;Hb(n,t,r)}}}):Hb(e,t,r)}catch(e){throw new Error(`Invalid prompt schema: ${e.message}`)}};var Jb=class e extends gb{static lc_name(){return"PromptTemplate"}template;templateFormat="f-string";validateTemplate=!0;additionalContentFields;constructor(e){if(super(e),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if("mustache"===this.templateFormat)throw new Error("Mustache templates cannot be validated.");let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Gb(this.template,this.templateFormat,e)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return Hb(this.template,this.templateFormat,t)}static fromExamples(t,n,r,s="\n\n",a=""){const i=[a,...t,n].join(s);return new e({inputVariables:r,template:i})}static fromTemplate(t,n){const{templateFormat:r="f-string",...s}=n??{},a=new Set;return Wb(t,r).forEach(e=>{"variable"===e.type&&a.add(e.name)}),new e({inputVariables:[...a],templateFormat:r,template:t,...s})}async partial(t){const n=this.inputVariables.filter(e=>!(e in t)),r={...this.partialVariables??{},...t},s={...this,inputVariables:n,partialVariables:r};return new e(s)}serialize(){if(void 0!==this.outputParser)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(t){if(!t.template)throw new Error("Prompt template must have a template");return new e({inputVariables:t.input_variables,template:t.template,templateFormat:t.template_format})}},Kb=class e extends fb{static lc_name(){return"ImagePromptTemplate"}lc_namespace=["langchain_core","prompts","image"];template;templateFormat="f-string";validateTemplate=!0;additionalContentFields;constructor(e){if(super(e),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.additionalContentFields=e.additionalContentFields,this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Gb([{type:"image_url",image_url:this.template}],this.templateFormat,e)}}_getPromptType(){return"prompt"}async partial(t){const n=this.inputVariables.filter(e=>!(e in t)),r={...this.partialVariables??{},...t},s={...this,inputVariables:n,partialVariables:r};return new e(s)}async format(e){const t={};for(const[n,r]of Object.entries(this.template))t[n]="string"==typeof r?Hb(r,this.templateFormat,e):r;const n=e.url||t.url,r=e.detail||t.detail;if(!n)throw new Error("Must provide either an image URL.");if("string"!=typeof n)throw new Error("url must be a string.");const s={url:n};return r&&(s.detail=r),s}async formatPromptValue(e){const t=await this.format(e);return new o_(t)}},Xb=class extends Eg{lc_namespace=["langchain_core","prompts","dict"];lc_serializable=!0;template;templateFormat;inputVariables;static lc_name(){return"DictPromptTemplate"}constructor(e){const t=e.templateFormat??"f-string",n=Yb(e.template,t);super({inputVariables:n,...e}),this.template=e.template,this.templateFormat=t,this.inputVariables=n}async format(e){return Qb(this.template,e,this.templateFormat)}async invoke(e){return await this._callWithConfig(this.format.bind(this),e,{runType:"prompt"})}};function Yb(e,t){const n=[];for(const r of Object.values(e))if("string"==typeof r)Wb(r,t).forEach(e=>{"variable"===e.type&&n.push(e.name)});else if(Array.isArray(r))for(const e of r)"string"==typeof e?Wb(e,t).forEach(e=>{"variable"===e.type&&n.push(e.name)}):"object"==typeof e&&n.push(...Yb(e,t));else"object"==typeof r&&null!==r&&n.push(...Yb(r,t));return Array.from(new Set(n))}function Qb(e,t,n){const r={};for(const[s,a]of Object.entries(e))if("string"==typeof a)r[s]=Hb(a,n,t);else if(Array.isArray(a)){const e=[];for(const r of a)"string"==typeof r?e.push(Hb(r,n,t)):"object"==typeof r&&e.push(Qb(r,t,n));r[s]=e}else r[s]="object"==typeof a&&null!==a?Qb(a,t,n):a;return r}var ex=class extends Eg{lc_namespace=["langchain_core","prompts","chat"];lc_serializable=!0;async invoke(e,t){return this._callWithConfig(e=>this.formatMessages(e),e,{...t,runType:"prompt"})}},tx=class extends ex{static lc_name(){return"MessagesPlaceholder"}variableName;optional;constructor(e){"string"==typeof e&&(e={variableName:e}),super(e),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){const t=e[this.variableName];if(this.optional&&!t)return[];if(!t){const e=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw e.name="InputFormatError",e}let n;try{n=Array.isArray(t)?t.map(Wa):[Wa(t)]}catch(e){const n="string"==typeof t?t:JSON.stringify(t,null,2),r=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${n}`,`Additional message: ${e.message}`].join("\n\n"));throw r.name="InputFormatError",r.lc_error_code=e.lc_error_code,r}return n}},nx=class extends ex{prompt;constructor(e){"prompt"in e||(e={prompt:e}),super(e),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}},rx=class extends fb{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new i_(t)}},sx=class extends nx{static lc_name(){return"ChatMessagePromptTemplate"}role;constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),this.role=e.role}async format(e){return new oa(await this.prompt.format(e),this.role)}static fromTemplate(e,t,n){return new this(Jb.fromTemplate(e,{templateFormat:n?.templateFormat}),t)}};function ax(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&1===Object.keys(e).length&&"text"in e&&"string"==typeof e.text}function ix(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)&&"image_url"in e&&("string"==typeof e.image_url||"object"==typeof e.image_url&&null!==e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url)}var ox=class extends ex{lc_namespace=["langchain_core","prompts","chat"];lc_serializable=!0;inputVariables=[];additionalOptions={};prompt;messageClass;static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}chatMessageClass;constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),this.prompt=e.prompt,Array.isArray(this.prompt)){let e=[];this.prompt.forEach(t=>{"inputVariables"in t&&(e=e.concat(t.inputVariables))}),this.inputVariables=e}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){const t=this.constructor;if(t._messageClass())return new(t._messageClass())({content:e});if(t.chatMessageClass){const n=t.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if("string"==typeof e)return new this(Jb.fromTemplate(e,t));const n=[];for(const r of e)if("string"==typeof r)n.push(Jb.fromTemplate(r,t));else if(null===r);else if(ax(r)){let e="";"string"==typeof r.text&&(e=r.text??"");const s={...t,additionalContentFields:r};n.push(Jb.fromTemplate(e,s))}else if(ix(r)){let e,s=r.image_url??"",a=[];if("string"==typeof s){let n;n="mustache"===t?.templateFormat?Fb(s):Ub(s);const i=n.flatMap(e=>"variable"===e.type?[e.name]:[]);if((i?.length??0)>0){if(i.length>1)throw new Error(`Only one format variable allowed per image template.\nGot: ${i}\nFrom: ${s}`);a=[i[0]]}else a=[];s={url:s},e=new Kb({template:s,inputVariables:a,templateFormat:t?.templateFormat,additionalContentFields:r})}else{if("object"!=typeof s)throw new Error("Invalid image template");if("url"in s){let e;e="mustache"===t?.templateFormat?Fb(s.url):Ub(s.url),a=e.flatMap(e=>"variable"===e.type?[e.name]:[])}else a=[];e=new Kb({template:s,inputVariables:a,templateFormat:t?.templateFormat,additionalContentFields:r})}n.push(e)}else"object"==typeof r&&n.push(new Xb({template:r,templateFormat:t?.templateFormat}));return new this({prompt:n,additionalOptions:t})}async format(e){if(this.prompt instanceof gb){const t=await this.prompt.format(e);return this.createMessage(t)}{const t=[];for(const n of this.prompt){let r={};if(!("inputVariables"in n))throw new Error(`Prompt ${n} does not have inputVariables defined.`);for(const t of n.inputVariables)r||(r={[t]:e[t]}),r={...r,[t]:e[t]};if(n instanceof gb){const e=await n.format(r);let s;"additionalContentFields"in n&&(s=n.additionalContentFields),""!==e&&t.push({...s,type:"text",text:e})}else if(n instanceof Kb){const e=await n.format(r);let s;"additionalContentFields"in n&&(s=n.additionalContentFields),t.push({...s,type:"image_url",image_url:e})}else if(n instanceof Xb){const e=await n.format(r);let s;"additionalContentFields"in n&&(s=n.additionalContentFields),t.push({...s,...e})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}},cx=class extends ox{static _messageClass(){return fa}static lc_name(){return"HumanMessagePromptTemplate"}},lx=class extends ox{static _messageClass(){return Da}static lc_name(){return"AIMessagePromptTemplate"}},ux=class extends ox{static _messageClass(){return wa}static lc_name(){return"SystemMessagePromptTemplate"}};function dx(e,t){if("function"==typeof e.formatMessages||Gs(e))return e;if(Array.isArray(e)&&"placeholder"===e[0]){const n=e[1];if("mustache"===t?.templateFormat&&"string"==typeof n&&"{{"===n.slice(0,2)&&"}}"===n.slice(-2)){const e=n.slice(2,-2);return new tx({variableName:e,optional:!0})}if("string"==typeof n&&"{"===n[0]&&"}"===n[n.length-1]){const e=n.slice(1,-1);return new tx({variableName:e,optional:!0})}throw new Error(`Invalid placeholder template for format ${t?.templateFormat??'"f-string"'}: "${e[1]}". Expected a variable name surrounded by ${"mustache"===t?.templateFormat?"double":"single"} curly braces.`)}const n=Wa(e);let r;if(r="string"==typeof n.content?n.content:n.content.map(e=>"text"in e?{...e,text:e.text}:"image_url"in e?{...e,image_url:e.image_url}:e),"human"===n._getType())return cx.fromTemplate(r,t);if("ai"===n._getType())return lx.fromTemplate(r,t);if("system"===n._getType())return ux.fromTemplate(r,t);if(oa.isInstance(n))return sx.fromTemplate(n.content,n.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${n._getType()}".`)}var px=class e extends rx{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}promptMessages;validateTemplate=!0;templateFormat="f-string";constructor(e){if(super(e),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){const e=new Set;for(const t of this.promptMessages)if(!(t instanceof Fs))for(const n of t.inputVariables)e.add(n);const t=this.inputVariables,n=new Set(this.partialVariables?t.concat(Object.keys(this.partialVariables)):t),r=new Set([...n].filter(t=>!e.has(t)));if(r.size>0)throw new Error(`Input variables \`${[...r]}\` are not used in any of the prompt messages.`);const s=new Set([...e].filter(e=>!n.has(e)));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if("string"==typeof e.content)return e;const n=await Promise.all(e.content.map(async e=>{if("image_url"!==e.type)return e;let n="";"string"==typeof e.image_url?n=e.image_url:"object"==typeof e.image_url&&null!==e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&(n=e.image_url.url);const r=Jb.fromTemplate(n,{templateFormat:this.templateFormat}),s=await r.format(t);return"object"==typeof e.image_url&&null!==e.image_url&&"url"in e.image_url?e.image_url.url=s:e.image_url=s,e}));return e.content=n,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let n=[];for(const e of this.promptMessages)if(e instanceof Fs)n.push(await this._parseImagePrompts(e,t));else{let r;r="mustache"===this.templateFormat?{...t}:e.inputVariables.reduce((n,r)=>{if(!(r in t||"MessagesPlaceholder"===e.constructor.lc_name()&&e.optional))throw Ta(new Error(`Missing value for input variable \`${r.toString()}\``),"INVALID_PROMPT_INPUT");return n[r]=t[r],n},{});const s=await e.formatMessages(r);n=n.concat(s)}return n}async partial(t){const n=this.inputVariables.filter(e=>!(e in t)),r={...this.partialVariables??{},...t},s={...this,inputVariables:n,partialVariables:r};return new e(s)}static fromTemplate(e,t){const n=Jb.fromTemplate(e,t),r=new cx({prompt:n});return this.fromMessages([r])}static fromMessages(t,n){const r=t.reduce((t,r)=>t.concat(r instanceof e?r.promptMessages:[dx(r,n)]),[]),s=t.reduce((t,n)=>n instanceof e?Object.assign(t,n.partialVariables):t,Object.create(null)),a=new Set;for(const e of r)if(!(e instanceof Fs))for(const t of e.inputVariables)t in s||a.add(t);return new this({...n,inputVariables:[...a],promptMessages:r,partialVariables:s,templateFormat:n?.templateFormat})}},hx=class e extends gb{lc_serializable=!1;examples;exampleSelector;examplePrompt;suffix="";exampleSeparator="\n\n";prefix="";templateFormat="f-string";validateTemplate=!0;constructor(e){if(super(e),Object.assign(this,e),void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Gb(this.prefix+this.suffix,this.templateFormat,e)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(t){const n=this.inputVariables.filter(e=>!(e in t)),r={...this.partialVariables??{},...t},s={...this,inputVariables:n,partialVariables:r};return new e(s)}async format(e){const t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),r=await Promise.all(n.map(e=>this.examplePrompt.format(e))),s=[this.prefix,...r,this.suffix].join(this.exampleSeparator);return Hb(s,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(void 0!==this.outputParser)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(t){const{example_prompt:n}=t;if(!n)throw new Error("Missing example prompt");const r=await Jb.deserialize(n);let s;if(!Array.isArray(t.examples))throw new Error("Invalid examples format. Only list or string are supported.");return s=t.examples,new e({inputVariables:t.input_variables,examplePrompt:r,examples:s,exampleSeparator:t.example_separator,prefix:t.prefix,suffix:t.suffix,templateFormat:t.template_format})}},mx=class e extends rx{lc_serializable=!0;examples;exampleSelector;examplePrompt;suffix="";exampleSeparator="\n\n";prefix="";templateFormat="f-string";validateTemplate=!0;_getPromptType(){return"few_shot_chat"}static lc_name(){return"FewShotChatMessagePromptTemplate"}constructor(e){if(super(e),this.examples=e.examples,this.examplePrompt=e.examplePrompt,this.exampleSeparator=e.exampleSeparator??"\n\n",this.exampleSelector=e.exampleSelector,this.prefix=e.prefix??"",this.suffix=e.suffix??"",this.templateFormat=e.templateFormat??"f-string",this.validateTemplate=e.validateTemplate??!0,void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Gb(this.prefix+this.suffix,this.templateFormat,e)}}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let n=await this.getExamples(t);n=n.map(e=>{const t={};return this.examplePrompt.inputVariables.forEach(n=>{t[n]=e[n]}),t});const r=[];for(const e of n){const t=await this.examplePrompt.formatMessages(e);r.push(...t)}return r}async format(e){const t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),r=(await Promise.all(n.map(e=>this.examplePrompt.formatMessages(e)))).flat().map(e=>e.content),s=[this.prefix,...r,this.suffix].join(this.exampleSeparator);return Hb(s,this.templateFormat,t)}async partial(t){const n=this.inputVariables.filter(e=>!(e in t)),r={...this.partialVariables??{},...t},s={...this,inputVariables:n,partialVariables:r};return new e(s)}},fx=class e extends fb{static lc_name(){return"PipelinePromptTemplate"}pipelinePrompts;finalPrompt;constructor(e){super({...e,inputVariables:[]}),this.pipelinePrompts=e.pipelinePrompts,this.finalPrompt=e.finalPrompt,this.inputVariables=this.computeInputValues()}computeInputValues(){const e=this.pipelinePrompts.map(e=>e.name),t=this.pipelinePrompts.map(t=>t.prompt.inputVariables.filter(t=>!e.includes(t))).flat();return[...new Set(t)]}static extractRequiredInputValues(e,t){return t.reduce((t,n)=>(t[n]=e[n],t),{})}async formatPipelinePrompts(t){const n=await this.mergePartialAndUserVariables(t);for(const{name:t,prompt:r}of this.pipelinePrompts){const s=e.extractRequiredInputValues(n,r.inputVariables);n[t]=r instanceof px?await r.formatMessages(s):await r.format(s)}return e.extractRequiredInputValues(n,this.finalPrompt.inputVariables)}async formatPromptValue(e){return this.finalPrompt.formatPromptValue(await this.formatPipelinePrompts(e))}async format(e){return this.finalPrompt.format(await this.formatPipelinePrompts(e))}async partial(t){const n={...this};return n.inputVariables=this.inputVariables.filter(e=>!(e in t)),n.partialVariables={...this.partialVariables??{},...t},new e(n)}serialize(){throw new Error("Not implemented.")}_getPromptType(){return"pipeline"}};function gx(e){return"object"==typeof e&&null!=e&&"withStructuredOutput"in e&&"function"==typeof e.withStructuredOutput}var yx=class e extends px{schema;method;lc_namespace=["langchain_core","prompts","structured"];get lc_aliases(){return{...super.lc_aliases,schema:"schema_"}}constructor(e){super(e),this.schema=e.schema,this.method=e.method}pipe(e){if(gx(e))return super.pipe(e.withStructuredOutput(this.schema));if("object"==typeof(t=e)&&null!=t&&"lc_id"in t&&Array.isArray(t.lc_id)&&"langchain_core/runnables/RunnableBinding"===t.lc_id.join("/")&&gx(e.bound))return super.pipe(new Og({bound:e.bound.withStructuredOutput(this.schema,...this.method?[{method:this.method}]:[]),kwargs:e.kwargs??{},config:e.config,configFactories:e.configFactories}));var t;throw new Error('Structured prompts need to be piped to a language model that supports the "withStructuredOutput()" method.')}static fromMessagesAndSchema(t,n,r){return e.fromMessages(t,{schema:n,method:r})}};Yr({},{AIMessagePromptTemplate:()=>lx,BaseChatPromptTemplate:()=>rx,BaseMessagePromptTemplate:()=>ex,BaseMessageStringPromptTemplate:()=>nx,BasePromptTemplate:()=>fb,BaseStringPromptTemplate:()=>gb,ChatMessagePromptTemplate:()=>sx,ChatPromptTemplate:()=>px,DEFAULT_FORMATTER_MAPPING:()=>qb,DEFAULT_PARSER_MAPPING:()=>Vb,DictPromptTemplate:()=>Xb,FewShotChatMessagePromptTemplate:()=>mx,FewShotPromptTemplate:()=>hx,HumanMessagePromptTemplate:()=>cx,ImagePromptTemplate:()=>Kb,MessagesPlaceholder:()=>tx,PipelinePromptTemplate:()=>fx,PromptTemplate:()=>Jb,StructuredPrompt:()=>yx,SystemMessagePromptTemplate:()=>ux,checkValidTemplate:()=>Gb,interpolateFString:()=>Bb,interpolateMustache:()=>Zb,parseFString:()=>Ub,parseMustache:()=>Fb,parseTemplate:()=>Wb,renderTemplate:()=>Hb}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("langchain-demo-app");if(!e)return;e.innerHTML='\n        <div class="wpli-langchain-demo">\n            <h2>LangChain.js Content Generator Demo</h2>\n\n            <div class="wpli-form-group">\n                <label for="api-key">OpenAI API Key:</label>\n                <input type="password" id="api-key" class="demo-input" placeholder="sk-...">\n            </div>\n\n            <div class="wpli-form-group">\n                <label for="topic">Topic:</label>\n                <input type="text" id="topic" class="demo-input" value="WordPress development">\n            </div>\n\n            <div class="wpli-form-group">\n                <label for="length">Length:</label>\n                <br>\n                <select id="length" class="demo-select">\n                    <option value="short paragraph">Short paragraph</option>\n                    <option value="medium article">Medium article</option>\n                    <option value="detailed explanation">Detailed explanation</option>\n                </select>\n            </div>\n\n            <div class="wpli-form-group">\n                <label for="style">Style:</label>\n                <br>\n                <select id="style" class="demo-select">\n                    <option value="professional">Professional</option>\n                    <option value="conversational">Conversational</option>\n                    <option value="technical">Technical</option>\n                </select>\n            </div>\n\n            <button id="generate-btn" class="demo-button">\n                Generate Content\n            </button>\n\n            <div id="result" class="wpli-result"></div>\n        </div>\n    ';const t=document.getElementById("api-key"),n=document.getElementById("topic"),r=document.getElementById("length"),s=document.getElementById("style"),a=document.getElementById("generate-btn"),i=document.getElementById("result");let o,c,l;a.addEventListener("click",async()=>{const e=t.value.trim(),u=n.value.trim();if(e)if(u){a.disabled=!0,a.textContent="Generating...",i.textContent="Generating content...";try{i.textContent="Generating response...",o=function(e){return new Nv({apiKey:e,modelName:"gpt-4o-mini",temperature:.7})}(e),c=Jb.fromTemplate("\nGenerate a {length} response about {topic} in the style of {style}.\n\nTopic: {topic}\nLength: {length}\nStyle: {style}\n\nResponse:"),l=function(e,t){return t.pipe(e)}(o,c);const t={topic:u,length:r.value,style:s.value},n=await async function(e,t){try{return(await e.invoke(t)).content}catch(e){throw console.error("Error generating content:",e),e}}(l,t);i.textContent=n}catch(e){i.textContent=`Error: ${e.message}`}finally{a.disabled=!1,a.textContent="Generate Content"}}else i.textContent="Please provide a topic.";else i.textContent="Please provide an OpenAI API key."})})},9855:(e,t,n)=>{const r=n(7737);e.exports=(e,t)=>{const n=r(e.trim().replace(/^[=v]+/,""),t);return n?n.version:null}},9881:(e,t,n)=>{const r=n(9558),s=n(6635),{ANY:a}=s,i=n(995),o=n(4621),c=[new s(">=0.0.0-0")],l=[new s(">=0.0.0")],u=(e,t,n)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===a){if(1===t.length&&t[0].semver===a)return!0;e=n.includePrerelease?c:l}if(1===t.length&&t[0].semver===a){if(n.includePrerelease)return!0;t=l}const r=new Set;let s,u,h,m,f,g,y;for(const t of e)">"===t.operator||">="===t.operator?s=d(s,t,n):"<"===t.operator||"<="===t.operator?u=p(u,t,n):r.add(t.semver);if(r.size>1)return null;if(s&&u){if(h=o(s.semver,u.semver,n),h>0)return null;if(0===h&&(">="!==s.operator||"<="!==u.operator))return null}for(const e of r){if(s&&!i(e,String(s),n))return null;if(u&&!i(e,String(u),n))return null;for(const r of t)if(!i(e,String(r),n))return!1;return!0}let _=!(!u||n.includePrerelease||!u.semver.prerelease.length)&&u.semver,v=!(!s||n.includePrerelease||!s.semver.prerelease.length)&&s.semver;_&&1===_.prerelease.length&&"<"===u.operator&&0===_.prerelease[0]&&(_=!1);for(const e of t){if(y=y||">"===e.operator||">="===e.operator,g=g||"<"===e.operator||"<="===e.operator,s)if(v&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===v.major&&e.semver.minor===v.minor&&e.semver.patch===v.patch&&(v=!1),">"===e.operator||">="===e.operator){if(m=d(s,e,n),m===e&&m!==s)return!1}else if(">="===s.operator&&!i(s.semver,String(e),n))return!1;if(u)if(_&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===_.major&&e.semver.minor===_.minor&&e.semver.patch===_.patch&&(_=!1),"<"===e.operator||"<="===e.operator){if(f=p(u,e,n),f===e&&f!==u)return!1}else if("<="===u.operator&&!i(u.semver,String(e),n))return!1;if(!e.operator&&(u||s)&&0!==h)return!1}return!(s&&g&&!u&&0!==h||u&&y&&!s&&0!==h||v||_)},d=(e,t,n)=>{if(!e)return t;const r=o(e.semver,t.semver,n);return r>0?e:r<0||">"===t.operator&&">="===e.operator?t:e},p=(e,t,n)=>{if(!e)return t;const r=o(e.semver,t.semver,n);return r<0?e:r>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,n={})=>{if(e===t)return!0;e=new r(e,n),t=new r(t,n);let s=!1;e:for(const r of e.set){for(const e of t.set){const t=u(r,e,n);if(s=s||null!==t,t)continue e}if(s)return!1}return!0}},9998:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,n){let r=0,s=e.length;for(;s>0;){const a=s/2|0;let i=r+a;n(e[i],t)<=0?(r=++i,s-=a+1):s=a}return r}}},n={};function r(e){var s=n[e];if(void 0!==s)return s.exports;var a=n[e]={id:e,loaded:!1,exports:{}};return t[e](a,a.exports,r),a.loaded=!0,a.exports}r.m=t,e=[],r.O=(t,n,s,a)=>{if(!n){var i=1/0;for(u=0;u<e.length;u++){for(var[n,s,a]=e[u],o=!0,c=0;c<n.length;c++)(!1&a||i>=a)&&Object.keys(r.O).every(e=>r.O[e](n[c]))?n.splice(c--,1):(o=!1,a<i&&(i=a));if(o){e.splice(u--,1);var l=s();void 0!==l&&(t=l)}}return t}a=a||0;for(var u=e.length;u>0&&e[u-1][2]>a;u--)e[u]=e[u-1];e[u]=[n,s,a]},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={57:0,350:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var s,a,[i,o,c]=n,l=0;if(i.some(t=>0!==e[t])){for(s in o)r.o(o,s)&&(r.m[s]=o[s]);if(c)var u=c(r)}for(t&&t(n);l<i.length;l++)a=i[l],r.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return r.O(u)},n=globalThis.webpackChunkwp_langchain=globalThis.webpackChunkwp_langchain||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})();var s=r.O(void 0,[350],()=>r(9771));s=r.O(s)})();