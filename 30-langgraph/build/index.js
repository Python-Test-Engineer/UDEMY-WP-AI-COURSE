(()=>{var e,t={204(e){"use strict";const t=/^[0-9]+$/,r=(e,r)=>{if("number"==typeof e&&"number"==typeof r)return e===r?0:e<r?-1:1;const n=t.test(e),a=t.test(r);return n&&a&&(e=+e,r=+r),e===r?0:n&&!a?-1:a&&!n?1:e<r?-1:1};e.exports={compareIdentifiers:r,rcompareIdentifiers:(e,t)=>r(t,e)}},228(e){"use strict";var t=Object.prototype.hasOwnProperty,r="~";function n(){}function a(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function s(e,t,n,s,i){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new a(n,s||e,i),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function i(e,t){0===--e._eventsCount?e._events=new n:delete e._events[t]}function o(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,n,a=[];if(0===this._eventsCount)return a;for(n in e=this._events)t.call(e,n)&&a.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},o.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var a=0,s=n.length,i=new Array(s);a<s;a++)i[a]=n[a].fn;return i},o.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},o.prototype.emit=function(e,t,n,a,s,i){var o=r?r+e:e;if(!this._events[o])return!1;var c,l,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,a),!0;case 5:return u.fn.call(u.context,t,n,a,s),!0;case 6:return u.fn.call(u.context,t,n,a,s,i),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var h,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,n);break;case 4:u[l].fn.call(u[l].context,t,n,a);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];u[l].fn.apply(u[l].context,c)}}return!0},o.prototype.on=function(e,t,r){return s(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return s(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,n,a){var s=r?r+e:e;if(!this._events[s])return this;if(!t)return i(this,s),this;var o=this._events[s];if(o.fn)o.fn!==t||a&&!o.once||n&&o.context!==n||i(this,s);else{for(var c=0,l=[],u=o.length;c<u;c++)(o[c].fn!==t||a&&!o[c].once||n&&o[c].context!==n)&&l.push(o[c]);l.length?this._events[s]=1===l.length?l[0]:l:i(this,s)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&i(this,t)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o},487(e,t,r){"use strict";const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:a,MAX_LENGTH:s}=r(6261),i=r(6735),o=(t=e.exports={}).re=[],c=t.safeRe=[],l=t.src=[],u=t.safeSrc=[],d=t.t={};let h=0;const p="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",s],[p,a]],m=(e,t,r)=>{const n=(e=>{for(const[t,r]of f)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),a=h++;i(e,a,t),d[e]=a,l[a]=t,u[a]=n,o[a]=new RegExp(t,r?"g":void 0),c[a]=new RegExp(n,r?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${p}*`),m("MAINVERSION",`(${l[d.NUMERICIDENTIFIER]})\\.(${l[d.NUMERICIDENTIFIER]})\\.(${l[d.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${l[d.NUMERICIDENTIFIERLOOSE]})\\.(${l[d.NUMERICIDENTIFIERLOOSE]})\\.(${l[d.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${l[d.NONNUMERICIDENTIFIER]}|${l[d.NUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${l[d.NONNUMERICIDENTIFIER]}|${l[d.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASE",`(?:-(${l[d.PRERELEASEIDENTIFIER]}(?:\\.${l[d.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${l[d.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[d.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${p}+`),m("BUILD",`(?:\\+(${l[d.BUILDIDENTIFIER]}(?:\\.${l[d.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${l[d.MAINVERSION]}${l[d.PRERELEASE]}?${l[d.BUILD]}?`),m("FULL",`^${l[d.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${l[d.MAINVERSIONLOOSE]}${l[d.PRERELEASELOOSE]}?${l[d.BUILD]}?`),m("LOOSE",`^${l[d.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${l[d.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${l[d.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${l[d.XRANGEIDENTIFIER]})(?:\\.(${l[d.XRANGEIDENTIFIER]})(?:\\.(${l[d.XRANGEIDENTIFIER]})(?:${l[d.PRERELEASE]})?${l[d.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${l[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[d.XRANGEIDENTIFIERLOOSE]})(?:${l[d.PRERELEASELOOSE]})?${l[d.BUILD]}?)?)?`),m("XRANGE",`^${l[d.GTLT]}\\s*${l[d.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${l[d.GTLT]}\\s*${l[d.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),m("COERCE",`${l[d.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",l[d.COERCEPLAIN]+`(?:${l[d.PRERELEASE]})?`+`(?:${l[d.BUILD]})?(?:$|[^\\d])`),m("COERCERTL",l[d.COERCE],!0),m("COERCERTLFULL",l[d.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${l[d.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",m("TILDE",`^${l[d.LONETILDE]}${l[d.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${l[d.LONETILDE]}${l[d.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${l[d.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",m("CARET",`^${l[d.LONECARET]}${l[d.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${l[d.LONECARET]}${l[d.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${l[d.GTLT]}\\s*(${l[d.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${l[d.GTLT]}\\s*(${l[d.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${l[d.GTLT]}\\s*(${l[d.LOOSEPLAIN]}|${l[d.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${l[d.XRANGEPLAIN]})\\s+-\\s+(${l[d.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${l[d.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[d.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},534(e,t,r){"use strict";const n=r(9558);e.exports=(e,t)=>new n(e,t).set.map(e=>e.map(e=>e.value).join(" ").trim().split(" "))},547(e,t,r){"use strict";const n=r(4899);e.exports=(e,t)=>new n(e,t).minor},639(e){"use strict";e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},753(e,t,r){"use strict";const n=r(9558);e.exports=(e,t,r)=>(e=new n(e,r),t=new n(t,r),e.intersects(t,r))},818(e,t,r){"use strict";const n=r(4621);e.exports=(e,t,r)=>0===n(e,t,r)},995(e,t,r){"use strict";const n=r(9558);e.exports=(e,t,r)=>{try{t=new n(t,r)}catch(e){return!1}return t.test(e)}},1534(e,t,r){"use strict";const n=r(818),a=r(9606),s=r(2559),i=r(7372),o=r(4056),c=r(6133);e.exports=(e,t,r,l)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return n(e,r,l);case"!=":return a(e,r,l);case">":return s(e,r,l);case">=":return i(e,r,l);case"<":return o(e,r,l);case"<=":return c(e,r,l);default:throw new TypeError(`Invalid operator: ${t}`)}}},1620(e,t,r){"use strict";const n=r(995),a=r(4621);e.exports=(e,t,r)=>{const s=[];let i=null,o=null;const c=e.sort((e,t)=>a(e,t,r));for(const e of c)n(e,t,r)?(o=e,i||(i=e)):(o&&s.push([i,o]),o=null,i=null);i&&s.push([i,null]);const l=[];for(const[e,t]of s)e===t?l.push(e):t||e!==c[0]?t?e===c[0]?l.push(`<=${t}`):l.push(`${e} - ${t}`):l.push(`>=${e}`):l.push("*");const u=l.join(" || "),d="string"==typeof t.raw?t.raw:String(t);return u.length<d.length?u:t}},2153(e,t,r){"use strict";const n=r(9558);e.exports=(e,t)=>{try{return new n(e,t).range||"*"}catch(e){return null}}},2469(e,t,r){"use strict";const n=r(4621);e.exports=(e,t,r)=>n(t,e,r)},2559(e,t,r){"use strict";const n=r(4621);e.exports=(e,t,r)=>n(e,t,r)>0},2729(e){"use strict";const t=/[\p{Lu}]/u,r=/[\p{Ll}]/u,n=/^[\p{Lu}](?![\p{Lu}])/gu,a=/([\p{Alpha}\p{N}_]|$)/u,s=/[_.\- ]+/,i=new RegExp("^"+s.source),o=new RegExp(s.source+a.source,"gu"),c=new RegExp("\\d+"+a.source,"gu"),l=(e,a)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(a={pascalCase:!1,preserveConsecutiveUppercase:!1,...a},0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length)return"";const s=!1===a.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(a.locale),l=!1===a.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(a.locale);return 1===e.length?a.pascalCase?l(e):s(e):(e!==s(e)&&(e=((e,n,a)=>{let s=!1,i=!1,o=!1;for(let c=0;c<e.length;c++){const l=e[c];s&&t.test(l)?(e=e.slice(0,c)+"-"+e.slice(c),s=!1,o=i,i=!0,c++):i&&o&&r.test(l)?(e=e.slice(0,c-1)+"-"+e.slice(c-1),o=i,i=!1,s=!0):(s=n(l)===l&&a(l)!==l,o=i,i=a(l)===l&&n(l)!==l)}return e})(e,s,l)),e=e.replace(i,""),e=a.preserveConsecutiveUppercase?((e,t)=>(n.lastIndex=0,e.replace(n,e=>t(e))))(e,s):s(e),a.pascalCase&&(e=l(e.charAt(0))+e.slice(1)),((e,t)=>(o.lastIndex=0,c.lastIndex=0,e.replace(o,(e,r)=>t(r)).replace(c,e=>t(e))))(e,l))};e.exports=l,e.exports.default=l},3042(e,t,r){"use strict";const n=r(4621);e.exports=(e,t)=>n(e,t,!0)},3290(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(228),a=r(6641),s=r(4774),i=()=>{},o=new a.TimeoutError;t.default=class extends n{constructor(e){var t,r,n,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=i,this._resolveIdle=i,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:s.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(r=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==r?r:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(a=null===(n=e.interval)||void 0===n?void 0:n.toString())&&void 0!==a?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=i,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=i,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,n)=>{this._queue.enqueue(async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():a.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&n(o)});r(await s)}catch(e){n(e)}this._next()},t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},3602(e,t,r){"use strict";const n=r(4899),a=r(9558),s=r(2559);e.exports=(e,t)=>{e=new a(e,t);let r=new n("0.0.0");if(e.test(r))return r;if(r=new n("0.0.0-0"),e.test(r))return r;r=null;for(let t=0;t<e.set.length;++t){const a=e.set[t];let i=null;a.forEach(e=>{const t=new n(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":i&&!s(t,i)||(i=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}}),!i||r&&!s(r,i)||(r=i)}return r&&e.test(r)?r:null}},3690(e,t,r){"use strict";const n=r(7737);e.exports=(e,t)=>{const r=n(e,t);return r&&r.prerelease.length?r.prerelease:null}},3767(e,t,r){"use strict";const n=r(4899);e.exports=(e,t)=>new n(e,t).major},3961(e){function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout(function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout(function(){n._operationTimeoutCb(n._attempts)},n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)},r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var a=this._errors[n],s=a.message,i=(e[s]||0)+1;e[s]=i,i>=r&&(t=a,r=i)}return t}},4004(e,t,r){"use strict";const n=r(7737);e.exports=(e,t)=>{const r=n(e,t);return r?r.version:null}},4056(e,t,r){"use strict";const n=r(4621);e.exports=(e,t,r)=>n(e,t,r)<0},4076(e,t,r){"use strict";const n=r(6592);e.exports=(e,t,r)=>n(e,t,">",r)},4083(e,t,r){"use strict";e=r.nmd(e);const n=(e=0)=>t=>`[${38+e};5;${t}m`,a=(e=0)=>(t,r,n)=>`[${38+e};2;${t};${r};${n}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright;for(const[r,n]of Object.entries(t)){for(const[r,a]of Object.entries(n))t[r]={open:`[${a[0]}m`,close:`[${a[1]}m`},n[r]=t[r],e.set(a[0],a[1]);Object.defineProperty(t,r,{value:n,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="[39m",t.bgColor.close="[49m",t.color.ansi256=n(),t.color.ansi16m=a(),t.bgColor.ansi256=n(10),t.bgColor.ansi16m=a(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:r}=t.groups;3===r.length&&(r=r.split("").map(e=>e+e).join(""));const n=Number.parseInt(r,16);return[n>>16&255,n>>8&255,255&n]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},4106(e,t,r){"use strict";const n=r(4899);e.exports=(e,t,r,a,s)=>{"string"==typeof r&&(s=a,a=r,r=void 0);try{return new n(e instanceof n?e.version:e,r).inc(t,a,s).version}catch(e){return null}}},4116(e,t,r){"use strict";const n=r(5617),a=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class s extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const i=(e,t)=>new Promise((r,i)=>{t={onFailedAttempt:()=>{},retries:10,...t};const o=n.operation(t);o.attempt(async n=>{try{r(await e(n))}catch(e){if(!(e instanceof Error))return void i(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof s)o.stop(),i(e.originalError);else if(e instanceof TypeError&&(c=e.message,!a.includes(c)))o.stop(),i(e);else{((e,t,r)=>{const n=r.retries-(t-1);e.attemptNumber=t,e.retriesLeft=n})(e,n,t);try{await t.onFailedAttempt(e)}catch(e){return void i(e)}o.retry(e)||i(o.mainError())}}var c})});e.exports=i,e.exports.default=i,e.exports.AbortError=s},4453(e,t,r){"use strict";const n=r(6592);e.exports=(e,t,r)=>n(e,t,"<",r)},4617(e){"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then(e=>new Promise(e=>{e(t())}).then(()=>e),e=>new Promise(e=>{e(t())}).then(()=>{throw e})))},4621(e,t,r){"use strict";const n=r(4899);e.exports=(e,t,r)=>new n(e,r).compare(new n(t,r))},4774(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(9998);t.default=class{constructor(){this._queue=[]}enqueue(e,t){const r={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(r);const a=n.default(this._queue,r,(e,t)=>t.priority-e.priority);this._queue.splice(a,0,r)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this._queue.length}}},4899(e,t,r){"use strict";const n=r(6735),{MAX_LENGTH:a,MAX_SAFE_INTEGER:s}=r(6261),{safeRe:i,t:o}=r(487),c=r(6588),{compareIdentifiers:l}=r(204);class u{constructor(e,t){if(t=c(t),e instanceof u){if(e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease)return e;e=e.version}else if("string"!=typeof e)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>a)throw new TypeError(`version is longer than ${a} characters`);n("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;const r=e.trim().match(t.loose?i[o.LOOSE]:i[o.FULL]);if(!r)throw new TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>s||this.major<0)throw new TypeError("Invalid major version");if(this.minor>s||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>s||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<s)return t}return e}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(n("SemVer.compare",this.version,this.options,e),!(e instanceof u)){if("string"==typeof e&&e===this.version)return 0;e=new u(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof u||(e=new u(e,this.options)),this.major<e.major?-1:this.major>e.major?1:this.minor<e.minor?-1:this.minor>e.minor?1:this.patch<e.patch?-1:this.patch>e.patch?1:0}comparePre(e){if(e instanceof u||(e=new u(e,this.options)),this.prerelease.length&&!e.prerelease.length)return-1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{const r=this.prerelease[t],a=e.prerelease[t];if(n("prerelease compare",t,r,a),void 0===r&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===r)return-1;if(r!==a)return l(r,a)}while(++t)}compareBuild(e){e instanceof u||(e=new u(e,this.options));let t=0;do{const r=this.build[t],a=e.build[t];if(n("build compare",t,r,a),void 0===r&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===r)return-1;if(r!==a)return l(r,a)}while(++t)}inc(e,t,r){if(e.startsWith("pre")){if(!t&&!1===r)throw new Error("invalid increment argument: identifier is empty");if(t){const e=`-${t}`.match(this.options.loose?i[o.PRERELEASELOOSE]:i[o.PRERELEASE]);if(!e||e[1]!==t)throw new Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"release":if(0===this.prerelease.length)throw new Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(r)?1:0;if(0===this.prerelease.length)this.prerelease=[e];else{let n=this.prerelease.length;for(;--n>=0;)"number"==typeof this.prerelease[n]&&(this.prerelease[n]++,n=-2);if(-1===n){if(t===this.prerelease.join(".")&&!1===r)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let n=[t,e];!1===r&&(n=[t]),0===l(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=n):this.prerelease=n}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=u},5617(e,t,r){e.exports=r(8303)},5985(e,t,r){"use strict";const n=r(4899),a=r(9558);e.exports=(e,t,r)=>{let s=null,i=null,o=null;try{o=new a(t,r)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(s&&-1!==i.compare(e)||(s=e,i=new n(s,r)))}),s}},6133(e,t,r){"use strict";const n=r(4621);e.exports=(e,t,r)=>n(e,t,r)<=0},6261(e){"use strict";const t=Number.MAX_SAFE_INTEGER||9007199254740991;e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:t,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},6588(e){"use strict";const t=Object.freeze({loose:!0}),r=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:r},6592(e,t,r){"use strict";const n=r(4899),a=r(6635),{ANY:s}=a,i=r(9558),o=r(995),c=r(2559),l=r(4056),u=r(6133),d=r(7372);e.exports=(e,t,r,h)=>{let p,f,m,g,y;switch(e=new n(e,h),t=new i(t,h),r){case">":p=c,f=u,m=l,g=">",y=">=";break;case"<":p=l,f=d,m=c,g="<",y="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,h))return!1;for(let r=0;r<t.set.length;++r){const n=t.set[r];let i=null,o=null;if(n.forEach(e=>{e.semver===s&&(e=new a(">=0.0.0")),i=i||e,o=o||e,p(e.semver,i.semver,h)?i=e:m(e.semver,o.semver,h)&&(o=e)}),i.operator===g||i.operator===y)return!1;if((!o.operator||o.operator===g)&&f(e,o.semver))return!1;if(o.operator===y&&m(e,o.semver))return!1}return!0}},6635(e,t,r){"use strict";const n=Symbol("SemVer ANY");class a{static get ANY(){return n}constructor(e,t){if(t=s(t),e instanceof a){if(e.loose===!!t.loose)return e;e=e.value}e=e.trim().split(/\s+/).join(" "),l("comparator",e,t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===n?this.value="":this.value=this.operator+this.semver.version,l("comp",this)}parse(e){const t=this.options.loose?i[o.COMPARATORLOOSE]:i[o.COMPARATOR],r=e.match(t);if(!r)throw new TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==r[1]?r[1]:"","="===this.operator&&(this.operator=""),r[2]?this.semver=new u(r[2],this.options.loose):this.semver=n}toString(){return this.value}test(e){if(l("Comparator.test",e,this.options.loose),this.semver===n||e===n)return!0;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}return c(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new d(e.value,t).test(this.value):""===e.operator?""===e.value||new d(this.value,t).test(e.semver):!((t=s(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0"))||(!this.operator.startsWith(">")||!e.operator.startsWith(">"))&&(!this.operator.startsWith("<")||!e.operator.startsWith("<"))&&(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))&&!(c(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))&&!(c(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))}}e.exports=a;const s=r(6588),{safeRe:i,t:o}=r(487),c=r(1534),l=r(6735),u=r(4899),d=r(9558)},6641(e,t,r){"use strict";const n=r(4617);class a extends Error{constructor(e){super(e),this.name="TimeoutError"}}const s=(e,t,r)=>new Promise((s,i)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void s(e);const o=setTimeout(()=>{if("function"==typeof r){try{s(r())}catch(e){i(e)}return}const n=r instanceof Error?r:new a("string"==typeof r?r:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),i(n)},t);n(e.then(s,i),()=>{clearTimeout(o)})});e.exports=s,e.exports.default=s,e.exports.TimeoutError=a},6735(e){"use strict";const t="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};e.exports=t},6856(e,t,r){"use strict";const n=r(8136);e.exports=(e,t)=>e.sort((e,r)=>n(e,r,t))},6945(e,t,r){"use strict";const n=r(4899),a=r(7737),{safeRe:s,t:i}=r(487);e.exports=(e,t)=>{if(e instanceof n)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let r=null;if((t=t||{}).rtl){const n=t.includePrerelease?s[i.COERCERTLFULL]:s[i.COERCERTL];let a;for(;(a=n.exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&a.index+a[0].length===r.index+r[0].length||(r=a),n.lastIndex=a.index+a[1].length+a[2].length;n.lastIndex=-1}else r=e.match(t.includePrerelease?s[i.COERCEFULL]:s[i.COERCE]);if(null===r)return null;const o=r[2],c=r[3]||"0",l=r[4]||"0",u=t.includePrerelease&&r[5]?`-${r[5]}`:"",d=t.includePrerelease&&r[6]?`+${r[6]}`:"";return a(`${o}.${c}.${l}${u}${d}`,t)}},7119(e,t,r){"use strict";const n=r(7737);e.exports=(e,t)=>{const r=n(e,null,!0),a=n(t,null,!0),s=r.compare(a);if(0===s)return null;const i=s>0,o=i?r:a,c=i?a:r,l=!!o.prerelease.length;if(c.prerelease.length&&!l){if(!c.patch&&!c.minor)return"major";if(0===c.compareMain(o))return c.minor&&!c.patch?"minor":"patch"}const u=l?"pre":"";return r.major!==a.major?u+"major":r.minor!==a.minor?u+"minor":r.patch!==a.patch?u+"patch":"prerelease"}},7280(e,t,r){"use strict";const n=r(487),a=r(6261),s=r(4899),i=r(204),o=r(7737),c=r(4004),l=r(9855),u=r(4106),d=r(7119),h=r(3767),p=r(547),f=r(9196),m=r(3690),g=r(4621),y=r(2469),_=r(3042),b=r(8136),w=r(6856),v=r(9056),O=r(2559),E=r(4056),k=r(818),x=r(9606),S=r(7372),A=r(6133),I=r(1534),P=r(6945),$=r(6635),T=r(9558),j=r(995),R=r(534),N=r(5985),C=r(9499),L=r(3602),M=r(2153),z=r(6592),U=r(4076),D=r(4453),F=r(753),B=r(1620),Z=r(9881);e.exports={parse:o,valid:c,clean:l,inc:u,diff:d,major:h,minor:p,patch:f,prerelease:m,compare:g,rcompare:y,compareLoose:_,compareBuild:b,sort:w,rsort:v,gt:O,lt:E,eq:k,neq:x,gte:S,lte:A,cmp:I,coerce:P,Comparator:$,Range:T,satisfies:j,toComparators:R,maxSatisfying:N,minSatisfying:C,minVersion:L,validRange:M,outside:z,gtr:U,ltr:D,intersects:F,simplifyRange:B,subset:Z,SemVer:s,re:n.re,src:n.src,tokens:n.t,SEMVER_SPEC_VERSION:a.SEMVER_SPEC_VERSION,RELEASE_TYPES:a.RELEASE_TYPES,compareIdentifiers:i.compareIdentifiers,rcompareIdentifiers:i.rcompareIdentifiers}},7372(e,t,r){"use strict";const n=r(4621);e.exports=(e,t,r)=>n(e,t,r)>=0},7526(e,t){"use strict";t.byteLength=function(e){var t=o(e),r=t[0],n=t[1];return 3*(r+n)/4-n},t.toByteArray=function(e){var t,r,s=o(e),i=s[0],c=s[1],l=new a(function(e,t,r){return 3*(t+r)/4-r}(0,i,c)),u=0,d=c>0?i-4:i;for(r=0;r<d;r+=4)t=n[e.charCodeAt(r)]<<18|n[e.charCodeAt(r+1)]<<12|n[e.charCodeAt(r+2)]<<6|n[e.charCodeAt(r+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;return 2===c&&(t=n[e.charCodeAt(r)]<<2|n[e.charCodeAt(r+1)]>>4,l[u++]=255&t),1===c&&(t=n[e.charCodeAt(r)]<<10|n[e.charCodeAt(r+1)]<<4|n[e.charCodeAt(r+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t),l},t.fromByteArray=function(e){for(var t,n=e.length,a=n%3,s=[],i=16383,o=0,c=n-a;o<c;o+=i)s.push(l(e,o,o+i>c?c:o+i));return 1===a?(t=e[n-1],s.push(r[t>>2]+r[t<<4&63]+"==")):2===a&&(t=(e[n-2]<<8)+e[n-1],s.push(r[t>>10]+r[t>>4&63]+r[t<<2&63]+"=")),s.join("")};for(var r=[],n=[],a="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0;i<64;++i)r[i]=s[i],n[s.charCodeAt(i)]=i;function o(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function c(e){return r[e>>18&63]+r[e>>12&63]+r[e>>6&63]+r[63&e]}function l(e,t,r){for(var n,a=[],s=t;s<r;s+=3)n=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(255&e[s+2]),a.push(c(n));return a.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},7737(e,t,r){"use strict";const n=r(4899);e.exports=(e,t,r=!1)=>{if(e instanceof n)return e;try{return new n(e,t)}catch(e){if(!r)return null;throw e}}},8089(e,t,r){"use strict";var n={};r.r(n),r.d(n,{JsonPatchError:()=>Yi,_areEquals:()=>co,applyOperation:()=>no,applyPatch:()=>ao,applyReducer:()=>so,deepClone:()=>Qi,getValueByPointer:()=>ro,validate:()=>oo,validator:()=>io});const a="RFC3986",s={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},i=(Object.prototype.hasOwnProperty,Array.isArray),o=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),c=1024;function l(e,t){if(i(e)){const r=[];for(let n=0;n<e.length;n+=1)r.push(t(e[n]));return r}return t(e)}const u=Object.prototype.hasOwnProperty,d={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},h=Array.isArray,p=Array.prototype.push,f=function(e,t){p.apply(e,h(t)?t:[t])},m=Date.prototype.toISOString,g={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,r,n,a)=>{if(0===e.length)return e;let s=e;if("symbol"==typeof e?s=Symbol.prototype.toString.call(e):"string"!=typeof e&&(s=String(e)),"iso-8859-1"===r)return escape(s).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let i="";for(let e=0;e<s.length;e+=c){const t=s.length>=c?s.slice(e,e+c):s,r=[];for(let e=0;e<t.length;++e){let n=t.charCodeAt(e);45===n||46===n||95===n||126===n||n>=48&&n<=57||n>=65&&n<=90||n>=97&&n<=122||"RFC1738"===a&&(40===n||41===n)?r[r.length]=t.charAt(e):n<128?r[r.length]=o[n]:n<2048?r[r.length]=o[192|n>>6]+o[128|63&n]:n<55296||n>=57344?r[r.length]=o[224|n>>12]+o[128|n>>6&63]+o[128|63&n]:(e+=1,n=65536+((1023&n)<<10|1023&t.charCodeAt(e)),r[r.length]=o[240|n>>18]+o[128|n>>12&63]+o[128|n>>6&63]+o[128|63&n])}i+=r.join("")}return i},encodeValuesOnly:!1,format:a,formatter:s[a],indices:!1,serializeDate:e=>m.call(e),skipNulls:!1,strictNullHandling:!1},y={};function _(e,t,r,n,a,s,i,o,c,u,d,p,m,b,w,v,O,E){let k=e,x=E,S=0,A=!1;for(;void 0!==(x=x.get(y))&&!A;){const t=x.get(e);if(S+=1,void 0!==t){if(t===S)throw new RangeError("Cyclic object value");A=!0}void 0===x.get(y)&&(S=0)}if("function"==typeof u?k=u(t,k):k instanceof Date?k=m?.(k):"comma"===r&&h(k)&&(k=l(k,function(e){return e instanceof Date?m?.(e):e})),null===k){if(s)return c&&!v?c(t,g.encoder,O,"key",b):t;k=""}if("string"==typeof(I=k)||"number"==typeof I||"boolean"==typeof I||"symbol"==typeof I||"bigint"==typeof I||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(k)){if(c){const e=v?t:c(t,g.encoder,O,"key",b);return[w?.(e)+"="+w?.(c(k,g.encoder,O,"value",b))]}return[w?.(t)+"="+w?.(String(k))]}var I;const P=[];if(void 0===k)return P;let $;if("comma"===r&&h(k))v&&c&&(k=l(k,c)),$=[{value:k.length>0?k.join(",")||null:void 0}];else if(h(u))$=u;else{const e=Object.keys(k);$=d?e.sort(d):e}const T=o?String(t).replace(/\./g,"%2E"):String(t),j=n&&h(k)&&1===k.length?T+"[]":T;if(a&&h(k)&&0===k.length)return j+"[]";for(let t=0;t<$.length;++t){const l=$[t],g="object"==typeof l&&void 0!==l.value?l.value:k[l];if(i&&null===g)continue;const x=p&&o?l.replace(/\./g,"%2E"):l,A=h(k)?"function"==typeof r?r(j,x):j:j+(p?"."+x:"["+x+"]");E.set(e,S);const I=new WeakMap;I.set(y,E),f(P,_(g,A,r,n,a,s,i,o,"comma"===r&&v&&h(k)?null:c,u,d,p,m,b,w,v,O,I))}return P}const b="4.104.0";let w,v,O,E,k,x,S,A,I,P=!1,$=null,T=null,j=null,R=null;class N{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}const C=()=>{w||function(e,t={auto:!1}){if(P)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(w)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${w}'\``);P=t.auto,w=e.kind,v=e.fetch,$=e.Request,T=e.Response,j=e.Headers,O=e.FormData,R=e.Blob,E=e.File,k=e.ReadableStream,x=e.getMultipartRequestOptions,S=e.getDefaultAgent,A=e.fileFromPath,I=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let r,n,a,s;try{r=fetch,n=Request,a=Response,s=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:r,Request:n,Response:a,Headers:s,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new N(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0})};C();class L extends Error{}class M extends L{constructor(e,t,r,n){super(`${M.makeMessage(e,t,r)}`),this.status=e,this.headers=n,this.request_id=n?.["x-request-id"],this.error=t;const a=t;this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,r){const n=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,r,n){if(!e||!n)return new U({message:r,cause:Ce(t)});const a=t?.error;return 400===e?new F(e,a,r,n):401===e?new B(e,a,r,n):403===e?new Z(e,a,r,n):404===e?new q(e,a,r,n):409===e?new H(e,a,r,n):422===e?new J(e,a,r,n):429===e?new G(e,a,r,n):e>=500?new W(e,a,r,n):new M(e,a,r,n)}}class z extends M{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class U extends M{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class D extends U{constructor({message:e}={}){super({message:e??"Request timed out."})}}class F extends M{}class B extends M{}class Z extends M{}class q extends M{}class H extends M{}class J extends M{}class G extends M{}class W extends M{}class K extends L{constructor(){super("Could not parse response content as the length limit was reached")}}class V extends L{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var X,Y=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r},Q=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class ee{constructor(){X.set(this,void 0),this.buffer=new Uint8Array,Y(this,X,null,"f")}decode(e){if(null==e)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?(new TextEncoder).encode(e):e;let r=new Uint8Array(this.buffer.length+t.length);r.set(this.buffer),r.set(t,this.buffer.length),this.buffer=r;const n=[];let a;for(;null!=(a=te(this.buffer,Q(this,X,"f")));){if(a.carriage&&null==Q(this,X,"f")){Y(this,X,a.index,"f");continue}if(null!=Q(this,X,"f")&&(a.index!==Q(this,X,"f")+1||a.carriage)){n.push(this.decodeText(this.buffer.slice(0,Q(this,X,"f")-1))),this.buffer=this.buffer.slice(Q(this,X,"f")),Y(this,X,null,"f");continue}const e=null!==Q(this,X,"f")?a.preceding-1:a.preceding,t=this.decodeText(this.buffer.slice(0,e));n.push(t),this.buffer=this.buffer.slice(a.index),Y(this,X,null,"f")}return n}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new L(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new L(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new L("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode("\n"):[]}}function te(e,t){for(let r=t??0;r<e.length;r++){if(10===e[r])return{preceding:r,index:r+1,carriage:!1};if(13===e[r])return{preceding:r,index:r+1,carriage:!0}}return null}function re(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}function ne(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}X=new WeakMap,ee.NEWLINE_CHARS=new Set(["\n","\r"]),ee.NEWLINE_REGEXP=/\r\n|[\n\r]/g;class ae{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;return new ae(async function*(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const r of async function*(e,t){if(!e.body)throw t.abort(),new L("Attempted to iterate over a response with no body");const r=new se,n=new ee,a=ne(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const r of e){if(null==r)continue;const e=r instanceof ArrayBuffer?new Uint8Array(r):"string"==typeof r?(new TextEncoder).encode(r):r;let n,a=new Uint8Array(t.length+e.length);for(a.set(t),a.set(e,t.length),t=a;-1!==(n=re(t));)yield t.slice(0,n),t=t.slice(n)}t.length>0&&(yield t)}(a))for(const t of n.decode(e)){const e=r.decode(t);e&&(yield e)}for(const e of n.flush()){const t=r.decode(e);t&&(yield t)}}(e,t))if(!n)if(r.data.startsWith("[DONE]"))n=!0;else if(null===r.event||r.event.startsWith("response.")||r.event.startsWith("transcript.")){let t;try{t=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if(t&&t.error)throw new M(void 0,t.error,void 0,Ee(e.headers));yield t}else{let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if("error"==r.event)throw new M(void 0,e.error,e.message,void 0);yield{event:r.event,data:e}}n=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{n||t.abort()}},t)}static fromReadableStream(e,t){let r=!1;return new ae(async function*(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let n=!1;try{for await(const t of async function*(){const t=new ee,r=ne(e);for await(const e of r)for(const r of t.decode(e))yield r;for(const e of t.flush())yield e}())n||t&&(yield JSON.parse(t));n=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{n||t.abort()}},t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),n=n=>({next:()=>{if(0===n.length){const n=r.next();e.push(n),t.push(n)}return n.shift()}});return[new ae(()=>n(e),this.controller),new ae(()=>n(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new k({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:n,done:a}=await t.next();if(a)return e.close();const s=r.encode(JSON.stringify(n)+"\n");e.enqueue(s)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}class se{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,n]=function(e){const t=e.indexOf(":");return-1!==t?[e.substring(0,t),":",e.substring(t+1)]:[e,"",""]}(e);return n.startsWith(" ")&&(n=n.substring(1)),"event"===t?this.event=n:"data"===t&&this.data.push(n),null}}const ie=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,oe=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&ce(e),ce=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function le(e,t,r){if(e=await e,oe(e))return e;if(ie(e)){const n=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const a=ce(n)?[await n.arrayBuffer()]:[n];return new E(a,t,r)}const n=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(ce(e))t.push(await e.arrayBuffer());else{if(!de(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){return`[${Object.getOwnPropertyNames(e).map(e=>`"${e}"`).join(", ")}]`}(e)}`);for await(const r of e)t.push(r)}return t}(e);if(t||(t=function(e){return ue(e.name)||ue(e.filename)||ue(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!r?.type){const e=n[0]?.type;"string"==typeof e&&(r={...r,type:e})}return new E(n,t,r)}const ue=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,de=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],he=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],pe=async e=>{const t=await fe(e.body);return x(t,e)},fe=async e=>{const t=new O;return await Promise.all(Object.entries(e||{}).map(([e,r])=>me(t,e,r))),t},me=async(e,t,r)=>{if(void 0!==r){if(null==r)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof r||"number"==typeof r||"boolean"==typeof r)e.append(t,String(r));else if((e=>oe(e)||ie(e)||I(e))(r)){const n=await le(r);e.append(t,n)}else if(Array.isArray(r))await Promise.all(r.map(r=>me(e,t+"[]",r)));else{if("object"!=typeof r)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${r} instead`);await Promise.all(Object.entries(r).map(([r,n])=>me(e,`${t}[${r}]`,n)))}}};var ge;async function ye(e){const{response:t}=e;if(e.options.stream)return Fe("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):ae.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const r=t.headers.get("content-type"),n=r?.split(";")[0]?.trim();if(n?.includes("application/json")||n?.endsWith("+json")){const e=await t.json();return Fe("response",t.status,t.url,t.headers,e),_e(e,t)}const a=await t.text();return Fe("response",t.status,t.url,t.headers,a),a}function _e(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}C();class be extends Promise{constructor(e,t=ye){super(e=>{e(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new be(this.responsePromise,async t=>_e(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class we{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:n,fetch:a}){this.baseURL=e,this.maxRetries=Ne("maxRetries",t),this.timeout=Ne("timeout",r),this.httpAgent=n,this.fetch=a??v}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Pe(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Be()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(async r=>{const n=r&&ce(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:n}}))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder)return(new TextEncoder).encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const r={...e},{method:n,path:a,query:s,headers:i={}}=r,o=ArrayBuffer.isView(r.body)||r.__binaryRequest&&"string"==typeof r.body?r.body:he(r.body)?r.body.body:r.body?JSON.stringify(r.body,null,2):null,c=this.calculateContentLength(o),l=this.buildURL(a,s);"timeout"in r&&Ne("timeout",r.timeout),r.timeout=r.timeout??this.timeout;const u=r.httpAgent??this.httpAgent??S(l),d=r.timeout+1e3;return"number"==typeof u?.options?.timeout&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey),{req:{method:n,...o&&{body:o},headers:this.buildHeaders({options:r,headers:i,contentLength:c,retryCount:t}),...u&&{agent:u},signal:r.signal??null},url:l,timeout:r.timeout}}buildHeaders({options:e,headers:t,contentLength:r,retryCount:n}){const a={};r&&(a["content-length"]=r);const s=this.defaultHeaders(e);return Ue(a,s),Ue(a,t),he(e.body)&&"node"!==w&&delete a["content-type"],void 0===Ze(s,"x-stainless-retry-count")&&void 0===Ze(t,"x-stainless-retry-count")&&(a["x-stainless-retry-count"]=String(n)),void 0===Ze(s,"x-stainless-timeout")&&void 0===Ze(t,"x-stainless-timeout")&&e.timeout&&(a["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(e=>[...e])):{...e}:{}}makeStatusError(e,t,r,n){return M.generate(e,t,r,n)}request(e,t=null){return new be(this.makeRequest(e,t))}async makeRequest(e,t){const r=await e,n=r.maxRetries??this.maxRetries;null==t&&(t=n),await this.prepareOptions(r);const{req:a,url:s,timeout:i}=this.buildRequest(r,{retryCount:n-t});if(await this.prepareRequest(a,{url:s,options:r}),Fe("request",s,r,a.headers),r.signal?.aborted)throw new z;const o=new AbortController,c=await this.fetchWithTimeout(s,a,i,o).catch(Ce);if(c instanceof Error){if(r.signal?.aborted)throw new z;if(t)return this.retryRequest(r,t);if("AbortError"===c.name)throw new D;throw new U({cause:c})}const l=Ee(c.headers);if(!c.ok){if(t&&this.shouldRetry(c))return Fe(`response (error; retrying, ${t} attempts remaining)`,c.status,s,l),this.retryRequest(r,t,l);const e=await c.text().catch(e=>Ce(e).message),n=$e(e),a=n?void 0:e;throw Fe(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,s,l,a),this.makeStatusError(c.status,n,a,l)}return{response:c,options:r,controller:o}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new Oe(this,r,e)}buildURL(e,t){const r=je(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),n=this.defaultQuery();return Me(n)||(t={...n,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([e,t])=>void 0!==t).map(([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new L(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,n){const{signal:a,...s}=t||{};a&&a.addEventListener("abort",()=>n.abort());const i=setTimeout(()=>n.abort(),r),o={signal:n.signal,...s};return o.method&&(o.method=o.method.toUpperCase()),this.fetch.call(void 0,e,o).finally(()=>{clearTimeout(i)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||e.status>=500)}async retryRequest(e,t,r){let n;const a=r?.["retry-after-ms"];if(a){const e=parseFloat(a);Number.isNaN(e)||(n=e)}const s=r?.["retry-after"];if(s&&!n){const e=parseFloat(s);n=Number.isNaN(e)?Date.parse(s)-Date.now():1e3*e}if(!(n&&0<=n&&n<6e4)){const r=e.maxRetries??this.maxRetries;n=this.calculateDefaultRetryTimeoutMillis(t,r)}return await Re(n),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const r=t-e;return Math.min(.5*Math.pow(2,r),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${b}`}}class ve{constructor(e,t,r,n){ge.set(this,void 0),function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===n?a.call(e,r):a?a.value=r:t.set(e,r)}(this,ge,e,"f"),this.options=n,this.response=t,this.body=r}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new L("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,n]of r)e.url.searchParams.set(t,n);t.query=void 0,t.path=e.url.toString()}return await function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)}(this,ge,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(ge=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Oe extends be{constructor(e,t,r){super(t,async t=>new r(e,t.response,await ye(t),t.options))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const Ee=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),ke={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},xe=e=>"object"==typeof e&&null!==e&&!Me(e)&&Object.keys(e).every(e=>ze(ke,e)),Se=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Ae=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let Ie;const Pe=()=>Ie??(Ie=(()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":b,"X-Stainless-OS":Ae(Deno.build.os),"X-Stainless-Arch":Se(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":b,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":b,"X-Stainless-OS":Ae(process.platform),"X-Stainless-Arch":Se(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:r}of e){const e=r.exec(navigator.userAgent);if(e)return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":b,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":b,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),$e=e=>{try{return JSON.parse(e)}catch(e){return}},Te=/^[a-z][a-z0-9+.-]*:/i,je=e=>Te.test(e),Re=e=>new Promise(t=>setTimeout(t,e)),Ne=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new L(`${e} must be an integer`);if(t<0)throw new L(`${e} must be a positive integer`);return t},Ce=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},Le=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function Me(e){if(!e)return!0;for(const t in e)return!1;return!0}function ze(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Ue(e,t){for(const r in t){if(!ze(t,r))continue;const n=r.toLowerCase();if(!n)continue;const a=t[r];null===a?delete e[n]:void 0!==a&&(e[n]=a)}}const De=new Set(["authorization","api-key"]);function Fe(e,...t){if("undefined"!=typeof process&&"true"===process?.env?.DEBUG){const r=t.map(e=>{if(!e)return e;if(e.headers){const t={...e,headers:{...e.headers}};for(const r in e.headers)De.has(r.toLowerCase())&&(t.headers[r]="REDACTED");return t}let t=null;for(const r in e)De.has(r.toLowerCase())&&(t??(t={...e}),t[r]="REDACTED");return t??e});console.log(`OpenAI:DEBUG:${e}`,...r)}}const Be=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),Ze=(e,t)=>{const r=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const n=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,(e,t,r)=>t+r.toUpperCase());for(const a of[t,r,t.toUpperCase(),n]){const t=e.get(a);if(t)return t}}for(const[n,a]of Object.entries(e))if(n.toLowerCase()===r)return Array.isArray(a)?(a.length<=1||console.warn(`Received ${a.length} entries for the ${t} header, using the first entry.`),a[0]):a};function qe(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class He{constructor(e){this._client=e}}class Je extends He{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class Ge extends He{list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,Ye,{query:t,...r})}}class We extends ve{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Ke extends ve{constructor(e,t,r,n){super(e,t,r,n),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class Ve extends He{constructor(){super(...arguments),this.messages=new Ge(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/chat/completions",Xe,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}}class Xe extends Ke{}class Ye extends Ke{}Ve.ChatCompletionsPage=Xe,Ve.Messages=Ge;class Qe extends He{constructor(){super(...arguments),this.completions=new Ve(this._client)}}Qe.Completions=Ve,Qe.ChatCompletionsPage=Xe;class et extends He{create(e,t){const r=!!e.encoding_format;let n=r?e.encoding_format:"base64";r&&Fe("Request","User defined encoding_format:",e.encoding_format);const a=this._client.post("/embeddings",{body:{...e,encoding_format:n},...t});return r?a:(Fe("response","Decoding base64 embeddings to float32 array"),a._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{const t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){const t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{const t=atob(e),r=t.length,n=new Uint8Array(r);for(let e=0;e<r;e++)n[e]=t.charCodeAt(e);return Array.from(new Float32Array(n.buffer))}})(t)}),e)))}}class tt extends He{create(e,t){return this._client.post("/files",pe({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/files",rt,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=18e5}={}){const n=new Set(["processed","error","deleted"]),a=Date.now();let s=await this.retrieve(e);for(;!s.status||!n.has(s.status);)if(await Re(t),s=await this.retrieve(e),Date.now()-a>r)throw new D({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return s}}class rt extends Ke{}tt.FileObjectsPage=rt;class nt extends He{createVariation(e,t){return this._client.post("/images/variations",pe({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",pe({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class at extends He{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class st extends He{create(e,t){return this._client.post("/audio/transcriptions",pe({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class it extends He{create(e,t){return this._client.post("/audio/translations",pe({body:e,...t,__metadata:{model:e.model}}))}}class ot extends He{constructor(){super(...arguments),this.transcriptions=new st(this._client),this.translations=new it(this._client),this.speech=new at(this._client)}}ot.Transcriptions=st,ot.Translations=it,ot.Speech=at;class ct extends He{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class lt extends He{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",ut,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class ut extends We{}lt.ModelsPage=ut;class dt extends He{}class ht extends He{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class pt extends He{constructor(){super(...arguments),this.graders=new ht(this._client)}}pt.Graders=ht;class ft extends He{create(e,t,r){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,mt,{body:t,method:"post",...r})}retrieve(e,t={},r){return xe(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}del(e,t,r){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,r)}}class mt extends We{}ft.PermissionCreateResponsesPage=mt;class gt extends He{constructor(){super(...arguments),this.permissions=new ft(this._client)}}gt.Permissions=ft,gt.PermissionCreateResponsesPage=mt;class yt extends He{list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,_t,{query:t,...r})}}class _t extends Ke{}yt.FineTuningJobCheckpointsPage=_t;class bt extends He{constructor(){super(...arguments),this.checkpoints=new yt(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",wt,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return xe(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,vt,{query:t,...r})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class wt extends Ke{}class vt extends Ke{}bt.FineTuningJobsPage=wt,bt.FineTuningJobEventsPage=vt,bt.Checkpoints=yt,bt.FineTuningJobCheckpointsPage=_t;class Ot extends He{constructor(){super(...arguments),this.methods=new dt(this._client),this.jobs=new bt(this._client),this.checkpoints=new gt(this._client),this.alpha=new pt(this._client)}}Ot.Methods=dt,Ot.Jobs=bt,Ot.FineTuningJobsPage=wt,Ot.FineTuningJobEventsPage=vt,Ot.Checkpoints=gt,Ot.Alpha=pt;class Et extends He{}class kt extends He{constructor(){super(...arguments),this.graderModels=new Et(this._client)}}kt.GraderModels=Et;class xt extends He{create(e,t,r){return this._client.post(`/vector_stores/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,St,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){const n=await this.create(e,t,r);return await this.poll(e,n.id,r)}async poll(e,t,r){const n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const a=await this.retrieve(e,t,{...r,headers:n}).withResponse(),s=a.data;switch(s.status){case"in_progress":let e=5e3;if(r?.pollIntervalMs)e=r.pollIntervalMs;else{const t=a.response.headers.get("openai-poll-after-ms");if(t){const r=parseInt(t);isNaN(r)||(e=r)}}await Re(e);break;case"failed":case"completed":return s}}}async upload(e,t,r){const n=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:n.id},r)}async uploadAndPoll(e,t,r){const n=await this.upload(e,t,r);return await this.poll(e,n.id,r)}content(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,At,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class St extends Ke{}class At extends We{}xt.VectorStoreFilesPage=St,xt.FileContentResponsesPage=At;class It extends He{create(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){const n=await this.create(e,t);return await this.poll(e,n.id,r)}listFiles(e,t,r={},n){return xe(r)?this.listFiles(e,t,{},r):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,St,{query:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async poll(e,t,r){const n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:s}=await this.retrieve(e,t,{...r,headers:n}).withResponse();switch(a.status){case"in_progress":let e=5e3;if(r?.pollIntervalMs)e=r.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const r=parseInt(t);isNaN(r)||(e=r)}}await Re(e);break;case"failed":case"cancelled":case"completed":return a}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},n){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const a=n?.maxConcurrency??5,s=Math.min(a,t.length),i=this._client,o=t.values(),c=[...r],l=Array(s).fill(o).map(async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},n);c.push(e.id)}});return await(async e=>{const t=await Promise.allSettled(e),r=t.filter(e=>"rejected"===e.status);if(r.length){for(const e of r)console.error(e.reason);throw new Error(`${r.length} promise(s) failed - see the above errors`)}const n=[];for(const e of t)"fulfilled"===e.status&&n.push(e.value);return n})(l),await this.createAndPoll(e,{file_ids:c})}}class Pt extends He{constructor(){super(...arguments),this.files=new xt(this._client),this.fileBatches=new It(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/vector_stores/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/vector_stores",$t,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,r){return this._client.getAPIList(`/vector_stores/${e}/search`,Tt,{body:t,method:"post",...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class $t extends Ke{}class Tt extends We{}Pt.VectorStoresPage=$t,Pt.VectorStoreSearchResponsesPage=Tt,Pt.Files=xt,Pt.VectorStoreFilesPage=St,Pt.FileContentResponsesPage=At,Pt.FileBatches=It;class jt extends He{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/assistants",Rt,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Rt extends Ke{}function Nt(e){return"function"==typeof e.parse}jt.AssistantsPage=Rt;const Ct=e=>"assistant"===e?.role,Lt=e=>"function"===e?.role,Mt=e=>"tool"===e?.role;var zt,Ut,Dt,Ft,Bt,Zt,qt,Ht,Jt,Gt,Wt,Kt,Vt,Xt=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r},Yt=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class Qt{constructor(){zt.add(this),this.controller=new AbortController,Ut.set(this,void 0),Dt.set(this,()=>{}),Ft.set(this,()=>{}),Bt.set(this,void 0),Zt.set(this,()=>{}),qt.set(this,()=>{}),Ht.set(this,{}),Jt.set(this,!1),Gt.set(this,!1),Wt.set(this,!1),Kt.set(this,!1),Xt(this,Ut,new Promise((e,t)=>{Xt(this,Dt,e,"f"),Xt(this,Ft,t,"f")}),"f"),Xt(this,Bt,new Promise((e,t)=>{Xt(this,Zt,e,"f"),Xt(this,qt,t,"f")}),"f"),Yt(this,Ut,"f").catch(()=>{}),Yt(this,Bt,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},Yt(this,zt,"m",Vt).bind(this))},0)}_connected(){this.ended||(Yt(this,Dt,"f").call(this),this._emit("connect"))}get ended(){return Yt(this,Jt,"f")}get errored(){return Yt(this,Gt,"f")}get aborted(){return Yt(this,Wt,"f")}abort(){this.controller.abort()}on(e,t){return(Yt(this,Ht,"f")[e]||(Yt(this,Ht,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=Yt(this,Ht,"f")[e];if(!r)return this;const n=r.findIndex(e=>e.listener===t);return n>=0&&r.splice(n,1),this}once(e,t){return(Yt(this,Ht,"f")[e]||(Yt(this,Ht,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{Xt(this,Kt,!0,"f"),"error"!==e&&this.once("error",r),this.once(e,t)})}async done(){Xt(this,Kt,!0,"f"),await Yt(this,Bt,"f")}_emit(e,...t){if(Yt(this,Jt,"f"))return;"end"===e&&(Xt(this,Jt,!0,"f"),Yt(this,Zt,"f").call(this));const r=Yt(this,Ht,"f")[e];if(r&&(Yt(this,Ht,"f")[e]=r.filter(e=>!e.once),r.forEach(({listener:e})=>e(...t))),"abort"===e){const e=t[0];return Yt(this,Kt,"f")||r?.length||Promise.reject(e),Yt(this,Ft,"f").call(this,e),Yt(this,qt,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Yt(this,Kt,"f")||r?.length||Promise.reject(e),Yt(this,Ft,"f").call(this,e),Yt(this,qt,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function er(e){return"auto-parseable-response-format"===e?.$brand}function tr(e){return"auto-parseable-tool"===e?.$brand}function rr(e,t){const r=e.choices.map(e=>{if("length"===e.finish_reason)throw new K;if("content_filter"===e.finish_reason)throw new V;return{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>function(e,t){const r=e.tools?.find(e=>e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:tr(r)?r.$parseRaw(t.function.arguments):r?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?nr(t,e.message.content):null}}});return{...e,choices:r}}function nr(e,t){return"json_schema"!==e.response_format?.type?null:"json_schema"===e.response_format?.type?"$parseRaw"in e.response_format?e.response_format.$parseRaw(t):JSON.parse(t):null}function ar(e,t){if(!e)return!1;const r=e.tools?.find(e=>e.function?.name===t.function.name);return tr(r)||r?.function.strict||!1}function sr(e){return!!er(e.response_format)||(e.tools?.some(e=>tr(e)||"function"===e.type&&!0===e.function.strict)??!1)}Ut=new WeakMap,Dt=new WeakMap,Ft=new WeakMap,Bt=new WeakMap,Zt=new WeakMap,qt=new WeakMap,Ht=new WeakMap,Jt=new WeakMap,Gt=new WeakMap,Wt=new WeakMap,Kt=new WeakMap,zt=new WeakSet,Vt=function(e){if(Xt(this,Gt,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new z),e instanceof z)return Xt(this,Wt,!0,"f"),this._emit("abort",e);if(e instanceof L)return this._emit("error",e);if(e instanceof Error){const t=new L(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new L(String(e)))};var ir,or,cr,lr,ur,dr,hr,pr,fr=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};const mr=10;class gr extends Qt{constructor(){super(...arguments),ir.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(Lt(e)||Mt(e))&&e.content)this._emit("functionCallResult",e.content);else if(Ct(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Ct(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new L("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),fr(this,ir,"m",or).call(this)}async finalMessage(){return await this.done(),fr(this,ir,"m",cr).call(this)}async finalFunctionCall(){return await this.done(),fr(this,ir,"m",lr).call(this)}async finalFunctionCallResult(){return await this.done(),fr(this,ir,"m",ur).call(this)}async totalUsage(){return await this.done(),fr(this,ir,"m",dr).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=fr(this,ir,"m",cr).call(this);t&&this._emit("finalMessage",t);const r=fr(this,ir,"m",or).call(this);r&&this._emit("finalContent",r);const n=fr(this,ir,"m",lr).call(this);n&&this._emit("finalFunctionCall",n);const a=fr(this,ir,"m",ur).call(this);null!=a&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",fr(this,ir,"m",dr).call(this))}async _createChatCompletion(e,t,r){const n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),fr(this,ir,"m",hr).call(this,t);const a=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(rr(a,t))}async _runChatCompletion(e,t,r){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){const n="function",{function_call:a="auto",stream:s,...i}=t,o="string"!=typeof a&&a?.name,{maxChatCompletions:c=mr}=r||{},l={};for(const e of t.functions)l[e.name||e.function.name]=e;const u=t.functions.map(e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description}));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...i,function_call:a,functions:u,messages:[...this.messages]},r),s=t.choices[0]?.message;if(!s)throw new L("missing message in ChatCompletion response");if(!s.function_call)return;const{name:c,arguments:d}=s.function_call,h=l[c];if(!h){const e=`Invalid function_call: ${JSON.stringify(c)}. Available options are: ${u.map(e=>JSON.stringify(e.name)).join(", ")}. Please try again`;this._addMessage({role:n,name:c,content:e});continue}if(o&&o!==c){const e=`Invalid function_call: ${JSON.stringify(c)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:n,name:c,content:e});continue}let p;try{p=Nt(h)?await h.parse(d):d}catch(e){this._addMessage({role:n,name:c,content:e instanceof Error?e.message:String(e)});continue}const f=await h.function(p,this),m=fr(this,ir,"m",pr).call(this,f);if(this._addMessage({role:n,name:c,content:m}),o)return}}async _runTools(e,t,r){const n="tool",{tool_choice:a="auto",stream:s,...i}=t,o="string"!=typeof a&&a?.function?.name,{maxChatCompletions:c=mr}=r||{},l=t.tools.map(e=>{if(tr(e)){if(!e.$callback)throw new L("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),u={};for(const e of l)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const d="tools"in t?l.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<c;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:a,tools:d,messages:[...this.messages]},r),s=t.choices[0]?.message;if(!s)throw new L("missing message in ChatCompletion response");if(!s.tool_calls?.length)return;for(const e of s.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:r,arguments:a}=e.function,s=u[r];if(!s){const e=`Invalid tool_call: ${JSON.stringify(r)}. Available options are: ${Object.keys(u).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:n,tool_call_id:t,content:e});continue}if(o&&o!==r){const e=`Invalid tool_call: ${JSON.stringify(r)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:n,tool_call_id:t,content:e});continue}let i;try{i=Nt(s)?await s.parse(a):a}catch(e){const r=e instanceof Error?e.message:String(e);this._addMessage({role:n,tool_call_id:t,content:r});continue}const c=await s.function(i,this),l=fr(this,ir,"m",pr).call(this,c);if(this._addMessage({role:n,tool_call_id:t,content:l}),o)return}}}}ir=new WeakSet,or=function(){return fr(this,ir,"m",cr).call(this).content??null},cr=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Ct(t)){const{function_call:e,...r}=t,n={...r,content:t.content??null,refusal:t.refusal??null};return e&&(n.function_call=e),n}}throw new L("stream ended without producing a ChatCompletionMessage with role=assistant")},lr=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Ct(t)&&t?.function_call)return t.function_call;if(Ct(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},ur=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Lt(t)&&null!=t.content)return t.content;if(Mt(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},dr=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},hr=function(e){if(null!=e.n&&e.n>1)throw new L("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},pr=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class yr extends gr{static runFunctions(e,t,r){const n=new yr,a={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return n._run(()=>n._runFunctions(e,t,a)),n}static runTools(e,t,r){const n=new yr,a={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,a)),n}_addMessage(e,t=!0){super._addMessage(e,t),Ct(e)&&e.content&&this._emit("content",e.content)}}class _r extends Error{}class br extends Error{}const wr=e=>function(e,t=511){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return((e,t)=>{const r=e.length;let n=0;const a=e=>{throw new _r(`${e} at position ${n}`)},s=e=>{throw new br(`${e} at position ${n}`)},i=()=>(d(),n>=r&&a("Unexpected end of input"),'"'===e[n]?o():"{"===e[n]?c():"["===e[n]?l():"null"===e.substring(n,n+4)||16&t&&r-n<4&&"null".startsWith(e.substring(n))?(n+=4,null):"true"===e.substring(n,n+4)||32&t&&r-n<4&&"true".startsWith(e.substring(n))?(n+=4,!0):"false"===e.substring(n,n+5)||32&t&&r-n<5&&"false".startsWith(e.substring(n))?(n+=5,!1):"Infinity"===e.substring(n,n+8)||128&t&&r-n<8&&"Infinity".startsWith(e.substring(n))?(n+=8,1/0):"-Infinity"===e.substring(n,n+9)||256&t&&1<r-n&&r-n<9&&"-Infinity".startsWith(e.substring(n))?(n+=9,-1/0):"NaN"===e.substring(n,n+3)||64&t&&r-n<3&&"NaN".startsWith(e.substring(n))?(n+=3,NaN):u()),o=()=>{const i=n;let o=!1;for(n++;n<r&&('"'!==e[n]||o&&"\\"===e[n-1]);)o="\\"===e[n]&&!o,n++;if('"'==e.charAt(n))try{return JSON.parse(e.substring(i,++n-Number(o)))}catch(e){s(String(e))}else if(1&t)try{return JSON.parse(e.substring(i,n-Number(o))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}a("Unterminated string literal")},c=()=>{n++,d();const s={};try{for(;"}"!==e[n];){if(d(),n>=r&&8&t)return s;const a=o();d(),n++;try{const e=i();Object.defineProperty(s,a,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return s;throw e}d(),","===e[n]&&n++}}catch(e){if(8&t)return s;a("Expected '}' at end of object")}return n++,s},l=()=>{n++;const r=[];try{for(;"]"!==e[n];)r.push(i()),d(),","===e[n]&&n++}catch(e){if(4&t)return r;a("Expected ']' at end of array")}return n++,r},u=()=>{if(0===n){"-"===e&&2&t&&a("Not sure what '-' is");try{return JSON.parse(e)}catch(r){if(2&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}s(String(r))}}const i=n;for("-"===e[n]&&n++;e[n]&&!",]}".includes(e[n]);)n++;n!=r||2&t||a("Unterminated number literal");try{return JSON.parse(e.substring(i,n))}catch(r){"-"===e.substring(i,n)&&2&t&&a("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){s(String(e))}}},d=()=>{for(;n<r&&" \n\r\t".includes(e[n]);)n++};return i()})(e.trim(),t)}(e,509);var vr,Or,Er,kr,xr,Sr,Ar,Ir,Pr,$r,Tr,jr,Rr=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r},Nr=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class Cr extends gr{constructor(e){super(),vr.add(this),Or.set(this,void 0),Er.set(this,void 0),kr.set(this,void 0),Rr(this,Or,e,"f"),Rr(this,Er,[],"f")}get currentChatCompletionSnapshot(){return Nr(this,kr,"f")}static fromReadableStream(e){const t=new Cr(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const n=new Cr(t);return n._run(()=>n._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createChatCompletion(e,t,r){super._createChatCompletion;const n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),Nr(this,vr,"m",xr).call(this);const a=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const e of a)Nr(this,vr,"m",Ar).call(this,e);if(a.controller.signal?.aborted)throw new z;return this._addChatCompletion(Nr(this,vr,"m",$r).call(this))}async _fromReadableStream(e,t){const r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Nr(this,vr,"m",xr).call(this),this._connected();const n=ae.fromReadableStream(e,this.controller);let a;for await(const e of n)a&&a!==e.id&&this._addChatCompletion(Nr(this,vr,"m",$r).call(this)),Nr(this,vr,"m",Ar).call(this,e),a=e.id;if(n.controller.signal?.aborted)throw new z;return this._addChatCompletion(Nr(this,vr,"m",$r).call(this))}[(Or=new WeakMap,Er=new WeakMap,kr=new WeakMap,vr=new WeakSet,xr=function(){this.ended||Rr(this,kr,void 0,"f")},Sr=function(e){let t=Nr(this,Er,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Nr(this,Er,"f")[e.index]=t,t)},Ar=function(e){if(this.ended)return;const t=Nr(this,vr,"m",jr).call(this,e);this._emit("chunk",e,t);for(const r of e.choices){const e=t.choices[r.index];null!=r.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",r.delta.content,e.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=r.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:e.message.refusal}),null!=r.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=r.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const n=Nr(this,vr,"m",Sr).call(this,e);e.finish_reason&&(Nr(this,vr,"m",Pr).call(this,e),null!=n.current_tool_call_index&&Nr(this,vr,"m",Ir).call(this,e,n.current_tool_call_index));for(const t of r.delta.tool_calls??[])n.current_tool_call_index!==t.index&&(Nr(this,vr,"m",Pr).call(this,e),null!=n.current_tool_call_index&&Nr(this,vr,"m",Ir).call(this,e,n.current_tool_call_index)),n.current_tool_call_index=t.index;for(const t of r.delta.tool_calls??[]){const r=e.message.tool_calls?.[t.index];r?.type&&("function"===r?.type?this._emit("tool_calls.function.arguments.delta",{name:r.function?.name,index:t.index,arguments:r.function.arguments,parsed_arguments:r.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):zr())}}},Ir=function(e,t){if(Nr(this,vr,"m",Sr).call(this,e).done_tool_calls.has(t))return;const r=e.message.tool_calls?.[t];if(!r)throw new Error("no tool call snapshot");if(!r.type)throw new Error("tool call snapshot missing `type`");if("function"===r.type){const e=Nr(this,Or,"f")?.tools?.find(e=>"function"===e.type&&e.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:t,arguments:r.function.arguments,parsed_arguments:tr(e)?e.$parseRaw(r.function.arguments):e?.function.strict?JSON.parse(r.function.arguments):null})}else r.type},Pr=function(e){const t=Nr(this,vr,"m",Sr).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const r=Nr(this,vr,"m",Tr).call(this);this._emit("content.done",{content:e.message.content,parsed:r?r.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},$r=function(){if(this.ended)throw new L("stream has ended, this shouldn't happen");const e=Nr(this,kr,"f");if(!e)throw new L("request ended without sending any chunks");return Rr(this,kr,void 0,"f"),Rr(this,Er,[],"f"),function(e,t){const{id:r,choices:n,created:a,model:s,system_fingerprint:i,...o}=e,c={...o,id:r,choices:n.map(({message:t,finish_reason:r,index:n,logprobs:a,...s})=>{if(!r)throw new L(`missing finish_reason for choice ${n}`);const{content:i=null,function_call:o,tool_calls:c,...l}=t,u=t.role;if(!u)throw new L(`missing role for choice ${n}`);if(o){const{arguments:e,name:c}=o;if(null==e)throw new L(`missing function_call.arguments for choice ${n}`);if(!c)throw new L(`missing function_call.name for choice ${n}`);return{...s,message:{content:i,function_call:{arguments:e,name:c},role:u,refusal:t.refusal??null},finish_reason:r,index:n,logprobs:a}}return c?{...s,index:n,finish_reason:r,logprobs:a,message:{...l,role:u,content:i,refusal:t.refusal??null,tool_calls:c.map((t,r)=>{const{function:a,type:s,id:i,...o}=t,{arguments:c,name:l,...u}=a||{};if(null==i)throw new L(`missing choices[${n}].tool_calls[${r}].id\n${Lr(e)}`);if(null==s)throw new L(`missing choices[${n}].tool_calls[${r}].type\n${Lr(e)}`);if(null==l)throw new L(`missing choices[${n}].tool_calls[${r}].function.name\n${Lr(e)}`);if(null==c)throw new L(`missing choices[${n}].tool_calls[${r}].function.arguments\n${Lr(e)}`);return{...o,id:i,type:s,function:{...u,name:l,arguments:c}}})}}:{...s,message:{...l,content:i,role:u,refusal:t.refusal??null},finish_reason:r,index:n,logprobs:a}}),created:a,model:s,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&sr(t)?rr(e,t):{...e,choices:e.choices.map(e=>({...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(c,t)}(e,Nr(this,Or,"f"))},Tr=function(){const e=Nr(this,Or,"f")?.response_format;return er(e)?e:null},jr=function(e){var t,r,n,a;let s=Nr(this,kr,"f");const{choices:i,...o}=e;s?Object.assign(s,o):s=Rr(this,kr,{...o,choices:[]},"f");for(const{delta:i,finish_reason:o,index:c,logprobs:l=null,...u}of e.choices){let e=s.choices[c];if(e||(e=s.choices[c]={finish_reason:o,index:c,message:{},logprobs:l,...u}),l)if(e.logprobs){const{content:n,refusal:a,...s}=l;Mr(),Object.assign(e.logprobs,s),n&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...n)),a&&((r=e.logprobs).refusal??(r.refusal=[]),e.logprobs.refusal.push(...a))}else e.logprobs=Object.assign({},l);if(o&&(e.finish_reason=o,Nr(this,Or,"f")&&sr(Nr(this,Or,"f")))){if("length"===o)throw new K;if("content_filter"===o)throw new V}if(Object.assign(e,u),!i)continue;const{content:d,refusal:h,function_call:p,role:f,tool_calls:m,...g}=i;if(Mr(),Object.assign(e.message,g),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((n=e.message.function_call).arguments??(n.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&Nr(this,vr,"m",Tr).call(this)&&(e.message.parsed=wr(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:r,type:n,function:s,...i}of m){const o=(a=e.message.tool_calls)[t]??(a[t]={});Object.assign(o,i),r&&(o.id=r),n&&(o.type=n),s&&(o.function??(o.function={name:s.name??"",arguments:""})),s?.name&&(o.function.name=s.name),s?.arguments&&(o.function.arguments+=s.arguments,ar(Nr(this,Or,"f"),o)&&(o.function.parsed_arguments=wr(o.function.arguments)))}}}return s},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",r=>{const n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{r=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),this.on("error",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ae(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Lr(e){return JSON.stringify(e)}function Mr(e){}function zr(_x){}class Ur extends Cr{static fromReadableStream(e){const t=new Ur(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){const n=new Ur(null),a={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return n._run(()=>n._runFunctions(e,t,a)),n}static runTools(e,t,r){const n=new Ur(t),a={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return n._run(()=>n._runTools(e,t,a)),n}}class Dr extends He{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new L(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new L(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(t=>rr(t,e))}runFunctions(e,t){return e.stream?Ur.runFunctions(this._client,e,t):yr.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Ur.runTools(this._client,e,t):yr.runTools(this._client,e,t)}stream(e,t){return Cr.createChatCompletion(this._client,e,t)}}class Fr extends He{constructor(){super(...arguments),this.completions=new Dr(this._client)}}!function(e){e.Completions=Dr}(Fr||(Fr={}));class Br extends He{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Zr extends He{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class qr extends He{constructor(){super(...arguments),this.sessions=new Br(this._client),this.transcriptionSessions=new Zr(this._client)}}qr.Sessions=Br,qr.TranscriptionSessions=Zr;var Hr,Jr,Gr,Wr,Kr,Vr,Xr,Yr,Qr,en,tn,rn,nn,an,sn,on,cn,ln,un,dn,hn,pn,fn=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)},mn=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r};class gn extends Qt{constructor(){super(...arguments),Hr.add(this),Jr.set(this,[]),Gr.set(this,{}),Wr.set(this,{}),Kr.set(this,void 0),Vr.set(this,void 0),Xr.set(this,void 0),Yr.set(this,void 0),Qr.set(this,void 0),en.set(this,void 0),tn.set(this,void 0),rn.set(this,void 0),nn.set(this,void 0)}[(Jr=new WeakMap,Gr=new WeakMap,Wr=new WeakMap,Kr=new WeakMap,Vr=new WeakMap,Xr=new WeakMap,Yr=new WeakMap,Qr=new WeakMap,en=new WeakMap,tn=new WeakMap,rn=new WeakMap,nn=new WeakMap,Hr=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",r=>{const n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{r=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),this.on("error",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new gn;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();const n=ae.fromReadableStream(e,this.controller);for await(const e of n)fn(this,Hr,"m",an).call(this,e);if(n.controller.signal?.aborted)throw new z;return this._addRun(fn(this,Hr,"m",sn).call(this))}toReadableStream(){return new ae(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,n,a){const s=new gn;return s._run(()=>s._runToolAssistantStream(e,t,r,n,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createToolAssistantStream(e,t,r,n,a){const s=a?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));const i={...n,stream:!0},o=await e.submitToolOutputs(t,r,i,{...a,signal:this.controller.signal});this._connected();for await(const e of o)fn(this,Hr,"m",an).call(this,e);if(o.controller.signal?.aborted)throw new z;return this._addRun(fn(this,Hr,"m",sn).call(this))}static createThreadAssistantStream(e,t,r){const n=new gn;return n._run(()=>n._threadAssistantStream(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}static createAssistantStream(e,t,r,n){const a=new gn;return a._run(()=>a._runAssistantStream(e,t,r,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return fn(this,tn,"f")}currentRun(){return fn(this,rn,"f")}currentMessageSnapshot(){return fn(this,Kr,"f")}currentRunStepSnapshot(){return fn(this,nn,"f")}async finalRunSteps(){return await this.done(),Object.values(fn(this,Gr,"f"))}async finalMessages(){return await this.done(),Object.values(fn(this,Wr,"f"))}async finalRun(){if(await this.done(),!fn(this,Vr,"f"))throw Error("Final run was not received.");return fn(this,Vr,"f")}async _createThreadAssistantStream(e,t,r){const n=r?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort()));const a={...t,stream:!0},s=await e.createAndRun(a,{...r,signal:this.controller.signal});this._connected();for await(const e of s)fn(this,Hr,"m",an).call(this,e);if(s.controller.signal?.aborted)throw new z;return this._addRun(fn(this,Hr,"m",sn).call(this))}async _createAssistantStream(e,t,r,n){const a=n?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const s={...r,stream:!0},i=await e.create(t,s,{...n,signal:this.controller.signal});this._connected();for await(const e of i)fn(this,Hr,"m",an).call(this,e);if(i.controller.signal?.aborted)throw new z;return this._addRun(fn(this,Hr,"m",sn).call(this))}static accumulateDelta(e,t){for(const[r,n]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=n;continue}let t=e[r];if(null!=t)if("index"!==r&&"type"!==r){if("string"==typeof t&&"string"==typeof n)t+=n;else if("number"==typeof t&&"number"==typeof n)t+=n;else{if(!qe(t)||!qe(n)){if(Array.isArray(t)&&Array.isArray(n)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...n);continue}for(const e of n){if(!qe(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const r=e.index;if(null==r)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof r)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${r}`);const n=t[r];null==n?t.push(e):t[r]=this.accumulateDelta(n,e)}continue}throw Error(`Unhandled record type: ${r}, deltaValue: ${n}, accValue: ${t}`)}t=this.accumulateDelta(t,n)}e[r]=t}else e[r]=n;else e[r]=n}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,n){return await this._createAssistantStream(t,e,r,n)}async _runToolAssistantStream(e,t,r,n,a){return await this._createToolAssistantStream(r,e,t,n,a)}}an=function(e){if(!this.ended)switch(mn(this,tn,e,"f"),fn(this,Hr,"m",ln).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":fn(this,Hr,"m",pn).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":fn(this,Hr,"m",cn).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":fn(this,Hr,"m",on).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},sn=function(){if(this.ended)throw new L("stream has ended, this shouldn't happen");if(!fn(this,Vr,"f"))throw Error("Final run has not been received");return fn(this,Vr,"f")},on=function(e){const[t,r]=fn(this,Hr,"m",dn).call(this,e,fn(this,Kr,"f"));mn(this,Kr,t,"f"),fn(this,Wr,"f")[t.id]=t;for(const e of r){const r=t.content[e.index];"text"==r?.type&&this._emit("textCreated",r.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const r of e.data.delta.content){if("text"==r.type&&r.text){let e=r.text,n=t.content[r.index];if(!n||"text"!=n.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,n.text)}if(r.index!=fn(this,Xr,"f")){if(fn(this,Yr,"f"))switch(fn(this,Yr,"f").type){case"text":this._emit("textDone",fn(this,Yr,"f").text,fn(this,Kr,"f"));break;case"image_file":this._emit("imageFileDone",fn(this,Yr,"f").image_file,fn(this,Kr,"f"))}mn(this,Xr,r.index,"f")}mn(this,Yr,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==fn(this,Xr,"f")){const t=e.data.content[fn(this,Xr,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,fn(this,Kr,"f"));break;case"text":this._emit("textDone",t.text,fn(this,Kr,"f"))}}fn(this,Kr,"f")&&this._emit("messageDone",e.data),mn(this,Kr,void 0,"f")}},cn=function(e){const t=fn(this,Hr,"m",un).call(this,e);switch(mn(this,nn,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const r=e.data.delta;if(r.step_details&&"tool_calls"==r.step_details.type&&r.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of r.step_details.tool_calls)e.index==fn(this,Qr,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(fn(this,en,"f")&&this._emit("toolCallDone",fn(this,en,"f")),mn(this,Qr,e.index,"f"),mn(this,en,t.step_details.tool_calls[e.index],"f"),fn(this,en,"f")&&this._emit("toolCallCreated",fn(this,en,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":mn(this,nn,void 0,"f"),"tool_calls"==e.data.step_details.type&&fn(this,en,"f")&&(this._emit("toolCallDone",fn(this,en,"f")),mn(this,en,void 0,"f")),this._emit("runStepDone",e.data,t)}},ln=function(e){fn(this,Jr,"f").push(e),this._emit("event",e)},un=function(e){switch(e.event){case"thread.run.step.created":return fn(this,Gr,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=fn(this,Gr,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){const n=gn.accumulateDelta(t,r.delta);fn(this,Gr,"f")[e.data.id]=n}return fn(this,Gr,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":fn(this,Gr,"f")[e.data.id]=e.data}if(fn(this,Gr,"f")[e.data.id])return fn(this,Gr,"f")[e.data.id];throw new Error("No snapshot available")},dn=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let n=e.data;if(n.delta.content)for(const e of n.delta.content)if(e.index in t.content){let r=t.content[e.index];t.content[e.index]=fn(this,Hr,"m",hn).call(this,e,r)}else t.content[e.index]=e,r.push(e);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},hn=function(e,t){return gn.accumulateDelta(t,e)},pn=function(e){switch(mn(this,rn,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.cancelling":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":mn(this,Vr,e.data,"f"),fn(this,en,"f")&&(this._emit("toolCallDone",fn(this,en,"f")),mn(this,en,void 0,"f"))}};class yn extends He{create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,bn,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t,r){return this._client.delete(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class bn extends Ke{}yn.MessagesPage=bn;class wn extends He{retrieve(e,t,r,n={},a){return xe(n)?this.retrieve(e,t,r,{},n):this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{query:n,...a,headers:{"OpenAI-Beta":"assistants=v2",...a?.headers}})}list(e,t,r={},n){return xe(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,vn,{query:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}}class vn extends Ke{}wn.RunStepsPage=vn;class On extends He{constructor(){super(...arguments),this.steps=new wn(this._client)}create(e,t,r){const{include:n,...a}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:n},body:a,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:t.stream??!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}update(e,t,r,n){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,En,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async createAndPoll(e,t,r){const n=await this.create(e,t,r);return await this.poll(e,n.id,r)}createAndStream(e,t,r){return gn.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){const n={...r?.headers,"X-Stainless-Poll-Helper":"true"};for(r?.pollIntervalMs&&(n["X-Stainless-Custom-Poll-Interval"]=r.pollIntervalMs.toString());;){const{data:a,response:s}=await this.retrieve(e,t,{...r,headers:{...r?.headers,...n}}).withResponse();switch(a.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(r?.pollIntervalMs)e=r.pollIntervalMs;else{const t=s.headers.get("openai-poll-after-ms");if(t){const r=parseInt(t);isNaN(r)||(e=r)}}await Re(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return a}}}stream(e,t,r){return gn.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,n){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:r.stream??!1})}async submitToolOutputsAndPoll(e,t,r,n){const a=await this.submitToolOutputs(e,t,r,n);return await this.poll(e,a.id,n)}submitToolOutputsStream(e,t,r,n){return gn.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,n)}}class En extends Ke{}On.RunsPage=En,On.Steps=wn,On.RunStepsPage=vn;class kn extends He{constructor(){super(...arguments),this.runs=new On(this._client),this.messages=new yn(this._client)}create(e={},t){return xe(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const r=await this.createAndRun(e,t);return await this.runs.poll(r.thread_id,r.id,t)}createAndRunStream(e,t){return gn.createThreadAssistantStream(e,this._client.beta.threads,t)}}kn.Runs=On,kn.RunsPage=En,kn.Messages=yn,kn.MessagesPage=bn;class xn extends He{constructor(){super(...arguments),this.realtime=new qr(this._client),this.chat=new Fr(this._client),this.assistants=new jt(this._client),this.threads=new kn(this._client)}}xn.Realtime=qr,xn.Assistants=jt,xn.AssistantsPage=Rt,xn.Threads=kn;class Sn extends He{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/batches",An,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class An extends Ke{}Sn.BatchesPage=An;class In extends He{create(e,t,r){return this._client.post(`/uploads/${e}/parts`,pe({body:t,...r}))}}class Pn extends He{constructor(){super(...arguments),this.parts=new In(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(`/uploads/${e}/complete`,{body:t,...r})}}function $n(e,t){const r=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:jn(t,e)};if("message"===e.type){const r=e.content.map(e=>"output_text"===e.type?{...e,parsed:Tn(t,e.text)}:e);return{...e,content:r}}return e}),n=Object.assign({},e,{output:r});return Object.getOwnPropertyDescriptor(e,"output_text")||Rn(n),Object.defineProperty(n,"output_parsed",{enumerable:!0,get(){for(const e of n.output)if("message"===e.type)for(const t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed;return null}}),n}function Tn(e,t){if("json_schema"!==e.text?.format?.type)return null;if("$parseRaw"in e.text?.format){const r=e.text?.format;return r.$parseRaw(t)}return JSON.parse(t)}function jn(e,t){const r=(n=e.tools??[],a=t.name,n.find(e=>"function"===e.type&&e.name===a));var n,a,s;return{...t,...t,parsed_arguments:(s=r,"auto-parseable-tool"===s?.$brand?r.$parseRaw(t.arguments):r?.strict?JSON.parse(t.arguments):null)}}function Rn(e){const t=[];for(const r of e.output)if("message"===r.type)for(const e of r.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}Pn.Parts=In;class Nn extends He{list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Wn,{query:t,...r})}}var Cn,Ln,Mn,zn,Un,Dn,Fn,Bn,Zn,qn=function(e,t,r,n,a){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!a)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?a.call(e,r):a?a.value=r:t.set(e,r),r},Hn=function(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)};class Jn extends Qt{constructor(e){super(),Cn.add(this),Ln.set(this,void 0),Mn.set(this,void 0),zn.set(this,void 0),qn(this,Ln,e,"f")}static createResponse(e,t,r){const n=new Jn(t);return n._run(()=>n._createOrRetrieveResponse(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),n}async _createOrRetrieveResponse(e,t,r){const n=r?.signal;let a;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",()=>this.controller.abort())),Hn(this,Cn,"m",Un).call(this);let s=null;"response_id"in t?(a=await e.responses.retrieve(t.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),s=t.starting_after??null):a=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal}),this._connected();for await(const e of a)Hn(this,Cn,"m",Dn).call(this,e,s);if(a.controller.signal?.aborted)throw new z;return Hn(this,Cn,"m",Fn).call(this)}[(Ln=new WeakMap,Mn=new WeakMap,zn=new WeakMap,Cn=new WeakSet,Un=function(){this.ended||qn(this,Mn,void 0,"f")},Dn=function(e,t){if(this.ended)return;const r=(e,r)=>{(null==t||r.sequence_number>t)&&this._emit(e,r)},n=Hn(this,Cn,"m",Bn).call(this,e);switch(r("event",e),e.type){case"response.output_text.delta":{const t=n.output[e.output_index];if(!t)throw new L(`missing output at index ${e.output_index}`);if("message"===t.type){const n=t.content[e.content_index];if(!n)throw new L(`missing content at index ${e.content_index}`);if("output_text"!==n.type)throw new L(`expected content to be 'output_text', got ${n.type}`);r("response.output_text.delta",{...e,snapshot:n.text})}break}case"response.function_call_arguments.delta":{const t=n.output[e.output_index];if(!t)throw new L(`missing output at index ${e.output_index}`);"function_call"===t.type&&r("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:r(e.type,e)}},Fn=function(){if(this.ended)throw new L("stream has ended, this shouldn't happen");const e=Hn(this,Mn,"f");if(!e)throw new L("request ended without sending any events");qn(this,Mn,void 0,"f");const t=function(e,t){return function(e,t){return t&&function(e){return!!er(e.text?.format)}(t)?$n(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,t)}(e,Hn(this,Ln,"f"));return qn(this,zn,t,"f"),t},Bn=function(e){let t=Hn(this,Mn,"f");if(!t){if("response.created"!==e.type)throw new L(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return t=qn(this,Mn,e.response,"f"),t}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{const r=t.output[e.output_index];if(!r)throw new L(`missing output at index ${e.output_index}`);"message"===r.type&&r.content.push(e.part);break}case"response.output_text.delta":{const r=t.output[e.output_index];if(!r)throw new L(`missing output at index ${e.output_index}`);if("message"===r.type){const t=r.content[e.content_index];if(!t)throw new L(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new L(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{const r=t.output[e.output_index];if(!r)throw new L(`missing output at index ${e.output_index}`);"function_call"===r.type&&(r.arguments+=e.delta);break}case"response.completed":qn(this,Mn,e.response,"f")}return t},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("event",r=>{const n=t.shift();n?n.resolve(r):e.push(r)}),this.on("end",()=>{r=!0;for(const e of t)e.resolve(void 0);t.length=0}),this.on("abort",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),this.on("error",e=>{r=!0;for(const r of t)r.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=Hn(this,zn,"f");if(!e)throw new L("stream ended without producing a ChatCompletion");return e}}class Gn extends He{constructor(){super(...arguments),this.inputItems=new Nn(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&Rn(e),e))}retrieve(e,t={},r){return this._client.get(`/responses/${e}`,{query:t,...r,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>$n(t,e))}stream(e,t){return Jn.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class Wn extends Ke{}Gn.InputItems=Nn;class Kn extends He{retrieve(e,t,r,n){return this._client.get(`/evals/${e}/runs/${t}/output_items/${r}`,n)}list(e,t,r={},n){return xe(r)?this.list(e,t,{},r):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Vn,{query:r,...n})}}class Vn extends Ke{}Kn.OutputItemListResponsesPage=Vn;class Xn extends He{constructor(){super(...arguments),this.outputItems=new Kn(this._client)}create(e,t,r){return this._client.post(`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){return this._client.get(`/evals/${e}/runs/${t}`,r)}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,Yn,{query:t,...r})}del(e,t,r){return this._client.delete(`/evals/${e}/runs/${t}`,r)}cancel(e,t,r){return this._client.post(`/evals/${e}/runs/${t}`,r)}}class Yn extends Ke{}Xn.RunListResponsesPage=Yn,Xn.OutputItems=Kn,Xn.OutputItemListResponsesPage=Vn;class Qn extends He{constructor(){super(...arguments),this.runs=new Xn(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,r){return this._client.post(`/evals/${e}`,{body:t,...r})}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/evals",ea,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class ea extends Ke{}Qn.EvalListResponsesPage=ea,Qn.Runs=Xn,Qn.RunListResponsesPage=Yn;class ta extends He{retrieve(e,t,r){return this._client.get(`/containers/${e}/files/${t}/content`,{...r,headers:{Accept:"application/binary",...r?.headers},__binaryResponse:!0})}}class ra extends He{constructor(){super(...arguments),this.content=new ta(this._client)}create(e,t,r){return this._client.post(`/containers/${e}/files`,pe({body:t,...r}))}retrieve(e,t,r){return this._client.get(`/containers/${e}/files/${t}`,r)}list(e,t={},r){return xe(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,na,{query:t,...r})}del(e,t,r){return this._client.delete(`/containers/${e}/files/${t}`,{...r,headers:{Accept:"*/*",...r?.headers}})}}class na extends Ke{}ra.FileListResponsesPage=na,ra.Content=ta;class aa extends He{constructor(){super(...arguments),this.files=new ra(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return xe(e)?this.list({},e):this._client.getAPIList("/containers",sa,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class sa extends Ke{}aa.ContainerListResponsesPage=sa,aa.Files=ra,aa.FileListResponsesPage=na;class ia extends we{constructor({baseURL:e=Le("OPENAI_BASE_URL"),apiKey:t=Le("OPENAI_API_KEY"),organization:r=Le("OPENAI_ORG_ID")??null,project:n=Le("OPENAI_PROJECT_ID")??null,...a}={}){if(void 0===t)throw new L("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const s={apiKey:t,organization:r,project:n,...a,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new L("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Je(this),this.chat=new Qe(this),this.embeddings=new et(this),this.files=new tt(this),this.images=new nt(this),this.audio=new ot(this),this.moderations=new ct(this),this.models=new lt(this),this.fineTuning=new Ot(this),this.graders=new kt(this),this.vectorStores=new Pt(this),this.beta=new xn(this),this.batches=new Sn(this),this.uploads=new Pn(this),this.responses=new Gn(this),this.evals=new Qn(this),this.containers=new aa(this),this._options=s,this.apiKey=t,this.organization=r,this.project=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return function(e,t={}){let r=e;const n=function(e=g){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||g.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let r=a;if(void 0!==e.format){if(!u.call(s,e.format))throw new TypeError("Unknown format option provided.");r=e.format}const n=s[r];let i,o=g.filter;if(("function"==typeof e.filter||h(e.filter))&&(o=e.filter),i=e.arrayFormat&&e.arrayFormat in d?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":g.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const c=void 0===e.allowDots?1==!!e.encodeDotInKeys||g.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:g.addQueryPrefix,allowDots:c,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:g.allowEmptyArrays,arrayFormat:i,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:g.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?g.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:g.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:g.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:g.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:g.encodeValuesOnly,filter:o,format:r,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:g.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:g.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:g.strictNullHandling}}(t);let i,o;"function"==typeof n.filter?(o=n.filter,r=o("",r)):h(n.filter)&&(o=n.filter,i=o);const c=[];if("object"!=typeof r||null===r)return"";const l=d[n.arrayFormat],p="comma"===l&&n.commaRoundTrip;i||(i=Object.keys(r)),n.sort&&i.sort(n.sort);const m=new WeakMap;for(let e=0;e<i.length;++e){const t=i[e];n.skipNulls&&null===r[t]||f(c,_(r[t],t,l,p,n.allowEmptyArrays,n.strictNullHandling,n.skipNulls,n.encodeDotInKeys,n.encode?n.encoder:null,n.filter,n.sort,n.allowDots,n.serializeDate,n.format,n.formatter,n.encodeValuesOnly,n.charset,m))}const y=c.join(n.delimiter);let b=!0===n.addQueryPrefix?"?":"";return n.charsetSentinel&&("iso-8859-1"===n.charset?b+="utf8=%26%2310003%3B&":b+="utf8=%E2%9C%93&"),y.length>0?b+y:""}(e,{arrayFormat:"brackets"})}}function oa(e,t=ca){const r=(e=e.trim()).indexOf("```");if(-1===r)return t(e);let n=e.substring(r+3);n.startsWith("json\n")?n=n.substring(5):n.startsWith("json")?n=n.substring(4):n.startsWith("\n")&&(n=n.substring(1));const a=n.indexOf("```");let s=n;return-1!==a&&(s=n.substring(0,a)),t(s.trim())}function ca(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const r=[];let n=!1,a=!1;for(let s of e){if(n)'"'!==s||a?"\n"!==s||a?a="\\"===s&&!a:s="\\n":n=!1;else if('"'===s)n=!0,a=!1;else if("{"===s)r.push("}");else if("["===s)r.push("]");else if("}"===s||"]"===s){if(!r||r[r.length-1]!==s)return null;r.pop()}t+=s}n&&(t+='"');for(let e=r.length-1;e>=0;e-=1)t+=r[e];try{return JSON.parse(t)}catch(e){return null}}Zn=ia,ia.OpenAI=Zn,ia.DEFAULT_TIMEOUT=6e5,ia.OpenAIError=L,ia.APIError=M,ia.APIConnectionError=U,ia.APIConnectionTimeoutError=D,ia.APIUserAbortError=z,ia.NotFoundError=q,ia.ConflictError=H,ia.RateLimitError=G,ia.BadRequestError=F,ia.AuthenticationError=B,ia.InternalServerError=W,ia.PermissionDeniedError=Z,ia.UnprocessableEntityError=J,ia.toFile=le,ia.fileFromPath=A,ia.Completions=Je,ia.Chat=Qe,ia.ChatCompletionsPage=Xe,ia.Embeddings=et,ia.Files=tt,ia.FileObjectsPage=rt,ia.Images=nt,ia.Audio=ot,ia.Moderations=ct,ia.Models=lt,ia.ModelsPage=ut,ia.FineTuning=Ot,ia.Graders=kt,ia.VectorStores=Pt,ia.VectorStoresPage=$t,ia.VectorStoreSearchResponsesPage=Tt,ia.Beta=xn,ia.Batches=Sn,ia.BatchesPage=An,ia.Uploads=Pn,ia.Responses=Gn,ia.Evals=Qn,ia.EvalListResponsesPage=ea,ia.Containers=aa,ia.ContainerListResponsesPage=sa,new Set(["/completions","/chat/completions","/embeddings","/audio/transcriptions","/audio/translations","/audio/speech","/images/generations","/images/edits"]);var la=r(9478);function ua(e,t){return t?.[e]||la(e)}r(2729);const da="__lc_escaped__";function ha(e){if(null!==e&&"object"==typeof e&&!Array.isArray(e)){if(null!==(t=e)&&"object"==typeof t&&"lc_serializable"in t&&"function"==typeof t.toJSON)return e;const r=e;if(function(e){return"lc"in e||1===Object.keys(e).length&&da in e}(r))return function(e){return{[da]:e}}(r);const n={};for(const[e,t]of Object.entries(r))n[e]=ha(t);return n}var t;return Array.isArray(e)?e.map(e=>ha(e)):e}function pa(e){return Array.isArray(e)?[...e]:{...e}}function fa(e){const t=Object.getPrototypeOf(e);return"function"!=typeof e.lc_name||"function"==typeof t.lc_name&&e.lc_name()===t.lc_name()?e.name:e.lc_name()}class ma{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,fa(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),void 0!==this.lc_serializable_keys?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([e])=>this.lc_serializable_keys?.includes(e))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof ma||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e),{});for(let n=Object.getPrototypeOf(this);n;n=Object.getPrototypeOf(n))Object.assign(e,Reflect.get(n,"lc_aliases",this)),Object.assign(t,Reflect.get(n,"lc_secrets",this)),Object.assign(r,Reflect.get(n,"lc_attributes",this));Object.keys(t).forEach(e=>{let t=this,n=r;const[a,...s]=e.split(".").reverse();for(const e of s.reverse()){if(!(e in t)||void 0===t[e])return;e in n&&void 0!==n[e]||("object"==typeof t[e]&&null!=t[e]?n[e]={}:Array.isArray(t[e])&&(n[e]=[])),t=t[e],n=n[e]}a in t&&void 0!==t[a]&&(n[a]=n[a]||t[a])});const n={};for(const[e,t]of Object.entries(r))n[e]=ha(t);const a=Object.keys(t).length?function(e,t){const r=pa(e);for(const[e,n]of Object.entries(t)){const[t,...a]=e.split(".").reverse();let s=r;for(const e of a.reverse()){if(void 0===s[e])break;s[e]=pa(s[e]),s=s[e]}void 0!==s[t]&&(s[t]={lc:1,type:"secret",id:[n]})}return r}(n,t):n,s=function(e,t,r){const n={};for(const a in e)Object.hasOwn(e,a)&&(n[t(a,r)]=e[a]);return n}(a,ua,e);return{lc:1,type:"constructor",id:this.lc_id,kwargs:s}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function ga(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"source_type"in e&&("url"===e.source_type||"base64"===e.source_type||"text"===e.source_type||"id"===e.source_type)}function ya(e){return ga(e)&&"url"===e.source_type&&"url"in e&&"string"==typeof e.url}function _a(e){return ga(e)&&"base64"===e.source_type&&"data"in e&&"string"==typeof e.data}function ba(e){if(ga(e)){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url}};if("base64"===e.source_type){if(!e.mime_type)throw new Error("mime_type key is required for base64 data.");return{type:"image_url",image_url:{url:`data:${e.mime_type};base64,${e.data}`}}}}throw new Error("Unsupported source type. Only 'url' and 'base64' are supported.")}function wa(e,t){return"string"==typeof e?""===e?t:"string"==typeof t?e+t:Array.isArray(t)&&t.some(e=>ga(e))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?Ea(e,t)??[...e,...t]:""===t?e:Array.isArray(e)&&e.some(e=>ga(e))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}class va extends ma{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:Array.isArray(this.content)?this.content.map(e=>"string"==typeof e?e:"text"===e.type?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){if(null===e)return this;const t=(r=this._printableFields,n=Math.max(4,e),JSON.stringify(function e(t,r){if("object"!=typeof t||null==t)return t;if(r>=n)return Array.isArray(t)?"[Array]":"[Object]";if(Array.isArray(t))return t.map(t=>e(t,r+1));const a={};for(const n of Object.keys(t))a[n]=e(t[n],r+1);return a}(r,0),null,2));var r,n;return`${this.constructor.lc_name()} ${t}`}}function Oa(e,t){const r={...e};for(const[e,n]of Object.entries(t))if(null==r[e])r[e]=n;else{if(null==n)continue;if(typeof r[e]!=typeof n||Array.isArray(r[e])!==Array.isArray(n))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof r[e]){if("type"===e)continue;["id","name","output_version","model_provider"].includes(e)?r[e]=n:r[e]+=n}else if("object"!=typeof r[e]||Array.isArray(r[e]))if(Array.isArray(r[e]))r[e]=Ea(r[e],n);else{if(r[e]===n)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else r[e]=Oa(r[e],n)}return r}function Ea(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const r=[...e];for(const e of t)if("object"==typeof e&&null!==e&&"index"in e&&"number"==typeof e.index){const t=r.findIndex(t=>{const r="object"==typeof t,n="index"in t&&t.index===e.index;return r&&n&&("id"in t&&"id"in e&&t?.id===e?.id||!("id"in t&&t?.id&&"id"in e&&e?.id))});-1!==t&&"object"==typeof r[t]&&null!==r[t]?r[t]=Oa(r[t],e):r.push(e)}else{if("object"==typeof e&&null!==e&&"text"in e&&""===e.text)continue;r.push(e)}return r}}}function ka(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(e&&t){if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.\nLeft ${typeof e}\nRight ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return Ea(e,t);if("object"==typeof e&&"object"==typeof t)return Oa(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.\nLeft ${e}\nRight ${t}`)}return e||t}class xa extends va{}function Sa(e){return"function"==typeof e?._getType}function Aa(e){return Sa(e)&&"function"==typeof e.concat}class Ia extends va{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){"string"==typeof e&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status,this.metadata=e.metadata}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class Pa extends xa{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new Pa({content:wa(this.content,e.content),additional_kwargs:Oa(this.additional_kwargs,e.additional_kwargs),response_metadata:Oa(this.response_metadata,e.response_metadata),artifact:ka(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:(t=this.status,r=e.status,"error"===t||"error"===r?"error":"success")});var t,r}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class $a extends va{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if("string"==typeof e)r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;const t=r.additional_kwargs?.tool_calls,n=r.tool_calls;null!=t&&t.length>0&&(void 0===n||0===n.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===n){const[e,n]=function(e){const t=[],r=[];for(const n of e)if(n.function){const e=n.function.name;try{const r={name:e||"",args:JSON.parse(n.function.arguments)||{},id:n.id};t.push(r)}catch(t){r.push({name:e,args:n.function.arguments,id:n.id,error:"Malformed args."})}}return[t,r]}(t);r.tool_calls=e??[],r.invalid_tool_calls=n??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch(e){r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof r&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function Ta(e){return"ai"===e._getType()}function ja(e){return"ai"===e._getType()}class Ra extends xa{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks||0===e.tool_call_chunks.length)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{const r=(e.tool_call_chunks??[]).reduce((e,t)=>{const r=e.findIndex(([e])=>"id"in t&&t.id&&"index"in t&&void 0!==t.index?t.id===e.id&&t.index===e.index:"id"in t&&t.id?t.id===e.id:"index"in t&&void 0!==t.index&&t.index===e.index);return-1!==r?e[r].push(t):e.push([t]),e},[]),n=[],a=[];for(const e of r){let t={};const r=e[0]?.name??"",s=e.map(e=>e.args||"").join(""),i=s.length?s:"{}",o=e[0]?.id;try{if(t=ca(i),!o||null===t||"object"!=typeof t||Array.isArray(t))throw new Error("Malformed tool call chunk args.");n.push({name:r,args:t,id:o,type:"tool_call"})}catch(e){a.push({name:r,args:i,id:o,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:n,invalid_tool_calls:a,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){const t={content:wa(this.content,e.content),additional_kwargs:Oa(this.additional_kwargs,e.additional_kwargs),response_metadata:Oa(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const r=Ea(this.tool_call_chunks,e.tool_call_chunks);void 0!==r&&r.length>0&&(t.tool_call_chunks=r)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const r={...(void 0!==this.usage_metadata?.input_token_details?.audio||void 0!==e.usage_metadata?.input_token_details?.audio)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_read||void 0!==e.usage_metadata?.input_token_details?.cache_read)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(void 0!==this.usage_metadata?.input_token_details?.cache_creation||void 0!==e.usage_metadata?.input_token_details?.cache_creation)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},n={...(void 0!==this.usage_metadata?.output_token_details?.audio||void 0!==e.usage_metadata?.output_token_details?.audio)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(void 0!==this.usage_metadata?.output_token_details?.reasoning||void 0!==e.usage_metadata?.output_token_details?.reasoning)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},a=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},i={input_tokens:a.input_tokens+s.input_tokens,output_tokens:a.output_tokens+s.output_tokens,total_tokens:a.total_tokens+s.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(n).length>0&&{output_token_details:n}};t.usage_metadata=i}return new Ra(t)}}class Na extends va{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Na}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}get _printableFields(){return{...super._printableFields,role:this.role}}}class Ca extends xa{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new Ca({content:wa(this.content,e.content),additional_kwargs:Oa(this.additional_kwargs,e.additional_kwargs),response_metadata:Oa(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}class La extends xa{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new La({content:wa(this.content,e.content),additional_kwargs:Oa(this.additional_kwargs,e.additional_kwargs),response_metadata:Oa(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class Ma extends va{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}}class za extends xa{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(e,t){super(e,t)}concat(e){return new za({content:wa(this.content,e.content),additional_kwargs:Oa(this.additional_kwargs,e.additional_kwargs),response_metadata:Oa(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class Ua extends va{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}}class Da extends xa{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(e,t){super(e,t)}concat(e){return new Da({content:wa(this.content,e.content),additional_kwargs:Oa(this.additional_kwargs,e.additional_kwargs),response_metadata:Oa(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function Fa(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}function Ba(e){return!(!e||"object"!=typeof e||!("type"in e)||"tool_call"!==e.type)}class Za extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}class qa extends va{constructor(e){super({...e,content:""}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.id=e.id}_getType(){return"remove"}get _printableFields(){return{...super._printableFields,id:this.id}}}function Ha(e){return Ba(e)?e:"string"==typeof e.id&&"function"===e.type&&"object"==typeof e.function&&null!==e.function&&"arguments"in e.function&&"string"==typeof e.function.arguments&&"name"in e.function&&"string"==typeof e.function.name?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function Ja(e){let t,r;if("object"==typeof(n=e)&&null!=n&&1===n.lc&&Array.isArray(n.id)&&null!=n.kwargs&&"object"==typeof n.kwargs){const n=e.id.at(-1);t="HumanMessage"===n||"HumanMessageChunk"===n?"user":"AIMessage"===n||"AIMessageChunk"===n?"assistant":"SystemMessage"===n||"SystemMessageChunk"===n?"system":"FunctionMessage"===n||"FunctionMessageChunk"===n?"function":"ToolMessage"===n||"ToolMessageChunk"===n?"tool":"unknown",r=e.kwargs}else{const{type:n,...a}=e;t=n,r=a}var n;if("human"===t||"user"===t)return new Ma(r);if("ai"===t||"assistant"===t){const{tool_calls:e,...t}=r;if(!Array.isArray(e))return new $a(r);const n=e.map(Ha);return new $a({...t,tool_calls:n})}if("system"===t)return new Ua(r);if("developer"===t)return new Ua({...r,additional_kwargs:{...r.additional_kwargs,__openai_role__:"developer"}});if("tool"===t&&"tool_call_id"in r)return new Ia({...r,content:r.content,tool_call_id:r.tool_call_id,name:r.name});if("remove"===t&&"id"in r&&"string"==typeof r.id)return new qa({...r,id:r.id});throw Fa(new Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.\n\nReceived: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}function Ga(e){if("string"==typeof e)return new Ma(e);if(Sa(e))return e;if(Array.isArray(e)){const[t,r]=e;return Ja({type:t,content:r})}if("string"==typeof e.role){const{role:t,...r}=e;return Ja({...r,type:t})}return Ja(e)}function Wa(e,t="Human",r="AI"){const n=[];for(const a of e){let e;if("human"===a._getType())e=t;else if("ai"===a._getType())e=r;else if("system"===a._getType())e="System";else if("function"===a._getType())e="Function";else if("tool"===a._getType())e="Tool";else{if("generic"!==a._getType())throw new Error(`Got unsupported message type: ${a._getType()}`);e=a.role}const s=a.name?`${a.name}, `:"",i="string"==typeof a.content?a.content:JSON.stringify(a.content,null,2);n.push(`${e}: ${s}${i}`)}return n.join("\n")}function Ka(e){const t=e._getType();if("human"===t)return new za({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)}))}),new Ra({...t})}if("system"===t)return new Da({...e});if("function"===t)return new La({...e});if(Na.isInstance(e))return new Ca({...e});throw new Error("Unknown message type.")}var Va,Xa,Ya;(Ya=Va||(Va={})).assertEqual=e=>{},Ya.assertIs=function(e){},Ya.assertNever=function(_x){throw new Error},Ya.arrayToEnum=e=>{const t={};for(const r of e)t[r]=r;return t},Ya.getValidEnumValues=e=>{const t=Ya.objectKeys(e).filter(t=>"number"!=typeof e[e[t]]),r={};for(const n of t)r[n]=e[n];return Ya.objectValues(r)},Ya.objectValues=e=>Ya.objectKeys(e).map(function(t){return e[t]}),Ya.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},Ya.find=(e,t)=>{for(const r of e)if(t(r))return r},Ya.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&Number.isFinite(e)&&Math.floor(e)===e,Ya.joinValues=function(e,t=" | "){return e.map(e=>"string"==typeof e?`'${e}'`:e).join(t)},Ya.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t,function(e){e.mergeShapes=(e,t)=>({...e,...t})}(Xa||(Xa={}));const Qa=Va.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),es=e=>{switch(typeof e){case"undefined":return Qa.undefined;case"string":return Qa.string;case"number":return Number.isNaN(e)?Qa.nan:Qa.number;case"boolean":return Qa.boolean;case"function":return Qa.function;case"bigint":return Qa.bigint;case"symbol":return Qa.symbol;case"object":return Array.isArray(e)?Qa.array:null===e?Qa.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?Qa.promise:"undefined"!=typeof Map&&e instanceof Map?Qa.map:"undefined"!=typeof Set&&e instanceof Set?Qa.set:"undefined"!=typeof Date&&e instanceof Date?Qa.date:Qa.object;default:return Qa.unknown}},ts=Va.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class rs extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}format(e){const t=e||function(e){return e.message},r={_errors:[]},n=e=>{for(const a of e.issues)if("invalid_union"===a.code)a.unionErrors.map(n);else if("invalid_return_type"===a.code)n(a.returnTypeError);else if("invalid_arguments"===a.code)n(a.argumentsError);else if(0===a.path.length)r._errors.push(t(a));else{let e=r,n=0;for(;n<a.path.length;){const r=a.path[n];n===a.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(a))):e[r]=e[r]||{_errors:[]},e=e[r],n++}}};return n(this),r}static assert(e){if(!(e instanceof rs))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Va.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},r=[];for(const n of this.issues)if(n.path.length>0){const r=n.path[0];t[r]=t[r]||[],t[r].push(e(n))}else r.push(e(n));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}rs.create=e=>new rs(e);const ns=(e,t)=>{let r;switch(e.code){case ts.invalid_type:r=e.received===Qa.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case ts.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(e.expected,Va.jsonStringifyReplacer)}`;break;case ts.unrecognized_keys:r=`Unrecognized key(s) in object: ${Va.joinValues(e.keys,", ")}`;break;case ts.invalid_union:r="Invalid input";break;case ts.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${Va.joinValues(e.options)}`;break;case ts.invalid_enum_value:r=`Invalid enum value. Expected ${Va.joinValues(e.options)}, received '${e.received}'`;break;case ts.invalid_arguments:r="Invalid function arguments";break;case ts.invalid_return_type:r="Invalid function return type";break;case ts.invalid_date:r="Invalid date";break;case ts.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(r=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(r=`${r} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?r=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?r=`Invalid input: must end with "${e.validation.endsWith}"`:Va.assertNever(e.validation):r="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case ts.too_small:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type||"bigint"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case ts.too_big:r="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case ts.custom:r="Invalid input";break;case ts.invalid_intersection_types:r="Intersection results could not be merged";break;case ts.not_multiple_of:r=`Number must be a multiple of ${e.multipleOf}`;break;case ts.not_finite:r="Number must be finite";break;default:r=t.defaultError,Va.assertNever(e)}return{message:r}};let as=ns;var ss;!function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:e?.message}(ss||(ss={}));function is(e,t){const r=as,n=(e=>{const{data:t,path:r,errorMaps:n,issueData:a}=e,s=[...r,...a.path||[]],i={...a,path:s};if(void 0!==a.message)return{...a,path:s,message:a.message};let o="";const c=n.filter(e=>!!e).slice().reverse();for(const e of c)o=e(i,{data:t,defaultError:o}).message;return{...a,path:s,message:o}})({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===ns?void 0:ns].filter(e=>!!e)});e.common.issues.push(n)}class os{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const n of t){if("aborted"===n.status)return cs;"dirty"===n.status&&e.dirty(),r.push(n.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const e of t){const t=await e.key,n=await e.value;r.push({key:t,value:n})}return os.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const n of t){const{key:t,value:a}=n;if("aborted"===t.status)return cs;if("aborted"===a.status)return cs;"dirty"===t.status&&e.dirty(),"dirty"===a.status&&e.dirty(),"__proto__"===t.value||void 0===a.value&&!n.alwaysSet||(r[t.value]=a.value)}return{status:e.value,value:r}}}const cs=Object.freeze({status:"aborted"}),ls=e=>({status:"dirty",value:e}),us=e=>({status:"valid",value:e}),ds=e=>"aborted"===e.status,hs=e=>"dirty"===e.status,ps=e=>"valid"===e.status,fs=e=>"undefined"!=typeof Promise&&e instanceof Promise;class ms{constructor(e,t,r,n){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=n}get path(){return this._cachedPath.length||(Array.isArray(this._key)?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const gs=(e,t)=>{if(ps(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new rs(e.common.issues);return this._error=t,this._error}}};function ys(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:n,description:a}=e;if(t&&(r||n))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');return t?{errorMap:t,description:a}:{errorMap:(t,a)=>{const{message:s}=e;return"invalid_enum_value"===t.code?{message:s??a.defaultError}:void 0===a.data?{message:s??n??a.defaultError}:"invalid_type"!==t.code?{message:a.defaultError}:{message:s??r??a.defaultError}},description:a}}class _s{get description(){return this._def.description}_getType(e){return es(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:es(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new os,ctx:{common:e.parent.common,data:e.data,parsedType:es(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(fs(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){const r={common:{issues:[],async:t?.async??!1,contextualErrorMap:t?.errorMap},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:es(e)},n=this._parseSync({data:e,path:r.path,parent:r});return gs(r,n)}"~validate"(e){const t={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:es(e)};if(!this["~standard"].async)try{const r=this._parseSync({data:e,path:[],parent:t});return ps(r)?{value:r.value}:{issues:t.common.issues}}catch(e){e?.message?.toLowerCase()?.includes("encountered")&&(this["~standard"].async=!0),t.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:t}).then(e=>ps(e)?{value:e.value}:{issues:t.common.issues})}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:t?.errorMap,async:!0},path:t?.path||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:es(e)},n=this._parse({data:e,path:r.path,parent:r}),a=await(fs(n)?n:Promise.resolve(n));return gs(r,a)}refine(e,t){const r=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement((t,n)=>{const a=e(t),s=()=>n.addIssue({code:ts.custom,...r(t)});return"undefined"!=typeof Promise&&a instanceof Promise?a.then(e=>!!e||(s(),!1)):!!a||(s(),!1)})}refinement(e,t){return this._refinement((r,n)=>!!e(r)||(n.addIssue("function"==typeof t?t(r,n):t),!1))}_refinement(e){return new gi({schema:this,typeName:xi.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:e=>this["~validate"](e)}}optional(){return yi.create(this,this._def)}nullable(){return _i.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ti.create(this)}promise(){return mi.create(this,this._def)}or(e){return ai.create([this,e],this._def)}and(e){return ii.create(this,e,this._def)}transform(e){return new gi({...ys(this._def),schema:this,typeName:xi.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new bi({...ys(this._def),innerType:this,defaultValue:t,typeName:xi.ZodDefault})}brand(){return new Oi({typeName:xi.ZodBranded,type:this,...ys(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new wi({...ys(this._def),innerType:this,catchValue:t,typeName:xi.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Ei.create(this,e)}readonly(){return ki.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const bs=/^c[^\s-]{8,}$/i,ws=/^[0-9a-z]+$/,vs=/^[0-9A-HJKMNP-TV-Z]{26}$/i,Os=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Es=/^[a-z0-9_-]{21}$/i,ks=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,xs=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,Ss=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let As;const Is=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,Ps=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,$s=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,Ts=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,js=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Rs=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Ns="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Cs=new RegExp(`^${Ns}$`);function Ls(e){let t="[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),`([01]\\d|2[0-3]):[0-5]\\d(:${t})${e.precision?"+":"?"}`}function Ms(e){return new RegExp(`^${Ls(e)}$`)}function zs(e){let t=`${Ns}T${Ls(e)}`;const r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,new RegExp(`^${t}$`)}function Us(e,t){return!("v4"!==t&&t||!Is.test(e))||!("v6"!==t&&t||!$s.test(e))}function Ds(e,t){if(!ks.test(e))return!1;try{const[r]=e.split(".");if(!r)return!1;const n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),a=JSON.parse(atob(n));return!("object"!=typeof a||null===a||"typ"in a&&"JWT"!==a?.typ||!a.alg||t&&a.alg!==t)}catch{return!1}}function Fs(e,t){return!("v4"!==t&&t||!Ps.test(e))||!("v6"!==t&&t||!Ts.test(e))}class Bs extends _s{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==Qa.string){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.string,received:t.parsedType}),cs}const t=new os;let r;for(const n of this._def.checks)if("min"===n.kind)e.data.length<n.value&&(r=this._getOrReturnCtx(e,r),is(r,{code:ts.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),t.dirty());else if("max"===n.kind)e.data.length>n.value&&(r=this._getOrReturnCtx(e,r),is(r,{code:ts.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!1,message:n.message}),t.dirty());else if("length"===n.kind){const a=e.data.length>n.value,s=e.data.length<n.value;(a||s)&&(r=this._getOrReturnCtx(e,r),a?is(r,{code:ts.too_big,maximum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}):s&&is(r,{code:ts.too_small,minimum:n.value,type:"string",inclusive:!0,exact:!0,message:n.message}),t.dirty())}else if("email"===n.kind)Ss.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"email",code:ts.invalid_string,message:n.message}),t.dirty());else if("emoji"===n.kind)As||(As=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),As.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"emoji",code:ts.invalid_string,message:n.message}),t.dirty());else if("uuid"===n.kind)Os.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"uuid",code:ts.invalid_string,message:n.message}),t.dirty());else if("nanoid"===n.kind)Es.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"nanoid",code:ts.invalid_string,message:n.message}),t.dirty());else if("cuid"===n.kind)bs.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"cuid",code:ts.invalid_string,message:n.message}),t.dirty());else if("cuid2"===n.kind)ws.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"cuid2",code:ts.invalid_string,message:n.message}),t.dirty());else if("ulid"===n.kind)vs.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"ulid",code:ts.invalid_string,message:n.message}),t.dirty());else if("url"===n.kind)try{new URL(e.data)}catch{r=this._getOrReturnCtx(e,r),is(r,{validation:"url",code:ts.invalid_string,message:n.message}),t.dirty()}else"regex"===n.kind?(n.regex.lastIndex=0,n.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"regex",code:ts.invalid_string,message:n.message}),t.dirty())):"trim"===n.kind?e.data=e.data.trim():"includes"===n.kind?e.data.includes(n.value,n.position)||(r=this._getOrReturnCtx(e,r),is(r,{code:ts.invalid_string,validation:{includes:n.value,position:n.position},message:n.message}),t.dirty()):"toLowerCase"===n.kind?e.data=e.data.toLowerCase():"toUpperCase"===n.kind?e.data=e.data.toUpperCase():"startsWith"===n.kind?e.data.startsWith(n.value)||(r=this._getOrReturnCtx(e,r),is(r,{code:ts.invalid_string,validation:{startsWith:n.value},message:n.message}),t.dirty()):"endsWith"===n.kind?e.data.endsWith(n.value)||(r=this._getOrReturnCtx(e,r),is(r,{code:ts.invalid_string,validation:{endsWith:n.value},message:n.message}),t.dirty()):"datetime"===n.kind?zs(n).test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{code:ts.invalid_string,validation:"datetime",message:n.message}),t.dirty()):"date"===n.kind?Cs.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{code:ts.invalid_string,validation:"date",message:n.message}),t.dirty()):"time"===n.kind?Ms(n).test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{code:ts.invalid_string,validation:"time",message:n.message}),t.dirty()):"duration"===n.kind?xs.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"duration",code:ts.invalid_string,message:n.message}),t.dirty()):"ip"===n.kind?Us(e.data,n.version)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"ip",code:ts.invalid_string,message:n.message}),t.dirty()):"jwt"===n.kind?Ds(e.data,n.alg)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"jwt",code:ts.invalid_string,message:n.message}),t.dirty()):"cidr"===n.kind?Fs(e.data,n.version)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"cidr",code:ts.invalid_string,message:n.message}),t.dirty()):"base64"===n.kind?js.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"base64",code:ts.invalid_string,message:n.message}),t.dirty()):"base64url"===n.kind?Rs.test(e.data)||(r=this._getOrReturnCtx(e,r),is(r,{validation:"base64url",code:ts.invalid_string,message:n.message}),t.dirty()):Va.assertNever(n);return{status:t.value,value:e.data}}_regex(e,t,r){return this.refinement(t=>e.test(t),{validation:t,code:ts.invalid_string,...ss.errToObj(r)})}_addCheck(e){return new Bs({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...ss.errToObj(e)})}url(e){return this._addCheck({kind:"url",...ss.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...ss.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...ss.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...ss.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...ss.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...ss.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...ss.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...ss.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...ss.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...ss.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...ss.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...ss.errToObj(e)})}datetime(e){return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===e?.precision?null:e?.precision,offset:e?.offset??!1,local:e?.local??!1,...ss.errToObj(e?.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===e?.precision?null:e?.precision,...ss.errToObj(e?.message)})}duration(e){return this._addCheck({kind:"duration",...ss.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...ss.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t?.position,...ss.errToObj(t?.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...ss.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...ss.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...ss.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...ss.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...ss.errToObj(t)})}nonempty(e){return this.min(1,ss.errToObj(e))}trim(){return new Bs({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Bs({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Bs({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isDate(){return!!this._def.checks.find(e=>"date"===e.kind)}get isTime(){return!!this._def.checks.find(e=>"time"===e.kind)}get isDuration(){return!!this._def.checks.find(e=>"duration"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isEmoji(){return!!this._def.checks.find(e=>"emoji"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isNANOID(){return!!this._def.checks.find(e=>"nanoid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get isCUID2(){return!!this._def.checks.find(e=>"cuid2"===e.kind)}get isULID(){return!!this._def.checks.find(e=>"ulid"===e.kind)}get isIP(){return!!this._def.checks.find(e=>"ip"===e.kind)}get isCIDR(){return!!this._def.checks.find(e=>"cidr"===e.kind)}get isBase64(){return!!this._def.checks.find(e=>"base64"===e.kind)}get isBase64url(){return!!this._def.checks.find(e=>"base64url"===e.kind)}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Zs(e,t){const r=(e.toString().split(".")[1]||"").length,n=(t.toString().split(".")[1]||"").length,a=r>n?r:n;return Number.parseInt(e.toFixed(a).replace(".",""))%Number.parseInt(t.toFixed(a).replace(".",""))/10**a}Bs.create=e=>new Bs({checks:[],typeName:xi.ZodString,coerce:e?.coerce??!1,...ys(e)});class qs extends _s{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==Qa.number){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.number,received:t.parsedType}),cs}let t;const r=new os;for(const n of this._def.checks)"int"===n.kind?Va.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),is(t,{code:ts.invalid_type,expected:"integer",received:"float",message:n.message}),r.dirty()):"min"===n.kind?(n.inclusive?e.data<n.value:e.data<=n.value)&&(t=this._getOrReturnCtx(e,t),is(t,{code:ts.too_small,minimum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),r.dirty()):"max"===n.kind?(n.inclusive?e.data>n.value:e.data>=n.value)&&(t=this._getOrReturnCtx(e,t),is(t,{code:ts.too_big,maximum:n.value,type:"number",inclusive:n.inclusive,exact:!1,message:n.message}),r.dirty()):"multipleOf"===n.kind?0!==Zs(e.data,n.value)&&(t=this._getOrReturnCtx(e,t),is(t,{code:ts.not_multiple_of,multipleOf:n.value,message:n.message}),r.dirty()):"finite"===n.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),is(t,{code:ts.not_finite,message:n.message}),r.dirty()):Va.assertNever(n);return{status:r.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,ss.toString(t))}gt(e,t){return this.setLimit("min",e,!1,ss.toString(t))}lte(e,t){return this.setLimit("max",e,!0,ss.toString(t))}lt(e,t){return this.setLimit("max",e,!1,ss.toString(t))}setLimit(e,t,r,n){return new qs({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:ss.toString(n)}]})}_addCheck(e){return new qs({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:ss.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:ss.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:ss.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:ss.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:ss.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:ss.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:ss.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:ss.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:ss.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind||"multipleOf"===e.kind&&Va.isInteger(e.value))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}qs.create=e=>new qs({checks:[],typeName:xi.ZodNumber,coerce:e?.coerce||!1,...ys(e)});class Hs extends _s{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==Qa.bigint)return this._getInvalidInput(e);let t;const r=new os;for(const n of this._def.checks)"min"===n.kind?(n.inclusive?e.data<n.value:e.data<=n.value)&&(t=this._getOrReturnCtx(e,t),is(t,{code:ts.too_small,type:"bigint",minimum:n.value,inclusive:n.inclusive,message:n.message}),r.dirty()):"max"===n.kind?(n.inclusive?e.data>n.value:e.data>=n.value)&&(t=this._getOrReturnCtx(e,t),is(t,{code:ts.too_big,type:"bigint",maximum:n.value,inclusive:n.inclusive,message:n.message}),r.dirty()):"multipleOf"===n.kind?e.data%n.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),is(t,{code:ts.not_multiple_of,multipleOf:n.value,message:n.message}),r.dirty()):Va.assertNever(n);return{status:r.value,value:e.data}}_getInvalidInput(e){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.bigint,received:t.parsedType}),cs}gte(e,t){return this.setLimit("min",e,!0,ss.toString(t))}gt(e,t){return this.setLimit("min",e,!1,ss.toString(t))}lte(e,t){return this.setLimit("max",e,!0,ss.toString(t))}lt(e,t){return this.setLimit("max",e,!1,ss.toString(t))}setLimit(e,t,r,n){return new Hs({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:ss.toString(n)}]})}_addCheck(e){return new Hs({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:ss.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:ss.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:ss.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:ss.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:ss.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}Hs.create=e=>new Hs({checks:[],typeName:xi.ZodBigInt,coerce:e?.coerce??!1,...ys(e)});class Js extends _s{_parse(e){if(this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==Qa.boolean){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.boolean,received:t.parsedType}),cs}return us(e.data)}}Js.create=e=>new Js({typeName:xi.ZodBoolean,coerce:e?.coerce||!1,...ys(e)});class Gs extends _s{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==Qa.date){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.date,received:t.parsedType}),cs}if(Number.isNaN(e.data.getTime()))return is(this._getOrReturnCtx(e),{code:ts.invalid_date}),cs;const t=new os;let r;for(const n of this._def.checks)"min"===n.kind?e.data.getTime()<n.value&&(r=this._getOrReturnCtx(e,r),is(r,{code:ts.too_small,message:n.message,inclusive:!0,exact:!1,minimum:n.value,type:"date"}),t.dirty()):"max"===n.kind?e.data.getTime()>n.value&&(r=this._getOrReturnCtx(e,r),is(r,{code:ts.too_big,message:n.message,inclusive:!0,exact:!1,maximum:n.value,type:"date"}),t.dirty()):Va.assertNever(n);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Gs({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:ss.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:ss.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Gs.create=e=>new Gs({checks:[],coerce:e?.coerce||!1,typeName:xi.ZodDate,...ys(e)});class Ws extends _s{_parse(e){if(this._getType(e)!==Qa.symbol){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.symbol,received:t.parsedType}),cs}return us(e.data)}}Ws.create=e=>new Ws({typeName:xi.ZodSymbol,...ys(e)});class Ks extends _s{_parse(e){if(this._getType(e)!==Qa.undefined){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.undefined,received:t.parsedType}),cs}return us(e.data)}}Ks.create=e=>new Ks({typeName:xi.ZodUndefined,...ys(e)});class Vs extends _s{_parse(e){if(this._getType(e)!==Qa.null){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.null,received:t.parsedType}),cs}return us(e.data)}}Vs.create=e=>new Vs({typeName:xi.ZodNull,...ys(e)});class Xs extends _s{constructor(){super(...arguments),this._any=!0}_parse(e){return us(e.data)}}Xs.create=e=>new Xs({typeName:xi.ZodAny,...ys(e)});class Ys extends _s{constructor(){super(...arguments),this._unknown=!0}_parse(e){return us(e.data)}}Ys.create=e=>new Ys({typeName:xi.ZodUnknown,...ys(e)});class Qs extends _s{_parse(e){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.never,received:t.parsedType}),cs}}Qs.create=e=>new Qs({typeName:xi.ZodNever,...ys(e)});class ei extends _s{_parse(e){if(this._getType(e)!==Qa.undefined){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.void,received:t.parsedType}),cs}return us(e.data)}}ei.create=e=>new ei({typeName:xi.ZodVoid,...ys(e)});class ti extends _s{_parse(e){const{ctx:t,status:r}=this._processInputParams(e),n=this._def;if(t.parsedType!==Qa.array)return is(t,{code:ts.invalid_type,expected:Qa.array,received:t.parsedType}),cs;if(null!==n.exactLength){const e=t.data.length>n.exactLength.value,a=t.data.length<n.exactLength.value;(e||a)&&(is(t,{code:e?ts.too_big:ts.too_small,minimum:a?n.exactLength.value:void 0,maximum:e?n.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:n.exactLength.message}),r.dirty())}if(null!==n.minLength&&t.data.length<n.minLength.value&&(is(t,{code:ts.too_small,minimum:n.minLength.value,type:"array",inclusive:!0,exact:!1,message:n.minLength.message}),r.dirty()),null!==n.maxLength&&t.data.length>n.maxLength.value&&(is(t,{code:ts.too_big,maximum:n.maxLength.value,type:"array",inclusive:!0,exact:!1,message:n.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((e,r)=>n.type._parseAsync(new ms(t,e,t.path,r)))).then(e=>os.mergeArray(r,e));const a=[...t.data].map((e,r)=>n.type._parseSync(new ms(t,e,t.path,r)));return os.mergeArray(r,a)}get element(){return this._def.type}min(e,t){return new ti({...this._def,minLength:{value:e,message:ss.toString(t)}})}max(e,t){return new ti({...this._def,maxLength:{value:e,message:ss.toString(t)}})}length(e,t){return new ti({...this._def,exactLength:{value:e,message:ss.toString(t)}})}nonempty(e){return this.min(1,e)}}function ri(e){if(e instanceof ni){const t={};for(const r in e.shape){const n=e.shape[r];t[r]=yi.create(ri(n))}return new ni({...e._def,shape:()=>t})}return e instanceof ti?new ti({...e._def,type:ri(e.element)}):e instanceof yi?yi.create(ri(e.unwrap())):e instanceof _i?_i.create(ri(e.unwrap())):e instanceof oi?oi.create(e.items.map(e=>ri(e))):e}ti.create=(e,t)=>new ti({type:e,minLength:null,maxLength:null,exactLength:null,typeName:xi.ZodArray,...ys(t)});class ni extends _s{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=Va.objectKeys(e);return this._cached={shape:e,keys:t},this._cached}_parse(e){if(this._getType(e)!==Qa.object){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.object,received:t.parsedType}),cs}const{status:t,ctx:r}=this._processInputParams(e),{shape:n,keys:a}=this._getCached(),s=[];if(!(this._def.catchall instanceof Qs&&"strip"===this._def.unknownKeys))for(const e in r.data)a.includes(e)||s.push(e);const i=[];for(const e of a){const t=n[e],a=r.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new ms(r,a,r.path,e)),alwaysSet:e in r.data})}if(this._def.catchall instanceof Qs){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of s)i.push({key:{status:"valid",value:e},value:{status:"valid",value:r.data[e]}});else if("strict"===e)s.length>0&&(is(r,{code:ts.unrecognized_keys,keys:s}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of s){const n=r.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new ms(r,n,r.path,t)),alwaysSet:t in r.data})}}return r.common.async?Promise.resolve().then(async()=>{const e=[];for(const t of i){const r=await t.key,n=await t.value;e.push({key:r,value:n,alwaysSet:t.alwaysSet})}return e}).then(e=>os.mergeObjectSync(t,e)):os.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return ss.errToObj,new ni({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{const n=this._def.errorMap?.(t,r).message??r.defaultError;return"unrecognized_keys"===t.code?{message:ss.errToObj(e).message??n}:{message:n}}}:{}})}strip(){return new ni({...this._def,unknownKeys:"strip"})}passthrough(){return new ni({...this._def,unknownKeys:"passthrough"})}extend(e){return new ni({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new ni({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:xi.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new ni({...this._def,catchall:e})}pick(e){const t={};for(const r of Va.objectKeys(e))e[r]&&this.shape[r]&&(t[r]=this.shape[r]);return new ni({...this._def,shape:()=>t})}omit(e){const t={};for(const r of Va.objectKeys(this.shape))e[r]||(t[r]=this.shape[r]);return new ni({...this._def,shape:()=>t})}deepPartial(){return ri(this)}partial(e){const t={};for(const r of Va.objectKeys(this.shape)){const n=this.shape[r];e&&!e[r]?t[r]=n:t[r]=n.optional()}return new ni({...this._def,shape:()=>t})}required(e){const t={};for(const r of Va.objectKeys(this.shape))if(e&&!e[r])t[r]=this.shape[r];else{let e=this.shape[r];for(;e instanceof yi;)e=e._def.innerType;t[r]=e}return new ni({...this._def,shape:()=>t})}keyof(){return hi(Va.objectKeys(this.shape))}}ni.create=(e,t)=>new ni({shape:()=>e,unknownKeys:"strip",catchall:Qs.create(),typeName:xi.ZodObject,...ys(t)}),ni.strictCreate=(e,t)=>new ni({shape:()=>e,unknownKeys:"strict",catchall:Qs.create(),typeName:xi.ZodObject,...ys(t)}),ni.lazycreate=(e,t)=>new ni({shape:e,unknownKeys:"strip",catchall:Qs.create(),typeName:xi.ZodObject,...ys(t)});class ai extends _s{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map(async e=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}})).then(function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;const r=e.map(e=>new rs(e.ctx.common.issues));return is(t,{code:ts.invalid_union,unionErrors:r}),cs});{let e;const n=[];for(const a of r){const r={...t,common:{...t.common,issues:[]},parent:null},s=a._parseSync({data:t.data,path:t.path,parent:r});if("valid"===s.status)return s;"dirty"!==s.status||e||(e={result:s,ctx:r}),r.common.issues.length&&n.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const a=n.map(e=>new rs(e));return is(t,{code:ts.invalid_union,unionErrors:a}),cs}}get options(){return this._def.options}}function si(e,t){const r=es(e),n=es(t);if(e===t)return{valid:!0,data:e};if(r===Qa.object&&n===Qa.object){const r=Va.objectKeys(t),n=Va.objectKeys(e).filter(e=>-1!==r.indexOf(e)),a={...e,...t};for(const r of n){const n=si(e[r],t[r]);if(!n.valid)return{valid:!1};a[r]=n.data}return{valid:!0,data:a}}if(r===Qa.array&&n===Qa.array){if(e.length!==t.length)return{valid:!1};const r=[];for(let n=0;n<e.length;n++){const a=si(e[n],t[n]);if(!a.valid)return{valid:!1};r.push(a.data)}return{valid:!0,data:r}}return r===Qa.date&&n===Qa.date&&+e===+t?{valid:!0,data:e}:{valid:!1}}ai.create=(e,t)=>new ai({options:e,typeName:xi.ZodUnion,...ys(t)});class ii extends _s{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),n=(e,n)=>{if(ds(e)||ds(n))return cs;const a=si(e.value,n.value);return a.valid?((hs(e)||hs(n))&&t.dirty(),{status:t.value,value:a.data}):(is(r,{code:ts.invalid_intersection_types}),cs)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([e,t])=>n(e,t)):n(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}ii.create=(e,t,r)=>new ii({left:e,right:t,typeName:xi.ZodIntersection,...ys(r)});class oi extends _s{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==Qa.array)return is(r,{code:ts.invalid_type,expected:Qa.array,received:r.parsedType}),cs;if(r.data.length<this._def.items.length)return is(r,{code:ts.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),cs;!this._def.rest&&r.data.length>this._def.items.length&&(is(r,{code:ts.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const n=[...r.data].map((e,t)=>{const n=this._def.items[t]||this._def.rest;return n?n._parse(new ms(r,e,r.path,t)):null}).filter(e=>!!e);return r.common.async?Promise.all(n).then(e=>os.mergeArray(t,e)):os.mergeArray(t,n)}get items(){return this._def.items}rest(e){return new oi({...this._def,rest:e})}}oi.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new oi({items:e,typeName:xi.ZodTuple,rest:null,...ys(t)})};class ci extends _s{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==Qa.map)return is(r,{code:ts.invalid_type,expected:Qa.map,received:r.parsedType}),cs;const n=this._def.keyType,a=this._def.valueType,s=[...r.data.entries()].map(([e,t],s)=>({key:n._parse(new ms(r,e,r.path,[s,"key"])),value:a._parse(new ms(r,t,r.path,[s,"value"]))}));if(r.common.async){const e=new Map;return Promise.resolve().then(async()=>{for(const r of s){const n=await r.key,a=await r.value;if("aborted"===n.status||"aborted"===a.status)return cs;"dirty"!==n.status&&"dirty"!==a.status||t.dirty(),e.set(n.value,a.value)}return{status:t.value,value:e}})}{const e=new Map;for(const r of s){const n=r.key,a=r.value;if("aborted"===n.status||"aborted"===a.status)return cs;"dirty"!==n.status&&"dirty"!==a.status||t.dirty(),e.set(n.value,a.value)}return{status:t.value,value:e}}}}ci.create=(e,t,r)=>new ci({valueType:t,keyType:e,typeName:xi.ZodMap,...ys(r)});class li extends _s{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==Qa.set)return is(r,{code:ts.invalid_type,expected:Qa.set,received:r.parsedType}),cs;const n=this._def;null!==n.minSize&&r.data.size<n.minSize.value&&(is(r,{code:ts.too_small,minimum:n.minSize.value,type:"set",inclusive:!0,exact:!1,message:n.minSize.message}),t.dirty()),null!==n.maxSize&&r.data.size>n.maxSize.value&&(is(r,{code:ts.too_big,maximum:n.maxSize.value,type:"set",inclusive:!0,exact:!1,message:n.maxSize.message}),t.dirty());const a=this._def.valueType;function s(e){const r=new Set;for(const n of e){if("aborted"===n.status)return cs;"dirty"===n.status&&t.dirty(),r.add(n.value)}return{status:t.value,value:r}}const i=[...r.data.values()].map((e,t)=>a._parse(new ms(r,e,r.path,t)));return r.common.async?Promise.all(i).then(e=>s(e)):s(i)}min(e,t){return new li({...this._def,minSize:{value:e,message:ss.toString(t)}})}max(e,t){return new li({...this._def,maxSize:{value:e,message:ss.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}li.create=(e,t)=>new li({valueType:e,minSize:null,maxSize:null,typeName:xi.ZodSet,...ys(t)});class ui extends _s{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}ui.create=(e,t)=>new ui({getter:e,typeName:xi.ZodLazy,...ys(t)});class di extends _s{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return is(t,{received:t.data,code:ts.invalid_literal,expected:this._def.value}),cs}return{status:"valid",value:e.data}}get value(){return this._def.value}}function hi(e,t){return new pi({values:e,typeName:xi.ZodEnum,...ys(t)})}di.create=(e,t)=>new di({value:e,typeName:xi.ZodLiteral,...ys(t)});class pi extends _s{_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),r=this._def.values;return is(t,{expected:Va.joinValues(r),received:t.parsedType,code:ts.invalid_type}),cs}if(this._cache||(this._cache=new Set(this._def.values)),!this._cache.has(e.data)){const t=this._getOrReturnCtx(e),r=this._def.values;return is(t,{received:t.data,code:ts.invalid_enum_value,options:r}),cs}return us(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return pi.create(e,{...this._def,...t})}exclude(e,t=this._def){return pi.create(this.options.filter(t=>!e.includes(t)),{...this._def,...t})}}pi.create=hi;class fi extends _s{_parse(e){const t=Va.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==Qa.string&&r.parsedType!==Qa.number){const e=Va.objectValues(t);return is(r,{expected:Va.joinValues(e),received:r.parsedType,code:ts.invalid_type}),cs}if(this._cache||(this._cache=new Set(Va.getValidEnumValues(this._def.values))),!this._cache.has(e.data)){const e=Va.objectValues(t);return is(r,{received:r.data,code:ts.invalid_enum_value,options:e}),cs}return us(e.data)}get enum(){return this._def.values}}fi.create=(e,t)=>new fi({values:e,typeName:xi.ZodNativeEnum,...ys(t)});class mi extends _s{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==Qa.promise&&!1===t.common.async)return is(t,{code:ts.invalid_type,expected:Qa.promise,received:t.parsedType}),cs;const r=t.parsedType===Qa.promise?t.data:Promise.resolve(t.data);return us(r.then(e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap})))}}mi.create=(e,t)=>new mi({type:e,typeName:xi.ZodPromise,...ys(t)});class gi extends _s{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===xi.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:r}=this._processInputParams(e),n=this._def.effect||null,a={addIssue:e=>{is(r,e),e.fatal?t.abort():t.dirty()},get path(){return r.path}};if(a.addIssue=a.addIssue.bind(a),"preprocess"===n.type){const e=n.transform(r.data,a);if(r.common.async)return Promise.resolve(e).then(async e=>{if("aborted"===t.value)return cs;const n=await this._def.schema._parseAsync({data:e,path:r.path,parent:r});return"aborted"===n.status?cs:"dirty"===n.status||"dirty"===t.value?ls(n.value):n});{if("aborted"===t.value)return cs;const n=this._def.schema._parseSync({data:e,path:r.path,parent:r});return"aborted"===n.status?cs:"dirty"===n.status||"dirty"===t.value?ls(n.value):n}}if("refinement"===n.type){const e=e=>{const t=n.refinement(e,a);if(r.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===r.common.async){const n=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===n.status?cs:("dirty"===n.status&&t.dirty(),e(n.value),{status:t.value,value:n.value})}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(r=>"aborted"===r.status?cs:("dirty"===r.status&&t.dirty(),e(r.value).then(()=>({status:t.value,value:r.value}))))}if("transform"===n.type){if(!1===r.common.async){const e=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!ps(e))return cs;const s=n.transform(e.value,a);if(s instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:s}}return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(e=>ps(e)?Promise.resolve(n.transform(e.value,a)).then(e=>({status:t.value,value:e})):cs)}Va.assertNever(n)}}gi.create=(e,t,r)=>new gi({schema:e,typeName:xi.ZodEffects,effect:t,...ys(r)}),gi.createWithPreprocess=(e,t,r)=>new gi({schema:t,effect:{type:"preprocess",transform:e},typeName:xi.ZodEffects,...ys(r)});class yi extends _s{_parse(e){return this._getType(e)===Qa.undefined?us(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}yi.create=(e,t)=>new yi({innerType:e,typeName:xi.ZodOptional,...ys(t)});class _i extends _s{_parse(e){return this._getType(e)===Qa.null?us(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}_i.create=(e,t)=>new _i({innerType:e,typeName:xi.ZodNullable,...ys(t)});class bi extends _s{_parse(e){const{ctx:t}=this._processInputParams(e);let r=t.data;return t.parsedType===Qa.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}bi.create=(e,t)=>new bi({innerType:e,typeName:xi.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...ys(t)});class wi extends _s{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},n=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return fs(n)?n.then(e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new rs(r.common.issues)},input:r.data})})):{status:"valid",value:"valid"===n.status?n.value:this._def.catchValue({get error(){return new rs(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}wi.create=(e,t)=>new wi({innerType:e,typeName:xi.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...ys(t)});class vi extends _s{_parse(e){if(this._getType(e)!==Qa.nan){const t=this._getOrReturnCtx(e);return is(t,{code:ts.invalid_type,expected:Qa.nan,received:t.parsedType}),cs}return{status:"valid",value:e.data}}}vi.create=e=>new vi({typeName:xi.ZodNaN,...ys(e)}),Symbol("zod_brand");class Oi extends _s{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class Ei extends _s{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{const e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?cs:"dirty"===e.status?(t.dirty(),ls(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})();{const e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?cs:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new Ei({in:e,out:t,typeName:xi.ZodPipeline})}}class ki extends _s{_parse(e){const t=this._def.innerType._parse(e),r=e=>(ps(e)&&(e.value=Object.freeze(e.value)),e);return fs(t)?t.then(e=>r(e)):r(t)}unwrap(){return this._def.innerType}}var xi;ki.create=(e,t)=>new ki({innerType:e,typeName:xi.ZodReadonly,...ys(t)}),ni.lazycreate,function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(xi||(xi={}));const Si=Bs.create,Ai=(qs.create,vi.create,Hs.create,Js.create,Gs.create,Ws.create,Ks.create,Vs.create,Xs.create),Ii=(Ys.create,Qs.create,ei.create,ti.create,ni.create);ni.strictCreate,ai.create,ii.create,oi.create,ci.create,li.create,ui.create,di.create,pi.create,fi.create,mi.create,gi.create,yi.create,_i.create,gi.createWithPreprocess,Ei.create;var Pi=r(4116);const $i={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var Ti,ji=new Uint8Array(16);function Ri(){if(!Ti&&!(Ti="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ti(ji)}for(var Ni=[],Ci=0;Ci<256;++Ci)Ni.push((Ci+256).toString(16).slice(1));function Li(e,t=0){return(Ni[e[t+0]]+Ni[e[t+1]]+Ni[e[t+2]]+Ni[e[t+3]]+"-"+Ni[e[t+4]]+Ni[e[t+5]]+"-"+Ni[e[t+6]]+Ni[e[t+7]]+"-"+Ni[e[t+8]]+Ni[e[t+9]]+"-"+Ni[e[t+10]]+Ni[e[t+11]]+Ni[e[t+12]]+Ni[e[t+13]]+Ni[e[t+14]]+Ni[e[t+15]]).toLowerCase()}const Mi=function(e,t,r){if($i.randomUUID&&!t&&!e)return $i.randomUUID();var n=(e=e||{}).random||(e.rng||Ri)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){r=r||0;for(var a=0;a<16;++a)t[r+a]=n[a];return t}return Li(n)},zi=Symbol.for("ls:tracing_async_local_storage"),Ui=new class{getStore(){}run(e,t){return t()}},Di=new class{getInstance(){return globalThis[zi]??Ui}initializeGlobalInstance(e){void 0===globalThis[zi]&&(globalThis[zi]=e)}};function Fi(e){return"function"==typeof e&&"langsmith:traceable"in e}Symbol.for("langsmith:traceable:root");const Bi=Object.prototype.hasOwnProperty;function Zi(e,t){return Bi.call(e,t)}function qi(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)Zi(e,r)&&t.push(r);return t}function Hi(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Ji(e){let t=0;const r=e.length;let n;for(;t<r;){if(n=e.charCodeAt(t),!(n>=48&&n<=57))return!1;t++}return!0}function Gi(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function Wi(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Ki(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(Ki(e[t]))return!0}else if("object"==typeof e){const r=qi(e),n=r.length;for(var t=0;t<n;t++)if(Ki(e[r[t]]))return!0}return!1}function Vi(e,t){const r=[e];for(const e in t){const n="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==n&&r.push(`${e}: ${n}`)}return r.join("\n")}class Xi extends Error{constructor(e,t,r,n,a){super(Vi(e,{name:t,index:r,operation:n,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=Vi(e,{name:t,index:r,operation:n,tree:a})}}const Yi=Xi,Qi=Hi,eo={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var n=e[t];return delete e[t],{newDocument:r,removed:n}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:function(e,t,r){let n=ro(r,this.path);n&&(n=Hi(n));const a=no(r,{op:"remove",path:this.from}).removed;return no(r,{op:"add",path:this.path,value:a}),{newDocument:r,removed:n}},copy:function(e,t,r){const n=ro(r,this.from);return no(r,{op:"add",path:this.path,value:Hi(n)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:co(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var to={add:function(e,t,r){return Ji(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var n=e[t];return e[t]=this.value,{newDocument:r,removed:n}},move:eo.move,copy:eo.copy,test:eo.test,_get:eo._get};function ro(e,t){if(""==t)return e;var r={op:"_get",path:t};return no(e,r),r.value}function no(e,t,r=!1,n=!0,a=!0,s=0){if(r&&("function"==typeof r?r(t,0,e,t.path):io(t,0)),""===t.path){let n={newDocument:e};if("add"===t.op)return n.newDocument=t.value,n;if("replace"===t.op)return n.newDocument=t.value,n.removed=e,n;if("move"===t.op||"copy"===t.op)return n.newDocument=ro(e,t.from),"move"===t.op&&(n.removed=e),n;if("test"===t.op){if(n.test=co(e,t.value),!1===n.test)throw new Yi("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return n.newDocument=e,n}if("remove"===t.op)return n.removed=e,n.newDocument=null,n;if("_get"===t.op)return t.value=e,n;if(r)throw new Yi("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,t,e);return n}{n||(e=Hi(e));const i=(t.path||"").split("/");let o,c,l,u=e,d=1,h=i.length;for(l="function"==typeof r?r:io;;){if(c=i[d],c&&-1!=c.indexOf("~")&&(c=Wi(c)),a&&("__proto__"==c||"prototype"==c&&d>0&&"constructor"==i[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===o&&(void 0===u[c]?o=i.slice(0,d).join("/"):d==h-1&&(o=t.path),void 0!==o&&l(t,0,e,o)),d++,Array.isArray(u)){if("-"===c)c=u.length;else{if(r&&!Ji(c))throw new Yi("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,t,e);Ji(c)&&(c=~~c)}if(d>=h){if(r&&"add"===t.op&&c>u.length)throw new Yi("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,t,e);const n=to[t.op].call(t,u,c,e);if(!1===n.test)throw new Yi("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return n}}else if(d>=h){const r=eo[t.op].call(t,u,c,e);if(!1===r.test)throw new Yi("Test operation failed","TEST_OPERATION_FAILED",s,t,e);return r}if(u=u[c],r&&d<h&&(!u||"object"!=typeof u))throw new Yi("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,t,e)}}}function ao(e,t,r,n=!0,a=!0){if(r&&!Array.isArray(t))throw new Yi("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");n||(e=Hi(e));const s=new Array(t.length);for(let n=0,i=t.length;n<i;n++)s[n]=no(e,t[n],r,!0,a,n),e=s[n].newDocument;return s.newDocument=e,s}function so(e,t,r){const n=no(e,t);if(!1===n.test)throw new Yi("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return n.newDocument}function io(e,t,r,n){if("object"!=typeof e||null===e||Array.isArray(e))throw new Yi("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(!eo[e.op])throw new Yi("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r);if("string"!=typeof e.path)throw new Yi("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new Yi('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new Yi("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new Yi("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&Ki(e.value))throw new Yi("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r)if("add"==e.op){var a=e.path.split("/").length,s=n.split("/").length;if(a!==s+1&&a!==s)throw new Yi("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==n)throw new Yi("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var i=oo([{op:"_get",path:e.from,value:void 0}],r);if(i&&"OPERATION_PATH_UNRESOLVABLE"===i.name)throw new Yi("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}function oo(e,t,r){try{if(!Array.isArray(e))throw new Yi("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)ao(Hi(t),Hi(e),r||!0);else{r=r||io;for(var n=0;n<e.length;n++)r(e[n],n,t,void 0)}}catch(e){if(e instanceof Yi)return e;throw e}}function co(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,n,a,s=Array.isArray(e),i=Array.isArray(t);if(s&&i){if((n=e.length)!=t.length)return!1;for(r=n;0!==r--;)if(!co(e[r],t[r]))return!1;return!0}if(s!=i)return!1;var o=Object.keys(e);if((n=o.length)!==Object.keys(t).length)return!1;for(r=n;0!==r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=n;0!==r--;)if(!co(e[a=o[r]],t[a]))return!1;return!0}return e!=e&&t!=t}function lo(e,t,r,n,a){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var s=qi(t),i=qi(e),o=!1,c=i.length-1;c>=0;c--){var l=e[d=i[c]];if(!Zi(t,d)||void 0===t[d]&&void 0!==l&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(a&&r.push({op:"test",path:n+"/"+Gi(d),value:Hi(l)}),r.push({op:"remove",path:n+"/"+Gi(d)}),o=!0):(a&&r.push({op:"test",path:n,value:e}),r.push({op:"replace",path:n,value:t}));else{var u=t[d];"object"==typeof l&&null!=l&&"object"==typeof u&&null!=u&&Array.isArray(l)===Array.isArray(u)?lo(l,u,r,n+"/"+Gi(d),a):l!==u&&(a&&r.push({op:"test",path:n+"/"+Gi(d),value:Hi(l)}),r.push({op:"replace",path:n+"/"+Gi(d),value:Hi(u)}))}}if(o||s.length!=i.length)for(c=0;c<s.length;c++){var d;Zi(e,d=s[c])||void 0===t[d]||r.push({op:"add",path:n+"/"+Gi(d),value:Hi(t[d])})}}}function uo(e,t,r=!1){var n=[];return lo(e,t,n,"",r),n}new WeakMap;const ho="gen_ai.request.model",po="gen_ai.usage.input_tokens",fo="gen_ai.usage.output_tokens",mo="gen_ai.usage.total_tokens",go="langsmith.span.tags",yo=(...e)=>fetch(...e),_o=Symbol.for("ls:fetch_implementation"),bo=e=>async(...t)=>{if(e||"true"===Mo("DEBUG")){const[e,r]=t;console.log(`â†’ ${r?.method||"GET"} ${e}`)}const r=await(globalThis[_o]??yo)(...t);return(e||"true"===Mo("DEBUG"))&&console.log(`â† ${r.status} ${r.statusText} ${r.url}`),r},wo=()=>Mo("PROJECT")??Lo("LANGCHAIN_SESSION")??"default";var vo=null,Oo=null,Eo=0;const ko={};function xo(e){ko[e]||(console.warn(e),ko[e]=!0)}const So=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function Ao(e,t){if(!So.test(e))throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`);return e}const Io="0.3.87";let Po;const $o=()=>"undefined"!=typeof Deno,To=()=>Po||(Po="undefined"!=typeof Bun?"bun":"undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||$o()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom")?"jsdom":$o()?"deno":"other":"node",Po);let jo,Ro;function No(){if(void 0===jo){const e=To(),t=function(){if(void 0!==Ro)return Ro;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const e=Lo(r);void 0!==e&&(t[r]=e)}return Ro=t,t}();jo={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:Io,...t}}return jo}function Co(){const e=function(){const e={};try{if("undefined"!=typeof process&&process.env)for(const[t,r]of Object.entries(process.env))(t.startsWith("LANGCHAIN_")||t.startsWith("LANGSMITH_"))&&null!=r&&((t.toLowerCase().includes("key")||t.toLowerCase().includes("secret")||t.toLowerCase().includes("token"))&&"string"==typeof r?e[t]=r.slice(0,2)+"*".repeat(r.length-4)+r.slice(-2):e[t]=r)}catch(e){}return e}(),t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(const[n,a]of Object.entries(e))"string"!=typeof a||r.includes(n)||n.toLowerCase().includes("key")||n.toLowerCase().includes("secret")||n.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===n?t.revision_id=a:t[n]=a);return t}function Lo(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function Mo(e){return Lo(`LANGSMITH_${e}`)||Lo(`LANGCHAIN_${e}`)}function zo(){return"true"===Lo("OTEL_ENABLED")||"true"===Mo("OTEL_ENABLED")}class Uo{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){let r;if(!this.hasWarned&&zo()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0),1===t.length&&"function"==typeof t[0]?r=t[0]:2===t.length&&"function"==typeof t[1]?r=t[1]:3===t.length&&"function"==typeof t[2]&&(r=t[2]),"function"==typeof r)return r()}}const Do=Symbol.for("ls:otel_trace"),Fo=Symbol.for("ls:otel_context"),Bo=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),Zo=new class{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new Uo})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}},qo=new class{active(){return{}}with(e,t){return t()}},Ho=new class{getTraceInstance(){return globalThis[Do]??Zo}getContextInstance(){return globalThis[Fo]??qo}initializeGlobalInstances(e){void 0===globalThis[Do]&&(globalThis[Do]=e.trace),void 0===globalThis[Fo]&&(globalThis[Fo]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[Bo]=e}getDefaultOTLPTracerComponents(){return globalThis[Bo]??void 0}};function Jo(){return Ho.getTraceInstance()}const Go={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};class Wo{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(const r of e)try{if(!r.run)continue;if("post"===r.operation){const e=this.createSpanForRun(r,r.run,t.get(r.id));e&&!r.run.end_time&&this.spans.set(r.id,e)}else this.updateSpanForRun(r,r.run)}catch(e){console.error(`Error processing operation ${r.id}:`,e)}}createSpanForRun(e,t,r){const n=r&&Jo().getSpan(r);if(n)try{return this.finishSpanSetup(n,t,e)}catch(t){return void console.error(`Failed to create span for run ${e.id}:`,t)}}finishSpanSetup(e,t,r){return this.setSpanAttributes(e,t,r),t.error?(e.setStatus({code:2}),e.recordException(new Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{const r=this.spans.get(e.id);if(!r)return void console.debug(`No span found for run ${e.id} during update`);this.setSpanAttributes(r,t,e),t.error?(r.setStatus({code:2}),r.recordException(new Error(t.error))):r.setStatus({code:1});const n=t.end_time;n&&(r.end(new Date(n)),this.spans.delete(e.id))}catch(t){console.error(`Failed to update span for run ${e.id}:`,t)}}extractModelName(e){if(e.extra?.metadata){const t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){const e=t.invocation_params;if(e.model)return e.model;if(e.model_name)return e.model_name}}}setSpanAttributes(e,t,r){if("run_type"in t&&t.run_type){e.setAttribute("langsmith.span.kind",t.run_type);const r=(n=t.run_type||"chain",Go[n]||n);e.setAttribute("gen_ai.operation.name",r)}var n;"name"in t&&t.name&&e.setAttribute("langsmith.trace.name",t.name),"session_id"in t&&t.session_id&&e.setAttribute("langsmith.trace.session_id",t.session_id),"session_name"in t&&t.session_name&&e.setAttribute("langsmith.trace.session_name",t.session_name),this.setGenAiSystem(e,t);const a=this.extractModelName(t);a&&e.setAttribute(ho,a),"prompt_tokens"in t&&"number"==typeof t.prompt_tokens&&e.setAttribute(po,t.prompt_tokens),"completion_tokens"in t&&"number"==typeof t.completion_tokens&&e.setAttribute(fo,t.completion_tokens),"total_tokens"in t&&"number"==typeof t.total_tokens&&e.setAttribute(mo,t.total_tokens),this.setInvocationParameters(e,t);const s=t.extra?.metadata||{};for(const[t,r]of Object.entries(s))null!=r&&e.setAttribute(`langsmith.metadata.${t}`,String(r));const i=t.tags;if(i&&Array.isArray(i)?e.setAttribute(go,i.join(", ")):i&&e.setAttribute(go,String(i)),"serialized"in t&&"object"==typeof t.serialized){const r=t.serialized;r.name&&e.setAttribute("gen_ai.serialized.name",String(r.name)),r.signature&&e.setAttribute("gen_ai.serialized.signature",String(r.signature)),r.doc&&e.setAttribute("gen_ai.serialized.doc",String(r.doc))}this.setIOAttributes(e,r)}setGenAiSystem(e,t){let r="langchain";const n=this.extractModelName(t);if(n){const e=n.toLowerCase();e.includes("anthropic")||e.startsWith("claude")?r="anthropic":e.includes("bedrock")?r="aws.bedrock":e.includes("azure")&&e.includes("openai")?r="az.ai.openai":e.includes("azure")&&e.includes("inference")?r="az.ai.inference":e.includes("cohere")?r="cohere":e.includes("deepseek")?r="deepseek":e.includes("gemini")?r="gemini":e.includes("groq")?r="groq":e.includes("watson")||e.includes("ibm")?r="ibm.watsonx.ai":e.includes("mistral")?r="mistral_ai":e.includes("gpt")||e.includes("openai")?r="openai":e.includes("perplexity")||e.includes("sonar")?r="perplexity":e.includes("vertex")?r="vertex_ai":(e.includes("xai")||e.includes("grok"))&&(r="xai")}e.setAttribute("gen_ai.system",r)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;const r=t.extra.metadata.invocation_params;void 0!==r.max_tokens&&e.setAttribute("gen_ai.request.max_tokens",r.max_tokens),void 0!==r.temperature&&e.setAttribute("gen_ai.request.temperature",r.temperature),void 0!==r.top_p&&e.setAttribute("gen_ai.request.top_p",r.top_p),void 0!==r.frequency_penalty&&e.setAttribute("gen_ai.request.frequency_penalty",r.frequency_penalty),void 0!==r.presence_penalty&&e.setAttribute("gen_ai.request.presence_penalty",r.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{const r=t.run.inputs;"object"==typeof r&&null!==r&&(r.model&&Array.isArray(r.messages)&&e.setAttribute(ho,r.model),void 0!==r.stream&&e.setAttribute("langsmith.request.streaming",r.stream),r.extra_headers&&e.setAttribute("langsmith.request.headers",JSON.stringify(r.extra_headers)),r.extra_query&&e.setAttribute("gen_ai.request.extra_query",JSON.stringify(r.extra_query)),r.extra_body&&e.setAttribute("gen_ai.request.extra_body",JSON.stringify(r.extra_body))),e.setAttribute("gen_ai.prompt",JSON.stringify(r))}catch(e){console.debug(`Failed to process inputs for run ${t.id}`,e)}if(t.run.outputs)try{const r=t.run.outputs,n=this.getUnifiedRunTokens(r);if(n&&(e.setAttribute(po,n[0]),e.setAttribute(fo,n[1]),e.setAttribute(mo,n[0]+n[1])),r&&"object"==typeof r){if(r.model&&e.setAttribute("gen_ai.response.model",String(r.model)),r.id&&e.setAttribute("gen_ai.response.id",r.id),r.choices&&Array.isArray(r.choices)){const t=r.choices.map(e=>e.finish_reason).filter(e=>e).map(String);t.length>0&&e.setAttribute("gen_ai.response.finish_reasons",t.join(", "))}if(r.service_tier&&e.setAttribute("gen_ai.response.service_tier",r.service_tier),r.system_fingerprint&&e.setAttribute("gen_ai.response.system_fingerprint",r.system_fingerprint),r.usage_metadata&&"object"==typeof r.usage_metadata){const t=r.usage_metadata;t.input_token_details&&e.setAttribute("gen_ai.usage.input_token_details",JSON.stringify(t.input_token_details)),t.output_token_details&&e.setAttribute("gen_ai.usage.output_token_details",JSON.stringify(t.output_token_details))}}e.setAttribute("gen_ai.completion",JSON.stringify(r))}catch(e){console.debug(`Failed to process outputs for run ${t.id}`,e)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;const r=Object.keys(e);for(const n of r){const r=e[n];if(r&&"object"==typeof r){if(t=this.extractUnifiedRunTokens(r.usage_metadata),t)return t;if(1===r.lc&&r.kwargs&&"object"==typeof r.kwargs&&(t=this.extractUnifiedRunTokens(r.kwargs.usage_metadata),t))return t}}const n=e.generations||[];if(!Array.isArray(n))return null;const a=Array.isArray(n[0])?n.flat():n;for(const e of a)if("object"==typeof e&&e.message&&"object"==typeof e.message&&e.message.kwargs&&"object"==typeof e.message.kwargs&&(t=this.extractUnifiedRunTokens(e.message.kwargs.usage_metadata),t))return t;return null}extractUnifiedRunTokens(e){return e&&"object"==typeof e?"number"!=typeof e.input_tokens||"number"!=typeof e.output_tokens?null:[e.input_tokens,e.output_tokens]:null}}const Ko=Object.prototype.toString,Vo=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function Xo(e,t,{min:r=0,allowInfinity:n=!1}={}){if(void 0!==t){if("number"!=typeof t||Number.isNaN(t))throw new TypeError(`Expected \`${e}\` to be a number${n?" or Infinity":""}.`);if(!n&&!Number.isFinite(t))throw new TypeError(`Expected \`${e}\` to be a finite number.`);if(t<r)throw new TypeError(`Expected \`${e}\` to be â‰¥ ${r}.`)}}class Yo extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function Qo(e,t){return Number.isFinite(t)?t-(performance.now()-e):t}async function ec({error:e,attemptNumber:t,retriesConsumed:r,startTime:n,options:a}){const s=e instanceof Error?e:new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`);if(s instanceof Yo)throw s.originalError;const i=Number.isFinite(a.retries)?Math.max(0,a.retries-r):a.retries,o=a.maxRetryTime??Number.POSITIVE_INFINITY,c=Object.freeze({error:s,attemptNumber:t,retriesLeft:i,retriesConsumed:r});if(await a.onFailedAttempt(c),Qo(n,o)<=0)throw s;const l=await a.shouldConsumeRetry(c),u=Qo(n,o);if(u<=0||i<=0)throw s;if(s instanceof TypeError&&!function(e){var t;if(!e||(t=e,"[object Error]"!==Ko.call(t))||"TypeError"!==e.name||"string"!=typeof e.message)return!1;const{message:r,stack:n}=e;return"Load failed"===r?void 0===n||"__sentry_captured__"in e:!!r.startsWith("error sending request for url")||Vo.has(r)}(s)){if(l)throw s;return a.signal?.throwIfAborted(),!1}if(!await a.shouldRetry(c))throw s;if(!l)return a.signal?.throwIfAborted(),!1;const d=function(e,t){const r=Math.max(1,e+1),n=t.randomize?Math.random()+1:1;let a=Math.round(n*t.minTimeout*t.factor**(r-1));return a=Math.min(a,t.maxTimeout),a}(r,a),h=Math.min(d,u);return h>0&&await new Promise((e,t)=>{const r=()=>{clearTimeout(n),a.signal?.removeEventListener("abort",r),t(a.signal.reason)},n=setTimeout(()=>{a.signal?.removeEventListener("abort",r),e()},h);a.unref&&n.unref?.(),a.signal?.addEventListener("abort",r,{once:!0})}),a.signal?.throwIfAborted(),!0}var tc=r(3290);const rc=[408,425,429,500,502,503,504];class nc{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxQueueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queueSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.maxQueueSizeBytes=e.maxQueueSizeBytes,this.queue=new tc.default({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){return this.callWithOptions({},e,...t)}callWithOptions(e,t,...r){const n=e.sizeBytes??0;if(void 0!==this.maxQueueSizeBytes&&n>0&&this.queueSizeBytes+n>this.maxQueueSizeBytes)return Promise.reject(new Error(`Queue size limit (${this.maxQueueSizeBytes} bytes) exceeded. Current queue size: ${this.queueSizeBytes} bytes, attempted addition: ${n} bytes.`));n>0&&(this.queueSizeBytes+=n);const a=this.onFailedResponseHook;let s=this.queue.add(()=>async function(e,t={}){if(function(e){if("number"==typeof e){if(e<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(e))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(void 0!==e)throw new TypeError("Expected `retries` to be a number or Infinity.")}((t={...t}).retries),Object.hasOwn(t,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");t.retries??=10,t.factor??=2,t.minTimeout??=1e3,t.maxTimeout??=Number.POSITIVE_INFINITY,t.maxRetryTime??=Number.POSITIVE_INFINITY,t.randomize??=!1,t.onFailedAttempt??=()=>{},t.shouldRetry??=()=>!0,t.shouldConsumeRetry??=()=>!0,Xo("factor",t.factor,{min:0,allowInfinity:!1}),Xo("minTimeout",t.minTimeout,{min:0,allowInfinity:!1}),Xo("maxTimeout",t.maxTimeout,{min:0,allowInfinity:!0}),Xo("maxRetryTime",t.maxRetryTime,{min:0,allowInfinity:!0}),t.factor>0||(t.factor=1),t.signal?.throwIfAborted();let r=0,n=0;const a=performance.now();for(;!Number.isFinite(t.retries)||n<=t.retries;){r++;try{t.signal?.throwIfAborted();const n=await e(r);return t.signal?.throwIfAborted(),n}catch(e){await ec({error:e,attemptNumber:r,retriesConsumed:n,startTime:a,options:t})&&n++}}throw new Error("Retry attempts exhausted without throwing an error.")}(()=>t(...r).catch(e=>{throw e instanceof Error?e:new Error(e)}),{async onFailedAttempt({error:e}){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||"TimeoutError"===e.name||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response;if(a&&await a(t))return;const r=t?.status??e?.status;if(r&&!rc.includes(+r))throw e},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0});return n>0&&(s=s.finally(()=>{this.queueSizeBytes-=n})),e.signal?Promise.race([s,new Promise((t,r)=>{e.signal?.addEventListener("abort",()=>{r(new Error("AbortError"))})})]):s}}function ac(e){return"function"==typeof e?._getType}function sc(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}function ic(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,r]=e.split(":"),n=r||"latest";if(t.includes("/")){const[r,a]=t.split("/",2);if(!r||!a)throw new Error(`Invalid identifier format: ${e}`);return[r,a,n]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,n]}r(7280);class oc extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function cc(e,t,r){let n;if(e.ok)return void(r&&(n=await e.text()));if(403===e.status)try{const t=await e.json(),r=t?.error;"org_scoped_key_requires_workspace"===r&&(n="This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch(t){const r=new Error(`${e.status} ${e.statusText}`);throw r.status=e?.status,r}if(void 0===n)try{n=await e.text()}catch(e){n=""}const a=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Message: ${n}`;if(409===e.status)throw new oc(a);const s=new Error(a);throw s.status=e.status,s}const lc="ERR_CONFLICTING_ENDPOINTS";class uc extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:lc}),this.name="ConflictingEndpointsError"}}var dc="[...]",hc={result:"[Circular]"},pc=[],fc=[];const mc=new TextEncoder;function gc(e){return mc.encode(e)}function yc(e){if(e&&"object"==typeof e&&null!==e){if(e instanceof Map)return Object.fromEntries(e);if(e instanceof Set)return Array.from(e);if(e instanceof Date)return e.toISOString();if(e instanceof RegExp)return e.toString();if(e instanceof Error)return{name:e.name,message:e.message}}else if("bigint"==typeof e)return e.toString();return e}function _c(e,t,r,n,a){try{return gc(JSON.stringify(e,(s=r,function(e,t){if(s){const r=s.call(this,e,t);if(void 0!==r)return r}return yc(t)}),n))}catch(s){if(!s.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."+(t?`\nContext: ${t}`:"")),gc("[Unserializable]");let i;"true"!==Mo("SUPPRESS_CIRCULAR_JSON_WARNINGS")&&console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. "+(t?`\nContext: ${t}`:"")),void 0===a&&(a={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),wc(e,"",0,[],void 0,0,a);try{i=0===fc.length?JSON.stringify(e,r,n):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,r){if(fc.length>0)for(var n=0;n<fc.length;n++){var a=fc[n];if(a[1]===t&&a[0]===r){r=a[2],fc.splice(n,1);break}}return e.call(this,t,r)}}(r),n)}catch(e){return gc("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==pc.length;){const e=pc.pop();4===e.length?Object.defineProperty(e[0],e[1],e[3]):e[0][e[1]]=e[2]}}return gc(i)}var s}function bc(e,t,r,n){var a=Object.getOwnPropertyDescriptor(n,r);void 0!==a.get?a.configurable?(Object.defineProperty(n,r,{value:e}),pc.push([n,r,t,a])):fc.push([t,r,e]):(n[r]=e,pc.push([n,r,t]))}function wc(e,t,r,n,a,s,i){var o;if(s+=1,"object"==typeof e&&null!==e){for(o=0;o<n.length;o++)if(n[o]===e)return void bc(hc,e,t,a);if(void 0!==i.depthLimit&&s>i.depthLimit)return void bc(dc,e,t,a);if(void 0!==i.edgesLimit&&r+1>i.edgesLimit)return void bc(dc,e,t,a);if(n.push(e),Array.isArray(e))for(o=0;o<e.length;o++)wc(e[o],o,o,n,e,s,i);else{e=yc(e);var c=Object.keys(e);for(o=0;o<c.length;o++){var l=c[o];wc(e[l],l,o,n,e,s,i)}}n.pop()}}function vc(e,t,r){if(r)return e;const n=No(),a=t??Co(),s=e.extra??{},i=s.metadata;return e.extra={...s,runtime:{...n,...s?.runtime},metadata:{...a,...a.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??a.revision_id}:{},...i}},e}function Oc(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Ec=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"10",10);if(t>0)return await new Promise(e=>setTimeout(e,t)),!0}return!1};function kc(e){return"number"==typeof e?Number(e.toFixed(4)):e}const xc=1073741824,Sc="https://api.smith.langchain.com";class Ac{constructor(e){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"maxSizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxSizeBytes=e??xc}peek(){return this.items[0]}push(e){let t;const r=new Promise(e=>{t=e}),n=_c(e.item,`Serializing run with id: ${e.item.id}`).length;return this.sizeBytes+n>this.maxSizeBytes&&this.items.length>0?(console.warn(`AutoBatchQueue size limit (${this.maxSizeBytes} bytes) exceeded. Dropping run with id: ${e.item.id}. Current queue size: ${this.sizeBytes} bytes, attempted addition: ${n} bytes.`),t(),r):(this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:r,size:n}),this.sizeBytes+=n,r)}pop({upToSizeBytes:e,upToSize:t}){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const r=[];let n=0;for(;n+(this.peek()?.size??0)<e&&this.items.length>0&&r.length<t;){const e=this.items.shift();e&&(r.push(e),n+=e.size,this.sizeBytes-=e.size)}if(0===r.length&&this.items.length>0){const e=this.items.shift();r.push(e),n+=e.size,this.sizeBytes-=e.size}return[r.map(e=>({action:e.action,item:e.payload,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,size:e.size})),()=>r.forEach(e=>e.itemPromiseResolve())]}}class Ic{get _fetch(){return this.fetchImplementation||bo(this.debug)}constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitTracedRuntimeInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchSizeLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===Lo("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cachedLSEnvVarsForMetadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:"true"===Lo("LANGSMITH_DEBUG")});const t=Ic.getDefaultClientConfig();if(this.tracingSampleRate=(e=>{const t=e?.toString()??Mo("TRACING_SAMPLING_RATE");if(void 0===t)return;const r=parseFloat(t);if(r<0||r>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r})(e.tracingSamplingRate),this.apiUrl=Oc(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Oc(e.apiKey??t.apiKey),this.webUrl=Oc(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=Oc(e.workspaceId??Mo("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new nc({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw new Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation;const r=e.maxIngestMemoryBytes??xc;this.batchIngestCaller=new nc({maxRetries:4,maxConcurrency:this.traceBatchConcurrency,maxQueueSizeBytes:r,...e.callerOptions??{},onFailedResponseHook:Ec,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.omitTracedRuntimeInfo=e.omitTracedRuntimeInfo??!1,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.autoBatchQueue=new Ac(r),this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.batchSizeLimit=e.batchSizeLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,zo()&&(this.langSmithToOTELTranslator=new Wo),this.cachedLSEnvVarsForMetadata=Co()}static getDefaultClientConfig(){const e=Mo("API_KEY");return{apiUrl:Mo("ENDPOINT")??Sc,apiKey:e,webUrl:void 0,hideInputs:"true"===Mo("HIDE_INPUTS"),hideOutputs:"true"===Mo("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(()=>{const e=this.apiUrl.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===e||"127.0.0.1"===e||"::1"===e})()?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.endsWith("/api/v1")?(this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("beta")?(this.webUrl="https://beta.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Io}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return"/v1"!==this.apiUrl.slice(-3)&&"/v1/"!==this.apiUrl.slice(-4)?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}async processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=await this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=t?.toString()??"",n=`${this.apiUrl}${e}?${r}`;return await this.caller.call(async()=>{const t=await this._fetch(n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,`fetch ${e}`),t})}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let n=Number(t.get("offset"))||0;const a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(n)),t.set("limit",String(a));const s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(async()=>{const t=await this._fetch(s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,`fetch ${e}`),t}),o=r?r(await i.json()):await i.json();if(0===o.length)break;if(yield o,o.length<a)break;n+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",n="runs"){const a=t?{...t}:{};for(;;){const t=JSON.stringify(a),s=await this.caller.call(async()=>{const n=await this._fetch(`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await cc(n,`fetch ${e}`),n}),i=await s.json();if(!i)break;if(!i[n])break;yield i[n];const o=i.cursors;if(!o)break;if(!o.next)break;a.cursor=o.next}}_shouldSample(){return void 0===this.tracingSampleRate||Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const r of e)this.filteredPostUuids.has(r.trace_id)?r.id===r.trace_id&&this.filteredPostUuids.delete(r.trace_id):t.push(r);return t}{const t=[];for(const r of e){const e=r.trace_id??r.id;this.filteredPostUuids.has(e)||(r.id===e?this._shouldSample()?t.push(r):this.filteredPostUuids.add(e):t.push(r))}return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??25165824}async _getBatchSizeLimit(){const e=await this._ensureServerInfo();return this.batchSizeLimit??e.batch_ingest_config?.size_limit??100}async _getDatasetExamplesMultiPartSupport(){const e=await this._ensureServerInfo();return e.instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t}){const r=[];for(;this.autoBatchQueue.items.length>0;){const[n,a]=this.autoBatchQueue.pop({upToSizeBytes:e,upToSize:t});if(!n.length){a();break}const s=n.reduce((e,t)=>{const r=t.apiUrl??this.apiUrl,n=t.apiKey??this.apiKey,a=t.apiKey===this.apiKey&&t.apiUrl===this.apiUrl?"default":`${r}|${n}`;return e[a]||(e[a]=[]),e[a].push(t),e},{}),i=[];for(const[e,t]of Object.entries(s)){const r=this._processBatch(t,{apiUrl:"default"===e?void 0:e.split("|")[0],apiKey:"default"===e?void 0:e.split("|")[1]});i.push(r)}const o=Promise.all(i).finally(a);r.push(o)}return Promise.all(r)}async _processBatch(e,t){if(!e.length)return;const r=e.reduce((e,t)=>e+(t.size??0),0);try{if(void 0!==this.langSmithToOTELTranslator)this._sendBatchToOTELTranslator(e);else{const n={runCreates:e.filter(e=>"create"===e.action).map(e=>e.item),runUpdates:e.filter(e=>"update"===e.action).map(e=>e.item)},a=await this._ensureServerInfo();if(a?.batch_ingest_config?.use_multipart_endpoint){const e=a?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(n,{...t,useGzip:e,sizeBytes:r})}else await this.batchIngestRuns(n,{...t,sizeBytes:r})}}catch(e){console.error("Error exporting batch:",e)}}_sendBatchToOTELTranslator(e){if(void 0!==this.langSmithToOTELTranslator){const t=new Map,r=[];for(const n of e)n.item.id&&n.otelContext&&(t.set(n.item.id,n.otelContext),"create"===n.action?r.push({operation:"post",id:n.item.id,trace_id:n.item.trace_id??n.item.id,run:n.item}):r.push({operation:"patch",id:n.item.id,trace_id:n.item.trace_id??n.item.id,run:n.item}));this.langSmithToOTELTranslator.exportBatch(r,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=vc(e.item,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);const t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;const r=await this._getBatchSizeLimitBytes(),n=await this._getBatchSizeLimit();return(this.autoBatchQueue.sizeBytes>r||this.autoBatchQueue.items.length>n)&&this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:n}),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue({batchSizeLimitBytes:r,batchSizeLimit:n})},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){const e=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e4),...this.fetchOptions});return await cc(e,"get server info"),e}),t=await e.json();return this.debug&&console.log("\n=== LangSmith Server Configuration ===\n"+JSON.stringify(t,null,2)+"\n"),t}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){const e=await this._getBatchSizeLimitBytes(),t=await this._getBatchSizeLimit();await this.drainAutoBatchQueue({batchSizeLimitBytes:e,batchSizeLimit:t})}_cloneCurrentOTELContext(){const e=Jo(),t=Ho.getContextInstance();if(void 0!==this.langSmithToOTELTranslator){const r=e.getActiveSpan();if(r)return e.setSpan(t.active(),r)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;const r={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const a=await this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==a.trace_id&&void 0!==a.dotted_order){const e=this._cloneCurrentOTELContext();return void this.processRunOperation({action:"create",item:a,otelContext:e,apiKey:t?.apiKey,apiUrl:t?.apiUrl}).catch(console.error)}const s=vc(a,this.cachedLSEnvVarsForMetadata,this.omitTracedRuntimeInfo);void 0!==t?.apiKey&&(r["x-api-key"]=t.apiKey),void 0!==t?.workspaceId&&(r["x-tenant-id"]=t.workspaceId);const i=_c(s,`Creating run with id: ${s.id}`);await this.caller.call(async()=>{const e=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await cc(e,"create run",!0),e})}async batchIngestRuns({runCreates:e,runUpdates:t},r){if(void 0===e&&void 0===t)return;let n=await Promise.all(e?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]),a=await Promise.all(t?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]);if(n.length>0&&a.length>0){const e=n.reduce((e,t)=>t.id?(e[t.id]=t,e):e,{}),t=[];for(const r of a)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);n=Object.values(e),a=t}const s={post:n,patch:a};if(!s.post.length&&!s.patch.length)return;const i={post:[],patch:[]};for(const e of["post","patch"]){const t=e,r=s[t].reverse();let n=r.pop();for(;void 0!==n;)i[t].push(n),n=r.pop()}if(i.post.length>0||i.patch.length>0){const e=i.post.map(e=>e.id).concat(i.patch.map(e=>e.id)).join(",");await this._postBatchIngestRuns(_c(i,`Ingesting runs with ids: ${e}`),r)}}async _postBatchIngestRuns(e,t){const r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};void 0!==t?.apiKey&&(r["x-api-key"]=t.apiKey),await this.batchIngestCaller.callWithOptions({sizeBytes:t?.sizeBytes},async()=>{const n=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await cc(n,"batch create run",!0),n})}async multipartIngestRuns({runCreates:e,runUpdates:t},r){if(void 0===e&&void 0===t)return;const n={};let a=[];for(const t of e??[]){const e=await this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(n[e.id]=e.attachments),delete e.attachments,a.push(e)}let s=[];for(const e of t??[])s.push(await this.prepareRunCreateOrUpdateInputs(e));if(void 0!==a.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==s.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(a.length>0&&s.length>0){const e=a.reduce((e,t)=>t.id?(e[t.id]=t,e):e,{}),t=[];for(const r of s)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);a=Object.values(e),s=t}if(0===a.length&&0===s.length)return;const i=[],o=[];for(const[e,t]of[["post",a],["patch",s]])for(const r of t){const{inputs:t,outputs:a,events:s,extra:c,error:l,serialized:u,attachments:d,...h}=r,p={inputs:t,outputs:a,events:s,extra:c,error:l,serialized:u},f=_c(h,`Serializing for multipart ingestion of run with id: ${h.id}`);o.push({name:`${e}.${h.id}`,payload:new Blob([f],{type:`application/json; length=${f.length}`})});for(const[t,r]of Object.entries(p)){if(void 0===r)continue;const n=_c(r,`Serializing ${t} for multipart ingestion of run with id: ${h.id}`);o.push({name:`${e}.${h.id}.${t}`,payload:new Blob([n],{type:`application/json; length=${n.length}`})})}if(void 0!==h.id){const e=n[h.id];if(e){delete n[h.id];for(const[t,r]of Object.entries(e)){let e,n;Array.isArray(r)?[e,n]=r:(e=r.mimeType,n=r.data),t.includes(".")?console.warn(`Skipping attachment '${t}' for run ${h.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`):o.push({name:`attachment.${h.id}.${t}`,payload:new Blob([n],{type:`${e}; length=${n.byteLength}`})})}}}i.push(`trace=${h.trace_id},id=${h.id}`)}await this._sendMultipartRequest(o,i.join("; "),r)}async _createNodeFetchBody(e,t){const r=[];for(const n of e)r.push(new Blob([`--${t}\r\n`])),r.push(new Blob([`Content-Disposition: form-data; name="${n.name}"\r\n`,`Content-Type: ${n.payload.type}\r\n\r\n`])),r.push(n.payload),r.push(new Blob(["\r\n"]));r.push(new Blob([`--${t}--\r\n`]));const n=new Blob(r);return await n.arrayBuffer()}async _createMultipartStream(e,t){const r=new TextEncoder;return new ReadableStream({async start(n){const a=async e=>{"string"==typeof e?n.enqueue(r.encode(e)):n.enqueue(e)};for(const r of e){await a(`--${t}\r\n`),await a(`Content-Disposition: form-data; name="${r.name}"\r\n`),await a(`Content-Type: ${r.payload.type}\r\n\r\n`);const e=r.payload.stream().getReader();try{let t;for(;!(t=await e.read()).done;)n.enqueue(t.value)}finally{e.releaseLock()}await a("\r\n")}await a(`--${t}--\r\n`),n.close()}})}async _sendMultipartRequest(e,t,r){const n="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),a=(()=>{const e=globalThis[_o];return!!e&&"function"==typeof e&&"Headers"in e&&"Request"in e&&"Response"in e})(),s=()=>this._createNodeFetchBody(e,n),i=()=>this._createMultipartStream(e,n),o=async e=>this.batchIngestCaller.callWithOptions({sizeBytes:r?.sizeBytes},async()=>{const t=await e(),a={...this.headers,"Content-Type":`multipart/form-data; boundary=${n}`};void 0!==r?.apiKey&&(a["x-api-key"]=r.apiKey);let s=t;r?.useGzip&&"object"==typeof t&&"pipeThrough"in t&&(s=t.pipeThrough(new CompressionStream("gzip")),a["Content-Encoding"]="gzip");const i=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:a,body:s,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(i,"Failed to send multipart request",!0),i});try{let e,n=!1;a||this.multipartStreamingDisabled||"bun"===To()?e=await o(s):(n=!0,e=await o(i)),this.multipartStreamingDisabled&&!n||422!==e.status||(r?.apiUrl??this.apiUrl)===Sc||(console.warn(`Streaming multipart upload to ${r?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${t}".`),this.multipartStreamingDisabled=!0,e=await o(s))}catch(e){console.warn(`${e.message.trim()}\n\nContext: ${t}`)}}async updateRun(e,t,r){Ao(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));const n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order){const e=this._cloneCurrentOTELContext();return void 0!==t.end_time&&void 0===n.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:n,otelContext:e,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error):void this.processRunOperation({action:"update",item:n,otelContext:e,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error)}const a={...this.headers,"Content-Type":"application/json"};void 0!==r?.apiKey&&(a["x-api-key"]=r.apiKey),void 0!==r?.workspaceId&&(a["x-tenant-id"]=r.workspaceId);const s=_c(t,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{const t=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await cc(t,"update run",!0),t})}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Ao(e);let r=await this._get(`/runs/${e}`);return t&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;e=t.session_id?t.session_id:r?.projectName?(await this.readProject({projectName:r?.projectName})).id:r?.projectId?r?.projectId:(await this.readProject({projectName:Mo("PROJECT")||"default"})).id;const n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const r of e)t.push(r);return t}(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),r={},n={};t.sort((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??""));for(const a of t){if(null===a.parent_run_id||void 0===a.parent_run_id)throw new Error(`Child run ${a.id} has no parent`);a.dotted_order?.startsWith(e.dotted_order??"")&&a.id!==e.id&&(a.parent_run_id in r||(r[a.parent_run_id]=[]),r[a.parent_run_id].push(a),n[a.id]=a)}e.child_runs=r[e.id]||[];for(const t in r)t!==e.id&&(n[t].child_runs=r[t]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:n,traceId:a,referenceExampleId:s,startTime:i,executionOrder:o,isRoot:c,runType:l,error:u,id:d,query:h,filter:p,traceFilter:f,treeFilter:m,limit:g,select:y,order:_}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),r){const e=Array.isArray(r)?r:[r],t=await Promise.all(e.map(e=>this.readProject({projectName:e}).then(e=>e.id)));b.push(...t)}const w={session:b.length?b:null,run_type:l,reference_example:s,query:h,filter:p,trace_filter:f,tree_filter:m,execution_order:o,parent_run:n,start_time:i?i.toISOString():null,error:u,id:d,limit:g,trace:a,select:y||["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c,order:_};w.select.includes("child_run_ids")&&xo("Deprecated: 'child_run_ids' in the listRuns select parameter is deprecated and will be removed in a future version.");let v=0;for await(const e of this._getCursorPaginatedList("/runs/query",w))if(g){if(v>=g)break;if(e.length+v>g){const t=e.slice(0,g-v);yield*t;break}v+=e.length,yield*e}else yield*e}async*listGroupRuns(e){const{projectId:t,projectName:r,groupBy:n,filter:a,startTime:s,endTime:i,limit:o,offset:c}=e,l={session_id:t||(await this.readProject({projectName:r})).id,group_by:n,filter:a,start_time:s?s.toISOString():null,end_time:i?i.toISOString():null,limit:Number(o)||100};let u=Number(c)||0;const d="/runs/group",h=`${this.apiUrl}${d}`;for(;;){const e={...l,offset:u},t=Object.fromEntries(Object.entries(e).filter(([e,t])=>void 0!==t)),r=JSON.stringify(t),n=await this.caller.call(async()=>{const e=await this._fetch(h,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await cc(e,`Failed to fetch ${d}`),e}),a=await n.json(),{groups:s,total:i}=a;if(0===s.length)break;for(const e of s)yield e;if(u+=s.length,u>=i)break}}async getRunStats({id:e,trace:t,parentRun:r,runType:n,projectNames:a,projectIds:s,referenceExampleIds:i,startTime:o,endTime:c,error:l,query:u,filter:d,traceFilter:h,treeFilter:p,isRoot:f,dataSourceType:m}){let g=s||[];a&&(g=[...s||[],...await Promise.all(a.map(e=>this.readProject({projectName:e}).then(e=>e.id)))]);const y={id:e,trace:t,parent_run:r,run_type:n,session:g,reference_example:i,start_time:o,end_time:c,error:l,query:u,filter:d,trace_filter:h,tree_filter:p,is_root:f,data_source_type:m},_=Object.fromEntries(Object.entries(y).filter(([e,t])=>void 0!==t)),b=JSON.stringify(_),w=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:b});return await cc(e,"get run stats"),e});return await w.json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||Mi()};Ao(e);const n=JSON.stringify(r),a=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await cc(t,"share run"),t}),s=await a.json();if(null===s||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){Ao(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"unshare run",!0),t})}async readRunSharedLink(e){Ao(e);const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"read run shared link"),t}),r=await t.json();if(null!==r&&"share_token"in r)return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)r.append("id",e);Ao(e);const n=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"list shared runs"),t});return await n.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){const r=await this.readDataset({datasetName:t});e=r.id}Ao(e);const r=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"read dataset shared schema"),t}),n=await r.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){const r=await this.readDataset({datasetName:t});e=r.id}const r={dataset_id:e};Ao(e);const n=JSON.stringify(r),a=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await cc(t,"share dataset"),t}),s=await a.json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){Ao(e),await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"unshare dataset",!0),t})}async readSharedDataset(e){Ao(e);const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"read shared dataset"),t});return await t.json()}async listSharedExamples(e,t){const r={};t?.exampleIds&&(r.id=t.exampleIds);const n=new URLSearchParams;Object.entries(r).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>n.append(e,t)):n.append(e,t)});const a=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/public/${e}/examples?${n.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"list shared examples"),t}),s=await a.json();if(!a.ok){if("detail"in s)throw new Error(`Failed to list shared examples.\nStatus: ${a.status}\nMessage: ${Array.isArray(s.detail)?s.detail.join("\n"):"Unspecified error"}`);throw new Error(`Failed to list shared examples: ${a.status} ${a.statusText}`)}return s.map(e=>({...e,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:n=!1,projectExtra:a=null,referenceDatasetId:s=null}){const i=n?"?upsert=true":"",o=`${this.apiUrl}/sessions${i}`,c=a||{};r&&(c.metadata=r);const l={name:e,extra:c,description:t};null!==s&&(l.reference_dataset_id=s);const u=JSON.stringify(l),d=await this.caller.call(async()=>{const e=await this._fetch(o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await cc(e,"create project"),e});return await d.json()}async updateProject(e,{name:t=null,description:r=null,metadata:n=null,projectExtra:a=null,endTime:s=null}){const i=`${this.apiUrl}/sessions/${e}`;let o=a;n&&(o={...o||{},metadata:n});const c=JSON.stringify({name:t,extra:o,description:r,end_time:s?new Date(s).toISOString():null}),l=await this.caller.call(async()=>{const e=await this._fetch(i,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await cc(e,"update project"),e});return await l.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Ao(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");n.append("name",t)}const a=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${r}?${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,"has project"),e});try{const e=await a.json();return!!a.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let n="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Ao(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}void 0!==r&&a.append("include_stats",r.toString());const s=await this._get(n,a);let i;if(Array.isArray(s)){if(0===s.length)throw new Error(`Project[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),n=await this._getTenantId();return`${this.getHostUrl()}/o/${n}/datasets/${r.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:n,referenceDatasetName:a,includeStats:s,datasetVersion:i,referenceFree:o,metadata:c}={}){const l=new URLSearchParams;if(void 0!==e)for(const t of e)l.append("id",t);if(void 0!==t&&l.append("name",t),void 0!==r&&l.append("name_contains",r),void 0!==n)l.append("reference_dataset",n);else if(void 0!==a){const e=await this.readDataset({datasetName:a});l.append("reference_dataset",e.id)}void 0!==s&&l.append("include_stats",s.toString()),void 0!==i&&l.append("dataset_version",i),void 0!==o&&l.append("reference_free",o.toString()),void 0!==c&&l.append("metadata",JSON.stringify(c));for await(const e of this._getPaginated("/sessions",l))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");r=void 0===e?(await this.readProject({projectName:t})).id:e,Ao(r),await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,`delete session ${r} (${t})`,!0),e})}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:n,description:a,dataType:s,name:i}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(e=>{c.append("input_keys",e)}),n.forEach(e=>{c.append("output_keys",e)}),a&&c.append("description",a),s&&c.append("data_type",s),i&&c.append("name",i);const l=await this.caller.call(async()=>{const e=await this._fetch(o,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await cc(e,"upload CSV"),e});return await l.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:n,outputsSchema:a,metadata:s}={}){const i={name:e,description:t,extra:s?{metadata:s}:void 0};r&&(i.data_type=r),n&&(i.inputs_schema_definition=n),a&&(i.outputs_schema_definition=a);const o=JSON.stringify(i),c=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await cc(e,"create dataset"),e});return await c.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const n=new URLSearchParams({limit:"1"});if(e&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(e)Ao(e),r+=`/${e}`;else{if(!t)throw new Error("Must provide datasetName or datasetId");n.append("name",t)}const a=await this._get(r,n);let s;if(Array.isArray(a)){if(0===a.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);s=a[0]}else s=a;return s}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:n}){let a=e;if(void 0===a&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==a&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");void 0===a&&(a=(await this.readDataset({datasetName:t})).id);const s=new URLSearchParams({from_version:"string"==typeof r?r:r.toISOString(),to_version:"string"==typeof n?n:n.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,s)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide either datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const r=await this._getResponse(`/datasets/${e}/openai_ft`);return(await r.text()).trim().split("\n").map(e=>JSON.parse(e))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:n,datasetNameContains:a,metadata:s}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(const e of r)i.append("id",e);void 0!==n&&i.append("name",n),void 0!==a&&i.append("name_contains",a),void 0!==s&&i.append("metadata",JSON.stringify(s));for await(const e of this._getPaginated("/datasets",i))yield*e}async updateDataset(e){const{datasetId:t,datasetName:r,...n}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const a=t??(await this.readDataset({datasetName:r})).id;Ao(a);const s=JSON.stringify(n),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await cc(e,"update dataset"),e});return await i.json()}async updateDatasetTag(e){const{datasetId:t,datasetName:r,asOf:n,tag:a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:r})).id;Ao(s);const i=JSON.stringify({as_of:"string"==typeof n?n:n.toISOString(),tag:a});await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${s}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await cc(e,"update dataset tags",!0),e})}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",n=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(n=(await this.readDataset({datasetName:t})).id),void 0===n)throw new Error("Must provide datasetName or datasetId");Ao(n),r+=`/${n}`,await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,`delete ${r}`,!0),e})}async indexDataset({datasetId:e,datasetName:t,tag:r}){let n=e;if(!n&&!t)throw new Error("Must provide either datasetName or datasetId");if(n&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(!n){const e=await this.readDataset({datasetName:t});n=e.id}Ao(n);const a={tag:r},s=JSON.stringify(a),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${n}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await cc(e,"index dataset"),e});await i.json()}async similarExamples(e,t,r,{filter:n}={}){const a={limit:r,inputs:e};void 0!==n&&(a.filter=n),Ao(t);const s=JSON.stringify(a),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:s});return await cc(e,"fetch similar examples"),e});return(await i.json()).examples}async createExample(e,t,r){if(Pc(e)&&(void 0!==t||void 0!==r))throw new Error("Cannot provide outputs or options when using ExampleCreate object");let n=t?r?.datasetId:e.dataset_id;const a=t?r?.datasetName:e.dataset_name;if(void 0===n&&void 0===a)throw new Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==a)throw new Error("Must provide either datasetName or datasetId, not both");void 0===n&&(n=(await this.readDataset({datasetName:a})).id);const s=(t?r?.createdAt:e.created_at)||new Date;let i;i=Pc(e)?e:{inputs:e,outputs:t,created_at:s?.toISOString(),id:r?.exampleId,metadata:r?.metadata,split:r?.split,source_run_id:r?.sourceRunId,use_source_run_io:r?.useSourceRunIO,use_source_run_attachments:r?.useSourceRunAttachments,attachments:r?.attachments};const o=await this._uploadExamplesMultipart(n,[i]);return await this.readExample(o.example_ids?.[0]??Mi())}async createExamples(e){if(Array.isArray(e)){if(0===e.length)return[];const t=e;let r=t[0].dataset_id;const n=t[0].dataset_name;if(void 0===r&&void 0===n)throw new Error("Must provide either datasetName or datasetId");if(void 0!==r&&void 0!==n)throw new Error("Must provide either datasetName or datasetId, not both");void 0===r&&(r=(await this.readDataset({datasetName:n})).id);const a=await this._uploadExamplesMultipart(r,t);return await Promise.all(a.example_ids.map(e=>this.readExample(e)))}const{inputs:t,outputs:r,metadata:n,splits:a,sourceRunIds:s,useSourceRunIOs:i,useSourceRunAttachments:o,attachments:c,exampleIds:l,datasetId:u,datasetName:d}=e;if(void 0===t)throw new Error("Must provide inputs when using legacy parameters");let h=u;const p=d;if(void 0===h&&void 0===p)throw new Error("Must provide either datasetName or datasetId");if(void 0!==h&&void 0!==p)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===h){const e=await this.readDataset({datasetName:p});h=e.id}const f=t.map((e,t)=>({dataset_id:h,inputs:e,outputs:r?.[t],metadata:n?.[t],split:a?.[t],id:l?.[t],attachments:c?.[t],source_run_id:s?.[t],use_source_run_io:i?.[t],use_source_run_attachments:o?.[t]})),m=await this._uploadExamplesMultipart(h,f);return await Promise.all(m.example_ids.map(e=>this.readExample(e)))}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const n=e.map(e=>ac(e)?sc(e):e),a=ac(t)?sc(t):t;return this.createExample({input:n},{output:a},r)}async readExample(e){Ao(e);const t=`/examples/${e}`,r=await this._get(t),{attachment_urls:n,...a}=r,s=a;return n&&(s.attachments=Object.entries(n).reduce((e,[t,r])=>(e[t.slice(11)]={presigned_url:r.presigned_url,mime_type:r.mime_type},e),{})),s}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:n,splits:a,inlineS3Urls:s,metadata:i,limit:o,offset:c,filter:l,includeAttachments:u}={}){let d;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");d=(await this.readDataset({datasetName:t})).id}const h=new URLSearchParams({dataset:d}),p=n?"string"==typeof n?n:n?.toISOString():void 0;p&&h.append("as_of",p);const f=s??!0;if(h.append("inline_s3_urls",f.toString()),void 0!==r)for(const e of r)h.append("id",e);if(void 0!==a)for(const e of a)h.append("splits",e);if(void 0!==i){const e=JSON.stringify(i);h.append("metadata",e)}void 0!==o&&h.append("limit",o.toString()),void 0!==c&&h.append("offset",c.toString()),void 0!==l&&h.append("filter",l),!0===u&&["attachment_urls","outputs","metadata"].forEach(e=>h.append("select",e));let m=0;for await(const e of this._getPaginated("/examples",h)){for(const t of e){const{attachment_urls:e,...r}=t,n=r;e&&(n.attachments=Object.entries(e).reduce((e,[t,r])=>(e[t.slice(11)]={presigned_url:r.presigned_url,mime_type:r.mime_type||void 0},e),{})),yield n,m++}if(void 0!==o&&m>=o)break}}async deleteExample(e){Ao(e);const t=`/examples/${e}`;await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,`delete ${t}`,!0),e})}async deleteExamples(e,t){if(e.forEach(e=>Ao(e)),t?.hardDelete){const t=this._getPlatformEndpointPath("datasets/examples/delete");await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}${t}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({example_ids:e,hard_delete:!0}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(r,"hard delete examples",!0),r})}else{const t=new URLSearchParams;e.forEach(e=>t.append("example_ids",e)),await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/examples?${t.toString()}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,"delete examples",!0),e})}}async updateExample(e,t){let r,n,a;return r=t?e:e.id,Ao(r),n=t?{id:r,...t}:e,a=void 0!==n.dataset_id?n.dataset_id:(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(a,[n])}async updateExamples(e){let t;return t=void 0===e[0].dataset_id?(await this.readExample(e[0].id)).dataset_id:e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:r,tag:n}){let a;if(e)a=e;else{const e=await this.readDataset({datasetName:t});a=e.id}if(Ao(a),r&&n||!r&&!n)throw new Error("Exactly one of asOf and tag must be specified.");const s=new URLSearchParams;void 0!==r&&s.append("as_of","string"==typeof r?r:r.toISOString()),void 0!==n&&s.append("tag",n);const i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${a}/version?${s.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,"read dataset version"),e});return await i.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");n=void 0===e?(await this.readDataset({datasetName:t})).id:e,Ao(n);const a=new URLSearchParams,s=r?"string"==typeof r?r:r?.toISOString():void 0;return s&&a.append("as_of",s),await this._get(`/datasets/${n}/splits`,a)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:n,remove:a=!1}){let s;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){const e=await this.readDataset({datasetName:t});s=e.id}else s=e;Ao(s);const i={split_name:r,examples:n.map(e=>(Ao(e),e)),remove:a},o=JSON.stringify(i);await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/${s}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await cc(e,"update dataset splits",!0),e})}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:n,referenceExample:a}={loadChildRuns:!1}){let s;if(xo("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)s=await this.readRun(e,{loadChildRuns:n});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);s=e}null!==s.reference_example_id&&void 0!==s.reference_example_id&&(a=await this.readExample(s.reference_example_id));const i=await t.evaluateRun(s,a),[o,c]=await this._logEvaluationFeedback(i,s,r);return c[0]}async createFeedback(e,t,{score:r,value:n,correction:a,comment:s,sourceInfo:i,feedbackSourceType:o="api",sourceRunId:c,feedbackId:l,feedbackConfig:u,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const p={type:o??"api",metadata:i??{}};void 0===c||void 0===p?.metadata||p.metadata.__run||(p.metadata.__run={run_id:c}),void 0!==p?.metadata&&void 0!==p.metadata.__run?.run_id&&Ao(p.metadata.__run.run_id);const f={id:l??Mi(),run_id:e,key:t,score:kc(r),value:n,correction:a,comment:s,feedback_source:p,comparative_experiment_id:h,feedbackConfig:u,session_id:d},m=JSON.stringify(f),g=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{const e=await this._fetch(g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:m});return await cc(e,"create feedback",!0),e}),f}async updateFeedback(e,{score:t,value:r,correction:n,comment:a}){const s={};null!=t&&(s.score=kc(t)),null!=r&&(s.value=r),null!=n&&(s.correction=n),null!=a&&(s.comment=a),Ao(e);const i=JSON.stringify(s);await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await cc(t,"update feedback",!0),t})}async readFeedback(e){Ao(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Ao(e);const t=`/feedback/${e}`;await this.caller.call(async()=>{const e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,`delete ${t}`,!0),e})}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const n=new URLSearchParams;if(e)for(const t of e)Ao(t),n.append("run",t);if(t)for(const e of t)n.append("key",e);if(r)for(const e of r)n.append("source",e);for await(const e of this._getPaginated("/feedback",n))yield*e}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:n}={}){const a={run_id:e,feedback_key:t,feedback_config:n};r?"string"==typeof r?a.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(a.expires_in=r):a.expires_in={hours:3};const s=JSON.stringify(a),i=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await cc(e,"create presigned feedback token"),e});return await i.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:n,description:a,metadata:s,id:i}){if(0===t.length)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!r)throw new Error("A reference dataset is required");const o={id:i,name:e,experiment_ids:t,reference_dataset_id:r,description:a,created_at:(n??new Date)?.toISOString(),extra:{}};s&&(o.extra.metadata=s);const c=JSON.stringify(o);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await cc(e,"create comparative experiment"),e})).json()}async*listPresignedFeedbackTokens(e){Ao(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:Array.isArray(e)?e:[e],t}async _logEvaluationFeedback(e,t,r){const n=this._selectEvalResults(e),a=[];for(const e of n){let n=r||{};e.evaluatorInfo&&(n={...e.evaluatorInfo,...n});let s=null;e.targetRunId?s=e.targetRunId:t&&(s=t.id),a.push(await this.createFeedback(s,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:n,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[n,a]}async logEvaluationFeedback(e,t,r){const[n]=await this._logEvaluationFeedback(e,t,r);return n}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:n,limit:a}=e,s=new URLSearchParams;t&&t.forEach((e,t)=>{Ao(e,`queueIds[${t}]`),s.append("ids",e)}),r&&s.append("name",r),n&&s.append("name_contains",n),s.append("limit",(void 0!==a?Math.min(a,100):100).toString());let i=0;for await(const e of this._getPaginated("/annotation-queues",s))if(yield*e,i++,void 0!==a&&i>=a)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:n,rubricInstructions:a}=e,s={name:t,description:r,id:n||Mi(),rubric_instructions:a},i=JSON.stringify(Object.fromEntries(Object.entries(s).filter(([e,t])=>void 0!==t)));return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await cc(e,"create annotation queue"),e})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Ao(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"read annotation queue"),t})).json()}async updateAnnotationQueue(e,t){const{name:r,description:n,rubricInstructions:a}=t,s=JSON.stringify({name:r,description:n,rubric_instructions:a});await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Ao(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await cc(t,"update annotation queue",!0),t})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Ao(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"delete annotation queue",!0),t})}async addRunsToAnnotationQueue(e,t){const r=JSON.stringify(t.map((e,t)=>Ao(e,`runIds[${t}]`).toString()));await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Ao(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await cc(t,"add runs to annotation queue",!0),t})}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${Ao(e,"queueId")}/run`;return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,"get run from annotation queue"),e})).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call(async()=>{const r=await this._fetch(`${this.apiUrl}/annotation-queues/${Ao(e,"queueId")}/runs/${Ao(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(r,"delete run from annotation queue",!0),r})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/annotation-queues/${Ao(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"get size from annotation queue"),t})).json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${r.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(t,"get latest commit hash"),t}),r=await t.json();if(0!==r.commits.length)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,n,a]=ic(e),s=JSON.stringify({like:t});return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/likes/${r}/${n}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await cc(e,(t?"like":"unlike")+" prompt"),e})).json()}async _getPromptUrl(e){const[t,r,n]=ic(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==n?`${this.getHostUrl()}/prompts/${r}/${n.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${e.id}`}return"latest"!==n?`${this.getHostUrl()}/hub/${t}/${r}/${n.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,e=>e.commits))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,e=>e.repos))yield*e}async getPrompt(e){const[t,r,n]=ic(e),a=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return 404===e?.status?null:(await cc(e,"get prompt"),e)}),s=await(a?.json());return s?.repo?s.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle.\n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[n,a,s]=ic(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("create a prompt",n);const i={repo_handle:a,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},o=JSON.stringify(i),c=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await cc(e,"create prompt"),e}),{repo:l}=await c.json();return l}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,a,s]=ic(e),i="latest"!==r?.parentCommitHash&&r?.parentCommitHash?r?.parentCommitHash:await this._getLatestCommitHash(`${n}/${a}`),o={manifest:JSON.parse(JSON.stringify(t)),parent_commit:i},c=JSON.stringify(o),l=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/commits/${n}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:c});return await cc(e,"create commit"),e}),u=await l.json();return this._getPromptUrl(`${n}/${a}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const e of t){const t=e.id,n=_c({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}},`Serializing body for example with id: ${t}`),a=new Blob([n],{type:"application/json"});if(r.append(t,a),e.inputs){const n=_c(e.inputs,`Serializing inputs for example with id: ${t}`),a=new Blob([n],{type:"application/json"});r.append(`${t}.inputs`,a)}if(e.outputs){const n=_c(e.outputs,`Serializing outputs whle updating example with id: ${t}`),a=new Blob([n],{type:"application/json"});r.append(`${t}.outputs`,a)}if(e.attachments)for(const[n,a]of Object.entries(e.attachments)){let e,s;Array.isArray(a)?[e,s]=a:(e=a.mimeType,s=a.data);const i=new Blob([s],{type:`${e}; length=${s.byteLength}`});r.append(`${t}.attachment.${n}`,i)}if(e.attachments_operations){const n=_c(e.attachments_operations,`Serializing attachments while updating example with id: ${t}`),a=new Blob([n],{type:"application/json"});r.append(`${t}.attachments_operations`,a)}}const n=e??t[0]?.dataset_id;return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${n}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await cc(e,"update examples"),e})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw new Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");const r=new FormData;for(const e of t){const t=(e.id??Mi()).toString(),n=_c({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split},...e.source_run_id&&{source_run_id:e.source_run_id},...e.use_source_run_io&&{use_source_run_io:e.use_source_run_io},...e.use_source_run_attachments&&{use_source_run_attachments:e.use_source_run_attachments}},`Serializing body for uploaded example with id: ${t}`),a=new Blob([n],{type:"application/json"});if(r.append(t,a),e.inputs){const n=_c(e.inputs,`Serializing inputs for uploaded example with id: ${t}`),a=new Blob([n],{type:"application/json"});r.append(`${t}.inputs`,a)}if(e.outputs){const n=_c(e.outputs,`Serializing outputs for uploaded example with id: ${t}`),a=new Blob([n],{type:"application/json"});r.append(`${t}.outputs`,a)}if(e.attachments)for(const[n,a]of Object.entries(e.attachments)){let e,s;Array.isArray(a)?[e,s]=a:(e=a.mimeType,s=a.data);const i=new Blob([s],{type:`${e}; length=${s.byteLength}`});r.append(`${t}.attachment.${n}`,i)}}return(await this.caller.call(async()=>{const t=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await cc(t,"upload examples"),t})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,n]=ic(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const a={};if(void 0!==t?.description&&(a.description=t.description),void 0!==t?.readme&&(a.readme=t.readme),void 0!==t?.tags&&(a.tags=t.tags),void 0!==t?.isPublic&&(a.is_public=t.isPublic),void 0!==t?.isArchived&&(a.is_archived=t.isArchived),0===Object.keys(a).length)throw new Error("No valid update options provided");const s=JSON.stringify(a);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${r}/${n}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await cc(e,"update prompt"),e})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,n]=ic(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,"delete prompt"),e})).json()}async pullPromptCommit(e,t){const[r,n,a]=ic(e),s=await this.caller.call(async()=>{const e=await this._fetch(`${this.apiUrl}/commits/${r}/${n}/${a}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await cc(e,"pull prompt commit"),e}),i=await s.json();return{owner:r,repo:n,commit_hash:i.commit_hash,manifest:i.manifest,examples:i.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){return await this.promptExists(e)?t&&Object.keys(t).some(e=>"object"!==e)&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:n}=t,[a,s]=this.parseTokenOrUrl(e,r),i=new Ic({apiUrl:a,apiKey:"placeholder"}),o=await i.readSharedDataset(s),c=n||o.name;try{if(await this.hasDataset({datasetId:c}))return void console.log(`Dataset ${c} already exists in your tenant. Skipping.`)}catch(e){}const l=await i.listSharedExamples(s),u=await this.createDataset(c,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map(e=>e.inputs),outputs:l.flatMap(e=>e.outputs?[e.outputs]:[]),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,r=2,n="dataset"){try{return Ao(e),[t,e]}catch(e){}try{const a=new URL(e).pathname.split("/").filter(e=>""!==e);if(a.length>=r)return[t,a[a.length-r]];throw new Error(`Invalid public ${n} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${n} URL or token: ${e}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()]),void 0!==this.langSmithToOTELTranslator&&await(Ho.getDefaultOTLPTracerComponents()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush())}}function Pc(e){return"dataset_id"in e||"dataset_name"in e}const $c=Symbol.for("lc:context_variables"),Tc=Symbol.for("langsmith:replica_trace_roots");function jc(e,t){if($c in e)return e[$c][t]}const Rc=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,Nc=function(e){return"string"==typeof e&&Rc.test(e)};function Cc(e,t,r,n){switch(e){case 0:return t&r^~t&n;case 1:case 3:return t^r^n;case 2:return t&r^t&n^r&n}}function Lc(e,t){return e<<t|e>>>32-t}var Mc=function(e,t,r){function n(e,t,n,a){var s;if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}(e)),"string"==typeof t&&(t=function(e){if(!Nc(e))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=255&t,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=255&t,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=255&t,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=255&t,r[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=t/4294967296&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=255&t,r}(t)),16!==(null===(s=t)||void 0===s?void 0:s.length))throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var i=new Uint8Array(16+e.length);if(i.set(t),i.set(e,t.length),(i=r(i))[6]=15&i[6]|80,i[8]=63&i[8]|128,n){a=a||0;for(var o=0;o<16;++o)n[a+o]=i[o];return n}return Li(i)}try{n.name="v5"}catch(e){}return n.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",n.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",n}(0,0,function(e){var t=[1518500249,1859775393,2400959708,3395469782],r=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var n=unescape(encodeURIComponent(e));e=[];for(var a=0;a<n.length;++a)e.push(n.charCodeAt(a))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var s=e.length/4+2,i=Math.ceil(s/16),o=new Array(i),c=0;c<i;++c){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=e[64*c+4*u]<<24|e[64*c+4*u+1]<<16|e[64*c+4*u+2]<<8|e[64*c+4*u+3];o[c]=l}o[i-1][14]=8*(e.length-1)/Math.pow(2,32),o[i-1][14]=Math.floor(o[i-1][14]),o[i-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<i;++d){for(var h=new Uint32Array(80),p=0;p<16;++p)h[p]=o[d][p];for(var f=16;f<80;++f)h[f]=Lc(h[f-3]^h[f-8]^h[f-14]^h[f-16],1);for(var m=r[0],g=r[1],y=r[2],_=r[3],b=r[4],w=0;w<80;++w){var v=Math.floor(w/20),O=Lc(m,5)+Cc(v,g,y,_)+b+t[v]+h[w]>>>0;b=_,_=y,y=Lc(g,30)>>>0,g=m,m=O}r[0]=r[0]+m>>>0,r[1]=r[1]+g>>>0,r[2]=r[2]+y>>>0,r[3]=r[3]+_>>>0,r[4]=r[4]+b>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]});const zc=Mc,Uc="6ba7b810-9dad-11d1-80b4-00c04fd430c8";function Dc(e){const t=Object.keys(e).sort().map(t=>`${t}:${e[t]??""}`).join("|");return zc(t,Uc)}function Fc(e,t=1){const r=t.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`}function Bc(e,t,r=1){const n=Fc(e,r);return{dottedOrder:(a=n,a.replace(/[-:.]/g,"")+t),microsecondPrecisionDatestring:n};var a}class Zc{constructor(e,t,r,n){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=r,this.replicas=n}static fromHeader(e){const t=e.split(",");let r,n,a={},s=[];for(const e of t){const[t,i]=e.split("="),o=decodeURIComponent(i);"langsmith-metadata"===t?a=JSON.parse(o):"langsmith-tags"===t?s=o.split(","):"langsmith-project"===t?r=o:"langsmith-replicas"===t&&(n=JSON.parse(o))}return new Zc(a,s,r,n)}toHeader(){const e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class qc{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"distributedParentId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),null!=(t=e)&&"function"==typeof t.createChild&&"function"==typeof t.postRun)return void Object.assign(this,{...e});var t;const r=qc.getDefaultConfig(),{metadata:n,...a}=e,s=a.client??qc.getSharedClient(),i={...n,...a?.extra?.metadata};if(a.extra={...a.extra,metadata:i},"id"in a&&null==a.id&&delete a.id,Object.assign(this,{...r,...a,client:s}),this.execution_order??=1,this.child_execution_order??=1,this.dotted_order||(this._serialized_start_time=Fc(this.start_time,this.execution_order)),this.id||(this.id=function(e,t,r){e=e||{};var n=t&&r||0,a=t||new Uint8Array(16),s=e.random||(e.rng||Ri)(),i=void 0!==e.msecs?e.msecs:Date.now(),o=void 0!==e.seq?e.seq:null,c=Oo,l=vo;return i>Eo&&void 0===e.msecs&&(Eo=i,null!==o&&(c=null,l=null)),null!==o&&(o>2147483647&&(o=2147483647),c=o>>>19&4095,l=524287&o),null!==c&&null!==l||(c=(c=127&s[6])<<8|s[7],l=(l=(l=63&s[8])<<8|s[9])<<5|s[10]>>>3),i+1e4>Eo&&null===o?++l>524287&&(l=0,++c>4095&&(c=0,Eo++)):Eo=i,Oo=c,vo=l,a[n++]=Eo/1099511627776&255,a[n++]=Eo/4294967296&255,a[n++]=Eo/16777216&255,a[n++]=Eo/65536&255,a[n++]=Eo/256&255,a[n++]=255&Eo,a[n++]=c>>>4&15|112,a[n++]=255&c,a[n++]=l>>>13&63|128,a[n++]=l>>>5&255,a[n++]=l<<3&255|7&s[10],a[n++]=s[11],a[n++]=s[12],a[n++]=s[13],a[n++]=s[14],a[n++]=s[15],t||Li(a)}({msecs:"string"==typeof(c=this._serialized_start_time??this.start_time)?Date.parse(c):c,seq:0})),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=(o=this.replicas)?o.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):function(){const e=Lo("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t)){const e=[];for(const r of t)"object"==typeof r&&null!==r?"string"==typeof r.api_url?"string"==typeof r.api_key?e.push({apiUrl:r.api_url.replace(/\/$/,""),apiKey:r.api_key}):console.warn("Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got "+typeof r.api_key):console.warn("Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got "+typeof r.api_url):console.warn("Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got "+typeof r);return e}if("object"==typeof t&&null!==t){!function(e){if(Object.keys(e).length>0&&Mo("ENDPOINT"))throw new uc}(t);const e=[];for(const[r,n]of Object.entries(t)){const t=r.replace(/\/$/,"");"string"==typeof n?e.push({apiUrl:t,apiKey:n}):console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${r}: expected string, got `+typeof n)}return e}return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS â€“ must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got "+typeof t),[]}catch(e){if("object"==typeof(t=e)&&null!==t&&t.code===lc)throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS â€“ must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}var t}(),!this.dotted_order){const{dottedOrder:e}=Bc(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e}var o,c}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){const e=Date.now();return{run_type:"chain",project_name:wo(),child_runs:[],api_url:Lo("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:Lo("LANGCHAIN_API_KEY"),caller_options:{},start_time:e,serialized:{},inputs:{},extra:{}}}static getSharedClient(){return qc.sharedClient||(qc.sharedClient=new Ic),qc.sharedClient}createChild(e){const t=this.child_execution_order+1,r=this.replicas?.map(e=>{const{reroot:t,...r}=e;return r}),n=e.replicas??r,a=new qc({...e,parent_run:this,project_name:this.project_name,replicas:n,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:t,child_execution_order:t});$c in this&&(a[$c]=this[$c]);const s=Symbol.for("lc:child_config"),i=e.extra?.[s]??this.extra[s];if(function(e){const t=e?.callbacks;return null!=e&&"object"==typeof t&&(Jc(t?.handlers)||Jc(t))}(i)){const e={...i},t="object"==typeof(o=e.callbacks)&&null!=o&&Array.isArray(o.handlers)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:a.id}),t.handlers?.find(Hc)?.updateFromRunTree?.(a),e.callbacks=t),a.extra[s]=e}var o;const c=new Set;let l=this;for(;null!=l&&!c.has(l.id);)c.add(l.id),l.child_execution_order=Math.max(l.child_execution_order,t),l=l.parent_run;return this.child_runs.push(a),a}async end(e,t,r=Date.now(),n){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,n&&Object.keys(n).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...n}}:{metadata:n})}_convertToCreate(e,t,r=!0){const n=e.extra??{};if(void 0===n?.runtime?.library&&(n.runtime||(n.runtime={}),t))for(const[e,r]of Object.entries(t))n.runtime[e]||(n.runtime[e]=r);let a,s;return r?(s=e.parent_run?.id??e.parent_run_id,a=[]):(a=e.child_runs.map(e=>this._convertToCreate(e,t,r)),s=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:n,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:s,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_sliceParentId(e,t){if(t.dotted_order){const r=t.dotted_order.split(".");let n=null;for(let t=0;t<r.length;t++)if(r[t].slice(-36)===e){n=t;break}if(null!==n){const e=r.slice(n+1);t.dotted_order=e.join("."),e.length>0?t.trace_id=e[0].slice(-36):t.trace_id=t.id}}t.parent_run_id===e&&(t.parent_run_id=void 0)}_setReplicaTraceRoot(e,t){const r=jc(this,Tc)??{};r[e]=t,function(e,t,r){const n=$c in e?e[$c]:{};n[t]=r,e[$c]=n}(this,Tc,r);for(const r of this.child_runs)r._setReplicaTraceRoot(e,t)}_remapForProject(e){const{projectName:t,runtimeEnv:r,excludeChildRuns:n=!0,reroot:a=!1,distributedParentId:s,apiUrl:i,apiKey:o,workspaceId:c}=e,l=this._convertToCreate(this,r,n);if(t===this.project_name)return{...l,session_name:t};if(a){if(s)this._sliceParentId(s,l);else if(l.parent_run_id=void 0,l.dotted_order){const e=l.dotted_order.split(".");e.length>0&&(l.dotted_order=e[e.length-1],l.trace_id=l.id)}const e=Dc({projectName:t,apiUrl:i,apiKey:o,workspaceId:c});this._setReplicaTraceRoot(e,l.id)}let u;if(!a&&(u=(jc(this,Tc)??{})[Dc({projectName:t,apiUrl:i,apiKey:o,workspaceId:c})],u&&(l.trace_id=u,l.dotted_order))){const e=l.dotted_order.split(".");let t=null;for(let r=0;r<e.length;r++)if(e[r].slice(-36)===u){t=r;break}if(null!==t){const r=e.slice(t);l.dotted_order=r.join(".")}}const d=l.id,h=zc(`${d}:${t}`,Uc);let p,f,m;return p=l.trace_id?zc(`${l.trace_id}:${t}`,Uc):h,l.parent_run_id&&(f=zc(`${l.parent_run_id}:${t}`,Uc)),l.dotted_order&&(m=l.dotted_order.split(".").map(e=>{const r=e.slice(-36),n=zc(`${r}:${t}`,Uc);return e.slice(0,-36)+n}).join(".")),{...l,id:h,trace_id:p,parent_run_id:f,dotted_order:m,session_name:t}}async postRun(e=!0){try{const t=No();if(this.replicas&&this.replicas.length>0)for(const{projectName:e,apiKey:r,apiUrl:n,workspaceId:a,reroot:s}of this.replicas){const i=this._remapForProject({projectName:e??this.project_name,runtimeEnv:t,excludeChildRuns:!0,reroot:s,distributedParentId:this.distributedParentId,apiUrl:n,apiKey:r,workspaceId:a});await this.client.createRun(i,{apiKey:r,apiUrl:n,workspaceId:a})}else{const r=this._convertToCreate(this,t,e);await this.client.createRun(r)}if(!e){xo("Posting with excludeChildRuns=false is deprecated and will be removed in a future version.");for(const e of this.child_runs)await e.postRun(!1)}}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(e){if(this.replicas&&this.replicas.length>0)for(const{projectName:t,apiKey:r,apiUrl:n,workspaceId:a,updates:s,reroot:i}of this.replicas){const o=this._remapForProject({projectName:t??this.project_name,runtimeEnv:void 0,excludeChildRuns:!0,reroot:i,distributedParentId:this.distributedParentId,apiUrl:n,apiKey:r,workspaceId:a}),c={id:o.id,name:o.name,run_type:o.run_type,start_time:o.start_time,outputs:o.outputs,error:o.error,parent_run_id:o.parent_run_id,session_name:o.session_name,reference_example_id:o.reference_example_id,end_time:o.end_time,dotted_order:o.dotted_order,trace_id:o.trace_id,events:o.events,tags:o.tags,extra:o.extra,attachments:this.attachments,...s};e?.excludeInputs||(c.inputs=o.inputs),await this.client.updateRun(o.id,c,{apiKey:r,apiUrl:n,workspaceId:a})}else try{const t={name:this.name,run_type:this.run_type,start_time:this._serialized_start_time??this.start_time,end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e?.excludeInputs||(t.inputs=this.inputs),await this.client.updateRun(this.id,t)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),"string"==typeof e?this.events.push({name:"event",time:(new Date).toISOString(),message:e}):this.events.push({...e,time:e.time??(new Date).toISOString()})}static fromRunnableConfig(e,t){const r=e?.callbacks;let n,a,s,i=!!["TRACING_V2","TRACING"].find(e=>"true"===Mo(e));if(r){const e=r?.getParentRunId?.()??"",t=r?.handlers?.find(e=>"langchain_tracer"==e?.name);n=t?.getRun?.(e),a=t?.projectName,s=t?.client,i=i||!!t}return n?new qc({name:n.name,id:n.id,trace_id:n.trace_id,dotted_order:n.dotted_order,client:s,tracingEnabled:i,project_name:a,tags:[...new Set((n?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...n?.extra?.metadata,...e?.metadata}}}).createChild(t):new qc({...t,client:s,tracingEnabled:i,project_name:a})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){const r="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,n=r["langsmith-trace"];if(!n||"string"!=typeof n)return;const a=n.trim(),s=a.split(".").map(e=>{const[t,r]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:r}}),i=s[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:s.at(-1)?.uuid,trace_id:i,dotted_order:a};if(r.baggage&&"string"==typeof r.baggage){const e=Zc.fromHeader(r.baggage);o.metadata=e.metadata,o.tags=e.tags,o.project_name=e.project_name,o.replicas=e.replicas}const c=new qc(o);return c.distributedParentId=c.id,c}toHeaders(e){const t={"langsmith-trace":this.dotted_order,baggage:new Zc(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(const[r,n]of Object.entries(t))e.set(r,n);return t}}function Hc(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function Jc(e){return Array.isArray(e)&&e.some(e=>Hc(e))}Object.defineProperty(qc,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});const Gc=()=>"undefined"!=typeof Deno;let Wc;function Kc(){if(void 0===Wc){const e=(()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Gc()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom")?"jsdom":Gc()?"deno":"other":"node",e})();Wc={library:"langchain-js",runtime:e}}return Wc}function Vc(e){try{return"undefined"!=typeof process?process.env?.[e]:Gc()?Deno?.env.get(e):void 0}catch(e){return}}class Xc{}function Yc(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}class Qc extends Xc{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,fa(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===Vc("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return ma.prototype.toJSON.call(this)}toJSONNotImplemented(){return ma.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends Qc{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Mi()}),Object.assign(this,e)}}}}const el=e=>{const t=e;return void 0!==t&&"function"==typeof t.copy&&"string"==typeof t.name&&"boolean"==typeof t.awaitHandlers};function tl(e,t){if(e)return new qc({...e,start_time:e._serialized_start_time??e.start_time,parent_run:tl(t),child_runs:e.child_runs.map(e=>tl(e)).filter(e=>void 0!==e),extra:{...e.extra,runtime:Kc()},tracingEnabled:!1})}function rl(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function nl(e){return"function"==typeof e._addRunToRunMap}class al extends Qc{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(void 0!==e)return this.usesRunTreeMap?(e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e})(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){const{dottedOrder:t,microsecondPrecisionDatestring:r}=Bc(new Date(e.start_time).getTime(),e.id,e.execution_order),n={...e},a=this.getRunById(n.parent_run_id);if(void 0!==n.parent_run_id?a&&(this._addChildRun(a,n),a.child_execution_order=Math.max(a.child_execution_order,n.child_execution_order),n.trace_id=a.trace_id,void 0!==a.dotted_order&&(n.dotted_order=[a.dotted_order,t].join("."),n._serialized_start_time=r)):(n.trace_id=n.id,n.dotted_order=t,n._serialized_start_time=r),this.usesRunTreeMap){const e=tl(n,a);void 0!==e&&this.runTreeMap.set(n.id,e)}else this.runMap.set(n.id,n);return n}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await(this.onRunUpdate?.(e)),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){const t=void 0!==e&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,n,a,s,i,o){const c=this._getExecutionOrder(n),l=Date.now(),u=i?{...a,metadata:i}:a,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:s||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,r,n,a,s,i,o){const c=this.getRunById(r)??this._createRunForLLMStart(e,t,r,n,a,s,i,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}_createRunForChatModelStart(e,t,r,n,a,s,i,o){const c=this._getExecutionOrder(n),l=Date.now(),u=i?{...a,metadata:i}:a,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:s||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,r,n,a,s,i,o){const c=this.getRunById(r)??this._createRunForChatModelStart(e,t,r,n,a,s,i,o);return await(this.onRunCreate?.(c)),await(this.onLLMStart?.(c)),c}async handleLLMEnd(e,t,r,n,a){const s=this.getRunById(t);if(!s||"llm"!==s?.run_type)throw new Error("No LLM run to end.");return s.end_time=Date.now(),s.outputs=e,s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),s.extra={...s.extra,...a},await(this.onLLMEnd?.(s)),await this._endTrace(s),s}async handleLLMError(e,t,r,n,a){const s=this.getRunById(t);if(!s||"llm"!==s?.run_type)throw new Error("No LLM run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),s.extra={...s.extra,...a},await(this.onLLMError?.(s)),await this._endTrace(s),s}_createRunForChainStart(e,t,r,n,a,s,i,o){const c=this._getExecutionOrder(n),l=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:n,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:i??"chain",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(u)}async handleChainStart(e,t,r,n,a,s,i,o){const c=this.getRunById(r)??this._createRunForChainStart(e,t,r,n,a,s,i,o);return await(this.onRunCreate?.(c)),await(this.onChainStart?.(c)),c}async handleChainEnd(e,t,r,n,a){const s=this.getRunById(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.outputs=rl(e,"output"),s.events.push({name:"end",time:new Date(s.end_time).toISOString()}),void 0!==a?.inputs&&(s.inputs=rl(a.inputs,"input")),await(this.onChainEnd?.(s)),await this._endTrace(s),s}async handleChainError(e,t,r,n,a){const s=this.getRunById(t);if(!s)throw new Error("No chain run to end.");return s.end_time=Date.now(),s.error=this.stringifyError(e),s.events.push({name:"error",time:new Date(s.end_time).toISOString()}),void 0!==a?.inputs&&(s.inputs=rl(a.inputs,"input")),await(this.onChainError?.(s)),await this._endTrace(s),s}_createRunForToolStart(e,t,r,n,a,s,i){const o=this._getExecutionOrder(n),c=Date.now(),l={id:r,name:i??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleToolStart(e,t,r,n,a,s,i){const o=this.getRunById(r)??this._createRunForToolStart(e,t,r,n,a,s,i);return await(this.onRunCreate?.(o)),await(this.onToolStart?.(o)),o}async handleToolEnd(e,t){const r=this.getRunById(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onToolEnd?.(r)),await this._endTrace(r),r}async handleToolError(e,t){const r=this.getRunById(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onToolError?.(r)),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.getRunById(t);if(!r||"chain"!==r?.run_type)return;const n=r;n.actions=n.actions||[],n.actions.push(e),n.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(r))}async handleAgentEnd(e,t){const r=this.getRunById(t);r&&"chain"===r?.run_type&&(r.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(r)))}_createRunForRetrieverStart(e,t,r,n,a,s,i){const o=this._getExecutionOrder(n),c=Date.now(),l={id:r,name:i??e.id[e.id.length-1],parent_run_id:n,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:s?{metadata:s}:{},tags:a||[]};return this._addRunToRunMap(l)}async handleRetrieverStart(e,t,r,n,a,s,i){const o=this.getRunById(r)??this._createRunForRetrieverStart(e,t,r,n,a,s,i);return await(this.onRunCreate?.(o)),await(this.onRetrieverStart?.(o)),o}async handleRetrieverEnd(e,t){const r=this.getRunById(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverEnd?.(r)),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.getRunById(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverError?.(r)),await this._endTrace(r),r}async handleText(e,t){const r=this.getRunById(t);r&&"chain"===r?.run_type&&(r.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(r)))}async handleLLMNewToken(e,t,r,n,a,s){const i=this.getRunById(r);if(!i||"llm"!==i?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return i.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:s?.chunk}}),await(this.onLLMNewToken?.(i,e,{chunk:s?.chunk})),i}}var sl=r(4083);function il(e,t){return`${e.open}${t}${e.close}`}function ol(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function cl(e){return"string"==typeof e?e.trim():null==e?e:ol(e,e.toString())}function ll(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:ul}=sl;class dl extends al{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const e=this.runMap.get(r.parent_run_id);if(!e)break;t.push(e),r=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map((e,t,r)=>{const n=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?il(sl.bold,n):n}).join(" > ");return il(ul.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.green,"[chain/start]")} [${t}] Entering Chain run with input: ${ol(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.cyan,"[chain/end]")} [${t}] [${ll(e)}] Exiting Chain run with output: ${ol(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.red,"[chain/error]")} [${t}] [${ll(e)}] Chain run errored with error: ${ol(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(e=>e.trim())}:e.inputs;console.log(`${il(ul.green,"[llm/start]")} [${t}] Entering LLM run with input: ${ol(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.cyan,"[llm/end]")} [${t}] [${ll(e)}] Exiting LLM run with output: ${ol(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.red,"[llm/error]")} [${t}] [${ll(e)}] LLM run errored with error: ${ol(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.green,"[tool/start]")} [${t}] Entering Tool run with input: "${cl(e.inputs.input)}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.cyan,"[tool/end]")} [${t}] [${ll(e)}] Exiting Tool run with output: "${cl(e.outputs?.output)}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.red,"[tool/error]")} [${t}] [${ll(e)}] Tool run errored with error: ${ol(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${ol(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.cyan,"[retriever/end]")} [${t}] [${ll(e)}] Exiting Retriever run with output: ${ol(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${il(ul.red,"[retriever/error]")} [${t}] [${ll(e)}] Retriever run errored with error: ${ol(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${il(ul.blue,"[agent/action]")} [${r}] Agent selected action: ${ol(t.actions[t.actions.length-1],"[action]")}`)}}let hl;const pl=()=>{if(void 0===hl){const e="false"===Vc("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{};hl=new Ic(e)}return hl};class fl extends al{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});const{exampleId:t,projectName:r,client:n,replicas:a}=e;this.projectName=r??wo(),this.replicas=a,this.exampleId=t,this.client=n??pl();const s=fl.getTraceableRunTree();s&&this.updateFromRunTree(s)}async persistRun(e){}async onRunCreate(e){const t=this.getRunTreeWithTracingConfig(e.id);await(t?.postRun())}async onRunUpdate(e){const t=this.getRunTreeWithTracingConfig(e.id);await(t?.patchRun())}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){this.runTreeMap.set(e.id,e);let t=e;const r=new Set;for(;t.parent_run&&!r.has(t.id)&&(r.add(t.id),t.parent_run);)t=t.parent_run;r.clear();const n=[t];for(;n.length>0;){const e=n.shift();e&&!r.has(e.id)&&(r.add(e.id),this.runTreeMap.set(e.id,e),e.child_runs&&n.push(...e.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){const t=this.runTreeMap.get(e);if(t)return new qc({...t,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return function(e=!1){const t=Di.getInstance().getStore();if(!e&&void 0===t)throw new Error("Could not get the current run tree.\n\nPlease make sure you are calling this method within a traceable function and that tracing is enabled.");return t}(!0)}catch{return}}}const ml=Symbol.for("ls:tracing_async_local_storage"),gl=Symbol.for("lc:context_variables"),yl=()=>globalThis[ml];let _l;async function bl(e,t){if(!0===t){const t=yl();void 0!==t?await t.run(void 0,async()=>e()):await e()}else void 0===_l&&(_l=new(0,tc.default)({autoStart:!0,concurrency:1})),_l.add(async()=>{const t=yl();void 0!==t?await t.run(void 0,async()=>e()):await e()})}function wl(e){const t=yl();if(void 0===t)return;const r=t.getStore();return r?.[gl]?.[e]}const vl=Symbol("lc:configure_hooks");class Ol{setHandler(e){return this.setHandlers([e])}}class El{constructor(e,t,r,n,a,s,i,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>bl(async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,n,a){await Promise.all(this.handlers.map(r=>bl(async()=>{try{await(r.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}}class kl extends El{getChild(e){const t=new Il(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}}class xl extends El{async handleLLMNewToken(e,t,r,n,a,s){await Promise.all(this.handlers.map(r=>bl(async()=>{if(!r.ignoreLLM)try{await(r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,s))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}async handleLLMError(e,t,r,n,a){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleLLMEnd(e,t,r,n,a){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class Sl extends El{getChild(e){const t=new Il(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,n,a){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleChainEnd(e,t,r,n,a){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,a))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class Al extends El{getChild(e){const t=new Il(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>bl(async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class Il extends Ol{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,n=void 0,a=void 0,s=void 0,i=void 0,o=void 0){return Promise.all(t.map(async(t,n)=>{const s=0===n&&r?r:Mi();return await Promise.all(this.handlers.map(r=>{if(!r.ignoreLLM)return nl(r)&&r._createRunForLLMStart(e,[t],s,this._parentRunId,a,this.tags,this.metadata,o),bl(async()=>{try{await(r.handleLLMStart?.(e,[t],s,this._parentRunId,a,this.tags,this.metadata,o))}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new xl(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,n=void 0,a=void 0,s=void 0,i=void 0,o=void 0){return Promise.all(t.map(async(t,n)=>{const s=0===n&&r?r:Mi();return await Promise.all(this.handlers.map(r=>{if(!r.ignoreLLM)return nl(r)&&r._createRunForChatModelStart(e,[t],s,this._parentRunId,a,this.tags,this.metadata,o),bl(async()=>{try{if(r.handleChatModelStart)await(r.handleChatModelStart?.(e,[t],s,this._parentRunId,a,this.tags,this.metadata,o));else if(r.handleLLMStart){const n=Wa(t);await(r.handleLLMStart?.(e,[n],s,this._parentRunId,a,this.tags,this.metadata,o))}}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new xl(s,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=Mi(),n=void 0,a=void 0,s=void 0,i=void 0){return await Promise.all(this.handlers.map(a=>{if(!a.ignoreChain)return nl(a)&&a._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,n,i),bl(async()=>{try{await(a.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,n,i))}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleChainStart: ${e}`),a.raiseError)throw e}},a.awaitHandlers)})),new Sl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=Mi(),n=void 0,a=void 0,s=void 0,i=void 0){return await Promise.all(this.handlers.map(n=>{if(!n.ignoreAgent)return nl(n)&&n._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,i),bl(async()=>{try{await(n.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,i))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleToolStart: ${e}`),n.raiseError)throw e}},n.awaitHandlers)})),new Al(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=Mi(),n=void 0,a=void 0,s=void 0,i=void 0){return await Promise.all(this.handlers.map(n=>{if(!n.ignoreRetriever)return nl(n)&&n._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,i),bl(async()=>{try{await(n.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,i))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleRetrieverStart: ${e}`),n.raiseError)throw e}},n.awaitHandlers)})),new kl(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,n,a){await Promise.all(this.handlers.map(n=>bl(async()=>{if(!n.ignoreCustomEvent)try{await(n.handleCustomEvent?.(e,t,r,this.tags,this.metadata))}catch(e){if((n.raiseError?console.error:console.warn)(`Error in handler ${n.constructor.name}, handleCustomEvent: ${e}`),n.raiseError)throw e}},n.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new Il(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const n of e)r.handlers.filter(e=>"console_callback_handler"===e.name).some(e=>e.name===n.name)||r.addHandler(n,t);return r}static fromHandlers(e){const t=new this;return t.addHandler(new class extends Qc{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Mi()}),Object.assign(this,e)}}),t}static configure(e,t,r,n,a,s,i){return this._configureSync(e,t,r,n,a,s,i)}static _configureSync(e,t,r,n,a,s,i){let o;(e||t)&&(Array.isArray(e)||!e?(o=new Il,o.setHandlers(e?.map(Pl)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(Pl):t?.handlers,!1));const c="true"===Vc("LANGCHAIN_VERBOSE")||i?.verbose,l=fl.getTraceableRunTree()?.tracingEnabled||!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(e=>"true"===Vc(e)),u=l||(Vc("LANGCHAIN_TRACING")??!1);if(c||u){if(o||(o=new Il),c&&!o.handlers.some(e=>e.name===dl.prototype.name)){const e=new dl;o.addHandler(e,!0)}if(u&&!o.handlers.some(e=>"langchain_tracer"===e.name)&&l){const e=new fl;o.addHandler(e,!0)}if(l){const e=fl.getTraceableRunTree();if(e&&void 0===o._parentRunId){o._parentRunId=e.id;const t=o.handlers.find(e=>"langchain_tracer"===e.name);t?.updateFromRunTree(e)}}}for(const{contextVar:e,inheritable:t=!0,handlerClass:r,envVar:n}of wl(vl)||[]){const a=n&&"true"===Vc(n)&&r;let s;const i=void 0!==e?wl(e):void 0;i&&el(i)?s=i:a&&(s=new r({})),void 0!==s&&(o||(o=new Il),o.handlers.some(e=>e.name===s.name)||o.addHandler(s,t))}return(r||n)&&o&&(o.addTags(r??[]),o.addTags(n??[],!1)),(a||s)&&o&&(o.addMetadata(a??{}),o.addMetadata(s??{},!1)),o}}function Pl(e){return"name"in e?e:Qc.fromMethods(e)}const $l=new class{getStore(){}run(e,t){return t()}enterWith(e){}},Tl=Symbol.for("lc:child_config"),jl=new class{getInstance(){return yl()??$l}getRunnableConfig(){const e=this.getInstance();return e.getStore()?.extra?.[Tl]}runWithConfig(e,t,r){const n=Il._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),a=this.getInstance(),s=a.getStore(),i=n?.getParentRunId(),o=n?.handlers?.find(e=>"langchain_tracer"===e?.name);let c;return o&&i?c=o.getRunTreeWithTracingConfig(i):r||(c=new qc({name:"<runnable_lambda>",tracingEnabled:!1})),c&&(c.extra={...c.extra,[Tl]:e}),void 0!==s&&void 0!==s[gl]&&(void 0===c&&(c={}),c[gl]=s[gl]),a.run(c,t)}initializeGlobalInstance(e){void 0===yl()&&(e=>{globalThis[ml]=e})(e)}};async function Rl(e){return Il._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function Nl(...e){const t={};for(const r of e.filter(e=>!!e))for(const e of Object.keys(r))if("metadata"===e)t[e]={...t[e],...r[e]};else if("tags"===e){const n=t[e]??[];t[e]=[...new Set(n.concat(r[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...r[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=r.timeout:void 0!==r.timeout&&(t.timeout=Math.min(t.timeout,r.timeout));else if("signal"===e)void 0===t.signal?t.signal=r.signal:void 0!==r.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,r.signal]):t.signal=r.signal);else if("callbacks"===e){const e=t.callbacks,n=r.callbacks;if(Array.isArray(n))if(e)if(Array.isArray(e))t.callbacks=e.concat(n);else{const r=e.copy();for(const e of n)r.addHandler(Pl(e),!0);t.callbacks=r}else t.callbacks=n;else if(n)if(e)if(Array.isArray(e)){const r=n.copy();for(const t of e)r.addHandler(Pl(t),!0);t.callbacks=r}else t.callbacks=new Il(n._parentRunId,{handlers:e.handlers.concat(n.handlers),inheritableHandlers:e.inheritableHandlers.concat(n.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(n.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(n.inheritableTags))),metadata:{...e.metadata,...n.metadata}});else t.callbacks=n}else{const n=e;t[n]=r[n]??t[n]}return t}const Cl=new Set(["string","number","boolean"]);function Ll(e){const t=jl.getRunnableConfig();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,runName:n,...a}=t;r=Object.entries(a).reduce((e,[t,r])=>(void 0!==r&&(e[t]=r),e),r)}if(e&&(r=Object.entries(e).reduce((e,[t,r])=>(void 0!==r&&(e[t]=r),e),r)),r?.configurable)for(const e of Object.keys(r.configurable))Cl.has(typeof r.configurable[e])&&!r.metadata?.[e]&&(r.metadata||(r.metadata={}),r.metadata[e]=r.configurable[e]);if(void 0!==r.timeout){if(r.timeout<=0)throw new Error("Timeout must be a positive number");const e=AbortSignal.timeout(r.timeout);void 0!==r.signal?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,e])):r.signal=e,delete r.timeout}return r}function Ml(e={},{callbacks:t,maxConcurrency:r,recursionLimit:n,runName:a,configurable:s,runId:i}={}){const o=Ll(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==n&&(o.recursionLimit=n),void 0!==r&&(o.maxConcurrency=r),void 0!==a&&(o.runName=a),void 0!==s&&(o.configurable={...o.configurable,...s}),void 0!==i&&delete o.runId,o}function zl(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}async function Ul(e,t){if(void 0===t)return e;let r;return Promise.race([e.catch(e=>{if(!t?.aborted)throw e}),new Promise((e,n)=>{r=()=>{n(new Error("Aborted"))},t.addEventListener("abort",r),t.aborted&&n(new Error("Aborted"))})]).finally(()=>t.removeEventListener("abort",r))}class Dl extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){const t=e.getReader();return new Dl({start:e=>function r(){return t.read().then(({done:t,value:n})=>{if(!t)return e.enqueue(n),r();e.close()})}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Dl({async pull(t){const{value:r,done:n}=await e.next();n&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function Fl(e,t=2){const r=Array.from({length:t},()=>[]);return r.map(async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of r)e.push(t)}else{if(t[0].done)return;yield t.shift().value}})}function Bl(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const r={...e};for(const[e,n]of Object.entries(t))e in r&&!Array.isArray(r[e])?r[e]=Bl(r[e],n):r[e]=n;return r}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class Zl{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,r)=>{jl.runWithConfig(zl(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(e=>t(void 0),r)},!0)})}async next(...e){return this.signal?.throwIfAborted(),this.firstResultUsed?jl.runWithConfig(zl(this.config),this.signal?async()=>Ul(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async[Symbol.asyncDispose](){await this.return()}}class ql{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=ao({},t);return new Hl({ops:t,state:r[r.length-1].newDocument})}}class Hl extends ql{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=ao(this.state,e.ops);return new Hl({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=ao({},e.ops);return new Hl({ops:e.ops,state:t[t.length-1].newDocument})}}const Jl=e=>"log_stream_tracer"===e.name;async function Gl(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=e;return["retriever","llm","prompt"].includes(e.run_type)?r:1!==Object.keys(r).length||""!==r?.input?r.input:void 0}async function Wl(e,t){const{outputs:r}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?r:void 0!==r&&1===Object.keys(r).length&&void 0!==r?.output?r.output:r}class Kl extends al{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Dl.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every(e=>!this.excludeTags?.includes(e))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new ql({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new ql({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(r.inputs=await Gl(e,this._schemaFormat)),await this.writer.write(new ql({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const r=[];"streaming_events"===this._schemaFormat&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Gl(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await Wl(e,this._schemaFormat)}),void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const n=new ql({ops:r});await this.writer.write(n)}finally{if(e.id===this.rootId){const t=new ql({ops:[{op:"replace",path:"/final_output",value:await Wl(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const n=this.keyMapByRunId[e.id];if(void 0===n)return;let a;var s;void 0!==e.inputs.messages?(s=r?.chunk,a=void 0!==s&&void 0!==s.message?r?.chunk:new Ra({id:`run-${e.id}`,content:t})):a=t;const i=new ql({ops:[{op:"add",path:`/logs/${n}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${n}/streamed_output/-`,value:a}]});await this.writer.write(i)}}const Vl="__run";class Xl{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Xl({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class Yl extends Xl{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new Yl({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function Ql({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const eu=e=>"event_stream_tracer"===e.name;class tu extends al{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Dl.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(r=r||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(r=r&&t.every(e=>!this.excludeTags?.includes(e))),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const n=this.runInfoMap.get(e);if(void 0===n)return void(yield r.value);function a(e,t){return"llm"===e&&"string"==typeof t?new Xl({text:t}):t}let s=this.tappedPromises.get(e);if(void 0===s){let i;s=new Promise(e=>{i=e}),this.tappedPromises.set(e,s);try{const s={event:`on_${n.runType}_stream`,run_id:e,name:n.name,tags:n.tags,metadata:n.metadata,data:{}};await this.send({...s,data:{chunk:a(n.runType,r.value)}},n),yield r.value;for await(const e of t)"tool"!==n.runType&&"retriever"!==n.runType&&await this.send({...s,data:{chunk:a(n.runType,e)}},n),yield e}finally{i()}}else{yield r.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);void 0!==r?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){const t=Ql(e),r=void 0!==e.inputs.messages?"chat_model":"llm",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,n);const a=`on_${r}_start`;await this.send({event:a,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onLLMNewToken(e,t,r){const n=this.runInfoMap.get(e.id);let a,s;if(void 0===n)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===n.runType)s="on_chat_model_stream",a=void 0===r?.chunk?new Ra({content:t,id:`run-${e.id}`}):r.chunk.message;else{if("llm"!==n.runType)throw new Error(`Unexpected run type ${n.runType}`);s="on_llm_stream",a=void 0===r?.chunk?new Xl({text:t}):r.chunk}await this.send({event:s,data:{chunk:a},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let r;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const n=e.outputs?.generations;let a;if("chat_model"===t.runType){for(const e of n??[]){if(void 0!==a)break;a=e[0]?.message}r="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);a={generations:n?.map(e=>e.map(e=>({text:e.text,generationInfo:e.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end"}await this.sendEndEvent({event:r,data:{output:a,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=Ql(e),r=e.run_type??"chain",n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let a={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(a={},n.inputs={}):void 0!==e.inputs.input?(a.input=e.inputs.input,n.inputs=e.inputs.input):(a.input=e.inputs,n.inputs=e.inputs),this.runInfoMap.set(e.id,n),await this.send({event:`on_${r}_start`,data:a,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,n=e.inputs??t.inputs??{},a={output:e.outputs?.output??e.outputs,input:n};n.input&&1===Object.keys(n).length&&(a.input=n.input,t.inputs=n.input),await this.sendEndEvent({event:r,data:a,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=Ql(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=Ql(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,r),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const n=this.runInfoMap.get(r);if(void 0===n)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:n.tags,metadata:n.metadata,data:t},n)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally(()=>{this.writer.close()})}}const ru=[400,401,402,403,404,405,406,407,409],nu=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&ru.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class au{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??nu;const t=tc.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>Pi(()=>e(...t).catch(e=>{throw e instanceof Error?e:new Error(e)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((t,r)=>{e.signal?.addEventListener("abort",()=>{r(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(e=>e.ok?e:Promise.reject(e)))}}class su extends al{constructor({config:e,onStart:t,onEnd:r,onError:n}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=n}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function iu(e){return!!e&&e.lc_runnable}class ou{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const n=e.tags??[];return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(t)),void 0!==this.includeTags&&(r=r||n.some(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(r=r&&n.every(e=>!this.excludeTags?.includes(e))),r}}function cu(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}const lu=["*","_","`"];Symbol("ZodOutput"),Symbol("ZodInput");class uu{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const r=t[0];if(this._map.set(e,r),r&&"object"==typeof r&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const r={...this.get(t)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}function du(){return new uu}const hu=du();function pu(e,t){return"bigint"==typeof t?t.toString():t}const fu=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{};function mu(e,t,r){const n=new e._zod.constr(t??e._zod.def);return t&&!r?.parent||(n._zod.parent=e),n}function gu(e){const t=e;if(!t)return{};if("string"==typeof t)return{error:()=>t};if(void 0!==t?.message){if(void 0!==t?.error)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,"string"==typeof t.error?{...t,error:()=>t.error}:t}function yu(e,t=0){for(let r=t;r<e.issues.length;r++)if(!0!==e.issues[r]?.continue)return!0;return!1}function _u(e){return"string"==typeof e?e:e?.message}function bu(e,t,r){const n={...e,path:e.path??[]};if(!e.message){const a=_u(e.inst?._zod.def?.error?.(e))??_u(t?.error?.(e))??_u(r.customError?.(e))??_u(r.localeError?.(e))??"Invalid input";n.message=a}return delete n.inst,delete n.continue,t?.reportInput||delete n.input,n}new Set(["string","number","symbol"]),new Set(["string","number","bigint","boolean","symbol","undefined"]),Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_VALUE,Number.MAX_VALUE;class wu{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??hu,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var r;const n=e._zod.def,a={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},s=this.seen.get(e);if(s)return s.count++,t.schemaPath.includes(e)&&(s.cycle=t.path),s.schema;const i={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,i);const o=e._zod.toJSONSchema?.();if(o)i.schema=o;else{const r={...t,schemaPath:[...t.schemaPath,e],path:t.path},s=e._zod.parent;if(s)i.ref=s,this.process(s,r),this.seen.get(s).isParent=!0;else{const t=i.schema;switch(n.type){case"string":{const r=t;r.type="string";const{minimum:n,maximum:s,format:o,patterns:c,contentEncoding:l}=e._zod.bag;if("number"==typeof n&&(r.minLength=n),"number"==typeof s&&(r.maxLength=s),o&&(r.format=a[o]??o,""===r.format&&delete r.format),l&&(r.contentEncoding=l),c&&c.size>0){const e=[...c];1===e.length?r.pattern=e[0].source:e.length>1&&(i.schema.allOf=[...e.map(e=>({..."draft-7"===this.target?{type:"string"}:{},pattern:e.source}))])}break}case"number":{const r=t,{minimum:n,maximum:a,format:s,multipleOf:i,exclusiveMaximum:o,exclusiveMinimum:c}=e._zod.bag;"string"==typeof s&&s.includes("int")?r.type="integer":r.type="number","number"==typeof c&&(r.exclusiveMinimum=c),"number"==typeof n&&(r.minimum=n,"number"==typeof c&&(c>=n?delete r.minimum:delete r.exclusiveMinimum)),"number"==typeof o&&(r.exclusiveMaximum=o),"number"==typeof a&&(r.maximum=a,"number"==typeof o&&(o<=a?delete r.maximum:delete r.exclusiveMaximum)),"number"==typeof i&&(r.multipleOf=i);break}case"boolean":case"success":t.type="boolean";break;case"bigint":if("throw"===this.unrepresentable)throw new Error("BigInt cannot be represented in JSON Schema");break;case"symbol":if("throw"===this.unrepresentable)throw new Error("Symbols cannot be represented in JSON Schema");break;case"null":t.type="null";break;case"any":case"unknown":break;case"undefined":if("throw"===this.unrepresentable)throw new Error("Undefined cannot be represented in JSON Schema");break;case"void":if("throw"===this.unrepresentable)throw new Error("Void cannot be represented in JSON Schema");break;case"never":t.not={};break;case"date":if("throw"===this.unrepresentable)throw new Error("Date cannot be represented in JSON Schema");break;case"array":{const a=t,{minimum:s,maximum:i}=e._zod.bag;"number"==typeof s&&(a.minItems=s),"number"==typeof i&&(a.maxItems=i),a.type="array",a.items=this.process(n.element,{...r,path:[...r.path,"items"]});break}case"object":{const e=t;e.type="object",e.properties={};const a=n.shape;for(const t in a)e.properties[t]=this.process(a[t],{...r,path:[...r.path,"properties",t]});const s=new Set(Object.keys(a)),i=new Set([...s].filter(e=>{const t=n.shape[e]._zod;return"input"===this.io?void 0===t.optin:void 0===t.optout}));i.size>0&&(e.required=Array.from(i)),"never"===n.catchall?._zod.def.type?e.additionalProperties=!1:n.catchall?n.catchall&&(e.additionalProperties=this.process(n.catchall,{...r,path:[...r.path,"additionalProperties"]})):"output"===this.io&&(e.additionalProperties=!1);break}case"union":t.anyOf=n.options.map((e,t)=>this.process(e,{...r,path:[...r.path,"anyOf",t]}));break;case"intersection":{const e=t,a=this.process(n.left,{...r,path:[...r.path,"allOf",0]}),s=this.process(n.right,{...r,path:[...r.path,"allOf",1]}),i=e=>"allOf"in e&&1===Object.keys(e).length,o=[...i(a)?a.allOf:[a],...i(s)?s.allOf:[s]];e.allOf=o;break}case"tuple":{const a=t;a.type="array";const s=n.items.map((e,t)=>this.process(e,{...r,path:[...r.path,"prefixItems",t]}));if("draft-2020-12"===this.target?a.prefixItems=s:a.items=s,n.rest){const e=this.process(n.rest,{...r,path:[...r.path,"items"]});"draft-2020-12"===this.target?a.items=e:a.additionalItems=e}n.rest&&(a.items=this.process(n.rest,{...r,path:[...r.path,"items"]}));const{minimum:i,maximum:o}=e._zod.bag;"number"==typeof i&&(a.minItems=i),"number"==typeof o&&(a.maxItems=o);break}case"record":{const e=t;e.type="object",e.propertyNames=this.process(n.keyType,{...r,path:[...r.path,"propertyNames"]}),e.additionalProperties=this.process(n.valueType,{...r,path:[...r.path,"additionalProperties"]});break}case"map":if("throw"===this.unrepresentable)throw new Error("Map cannot be represented in JSON Schema");break;case"set":if("throw"===this.unrepresentable)throw new Error("Set cannot be represented in JSON Schema");break;case"enum":{const e=t,r=function(e){const t=Object.values(e).filter(e=>"number"==typeof e);return Object.entries(e).filter(([e,r])=>-1===t.indexOf(+e)).map(([e,t])=>t)}(n.entries);r.every(e=>"number"==typeof e)&&(e.type="number"),r.every(e=>"string"==typeof e)&&(e.type="string"),e.enum=r;break}case"literal":{const e=t,r=[];for(const e of n.values)if(void 0===e){if("throw"===this.unrepresentable)throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if("bigint"==typeof e){if("throw"===this.unrepresentable)throw new Error("BigInt literals cannot be represented in JSON Schema");r.push(Number(e))}else r.push(e);if(0===r.length);else if(1===r.length){const t=r[0];e.type=null===t?"null":typeof t,e.const=t}else r.every(e=>"number"==typeof e)&&(e.type="number"),r.every(e=>"string"==typeof e)&&(e.type="string"),r.every(e=>"boolean"==typeof e)&&(e.type="string"),r.every(e=>null===e)&&(e.type="null"),e.enum=r;break}case"file":{const r=t,n={type:"string",format:"binary",contentEncoding:"binary"},{minimum:a,maximum:s,mime:i}=e._zod.bag;void 0!==a&&(n.minLength=a),void 0!==s&&(n.maxLength=s),i?1===i.length?(n.contentMediaType=i[0],Object.assign(r,n)):r.anyOf=i.map(e=>({...n,contentMediaType:e})):Object.assign(r,n);break}case"transform":if("throw"===this.unrepresentable)throw new Error("Transforms cannot be represented in JSON Schema");break;case"nullable":{const e=this.process(n.innerType,r);t.anyOf=[e,{type:"null"}];break}case"nonoptional":case"promise":case"optional":this.process(n.innerType,r),i.ref=n.innerType;break;case"default":this.process(n.innerType,r),i.ref=n.innerType,t.default=JSON.parse(JSON.stringify(n.defaultValue));break;case"prefault":this.process(n.innerType,r),i.ref=n.innerType,"input"===this.io&&(t._prefault=JSON.parse(JSON.stringify(n.defaultValue)));break;case"catch":{let e;this.process(n.innerType,r),i.ref=n.innerType;try{e=n.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}t.default=e;break}case"nan":if("throw"===this.unrepresentable)throw new Error("NaN cannot be represented in JSON Schema");break;case"template_literal":{const r=t,n=e._zod.pattern;if(!n)throw new Error("Pattern not found in template literal");r.type="string",r.pattern=n.source;break}case"pipe":{const e="input"===this.io?"transform"===n.in._zod.def.type?n.out:n.in:n.out;this.process(e,r),i.ref=e;break}case"readonly":this.process(n.innerType,r),i.ref=n.innerType,t.readOnly=!0;break;case"lazy":{const t=e._zod.innerType;this.process(t,r),i.ref=t;break}case"custom":if("throw"===this.unrepresentable)throw new Error("Custom types cannot be represented in JSON Schema")}}}const c=this.metadataRegistry.get(e);return c&&Object.assign(i.schema,c),"input"===this.io&&Ou(e)&&(delete i.schema.examples,delete i.schema.default),"input"===this.io&&i.schema._prefault&&((r=i.schema).default??(r.default=i.schema._prefault)),delete i.schema._prefault,this.seen.get(e).schema}emit(e,t){const r={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},n=this.seen.get(e);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const a=e=>{const t="draft-2020-12"===this.target?"$defs":"definitions";if(r.external){const n=r.external.registry.get(e[0])?.id,a=r.external.uri??(e=>e);if(n)return{ref:a(n)};const s=e[1].defId??e[1].schema.id??"schema"+this.counter++;return e[1].defId=s,{defId:s,ref:`${a("__shared")}#/${t}/${s}`}}if(e[1]===n)return{ref:"#"};const a=`#/${t}/`,s=e[1].schema.id??"__schema"+this.counter++;return{defId:s,ref:a+s}},s=e=>{if(e[1].schema.$ref)return;const t=e[1],{ref:r,defId:n}=a(e);t.def={...t.schema},n&&(t.defId=n);const s=t.schema;for(const e in s)delete s[e];s.$ref=r};if("throw"===r.cycles)for(const e of this.seen.entries()){const t=e[1];if(t.cycle)throw new Error(`Cycle detected: #/${t.cycle?.join("/")}/<root>\n\nSet the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const t of this.seen.entries()){const n=t[1];if(e===t[0]){s(t);continue}if(r.external){const n=r.external.registry.get(t[0])?.id;if(e!==t[0]&&n){s(t);continue}}const a=this.metadataRegistry.get(t[0])?.id;(a||n.cycle||n.count>1&&"ref"===r.reused)&&s(t)}const i=(e,t)=>{const r=this.seen.get(e),n=r.def??r.schema,a={...n};if(null===r.ref)return;const s=r.ref;if(r.ref=null,s){i(s,t);const e=this.seen.get(s).schema;e.$ref&&"draft-7"===t.target?(n.allOf=n.allOf??[],n.allOf.push(e)):(Object.assign(n,e),Object.assign(n,a))}r.isParent||this.override({zodSchema:e,jsonSchema:n,path:r.path??[]})};for(const e of[...this.seen.entries()].reverse())i(e[0],{target:this.target});const o={};if("draft-2020-12"===this.target?o.$schema="https://json-schema.org/draft/2020-12/schema":"draft-7"===this.target?o.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),r.external?.uri){const t=r.external.registry.get(e)?.id;if(!t)throw new Error("Schema is missing an `id` property");o.$id=r.external.uri(t)}Object.assign(o,n.def);const c=r.external?.defs??{};for(const e of this.seen.entries()){const t=e[1];t.def&&t.defId&&(c[t.defId]=t.def)}r.external||Object.keys(c).length>0&&("draft-2020-12"===this.target?o.$defs=c:o.definitions=c);try{return JSON.parse(JSON.stringify(o))}catch(e){throw new Error("Error converting schema to JSON.")}}}function vu(e,t){if(e instanceof uu){const r=new wu(t),n={};for(const t of e._idmap.entries()){const[e,n]=t;r.process(n)}const a={},s={registry:e,uri:t?.uri,defs:n};for(const n of e._idmap.entries()){const[e,i]=n;a[e]=r.emit(i,{...t,external:s})}if(Object.keys(n).length>0){const e="draft-2020-12"===r.target?"$defs":"definitions";a.__shared={[e]:n}}return{schemas:a}}const r=new wu(t);return r.process(e),r.emit(e,t)}function Ou(e,t){const r=t??{seen:new Set};if(r.seen.has(e))return!1;r.seen.add(e);const n=e._zod.def;switch(n.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":case"custom":case"success":case"catch":return!1;case"array":return Ou(n.element,r);case"object":for(const e in n.shape)if(Ou(n.shape[e],r))return!0;return!1;case"union":for(const e of n.options)if(Ou(e,r))return!0;return!1;case"intersection":return Ou(n.left,r)||Ou(n.right,r);case"tuple":for(const e of n.items)if(Ou(e,r))return!0;return!(!n.rest||!Ou(n.rest,r));case"record":case"map":return Ou(n.keyType,r)||Ou(n.valueType,r);case"set":return Ou(n.valueType,r);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":case"default":case"prefault":return Ou(n.innerType,r);case"lazy":return Ou(n.getter(),r);case"transform":return!0;case"pipe":return Ou(n.in,r)||Ou(n.out,r)}throw new Error(`Unknown schema type: ${n.type}`)}const Eu=Symbol("Let zodToJsonSchema decide on which parser to use"),ku={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},xu=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function Su(e){if("openAi"!==e.target)return{};const t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?xu(t,e.currentPath):t.join("/")}}function Au(e,t,r,n){n?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function Iu(e,t,r,n,a){e[t]=r,Au(e,t,n,a)}function Pu(e,t){return td(e.type._def,t)}function $u(e,t,r){const n=r??t.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((r,n)=>$u(e,t,r))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Tu(e,t)}}const Tu=(e,t)=>{const r={type:"integer",format:"unix-time"};if("openApi3"===t.target)return r;for(const n of e.checks)switch(n.kind){case"min":Iu(r,"minimum",n.value,n.message,t);break;case"max":Iu(r,"maximum",n.value,n.message,t)}return r};let ju;const Ru=/^[cC][^\s-]{8,}$/,Nu=/^[0-9a-z]+$/,Cu=/^[0-9A-HJKMNP-TV-Z]{26}$/,Lu=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,Mu=()=>(void 0===ju&&(ju=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ju),zu=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Uu=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,Du=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Fu=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Bu=/^[a-zA-Z0-9_-]{21}$/,Zu=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function qu(e,t){const r={type:"string"};if(e.checks)for(const n of e.checks)switch(n.kind){case"min":Iu(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,n.value):n.value,n.message,t);break;case"max":Iu(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Gu(r,"email",n.message,t);break;case"format:idn-email":Gu(r,"idn-email",n.message,t);break;case"pattern:zod":Wu(r,Lu,n.message,t)}break;case"url":Gu(r,"uri",n.message,t);break;case"uuid":Gu(r,"uuid",n.message,t);break;case"regex":Wu(r,n.regex,n.message,t);break;case"cuid":Wu(r,Ru,n.message,t);break;case"cuid2":Wu(r,Nu,n.message,t);break;case"startsWith":Wu(r,RegExp(`^${Hu(n.value,t)}`),n.message,t);break;case"endsWith":Wu(r,RegExp(`${Hu(n.value,t)}$`),n.message,t);break;case"datetime":Gu(r,"date-time",n.message,t);break;case"date":Gu(r,"date",n.message,t);break;case"time":Gu(r,"time",n.message,t);break;case"duration":Gu(r,"duration",n.message,t);break;case"length":Iu(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,n.value):n.value,n.message,t),Iu(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"includes":Wu(r,RegExp(Hu(n.value,t)),n.message,t);break;case"ip":"v6"!==n.version&&Gu(r,"ipv4",n.message,t),"v4"!==n.version&&Gu(r,"ipv6",n.message,t);break;case"base64url":Wu(r,Fu,n.message,t);break;case"jwt":Wu(r,Zu,n.message,t);break;case"cidr":"v6"!==n.version&&Wu(r,zu,n.message,t),"v4"!==n.version&&Wu(r,Uu,n.message,t);break;case"emoji":Wu(r,Mu(),n.message,t);break;case"ulid":Wu(r,Cu,n.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Gu(r,"binary",n.message,t);break;case"contentEncoding:base64":Iu(r,"contentEncoding","base64",n.message,t);break;case"pattern:zod":Wu(r,Du,n.message,t)}break;case"nanoid":Wu(r,Bu,n.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return r}function Hu(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)Ju.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}const Ju=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function Gu(e,t,r,n){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&n.errorMessages&&{errorMessage:{format:r}}})):Iu(e,"format",t,r,n)}function Wu(e,t,r,n){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:Ku(t,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):Iu(e,"pattern",Ku(t,n),r,n)}function Ku(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;const r=e.flags.includes("i"),n=e.flags.includes("m"),a=e.flags.includes("s"),s=r?e.source.toLowerCase():e.source;let i="",o=!1,c=!1,l=!1;for(let e=0;e<s.length;e++)if(o)i+=s[e],o=!1;else{if(r)if(c){if(s[e].match(/[a-z]/)){l?(i+=s[e],i+=`${s[e-2]}-${s[e]}`.toUpperCase(),l=!1):"-"===s[e+1]&&s[e+2]?.match(/[a-z]/)?(i+=s[e],l=!0):i+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){i+=`[${s[e]}${s[e].toUpperCase()}]`;continue}if(n){if("^"===s[e]){i+="(^|(?<=[\r\n]))";continue}if("$"===s[e]){i+="($|(?=[\r\n]))";continue}}a&&"."===s[e]?i+=c?`${s[e]}\r\n`:`[${s[e]}\r\n]`:(i+=s[e],"\\"===s[e]?o=!0:c&&"]"===s[e]?c=!1:c||"["!==s[e]||(c=!0))}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return i}function Vu(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===xi.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,n)=>({...r,[n]:td(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",n]})??Su(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};const r={type:"object",additionalProperties:td(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===xi.ZodString&&e.keyType._def.checks?.length){const{type:n,...a}=qu(e.keyType._def,t);return{...r,propertyNames:a}}if(e.keyType?._def.typeName===xi.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===xi.ZodBranded&&e.keyType._def.type._def.typeName===xi.ZodString&&e.keyType._def.type._def.checks?.length){const{type:n,...a}=Pu(e.keyType._def,t);return{...r,propertyNames:a}}return r}const Xu={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Yu=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>td(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function Qu(e){try{return e.isOptional()}catch{return!0}}const ed=(e,t,r)=>{switch(t){case xi.ZodString:return qu(e,r);case xi.ZodNumber:return function(e,t){const r={type:"number"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"int":r.type="integer",Au(r,"type",n.message,t);break;case"min":"jsonSchema7"===t.target?n.inclusive?Iu(r,"minimum",n.value,n.message,t):Iu(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),Iu(r,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?Iu(r,"maximum",n.value,n.message,t):Iu(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),Iu(r,"maximum",n.value,n.message,t));break;case"multipleOf":Iu(r,"multipleOf",n.value,n.message,t)}return r}(e,r);case xi.ZodObject:return function(e,t){const r="openAi"===t.target,n={type:"object",properties:{}},a=[],s=e.shape();for(const e in s){let i=s[e];if(void 0===i||void 0===i._def)continue;let o=Qu(i);o&&r&&("ZodOptional"===i._def.typeName&&(i=i._def.innerType),i.isNullable()||(i=i.nullable()),o=!1);const c=td(i._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==c&&(n.properties[e]=c,o||a.push(e))}a.length&&(n.required=a);const i=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return td(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==i&&(n.additionalProperties=i),n}(e,r);case xi.ZodBigInt:return function(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"min":"jsonSchema7"===t.target?n.inclusive?Iu(r,"minimum",n.value,n.message,t):Iu(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),Iu(r,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?Iu(r,"maximum",n.value,n.message,t):Iu(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),Iu(r,"maximum",n.value,n.message,t));break;case"multipleOf":Iu(r,"multipleOf",n.value,n.message,t)}return r}(e,r);case xi.ZodBoolean:return{type:"boolean"};case xi.ZodDate:return $u(e,r);case xi.ZodUndefined:return function(e){return{not:Su(e)}}(r);case xi.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(r);case xi.ZodArray:return function(e,t){const r={type:"array"};return e.type?._def&&e.type?._def?.typeName!==xi.ZodAny&&(r.items=td(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Iu(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Iu(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Iu(r,"minItems",e.exactLength.value,e.exactLength.message,t),Iu(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}(e,r);case xi.ZodUnion:case xi.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Yu(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every(e=>e._def.typeName in Xu&&(!e._def.checks||!e._def.checks.length))){const e=r.reduce((e,t)=>{const r=Xu[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(r.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=r.reduce((e,t)=>{const r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===r.length){const t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:r.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(r.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:r.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return Yu(e,t)}(e,r);case xi.ZodIntersection:return function(e,t){const r=[td(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),td(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let n="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return r.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:r,...n}=e;t=n}else n=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(n=void 0);var t}),a.length?{allOf:a,...n}:void 0}(e,r);case xi.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,r)=>td(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:td(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,r)=>td(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,r);case xi.ZodRecord:return Vu(e,r);case xi.ZodLiteral:return function(e,t){const r=typeof e.value;return"bigint"!==r&&"number"!==r&&"boolean"!==r&&"string"!==r?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===r?"integer":r,enum:[e.value]}:{type:"bigint"===r?"integer":r,const:e.value}}(e,r);case xi.ZodEnum:return function(e){return{type:"string",enum:Array.from(e.values)}}(e);case xi.ZodNativeEnum:return function(e){const t=e.values,r=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),n=Array.from(new Set(r.map(e=>typeof e)));return{type:1===n.length?"string"===n[0]?"string":"number":["string","number"],enum:r}}(e);case xi.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:Xu[e.innerType._def.typeName],nullable:!0}:{type:[Xu[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const r=td(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const r=td(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}(e,r);case xi.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return td(e.innerType._def,t);const r=td(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:Su(t)},r]}:Su(t)})(e,r);case xi.ZodMap:return function(e,t){return"record"===t.mapStrategy?Vu(e,t):{type:"array",maxItems:125,items:{type:"array",items:[td(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||Su(t),td(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||Su(t)],minItems:2,maxItems:2}}}(e,r);case xi.ZodSet:return function(e,t){const r={type:"array",uniqueItems:!0,items:td(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Iu(r,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Iu(r,"maxItems",e.maxSize.value,e.maxSize.message,t),r}(e,r);case xi.ZodLazy:return()=>e.getter()._def;case xi.ZodPromise:return function(e,t){return td(e.type._def,t)}(e,r);case xi.ZodNaN:case xi.ZodNever:return function(e){return"openAi"===e.target?void 0:{not:Su({...e,currentPath:[...e.currentPath,"not"]})}}(r);case xi.ZodEffects:return function(e,t){return"input"===t.effectStrategy?td(e.schema._def,t):Su(t)}(e,r);case xi.ZodAny:return Su(r);case xi.ZodUnknown:return function(e){return Su(e)}(r);case xi.ZodDefault:return function(e,t){return{...td(e.innerType._def,t),default:e.defaultValue()}}(e,r);case xi.ZodBranded:return Pu(e,r);case xi.ZodReadonly:case xi.ZodCatch:return((e,t)=>td(e.innerType._def,t))(e,r);case xi.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return td(e.in._def,t);if("output"===t.pipeStrategy)return td(e.out._def,t);const r=td(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[r,td(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]})].filter(e=>void 0!==e)}})(e,r);case xi.ZodFunction:case xi.ZodVoid:case xi.ZodSymbol:default:return}};function td(e,t,r=!1){const n=t.seen.get(e);if(t.override){const a=t.override?.(e,t,n,r);if(a!==Eu)return a}if(n&&!r){const e=rd(n,t);if(void 0!==e)return e}const a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);const s=ed(e,e.typeName,t),i="function"==typeof s?td(s(),t):s;if(i&&nd(e,t,i),t.postProcess){const r=t.postProcess(i,e,t);return a.jsonSchema=i,r}return a.jsonSchema=i,i}const rd=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:xu(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),Su(t)):"seen"===t.$refStrategy?Su(t):void 0}},nd=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),ad=(e,t)=>{const r=(e=>{const t=(e=>"string"==typeof e?{...ku,name:e}:{...ku,...e})(e),r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([e,r])=>[r._def,{def:r._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t);let n="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,n])=>({...e,[t]:td(n._def,{...r,currentPath:[...r.basePath,r.definitionPath,t]},!0)??Su(r)}),{}):void 0;const a="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,s=td(e._def,void 0===a?r:{...r,currentPath:[...r.basePath,r.definitionPath,a]},!1)??Su(r),i="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==i&&(s.title=i),r.flags.hasReferencedOpenAiAnyType&&(n||(n={}),n[r.openAiAnyTypeName]||(n[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===r.$refStrategy?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));const o=void 0===a?n?{...s,[r.definitionPath]:n}:s:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,a].join("/"),[r.definitionPath]:{...n,[a]:s}};return"jsonSchema7"===r.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"!==r.target&&"openAi"!==r.target||(o.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===r.target&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o};function sd(e,t){const r=typeof e;if(r!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const r=e.length;if(r!==t.length)return!1;for(let n=0;n<r;n++)if(!sd(e[n],t[n]))return!1;return!0}if("object"===r){if(!e||!t)return e===t;const r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(const n of r)if(!sd(e[n],t[n]))return!1;return!0}return e===t}function id(e){return encodeURI(function(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}(e))}const od={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},cd={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},ld={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0};let ud="undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");function dd(e,t=Object.create(null),r=ud,n=""){if(e&&"object"==typeof e&&!Array.isArray(e)){const a=e.$id||e.id;if(a){const s=new URL(a,r.href);s.hash.length>1?t[s.href]=e:(s.hash="",""===n?r=s:dd(e,t,r))}}else if(!0!==e&&!1!==e)return t;const a=r.href+(n?"#"+n:"");if(void 0!==t[a])throw new Error(`Duplicate schema URI "${a}".`);if(t[a]=e,!0===e||!1===e)return t;if(void 0===e.__absolute_uri__&&Object.defineProperty(e,"__absolute_uri__",{enumerable:!1,value:a}),e.$ref&&void 0===e.__absolute_ref__){const t=new URL(e.$ref,r.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_ref__",{enumerable:!1,value:t.href})}if(e.$recursiveRef&&void 0===e.__absolute_recursive_ref__){const t=new URL(e.$recursiveRef,r.href);t.hash=t.hash,Object.defineProperty(e,"__absolute_recursive_ref__",{enumerable:!1,value:t.href})}e.$anchor&&(t[new URL("#"+e.$anchor,r.href).href]=e);for(let a in e){if(ld[a])continue;const s=`${n}/${id(a)}`,i=e[a];if(Array.isArray(i)){if(od[a]){const e=i.length;for(let n=0;n<e;n++)dd(i[n],t,r,`${s}/${n}`)}}else if(cd[a])for(let e in i)dd(i[e],t,r,`${s}/${id(e)}`);else dd(i,t,r,s)}return t}const hd=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,pd=[0,31,28,31,30,31,30,31,31,30,31,30,31],fd=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i;function md(e){return e.test.bind(e)}const gd={date:yd,time:_d.bind(void 0,!1),"date-time":function(e){const t=e.split(bd);return 2==t.length&&yd(t[0])&&_d(!0,t[1])},duration:e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),uri:function(e){return wd.test(e)&&vd.test(e)},"uri-reference":md(/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i),"uri-template":md(/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i),url:md(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu),email:e=>{if('"'===e[0])return!1;const[t,r,...n]=e.split("@");return!(!t||!r||0!==n.length||t.length>64||r.length>253)&&"."!==t[0]&&!t.endsWith(".")&&!t.includes("..")&&!(!/^[a-z0-9.-]+$/i.test(r)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t))&&r.split(".").every(e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e))},hostname:md(/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i),ipv4:md(/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/),ipv6:md(/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i),regex:function(e){if(Od.test(e))return!1;try{return new RegExp(e,"u"),!0}catch(e){return!1}},uuid:md(/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i),"json-pointer":md(/^(?:\/(?:[^~/]|~0|~1)*)*$/),"json-pointer-uri-fragment":md(/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i),"relative-json-pointer":md(/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/)};function yd(e){const t=e.match(hd);if(!t)return!1;const r=+t[1],n=+t[2],a=+t[3];return n>=1&&n<=12&&a>=1&&a<=(2==n&&function(e){return e%4==0&&(e%100!=0||e%400==0)}(r)?29:pd[n])}function _d(e,t){const r=t.match(fd);if(!r)return!1;const n=+r[1],a=+r[2],s=+r[3],i=!!r[5];return(n<=23&&a<=59&&s<=59||23==n&&59==a&&60==s)&&(!e||i)}const bd=/t|\s/i,wd=/\/|:/,vd=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,Od=/[^\\]\\Z/;var Ed;function kd(e,t,r="2019-09",n=dd(t),a=!0,s=null,i="#",o="#",c=Object.create(null)){if(!0===t)return{valid:!0,errors:[]};if(!1===t)return{valid:!1,errors:[{instanceLocation:i,keyword:"false",keywordLocation:i,error:"False boolean schema."}]};const l=typeof e;let u;switch(l){case"boolean":case"number":case"string":u=l;break;case"object":u=null===e?"null":Array.isArray(e)?"array":"object";break;default:throw new Error(`Instances of "${l}" type are not supported.`)}const{$ref:d,$recursiveRef:h,$recursiveAnchor:p,type:f,const:m,enum:g,required:y,not:_,anyOf:b,allOf:w,oneOf:v,if:O,then:E,else:k,format:x,properties:S,patternProperties:A,additionalProperties:I,unevaluatedProperties:P,minProperties:$,maxProperties:T,propertyNames:j,dependentRequired:R,dependentSchemas:N,dependencies:C,prefixItems:L,items:M,additionalItems:z,unevaluatedItems:U,contains:D,minContains:F,maxContains:B,minItems:Z,maxItems:q,uniqueItems:H,minimum:J,maximum:G,exclusiveMinimum:W,exclusiveMaximum:K,multipleOf:V,minLength:X,maxLength:Y,pattern:Q,__absolute_ref__:ee,__absolute_recursive_ref__:te}=t,re=[];if(!0===p&&null===s&&(s=t),"#"===h){const l=null===s?n[te]:s,u=`${o}/$recursiveRef`,d=kd(e,null===s?t:s,r,n,a,l,i,u,c);d.valid||re.push({instanceLocation:i,keyword:"$recursiveRef",keywordLocation:u,error:"A subschema had errors."},...d.errors)}if(void 0!==d){const t=n[ee||d];if(void 0===t){let e=`Unresolved $ref "${d}".`;throw ee&&ee!==d&&(e+=`  Absolute URI "${ee}".`),e+=`\nKnown schemas:\n- ${Object.keys(n).join("\n- ")}`,new Error(e)}const l=`${o}/$ref`,u=kd(e,t,r,n,a,s,i,l,c);if(u.valid||re.push({instanceLocation:i,keyword:"$ref",keywordLocation:l,error:"A subschema had errors."},...u.errors),"4"===r||"7"===r)return{valid:0===re.length,errors:re}}if(Array.isArray(f)){let t=f.length,r=!1;for(let n=0;n<t;n++)if(u===f[n]||"integer"===f[n]&&"number"===u&&e%1==0&&e==e){r=!0;break}r||re.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f.join('", "')}".`})}else"integer"===f?("number"!==u||e%1||e!=e)&&re.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f}".`}):void 0!==f&&u!==f&&re.push({instanceLocation:i,keyword:"type",keywordLocation:`${o}/type`,error:`Instance type "${u}" is invalid. Expected "${f}".`});if(void 0!==m&&("object"===u||"array"===u?sd(e,m)||re.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`}):e!==m&&re.push({instanceLocation:i,keyword:"const",keywordLocation:`${o}/const`,error:`Instance does not match ${JSON.stringify(m)}.`})),void 0!==g&&("object"===u||"array"===u?g.some(t=>sd(e,t))||re.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`}):g.some(t=>e===t)||re.push({instanceLocation:i,keyword:"enum",keywordLocation:`${o}/enum`,error:`Instance does not match any of ${JSON.stringify(g)}.`})),void 0!==_){const t=`${o}/not`;kd(e,_,r,n,a,s,i,t).valid&&re.push({instanceLocation:i,keyword:"not",keywordLocation:t,error:'Instance matched "not" schema.'})}let ne=[];if(void 0!==b){const t=`${o}/anyOf`,l=re.length;let u=!1;for(let o=0;o<b.length;o++){const l=b[o],d=Object.create(c),h=kd(e,l,r,n,a,!0===p?s:null,i,`${t}/${o}`,d);re.push(...h.errors),u=u||h.valid,h.valid&&ne.push(d)}u?re.length=l:re.splice(l,0,{instanceLocation:i,keyword:"anyOf",keywordLocation:t,error:"Instance does not match any subschemas."})}if(void 0!==w){const t=`${o}/allOf`,l=re.length;let u=!0;for(let o=0;o<w.length;o++){const l=w[o],d=Object.create(c),h=kd(e,l,r,n,a,!0===p?s:null,i,`${t}/${o}`,d);re.push(...h.errors),u=u&&h.valid,h.valid&&ne.push(d)}u?re.length=l:re.splice(l,0,{instanceLocation:i,keyword:"allOf",keywordLocation:t,error:"Instance does not match every subschema."})}if(void 0!==v){const t=`${o}/oneOf`,l=re.length,u=v.filter((o,l)=>{const u=Object.create(c),d=kd(e,o,r,n,a,!0===p?s:null,i,`${t}/${l}`,u);return re.push(...d.errors),d.valid&&ne.push(u),d.valid}).length;1===u?re.length=l:re.splice(l,0,{instanceLocation:i,keyword:"oneOf",keywordLocation:t,error:`Instance does not match exactly one subschema (${u} matches).`})}if("object"!==u&&"array"!==u||Object.assign(c,...ne),void 0!==O){const t=`${o}/if`;if(kd(e,O,r,n,a,s,i,t,c).valid){if(void 0!==E){const l=kd(e,E,r,n,a,s,i,`${o}/then`,c);l.valid||re.push({instanceLocation:i,keyword:"if",keywordLocation:t,error:'Instance does not match "then" schema.'},...l.errors)}}else if(void 0!==k){const l=kd(e,k,r,n,a,s,i,`${o}/else`,c);l.valid||re.push({instanceLocation:i,keyword:"if",keywordLocation:t,error:'Instance does not match "else" schema.'},...l.errors)}}if("object"===u){if(void 0!==y)for(const t of y)t in e||re.push({instanceLocation:i,keyword:"required",keywordLocation:`${o}/required`,error:`Instance does not have required property "${t}".`});const t=Object.keys(e);if(void 0!==$&&t.length<$&&re.push({instanceLocation:i,keyword:"minProperties",keywordLocation:`${o}/minProperties`,error:`Instance does not have at least ${$} properties.`}),void 0!==T&&t.length>T&&re.push({instanceLocation:i,keyword:"maxProperties",keywordLocation:`${o}/maxProperties`,error:`Instance does not have at least ${T} properties.`}),void 0!==j){const t=`${o}/propertyNames`;for(const o in e){const e=`${i}/${id(o)}`,c=kd(o,j,r,n,a,s,e,t);c.valid||re.push({instanceLocation:i,keyword:"propertyNames",keywordLocation:t,error:`Property name "${o}" does not match schema.`},...c.errors)}}if(void 0!==R){const t=`${o}/dependantRequired`;for(const r in R)if(r in e){const n=R[r];for(const a of n)a in e||re.push({instanceLocation:i,keyword:"dependentRequired",keywordLocation:t,error:`Instance has "${r}" but does not have "${a}".`})}}if(void 0!==N)for(const t in N){const l=`${o}/dependentSchemas`;if(t in e){const o=kd(e,N[t],r,n,a,s,i,`${l}/${id(t)}`,c);o.valid||re.push({instanceLocation:i,keyword:"dependentSchemas",keywordLocation:l,error:`Instance has "${t}" but does not match dependant schema.`},...o.errors)}}if(void 0!==C){const t=`${o}/dependencies`;for(const o in C)if(o in e){const c=C[o];if(Array.isArray(c))for(const r of c)r in e||re.push({instanceLocation:i,keyword:"dependencies",keywordLocation:t,error:`Instance has "${o}" but does not have "${r}".`});else{const l=kd(e,c,r,n,a,s,i,`${t}/${id(o)}`);l.valid||re.push({instanceLocation:i,keyword:"dependencies",keywordLocation:t,error:`Instance has "${o}" but does not match dependant schema.`},...l.errors)}}}const l=Object.create(null);let u=!1;if(void 0!==S){const t=`${o}/properties`;for(const o in S){if(!(o in e))continue;const d=`${i}/${id(o)}`,h=kd(e[o],S[o],r,n,a,s,d,`${t}/${id(o)}`);if(h.valid)c[o]=l[o]=!0;else if(u=a,re.push({instanceLocation:i,keyword:"properties",keywordLocation:t,error:`Property "${o}" does not match schema.`},...h.errors),u)break}}if(!u&&void 0!==A){const t=`${o}/patternProperties`;for(const o in A){const d=new RegExp(o,"u"),h=A[o];for(const p in e){if(!d.test(p))continue;const f=`${i}/${id(p)}`,m=kd(e[p],h,r,n,a,s,f,`${t}/${id(o)}`);m.valid?c[p]=l[p]=!0:(u=a,re.push({instanceLocation:i,keyword:"patternProperties",keywordLocation:t,error:`Property "${p}" matches pattern "${o}" but does not match associated schema.`},...m.errors))}}}if(u||void 0===I){if(!u&&void 0!==P){const t=`${o}/unevaluatedProperties`;for(const o in e)if(!c[o]){const l=`${i}/${id(o)}`,u=kd(e[o],P,r,n,a,s,l,t);u.valid?c[o]=!0:re.push({instanceLocation:i,keyword:"unevaluatedProperties",keywordLocation:t,error:`Property "${o}" does not match unevaluated properties schema.`},...u.errors)}}}else{const t=`${o}/additionalProperties`;for(const o in e){if(l[o])continue;const d=`${i}/${id(o)}`,h=kd(e[o],I,r,n,a,s,d,t);h.valid?c[o]=!0:(u=a,re.push({instanceLocation:i,keyword:"additionalProperties",keywordLocation:t,error:`Property "${o}" does not match additional properties schema.`},...h.errors))}}}else if("array"===u){void 0!==q&&e.length>q&&re.push({instanceLocation:i,keyword:"maxItems",keywordLocation:`${o}/maxItems`,error:`Array has too many items (${e.length} > ${q}).`}),void 0!==Z&&e.length<Z&&re.push({instanceLocation:i,keyword:"minItems",keywordLocation:`${o}/minItems`,error:`Array has too few items (${e.length} < ${Z}).`});const t=e.length;let l=0,u=!1;if(void 0!==L){const d=`${o}/prefixItems`,h=Math.min(L.length,t);for(;l<h;l++){const t=kd(e[l],L[l],r,n,a,s,`${i}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(u=a,re.push({instanceLocation:i,keyword:"prefixItems",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}}if(void 0!==M){const d=`${o}/items`;if(Array.isArray(M)){const o=Math.min(M.length,t);for(;l<o;l++){const t=kd(e[l],M[l],r,n,a,s,`${i}/${l}`,`${d}/${l}`);if(c[l]=!0,!t.valid&&(u=a,re.push({instanceLocation:i,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}}else for(;l<t;l++){const t=kd(e[l],M,r,n,a,s,`${i}/${l}`,d);if(c[l]=!0,!t.valid&&(u=a,re.push({instanceLocation:i,keyword:"items",keywordLocation:d,error:"Items did not match schema."},...t.errors),u))break}if(!u&&void 0!==z){const d=`${o}/additionalItems`;for(;l<t;l++){const t=kd(e[l],z,r,n,a,s,`${i}/${l}`,d);c[l]=!0,t.valid||(u=a,re.push({instanceLocation:i,keyword:"additionalItems",keywordLocation:d,error:"Items did not match additional items schema."},...t.errors))}}}if(void 0!==D)if(0===t&&void 0===F)re.push({instanceLocation:i,keyword:"contains",keywordLocation:`${o}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(void 0!==F&&t<F)re.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array has less items (${t}) than minContains (${F}).`});else{const l=`${o}/contains`,u=re.length;let d=0;for(let o=0;o<t;o++){const t=kd(e[o],D,r,n,a,s,`${i}/${o}`,l);t.valid?(c[o]=!0,d++):re.push(...t.errors)}d>=(F||0)&&(re.length=u),void 0===F&&void 0===B&&0===d?re.splice(u,0,{instanceLocation:i,keyword:"contains",keywordLocation:l,error:"Array does not contain item matching schema."}):void 0!==F&&d<F?re.push({instanceLocation:i,keyword:"minContains",keywordLocation:`${o}/minContains`,error:`Array must contain at least ${F} items matching schema. Only ${d} items were found.`}):void 0!==B&&d>B&&re.push({instanceLocation:i,keyword:"maxContains",keywordLocation:`${o}/maxContains`,error:`Array may contain at most ${B} items matching schema. ${d} items were found.`})}if(!u&&void 0!==U){const u=`${o}/unevaluatedItems`;for(;l<t;l++){if(c[l])continue;const t=kd(e[l],U,r,n,a,s,`${i}/${l}`,u);c[l]=!0,t.valid||re.push({instanceLocation:i,keyword:"unevaluatedItems",keywordLocation:u,error:"Items did not match unevaluated items schema."},...t.errors)}}if(H)for(let r=0;r<t;r++){const n=e[r],a="object"==typeof n&&null!==n;for(let s=0;s<t;s++){if(r===s)continue;const t=e[s];(n===t||a&&"object"==typeof t&&null!==t&&sd(n,t))&&(re.push({instanceLocation:i,keyword:"uniqueItems",keywordLocation:`${o}/uniqueItems`,error:`Duplicate items at indexes ${r} and ${s}.`}),r=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER)}}}else if("number"===u){if("4"===r?(void 0!==J&&(!0===W&&e<=J||e<J)&&re.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${W?"or equal to ":""} ${J}.`}),void 0!==G&&(!0===K&&e>=G||e>G)&&re.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${K?"or equal to ":""} ${G}.`})):(void 0!==J&&e<J&&re.push({instanceLocation:i,keyword:"minimum",keywordLocation:`${o}/minimum`,error:`${e} is less than ${J}.`}),void 0!==G&&e>G&&re.push({instanceLocation:i,keyword:"maximum",keywordLocation:`${o}/maximum`,error:`${e} is greater than ${G}.`}),void 0!==W&&e<=W&&re.push({instanceLocation:i,keyword:"exclusiveMinimum",keywordLocation:`${o}/exclusiveMinimum`,error:`${e} is less than ${W}.`}),void 0!==K&&e>=K&&re.push({instanceLocation:i,keyword:"exclusiveMaximum",keywordLocation:`${o}/exclusiveMaximum`,error:`${e} is greater than or equal to ${K}.`})),void 0!==V){const t=e%V;Math.abs(0-t)>=1.1920929e-7&&Math.abs(V-t)>=1.1920929e-7&&re.push({instanceLocation:i,keyword:"multipleOf",keywordLocation:`${o}/multipleOf`,error:`${e} is not a multiple of ${V}.`})}}else if("string"===u){const t=void 0===X&&void 0===Y?0:function(e){let t,r=0,n=e.length,a=0;for(;a<n;)r++,t=e.charCodeAt(a++),t>=55296&&t<=56319&&a<n&&(t=e.charCodeAt(a),56320==(64512&t)&&a++);return r}(e);void 0!==X&&t<X&&re.push({instanceLocation:i,keyword:"minLength",keywordLocation:`${o}/minLength`,error:`String is too short (${t} < ${X}).`}),void 0!==Y&&t>Y&&re.push({instanceLocation:i,keyword:"maxLength",keywordLocation:`${o}/maxLength`,error:`String is too long (${t} > ${Y}).`}),void 0===Q||new RegExp(Q,"u").test(e)||re.push({instanceLocation:i,keyword:"pattern",keywordLocation:`${o}/pattern`,error:"String does not match pattern."}),void 0!==x&&gd[x]&&!gd[x](e)&&re.push({instanceLocation:i,keyword:"format",keywordLocation:`${o}/format`,error:`String does not match format "${x}".`})}return{valid:0===re.length,errors:re}}function xd(e,t,r){function n(r,n){var a;Object.defineProperty(r,"_zod",{value:r._zod??{},enumerable:!1}),(a=r._zod).traits??(a.traits=new Set),r._zod.traits.add(e),t(r,n);for(const e in i.prototype)e in r||Object.defineProperty(r,e,{value:i.prototype[e].bind(r)});r._zod.constr=i,r._zod.def=n}const a=r?.Parent??Object;class s extends a{}function i(e){var t;const a=r?.Parent?new s:this;n(a,e),(t=a._zod).deferred??(t.deferred=[]);for(const e of a._zod.deferred)e();return a}return Object.defineProperty(s,"name",{value:e}),Object.defineProperty(i,"init",{value:n}),Object.defineProperty(i,Symbol.hasInstance,{value:t=>!!(r?.Parent&&t instanceof r.Parent)||t?._zod?.traits?.has(e)}),Object.defineProperty(i,"name",{value:e}),i}!function(e){e[e.Flag=1]="Flag",e[e.Basic=2]="Basic",e[e.Detailed=4]="Detailed"}(Ed||(Ed={})),Object.freeze({status:"aborted"}),Symbol("zod_brand");class Sd extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const Ad={};function Id(e){return e&&Object.assign(Ad,e),Ad}const Pd=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get:()=>JSON.stringify(t,pu,2),enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},$d=xd("$ZodError",Pd),Td=xd("$ZodError",Pd,{Parent:Error}),jd=e=>(t,r,n,a)=>{const s=n?Object.assign(n,{async:!1}):{async:!1},i=t._zod.run({value:r,issues:[]},s);if(i instanceof Promise)throw new Sd;if(i.issues.length){const t=new(a?.Err??e)(i.issues.map(e=>bu(e,s,Id())));throw fu(t,a?.callee),t}return i.value},Rd=jd(Td),Nd=e=>async(t,r,n,a)=>{const s=n?Object.assign(n,{async:!0}):{async:!0};let i=t._zod.run({value:r,issues:[]},s);if(i instanceof Promise&&(i=await i),i.issues.length){const t=new(a?.Err??e)(i.issues.map(e=>bu(e,s,Id())));throw fu(t,a?.callee),t}return i.value},Cd=Nd(Td),Ld=e=>(t,r,n)=>{const a=n?{...n,async:!1}:{async:!1},s=t._zod.run({value:r,issues:[]},a);if(s instanceof Promise)throw new Sd;return s.issues.length?{success:!1,error:new(e??$d)(s.issues.map(e=>bu(e,a,Id())))}:{success:!0,data:s.value}},Md=Ld(Td),zd=e=>async(t,r,n)=>{const a=n?Object.assign(n,{async:!0}):{async:!0};let s=t._zod.run({value:r,issues:[]},a);return s instanceof Promise&&(s=await s),s.issues.length?{success:!1,error:new e(s.issues.map(e=>bu(e,a,Id())))}:{success:!0,data:s.value}},Ud=zd(Td);const Dd={major:4,minor:0,patch:0},Fd=xd("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=Dd;const n=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&n.unshift(e);for(const t of n)for(const r of t._zod.onattach)r(e);if(0===n.length)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const t=(e,t,r)=>{let n,a=yu(e);for(const s of t){if(s._zod.def.when){if(!s._zod.def.when(e))continue}else if(a)continue;const t=e.issues.length,i=s._zod.check(e);if(i instanceof Promise&&!1===r?.async)throw new Sd;if(n||i instanceof Promise)n=(n??Promise.resolve()).then(async()=>{await i,e.issues.length!==t&&(a||(a=yu(e,t)))});else{if(e.issues.length===t)continue;a||(a=yu(e,t))}}return n?n.then(()=>e):e};e._zod.run=(r,a)=>{const s=e._zod.parse(r,a);if(s instanceof Promise){if(!1===a.async)throw new Sd;return s.then(e=>t(e,n,a))}return t(s,n,a)}}e["~standard"]={validate:t=>{try{const r=Md(e,t);return r.success?{value:r.data}:{issues:r.error?.issues}}catch(r){return Ud(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),Bd=xd("$ZodNever",(e,t)=>{Fd.init(e,t),e._zod.parse=(t,r)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)});function Zd(e){if("object"!=typeof e||null===e)return!1;if(!("_zod"in e))return!1;const t=e._zod;return"object"==typeof t&&null!==t&&"def"in t}function qd(e){if("object"!=typeof e||null===e)return!1;if(!("_def"in e)||"_zod"in e)return!1;const t=e._def;return"object"==typeof t&&null!=t&&"typeName"in t}function Hd(e){return!(!e||"object"!=typeof e||Array.isArray(e)||!Zd(e)&&!qd(e))}async function Jd(e,t){if(Zd(e))return Rd(e,t);if(qd(e))return e.parse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Gd(e){return Zd(e)?hu.get(e)?.description:qd(e)||"description"in e&&"string"==typeof e.description?e.description:void 0}function Wd(e){return!!Zd(e)&&"object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"object"===e._zod.def.type}function Kd(e){return!!Zd(e)&&"object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"array"===e._zod.def.type}function Vd(e,t=!1){if(qd(e))return e.strict();if(Wd(e)){const a=e._zod.def.shape;if(t)for(const[r,n]of Object.entries(e._zod.def.shape)){if(Wd(n)){const e=Vd(n,t);a[r]=e}else if(Kd(n)){let e=n._zod.def.element;Wd(e)&&(e=Vd(e,t)),a[r]=mu(n,{...n._zod.def,element:e})}else a[r]=n;const e=hu.get(n);e&&hu.add(a[r],e)}const s=mu(e,{...e._zod.def,shape:a,catchall:(r=Bd,new r({type:"never",...gu(n)}))}),i=hu.get(e);return i&&hu.add(s,i),s}var r,n;throw new Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}function Xd(e,t=!1){if(qd(e))return function(e){return qd(e)&&"typeName"in e._def&&"ZodEffects"===e._def.typeName}(e)?Xd(e._def.schema,t):e;if(Zd(e)){let r=e;if(function(e){return Zd(e)&&"pipe"===e._zod.def.type}(e)&&(r=Xd(e._zod.def.in,t)),t)if(Wd(r)){const e=r._zod.def.shape;for(const[n,a]of Object.entries(r._zod.def.shape))e[n]=Xd(a,t);r=mu(r,{...r._zod.def,shape:e})}else if(Kd(r)){const e=Xd(r._zod.def.element,t);r=mu(r,{...r._zod.def,element:e})}const n=hu.get(e);return n&&hu.add(r,n),r}throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function Yd(e){if(Zd(e)){const t=Xd(e,!0);return Wd(t)?vu(Vd(t,!0)):vu(e)}return qd(e)?ad(e):e}function Qd(e,t){if(void 0!==e&&!Nc(e))return e;if(!iu(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e,e}catch(e){return t.getName()}}function eh(e){return iu(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Yd(e.data.schema),title:e.data.name}}}class th{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){const e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Nc(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...eh(t)})),edges:this.edges.map(t=>{const r={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(r.data=t.data),void 0!==t.conditional&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const n=t??Mi(),a={id:n,data:e,name:Qd(t,e),metadata:r};return this.nodes[n]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,n){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const a={source:e.id,target:t.id,data:r,conditional:n};return this.edges.push(a),a}firstNode(){return rh(this)}lastNode(){return nh(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(e=>e.id).every(Nc)&&(r="");const n=e=>r?`${r}:${e}`:e;Object.entries(e.nodes).forEach(([e,t])=>{this.nodes[n(e)]={...t,id:n(e)}});const a=e.edges.map(e=>({...e,source:n(e.source),target:n(e.target)}));this.edges=[...this.edges,...a];const s=e.firstNode(),i=e.lastNode();return[s?{id:n(s.id),data:s.data}:void 0,i?{id:n(i.id),data:i.data}:void 0]}trimFirstNode(){const e=this.firstNode();e&&rh(this,[e.id])&&this.removeNode(e)}trimLastNode(){const e=this.lastNode();e&&nh(this,[e.id])&&this.removeNode(e)}reid(){const e=Object.fromEntries(Object.values(this.nodes).map(e=>[e.id,e.name])),t=new Map;Object.values(e).forEach(e=>{t.set(e,(t.get(e)||0)+1)});const r=r=>{const n=e[r];return Nc(r)&&1===t.get(n)?n:r};return new th({nodes:Object.fromEntries(Object.entries(this.nodes).map(([e,t])=>[r(e),{...t,id:r(e)}])),edges:this.edges.map(e=>({...e,source:r(e.source),target:r(e.target)}))})}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:n={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:a}=e??{},s=this.reid(),i=s.firstNode(),o=s.lastNode();return function(e,t,r){const{firstNode:n,lastNode:a,nodeColors:s,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=r??{};let l=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(i){const t="default",r={[t]:"{0}({1})"};void 0!==n&&(r[n]="{0}([{1}]):::first"),void 0!==a&&(r[a]="{0}([{1}]):::last");for(const[n,a]of Object.entries(e)){const e=a.name.split(":").pop()??"";let s=lu.some(t=>e.startsWith(t)&&e.endsWith(t))?`<p>${e}</p>`:e;Object.keys(a.metadata??{}).length&&(s+=`<hr/><small><em>${Object.entries(a.metadata??{}).map(([e,t])=>`${e} = ${t}`).join("\n")}</em></small>`);const i=(r[n]??r[t]).replace("{0}",cu(n)).replace("{1}",s);l+=`\t${i}\n`}}const u={};for(const e of t){const t=e.source.split(":"),r=e.target.split(":"),n=t.filter((e,t)=>e===r[t]).join(":");u[n]||(u[n]=[]),u[n].push(e)}const d=new Set;function h(e,t){const r=1===e.length&&e[0].source===e[0].target;if(t&&!r){const e=t.split(":").pop();if(d.has(e))throw new Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(e),l+=`\tsubgraph ${e}\n`}for(const t of e){const{source:e,target:r,data:n,conditional:a}=t;let s="";if(void 0!==n){let e=n;const t=e.split(" ");t.length>c&&(e=Array.from({length:Math.ceil(t.length/c)},(e,r)=>t.slice(r*c,(r+1)*c).join(" ")).join("&nbsp;<br>&nbsp;")),s=a?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --\x3e `}else s=a?" -.-> ":" --\x3e ";l+=`\t${cu(e)}${s}${cu(r)};\n`}for(const e in u)e.startsWith(`${t}:`)&&e!==t&&h(u[e],e);t&&!r&&(l+="\tend\n")}h(u[""]??[],"");for(const e in u)e.includes(":")||""===e||h(u[e],e);return i&&(l+=function(e){let t="";for(const[r,n]of Object.entries(e))t+=`\tclassDef ${r} ${n};\n`;return t}(s??{})),l}(s.nodes,s.edges,{firstNode:i?.id,lastNode:o?.id,withStyles:t,curveStyle:r,nodeColors:n,wrapLabelNWords:a})}async drawMermaidPng(e){return async function(e,t){return async function(e,t){let r=t?.backgroundColor??"white";const n=t?.imageType??"png",a=btoa(e);void 0!==r&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const s=`https://mermaid.ink/img/${a}?bgColor=${r}&type=${n}`,i=await fetch(s);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join("\n"));return await i.blob()}(e,{...t,imageType:"png"})}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function rh(e,t=[]){const r=new Set(e.edges.filter(e=>!t.includes(e.source)).map(e=>e.target)),n=[];for(const a of Object.values(e.nodes))t.includes(a.id)||r.has(a.id)||n.push(a);return 1===n.length?n[0]:void 0}function nh(e,t=[]){const r=new Set(e.edges.filter(e=>!t.includes(e.target)).map(e=>e.source)),n=[];for(const a of Object.values(e.nodes))t.includes(a.id)||r.has(a.id)||n.push(a);return 1===n.length?n[0]:void 0}function ah(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function sh(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*ih(e,t){for(;;){const{value:r,done:n}=jl.runWithConfig(zl(e),t.next.bind(t),!0);if(n)break;yield r}}async function*oh(e,t){const r=t[Symbol.asyncIterator]();for(;;){const{value:n,done:a}=await jl.runWithConfig(zl(e),r.next.bind(t),!0);if(a)break;yield n}}function ch(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class lh extends ma{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new uh({bound:this,kwargs:e,config:{}})}map(){return new dh({bound:this})}withRetry(e){return new hh({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new uh({bound:this,config:e,kwargs:{}})}withFallbacks(e){const t=Array.isArray(e)?e:e.fallbacks;return new yh({runnable:this,fallbacks:t})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Ll);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter(([e])=>"runId"!==e));return Array.from({length:t},(t,n)=>Ll(0===n?e:r))}return Array.from({length:t},()=>Ll(e))}async batch(e,t,r){const n=this._getOptionsList(t??{},e.length),a=n[0]?.maxConcurrency??r?.maxConcurrency,s=new au({maxConcurrency:a,onFailedAttempt:e=>{throw e}}),i=e.map((e,t)=>s.call(async()=>{try{return await this.invoke(e,n[t])}catch(e){if(r?.returnExceptions)return e;throw e}}));return Promise.all(i)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=Ll(t),n=new Zl({generator:this._streamIterator(e,r),config:r});return await n.setup,Dl.fromAsyncGenerator(n)}_separateRunnableConfigFromCallOptions(e){let t;t=Ll(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){const n=Ll(r),a=await Rl(n),s=await(a?.handleChainStart(this.toJSON(),ch(t,"input"),n.runId,n?.runType,void 0,void 0,n?.runName??this.getName()));let i;delete n.runId;try{const a=e.call(this,t,n,s);i=await Ul(a,r?.signal)}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(ch(i,"output"))),i}async _batchWithConfig(e,t,r,n){const a=this._getOptionsList(r??{},t.length),s=await Promise.all(a.map(Rl)),i=await Promise.all(s.map(async(e,r)=>{const n=await(e?.handleChainStart(this.toJSON(),ch(t[r],"input"),a[r].runId,a[r].runType,void 0,void 0,a[r].runName??this.getName()));return delete a[r].runId,n}));let o;try{const r=e.call(this,t,a,i,n);o=await Ul(r,a?.[0]?.signal)}catch(e){throw await Promise.all(i.map(t=>t?.handleChainError(e))),e}return await Promise.all(i.map(e=>e?.handleChainEnd(ch(o,"output")))),o}_concatOutputChunks(e,t){return Bl(e,t)}async*_transformStreamWithConfig(e,t,r){let n,a,s=!0,i=!0;const o=Ll(r),c=await Rl(o),l=this;let u;try{const d=await async function(e,t,r,n,...a){const s=new Zl({generator:t,startSetup:r,signal:n}),i=await s.setup;return{output:e(s,i,...a),setup:i}}(t.bind(this),async function*(){for await(const t of e){if(s)if(void 0===n)n=t;else try{n=l._concatOutputChunks(n,t)}catch{n=void 0,s=!1}yield t}}(),async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName()),r?.signal,o);delete o.runId,u=d.setup;const h=u?.handlers.find(eu);let p=d.output;void 0!==h&&void 0!==u&&(p=h.tapOutputIterable(u.runId,p));const f=u?.handlers.find(Jl);void 0!==f&&void 0!==u&&(p=f.tapOutputIterable(u.runId,p));for await(const e of p)if(yield e,i)if(void 0===a)a=e;else try{a=this._concatOutputChunks(a,e)}catch{a=void 0,i=!1}}catch(e){throw await(u?.handleChainError(e,void 0,void 0,void 0,{inputs:ch(n,"input")})),e}await(u?.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:ch(n,"input")}))}getGraph(e){const t=new th,r=t.addNode({name:`${this.getName()}Input`,schema:Ai()}),n=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:Ai()});return t.addEdge(r,n),t.addEdge(n,a),t}pipe(e){return new ph({first:this,last:_h(e)})}pick(e){return this.pipe(new wh(e))}assign(e){return this.pipe(new bh(new fh({steps:e})))}async*transform(e,t){let r;for await(const t of e)r=void 0===r?t:this._concatOutputChunks(r,t);yield*this._streamIterator(r,Ll(t))}async*streamLog(e,t,r){const n=new Kl({...r,autoClose:!1,_schemaFormat:"original"}),a=Ll(t);yield*this._streamLog(e,n,a)}async*_streamLog(e,t,r){const{callbacks:n}=r;if(void 0===n)r.callbacks=[t];else if(Array.isArray(n))r.callbacks=n.concat([t]);else{const e=n.copy();e.addHandler(t,!0),r.callbacks=e}const a=this.stream(e,r),s=async function(){try{const e=await a;for await(const r of e){const e=new ql({ops:[{op:"add",path:"/streamed_output/-",value:r}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await s}}streamEvents(e,t,r){let n;if("v1"===t.version)n=this._streamEventsV1(e,t,r);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');n=this._streamEventsV2(e,t,r)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,r=new ReadableStream({async start(r){for await(const n of e)r.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(n)}\n\n`));r.enqueue(t.encode("event: end\n\n")),r.close()}});return Dl.fromReadableStream(r)}(n):Dl.fromAsyncGenerator(n)}async*_streamEventsV2(e,t,r){const n=new tu({...r,autoClose:!1}),a=Ll(t),s=a.runId??Mi();a.runId=s;const i=a.callbacks;if(void 0===i)a.callbacks=[n];else if(Array.isArray(i))a.callbacks=i.concat(n);else{const e=i.copy();e.addHandler(n,!0),a.callbacks=e}const o=new AbortController,c=this,l=async function(){let r,i=null;try{t?.signal?"any"in AbortSignal?r=AbortSignal.any([o.signal,t.signal]):(r=t.signal,i=()=>{o.abort()},t.signal.addEventListener("abort",i,{once:!0})):r=o.signal;const l=await c.stream(e,{...a,signal:r}),u=n.tapOutputIterable(s,l);for await(const e of u)if(o.signal.aborted)break}finally{await n.finish(),r&&i&&r.removeEventListener("abort",i)}}();let u,d=!1;try{for await(const t of n)d?(t.run_id===u&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,d=!0,u=t.run_id,yield t)}finally{o.abort(),await l}}async*_streamEventsV1(e,t,r){let n,a=!1;const s=Ll(t),i=s.tags??[],o=s.metadata??{},c=s.runName??this.getName(),l=new Kl({...r,autoClose:!1,_schemaFormat:"streaming_events"}),u=new ou({...r}),d=this._streamLog(e,l,s);for await(const t of d){if(n=n?n.concat(t):Hl.fromRunLogPatch(t),void 0===n.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;const t={...n.state},r={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:i,metadata:o,data:{input:e}};u.includeEvent(r,t.type)&&(yield r)}const r=t.ops.filter(e=>e.path.startsWith("/logs/")).map(e=>e.path.split("/")[2]),s=[...new Set(r)];for(const e of s){let t,r={};const a=n.state.logs[e];if(t=void 0===a.end_time?a.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==a.inputs&&(r.input=a.inputs);else if("end"===t)void 0!==a.inputs&&(r.input=a.inputs),r.output=a.final_output;else if("stream"===t){const e=a.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${a.name}"`);r={chunk:a.streamed_output[0]},a.streamed_output=[]}yield{event:`on_${a.type}_${t}`,name:a.name,run_id:a.id,tags:a.tags,metadata:a.metadata,data:r}}const{state:l}=n;if(l.streamed_output.length>0){const e=l.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${l.name}"`);const t={chunk:l.streamed_output[0]};l.streamed_output=[];const r={event:`on_${l.type}_stream`,run_id:l.id,tags:i,metadata:o,name:c,data:t};u.includeEvent(r,l.type)&&(yield r)}}const h=n?.state;if(void 0!==h){const e={event:`on_${h.type}_end`,name:c,run_id:h.id,tags:i,metadata:o,data:{output:h.final_output}};u.includeEvent(e,h.type)&&(yield e)}}static isRunnable(e){return iu(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new uh({bound:this,config:{},configFactories:[n=>({callbacks:[new su({config:n,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return function(e,t){const r=t.name??e.getName(),n=t.description??Gd(t.schema);return Hd(a=t.schema)&&(qd(a)?"ZodString"===a._def.typeName:Zd(a)&&"string"===a._zod.def.type)?new vh({name:r,description:n,schema:Ii({input:Si()}).transform(e=>e.input),bound:e}):new vh({name:r,description:n,schema:t.schema,bound:e});var a}(this,e)}}class uh extends lh{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=Nl(this.config,...e);return Nl(t,...this.configFactories?await Promise.all(this.configFactories.map(async e=>await e(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new hh({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(Ll(t),this.kwargs))}async batch(e,t,r){const n=Array.isArray(t)?await Promise.all(t.map(async e=>this._mergeConfig(Ll(e),this.kwargs))):await this._mergeConfig(Ll(t),this.kwargs);return this.bound.batch(e,n,r)}_concatOutputChunks(e,t){return this.bound._concatOutputChunks(e,t)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(Ll(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(Ll(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(Ll(t),this.kwargs))}streamEvents(e,t,r){const n=this;return Dl.fromAsyncGenerator(async function*(){yield*n.bound.streamEvents(e,{...await n._mergeConfig(Ll(t),n.kwargs),version:t.version},r)}())}static isRunnableBinding(e){return e.bound&&lh.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new uh({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[n=>({callbacks:[new su({config:n,onStart:e,onEnd:t,onError:r})]})]})}}class dh extends lh{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new dh({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,Ml(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new dh({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class hh extends uh{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const n=e>1?`retry:attempt:${e}`:void 0;return Ml(t,{callbacks:r?.getChild(n)})}async _invoke(e,t,r){return Pi(n=>super.invoke(e,this._patchConfigForRetry(n,t,r)),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,n){const a={};try{await Pi(async s=>{const i=e.map((e,t)=>t).filter(e=>void 0===a[e.toString()]||a[e.toString()]instanceof Error),o=i.map(t=>e[t]),c=i.map(e=>this._patchConfigForRetry(s,t?.[e],r?.[e])),l=await super.batch(o,c,{...n,returnExceptions:!0});let u;for(let e=0;e<l.length;e+=1){const t=l[e],r=i[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),a[r.toString()]=t}if(u)throw u;return l},{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==n?.returnExceptions)throw e}return Object.keys(a).sort((e,t)=>parseInt(e,10)-parseInt(t,10)).map(e=>a[parseInt(e,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class ph extends lh{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=Ll(t),n=await Rl(r),a=await(n?.handleChainStart(this.toJSON(),ch(e,"input"),r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;let s,i=e;try{const e=[this.first,...this.middle];for(let n=0;n<e.length;n+=1){const s=e[n].invoke(i,Ml(r,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${n+1}`)}));i=await Ul(s,t?.signal)}if(t?.signal?.aborted)throw new Error("Aborted");s=await this.last.invoke(i,Ml(r,{callbacks:a?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(ch(s,"output"))),s}async batch(e,t,r){const n=this._getOptionsList(t??{},e.length),a=await Promise.all(n.map(Rl)),s=await Promise.all(a.map(async(t,r)=>{const a=await(t?.handleChainStart(this.toJSON(),ch(e[r],"input"),n[r].runId,void 0,void 0,void 0,n[r].runName));return delete n[r].runId,a}));let i=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e].batch(i,s.map((t,r)=>{const a=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return Ml(n[r],{callbacks:a})}),r);i=await Ul(t,n[0]?.signal)}}catch(e){throw await Promise.all(s.map(t=>t?.handleChainError(e))),e}return await Promise.all(s.map(e=>e?.handleChainEnd(ch(i,"output")))),i}_concatOutputChunks(e,t){return this.last._concatOutputChunks(e,t)}async*_streamIterator(e,t){const r=await Rl(t),{runId:n,...a}=t??{},s=await(r?.handleChainStart(this.toJSON(),ch(e,"input"),n,void 0,void 0,void 0,a?.runName)),i=[this.first,...this.middle,this.last];let o,c=!0;try{let r=i[0].transform(async function*(){yield e}(),Ml(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let e=1;e<i.length;e+=1){const t=i[e];r=await t.transform(r,Ml(a,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`)}))}for await(const e of r)if(t?.signal?.throwIfAborted(),yield e,c)if(void 0===o)o=e;else try{o=this._concatOutputChunks(o,e)}catch(e){o=void 0,c=!1}}catch(e){throw await(s?.handleChainError(e)),e}await(s?.handleChainEnd(ch(o,"output")))}getGraph(e){const t=new th;let r=null;return this.steps.forEach((n,a)=>{const s=n.getGraph(e);0!==a&&s.trimFirstNode(),a!==this.steps.length-1&&s.trimLastNode(),t.extend(s);const i=s.firstNode();if(!i)throw new Error(`Runnable ${n} has no first node`);r&&t.addEdge(r,i),r=s.lastNode()}),t}pipe(e){return ph.isRunnableSequence(e)?new ph({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new ph({first:this.first,middle:[...this.middle,this.last],last:_h(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&lh.isRunnable(e)}static from([e,...t],r){let n={};return"string"==typeof r?n.name=r:void 0!==r&&(n=r),new ph({...n,first:_h(e),middle:t.slice(0,-1).map(_h),last:_h(t[t.length-1])})}}class fh extends lh{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=_h(r)}static from(e){return new fh({steps:e})}async invoke(e,t){const r=Ll(t),n=await Rl(r),a=await(n?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;const s={};try{const n=Object.entries(this.steps).map(async([t,n])=>{s[t]=await n.invoke(e,Ml(r,{callbacks:a?.getChild(`map:key:${t}`)}))});await Ul(Promise.all(n),t?.signal)}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(s)),s}async*_transform(e,t,r){const n={...this.steps},a=Fl(e,Object.keys(n).length),s=new Map(Object.entries(n).map(([e,n],s)=>{const i=n.transform(a[s],Ml(r,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,i.next().then(t=>({key:e,gen:i,result:t}))]}));for(;s.size;){const e=Promise.race(s.values()),{key:t,result:n,gen:a}=await Ul(e,r?.signal);s.delete(t),n.done||(yield{[t]:n.value},s.set(t,a.next().then(e=>({key:t,gen:a,result:e}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=Ll(t),n=new Zl({generator:this.transform(async function*(){yield e}(),r),config:r});return await n.setup,Dl.fromAsyncGenerator(n)}}class mh extends lh{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!Fi(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[r]=this._getOptionsList(t??{},1),n=await Rl(r);return Ul(this.func(Ml(r,{callbacks:n}),e),r?.signal)}async*_streamIterator(e,t){const[r]=this._getOptionsList(t??{},1),n=await this.invoke(e,t);var a;if(sh(n))for await(const e of n)r?.signal?.throwIfAborted(),yield e;else if(null!=(a=n)&&"object"==typeof a&&"next"in a&&"function"==typeof a.next)for(;;){r?.signal?.throwIfAborted();const e=n.next();if(e.done)break;yield e.value}else yield n}static from(e){return new mh({func:e})}}class gh extends lh{static lc_name(){return"RunnableLambda"}constructor(e){if(Fi(e.func))return mh.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if(Fi(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new gh({func:e})}async _invoke(e,t,r){return new Promise((n,a)=>{const s=Ml(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});jl.runWithConfig(zl(s),async()=>{try{let r=await this.func(e,{...s});if(r&&lh.isRunnable(r)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");r=await r.invoke(e,{...s,recursionLimit:(s.recursionLimit??25)-1})}else if(sh(r)){let e;for await(const n of oh(s,r))if(t?.signal?.throwIfAborted(),void 0===e)e=n;else try{e=this._concatOutputChunks(e,n)}catch(t){e=n}r=e}else if(ah(r)){let e;for(const n of ih(s,r))if(t?.signal?.throwIfAborted(),void 0===e)e=n;else try{e=this._concatOutputChunks(e,n)}catch(t){e=n}r=e}n(r)}catch(e){a(e)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async*_transform(e,t,r){let n;for await(const t of e)if(void 0===n)n=t;else try{n=this._concatOutputChunks(n,t)}catch(e){n=t}const a=Ml(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??25)-1}),s=await new Promise((e,t)=>{jl.runWithConfig(zl(a),async()=>{try{const t=await this.func(n,{...a,config:a});e(t)}catch(e){t(e)}})});if(s&&lh.isRunnable(s)){if(0===r?.recursionLimit)throw new Error("Recursion limit reached.");const e=await s.stream(n,a);for await(const t of e)yield t}else if(sh(s))for await(const e of oh(a,s))r?.signal?.throwIfAborted(),yield e;else if(ah(s))for(const e of ih(a,s))r?.signal?.throwIfAborted(),yield e;else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=Ll(t),n=new Zl({generator:this.transform(async function*(){yield e}(),r),config:r});return await n.setup,Dl.fromAsyncGenerator(n)}}class yh extends lh{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=Ll(t),n=await Rl(r),{runId:a,...s}=r,i=await(n?.handleChainStart(this.toJSON(),ch(e,"input"),a,void 0,void 0,void 0,s?.runName)),o=Ml(s,{callbacks:i?.getChild()});return await jl.runWithConfig(o,async()=>{let t;for(const n of this.runnables()){r?.signal?.throwIfAborted();try{const t=await n.invoke(e,o);return await(i?.handleChainEnd(ch(t,"output"))),t}catch(e){void 0===t&&(t=e)}}if(void 0===t)throw new Error("No error stored at end of fallback.");throw await(i?.handleChainError(t)),t})}async*_streamIterator(e,t){const r=Ll(t),n=await Rl(r),{runId:a,...s}=r,i=await(n?.handleChainStart(this.toJSON(),ch(e,"input"),a,void 0,void 0,void 0,s?.runName));let o,c,l;for(const t of this.runnables()){r?.signal?.throwIfAborted();const n=Ml(s,{callbacks:i?.getChild()});try{c=oh(n,await t.stream(e,n));break}catch(e){void 0===o&&(o=e)}}if(void 0===c){const e=o??new Error("No error stored at end of fallback.");throw await(i?.handleChainError(e)),e}try{for await(const e of c){yield e;try{l=void 0===l?l:this._concatOutputChunks(l,e)}catch(e){l=void 0}}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(ch(l,"output")))}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const n=this._getOptionsList(t??{},e.length),a=await Promise.all(n.map(e=>Rl(e))),s=await Promise.all(a.map(async(t,r)=>{const a=await(t?.handleChainStart(this.toJSON(),ch(e[r],"input"),n[r].runId,void 0,void 0,void 0,n[r].runName));return delete n[r].runId,a}));let i;for(const t of this.runnables()){n[0].signal?.throwIfAborted();try{const a=await t.batch(e,s.map((e,t)=>Ml(n[t],{callbacks:e?.getChild()})),r);return await Promise.all(s.map((e,t)=>e?.handleChainEnd(ch(a[t],"output")))),a}catch(e){void 0===i&&(i=e)}}if(!i)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(s.map(e=>e?.handleChainError(i))),i}}function _h(e){if("function"==typeof e)return new gh({func:e});if(lh.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[r,n]of Object.entries(e))t[r]=_h(n);return new fh({steps:t})}}class bh extends lh{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof fh&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const n=this.mapper.getStepsKeys(),[a,s]=Fl(e),i=this.mapper.transform(s,Ml(r,{callbacks:t?.getChild()})),o=i.next();for await(const e of a){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter(([e])=>!n.includes(e)));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of i)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=Ll(t),n=new Zl({generator:this.transform(async function*(){yield e}(),r),config:r});return await n.setup,Dl.fromAsyncGenerator(n)}}class wh extends lh{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map(t=>[t,e[t]]).filter(e=>void 0!==e[1]);return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=Ll(t),n=new Zl({generator:this.transform(async function*(){yield e}(),r),config:r});return await n.setup,Dl.fromAsyncGenerator(n)}}class vh extends uh{constructor(e){super({bound:ph.from([gh.from(async e=>{let t;if(Ba(e))try{t=await Jd(this.schema,e.args)}catch(t){throw new Za("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}var Oh="object"==typeof window?window:{},Eh="0123456789abcdef".split(""),kh=[-2147483648,8388608,32768,128],xh=[24,16,8,0],Sh=[];function Ah(e){e?(Sh[0]=Sh[16]=Sh[1]=Sh[2]=Sh[3]=Sh[4]=Sh[5]=Sh[6]=Sh[7]=Sh[8]=Sh[9]=Sh[10]=Sh[11]=Sh[12]=Sh[13]=Sh[14]=Sh[15]=0,this.blocks=Sh):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Ah.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===Oh.ArrayBuffer&&(e=new Uint8Array(e));for(var r,n,a=0,s=e.length||0,i=this.blocks;a<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),t)for(n=this.start;a<s&&n<64;++a)i[n>>2]|=e[a]<<xh[3&n++];else for(n=this.start;a<s&&n<64;++a)(r=e.charCodeAt(a))<128?i[n>>2]|=r<<xh[3&n++]:r<2048?(i[n>>2]|=(192|r>>6)<<xh[3&n++],i[n>>2]|=(128|63&r)<<xh[3&n++]):r<55296||r>=57344?(i[n>>2]|=(224|r>>12)<<xh[3&n++],i[n>>2]|=(128|r>>6&63)<<xh[3&n++],i[n>>2]|=(128|63&r)<<xh[3&n++]):(r=65536+((1023&r)<<10|1023&e.charCodeAt(++a)),i[n>>2]|=(240|r>>18)<<xh[3&n++],i[n>>2]|=(128|r>>12&63)<<xh[3&n++],i[n>>2]|=(128|r>>6&63)<<xh[3&n++],i[n>>2]|=(128|63&r)<<xh[3&n++]);this.lastByteIndex=n,this.bytes+=n-this.start,n>=64?(this.block=i[16],this.start=n-64,this.hash(),this.hashed=!0):this.start=n}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},Ah.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=kh[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Ah.prototype.hash=function(){var e,t,r=this.h0,n=this.h1,a=this.h2,s=this.h3,i=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)r=(t=(n=(t=(a=(t=(s=(t=(i=(t=r<<5|r>>>27)+(n&a|~n&s)+i+1518500249+o[e]|0)<<5|i>>>27)+(r&(n=n<<30|n>>>2)|~r&a)+s+1518500249+o[e+1]|0)<<5|s>>>27)+(i&(r=r<<30|r>>>2)|~i&n)+a+1518500249+o[e+2]|0)<<5|a>>>27)+(s&(i=i<<30|i>>>2)|~s&r)+n+1518500249+o[e+3]|0)<<5|n>>>27)+(a&(s=s<<30|s>>>2)|~a&i)+r+1518500249+o[e+4]|0,a=a<<30|a>>>2;for(;e<40;e+=5)r=(t=(n=(t=(a=(t=(s=(t=(i=(t=r<<5|r>>>27)+(n^a^s)+i+1859775393+o[e]|0)<<5|i>>>27)+(r^(n=n<<30|n>>>2)^a)+s+1859775393+o[e+1]|0)<<5|s>>>27)+(i^(r=r<<30|r>>>2)^n)+a+1859775393+o[e+2]|0)<<5|a>>>27)+(s^(i=i<<30|i>>>2)^r)+n+1859775393+o[e+3]|0)<<5|n>>>27)+(a^(s=s<<30|s>>>2)^i)+r+1859775393+o[e+4]|0,a=a<<30|a>>>2;for(;e<60;e+=5)r=(t=(n=(t=(a=(t=(s=(t=(i=(t=r<<5|r>>>27)+(n&a|n&s|a&s)+i-1894007588+o[e]|0)<<5|i>>>27)+(r&(n=n<<30|n>>>2)|r&a|n&a)+s-1894007588+o[e+1]|0)<<5|s>>>27)+(i&(r=r<<30|r>>>2)|i&n|r&n)+a-1894007588+o[e+2]|0)<<5|a>>>27)+(s&(i=i<<30|i>>>2)|s&r|i&r)+n-1894007588+o[e+3]|0)<<5|n>>>27)+(a&(s=s<<30|s>>>2)|a&i|s&i)+r-1894007588+o[e+4]|0,a=a<<30|a>>>2;for(;e<80;e+=5)r=(t=(n=(t=(a=(t=(s=(t=(i=(t=r<<5|r>>>27)+(n^a^s)+i-899497514+o[e]|0)<<5|i>>>27)+(r^(n=n<<30|n>>>2)^a)+s-899497514+o[e+1]|0)<<5|s>>>27)+(i^(r=r<<30|r>>>2)^n)+a-899497514+o[e+2]|0)<<5|a>>>27)+(s^(i=i<<30|i>>>2)^r)+n-899497514+o[e+3]|0)<<5|n>>>27)+(a^(s=s<<30|s>>>2)^i)+r-899497514+o[e+4]|0,a=a<<30|a>>>2;this.h0=this.h0+r|0,this.h1=this.h1+n|0,this.h2=this.h2+a|0,this.h3=this.h3+s|0,this.h4=this.h4+i|0},Ah.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,a=this.h4;return Eh[e>>28&15]+Eh[e>>24&15]+Eh[e>>20&15]+Eh[e>>16&15]+Eh[e>>12&15]+Eh[e>>8&15]+Eh[e>>4&15]+Eh[15&e]+Eh[t>>28&15]+Eh[t>>24&15]+Eh[t>>20&15]+Eh[t>>16&15]+Eh[t>>12&15]+Eh[t>>8&15]+Eh[t>>4&15]+Eh[15&t]+Eh[r>>28&15]+Eh[r>>24&15]+Eh[r>>20&15]+Eh[r>>16&15]+Eh[r>>12&15]+Eh[r>>8&15]+Eh[r>>4&15]+Eh[15&r]+Eh[n>>28&15]+Eh[n>>24&15]+Eh[n>>20&15]+Eh[n>>16&15]+Eh[n>>12&15]+Eh[n>>8&15]+Eh[n>>4&15]+Eh[15&n]+Eh[a>>28&15]+Eh[a>>24&15]+Eh[a>>20&15]+Eh[a>>16&15]+Eh[a>>12&15]+Eh[a>>8&15]+Eh[a>>4&15]+Eh[15&a]},Ah.prototype.toString=Ah.prototype.hex,Ah.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,a=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,a>>24&255,a>>16&255,a>>8&255,255&a]},Ah.prototype.array=Ah.prototype.digest,Ah.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};let Ih=!1;var Ph="0123456789abcdef".split(""),$h=[-2147483648,8388608,32768,128],Th=[24,16,8,0],jh=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],Rh=[];function Nh(e,t){t?(Rh[0]=Rh[16]=Rh[1]=Rh[2]=Rh[3]=Rh[4]=Rh[5]=Rh[6]=Rh[7]=Rh[8]=Rh[9]=Rh[10]=Rh[11]=Rh[12]=Rh[13]=Rh[14]=Rh[15]=0,this.blocks=Rh):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=3238371032,this.h1=914150663,this.h2=812702999,this.h3=4144912697,this.h4=4290775857,this.h5=1750603025,this.h6=1694076839,this.h7=3204075428):(this.h0=1779033703,this.h1=3144134277,this.h2=1013904242,this.h3=2773480762,this.h4=1359893119,this.h5=2600822924,this.h6=528734635,this.h7=1541459225),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}Nh.prototype.update=function(e){if(!this.finalized){var t,r=typeof e;if("string"!==r){if("object"!==r)throw new Error(ERROR);if(null===e)throw new Error(ERROR);if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!(Array.isArray(e)||ARRAY_BUFFER&&ArrayBuffer.isView(e)))throw new Error(ERROR);t=!0}for(var n,a,s=0,i=e.length,o=this.blocks;s<i;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(a=this.start;s<i&&a<64;++s)o[a>>>2]|=e[s]<<Th[3&a++];else for(a=this.start;s<i&&a<64;++s)(n=e.charCodeAt(s))<128?o[a>>>2]|=n<<Th[3&a++]:n<2048?(o[a>>>2]|=(192|n>>>6)<<Th[3&a++],o[a>>>2]|=(128|63&n)<<Th[3&a++]):n<55296||n>=57344?(o[a>>>2]|=(224|n>>>12)<<Th[3&a++],o[a>>>2]|=(128|n>>>6&63)<<Th[3&a++],o[a>>>2]|=(128|63&n)<<Th[3&a++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++s)),o[a>>>2]|=(240|n>>>18)<<Th[3&a++],o[a>>>2]|=(128|n>>>12&63)<<Th[3&a++],o[a>>>2]|=(128|n>>>6&63)<<Th[3&a++],o[a>>>2]|=(128|63&n)<<Th[3&a++]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=o[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},Nh.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=$h[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Nh.prototype.hash=function(){var e,t,r,n,a,s,i,o,c,l=this.h0,u=this.h1,d=this.h2,h=this.h3,p=this.h4,f=this.h5,m=this.h6,g=this.h7,y=this.blocks;for(e=16;e<64;++e)t=((a=y[e-15])>>>7|a<<25)^(a>>>18|a<<14)^a>>>3,r=((a=y[e-2])>>>17|a<<15)^(a>>>19|a<<13)^a>>>10,y[e]=y[e-16]+t+y[e-7]+r|0;for(c=u&d,e=0;e<64;e+=4)this.first?(this.is224?(s=300032,g=(a=y[0]-1413257819)-150054599|0,h=a+24177077|0):(s=704751109,g=(a=y[0]-210244248)-1521486534|0,h=a+143694565|0),this.first=!1):(t=(l>>>2|l<<30)^(l>>>13|l<<19)^(l>>>22|l<<10),n=(s=l&u)^l&d^c,g=h+(a=g+(r=(p>>>6|p<<26)^(p>>>11|p<<21)^(p>>>25|p<<7))+(p&f^~p&m)+jh[e]+y[e])|0,h=a+(t+n)|0),t=(h>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),n=(i=h&l)^h&u^s,m=d+(a=f+(r=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7))+(m&g^~m&p)+jh[e+1]+y[e+1])|0,t=((d=a+(t+n)|0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),n=(o=d&h)^d&l^i,f=u+(a=p+(r=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7))+(f&m^~f&g)+jh[e+2]+y[e+2])|0,t=((u=a+(t+n)|0)>>>2|u<<30)^(u>>>13|u<<19)^(u>>>22|u<<10),n=(c=u&d)^u&h^o,p=l+(a=p+(r=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7))+(f&m^~f&g)+jh[e+3]+y[e+3])|0,l=a+(t+n)|0,this.chromeBugWorkAround=!0;this.h0=this.h0+l|0,this.h1=this.h1+u|0,this.h2=this.h2+d|0,this.h3=this.h3+h|0,this.h4=this.h4+p|0,this.h5=this.h5+f|0,this.h6=this.h6+m|0,this.h7=this.h7+g|0},Nh.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,a=this.h4,s=this.h5,i=this.h6,o=this.h7,c=Ph[e>>>28&15]+Ph[e>>>24&15]+Ph[e>>>20&15]+Ph[e>>>16&15]+Ph[e>>>12&15]+Ph[e>>>8&15]+Ph[e>>>4&15]+Ph[15&e]+Ph[t>>>28&15]+Ph[t>>>24&15]+Ph[t>>>20&15]+Ph[t>>>16&15]+Ph[t>>>12&15]+Ph[t>>>8&15]+Ph[t>>>4&15]+Ph[15&t]+Ph[r>>>28&15]+Ph[r>>>24&15]+Ph[r>>>20&15]+Ph[r>>>16&15]+Ph[r>>>12&15]+Ph[r>>>8&15]+Ph[r>>>4&15]+Ph[15&r]+Ph[n>>>28&15]+Ph[n>>>24&15]+Ph[n>>>20&15]+Ph[n>>>16&15]+Ph[n>>>12&15]+Ph[n>>>8&15]+Ph[n>>>4&15]+Ph[15&n]+Ph[a>>>28&15]+Ph[a>>>24&15]+Ph[a>>>20&15]+Ph[a>>>16&15]+Ph[a>>>12&15]+Ph[a>>>8&15]+Ph[a>>>4&15]+Ph[15&a]+Ph[s>>>28&15]+Ph[s>>>24&15]+Ph[s>>>20&15]+Ph[s>>>16&15]+Ph[s>>>12&15]+Ph[s>>>8&15]+Ph[s>>>4&15]+Ph[15&s]+Ph[i>>>28&15]+Ph[i>>>24&15]+Ph[i>>>20&15]+Ph[i>>>16&15]+Ph[i>>>12&15]+Ph[i>>>8&15]+Ph[i>>>4&15]+Ph[15&i];return this.is224||(c+=Ph[o>>>28&15]+Ph[o>>>24&15]+Ph[o>>>20&15]+Ph[o>>>16&15]+Ph[o>>>12&15]+Ph[o>>>8&15]+Ph[o>>>4&15]+Ph[15&o]),c},Nh.prototype.toString=Nh.prototype.hex,Nh.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,n=this.h3,a=this.h4,s=this.h5,i=this.h6,o=this.h7,c=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,r>>>24&255,r>>>16&255,r>>>8&255,255&r,n>>>24&255,n>>>16&255,n>>>8&255,255&n,a>>>24&255,a>>>16&255,a>>>8&255,255&a,s>>>24&255,s>>>16&255,s>>>8&255,255&s,i>>>24&255,i>>>16&255,i>>>8&255,255&i];return this.is224||c.push(o>>>24&255,o>>>16&255,o>>>8&255,255&o),c},Nh.prototype.array=Nh.prototype.digest,Nh.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e};const Ch=(...e)=>{return t=e.join("_"),Ih||(console.warn(["The default method for hashing keys is insecure and will be replaced in a future version,","but hasn't been replaced yet as to not break existing caches. It's recommended that you use","a more secure hashing algorithm to avoid cache poisoning.","","See this page for more information:","|","â””> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm"].join("\n")),Ih=!0),new Ah(!0).update(t).hex();var t};class Lh{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:Ch})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}const Mh=new Map;class zh extends Lh{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,r){this.cache.set(this.keyEncoder(e,t),r)}static global(){return new zh(Mh)}}class Uh extends ma{}class Dh extends Uh{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Ma(this.value)]}}class Fh extends Uh{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Wa(this.messages)}toChatMessages(){return this.messages}}var Bh=r(7526),Zh=Object.defineProperty;function qh(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let r=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;r.length>1;){let n=null;for(let a=0;a<r.length-1;a++){const s=e.slice(r[a].start,r[a+1].end),i=t.get(s.join(","));null!=i&&(null==n||i<n[0])&&(n=[i,a])}if(null==n)break;{const e=n[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}}return r}(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(e=>null!=e)}var Hh,Jh,Gh=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const r=e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{const[r,n,...a]=t.split(" "),s=Number.parseInt(n,10);return a.forEach((t,r)=>e[t]=s+r),e},{});for(const[e,t]of Object.entries(r)){const r=Bh.toByteArray(e);this.rankMap.set(r.join(","),t),this.textMap.set(t,r)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e),{})}encode(e,t=[],r="all"){const n=new RegExp(this.patStr,"ug"),a=Gh.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter(e=>!i.has(e)):r);if(o.size>0){const t=Gh.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw new Error(`The text contains a special token that is not allowed: ${r[0]}`)}let c=0;for(;;){let t=null,r=c;for(;a.lastIndex=r,t=a.exec(e),null!=t&&!i.has(t[0]);)r=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(n)){const e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));null==r?s.push(...qh(e,this.rankMap)):s.push(r)}if(null==t)break;let l=this.specialTokens[t[0]];s.push(l),c=t.index+t[0].length}return s}decode(e){const t=[];let r=0;for(let n=0;n<e.length;++n){const a=e[n],s=this.textMap.get(a)??this.inverseSpecialTokens[a];null!=s&&(t.push(s),r+=s.length)}const n=new Uint8Array(r);let a=0;for(const e of t)n.set(e,a),a+=e.length;return this.textDecoder.decode(n)}},Wh=Gh;Jh=e=>new RegExp(e.map(e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e)).join("|"),"g"),((e,t,r)=>{t in e?Zh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r})(Wh,"symbol"!=typeof(Hh="specialTokenRegex")?Hh+"":Hh,Jh);const Kh={},Vh=new au({});class Xh extends lh{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class Yh extends Xh{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){const{cache:n,...a}=r;super({callbacks:e??t,...a}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache="object"==typeof n?n:n?zh.global():void 0,this.caller=new au(r??{})}async getNumTokens(e){let t;t="string"==typeof e?e:e.map(e=>"string"==typeof e?e:"text"===e.type&&"text"in e?e.text:"").join("");let r=Math.ceil(t.length/4);if(!this._encoding)try{this._encoding=await async function(e){return async function(e){return e in Kh||(Kh[e]=Vh.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(e=>e.json()).then(e=>new Wh(e)).catch(t=>{throw delete Kh[e],t})),await Kh[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw new Error("Unknown model")}}(e))}("modelName"in this?(n=this.modelName,n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var n;if(this._encoding)try{r=this._encoding.encode(t).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return r}static _convertInputToPromptValue(e){return"string"==typeof e?new Dh(e):Array.isArray(e)?new Fh(e.map(Ga)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const r={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},n=Object.entries(r).filter(([e,t])=>void 0!==t),a=n.map(([e,t])=>`${e}:${JSON.stringify(t)}`).sort().join(",");return a}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class Qh extends lh{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const r=Ll(t);return this.func&&await this.func(e,r),this._callWithConfig(e=>Promise.resolve(e),e,r)}async*transform(e,t){const r=Ll(t);let n,a=!0;for await(const t of this._transformStreamWithConfig(e,e=>e,r))if(yield t,a)if(void 0===n)n=t;else try{n=Bl(n,t)}catch{n=void 0,a=!1}this.func&&void 0!==n&&await this.func(n,r)}static assign(e){return new bh(new fh({steps:e}))}}function ep(e){const t=[];for(const r of e){let e=r;if(Array.isArray(r.content))for(let t=0;t<r.content.length;t++){const n=r.content[t];(ya(n)||_a(n))&&e===r&&(e=new r.constructor({...e,content:[...r.content.slice(0,t),ba(n),...r.content.slice(t+1)]}))}t.push(e)}return t}class tp extends Yh{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){const r=tp._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===tp.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{const r=tp._convertInputToPromptValue(e).toChatMessages(),[n,a]=this._separateRunnableConfigFromCallOptionsCompat(t),s={...n.metadata,...this.getLsParams(a)},i=await Il.configure(n.callbacks,this.callbacks,n.tags,this.tags,s,this.metadata,{verbose:this.verbose}),o={options:a,invocation_params:this?.invocationParams(a),batch_size:1},c=await(i?.handleChatModelStart(this.toJSON(),[ep(r)],n.runId,void 0,o,void 0,void 0,n.runName));let l,u;try{for await(const e of this._streamResponseChunks(r,a,c?.[0])){if(null==e.message.id){const t=c?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,l=l?l.concat(e):e,ja(e.message)&&void 0!==e.message.usage_metadata&&(u={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((c??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((c??[]).map(e=>e?.handleLLMEnd({generations:[[l]],llmOutput:u})))}}getLsParams(e){const t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r,n){const a=e.map(e=>e.map(Ga));let s;if(void 0!==n&&n.length===a.length)s=n;else{const e={...r.metadata,...this.getLsParams(t)},n=await Il.configure(r.callbacks,this.callbacks,r.tags,this.tags,e,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this?.invocationParams(t),batch_size:1};s=await(n?.handleChatModelStart(this.toJSON(),a.map(ep),r.runId,void 0,i,void 0,void 0,r.runName))}const i=[],o=[];if(s?.[0].handlers.find(Yc)&&!this.disableStreaming&&1===a.length&&this._streamResponseChunks!==tp.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(a[0],t,s?.[0]);let r,n;for await(const t of e){if(null==t.message.id){const e=s?.at(0)?.runId;null!=e&&t.message._updateId(`run-${e}`)}r=void 0===r?t:Bl(r,t),ja(t.message)&&void 0!==t.message.usage_metadata&&(n={tokenUsage:{promptTokens:t.message.usage_metadata.input_tokens,completionTokens:t.message.usage_metadata.output_tokens,totalTokens:t.message.usage_metadata.total_tokens}})}if(void 0===r)throw new Error("Received empty response from chat model call.");i.push([r]),await(s?.[0].handleLLMEnd({generations:i,llmOutput:n}))}catch(e){throw await(s?.[0].handleLLMError(e)),e}else{const e=await Promise.allSettled(a.map((e,r)=>this._generate(e,{...t,promptIndex:r},s?.[r])));await Promise.all(e.map(async(e,t)=>{if("fulfilled"===e.status){const r=e.value;for(const e of r.generations){if(null==e.message.id){const t=s?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===r.generations.length&&(r.generations[0].message.response_metadata={...r.llmOutput,...r.generations[0].message.response_metadata}),i[t]=r.generations,o[t]=r.llmOutput,s?.[t]?.handleLLMEnd({generations:[r.generations],llmOutput:r.llmOutput})}return await(s?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)}))}const c={generations:i,llmOutput:o.length?this._combineLLMOutput?.(...o):void 0};return Object.defineProperty(c,Vl,{value:s?{runIds:s?.map(e=>e.runId)}:void 0,configurable:!0}),c}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:n,handledOptions:a}){const s=e.map(e=>e.map(Ga)),i={...a.metadata,...this.getLsParams(n)},o=await Il.configure(a.callbacks,this.callbacks,a.tags,this.tags,i,this.metadata,{verbose:this.verbose}),c={options:n,invocation_params:this?.invocationParams(n),batch_size:1},l=await(o?.handleChatModelStart(this.toJSON(),s.map(ep),a.runId,void 0,c,void 0,void 0,a.runName)),u=[],d=(await Promise.allSettled(s.map(async(e,n)=>{const a=tp._convertInputToPromptValue(e).toString(),s=await t.lookup(a,r);return null==s&&u.push(n),s}))).map((e,t)=>({result:e,runManager:l?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),h=[];await Promise.all(d.map(async({result:e,runManager:t},r)=>{if("fulfilled"===e.status){const n=e.value;return h[r]=n.map(e=>("message"in e&&Sa(e.message)&&Ta(e.message)&&(e.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),n.length&&await(t?.handleLLMNewToken(n[0].text)),t?.handleLLMEnd({generations:[n]},void 0,void 0,void 0,{cached:!0})}return await(t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0})),Promise.reject(e.reason)}));const p={generations:h,missingPromptIndices:u,startedRunManagers:l};return Object.defineProperty(p,Vl,{value:l?{runIds:l?.map(e=>e.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){let n;n=Array.isArray(t)?{stop:t}:t;const a=e.map(e=>e.map(Ga)),[s,i]=this._separateRunnableConfigFromCallOptionsCompat(n);if(s.callbacks=s.callbacks??r,!this.cache)return this._generateUncached(a,i,s);const{cache:o}=this,c=this._getSerializedCacheKeyParametersForCall(i),{generations:l,missingPromptIndices:u,startedRunManagers:d}=await this._generateCached({messages:a,cache:o,llmStringKey:c,parsedOptions:i,handledOptions:s});let h={};if(u.length>0){const e=await this._generateUncached(u.map(e=>a[e]),i,s,void 0!==d?u.map(e=>d?.[e]):void 0);await Promise.all(e.generations.map(async(e,t)=>{const r=u[t];l[r]=e;const n=tp._convertInputToPromptValue(a[r]).toString();return o.update(n,c,e)})),h=e.llmOutput??{}}return{generations:l,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const n=e.map(e=>e.toChatMessages());return this.generate(n,t,r)}async call(e,t,r){return(await this.generate([e.map(Ga)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const n=e.toChatMessages();return this.call(n,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const n=new Ma(e),a=await this.call([n],t,r);if("string"!=typeof a.content)throw new Error("Cannot use predict when output is not a string.");return a.content}withStructuredOutput(e,t){if("function"!=typeof this.bindTools)throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw new Error('"strict" mode is not supported for this model by default.');const r=e,n=t?.name,a=Gd(r)??"A function available to call.",s=t?.method,i=t?.includeRaw;if("jsonMode"===s)throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o,c=n??"extract";Hd(r)?o=[{type:"function",function:{name:c,description:a,parameters:Yd(r)}}]:("name"in r&&(c=r.name),o=[{type:"function",function:{name:c,description:a,parameters:r}}]);const l=this.bindTools(o),u=gh.from(e=>{if(!e.tool_calls||0===e.tool_calls.length)throw new Error("No tool calls found in the response.");const t=e.tool_calls.find(e=>e.name===c);if(!t)throw new Error(`No tool call found with name ${c}.`);return t.args});if(!i)return l.pipe(u).withConfig({runName:"StructuredOutput"});const d=Qh.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),h=Qh.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[h]});return ph.from([{raw:l},p]).withConfig({runName:"StructuredOutputRunnable"})}}class rp extends lh{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig(async(e,t)=>this.parseResult([{text:e}],t?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks),e,{...t,runType:"parser"})}}class np extends rp{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class ap extends Error{constructor(e,t,r,n=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=n,n&&(void 0===r||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");Fa(this,"OUTPUT_PARSING_FAILURE")}}class sp extends np{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class ip extends sp{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,r;for await(const n of e){if("string"!=typeof n&&"string"!=typeof n.content)throw new Error("Cannot handle non-string output.");let e;if(Aa(n)){if("string"!=typeof n.content)throw new Error("Cannot handle non-string message output.");e=new Yl({message:n,text:n.content})}else if(Sa(n)){if("string"!=typeof n.content)throw new Error("Cannot handle non-string message output.");e=new Yl({message:Ka(n),text:n.content})}else e=new Xl({text:n});r=void 0===r?e:r.concat(e);const a=await this.parsePartialResult([r]);null==a||sd(a,t)||(this.diff?yield this._diff(t,a):yield a,t=a)}}getFormatInstructions(){return""}}class op extends np{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(Ii(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,Si().describe(t)]))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify(Yd(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=e.trim(),r=(t.match(/^```(?:json)?\s*([\s\S]*?)```/)?.[1]||t.match(/```json\s*([\s\S]*?)```/)?.[1]||t).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(e,t)=>`"${t.replace(/\n/g,"\\n")}"`).replace(/\n/g,"");return await Jd(this.schema,JSON.parse(r))}catch(t){throw new ap(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class cp extends ip{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?uo(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return oa(e[0].text)}async parse(e){return oa(e,JSON.parse)}getFormatInstructions(){return""}}function lp(e,t){if(void 0===e.function)return;let r;if(t?.partial)try{r=ca(e.function.arguments??"{}")}catch(e){return}else try{r=JSON.parse(e.function.arguments)}catch(t){throw new ap([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const n={name:e.function.name,args:r,type:"tool_call"};return t?.returnId&&(n.id=e.id),n}function up(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function dp(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}class hp extends ip{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw new Error("Not supported.")}async parse(){throw new Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){const r=e[0].message;let n;if(Ta(r)&&r.tool_calls?.length?n=r.tool_calls.map(e=>{const{id:t,...r}=e;return this.returnId?{id:t,...r}:r}):void 0!==r.additional_kwargs.tool_calls&&(n=JSON.parse(JSON.stringify(r.additional_kwargs.tool_calls)).map(e=>lp(e,{returnId:this.returnId,partial:t}))),!n)return[];const a=[];for(const e of n)if(void 0!==e){const t={type:e.name,args:e.args,id:e.id};a.push(t)}return a}}class pp extends hp{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await async function(e,t){if(Zd(e))try{return{success:!0,data:await Cd(e,t)}}catch(e){return{success:!1,error:e}}if(qd(e))return e.safeParse(t);throw new Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}(this.zodSchema,e);if(t.success)return t.data;throw new ap(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){const t=(await super.parsePartialResult(e)).filter(e=>e.type===this.keyName);let r=t;if(t.length)return this.returnId||(r=t.map(e=>e.args)),this.returnSingle?r[0]:r}async parseResult(e){const t=(await super.parsePartialResult(e,!1)).filter(e=>e.type===this.keyName);let r=t;if(!t.length)return;if(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)return this._validateResult(r[0]);const n=await Promise.all(r.map(e=>this._validateResult(e)));return n}}function fp(e,t,r,n){n?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function mp(e,t,r,n,a){e[t]=r,fp(e,t,n,a)}function gp(e,t,r){const n=r??t.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((r,n)=>gp(e,t,r))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return yp(e,t)}}const yp=(e,t)=>{const r={type:"integer",format:"unix-time"};if("openApi3"===t.target)return r;for(const n of e.checks)switch(n.kind){case"min":mp(r,"minimum",n.value,n.message,t);break;case"max":mp(r,"maximum",n.value,n.message,t)}return r};let _p;const bp=/^[cC][^\s-]{8,}$/,wp=/^[0-9a-z]+$/,vp=/^[0-9A-HJKMNP-TV-Z]{26}$/,Op=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,Ep=()=>(void 0===_p&&(_p=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),_p),kp=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,xp=/^[a-zA-Z0-9_-]{21}$/;function Sp(e,t){const r={type:"string"};function n(e){return"escape"===t.patternStrategy?Ap(e):e}if(e.checks)for(const a of e.checks)switch(a.kind){case"min":mp(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":mp(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Ip(r,"email",a.message,t);break;case"format:idn-email":Ip(r,"idn-email",a.message,t);break;case"pattern:zod":Pp(r,Op,a.message,t)}break;case"url":Ip(r,"uri",a.message,t);break;case"uuid":Ip(r,"uuid",a.message,t);break;case"regex":Pp(r,a.regex,a.message,t);break;case"cuid":Pp(r,bp,a.message,t);break;case"cuid2":Pp(r,wp,a.message,t);break;case"startsWith":Pp(r,RegExp(`^${n(a.value)}`),a.message,t);break;case"endsWith":Pp(r,RegExp(`${n(a.value)}$`),a.message,t);break;case"datetime":Ip(r,"date-time",a.message,t);break;case"date":Ip(r,"date",a.message,t);break;case"time":Ip(r,"time",a.message,t);break;case"duration":Ip(r,"duration",a.message,t);break;case"length":mp(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),mp(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":Pp(r,RegExp(n(a.value)),a.message,t);break;case"ip":"v6"!==a.version&&Ip(r,"ipv4",a.message,t),"v4"!==a.version&&Ip(r,"ipv6",a.message,t);break;case"emoji":Pp(r,Ep,a.message,t);break;case"ulid":Pp(r,vp,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Ip(r,"binary",a.message,t);break;case"contentEncoding:base64":mp(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":Pp(r,kp,a.message,t)}break;case"nanoid":Pp(r,xp,a.message,t);case"toLowerCase":case"toUpperCase":case"trim":break;default:(()=>{})()}return r}const Ap=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Ip=(e,t,r,n)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&n.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&n.errorMessages&&{errorMessage:{format:r}}})):mp(e,"format",t,r,n)},Pp=(e,t,r,n)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&n.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:$p(t,n),...r&&n.errorMessages&&{errorMessage:{pattern:r}}})):mp(e,"pattern",$p(t,n),r,n)},$p=(e,t)=>{const r="function"==typeof e?e():e;if(!t.applyRegexFlags||!r.flags)return r.source;const n=r.flags.includes("i"),a=r.flags.includes("m"),s=r.flags.includes("s"),i=n?r.source.toLowerCase():r.source;let o="",c=!1,l=!1,u=!1;for(let e=0;e<i.length;e++)if(c)o+=i[e],c=!1;else{if(n)if(l){if(i[e].match(/[a-z]/)){u?(o+=i[e],o+=`${i[e-2]}-${i[e]}`.toUpperCase(),u=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(o+=i[e],u=!0):o+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){o+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(a){if("^"===i[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){o+="($|(?=[\r\n]))";continue}}s&&"."===i[e]?o+=l?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(o+=i[e],"\\"===i[e]?c=!0:l&&"]"===i[e]?l=!1:l||"["!==i[e]||(l=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return o};function Tp(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===xi.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,n)=>({...r,[n]:Mp(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",n]})??{}}),{}),additionalProperties:!1};const r={type:"object",additionalProperties:Mp(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===xi.ZodString&&e.keyType._def.checks?.length){const n=Object.entries(Sp(e.keyType._def,t)).reduce((e,[t,r])=>"type"===t?e:{...e,[t]:r},{});return{...r,propertyNames:n}}return e.keyType?._def.typeName===xi.ZodEnum?{...r,propertyNames:{enum:e.keyType._def.values}}:r}const jp={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},Rp=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>Mp(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function Np(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:Mp(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:Mp(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}const Cp=Symbol("Let zodToJsonSchema decide on which parser to use"),Lp={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"};function Mp(e,t,r=!1){const n=t.seen.get(e);if(t.override){const a=t.override?.(e,t,n,r);if(a!==Cp)return a}if(n&&!r){const e=zp(n,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}const a={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,a);const s=Dp(e,e.typeName,t,r);return s&&Fp(e,t,s),a.jsonSchema=s,s}const zp=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":const r=e.path.slice(t.basePath.length+1).join("_");return r!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[r]=e.def),{$ref:[...t.basePath,t.definitionPath,r].join("/")};case"relative":return{$ref:Up(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e)?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},Up=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},Dp=(e,t,r,n)=>{switch(t){case xi.ZodString:return Sp(e,r);case xi.ZodNumber:return function(e,t){const r={type:"number"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"int":r.type="integer",fp(r,"type",n.message,t);break;case"min":"jsonSchema7"===t.target?n.inclusive?mp(r,"minimum",n.value,n.message,t):mp(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),mp(r,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?mp(r,"maximum",n.value,n.message,t):mp(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),mp(r,"maximum",n.value,n.message,t));break;case"multipleOf":mp(r,"multipleOf",n.value,n.message,t)}return r}(e,r);case xi.ZodObject:return function(e,t){const r={type:"object",...Object.entries(e.shape()).reduce((e,[r,n])=>{if(void 0===n||void 0===n._def)return e;const a=[...t.currentPath,"properties",r],s=Mp(n._def,{...t,currentPath:a,propertyPath:a});return void 0===s?e:(t.openaiStrictMode&&n.isOptional()&&!n.isNullable()&&console.warn(`Zod field at \`${a.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required\nThis will become an error in a future version of the SDK.`),{properties:{...e.properties,[r]:s},required:n.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,r]})},{properties:{},required:[]}),additionalProperties:Np(e,t)};return r.required.length||delete r.required,r}(e,r);case xi.ZodBigInt:return function(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const n of e.checks)switch(n.kind){case"min":"jsonSchema7"===t.target?n.inclusive?mp(r,"minimum",n.value,n.message,t):mp(r,"exclusiveMinimum",n.value,n.message,t):(n.inclusive||(r.exclusiveMinimum=!0),mp(r,"minimum",n.value,n.message,t));break;case"max":"jsonSchema7"===t.target?n.inclusive?mp(r,"maximum",n.value,n.message,t):mp(r,"exclusiveMaximum",n.value,n.message,t):(n.inclusive||(r.exclusiveMaximum=!0),mp(r,"maximum",n.value,n.message,t));break;case"multipleOf":mp(r,"multipleOf",n.value,n.message,t)}return r}(e,r);case xi.ZodBoolean:return{type:"boolean"};case xi.ZodDate:return gp(e,r);case xi.ZodUndefined:return{not:{}};case xi.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(r);case xi.ZodArray:return function(e,t){const r={type:"array"};return e.type?._def?.typeName!==xi.ZodAny&&(r.items=Mp(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&mp(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&mp(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(mp(r,"minItems",e.exactLength.value,e.exactLength.message,t),mp(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}(e,r);case xi.ZodUnion:case xi.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Rp(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every(e=>e._def.typeName in jp&&(!e._def.checks||!e._def.checks.length))){const e=r.reduce((e,t)=>{const r=jp[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(r.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){const e=r.reduce((e,t)=>{const r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===r.length){const t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:r.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(r.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:r.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return Rp(e,t)}(e,r);case xi.ZodIntersection:return function(e,t){const r=[Mp(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Mp(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e);let n="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const a=[];return r.forEach(e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:r,...n}=e;t=n}else n=void 0;a.push(t)}else a.push(...e.allOf),void 0===e.unevaluatedProperties&&(n=void 0);var t}),a.length?{allOf:a,...n}:void 0}(e,r);case xi.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,r)=>Mp(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:Mp(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,r)=>Mp(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,r);case xi.ZodRecord:return Tp(e,r);case xi.ZodLiteral:return function(e,t){const r=typeof e.value;return"bigint"!==r&&"number"!==r&&"boolean"!==r&&"string"!==r?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===r?"integer":r,enum:[e.value]}:{type:"bigint"===r?"integer":r,const:e.value}}(e,r);case xi.ZodEnum:return function(e){return{type:"string",enum:[...e.values]}}(e);case xi.ZodNativeEnum:return function(e){const t=e.values,r=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]),n=r.map(e=>t[e]),a=Array.from(new Set(n.map(e=>typeof e)));return{type:1===a.length?"string"===a[0]?"string":"number":["string","number"],enum:n}}(e);case xi.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:jp[e.innerType._def.typeName],nullable:!0}:{type:[jp[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const r=Mp(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const r=Mp(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}(e,r);case xi.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Mp(e.innerType._def,t);const r=Mp(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:{}},r]}:{}})(e,r);case xi.ZodMap:return function(e,t){return"record"===t.mapStrategy?Tp(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Mp(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},Mp(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,r);case xi.ZodSet:return function(e,t){const r={type:"array",uniqueItems:!0,items:Mp(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&mp(r,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&mp(r,"maxItems",e.maxSize.value,e.maxSize.message,t),r}(e,r);case xi.ZodLazy:return Mp(e.getter()._def,r);case xi.ZodPromise:return function(e,t){return Mp(e.type._def,t)}(e,r);case xi.ZodNaN:case xi.ZodNever:return{not:{}};case xi.ZodEffects:return function(e,t,r){return"input"===t.effectStrategy?Mp(e.schema._def,t,r):{}}(e,r,n);case xi.ZodAny:case xi.ZodUnknown:return{};case xi.ZodDefault:return function(e,t){return{...Mp(e.innerType._def,t),default:e.defaultValue()}}(e,r);case xi.ZodBranded:return function(e,t){return Mp(e.type._def,t)}(e,r);case xi.ZodReadonly:case xi.ZodCatch:return((e,t)=>Mp(e.innerType._def,t))(e,r);case xi.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Mp(e.in._def,t);if("output"===t.pipeStrategy)return Mp(e.out._def,t);const r=Mp(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[r,Mp(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]})].filter(e=>void 0!==e)}})(e,r);case xi.ZodFunction:case xi.ZodVoid:case xi.ZodSymbol:default:return}},Fp=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),Bp=e=>"_def"in e?e._def:e;function Zp(e,t){return((e,t)=>{const r=(e=>{const t=(e=>"string"==typeof e?{...Lp,basePath:["#"],definitions:{},name:e}:{...Lp,basePath:["#"],definitions:{},...e})(e),r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:r,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([e,r])=>[Bp(r),{def:Bp(r),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t),n="title"===t?.nameStrategy?void 0:t?.name,a=Mp(e._def,void 0===n?r:{...r,currentPath:[...r.basePath,r.definitionPath,n]},!1)??{},s=void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==s&&(a.title=s);const i=(()=>{if(function(e){if(!e)return!0;for(const t in e)return!1;return!0}(r.definitions))return;const e={},t=new Set;for(let n=0;n<500;n++){const n=Object.entries(r.definitions).filter(([e])=>!t.has(e));if(0===n.length)break;for(const[a,s]of n)e[a]=Mp(Bp(s),{...r,currentPath:[...r.basePath,r.definitionPath,a]},!0)??{},t.add(a)}return e})(),o=void 0===n?i?{...a,[r.definitionPath]:i}:a:"duplicate-ref"===r.nameStrategy?{...a,...i||r.seenRefs.size?{[r.definitionPath]:{...i,...r.seenRefs.size?{[n]:a}:void 0}}:void 0}:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,n].join("/"),[r.definitionPath]:{...i,[n]:a}};return"jsonSchema7"===r.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===r.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o})(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}function qp(e,t,r){return function(t){const r={...t};return Object.defineProperties(r,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t=>e.parse(JSON.parse(t)),enumerable:!1}}),r}({type:"json_schema",json_schema:{...r,name:t,strict:!0,schema:Zp(e,{name:t})}})}function Hp(e,t){const r="number"==typeof t?void 0:t;return{name:e.name,description:e.description,parameters:Yd(e.schema),...void 0!==r?.strict?{strict:r.strict}:{}}}function Jp(e,t){return e.lc_error_code=t,e.message=`${e.message}\n\nTroubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/\n`,e}function Gp(e){let t;return e.constructor.name===D.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===z.name?(t=new Error(e.message),t.name="AbortError"):t=400===e.status&&e.message.includes("tool_calls")?Jp(e,"INVALID_TOOL_RESULTS"):401===e.status?Jp(e,"MODEL_AUTHENTICATION"):429===e.status?Jp(e,"MODEL_RATE_LIMIT"):404===e.status?Jp(e,"MODEL_NOT_FOUND"):e,t}function Wp(e,t){const r=[];for(const[n,a]of Object.entries(e.properties??{}))a.description&&t<2&&r.push(`// ${a.description}`),e.required?.includes(n)?r.push(`${n}: ${Kp(a,t)},`):r.push(`${n}?: ${Kp(a,t)},`);return r.map(e=>" ".repeat(t)+e).join("\n")}function Kp(e,t){if(void 0!==(r=e).anyOf&&Array.isArray(r.anyOf))return e.anyOf.map(e=>Kp(e,t)).join(" | ");var r;switch(e.type){case"string":return e.enum?e.enum.map(e=>`"${e}"`).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map(e=>`${e}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Wp(e,t+2),"}"].join("\n");case"array":return e.items?`${Kp(e.items,t)}[]`:"any[]";default:return""}}function Vp(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!Na.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}function Xp(e,t,r){const n=e.tool_calls;if("assistant"===e.role){const a=[],s=[];for(const e of n??[])try{a.push(lp(e,{returnId:!0}))}catch(t){s.push(dp(e,t.message))}const i={function_call:e.function_call,tool_calls:n};void 0!==r&&(i.__raw_response=t);const o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(i.audio=e.audio),new $a({content:e.content||"",tool_calls:a,invalid_tool_calls:s,additional_kwargs:i,response_metadata:o,id:t.id})}return new Na(e.content||"",e.role??"unknown")}function Yp(e,t,r,n){const a=e.role??r,s=e.content??"";let i;i=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},n&&(i.__raw_response=t),e.audio&&(i.audio={...e.audio,index:t.choices[0].index});const o={usage:{...t.usage}};if("user"===a)return new za({content:s,response_metadata:o});if("assistant"===a){const r=[];if(Array.isArray(e.tool_calls))for(const t of e.tool_calls)r.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new Ra({content:s,tool_call_chunks:r,additional_kwargs:i,id:t.id,response_metadata:o})}return"system"===a?new Da({content:s,response_metadata:o}):"developer"===a?new Da({content:s,response_metadata:o,additional_kwargs:{__openai_role__:"developer"}}):"function"===a?new La({content:s,additional_kwargs:i,name:e.name,response_metadata:o}):"tool"===a?new Pa({content:s,additional_kwargs:i,tool_call_id:e.tool_call_id,response_metadata:o}):new Ca({content:s,role:a,response_metadata:o})}function Qp(e,t){return e.flatMap(e=>{let r=Vp(e);"system"===r&&t?.startsWith("o1")&&(r="developer");const n={role:r,content:e.content};return null!=e.name&&(n.name=e.name),null!=e.additional_kwargs.function_call&&(n.function_call=e.additional_kwargs.function_call,n.content=null),Ta(e)&&e.tool_calls?.length?(n.tool_calls=e.tool_calls.map(up),n.content=null):(null!=e.additional_kwargs.tool_calls&&(n.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(n.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio?[n,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:n})}function ef(e,t){return function(e){return!("object"!=typeof e||!e||!("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&e.function&&"name"in e.function&&"parameters"in e.function))}(e)?void 0!==t?.strict?{...e,function:{...e.function,strict:t.strict}}:e:function(e,t){let r;if(function(e){return function(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&(Hd(e.schema)||null!=e.schema&&"object"==typeof e.schema&&"type"in e.schema&&"string"==typeof e.schema.type&&["null","boolean","object","array","number","string"].includes(e.schema.type))}(e)||function(e){return void 0!==e&&lh.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}(e)||function(e){return void 0!==e&&Array.isArray(e.lc_namespace)}(e)}(e)){const a=function(e,{parser:t,callback:r}){const n={...e};return Object.defineProperties(n,{$brand:{value:"auto-parseable-tool",enumerable:!1},$parseRaw:{value:t,enumerable:!1},$callback:{value:r,enumerable:!1}}),n}({type:"function",function:{name:(n={name:e.name,parameters:e.schema,description:e.description}).name,parameters:Zp(n.parameters,{name:n.name}),strict:!0,...n.description?{description:n.description}:void 0}},{callback:n.function,parser:e=>n.parameters.parse(JSON.parse(e))});r=a.function.parameters?{type:a.type,function:{name:a.function.name,description:a.function.description,parameters:a.function.parameters,...void 0!==t?.strict?{strict:t.strict}:{}}}:{type:"function",function:Hp(e,t)}}else r=e;var n;return void 0!==t?.strict&&(r.function.strict=t.strict),r}(e,t)}class tf extends tp{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIEndpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??Vc("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??Vc("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??Vc("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??Vc("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??Vc("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??Vc("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??Vc("OPENAI_ORGANIZATION"),this.azureOpenAIEndpoint=e?.azureOpenAIEndpoint??Vc("AZURE_OPENAI_ENDPOINT"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath&&!this.azureOpenAIEndpoint)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName&&this.azureOpenAIBasePath){const e=this.azureOpenAIBasePath.split("/openai/deployments/");if(2===e.length){const[,t]=e;this.azureOpenAIApiDeploymentName=t}}if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}"o1"===this.model&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration},void 0!==e?.supportsStrictToolCalling&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return void 0!==t?.strict?r=t.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(e=>ef(e,{strict:r})),...t})}createResponseFormat(e){return e&&"json_schema"===e.type&&e.json_schema.schema&&rf(e.json_schema.schema)?qp(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}invocationParams(e,t){let r;void 0!==e?.strict?r=e.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling);let n={};void 0!==e?.stream_options?n={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(n={stream_options:{include_usage:!0}});const a={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(e=>ef(e,{strict:r})):void 0,tool_choice:(s=e?.tool_choice,s?"any"===s||"required"===s?"required":"auto"===s?"auto":"none"===s?"none":"string"==typeof s?{type:"function",function:{name:s}}:s:void 0),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...n,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};var s;void 0!==e?.prediction&&(a.prediction=e.prediction);const i=e?.reasoning_effort??this.reasoningEffort;return void 0!==i&&(a.reasoning_effort=i),a}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){const n=Qp(e,this.model),a={...this.invocationParams(t,{streaming:!0}),messages:n,stream:!0};let s;const i=await this.completionWithRetry(a,t);let o;for await(const e of i){const n=e?.choices?.[0];if(e.usage&&(o=e.usage),!n)continue;const{delta:a}=n;if(!a)continue;const i=Yp(a,e,s,this.__includeRawResponse);s=a.role??s;const c={prompt:t.promptIndex??0,completion:n.index??0};if("string"!=typeof i.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const l={...c};null!=n.finish_reason&&(l.finish_reason=n.finish_reason,l.system_fingerprint=e.system_fingerprint,l.model_name=e.model),this.logprobs&&(l.logprobs=n.logprobs);const u=new Yl({message:i,text:i.content,generationInfo:l});yield u,await(r?.handleLLMNewToken(u.text??"",c,void 0,void 0,void 0,{chunk:u}))}if(o){const e={...null!==o.prompt_tokens_details?.audio_tokens&&{audio:o.prompt_tokens_details?.audio_tokens},...null!==o.prompt_tokens_details?.cached_tokens&&{cache_read:o.prompt_tokens_details?.cached_tokens}},t={...null!==o.completion_tokens_details?.audio_tokens&&{audio:o.completion_tokens_details?.audio_tokens},...null!==o.completion_tokens_details?.reasoning_tokens&&{reasoning:o.completion_tokens_details?.reasoning_tokens}},r=new Yl({message:new Ra({content:"",response_metadata:{usage:{...o}},usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield r}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){const n={},a=this.invocationParams(t),s=Qp(e,this.model);if(a.stream){const a=this._streamResponseChunks(e,t,r),s={};for await(const e of a){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===s[t]?s[t]=e:s[t]=s[t].concat(e)}const i=Object.entries(s).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:o,function_call:c}=this.invocationParams(t),l=await this.getEstimatedTokenCountFromPrompt(e,o,c),u=await this.getNumTokensFromGenerations(i);return n.input_tokens=l,n.output_tokens=u,n.total_tokens=l+u,{generations:i,llmOutput:{estimatedTokenUsage:{promptTokens:n.input_tokens,completionTokens:n.output_tokens,totalTokens:n.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...a,stream:!1,messages:s},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...a,stream:!1,messages:s},{signal:t?.signal,...t?.options});const{completion_tokens:r,prompt_tokens:i,total_tokens:o,prompt_tokens_details:c,completion_tokens_details:l}=e?.usage??{};r&&(n.output_tokens=(n.output_tokens??0)+r),i&&(n.input_tokens=(n.input_tokens??0)+i),o&&(n.total_tokens=(n.total_tokens??0)+o),null===c?.audio_tokens&&null===c?.cached_tokens||(n.input_token_details={...null!==c?.audio_tokens&&{audio:c?.audio_tokens},...null!==c?.cached_tokens&&{cache_read:c?.cached_tokens}}),null===l?.audio_tokens&&null===l?.reasoning_tokens||(n.output_token_details={...null!==l?.audio_tokens&&{audio:l?.audio_tokens},...null!==l?.reasoning_tokens&&{reasoning:l?.reasoning_tokens}});const u=[];for(const t of e?.choices??[]){const r={text:t.message?.content??"",message:Xp(t.message??{role:"assistant"},e,this.__includeRawResponse)};r.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},Ta(r.message)&&(r.message.usage_metadata=n),r.message=new $a(Object.fromEntries(Object.entries(r.message).filter(([e])=>!e.startsWith("lc_")))),u.push(r)}return{generations:u,llmOutput:{tokenUsage:{promptTokens:n.input_tokens,completionTokens:n.output_tokens,totalTokens:n.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let n=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==r){const e=function(e){const t=["namespace functions {",""];for(const r of e)r.description&&t.push(`// ${r.description}`),Object.keys(r.parameters.properties??{}).length>0?(t.push(`type ${r.name} = (_: {`),t.push(Wp(r.parameters,0)),t.push("}) => any;")):t.push(`type ${r.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);n+=await this.getNumTokens(e),n+=9}return t&&e.find(e=>"system"===e._getType())&&(n-=4),"none"===r?n+=1:"object"==typeof r&&(n+=await this.getNumTokens(r.name)+4),n}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async getNumTokensFromMessages(e){let t=0,r=0,n=0;"gpt-3.5-turbo-0301"===this.model?(r=4,n=-1):(r=3,n=1);const a=await Promise.all(e.map(async e=>{const a=await this.getNumTokens(e.content),s=await this.getNumTokens(Vp(e)),i=void 0!==e.name?n+await this.getNumTokens(e.name):0;let o=a+r+s+i;const c=e;if("function"===c._getType()&&(o-=2),c.additional_kwargs?.function_call&&(o+=3),c?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(c.additional_kwargs.function_call?.name)),c.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(c.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(c.additional_kwargs.function_call)),o+=await this.getNumTokens(c.additional_kwargs.function_call?.arguments)}return t+=o,o}));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(e){throw Gp(e)}})}async betaParsedCompletionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(e){throw Gp(e)}})}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:r,azureOpenAIApiKey:n,azureOpenAIBasePath:a,baseURL:s,azureADTokenProvider:i,azureOpenAIEndpoint:o}=e;if((n||i)&&a&&t)return`${a}/${t}`;if((n||i)&&o&&t)return`${o}/openai/deployments/${t}`;if(n||i){if(!r)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${r}.openai.azure.com/openai/deployments/${t}`}return s}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL,azureOpenAIEndpoint:this.azureOpenAIEndpoint}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new ia(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let r,n,a,s;var i;let o,c;if(void 0!==(i=e)&&"object"==typeof i.schema?(r=e.schema,n=e.name,a=e.method,s=e.includeRaw):(r=e,n=t?.name,a=t?.method,s=t?.includeRaw),void 0!==t?.strict&&"jsonMode"===a)throw new Error("Argument `strict` is only supported for `method` = 'function_calling'");if("jsonMode"===a)o=this.bind({response_format:{type:"json_object"}}),c=rf(r)?op.fromZodSchema(r):new cp;else if("jsonSchema"===a)o=this.bind({response_format:{type:"json_schema",json_schema:{name:n??"extract",description:r.description,schema:r,strict:t?.strict}}}),c=rf(r)?op.fromZodSchema(r):new cp;else{let e=n??"extract";if(rf(r)){const n=ad(r);o=this.bind({tools:[{type:"function",function:{name:e,description:n.description,parameters:n}}],tool_choice:{type:"function",function:{name:e}},...void 0!==t?.strict?{strict:t.strict}:{}}),c=new pp({returnSingle:!0,keyName:e,zodSchema:r})}else{let n;"string"==typeof r.name&&"object"==typeof r.parameters&&null!=r.parameters?(n=r,e=r.name):(e=r.title??e,n={name:e,description:r.description??"",parameters:r}),o=this.bind({tools:[{type:"function",function:n}],tool_choice:{type:"function",function:{name:e}},...void 0!==t?.strict?{strict:t.strict}:{}}),c=new pp({returnSingle:!0,keyName:e})}}if(!s)return o.pipe(c);const l=Qh.assign({parsed:(e,t)=>c.invoke(e.raw,t)}),u=Qh.assign({parsed:()=>null}),d=l.withFallbacks({fallbacks:[u]});return ph.from([{raw:o},d])}}function rf(e){return"function"==typeof e?.parse}class nf extends Xh{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),Object.defineProperty(this,"defaultConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata}async invoke(e,t){let r,n=Ll(Nl(this.defaultConfig,t));return Ba(e)?(r=e.args,n={...n,toolCall:e}):r=e,this.call(r,n)}async call(e,t,r){const n=Ba(e)?e.args:e;let a;if(Hd(this.schema))try{a=await Jd(this.schema,n)}catch(t){let r="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(r=`${r}\nDetails: ${t.message}`),new Za(r,JSON.stringify(e))}else{const t=kd(n,this.schema);if(!t.valid){let r="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(r=`${r}\nDetails: ${t.errors.map(e=>`${e.keywordLocation}: ${e.error}`).join("\n")}`),new Za(r,JSON.stringify(e))}a=n}const s=function(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}(t),i=Il.configure(s.callbacks,this.callbacks,s.tags||r,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),o=await(i?.handleToolStart(this.toJSON(),"string"==typeof e?e:JSON.stringify(e),s.runId,void 0,void 0,void 0,s.runName));let c,l,u,d;delete s.runId;try{c=await this._call(a,o,s)}catch(e){throw await(o?.handleToolError(e)),e}if("content_and_artifact"===this.responseFormat){if(!Array.isArray(c)||2!==c.length)throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.\nResult: ${JSON.stringify(c)}`);[l,u]=c}else l=c;Ba(e)&&(d=e.id),!d&&function(e){return!!(e&&"object"==typeof e&&"toolCall"in e&&null!=e.toolCall&&"object"==typeof e.toolCall&&"id"in e.toolCall&&"string"==typeof e.toolCall.id)}(s)&&(d=s.toolCall.id);const h=function(e){const{content:t,artifact:r,toolCallId:n,metadata:a}=e;return n&&(null==(s=t)||"object"!=typeof s||!("lc_direct_tool_output"in s)||!0!==s.lc_direct_tool_output)?"string"==typeof t||Array.isArray(t)&&t.every(e=>"object"==typeof e)?new Ia({status:"success",content:t,artifact:r,tool_call_id:n,name:e.name,metadata:a}):new Ia({status:"success",content:sf(t),artifact:r,tool_call_id:n,name:e.name,metadata:a}):t;var s}({content:l,artifact:u,toolCallId:d,name:this.name,metadata:this.metadata});return await(o?.handleToolEnd(h)),h}}class af extends nf{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:Ii({input:Si().optional()}).transform(e=>e.input)})}call(e,t){const r="string"==typeof e||null==e?{input:e}:e;return super.call(r,t)}}function sf(e){try{return JSON.stringify(e,null,2)??""}catch(t){return`${e}`}}async function of(){console.log("ðŸ–±ï¸ Process button clicked");const e=document.getElementById("user-input").value.trim(),t=document.getElementById("status"),r=document.getElementById("graph-steps"),n=document.getElementById("final-result"),a=document.getElementById("process-btn");if(!e)return console.warn("âš ï¸ No input provided"),void(t.innerHTML='<p class="error">Please enter some text to process.</p>');console.log("ðŸ“ User input:",e),a.disabled=!0,a.textContent="Processing...",t.innerHTML='<p class="info">â³ Fetching API key from WordPress database...</p>',r.innerHTML="",n.innerHTML="";try{console.log("ðŸ”‘ Fetching API key from WordPress...");const n=await async function(){console.log("ðŸ“¡ Making AJAX request to get API key");const e=await fetch(ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"wplg_get_api_key"})});console.log("ðŸ“¡ AJAX response received:",e.status);const t=await e.json();if(console.log("ðŸ“¦ AJAX data:",t),!t.success)throw new Error(t.data.message||"Failed to get API key");return t.data.api_key}();console.log("âœ… API key retrieved successfully"),t.innerHTML='<p class="info">â³ Running graph workflow...</p>',console.log("ðŸ”„ Starting graph workflow"),await async function(e,t,r){console.log("ðŸ—ï¸ Building graph-style workflow"),console.log("ðŸ¤– Initializing ChatOpenAI with gpt-4o-mini");const n=new tf({modelName:"gpt-4o-mini",temperature:.7,openAIApiKey:t});console.log("âœ… ChatOpenAI initialized"),console.log("ðŸ“Š Creating initial workflow state");let a={input:e,analysis:"",processed:"",final_response:"",step_count:0};console.log("   Initial state:",a),console.log("ðŸ“ NODE 1: ANALYZER - Starting"),cf(r,1,"Analyzer","Analyzing your input...","processing");const s=`Analyze the following text and identify:\n1. Main topic/theme\n2. Key points or questions\n3. Tone (formal, casual, technical, etc.)\n\nText to analyze: "${a.input}"\n\nProvide a brief, structured analysis.`;console.log("   ðŸ“¤ Sending prompt to OpenAI (Analyzer)");const i=await n.invoke(s);a.analysis=i.content,a.step_count++,console.log("   ðŸ“¥ Analysis complete:",a.analysis),cf(r,1,"Analyzer",a.analysis,"complete"),console.log("ðŸ“ NODE 2: PROCESSOR - Starting"),cf(r,2,"Processor","Processing the analysis...","processing");const o=`Based on this analysis of user input:\n\nAnalysis: ${a.analysis}\n\nOriginal input: "${a.input}"\n\nCreate a processing plan that outlines:\n1. What information should be included in the response\n2. The best format/structure for the response\n3. Key points to emphasize\n\nKeep it brief and actionable.`;console.log("   ðŸ“¤ Sending prompt to OpenAI (Processor)");const c=await n.invoke(o);a.processed=c.content,a.step_count++,console.log("   ðŸ“¥ Processing complete:",a.processed),cf(r,2,"Processor",a.processed,"complete"),console.log("ðŸ“ NODE 3: RESPONDER - Starting"),cf(r,3,"Responder","Generating final response...","processing");const l=`Based on the analysis and processing plan below, generate a helpful, comprehensive response to the user's original input.\n\nOriginal input: "${a.input}"\n\nAnalysis: ${a.analysis}\n\nProcessing plan: ${a.processed}\n\nGenerate a well-structured, informative response that addresses the user's input directly.`;console.log("   ðŸ“¤ Sending prompt to OpenAI (Responder)");const u=await n.invoke(l);a.final_response=u.content,a.step_count++,console.log("   ðŸ“¥ Final response generated:",a.final_response),cf(r,3,"Responder",a.final_response,"complete");return document.getElementById("final-result").innerHTML=`\n        <h3>ðŸ“‹ Final Result</h3>\n        <div class="final-content">${a.final_response}</div>\n    `,console.log("ðŸŽ‰ Graph workflow complete!"),console.log("ðŸ“Š Final state:",a),console.log("   Flow executed: INPUT -> Analyzer -> Processor -> Responder -> END"),a}(e,n,r),console.log("âœ… Workflow completed successfully"),t.innerHTML='<p class="success">âœ… Processing complete!</p>'}catch(e){console.error("âŒ Error during processing:",e),t.innerHTML=`<p class="error">âŒ Error: ${e.message}</p>`}finally{a.disabled=!1,a.textContent="Process with Graph Workflow"}}function cf(e,t,r,n,a){console.log(`ðŸ“º Displaying step ${t} (${r}): ${a}`);let s=document.getElementById(`step-${t}`);s||(s=document.createElement("div"),s.id=`step-${t}`,s.className="graph-step",e.appendChild(s));const i="complete"===a?"âœ…":"â³",o="complete"===a?"complete":"processing";s.className=`graph-step ${o}`,s.innerHTML=`\n        <div class="step-header">\n            <span class="step-icon">${i}</span>\n            <h3>Step ${t}: ${r}</h3>\n        </div>\n        <div class="step-content">${n}</div>\n    `}Object.defineProperty(class extends af{static lc_name(){return"DallEAPIWrapper"}constructor(e){void 0!==e?.responseFormat&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t={apiKey:e?.apiKey??e?.openAIApiKey??Vc("OPENAI_API_KEY"),organization:e?.organization??Vc("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new ia(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap(e=>e.data.flatMap(e=>e.url?{type:"image_url",image_url:e.url}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)):e.flatMap(e=>e.data.flatMap(e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url))}async _call(e){const t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){const e=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(e)}const r=await this.client.images.generate(t);let n="";return"url"===this.dallEResponseFormat?[n]=r.data.map(e=>e.url).filter(e=>"undefined"!==e):[n]=r.data.map(e=>e.b64_json).filter(e=>"undefined"!==e),n}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),console.log("ðŸš€ LangGraph-style WordPress plugin loaded"),document.addEventListener("DOMContentLoaded",()=>{console.log("ðŸ“„ DOM Content Loaded - Initializing LangGraph-style app");const e=document.getElementById("langgraph-app");var t;e?(console.log("âœ… Found app container, rendering UI"),t=e,console.log("ðŸŽ¨ Rendering application UI"),t.innerHTML='\n        <div class="langgraph-demo">\n            <h2>LangGraph-Style Multi-Step Processing Demo</h2>\n            \n            <div class="input-section">\n                <label for="user-input">Enter your text to process:</label>\n                <textarea \n                    id="user-input" \n                    rows="4" \n                    placeholder="Type something interesting here... (e.g., \'Tell me about WordPress\')"\n                >Tell me about WordPress</textarea>\n                \n                <button id="process-btn" class="process-button">\n                    Process with Graph Workflow\n                </button>\n            </div>\n            \n            <div id="status" class="status-message"></div>\n            \n            <div id="graph-steps" class="graph-steps">\n                \x3c!-- Steps will be displayed here --\x3e\n            </div>\n            \n            <div id="final-result" class="final-result">\n                \x3c!-- Final result will be displayed here --\x3e\n            </div>\n        </div>\n    ',document.getElementById("process-btn").addEventListener("click",of),console.log("âœ… UI rendered and event listeners attached")):console.error("âŒ Could not find #langgraph-app container")})},8136(e,t,r){"use strict";const n=r(4899);e.exports=(e,t,r)=>{const a=new n(e,r),s=new n(t,r);return a.compare(s)||a.compareBuild(s)}},8303(e,t,r){var n=r(3961);t.operation=function(e){var r=t.timeouts(e);return new n(r,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],a=0;a<t.retries;a++)n.push(this.createTimeout(a,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(a,t)),n.sort(function(e,t){return e-t}),n},t.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,n=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(n,t.maxTimeout)},t.wrap=function(e,r,n){if(r instanceof Array&&(n=r,r=null),!n)for(var a in n=[],e)"function"==typeof e[a]&&n.push(a);for(var s=0;s<n.length;s++){var i=n[s],o=e[i];e[i]=function(n){var a=t.operation(r),s=Array.prototype.slice.call(arguments,1),i=s.pop();s.push(function(e){a.retry(e)||(e&&(arguments[0]=a.mainError()),i.apply(this,arguments))}),a.attempt(function(){n.apply(e,s)})}.bind(e,o),e[i].options=r}}},9056(e,t,r){"use strict";const n=r(8136);e.exports=(e,t)=>e.sort((e,r)=>n(r,e,t))},9196(e,t,r){"use strict";const n=r(4899);e.exports=(e,t)=>new n(e,t).patch},9478(e){"use strict";e.exports=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},9499(e,t,r){"use strict";const n=r(4899),a=r(9558);e.exports=(e,t,r)=>{let s=null,i=null,o=null;try{o=new a(t,r)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(s&&1!==i.compare(e)||(s=e,i=new n(s,r)))}),s}},9558(e,t,r){"use strict";const n=/\s+/g;class a{constructor(e,t){if(t=i(t),e instanceof a)return e.loose===!!t.loose&&e.includePrerelease===!!t.includePrerelease?e:new a(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(n," "),this.set=this.raw.split("||").map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter(e=>!y(e[0])),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&_(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&m)|(this.options.loose&&g))+":"+e,r=s.get(t);if(r)return r;const n=this.options.loose,a=n?u[d.HYPHENRANGELOOSE]:u[d.HYPHENRANGE];e=e.replace(a,$(this.options.includePrerelease)),c("hyphen replace",e),e=e.replace(u[d.COMPARATORTRIM],h),c("comparator trim",e),e=e.replace(u[d.TILDETRIM],p),c("tilde trim",e),e=e.replace(u[d.CARETTRIM],f),c("caret trim",e);let i=e.split(" ").map(e=>w(e,this.options)).join(" ").split(/\s+/).map(e=>P(e,this.options));n&&(i=i.filter(e=>(c("loose invalid filter",e,this.options),!!e.match(u[d.COMPARATORLOOSE])))),c("range list",i);const l=new Map,_=i.map(e=>new o(e,this.options));for(const e of _){if(y(e))return[e];l.set(e.value,e)}l.size>1&&l.has("")&&l.delete("");const b=[...l.values()];return s.set(t,b),b}intersects(e,t){if(!(e instanceof a))throw new TypeError("a Range is required");return this.set.some(r=>b(r,t)&&e.set.some(e=>b(e,t)&&r.every(r=>e.every(e=>r.intersects(e,t)))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new l(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(T(this.set[t],e,this.options))return!0;return!1}}e.exports=a;const s=new(r(639)),i=r(6588),o=r(6635),c=r(6735),l=r(4899),{safeRe:u,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:f}=r(487),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:g}=r(6261),y=e=>"<0.0.0-0"===e.value,_=e=>""===e.value,b=(e,t)=>{let r=!0;const n=e.slice();let a=n.pop();for(;r&&n.length;)r=n.every(e=>a.intersects(e,t)),a=n.pop();return r},w=(e,t)=>(e=e.replace(u[d.BUILD],""),c("comp",e,t),e=k(e,t),c("caret",e),e=O(e,t),c("tildes",e),e=S(e,t),c("xrange",e),e=I(e,t),c("stars",e),e),v=e=>!e||"x"===e.toLowerCase()||"*"===e,O=(e,t)=>e.trim().split(/\s+/).map(e=>E(e,t)).join(" "),E=(e,t)=>{const r=t.loose?u[d.TILDELOOSE]:u[d.TILDE];return e.replace(r,(t,r,n,a,s)=>{let i;return c("tilde",e,t,r,n,a,s),v(r)?i="":v(n)?i=`>=${r}.0.0 <${+r+1}.0.0-0`:v(a)?i=`>=${r}.${n}.0 <${r}.${+n+1}.0-0`:s?(c("replaceTilde pr",s),i=`>=${r}.${n}.${a}-${s} <${r}.${+n+1}.0-0`):i=`>=${r}.${n}.${a} <${r}.${+n+1}.0-0`,c("tilde return",i),i})},k=(e,t)=>e.trim().split(/\s+/).map(e=>x(e,t)).join(" "),x=(e,t)=>{c("caret",e,t);const r=t.loose?u[d.CARETLOOSE]:u[d.CARET],n=t.includePrerelease?"-0":"";return e.replace(r,(t,r,a,s,i)=>{let o;return c("caret",e,t,r,a,s,i),v(r)?o="":v(a)?o=`>=${r}.0.0${n} <${+r+1}.0.0-0`:v(s)?o="0"===r?`>=${r}.${a}.0${n} <${r}.${+a+1}.0-0`:`>=${r}.${a}.0${n} <${+r+1}.0.0-0`:i?(c("replaceCaret pr",i),o="0"===r?"0"===a?`>=${r}.${a}.${s}-${i} <${r}.${a}.${+s+1}-0`:`>=${r}.${a}.${s}-${i} <${r}.${+a+1}.0-0`:`>=${r}.${a}.${s}-${i} <${+r+1}.0.0-0`):(c("no pr"),o="0"===r?"0"===a?`>=${r}.${a}.${s}${n} <${r}.${a}.${+s+1}-0`:`>=${r}.${a}.${s}${n} <${r}.${+a+1}.0-0`:`>=${r}.${a}.${s} <${+r+1}.0.0-0`),c("caret return",o),o})},S=(e,t)=>(c("replaceXRanges",e,t),e.split(/\s+/).map(e=>A(e,t)).join(" ")),A=(e,t)=>{e=e.trim();const r=t.loose?u[d.XRANGELOOSE]:u[d.XRANGE];return e.replace(r,(r,n,a,s,i,o)=>{c("xRange",e,r,n,a,s,i,o);const l=v(a),u=l||v(s),d=u||v(i),h=d;return"="===n&&h&&(n=""),o=t.includePrerelease?"-0":"",l?r=">"===n||"<"===n?"<0.0.0-0":"*":n&&h?(u&&(s=0),i=0,">"===n?(n=">=",u?(a=+a+1,s=0,i=0):(s=+s+1,i=0)):"<="===n&&(n="<",u?a=+a+1:s=+s+1),"<"===n&&(o="-0"),r=`${n+a}.${s}.${i}${o}`):u?r=`>=${a}.0.0${o} <${+a+1}.0.0-0`:d&&(r=`>=${a}.${s}.0${o} <${a}.${+s+1}.0-0`),c("xRange return",r),r})},I=(e,t)=>(c("replaceStars",e,t),e.trim().replace(u[d.STAR],"")),P=(e,t)=>(c("replaceGTE0",e,t),e.trim().replace(u[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),$=e=>(t,r,n,a,s,i,o,c,l,u,d,h)=>`${r=v(n)?"":v(a)?`>=${n}.0.0${e?"-0":""}`:v(s)?`>=${n}.${a}.0${e?"-0":""}`:i?`>=${r}`:`>=${r}${e?"-0":""}`} ${c=v(l)?"":v(u)?`<${+l+1}.0.0-0`:v(d)?`<${l}.${+u+1}.0-0`:h?`<=${l}.${u}.${d}-${h}`:e?`<${l}.${u}.${+d+1}-0`:`<=${c}`}`.trim(),T=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(c(e[r].semver),e[r].semver!==o.ANY&&e[r].semver.prerelease.length>0){const n=e[r].semver;if(n.major===t.major&&n.minor===t.minor&&n.patch===t.patch)return!0}return!1}return!0}},9606(e,t,r){"use strict";const n=r(4621);e.exports=(e,t,r)=>0!==n(e,t,r)},9855(e,t,r){"use strict";const n=r(7737);e.exports=(e,t)=>{const r=n(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null}},9881(e,t,r){"use strict";const n=r(9558),a=r(6635),{ANY:s}=a,i=r(995),o=r(4621),c=[new a(">=0.0.0-0")],l=[new a(">=0.0.0")],u=(e,t,r)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===s){if(1===t.length&&t[0].semver===s)return!0;e=r.includePrerelease?c:l}if(1===t.length&&t[0].semver===s){if(r.includePrerelease)return!0;t=l}const n=new Set;let a,u,p,f,m,g,y;for(const t of e)">"===t.operator||">="===t.operator?a=d(a,t,r):"<"===t.operator||"<="===t.operator?u=h(u,t,r):n.add(t.semver);if(n.size>1)return null;if(a&&u){if(p=o(a.semver,u.semver,r),p>0)return null;if(0===p&&(">="!==a.operator||"<="!==u.operator))return null}for(const e of n){if(a&&!i(e,String(a),r))return null;if(u&&!i(e,String(u),r))return null;for(const n of t)if(!i(e,String(n),r))return!1;return!0}let _=!(!u||r.includePrerelease||!u.semver.prerelease.length)&&u.semver,b=!(!a||r.includePrerelease||!a.semver.prerelease.length)&&a.semver;_&&1===_.prerelease.length&&"<"===u.operator&&0===_.prerelease[0]&&(_=!1);for(const e of t){if(y=y||">"===e.operator||">="===e.operator,g=g||"<"===e.operator||"<="===e.operator,a)if(b&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===b.major&&e.semver.minor===b.minor&&e.semver.patch===b.patch&&(b=!1),">"===e.operator||">="===e.operator){if(f=d(a,e,r),f===e&&f!==a)return!1}else if(">="===a.operator&&!i(a.semver,String(e),r))return!1;if(u)if(_&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===_.major&&e.semver.minor===_.minor&&e.semver.patch===_.patch&&(_=!1),"<"===e.operator||"<="===e.operator){if(m=h(u,e,r),m===e&&m!==u)return!1}else if("<="===u.operator&&!i(u.semver,String(e),r))return!1;if(!e.operator&&(u||a)&&0!==p)return!1}return!(a&&g&&!u&&0!==p||u&&y&&!a&&0!==p||b||_)},d=(e,t,r)=>{if(!e)return t;const n=o(e.semver,t.semver,r);return n>0?e:n<0||">"===t.operator&&">="===e.operator?t:e},h=(e,t,r)=>{if(!e)return t;const n=o(e.semver,t.semver,r);return n<0?e:n>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,r={})=>{if(e===t)return!0;e=new n(e,r),t=new n(t,r);let a=!1;e:for(const n of e.set){for(const e of t.set){const t=u(n,e,r);if(a=a||null!==t,t)continue e}if(a)return!1}return!0}},9998(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){let n=0,a=e.length;for(;a>0;){const s=a/2|0;let i=n+s;r(e[i],t)<=0?(n=++i,a-=s+1):a=s}return n}}},r={};function n(e){var a=r[e];if(void 0!==a)return a.exports;var s=r[e]={id:e,loaded:!1,exports:{}};return t[e](s,s.exports,n),s.loaded=!0,s.exports}n.m=t,e=[],n.O=(t,r,a,s)=>{if(!r){var i=1/0;for(u=0;u<e.length;u++){for(var[r,a,s]=e[u],o=!0,c=0;c<r.length;c++)(!1&s||i>=s)&&Object.keys(n.O).every(e=>n.O[e](r[c]))?r.splice(c--,1):(o=!1,s<i&&(i=s));if(o){e.splice(u--,1);var l=a();void 0!==l&&(t=l)}}return t}s=s||0;for(var u=e.length;u>0&&e[u-1][2]>s;u--)e[u]=e[u-1];e[u]=[r,a,s]},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e={57:0,350:0};n.O.j=t=>0===e[t];var t=(t,r)=>{var a,s,[i,o,c]=r,l=0;if(i.some(t=>0!==e[t])){for(a in o)n.o(o,a)&&(n.m[a]=o[a]);if(c)var u=c(n)}for(t&&t(r);l<i.length;l++)s=i[l],n.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return n.O(u)},r=globalThis.webpackChunkwp_langgraph=globalThis.webpackChunkwp_langgraph||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})();var a=n.O(void 0,[350],()=>n(8089));a=n.O(a)})();