<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Multi-Agent Workflow Demo</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet">
   <style>
      body {
         font-family: 'Raleway', sans-serif;
         max-width: 1000px;
         margin: 50px auto;
         padding: 20px;
         background: #f5f5f5;
      }

      h1 {
         color: #333;
         font-size: 2em;
         margin-bottom: 30px;
      }

      input[type="text"] {
         width: 100%;
         padding: 12px;
         margin: 10px 0;
         border: 2px solid #ddd;
         border-radius: 5px;
         font-size: 16px;
         font-family: 'Fira Code', monospace;
      }

      button {
         background: #007bff;
         color: white;
         padding: 12px 30px;
         border: none;
         border-radius: 5px;
         font-size: 16px;
         cursor: pointer;
         margin: 10px 0;
      }

      button:hover {
         background: #0056b3;
      }

      button:disabled {
         background: #ccc;
         cursor: not-allowed;
      }

      #workflow-container {
         display: flex;
         gap: 20px;
         margin-top: 20px;
      }

      #agent-log {
         flex: 1;
         background: white;
         padding: 20px;
         border-radius: 5px;
         box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
         max-height: 600px;
         overflow-y: auto;
      }

      #result {
         flex: 1;
         background: white;
         padding: 20px;
         border-radius: 5px;
         box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
         max-height: 600px;
         overflow-y: auto;
      }

      #jsonOutput {
         background: #1e1e1e;
         color: #d4d4d4;
         padding: 20px;
         border-radius: 5px;
         margin-top: 20px;
         box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
         font-family: 'Fira Code', monospace;
         overflow-x: auto;
         max-height: 400px;
         overflow-y: auto;
      }

      #jsonOutput h3 {
         color: #4ec9b0;
         margin-top: 0;
      }

      #jsonOutput pre {
         margin: 0;
         white-space: pre-wrap;
         word-wrap: break-word;
      }

      .agent-step {
         margin: 15px 0;
         padding: 15px;
         border-radius: 8px;
         border-left: 4px solid;
      }

      .agent-step.research-agent {
         border-left-color: #007bff;
         background: #e7f3ff;
      }

      .agent-step.large-city-agent {
         border-left-color: #28a745;
         background: #e8f5e8;
      }

      .agent-step.small-city-agent {
         border-left-color: #ffc107;
         background: #fff3cd;
      }

      .agent-step.summary-agent {
         border-left-color: #6f42c1;
         background: #f3f0ff;
      }

      .agent-step h3 {
         margin: 0 0 10px 0;
         color: #333;
         font-size: 1.1em;
      }

      .agent-step p {
         margin: 5px 0;
         line-height: 1.4;
      }

      .city-card {
         border-left: 4px solid #007bff;
         padding-left: 15px;
      }

      .city-card h2 {
         margin: 0 0 10px 0;
         color: #007bff;
      }

      .city-info {
         margin: 10px 0;
      }

      .landmarks {
         margin-top: 15px;
      }

      .landmarks ul {
         list-style-type: none;
         padding: 0;
      }

      .landmarks li {
         background: #f8f9fa;
         padding: 8px;
         margin: 5px 0;
         border-radius: 3px;
      }

      .error {
         color: red;
         padding: 10px;
         background: #ffe6e6;
         border-radius: 5px;
         margin: 10px 0;
      }

      .loading {
         color: #666;
         font-style: italic;
         padding: 10px;
      }

      .agent-chain {
         margin: 10px 0;
         font-size: 0.9em;
         color: #666;
      }

      .agent-chain strong {
         color: #333;
      }
   </style>
</head>

<body>
   <h1>üï∏Ô∏è Multi-Agent Workflow Demo</h1>
   <p>This demo shows how multiple AI agents can work together in a workflow, where each agent calls the next based on the 'do_next' field in structured JSON responses.</p>

   <input type="text" id="apiKey" placeholder="Enter your OpenAI API key" value="" autocomplete="off"
      data-form-type="other">
   <input type="text" id="prompt" placeholder="Ask about a city (e.g., 'Tell me about Paris')"
      value="Tell me about Tokyo">

   <button id="sendBtn" type="submit">Start Multi-Agent Workflow</button>

   <div id="workflow-container">
      <!-- Agent execution log -->
      <div id="agent-log">
         <h2>ü§ñ Agent Execution Log</h2>
         <p>Watch the agents work together step by step...</p>
      </div>

      <!-- Final results -->
      <div id="result">
         <h2>üìä Final Results</h2>
         <p>Final processed information will appear here...</p>
      </div>
   </div>

   <!-- Raw JSON output for debugging -->
   <div id="jsonOutput"></div>

   <script>
      // Agent definitions and their behaviors
      const agents = {
         'research-agent': {
            name: 'Research Agent',
            systemPrompt: 'You are a research agent that gathers basic information about cities. Analyze the user query and provide structured city information. If the population is over 1 million, set "do_next" to "large_city_agent", otherwise set it to "small_city_agent". Always set do_next to continue the workflow.',
            schema: {
               type: "object",
               properties: {
                  do_next: { type: "string", description: "which agent to call next" },
                  city_name: { type: "string", description: "The name of the city" },
                  country: { type: "string", description: "The country where the city is located" },
                  population: { type: "number", description: "The approximate population of the city" },
                  famous_landmarks: { type: "array", description: "List of famous landmarks in the city", items: { type: "string" } },
                  fun_fact: { type: "string", description: "An interesting fact about the city" }
               },
               required: ["do_next", "city_name", "country", "population", "famous_landmarks", "fun_fact"],
               additionalProperties: false
            },
            schemaName: "city_research"
         },

         'large-city-agent': {
            name: 'Large City Specialist',
            systemPrompt: 'You are a specialist in large metropolitan cities (population > 1M). Provide detailed analysis about urban development, economy, culture, and challenges of major cities. Set "do_next" to "summary-agent" to conclude the analysis.',
            schema: {
               type: "object",
               properties: {
                  do_next: { type: "string", description: "which agent to call next" },
                  urban_analysis: { type: "string", description: "Analysis of urban development and infrastructure" },
                  economic_significance: { type: "string", description: "Economic importance and contributions" },
                  cultural_impact: { type: "string", description: "Cultural influence and global significance" },
                  challenges: { type: "array", description: "Major challenges faced by this large city", items: { type: "string" } },
                  future_outlook: { type: "string", description: "Future development prospects" }
               },
               required: ["do_next", "urban_analysis", "economic_significance", "cultural_impact", "challenges", "future_outlook"],
               additionalProperties: false
            },
            schemaName: "large_city_analysis"
         },

         'small-city-agent': {
            name: 'Small City Specialist',
            systemPrompt: 'You are a specialist in smaller cities and towns (population < 1M). Focus on community aspects, local culture, quality of life, and unique characteristics. Set "do_next" to "summary-agent" to conclude the analysis.',
            schema: {
               type: "object",
               properties: {
                  do_next: { type: "string", description: "which agent to call next" },
                  community_aspects: { type: "string", description: "Community life and social structure" },
                  local_culture: { type: "string", description: "Unique local culture and traditions" },
                  quality_of_life: { type: "string", description: "Quality of life factors" },
                  unique_features: { type: "array", description: "Unique characteristics of this smaller city", items: { type: "string" } },
                  community_strengths: { type: "string", description: "Strengths of the local community" }
               },
               required: ["do_next", "community_aspects", "local_culture", "quality_of_life", "unique_features", "community_strengths"],
               additionalProperties: false
            },
            schemaName: "small_city_analysis"
         },

         'summary-agent': {
            name: 'Summary Agent',
            systemPrompt: 'You are a summary agent that synthesizes all the information from previous agents into a comprehensive report. Set "do_next" to "end" to finish the workflow.',
            schema: {
               type: "object",
               properties: {
                  do_next: { type: "string", description: "which agent to call next (set to 'end')" },
                  executive_summary: { type: "string", description: "Brief overview of all findings" },
                  key_insights: { type: "array", description: "Most important insights from the analysis", items: { type: "string" } },
                  recommendations: { type: "array", description: "Recommendations based on the analysis", items: { type: "string" } },
                  overall_assessment: { type: "string", description: "Final assessment of the city" }
               },
               required: ["do_next", "executive_summary", "key_insights", "recommendations", "overall_assessment"],
               additionalProperties: false
            },
            schemaName: "final_summary"
         }
      };

      // Function to add agent step to log
      function addAgentStep(agentType, stepData) {
         const agentLog = document.getElementById('agent-log');
         const stepDiv = document.createElement('div');
         stepDiv.className = `agent-step ${agentType}`;

         let content = `<h3>${agents[agentType].name}</h3>`;

         if (agentType === 'research-agent') {
            content += `
               <p><strong>City:</strong> ${stepData.city_name}, ${stepData.country}</p>
               <p><strong>Population:</strong> ${stepData.population.toLocaleString()}</p>
               <p><strong>Next Agent:</strong> ${stepData.do_next}</p>
               <p><strong>Fun Fact:</strong> ${stepData.fun_fact}</p>
            `;
         } else if (agentType === 'large-city-agent') {
            content += `
               <p><strong>Urban Analysis:</strong> ${stepData.urban_analysis}</p>
               <p><strong>Economic Significance:</strong> ${stepData.economic_significance}</p>
               <p><strong>Next:</strong> ${stepData.do_next}</p>
            `;
         } else if (agentType === 'small-city-agent') {
            content += `
               <p><strong>Community Aspects:</strong> ${stepData.community_aspects}</p>
               <p><strong>Quality of Life:</strong> ${stepData.quality_of_life}</p>
               <p><strong>Next:</strong> ${stepData.do_next}</p>
            `;
         } else if (agentType === 'summary-agent') {
            content += `
               <p><strong>Executive Summary:</strong> ${stepData.executive_summary}</p>
               <p><strong>Overall Assessment:</strong> ${stepData.overall_assessment}</p>
               <p><strong>Next:</strong> ${stepData.do_next}</p>
            `;
         }

         stepDiv.innerHTML = content;
         agentLog.appendChild(stepDiv);
         agentLog.scrollTop = agentLog.scrollHeight;
      }

      // Function to call an agent
      async function callAgent(apiKey, agentType, contextData, userPrompt) {
         const agent = agents[agentType];

         // Build messages based on agent type and context
         let systemPrompt = agent.systemPrompt;
         let userMessage = userPrompt;

         // Add context from previous agents
         if (contextData.length > 0) {
            systemPrompt += '\n\nPrevious agent responses: ' + JSON.stringify(contextData, null, 2);
            userMessage = `Continue the analysis for: ${userPrompt}`;
         }

         try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`
               },
               body: JSON.stringify({
                  model: 'gpt-4o-mini',
                  messages: [
                     { role: 'system', content: systemPrompt },
                     { role: 'user', content: userMessage }
                  ],
                  response_format: {
                     type: "json_schema",
                     json_schema: {
                        name: agent.schemaName,
                        strict: true,
                        schema: agent.schema
                     }
                  },
                  temperature: 0.7
               })
            });

            const data = await response.json();

            if (data.error) {
               throw new Error(data.error.message);
            }

            return JSON.parse(data.choices[0].message.content);
         } catch (error) {
            throw new Error(`Agent ${agentType} failed: ${error.message}`);
         }
      }

      // Main workflow function
      async function runMultiAgentWorkflow(apiKey, userPrompt) {
         const agentLog = document.getElementById('agent-log');
         const resultDiv = document.getElementById('result');
         const jsonOutput = document.getElementById('jsonOutput');

         // Clear previous results
         agentLog.innerHTML = '<h2>ü§ñ Agent Execution Log</h2>';
         resultDiv.innerHTML = '<h2>üìä Final Results</h2><p class="loading">Running multi-agent workflow...</p>';
         jsonOutput.innerHTML = '';

         const contextData = [];
         let currentAgent = 'research-agent';
         let workflowComplete = false;
         let stepCount = 0;
         const maxSteps = 10;

         try {
            while (!workflowComplete && stepCount < maxSteps) {
               stepCount++;
               console.log(`Step ${stepCount}: Calling ${currentAgent}`);

               // Show loading state
               const loadingDiv = document.createElement('div');
               loadingDiv.className = 'agent-step loading';
               loadingDiv.innerHTML = `<h3>${agents[currentAgent].name}</h3><p>Processing...</p>`;
               agentLog.appendChild(loadingDiv);

               // Call the agent
               const agentResponse = await callAgent(apiKey, currentAgent, contextData, userPrompt);

               // Remove loading state and add actual result
               agentLog.removeChild(loadingDiv);
               addAgentStep(currentAgent, agentResponse);

               // Add to context for next agent
               contextData.push({
                  agent: currentAgent,
                  response: agentResponse
               });

               // Determine next agent
               currentAgent = agentResponse.do_next;

               if (currentAgent === 'end' || !agents[currentAgent]) {
                  workflowComplete = true;
               }
            }

            // Display final results
            const finalData = contextData[contextData.length - 1];
            if (finalData.agent === 'summary-agent') {
               resultDiv.innerHTML = `
                  <h2>üìä Final Analysis Complete</h2>
                  <div class="city-card">
                     <h3>Executive Summary</h3>
                     <p>${finalData.response.executive_summary}</p>

                     <h3>Key Insights</h3>
                     <ul>
                        ${finalData.response.key_insights.map(insight => `<li>${insight}</li>`).join('')}
                     </ul>

                     <h3>Recommendations</h3>
                     <ul>
                        ${finalData.response.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                     </ul>

                     <h3>Overall Assessment</h3>
                     <p><strong>${finalData.response.overall_assessment}</strong></p>
                  </div>
               `;
            }

            // Show agent chain
            let chainHtml = '<div class="agent-chain"><strong>Agent Chain:</strong> ';
            chainHtml += contextData.map((data, index) => {
               const agentName = agents[data.agent].name;
               return index === 0 ? agentName : ` ‚Üí ${agentName}`;
            }).join('');
            chainHtml += '</div>';

            resultDiv.innerHTML += chainHtml;

            // Display raw JSON for debugging
            jsonOutput.innerHTML = `
               <h3>All Agent Responses (Raw JSON)</h3>
               <pre>${JSON.stringify(contextData, null, 2)}</pre>
            `;

         } catch (error) {
            resultDiv.innerHTML = `<p class="error">Workflow failed: ${error.message}</p>`;
            console.error('Workflow error:', error);
         }
      }

      // Event listener
      document.getElementById('sendBtn').addEventListener('click', async () => {
         const apiKey = document.getElementById('apiKey').value;
         const prompt = document.getElementById('prompt').value;
         const sendBtn = document.getElementById('sendBtn');

         if (!apiKey) {
            document.getElementById('result').innerHTML = '<p class="error">Please enter your API key</p>';
            return;
         }

         if (!prompt) {
            document.getElementById('result').innerHTML = '<p class="error">Please enter a prompt</p>';
            return;
         }

         sendBtn.disabled = true;
         sendBtn.textContent = 'Running Workflow...';

         try {
            await runMultiAgentWorkflow(apiKey, prompt);
         } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = 'Start Multi-Agent Workflow';
         }
      });

      // Allow Enter key to submit
      document.getElementById('prompt').addEventListener('keypress', (e) => {
         if (e.key === 'Enter') {
            document.getElementById('sendBtn').click();
         }
      });
   </script>
</body>

</html>
