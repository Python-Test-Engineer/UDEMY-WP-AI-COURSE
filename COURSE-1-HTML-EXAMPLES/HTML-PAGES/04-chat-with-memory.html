<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>OpenAI API in Browser</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet">
   <link rel="stylesheet" href="01-style.css">
</head>

<body>
   <h1>OpenAI API in Browser</h1>
   <input type="text" id="apiKey" placeholder="Enter your OpenAI API key">

   <div id="chatContainer">
      <div id="messages"></div>
   </div>

   <div id="inputContainer">
      <input type="text" id="messageInput" placeholder="Type your message..." value="Capital of England?">
      <button id="sendBtn">Send</button>
      <button id="clearBtn" style="background: #dc3545;">Clear Chat</button>
   </div>

   <script>
      const systemPrompt = `
         You are a helpful assistant with access to the full conversation history. You always answer in a concise manner.

         IMPORTANT: When the user asks follow-up questions using words like "it", "that", "there", etc., refer to the previous messages in our conversation to understand what they're referring to. Use your knowledge to answer questions about topics we've discussed.

         If you genuinely don't know something, say 'I don't know', but always check the conversation context first before saying this.

         Convert markdown to HTML when needed so that output is properly formatted. Ensure there is a new line after each sentence.
      `;

      let messages = [{ role: 'system', content: systemPrompt }];

      // Load messages from localStorage
      function loadMessages() {
         const saved = localStorage.getItem('chatHistory');
         if (saved) {
            messages = JSON.parse(saved);
         }
         renderMessages();
      }

      // Save messages to localStorage
      function saveMessages() {
         localStorage.setItem('chatHistory', JSON.stringify(messages));
      }

      // Render messages to the chat
      function renderMessages() {
         const messagesDiv = document.getElementById('messages');
         messagesDiv.innerHTML = '';
         messages.slice(1).forEach(msg => { // Skip system message
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${msg.role}`;
            msgDiv.textContent = msg.content;
            messagesDiv.appendChild(msgDiv);
         });
      }

      // Send message to OpenAI
      async function sendMessage(userMessage) {
         const apiKey = document.getElementById('apiKey').value;

         if (!apiKey) {
            alert('Please enter your API key');
            return;
         }

         // Add user message
         messages.push({ role: 'user', content: userMessage });
         saveMessages();
         renderMessages();

         // Clear input
         document.getElementById('messageInput').value = '';

         // Add loading message
         const loadingDiv = document.createElement('div');
         loadingDiv.className = 'message assistant loading';
         loadingDiv.textContent = 'Thinking...';
         document.getElementById('messages').appendChild(loadingDiv);

         // Scroll to bottom
         document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;

         // Log conversation history being sent
         console.log('Sending to OpenAI - Total messages in conversation:', messages.length);
         console.log('Full conversation history:', messages);

         try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`
               },
               body: JSON.stringify({
                  model: 'gpt-4o-mini',
                  messages: messages,
                  max_tokens: 1024
               })
            });

            const data = await response.json();

            if (data.error) {
               loadingDiv.textContent = `Error: ${data.error.message}`;
               loadingDiv.style.color = 'red';
            } else {
               // Remove loading message
               document.getElementById('messages').removeChild(loadingDiv);

               // Add actual response
               const assistantMessage = data.choices[0].message.content;
               messages.push({ role: 'assistant', content: assistantMessage });
               saveMessages();
               renderMessages();

               console.log('Assistant response added. Total messages now:', messages.length);

               // Scroll to bottom
               document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
            }
         } catch (error) {
            loadingDiv.textContent = `Error: ${error.message}`;
            loadingDiv.style.color = 'red';
         }
      }

      // Event listener for send button
      document.getElementById('sendBtn').addEventListener('click', () => {
         const input = document.getElementById('messageInput');
         const message = input.value.trim();
         if (message) {
            sendMessage(message);
         }
      });

      // Allow enter key to send
      document.getElementById('messageInput').addEventListener('keypress', (e) => {
         if (e.key === 'Enter') {
            sendMessage(e.target.value.trim());
         }
      });

      // Clear chat functionality
      document.getElementById('clearBtn').addEventListener('click', () => {
         if (confirm('Are you sure you want to clear the chat history?')) {
            messages = [{ role: 'system', content: systemPrompt }];
            saveMessages();
            renderMessages();
         }
      });

      // Load messages on page load
      window.addEventListener('load', loadMessages);

      // Debug: Log messages array before each API call
      console.log('Chat initialized. Messages array:', messages);
   </script>
</body>

</html>